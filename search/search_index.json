{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Soliplex Documentation","text":"<p>Welcome to the Soliplex ecosystem documentation. Soliplex provides AI-powered retrieval-augmented generation capabilities for intelligent document search and question answering.</p>"},{"location":"#core-components","title":"Core Components","text":""},{"location":"#soliplex-platform","title":"Soliplex Platform","text":"<p>The main Soliplex RAG system with FastAPI backend and Flutter frontend.</p> <p>Quick Links: - Overview - Server Setup - Client Setup - RAG Database - Configuration Guide - Usage</p>"},{"location":"#ingester","title":"Ingester","text":"<p>Robust document ingestion system for loading content into RAG databases.</p> <p>Quick Links: - Getting Started - Architecture - API Reference - CLI Reference - Configuration - Database Schema - Workflows</p>"},{"location":"#user-interfaces","title":"User Interfaces","text":""},{"location":"#flutter-client","title":"Flutter Client","text":"<p>Cross-platform mobile and desktop client application for Soliplex.</p> <p>Quick Links: - Developer Setup Guide - Flutter Development Rules - Client Summary</p>"},{"location":"#chatbot-widget","title":"Chatbot Widget","text":"<p>Embeddable Next.js chat widget for integrating Soliplex into web applications.</p> <p>Quick Links: - Documentation - Usage Guide</p>"},{"location":"#supporting-tools","title":"Supporting Tools","text":""},{"location":"#ingester-agents","title":"Ingester Agents","text":"<p>Agents for ingesting documents from various sources (filesystem, GitHub, Gitea) into the Soliplex Ingester.</p> <p>Quick Links: - Documentation</p>"},{"location":"#pdf-splitter","title":"PDF Splitter","text":"<p>Utility for splitting and processing PDF documents for ingestion.</p> <p>Quick Links: - Documentation</p>"},{"location":"#getting-started","title":"Getting Started","text":""},{"location":"#for-new-users","title":"For New Users","text":"<ol> <li>Core Platform Overview - Understanding the Soliplex system</li> <li>Server Setup - Set up the backend server</li> <li>Client Setup - Configure the client application</li> <li>Getting Started with Ingester - Document ingestion basics</li> </ol>"},{"location":"#for-developers","title":"For Developers","text":"<ol> <li>Core Platform Architecture - System design and components</li> <li>Ingester Architecture - Ingestion pipeline design</li> <li>API References - REST API documentation</li> </ol>"},{"location":"#for-operations","title":"For Operations","text":"<ol> <li>Configuration Guide - Installation configuration</li> <li>Environment Setup - Environment variables</li> <li>Secrets Management - Handling sensitive configuration</li> <li>Ingester CLI Reference - Command-line tool usage</li> </ol>"},{"location":"#what-is-soliplex","title":"What is Soliplex?","text":"<p>Soliplex combines the power of retrieval systems with generative AI to provide accurate, contextual responses based on your document collections. The system indexes your documents and uses them to enhance AI responses with relevant, up-to-date information.</p>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li>RAG-Powered Search: Semantic document retrieval using LanceDB vector database</li> <li>Multi-Room Architecture: Independent chat environments with separate configurations</li> <li>Multiple LLM Providers: OpenAI, Ollama, and compatible APIs</li> <li>Document Ingestion: Robust pipeline for loading and processing documents</li> <li>Real-time Communication: WebSocket-based conversation streams</li> <li>OIDC Authentication: Enterprise SSO with Keycloak integration</li> </ul>"},{"location":"#documentation-updates","title":"Documentation Updates","text":"<p>This documentation is automatically synchronized from multiple repositories:</p> <ul> <li>Core Platform: soliplex/soliplex</li> <li>Ingester: soliplex/ingester</li> <li>Flutter Client: soliplex/flutter</li> <li>Chatbot Widget: soliplex/chatbot</li> <li>Ingester Agents: soliplex/ingester-agents</li> <li>PDF Splitter: soliplex/pdf-splitter</li> </ul> <p>Documentation is updated automatically when changes are made to the source repositories via git submodules.</p> <p>Last Updated: This site is automatically updated when documentation changes are pushed to the main branch of each repository.</p>"},{"location":"chatbot/readme/","title":"Chatbot Widget","text":"<p>Live Demo</p>"},{"location":"chatbot/readme/#soliplex-chat-widget","title":"Soliplex Chat Widget","text":"<p>A React-based embeddable chat widget that connects to a Soliplex/PydanticAI backend using the AG-UI protocol.</p>"},{"location":"chatbot/readme/#project-structure","title":"Project Structure","text":"<pre><code>/\n\u251c\u2500\u2500 app/                    # Next.js app router pages\n\u2502   \u251c\u2500\u2500 page.tsx           # Main page (standalone chat UI)\n\u2502   \u251c\u2500\u2500 layout.tsx         # Root layout\n\u2502   \u2514\u2500\u2500 globals.css        # Global styles (Tailwind)\n\u251c\u2500\u2500 components/\n\u2502   \u251c\u2500\u2500 Chat.tsx           # Core chat component\n\u2502   \u2514\u2500\u2500 ChatWidget.tsx     # Floating widget wrapper\n\u251c\u2500\u2500 hooks/\n\u2502   \u2514\u2500\u2500 useAGUIChat.ts     # Chat state management hook\n\u251c\u2500\u2500 lib/\n\u2502   \u2514\u2500\u2500 agui-client.ts     # AG-UI protocol client\n\u251c\u2500\u2500 widget/\n\u2502   \u2514\u2500\u2500 index.tsx          # Embeddable widget entry point\n\u251c\u2500\u2500 public/\n\u2502   \u251c\u2500\u2500 soliplex-chat.js   # Built widget bundle (after build)\n\u2502   \u2514\u2500\u2500 embed-example.html # Example embed page\n\u251c\u2500\u2500 docs/\n\u2502   \u251c\u2500\u2500 readme.md          # This file\n\u2502   \u2514\u2500\u2500 usage.md           # Widget usage guide\n\u251c\u2500\u2500 esbuild.config.mjs     # Widget build configuration\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 tsconfig.json\n\u251c\u2500\u2500 tailwind.config.js\n\u2514\u2500\u2500 next.config.js\n</code></pre>"},{"location":"chatbot/readme/#prerequisites","title":"Prerequisites","text":"<ul> <li>Node.js 18+</li> <li>npm or yarn</li> <li>A running Soliplex backend (default: <code>http://localhost:8000</code>)</li> </ul>"},{"location":"chatbot/readme/#development-setup","title":"Development Setup","text":""},{"location":"chatbot/readme/#1-install-dependencies","title":"1. Install Dependencies","text":"<pre><code>npm install\n</code></pre>"},{"location":"chatbot/readme/#2-configure-environment","title":"2. Configure Environment","text":"<p>Create a <code>.env.local</code> file:</p> <pre><code># Backend API URL\nNEXT_PUBLIC_AGUI_BASE_URL=http://localhost:8000\n</code></pre>"},{"location":"chatbot/readme/#3-start-development-server","title":"3. Start Development Server","text":"<pre><code>npm run dev\n</code></pre> <p>This starts the Next.js development server at <code>http://localhost:3000</code>.</p>"},{"location":"chatbot/readme/#4-start-the-backend","title":"4. Start the Backend","text":"<p>In a separate terminal, start your Soliplex backend:</p> <pre><code>cd /path/to/soliplex\nuvicorn soliplex.main:app --reload --port 8000\n</code></pre>"},{"location":"chatbot/readme/#5-open-in-browser","title":"5. Open in Browser","text":"<p>Navigate to <code>http://localhost:3000</code> to see the standalone chat interface.</p>"},{"location":"chatbot/readme/#development-commands","title":"Development Commands","text":"Command Description <code>npm run dev</code> Start Next.js dev server with hot reload <code>npm run build</code> Build Next.js app for production <code>npm run start</code> Start production Next.js server <code>npm run lint</code> Run ESLint <code>npm run build:widget</code> Build embeddable widget bundle <code>npm run build:widget:watch</code> Build widget with watch mode"},{"location":"chatbot/readme/#building-for-production","title":"Building for Production","text":""},{"location":"chatbot/readme/#option-1-nextjs-app","title":"Option 1: Next.js App","text":"<p>Build and deploy as a standard Next.js application:</p> <pre><code>npm run build\nnpm run start\n</code></pre>"},{"location":"chatbot/readme/#option-2-embeddable-widget","title":"Option 2: Embeddable Widget","text":"<p>Build a standalone JavaScript bundle that can be embedded in any website:</p> <pre><code>npm run build:widget\n</code></pre> <p>This creates <code>public/soliplex-chat.js</code> (~200KB minified).</p>"},{"location":"chatbot/readme/#widget-build-output","title":"Widget Build Output","text":"<pre><code>public/\n\u251c\u2500\u2500 soliplex-chat.js      # Main bundle (minified)\n\u2514\u2500\u2500 soliplex-chat.js.map  # Source map (for debugging)\n</code></pre>"},{"location":"chatbot/readme/#serving-the-widget","title":"Serving the Widget","text":"<p>You can serve the widget from:</p> <ol> <li>Your CDN - Upload to S3, CloudFront, Cloudflare, etc.</li> <li>Your backend - Serve from your FastAPI static files</li> <li>npm package - Publish as an npm package</li> </ol> <p>Example FastAPI static file serving:</p> <pre><code>from fastapi.staticfiles import StaticFiles\n\napp.mount(\"/static\", StaticFiles(directory=\"static\"), name=\"static\")\n# Widget available at: https://your-api.com/static/soliplex-chat.js\n</code></pre>"},{"location":"chatbot/readme/#widget-development","title":"Widget Development","text":""},{"location":"chatbot/readme/#watch-mode","title":"Watch Mode","text":"<p>For rapid widget development:</p> <pre><code>npm run build:widget:watch\n</code></pre> <p>Then serve the <code>public/</code> directory and open <code>embed-example.html</code>:</p> <pre><code># In another terminal\ncd public\npython -m http.server 8080\n# Open http://localhost:8080/embed-example.html\n</code></pre>"},{"location":"chatbot/readme/#testing-changes","title":"Testing Changes","text":"<ol> <li>Make changes to widget code</li> <li>Watch mode rebuilds automatically</li> <li>Refresh the embed example page</li> </ol>"},{"location":"chatbot/readme/#architecture","title":"Architecture","text":""},{"location":"chatbot/readme/#ag-ui-protocol-flow","title":"AG-UI Protocol Flow","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Browser   \u2502     \u2502   Backend   \u2502     \u2502   LLM API   \u2502\n\u2502  (Widget)   \u2502     \u2502  (FastAPI)  \u2502     \u2502  (Claude)   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502                   \u2502                   \u2502\n       \u2502 POST /agui       \u2502                   \u2502\n       \u2502 (create thread)   \u2502                   \u2502\n       \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500&gt;\u2502                   \u2502\n       \u2502&lt;\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                   \u2502\n       \u2502 { thread_id, run_id }                 \u2502\n       \u2502                   \u2502                   \u2502\n       \u2502 POST /agui/{thread}/{run}             \u2502\n       \u2502 (RunAgentInput)   \u2502                   \u2502\n       \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500&gt;\u2502                   \u2502\n       \u2502                   \u2502 Stream request    \u2502\n       \u2502                   \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500&gt;\u2502\n       \u2502                   \u2502                   \u2502\n       \u2502    SSE Stream     \u2502&lt;\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n       \u2502&lt;\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502  Stream response  \u2502\n       \u2502                   \u2502                   \u2502\n       \u2502 TEXT_MESSAGE_START\u2502                   \u2502\n       \u2502 TEXT_MESSAGE_CONTENT (delta)          \u2502\n       \u2502 TEXT_MESSAGE_END  \u2502                   \u2502\n       \u2502 TOOL_CALL_START   \u2502                   \u2502\n       \u2502 TOOL_CALL_ARGS    \u2502                   \u2502\n       \u2502 TOOL_CALL_END     \u2502                   \u2502\n       \u2502 RUN_FINISHED      \u2502                   \u2502\n       \u2502                   \u2502                   \u2502\n</code></pre>"},{"location":"chatbot/readme/#client-side-tool-execution","title":"Client-Side Tool Execution","text":"<p>When the AI requests a tool call:</p> <ol> <li><code>TOOL_CALL_START</code> - Widget receives tool name and ID</li> <li><code>TOOL_CALL_ARGS</code> - Widget accumulates JSON arguments</li> <li><code>TOOL_CALL_END</code> - Widget executes the local handler</li> <li>Result is displayed in chat (future: sent back to continue conversation)</li> </ol>"},{"location":"chatbot/readme/#key-files","title":"Key Files","text":"<ul> <li><code>lib/agui-client.ts</code> - Low-level AG-UI protocol implementation</li> <li><code>hooks/useAGUIChat.ts</code> - React hook managing chat state and streaming</li> <li><code>components/Chat.tsx</code> - Chat UI with message rendering</li> <li><code>components/ChatWidget.tsx</code> - Floating bubble wrapper</li> <li><code>widget/index.tsx</code> - Standalone bundle entry point</li> </ul>"},{"location":"chatbot/readme/#customization","title":"Customization","text":""},{"location":"chatbot/readme/#styling","title":"Styling","text":"<p>The widget includes embedded CSS to work without external dependencies. To customize:</p> <ol> <li>Widget bundle - Modify styles in <code>widget/index.tsx</code> <code>injectStyles()</code> function</li> <li>Next.js app - Edit <code>app/globals.css</code> and Tailwind config</li> </ol>"},{"location":"chatbot/readme/#adding-built-in-tools","title":"Adding Built-in Tools","text":"<p>Edit <code>components/Chat.tsx</code> <code>useClientTools()</code> to add tools available to all users:</p> <pre><code>function useClientTools(): ToolDefinition[] {\n  return useMemo(() =&gt; [\n    // Existing get_current_time tool...\n    {\n      name: \"my_new_tool\",\n      description: \"Description for the AI\",\n      parameters: { /* JSON Schema */ },\n      handler: async (args) =&gt; {\n        // Implementation\n        return { result: \"...\" };\n      }\n    }\n  ], []);\n}\n</code></pre>"},{"location":"chatbot/readme/#theming","title":"Theming","text":"<p>The widget accepts a <code>bubbleColor</code> prop. For deeper theming, modify the <code>ChatWidget.tsx</code> component or extend the configuration.</p>"},{"location":"chatbot/readme/#troubleshooting","title":"Troubleshooting","text":""},{"location":"chatbot/readme/#failed-to-create-thread-error","title":"\"Failed to create thread\" Error","text":"<ul> <li>Verify backend is running at the configured <code>baseUrl</code></li> <li>Check CORS settings on the backend</li> <li>Ensure the room exists and user has access</li> </ul>"},{"location":"chatbot/readme/#no-messages-appearing","title":"No Messages Appearing","text":"<ul> <li>Check browser console for event type mismatches</li> <li>Verify backend sends UPPERCASE event types (<code>TEXT_MESSAGE_START</code>, not <code>text_message_start</code>)</li> <li>Check that <code>messageId</code> field exists in events (not <code>message_id</code>)</li> </ul>"},{"location":"chatbot/readme/#widget-not-rendering","title":"Widget Not Rendering","text":"<ul> <li>Ensure <code>SoliplexChat.init()</code> is called after the script loads</li> <li>Check for JavaScript errors in console</li> <li>Verify container element doesn't have conflicting CSS</li> </ul>"},{"location":"chatbot/readme/#tool-not-executing","title":"Tool Not Executing","text":"<ul> <li>Confirm handler function exists before <code>init()</code> is called</li> <li>Check the handler path is correct (e.g., <code>\"window.myTools.func\"</code> vs <code>\"myTools.func\"</code>)</li> <li>Ensure handler is async or returns a Promise</li> </ul>"},{"location":"chatbot/readme/#related-documentation","title":"Related Documentation","text":"<ul> <li>Widget Usage Guide - Embedding and tool examples</li> <li>AG-UI Protocol - Protocol specification</li> <li>PydanticAI - Backend agent framework</li> </ul>"},{"location":"chatbot/usage/","title":"Soliplex Chat Widget - Usage Guide","text":"<p>This guide explains how to embed the Soliplex Chat widget into any website.</p>"},{"location":"chatbot/usage/#quick-start","title":"Quick Start","text":"<p>Add the following to your HTML page:</p> <pre><code>&lt;script src=\"https://your-domain.com/soliplex-chat.js\"&gt;&lt;/script&gt;\n&lt;script&gt;\n  SoliplexChat.init({\n    baseUrl: \"http://localhost:8000\"\n  });\n&lt;/script&gt;\n</code></pre> <p>That's it! A chat bubble will appear in the bottom-right corner of your page. When clicked, users will see a list of available chat rooms to choose from.</p>"},{"location":"chatbot/usage/#configuration-options","title":"Configuration Options","text":"Option Type Default Description <code>baseUrl</code> string required Backend API URL (e.g., <code>http://localhost:8000</code>) <code>roomIds</code> string[] <code>[]</code> Room IDs to show; empty or omit to show all available rooms <code>autoHideSeconds</code> number <code>0</code> Seconds until bubble auto-hides (0 = never hide) <code>position</code> string <code>\"bottom-right\"</code> <code>\"bottom-right\"</code> or <code>\"bottom-left\"</code> <code>bubbleColor</code> string <code>\"#2563eb\"</code> CSS color for the chat bubble <code>title</code> string <code>\"Chat with us\"</code> Title shown in the chat header (room selector screen) <code>placeholder</code> string - Placeholder text for empty chat (overrides room's welcome message) <code>tools</code> array <code>[]</code> Custom client-side tools (see below) <code>containerId</code> string <code>\"soliplex-chat-widget\"</code> DOM element ID for the widget container <p>Note: The <code>roomId</code> option is still supported for backwards compatibility and will be converted to <code>roomIds: [roomId]</code>.</p>"},{"location":"chatbot/usage/#example-with-all-options","title":"Example with All Options","text":"<pre><code>&lt;script src=\"https://your-domain.com/soliplex-chat.js\"&gt;&lt;/script&gt;\n&lt;script&gt;\n  SoliplexChat.init({\n    baseUrl: \"https://api.example.com\",\n    roomIds: [\"support\", \"sales\"],  // Only show these rooms\n    autoHideSeconds: 30,\n    position: \"bottom-left\",\n    bubbleColor: \"#10b981\",\n    title: \"Need help?\",\n    containerId: \"my-chat-widget\"\n  });\n&lt;/script&gt;\n</code></pre>"},{"location":"chatbot/usage/#room-selection-behavior","title":"Room Selection Behavior","text":"<p>The widget fetches available rooms from <code>GET /api/v1/rooms</code> when opened:</p> <ul> <li>No <code>roomIds</code> specified: Shows all available rooms from the backend</li> <li><code>roomIds</code> with multiple IDs: Shows only those rooms, user picks one</li> <li><code>roomIds</code> with single ID: Auto-selects that room, skips room selection</li> <li><code>roomIds</code> with IDs not in backend: Those rooms are filtered out</li> </ul> <p>Once a room is selected, the header shows the room's name and a back button (if multiple rooms are available) to return to room selection.</p>"},{"location":"chatbot/usage/#api-methods","title":"API Methods","text":""},{"location":"chatbot/usage/#soliplexchatinitconfig","title":"<code>SoliplexChat.init(config)</code>","text":"<p>Initializes the widget with the given configuration. Can only be called once. Call <code>destroy()</code> first if you need to reinitialize.</p>"},{"location":"chatbot/usage/#soliplexchatopen","title":"<code>SoliplexChat.open()</code>","text":"<p>Programmatically opens the chat panel.</p> <pre><code>document.getElementById('help-button').addEventListener('click', () =&gt; {\n  SoliplexChat.open();\n});\n</code></pre>"},{"location":"chatbot/usage/#soliplexchatclose","title":"<code>SoliplexChat.close()</code>","text":"<p>Programmatically closes the chat panel.</p>"},{"location":"chatbot/usage/#soliplexchatdestroy","title":"<code>SoliplexChat.destroy()</code>","text":"<p>Completely removes the widget from the page. Useful for cleanup or reinitializing with different config.</p> <pre><code>// Change configuration\nSoliplexChat.destroy();\nSoliplexChat.init({ ...newConfig });\n</code></pre>"},{"location":"chatbot/usage/#auto-hide-feature","title":"Auto-Hide Feature","text":"<p>Set <code>autoHideSeconds</code> to automatically hide the bubble after a period of inactivity:</p> <pre><code>SoliplexChat.init({\n  baseUrl: \"http://localhost:8000\",\n  autoHideSeconds: 15  // Hide after 15 seconds if user hasn't interacted\n});\n</code></pre> <p>The bubble will reappear when the user moves their mouse near the corner where it was positioned.</p>"},{"location":"chatbot/usage/#client-side-tools","title":"Client-Side Tools","text":"<p>Tools allow the AI agent to execute JavaScript functions in the user's browser. This is useful for:</p> <ul> <li>Getting information from the current page</li> <li>Interacting with your application's state</li> <li>Performing client-side actions</li> </ul>"},{"location":"chatbot/usage/#tool-definition-structure","title":"Tool Definition Structure","text":"<pre><code>{\n  name: \"tool_name\",           // Unique identifier (snake_case recommended)\n  description: \"...\",          // What the tool does (helps the AI decide when to use it)\n  parameters: {                // JSON Schema for the tool's arguments\n    type: \"object\",\n    properties: {\n      param1: { type: \"string\", description: \"...\" },\n      param2: { type: \"number\", description: \"...\" }\n    },\n    required: [\"param1\"]       // Optional: list of required parameters\n  },\n  handler: \"path.to.function\"  // String path OR inline function\n}\n</code></pre>"},{"location":"chatbot/usage/#handler-types","title":"Handler Types","text":"<p>String Reference - Points to a function on the <code>window</code> object:</p> <pre><code>window.myApp = {\n  tools: {\n    getUser: async () =&gt; ({ name: \"John\", email: \"john@example.com\" })\n  }\n};\n\n// In config:\nhandler: \"myApp.tools.getUser\"\n</code></pre> <p>Inline Function - Define the handler directly:</p> <pre><code>handler: async (args) =&gt; {\n  return { result: args.value * 2 };\n}\n</code></pre>"},{"location":"chatbot/usage/#examples","title":"Examples","text":""},{"location":"chatbot/usage/#example-1-page-information-tool","title":"Example 1: Page Information Tool","text":"<p>Get information about the current page:</p> <pre><code>&lt;script src=\"soliplex-chat.js\"&gt;&lt;/script&gt;\n&lt;script&gt;\n  window.pageTools = {\n    getPageInfo: async () =&gt; ({\n      title: document.title,\n      url: window.location.href,\n      referrer: document.referrer,\n      scrollPosition: window.scrollY,\n      viewportHeight: window.innerHeight,\n      documentHeight: document.documentElement.scrollHeight\n    })\n  };\n\n  SoliplexChat.init({\n    baseUrl: \"http://localhost:8000\",\n    roomIds: [\"support\"],\n    tools: [\n      {\n        name: \"get_page_info\",\n        description: \"Get information about the current page including URL, title, and scroll position\",\n        parameters: { type: \"object\", properties: {} },\n        handler: \"pageTools.getPageInfo\"\n      }\n    ]\n  });\n&lt;/script&gt;\n</code></pre>"},{"location":"chatbot/usage/#example-2-e-commerce-tools","title":"Example 2: E-commerce Tools","text":"<p>Tools for an e-commerce site:</p> <pre><code>&lt;script src=\"soliplex-chat.js\"&gt;&lt;/script&gt;\n&lt;script&gt;\n  window.shopTools = {\n    getCart: async () =&gt; {\n      // Your cart implementation\n      const cart = JSON.parse(localStorage.getItem('cart') || '[]');\n      return {\n        items: cart,\n        itemCount: cart.length,\n        total: cart.reduce((sum, item) =&gt; sum + item.price * item.quantity, 0)\n      };\n    },\n\n    addToCart: async ({ productId, quantity = 1 }) =&gt; {\n      const cart = JSON.parse(localStorage.getItem('cart') || '[]');\n      const existing = cart.find(item =&gt; item.productId === productId);\n\n      if (existing) {\n        existing.quantity += quantity;\n      } else {\n        // Fetch product details from your API\n        cart.push({ productId, quantity, price: 29.99, name: `Product ${productId}` });\n      }\n\n      localStorage.setItem('cart', JSON.stringify(cart));\n      return { success: true, cartSize: cart.length };\n    },\n\n    searchProducts: async ({ query, category }) =&gt; {\n      // Mock search - replace with your API\n      return {\n        results: [\n          { id: \"1\", name: \"Blue T-Shirt\", price: 29.99, category: \"clothing\" },\n          { id: \"2\", name: \"Red Sneakers\", price: 89.99, category: \"shoes\" }\n        ].filter(p =&gt;\n          p.name.toLowerCase().includes(query.toLowerCase()) &amp;&amp;\n          (!category || p.category === category)\n        )\n      };\n    }\n  };\n\n  SoliplexChat.init({\n    baseUrl: \"http://localhost:8000\",\n    roomIds: [\"shop-assistant\"],\n    bubbleColor: \"#f97316\",\n    title: \"Shopping Assistant\",\n    tools: [\n      {\n        name: \"get_cart\",\n        description: \"Get the current shopping cart contents and total\",\n        parameters: { type: \"object\", properties: {} },\n        handler: \"shopTools.getCart\"\n      },\n      {\n        name: \"add_to_cart\",\n        description: \"Add a product to the shopping cart\",\n        parameters: {\n          type: \"object\",\n          properties: {\n            productId: {\n              type: \"string\",\n              description: \"The product ID to add\"\n            },\n            quantity: {\n              type: \"number\",\n              description: \"Quantity to add (default: 1)\"\n            }\n          },\n          required: [\"productId\"]\n        },\n        handler: \"shopTools.addToCart\"\n      },\n      {\n        name: \"search_products\",\n        description: \"Search for products by name or category\",\n        parameters: {\n          type: \"object\",\n          properties: {\n            query: {\n              type: \"string\",\n              description: \"Search query\"\n            },\n            category: {\n              type: \"string\",\n              description: \"Optional category filter\"\n            }\n          },\n          required: [\"query\"]\n        },\n        handler: \"shopTools.searchProducts\"\n      }\n    ]\n  });\n&lt;/script&gt;\n</code></pre>"},{"location":"chatbot/usage/#example-3-form-helper-tools","title":"Example 3: Form Helper Tools","text":"<p>Tools to help users fill out forms:</p> <pre><code>&lt;script src=\"soliplex-chat.js\"&gt;&lt;/script&gt;\n&lt;script&gt;\n  window.formTools = {\n    getFormFields: async () =&gt; {\n      const form = document.querySelector('form');\n      if (!form) return { error: \"No form found on page\" };\n\n      const fields = Array.from(form.elements)\n        .filter(el =&gt; el.name)\n        .map(el =&gt; ({\n          name: el.name,\n          type: el.type,\n          label: document.querySelector(`label[for=\"${el.id}\"]`)?.textContent || el.name,\n          value: el.value,\n          required: el.required\n        }));\n\n      return { fields };\n    },\n\n    fillField: async ({ fieldName, value }) =&gt; {\n      const field = document.querySelector(`[name=\"${fieldName}\"]`);\n      if (!field) return { error: `Field \"${fieldName}\" not found` };\n\n      field.value = value;\n      field.dispatchEvent(new Event('input', { bubbles: true }));\n      field.dispatchEvent(new Event('change', { bubbles: true }));\n\n      return { success: true, field: fieldName, newValue: value };\n    },\n\n    validateForm: async () =&gt; {\n      const form = document.querySelector('form');\n      if (!form) return { error: \"No form found\" };\n\n      const errors = [];\n      form.querySelectorAll('[required]').forEach(field =&gt; {\n        if (!field.value.trim()) {\n          errors.push({\n            field: field.name,\n            message: `${field.name} is required`\n          });\n        }\n      });\n\n      return {\n        valid: errors.length === 0,\n        errors\n      };\n    }\n  };\n\n  SoliplexChat.init({\n    baseUrl: \"http://localhost:8000\",\n    roomIds: [\"form-helper\"],\n    title: \"Form Assistant\",\n    tools: [\n      {\n        name: \"get_form_fields\",\n        description: \"Get all form fields on the current page with their labels and values\",\n        parameters: { type: \"object\", properties: {} },\n        handler: \"formTools.getFormFields\"\n      },\n      {\n        name: \"fill_field\",\n        description: \"Fill a form field with a value\",\n        parameters: {\n          type: \"object\",\n          properties: {\n            fieldName: { type: \"string\", description: \"The name attribute of the field\" },\n            value: { type: \"string\", description: \"The value to set\" }\n          },\n          required: [\"fieldName\", \"value\"]\n        },\n        handler: \"formTools.fillField\"\n      },\n      {\n        name: \"validate_form\",\n        description: \"Check if all required form fields are filled\",\n        parameters: { type: \"object\", properties: {} },\n        handler: \"formTools.validateForm\"\n      }\n    ]\n  });\n&lt;/script&gt;\n</code></pre>"},{"location":"chatbot/usage/#example-4-user-context-tools","title":"Example 4: User Context Tools","text":"<p>Tools that provide user context to the AI:</p> <pre><code>&lt;script src=\"soliplex-chat.js\"&gt;&lt;/script&gt;\n&lt;script&gt;\n  window.userTools = {\n    getUserInfo: async () =&gt; {\n      // Get from your auth system\n      const user = JSON.parse(localStorage.getItem('user') || 'null');\n      return user ? {\n        loggedIn: true,\n        name: user.name,\n        email: user.email,\n        memberSince: user.createdAt,\n        plan: user.subscription\n      } : {\n        loggedIn: false\n      };\n    },\n\n    getPreferences: async () =&gt; {\n      return {\n        theme: localStorage.getItem('theme') || 'light',\n        language: navigator.language,\n        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n        notifications: localStorage.getItem('notifications') === 'true'\n      };\n    },\n\n    getBrowserInfo: async () =&gt; ({\n      userAgent: navigator.userAgent,\n      platform: navigator.platform,\n      language: navigator.language,\n      cookiesEnabled: navigator.cookieEnabled,\n      screenSize: `${screen.width}x${screen.height}`,\n      windowSize: `${window.innerWidth}x${window.innerHeight}`\n    })\n  };\n\n  SoliplexChat.init({\n    baseUrl: \"http://localhost:8000\",\n    roomIds: [\"support\"],\n    tools: [\n      {\n        name: \"get_user_info\",\n        description: \"Get information about the currently logged in user\",\n        parameters: { type: \"object\", properties: {} },\n        handler: \"userTools.getUserInfo\"\n      },\n      {\n        name: \"get_preferences\",\n        description: \"Get the user's preferences and settings\",\n        parameters: { type: \"object\", properties: {} },\n        handler: \"userTools.getPreferences\"\n      },\n      {\n        name: \"get_browser_info\",\n        description: \"Get technical information about the user's browser for debugging\",\n        parameters: { type: \"object\", properties: {} },\n        handler: \"userTools.getBrowserInfo\"\n      }\n    ]\n  });\n&lt;/script&gt;\n</code></pre>"},{"location":"chatbot/usage/#example-5-navigation-tools","title":"Example 5: Navigation Tools","text":"<p>Tools to help users navigate your site:</p> <pre><code>&lt;script src=\"soliplex-chat.js\"&gt;&lt;/script&gt;\n&lt;script&gt;\n  window.navTools = {\n    navigateTo: async ({ path }) =&gt; {\n      window.location.href = path;\n      return { navigating: true, destination: path };\n    },\n\n    scrollToSection: async ({ sectionId }) =&gt; {\n      const element = document.getElementById(sectionId);\n      if (!element) return { error: `Section \"${sectionId}\" not found` };\n\n      element.scrollIntoView({ behavior: 'smooth' });\n      return { success: true, scrolledTo: sectionId };\n    },\n\n    getSiteMap: async () =&gt; {\n      // Return your site structure\n      return {\n        pages: [\n          { path: \"/\", name: \"Home\" },\n          { path: \"/products\", name: \"Products\" },\n          { path: \"/about\", name: \"About Us\" },\n          { path: \"/contact\", name: \"Contact\" },\n          { path: \"/faq\", name: \"FAQ\" }\n        ]\n      };\n    },\n\n    highlightElement: async ({ selector }) =&gt; {\n      const element = document.querySelector(selector);\n      if (!element) return { error: \"Element not found\" };\n\n      const originalOutline = element.style.outline;\n      element.style.outline = \"3px solid #2563eb\";\n      element.scrollIntoView({ behavior: 'smooth', block: 'center' });\n\n      setTimeout(() =&gt; {\n        element.style.outline = originalOutline;\n      }, 3000);\n\n      return { success: true, highlighted: selector };\n    }\n  };\n\n  SoliplexChat.init({\n    baseUrl: \"http://localhost:8000\",\n    roomIds: [\"navigator\"],\n    title: \"Site Guide\",\n    tools: [\n      {\n        name: \"navigate_to\",\n        description: \"Navigate to a different page on the site\",\n        parameters: {\n          type: \"object\",\n          properties: {\n            path: { type: \"string\", description: \"The URL path to navigate to\" }\n          },\n          required: [\"path\"]\n        },\n        handler: \"navTools.navigateTo\"\n      },\n      {\n        name: \"scroll_to_section\",\n        description: \"Scroll to a specific section on the current page\",\n        parameters: {\n          type: \"object\",\n          properties: {\n            sectionId: { type: \"string\", description: \"The ID of the section to scroll to\" }\n          },\n          required: [\"sectionId\"]\n        },\n        handler: \"navTools.scrollToSection\"\n      },\n      {\n        name: \"get_site_map\",\n        description: \"Get a list of all pages on the site\",\n        parameters: { type: \"object\", properties: {} },\n        handler: \"navTools.getSiteMap\"\n      },\n      {\n        name: \"highlight_element\",\n        description: \"Highlight an element on the page to show the user where something is\",\n        parameters: {\n          type: \"object\",\n          properties: {\n            selector: { type: \"string\", description: \"CSS selector for the element to highlight\" }\n          },\n          required: [\"selector\"]\n        },\n        handler: \"navTools.highlightElement\"\n      }\n    ]\n  });\n&lt;/script&gt;\n</code></pre>"},{"location":"chatbot/usage/#built-in-tools","title":"Built-in Tools","text":"<p>The widget includes a built-in <code>get_current_time</code> tool that returns the current time in the user's local timezone. This is automatically available without any configuration.</p>"},{"location":"chatbot/usage/#troubleshooting","title":"Troubleshooting","text":""},{"location":"chatbot/usage/#widget-doesnt-appear","title":"Widget doesn't appear","text":"<ol> <li>Check browser console for errors</li> <li>Verify <code>baseUrl</code> is correct and the backend is running</li> <li>Ensure the script is loaded before calling <code>init()</code></li> </ol>"},{"location":"chatbot/usage/#tools-not-working","title":"Tools not working","text":"<ol> <li>Check that the handler path is correct (e.g., <code>\"myApp.tools.myFunction\"</code>)</li> <li>Verify the function exists on the <code>window</code> object before <code>init()</code> is called</li> <li>Check browser console for \"Handler not found\" errors</li> <li>Ensure your handler returns a Promise or is an async function</li> </ol>"},{"location":"chatbot/usage/#cors-errors","title":"CORS errors","text":"<p>Ensure your backend allows requests from your frontend domain:</p> <pre><code># FastAPI example\nfrom fastapi.middleware.cors import CORSMiddleware\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"http://localhost:3000\", \"https://yourdomain.com\"],\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n</code></pre>"},{"location":"flutter/guides/developer-setup/","title":"Developer Setup Guide","text":"<p>Platform-specific setup instructions for building and running the Soliplex Flutter frontend.</p>"},{"location":"flutter/guides/developer-setup/#prerequisites","title":"Prerequisites","text":"<ul> <li>Flutter SDK (stable channel)</li> <li>Xcode (for iOS/macOS)</li> <li>CocoaPods (<code>gem install cocoapods</code>)</li> </ul>"},{"location":"flutter/guides/developer-setup/#quick-start","title":"Quick Start","text":"<pre><code># Install dependencies\nflutter pub get\n\n# Install iOS/macOS pods\ncd ios &amp;&amp; pod install &amp;&amp; cd ..\ncd macos &amp;&amp; pod install &amp;&amp; cd ..\n\n# Run the app\nflutter run -d macos   # or: -d ios, -d chrome\n</code></pre>"},{"location":"flutter/guides/developer-setup/#platform-setup","title":"Platform Setup","text":""},{"location":"flutter/guides/developer-setup/#macos","title":"macOS","text":""},{"location":"flutter/guides/developer-setup/#code-signing-required-for-keychain","title":"Code Signing (Required for Keychain)","text":"<p>macOS apps require code signing to access Keychain for secure token storage. Each developer must configure their own Apple Developer Team ID:</p> <pre><code># 1. Copy the template\ncp macos/Runner/Configs/Local.xcconfig.template macos/Runner/Configs/Local.xcconfig\n\n# 2. Edit Local.xcconfig and add your Team ID\n</code></pre> <p>Your <code>Local.xcconfig</code> should contain:</p> <pre><code>DEVELOPMENT_TEAM = YOUR_TEAM_ID_HERE\n</code></pre> <p>Both iOS and macOS use Xcode's automatic signing, which selects the correct identity based on build type (development vs release).</p> <p>Finding your Team ID:</p> <ol> <li>Go to https://developer.apple.com/account</li> <li>Click \"Membership details\"</li> <li>Copy the 10-character Team ID (e.g., <code>XXXXXXXXXX</code>)</li> </ol> <p>Verification:</p> <pre><code>flutter build macos --debug\n</code></pre> <p>If configured correctly, Keychain operations succeed and auth tokens persist across app restarts.</p> <p>Without code signing: The app runs but Keychain fails silently. Auth works per-session but tokens don't persist, requiring re-login on each launch.</p>"},{"location":"flutter/guides/developer-setup/#ios","title":"iOS","text":""},{"location":"flutter/guides/developer-setup/#code-signing-required-for-physical-devices","title":"Code Signing (Required for Physical Devices)","text":"<p>iOS uses the same xcconfig pattern as macOS:</p> <pre><code># 1. Copy the template\ncp ios/Runner/Configs/Local.xcconfig.template ios/Runner/Configs/Local.xcconfig\n\n# 2. Edit Local.xcconfig and add your Team ID\n</code></pre> <p>Your <code>Local.xcconfig</code> should contain:</p> <pre><code>DEVELOPMENT_TEAM = YOUR_TEAM_ID_HERE\n</code></pre>"},{"location":"flutter/guides/developer-setup/#simulator-vs-device","title":"Simulator vs Device","text":"<ul> <li>Simulator: No signing required for debug builds</li> <li>Physical device: Requires <code>Local.xcconfig</code> with valid <code>DEVELOPMENT_TEAM</code></li> </ul>"},{"location":"flutter/guides/developer-setup/#building-for-testflightapp-store","title":"Building for TestFlight/App Store","text":"<p>CRITICAL: Use Flutter stable channel for production builds. Beta/dev channels can produce binaries that fail App Store validation.</p> <pre><code># Verify you're on stable channel\nflutter channel stable\nflutter upgrade\n\n# Build release IPA\nflutter build ipa --release\n\n# Upload using Transporter app\nopen -a Transporter build/ios/ipa/soliplex_frontend.ipa\n\n# Or use command line (requires API key)\nxcrun altool --upload-app --type ios -f build/ios/ipa/soliplex_frontend.ipa \\\n  --apiKey YOUR_API_KEY --apiIssuer YOUR_ISSUER_ID\n</code></pre> <p>The <code>flutter build ipa --release</code> command automatically:</p> <ul> <li>Uses <code>Apple Distribution</code> signing identity</li> <li>Includes debug symbols (dSYM files)</li> <li>Creates properly encrypted binary for App Store submission</li> </ul> <p>Troubleshooting validation errors: If you get \"binary not built with Apple's linker\" errors, ensure you're on Flutter stable channel, not beta or dev.</p>"},{"location":"flutter/guides/developer-setup/#web","title":"Web","text":"<p>No special setup required. Run with:</p> <pre><code>flutter run -d chrome\n</code></pre>"},{"location":"flutter/guides/developer-setup/#troubleshooting","title":"Troubleshooting","text":""},{"location":"flutter/guides/developer-setup/#entitlements-require-signing","title":"Entitlements require signing","text":"<pre><code>\"Runner\" has entitlements that require signing with a development certificate\n</code></pre> <p>Cause: Missing <code>Local.xcconfig</code> or <code>DEVELOPMENT_TEAM</code> not set.</p> <p>Fix: Create <code>Local.xcconfig</code> with <code>DEVELOPMENT_TEAM</code> as shown above.</p>"},{"location":"flutter/guides/developer-setup/#keychain-errors-on-macos","title":"Keychain errors on macOS","text":"<pre><code>OSStatus error -25293\n</code></pre> <p>Cause: Missing or invalid code signing configuration.</p> <p>Fix: Follow the macOS code signing setup above.</p>"},{"location":"flutter/guides/developer-setup/#pod-install-fails","title":"Pod install fails","text":"<pre><code># Clean and reinstall\ncd ios &amp;&amp; pod deintegrate &amp;&amp; pod install &amp;&amp; cd ..\ncd macos &amp;&amp; pod deintegrate &amp;&amp; pod install &amp;&amp; cd ..\n</code></pre>"},{"location":"flutter/guides/developer-setup/#flutter-version-issues","title":"Flutter version issues","text":"<pre><code># Check version\nflutter --version\n\n# Upgrade if needed\nflutter upgrade\n</code></pre>"},{"location":"flutter/guides/developer-setup/#related-files","title":"Related Files","text":"File Purpose <code>macos/Runner/Configs/Local.xcconfig.template</code> Template for macOS signing <code>macos/Runner/Configs/Local.xcconfig</code> Your macOS signing config (gitignored) <code>ios/Runner/Configs/Local.xcconfig.template</code> Template for iOS signing <code>ios/Runner/Configs/Local.xcconfig</code> Your iOS signing config (gitignored) <code>.gitignore</code> Excludes <code>**/Local.xcconfig</code>"},{"location":"flutter/planning/ROADMAP/","title":"Roadmap","text":""},{"location":"flutter/planning/ROADMAP/#version-overview","title":"Version Overview","text":"Version Theme Status v1.0 Core Functionality In Progress v1.1 Enhanced UX + Native Network Future v1.2 Power User Features Future v2.0 Advanced Features Future"},{"location":"flutter/planning/ROADMAP/#packages","title":"Packages","text":"Package Type Version Description <code>soliplex_client</code> Pure Dart v1.0 HTTP/AG-UI client, models, sessions <code>soliplex_client_native</code> Flutter v1.1 Native HTTP adapters (iOS, Android, Windows, Linux, Web) <code>soliplex_core</code> Flutter v1.0 P4 Core frontend extracted (providers, config, registries)"},{"location":"flutter/planning/ROADMAP/#v10-core-functionality","title":"v1.0 - Core Functionality","text":""},{"location":"flutter/planning/ROADMAP/#milestones","title":"Milestones","text":"<p>v1.0 uses a two-tier milestone system:</p> <ul> <li>Developer Milestones (DM): Client library work, verified by unit tests (85%+ coverage)</li> <li>App Milestones (AM): End-user testable features</li> </ul>"},{"location":"flutter/planning/ROADMAP/#developer-milestones-dm-client-package","title":"Developer Milestones (DM) - Client Package","text":"# Name Components Test Criteria Status DM1 Models &amp; Errors ChatMessage, Room, ThreadInfo, RunInfo, all exceptions 100% model coverage Done DM2 HTTP Adapter HttpClientAdapter (interface), DartHttpAdapter, AdapterResponse Request/response cycle works Done DM3 Network Observer HttpObserver (interface), ObservableHttpAdapter (decorator) HTTP traffic observable Done DM4 HTTP Transport HttpTransport, UrlBuilder, CancelToken JSON serialization, URL building, cancellation Done DM5 API Layer SoliplexApi (CRUD) Can fetch rooms, threads via API Done DM6 AG-UI Protocol Thread, TextMessageBuffer, ToolCallBuffer, ToolRegistry Event streaming works Done DM7 Sessions ConnectionManager, RoomSession Multi-room management works - DM8 Facade SoliplexClient, chat() flow Integration tests pass -"},{"location":"flutter/planning/ROADMAP/#app-milestones-am-end-user-testable","title":"App Milestones (AM) - End-User Testable","text":"# Name Phases Requires DM User Can Test Status AM1 App Shell Core P1 DM1 Launch app, navigate \u2705 Done AM2 Connected Data - DM1-DM5 See real rooms &amp; threads from backend \u2705 Done AM3 Working Chat Core P2, Chat P1, History P1 DM6 Send message, receive AI response \u2705 Done AM4 Full Chat Chat P2-P3, History P2-P4 - Streaming, markdown, thread management - AM5 Inspector Detail P1-P4 - Events, thinking, tool calls, state - AM6 Canvas Current Canvas P1-P3, Permanent Canvas P1-P3 - State snapshots, pin items - AM7* Authentication - DM7-DM8 Login, token refresh - AM8* Polish Core P3-P4 DM7-DM8 Multi-room, white-label ready -"},{"location":"flutter/planning/ROADMAP/#milestone-dependencies","title":"Milestone Dependencies","text":"<pre><code>            DM Track (Developer Milestones)\nDM1 \u2192 DM2 \u2192 DM3 \u2192 DM4 \u2192 DM5 \u2192 DM6 \u2192 DM7 \u2192 DM8\n \u2502                        \u2502      \u2502          \u2502\n \u25bc                        \u25bc      \u25bc          \u25bc\nAM1 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba AM2 \u2500\u25ba AM3 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n(App Shell)         (Connected) (Chat)\n                                 \u2502\n                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u25bc            \u25bc            \u25bc\n                  AM4          AM5          AM6\n                (Full Chat) (Inspector)  (Canvas)\n                    \u2502            \u2502            \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                                 \u25bc\n                               AM7\n</code></pre>"},{"location":"flutter/planning/ROADMAP/#priority-1-client-phases-dm1-dm8","title":"Priority 1: Client (Phases \u2192 DM1-DM8)","text":"<p>Package: <code>soliplex_client</code> (Pure Dart)</p> Phase Goal Milestone 1 Models &amp; errors DM1 2a HTTP adapter interface + DartHttpAdapter DM2 2b HttpObserver + ObservableHttpAdapter DM3 2c HttpTransport, UrlBuilder, CancelToken DM4 3 API layer (SoliplexApi) DM5 4 AG-UI protocol (Thread, buffers, tool registry) DM6 5 Sessions (ConnectionManager, RoomSession) DM7 6 Facade (SoliplexClient) DM8"},{"location":"flutter/planning/ROADMAP/#priority-2-core-frontend-4-phases","title":"Priority 2: Core Frontend (4 Phases)","text":"<p>Depends on: DM1 (AM1), DM6 (AM3)</p> Phase Goal Milestone 1 Project setup, navigation AM1 2 ActiveRunNotifier + extensions AM3 3 Extensibility: SoliplexConfig, SoliplexRegistry AM7 4 Polish, extract to <code>soliplex_core</code> package AM7 <p>Extensibility (Level 2):</p> <ul> <li><code>SoliplexConfig</code>: Branding, feature flags, default routes, servers</li> <li><code>SoliplexRegistry</code>: Custom widgets, slash commands, panels, routes</li> <li><code>PanelRegistry</code>, <code>CommandRegistry</code>, <code>RouteDefinition</code> abstractions</li> </ul>"},{"location":"flutter/planning/ROADMAP/#priority-3-ui-components","title":"Priority 3: UI Components","text":"<p>Depends on: AM3 (Core Frontend phase 2)</p> Component Phases Milestone history 4 AM3 (P1), AM4 (P2-P4) chat 3 AM3 (P1), AM4 (P2-P3) detail 4 AM5 current_canvas 3 AM6 permanent_canvas 3 AM6"},{"location":"flutter/planning/ROADMAP/#v11-enhanced-ux-native-network","title":"v1.1 - Enhanced UX + Native Network","text":"<p>Chat: Media messages, tool call visualization, message search History: Thread deletion/renaming/grouping Detail: Event export, chat message linking Core: Token refresh, desktop polish Network (<code>soliplex_client_native</code> package):</p> <ul> <li>Native HTTP clients (Cupertino, Android, Windows, Linux, Web)</li> <li>Certificate pinning</li> <li>Platform auto-detection via <code>createPlatformClient()</code></li> </ul>"},{"location":"flutter/planning/ROADMAP/#v12-power-user-features","title":"v1.2 - Power User Features","text":"<p>History: Pagination, search, reorder Detail: Event comparison/replay, performance metrics, timeline Canvas: Export, history, custom renderers Permanent Canvas: Folders, markdown export</p>"},{"location":"flutter/planning/ROADMAP/#v20-advanced-features","title":"v2.0 - Advanced Features","text":"<p>Cloud sync, offline support, push notifications</p>"},{"location":"flutter/planning/ROADMAP/#dependencies","title":"Dependencies","text":"<pre><code>v1.0 \u2192 v1.1 (Native adapters, UX polish)\n     \u2192 v1.2 (Power features)\n          \u2192 v2.0 (Cloud, offline)\n</code></pre>"},{"location":"flutter/planning/backend-frontend-integration/","title":"Backend-Frontend Integration Notes","text":"<p>This document tracks backend changes needed for web platform support, organized by priority.</p>"},{"location":"flutter/planning/backend-frontend-integration/#quick-reference-backend-changes-needed","title":"Quick Reference: Backend Changes Needed","text":""},{"location":"flutter/planning/backend-frontend-integration/#blocking-web-platform-non-functional-without-these","title":"\ud83d\udeab BLOCKING - Web Platform Non-Functional Without These","text":"Change Endpoint Description BFF Token Refresh <code>POST /api/refresh</code> Proxy refresh requests to IdP (CORS blocks direct calls)"},{"location":"flutter/planning/backend-frontend-integration/#security-recommended-for-production","title":"\ud83d\udd12 SECURITY - Recommended for Production","text":"Change Endpoint Description OAuth State Parameter <code>/api/login/{provider}</code> Echo <code>state</code> param for CSRF protection Fragment-based Tokens Callback redirect Use <code>#token=</code> instead of <code>?token=</code>"},{"location":"flutter/planning/backend-frontend-integration/#convenience-simplifies-frontend-code","title":"\u2728 CONVENIENCE - Simplifies Frontend Code","text":"Change Endpoint Description Include id_token Callback redirect Enables proper OIDC logout Include Issuer Metadata Callback redirect Removes need for PreAuthState storage"},{"location":"flutter/planning/backend-frontend-integration/#api-specifications","title":"API Specifications","text":""},{"location":"flutter/planning/backend-frontend-integration/#1-bff-token-refresh-endpoint-blocking","title":"1. BFF Token Refresh Endpoint (BLOCKING)","text":"<p>Status: \u274c Missing - Web auth broken without this</p> <p>Why needed: Frontend cannot call IdP token endpoint directly due to CORS. Browsers block cross-origin requests to <code>https://pydio-kc.enfoldsystems.net/...</code> from the frontend origin.</p> <p>Error without this:</p> <pre><code>Access to fetch at 'https://pydio-kc.../token' from origin 'http://localhost:...'\nhas been blocked by CORS policy: No 'Access-Control-Allow-Origin' header\n</code></pre> <p>Specification:</p> <pre><code>POST /api/refresh\nContent-Type: application/json\n\nRequest:\n{\n  \"refresh_token\": \"eyJhbGci...\"\n}\n\nResponse (success):\n{\n  \"access_token\": \"eyJhbGci...\",\n  \"refresh_token\": \"eyJhbGci...\",   // New refresh token if rotated\n  \"expires_in\": 3600,\n  \"token_type\": \"Bearer\"\n}\n\nResponse (error - invalid/expired refresh token):\nHTTP 401\n{\n  \"error\": \"invalid_grant\",\n  \"error_description\": \"Refresh token expired\"\n}\n\nResponse (error - other):\nHTTP 500\n{\n  \"error\": \"server_error\",\n  \"error_description\": \"...\"\n}\n</code></pre> <p>Backend implementation:</p> <ol> <li>Extract <code>refresh_token</code> from request body</li> <li>Call IdP token endpoint server-side:</li> </ol> <pre><code>POST https://{idp}/protocol/openid-connect/token\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=refresh_token&amp;\nrefresh_token={refresh_token}&amp;\nclient_id={client_id}&amp;\nclient_secret={client_secret}  // If confidential client\n</code></pre> <ol> <li>Return IdP response to frontend (or transform errors)</li> </ol> <p>Frontend changes when ready:</p> <ul> <li><code>packages/soliplex_client/lib/src/auth/token_refresh_service.dart</code></li> <li><code>lib/core/auth/auth_notifier.dart</code></li> </ul>"},{"location":"flutter/planning/backend-frontend-integration/#2-oauth-state-parameter-echo-security","title":"2. OAuth State Parameter Echo (SECURITY)","text":"<p>Status: \u26a0\ufe0f Missing - CSRF vulnerability (CAT II)</p> <p>Current behavior: BFF ignores any <code>state</code> parameter in the OAuth flow.</p> <p>Why needed: OAuth 2.0 RFC 6749 Section 10.12 requires <code>state</code> for CSRF protection. Without it, an attacker could:</p> <ol> <li>Start OAuth flow on their own device</li> <li>Get the callback URL with tokens</li> <li>Trick victim into visiting that URL</li> <li>Victim's session now uses attacker's account</li> </ol> <p>Specification:</p> <pre><code>Current:\n  GET /api/login/pydio?return_to=https://app.example.com/callback\n  \u2192 Redirects to IdP\n  \u2192 IdP redirects to: https://app.example.com/callback?token=xxx\n\nWith state:\n  GET /api/login/pydio?return_to=https://app.example.com/callback&amp;state=abc123\n  \u2192 Redirects to IdP with state=abc123\n  \u2192 IdP redirects to: https://app.example.com/callback?token=xxx&amp;state=abc123\n</code></pre> <p>Backend implementation:</p> <ol> <li>Accept <code>state</code> parameter in <code>/api/login/{provider}</code></li> <li>Include <code>state</code> in redirect to IdP</li> <li>Echo <code>state</code> in callback redirect URL</li> </ol> <p>Frontend changes when ready:</p> <ul> <li><code>lib/core/auth/auth_flow_web.dart</code> - Generate cryptographic state</li> <li><code>lib/core/auth/auth_notifier.dart</code> - Validate state in callback</li> </ul>"},{"location":"flutter/planning/backend-frontend-integration/#3-fragment-based-token-delivery-security","title":"3. Fragment-Based Token Delivery (SECURITY)","text":"<p>Status: \u26a0\ufe0f Current method exposes tokens (CAT III)</p> <p>Current behavior: Tokens in URL query string <code>?token=xxx</code> are:</p> <ul> <li>Visible in browser address bar for ~1-2 seconds</li> <li>Stored in browser history</li> <li>Potentially sent in Referer headers</li> </ul> <p>Why needed: URL fragments (<code>#token=xxx</code>) are:</p> <ul> <li>Never sent in HTTP requests (including Referer)</li> <li>Not stored in browser history in the same way</li> <li>Cleared faster by frontend code</li> </ul> <p>Specification:</p> <pre><code>Current:\n  Redirect to: https://app.example.com/?token=xxx&amp;refresh_token=yyy\n\nWith fragments:\n  Redirect to: https://app.example.com/#access_token=xxx&amp;refresh_token=yyy&amp;expires_in=3600\n</code></pre> <p>Note: This follows the OAuth 2.0 Implicit Flow response format, which is well-understood by frontend libraries.</p> <p>Frontend changes when ready:</p> <ul> <li><code>lib/core/auth/web_auth_callback_web.dart</code> - Extract from fragment</li> <li><code>lib/core/auth/callback_params.dart</code> - Update parameter model</li> </ul>"},{"location":"flutter/planning/backend-frontend-integration/#4-include-id_token-in-callback-convenience","title":"4. Include id_token in Callback (CONVENIENCE)","text":"<p>Status: \u26a0\ufe0f Missing - Logout doesn't terminate IdP session</p> <p>Current behavior: BFF callback only returns <code>token</code>, <code>refresh_token</code>, <code>expires_in</code>. No <code>id_token</code> is provided.</p> <p>Why needed: OIDC logout (<code>end_session_endpoint</code>) requires <code>id_token_hint</code> to properly terminate the IdP session. Without it:</p> <ul> <li>User clicks \"Logout\" in app</li> <li>App clears local tokens</li> <li>User visits app again</li> <li>IdP auto-logs them in (session still active)</li> </ul> <p>Specification:</p> <pre><code>Current:\n  ?token=xxx&amp;refresh_token=yyy&amp;expires_in=3600\n\nWith id_token:\n  ?token=xxx&amp;refresh_token=yyy&amp;expires_in=3600&amp;id_token=zzz\n</code></pre> <p>Frontend changes when ready:</p> <ul> <li><code>lib/core/auth/callback_params.dart</code> - Add <code>idToken</code> field</li> <li><code>lib/core/auth/auth_flow_web.dart</code> - Use for <code>endSession()</code></li> </ul>"},{"location":"flutter/planning/backend-frontend-integration/#5-include-issuer-metadata-in-callback-convenience","title":"5. Include Issuer Metadata in Callback (CONVENIENCE)","text":"<p>Status: \u26a0\ufe0f Missing - Frontend uses complex workaround</p> <p>Current behavior: Frontend must:</p> <ol> <li>Store issuer info in localStorage before OAuth redirect (<code>PreAuthState</code>)</li> <li>Set 5-minute expiry for security</li> <li>Load and validate after callback</li> <li>Clean up storage</li> </ol> <p>Why needed: Simplifies frontend significantly. Frontend needs issuer metadata (discovery URL, client ID) for token refresh.</p> <p>Specification:</p> <pre><code>Current:\n  ?token=xxx&amp;refresh_token=yyy&amp;expires_in=3600\n\nWith metadata:\n  ?token=xxx&amp;refresh_token=yyy&amp;expires_in=3600&amp;issuer_id=pydio&amp;discovery_url=https://...&amp;client_id=xxx\n</code></pre> <p>Alternative: If implementing BFF refresh endpoint (#1), this becomes less important since the backend handles refresh internally.</p> <p>Frontend changes when ready:</p> <ul> <li><code>lib/core/auth/callback_params.dart</code> - Add issuer fields</li> <li><code>lib/core/auth/auth_notifier.dart</code> - Remove PreAuthState handling</li> <li><code>lib/core/auth/auth_storage.dart</code> - Remove PreAuthState methods</li> </ul>"},{"location":"flutter/planning/backend-frontend-integration/#current-frontend-workarounds","title":"Current Frontend Workarounds","text":"Issue Workaround Limitation Token refresh CORS None \u274c Web auth broken after token expires CSRF (no state) PreAuthState with 5-min expiry Narrow attack window remains Tokens in URL Clear via <code>replaceState()</code> in main() ~1-2s visibility during load No id_token Skip IdP logout Users auto-login on return No issuer metadata PreAuthState localStorage Complex code, expiry handling"},{"location":"flutter/planning/backend-frontend-integration/#summary-table","title":"Summary Table","text":"Issue Priority Security Frontend Impact Backend Effort No BFF refresh BLOCKING N/A Broken Medium No state param Security CAT II Workaround exists Low Tokens in query Security CAT III Workaround exists Medium No id_token Convenience None Workaround exists Low No issuer metadata Convenience None Complex workaround Low"},{"location":"flutter/planning/backend-frontend-integration/#references","title":"References","text":"<ul> <li>OAuth 2.0 RFC 6749: https://datatracker.ietf.org/doc/html/rfc6749</li> <li>OAuth 2.0 Security BCP: https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics</li> <li>OIDC Core 1.0: https://openid.net/specs/openid-connect-core-1_0.html</li> <li>OWASP CSRF Prevention: https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html</li> </ul>"},{"location":"flutter/planning/fix-stale-messages-on-thread-switch/","title":"Fix: Stale Messages on Thread/Room Switch","text":""},{"location":"flutter/planning/fix-stale-messages-on-thread-switch/#problem","title":"Problem","text":"<p>When switching threads/rooms, stale messages from the previous thread appeared.</p>"},{"location":"flutter/planning/fix-stale-messages-on-thread-switch/#root-cause","title":"Root Cause","text":"<ol> <li><code>activeRunNotifierProvider</code> didn't reset on thread change</li> <li>No historical message fetching - messages lost on thread switch</li> </ol>"},{"location":"flutter/planning/fix-stale-messages-on-thread-switch/#solution","title":"Solution","text":"<ol> <li>Reset on thread change - Listen to <code>threadSelectionProvider</code>, call <code>reset()</code>    when leaving a selected thread</li> <li>Message caching - <code>ThreadMessageCache</code> as single source of truth with    backend fetch on miss</li> <li>Explicit room binding - <code>HistoryPanel</code> receives <code>roomId</code> as parameter    (eliminates timing bugs)</li> </ol>"},{"location":"flutter/planning/fix-stale-messages-on-thread-switch/#architecture","title":"Architecture","text":"<pre><code>Thread Selection\n      \u2502\n      \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 threadMessageCacheProvider  \u2502 \u2190 Single source of truth\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2502\n     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n     \u2502 Cache hit?        \u2502\n     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n           Yes \u2502           No\n               \u2502            \u2502\n               \u25bc            \u25bc\n       Return cached    api.getThreadMessages()\n       (instant)        \u2192 cache \u2192 return\n</code></pre>"},{"location":"flutter/planning/fix-stale-messages-on-thread-switch/#key-design-decisions","title":"Key Design Decisions","text":"<ol> <li><code>reset()</code> clears immediately, disposes async - UI updates instantly,    cleanup in background</li> <li>Listen to sealed <code>ThreadSelection</code> - Type-safe <code>previous is ThreadSelected</code>    vs nullable string checks</li> <li>Single cache provider - Avoids dual source of truth between run state    and historical messages</li> <li>Event replay via <code>processEvent()</code> - Reuses existing logic for consistency</li> <li>In-flight request deduplication - <code>_inFlightFetches</code> map prevents    concurrent API calls for same thread</li> </ol>"},{"location":"flutter/planning/fix-stale-messages-on-thread-switch/#implementation-summary","title":"Implementation Summary","text":"Component Change <code>ActiveRunNotifier</code> Listens to thread selection, resets on change <code>ThreadMessageCache</code> New provider: cache + fetch-on-miss <code>allMessagesProvider</code> Now <code>FutureProvider</code>, merges cached + streaming <code>SoliplexApi</code> Added <code>getThreadMessages()</code> with event replay <code>HistoryPanel</code> Explicit <code>roomId</code> parameter (not derived from provider) <code>MessageList</code> Handles <code>AsyncValue&lt;List&lt;ChatMessage&gt;&gt;</code>"},{"location":"flutter/planning/fix-stale-messages-on-thread-switch/#files-changed","title":"Files Changed","text":"<p>Core providers:</p> <ul> <li><code>lib/core/providers/active_run_notifier.dart</code> - thread listener, async reset</li> <li><code>lib/core/providers/active_run_provider.dart</code> - <code>allMessagesProvider</code> as FutureProvider</li> <li><code>lib/core/providers/thread_message_cache.dart</code> - new cache provider</li> </ul> <p>UI:</p> <ul> <li><code>lib/features/history/history_panel.dart</code> - explicit <code>roomId</code> parameter</li> <li><code>lib/features/room/room_screen.dart</code> - passes <code>roomId</code> to HistoryPanel</li> <li><code>lib/features/chat/widgets/message_list.dart</code> - AsyncValue handling</li> </ul> <p>Client:</p> <ul> <li><code>packages/soliplex_client/lib/src/api/soliplex_api.dart</code> - <code>getThreadMessages()</code></li> </ul>"},{"location":"flutter/planning/fix-stale-messages-on-thread-switch/#acceptance-criteria","title":"Acceptance Criteria","text":"<ul> <li>[x] <code>reset()</code> is async with immediate state clear</li> <li>[x] State resets when leaving a selected thread</li> <li>[x] No reset on initial thread selection</li> <li>[x] Historical messages fetched from backend</li> <li>[x] Cache prevents redundant API calls</li> <li>[x] Messages deduplicated (cached + streaming)</li> <li>[x] Run completion updates cache</li> <li>[x] HistoryPanel shows correct room's threads</li> <li>[x] All tests pass (461)</li> <li>[x] Analyzer reports 0 issues</li> </ul>"},{"location":"flutter/planning/navigation-review-fixes/","title":"Navigation Refactor: Review Fixes","text":"<p>Follow-up fixes from code review of <code>refactor/navigation</code> branch.</p>"},{"location":"flutter/planning/navigation-review-fixes/#issues-to-address","title":"Issues to Address","text":""},{"location":"flutter/planning/navigation-review-fixes/#1-feature-envy-in-thread-selection-persistence","title":"1. Feature Envy in Thread Selection Persistence","text":"<p>Severity: Major Effort: Small (1-2 hours) Files: <code>room_screen.dart</code>, <code>chat_panel.dart</code>, <code>threads_provider.dart</code></p> <p>Problem: Both RoomScreen and ChatPanel know the full thread selection workflow (state update + persistence + URL update). ChatPanel awaits persistence while RoomScreen fires-and-forgets\u2014an inconsistency that could cause subtle bugs.</p> <p>Fix: Create <code>selectThreadWithNavigation()</code> in <code>threads_provider.dart</code>:</p> <pre><code>void selectThreadWithNavigation({\n  required WidgetRef ref,\n  required String roomId,\n  required String threadId,\n  required void Function(String path) navigate,\n}) {\n  selectAndPersistThread(ref: ref, roomId: roomId, threadId: threadId);\n  navigate('/rooms/$roomId?thread=$threadId');\n}\n</code></pre> <p>Update call sites to use this helper. ChatPanel's thread creation still needs special handling (it creates the thread first), but the selection workflow after creation can use the shared function.</p>"},{"location":"flutter/planning/navigation-review-fixes/#2-initializingselection-couples-historypanel-to-roomscreen","title":"2. InitializingSelection Couples HistoryPanel to RoomScreen","text":"<p>Severity: Major Effort: Medium (2-3 hours) Files: <code>history_panel.dart</code>, <code>threads_provider.dart</code>, <code>room_screen.dart</code></p> <p>Problem: <code>InitializingSelection</code> exists solely to prevent HistoryPanel from auto-selecting while RoomScreen initializes. HistoryPanel knows about RoomScreen's internal lifecycle.</p> <p>Fix Options:</p> <p>Option A (Recommended): Remove auto-selection from HistoryPanel entirely.</p> <ul> <li>Delete the <code>NoThreadSelected</code> auto-selection logic in HistoryPanel</li> <li>Let RoomScreen be the single owner of initialization</li> <li>HistoryPanel only displays threads and handles user taps</li> <li>Remove <code>InitializingSelection</code> variant</li> </ul> <p>Option B: Keep behavior but document the contract.</p> <ul> <li>Add doc comment to <code>InitializingSelection</code> explaining the protocol</li> <li>Less clean but lower effort</li> </ul> <p>Going with Option A aligns with Single Responsibility and removes the coupling.</p>"},{"location":"flutter/planning/navigation-review-fixes/#3-_initialized-flag-state-management","title":"3. <code>_initialized</code> Flag State Management","text":"<p>Severity: Minor Effort: Small (30 min - 1 hour) Files: <code>room_screen.dart</code></p> <p>Problem: The <code>_initialized</code> boolean flag + <code>didUpdateWidget</code> + post-frame callback is fragile. There's a window where <code>_initialized</code> is false but re-initialization hasn't run yet.</p> <p>Fix: Track <code>_initializedForRoomId</code> instead of just <code>_initialized</code>:</p> <pre><code>String? _initializedForRoomId;\n\nFuture&lt;void&gt; _initializeThreadSelection() async {\n  if (_initializedForRoomId == widget.roomId) return;\n  _initializedForRoomId = widget.roomId;\n  // ... rest of initialization\n}\n</code></pre> <p>This guards against double-init for the same room and makes the intent clearer.</p>"},{"location":"flutter/planning/navigation-review-fixes/#4-result-type-scope","title":"4. Result Type Scope","text":"<p>Severity: Minor Effort: Trivial (15 min) Files: <code>result.dart</code>, <code>chat_panel.dart</code></p> <p>Problem: <code>Result&lt;T&gt;</code> is only used in <code>ChatPanel._withErrorHandling</code>. Either expand usage or make it local.</p> <p>Fix: Move <code>Result</code>, <code>Ok</code>, and <code>Err</code> into <code>chat_panel.dart</code> as private classes since it's only used there. If we need it elsewhere later, we can extract it back.</p> <p>Alternatively, keep it in <code>result.dart</code> but add a <code>// TODO: expand usage or remove</code> comment.</p>"},{"location":"flutter/planning/navigation-review-fixes/#5-missing-async-cancellation-in-roomscreen","title":"5. Missing Async Cancellation in RoomScreen","text":"<p>Severity: Minor Effort: Small (30 min) Files: <code>room_screen.dart</code></p> <p>Problem: <code>_initializeThreadSelection()</code> could complete after widget unmount, calling <code>ref.read()</code> on a disposed widget.</p> <p>Fix: Add mounted check after each async gap:</p> <pre><code>Future&lt;void&gt; _initializeThreadSelection() async {\n  if (_initializedForRoomId == widget.roomId) return;\n  _initializedForRoomId = widget.roomId;\n\n  final threads = await ref.read(threadsProvider(widget.roomId).future);\n  if (!mounted) return;  // &lt;-- Add this\n\n  // ... rest of method, add mounted checks after other awaits\n}\n</code></pre>"},{"location":"flutter/planning/navigation-review-fixes/#6-desktop-breakpoint-constant-duplication","title":"6. Desktop Breakpoint Constant Duplication","text":"<p>Severity: Minor Effort: Trivial (15 min) Files: <code>room_screen.dart</code>, potentially a new constants file</p> <p>Problem: 600px breakpoint is defined locally in RoomScreen and implicitly used in tests.</p> <p>Fix: Export the constant or create <code>lib/core/constants/breakpoints.dart</code>:</p> <pre><code>const double kDesktopBreakpoint = 600;\n</code></pre> <p>Low priority\u2014only matters if more screens need responsive layouts.</p>"},{"location":"flutter/planning/navigation-review-fixes/#effort-summary","title":"Effort Summary","text":"Issue Effort Priority Feature Envy in thread selection Small (1-2h) High InitializingSelection coupling Medium (2-3h) High <code>_initialized</code> flag management Small (30min-1h) Medium Result type scope Trivial (15min) Low Missing async cancellation Small (30min) Medium Breakpoint duplication Trivial (15min) Low <p>Total estimated effort: 5-7 hours</p>"},{"location":"flutter/planning/navigation-review-fixes/#recommended-order","title":"Recommended Order","text":"<ol> <li>InitializingSelection coupling - Largest impact on design cleanliness</li> <li>Feature Envy - Consolidates scattered logic</li> <li>Async cancellation - Prevents potential runtime errors</li> <li><code>_initialized</code> flag - Improves robustness</li> <li>Result type scope - Cleanup</li> <li>Breakpoint constant - Cleanup if time permits</li> </ol>"},{"location":"flutter/planning/no-auth-mode/","title":"No-Auth Mode Support","text":""},{"location":"flutter/planning/no-auth-mode/#problem","title":"Problem","text":"<p>When backend runs with <code>--no-auth-mode</code>, the Flutter app got stuck on login screen showing \"No identity providers configured\" with no way to proceed.</p>"},{"location":"flutter/planning/no-auth-mode/#solution","title":"Solution","text":"<p>Added <code>NoAuthRequired</code> as a new <code>AuthState</code> variant. Router treats it like <code>Authenticated</code> for access control, but no token is sent to the backend.</p>"},{"location":"flutter/planning/no-auth-mode/#key-changes","title":"Key Changes","text":"<ul> <li><code>AuthState</code> - Added <code>NoAuthRequired</code> sealed class variant</li> <li><code>AuthNotifier</code> - Added <code>enterNoAuthMode()</code> and <code>exitNoAuthMode()</code> methods</li> <li><code>hasAppAccessProvider</code> - Renamed from <code>isAuthenticatedProvider</code>; returns true   for both <code>Authenticated</code> and <code>NoAuthRequired</code></li> <li><code>HomeScreen._connect()</code> - Detects empty providers list and calls   <code>enterNoAuthMode()</code>; handles backend switching with URL normalization</li> </ul>"},{"location":"flutter/planning/no-auth-mode/#design-decisions","title":"Design Decisions","text":"<ol> <li>Explicit state over nullable auth - <code>NoAuthRequired</code> is clearer than    null/empty checks scattered throughout the codebase</li> <li>No persistence - Re-detect on each connect to handle backend config    changes</li> <li>Guard on exitNoAuthMode() - Throws <code>StateError</code> if called from    <code>Authenticated</code> to prevent accidentally skipping token cleanup</li> <li>URL normalization - Trailing slash differences don't trigger unnecessary    auth state resets</li> </ol>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/","title":"Making SOLIPLEX Flutter Frontend Reusable","text":"<p>This document outlines three levels of increasingly sophisticated integration for making the Flutter frontend reusable as a white-label/templatable solution.</p>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#overview","title":"Overview","text":"<p>The goal is to allow consumers to:</p> <ul> <li>Wire in custom panels</li> <li>Add custom slash commands</li> <li>Register custom widgets</li> <li>Configure deep linking</li> <li>Apply their own branding</li> </ul>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#level-1-configuration-driven-customization","title":"Level 1: Configuration-Driven Customization","text":"<p>Effort: Low | Flexibility: Limited</p> <p>A consumer provides a configuration object at app startup - no code changes required.</p>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#what-they-can-customize","title":"What They Can Customize","text":"<ul> <li>Branding: App name, colors, logo, theme</li> <li>Feature flags: Enable/disable panels (canvas, context pane, inspector)</li> <li>Default routes: Initial screen, available navigation items</li> <li>Pre-registered servers: Default server URLs, OIDC providers</li> </ul>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#implementation-pattern","title":"Implementation Pattern","text":"<pre><code>// Consumer's main.dart\nvoid main() {\n  runSoliplexApp(\n    SoliplexConfig(\n      appName: 'MyChat',\n      theme: MyTheme.data,\n      features: Features(\n        enableCanvas: true,\n        enableContextPane: false,\n        enableInspector: false,\n      ),\n      routes: RouteConfig(\n        initialRoute: '/chat',\n        hideSettings: true,\n      ),\n      defaultServers: [\n        ServerConfig(url: 'https://api.mycompany.com', name: 'Production'),\n      ],\n    ),\n  );\n}\n</code></pre>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#changes-required","title":"Changes Required","text":"Area Change <code>main.dart</code> Accept <code>SoliplexConfig</code> parameter <code>app_shell.dart</code> Read config from provider, apply theme <code>app_router.dart</code> Filter routes based on <code>RouteConfig</code> Layouts Conditionally render panels based on <code>Features</code>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#limitations","title":"Limitations","text":"<ul> <li>No custom panels or widgets</li> <li>No custom slash commands</li> <li>Fixed UI structure</li> </ul>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#level-2-registry-based-extension","title":"Level 2: Registry-Based Extension","text":"<p>Effort: Medium | Flexibility: Moderate</p> <p>Consumer registers custom components via typed registries at startup.</p>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#what-they-can-customize_1","title":"What They Can Customize","text":"<p>Everything from Level 1, plus:</p> <ul> <li>Custom GenUI widgets: Register new widget builders</li> <li>Custom slash commands: Add command handlers</li> <li>Custom panels: Register panel providers with layouts</li> <li>Custom keyboard shortcuts: Add app-wide shortcuts</li> <li>Deep link handlers: Custom route handlers</li> </ul>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#implementation-pattern_1","title":"Implementation Pattern","text":"<pre><code>void main() {\n  final registry = SoliplexRegistry()\n    // Custom widgets\n    ..registerWidget('CompanyCard', CompanyCardWidget.fromData)\n    ..registerWidget('OrgChart', OrgChartWidget.fromData)\n\n    // Custom slash commands\n    ..registerCommand(SlashCommand(\n      name: 'ticket',\n      description: 'Create support ticket',\n      handler: (args, session) =&gt; _handleTicket(args, session),\n    ))\n\n    // Custom panel\n    ..registerPanel(PanelDefinition(\n      id: 'tickets',\n      name: 'Support Tickets',\n      icon: Icons.confirmation_number,\n      builder: (context, ref) =&gt; TicketPanel(),\n      providerFactory: (key) =&gt; ticketPanelProvider(key),\n    ))\n\n    // Custom routes\n    ..registerRoute(RouteDefinition(\n      path: '/tickets/:id',\n      builder: (context, state) =&gt; TicketDetailScreen(\n        id: state.pathParameters['id']!,\n      ),\n    ));\n\n  runSoliplexApp(\n    config: SoliplexConfig(...),\n    registry: registry,\n  );\n}\n</code></pre>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#new-abstractions-required","title":"New Abstractions Required","text":"<pre><code>// lib/core/extension/slash_command.dart\nclass SlashCommand {\n  final String name;\n  final String description;\n  final bool Function(List&lt;String&gt; args, RoomSession session) handler;\n}\n\n// lib/core/extension/panel_definition.dart\nclass PanelDefinition {\n  final String id;\n  final String name;\n  final IconData icon;\n  final Widget Function(BuildContext, WidgetRef) builder;\n  final ProviderBase Function(ServerRoomKey) providerFactory;\n  final PanelPosition defaultPosition; // left, right, bottom\n}\n\n// lib/core/extension/route_definition.dart\nclass RouteDefinition {\n  final String path;\n  final Widget Function(BuildContext, GoRouterState) builder;\n  final List&lt;RouteDefinition&gt; children;\n}\n</code></pre>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#changes-required_1","title":"Changes Required","text":"Area Change <code>widget_registry.dart</code> Already extensible, expose via registry <code>slash_command_service.dart</code> Switch from hardcoded switch to registered handlers <code>panel_providers.dart</code> Dynamic provider registration <code>app_router.dart</code> Merge registered routes with core routes Layouts Query registry for available panels Navigation drawer Render registered panels dynamically"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#level-3-full-plugin-architecture","title":"Level 3: Full Plugin Architecture","text":"<p>Effort: High | Flexibility: Maximum</p> <p>Consumers build self-contained plugins that integrate via lifecycle hooks and can modify core behavior.</p>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#what-they-can-customize_2","title":"What They Can Customize","text":"<p>Everything from Levels 1 &amp; 2, plus:</p> <ul> <li>Message interceptors: Transform/filter messages before display</li> <li>Event hooks: React to app lifecycle events</li> <li>Protocol extensions: Custom message types, tool handlers</li> <li>State middleware: Intercept and transform state changes</li> <li>Custom layouts: Entirely new screen arrangements</li> <li>Theme extensions: Beyond colors - custom widget variants</li> </ul>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#implementation-pattern_2","title":"Implementation Pattern","text":"<pre><code>// my_company_plugin/lib/plugin.dart\nclass MyCompanyPlugin extends SoliplexPlugin {\n  @override\n  String get id =&gt; 'com.mycompany.chat';\n\n  @override\n  List&lt;SoliplexPlugin&gt; get dependencies =&gt; [AnalyticsPlugin()];\n\n  @override\n  void register(PluginContext context) {\n    // Register all extensions\n    context.widgets.register('CompanyCard', CompanyCard.fromData);\n    context.commands.register(TicketCommand());\n    context.panels.register(TicketPanelPlugin());\n    context.routes.register('/tickets', TicketRoutes());\n  }\n\n  @override\n  void onAppStart(AppLifecycleContext context) {\n    // Initialize plugin state\n    _analyticsService = context.ref.read(analyticsProvider);\n  }\n\n  @override\n  void onServerConnect(ServerContext context) {\n    // Hook into server connection\n    _trackServerConnection(context.serverUrl);\n  }\n\n  @override\n  MessageInterceptor? get messageInterceptor =&gt; _MessageEnricher();\n\n  @override\n  List&lt;ProviderOverride&gt; get providerOverrides =&gt; [\n    // Override core providers if needed\n    feedbackServiceProvider.overrideWith((ref) =&gt; MyFeedbackService()),\n  ];\n}\n\n// Message interceptor example\nclass _MessageEnricher implements MessageInterceptor {\n  @override\n  UnifiedMessage? intercept(UnifiedMessage message, InterceptContext ctx) {\n    // Add company-specific metadata\n    if (message.isFromAgent) {\n      return message.copyWith(\n        metadata: {...message.metadata, 'processed': true},\n      );\n    }\n    return message;\n  }\n}\n</code></pre>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#plugin-lifecycle","title":"Plugin Lifecycle","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    App Startup                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  1. Load plugin manifests                               \u2502\n\u2502  2. Resolve dependencies (topological sort)             \u2502\n\u2502  3. Call plugin.register() for each                     \u2502\n\u2502  4. Build merged router, registries                     \u2502\n\u2502  5. Call plugin.onAppStart()                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                   Runtime Events                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  \u2022 onServerConnect(ctx)    - Server selected            \u2502\n\u2502  \u2022 onRoomJoin(ctx)         - Room entered               \u2502\n\u2502  \u2022 onMessageReceive(msg)   - Before message displayed   \u2502\n\u2502  \u2022 onMessageSend(msg)      - Before message sent        \u2502\n\u2502  \u2022 onToolCall(call)        - Tool execution started     \u2502\n\u2502  \u2022 onError(error, stack)   - Error occurred             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                     Shutdown                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  \u2022 onAppStop()             - Cleanup opportunity        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#new-core-abstractions","title":"New Core Abstractions","text":"<pre><code>// lib/core/plugin/soliplex_plugin.dart\nabstract class SoliplexPlugin {\n  String get id;\n  String get version =&gt; '1.0.0';\n  List&lt;SoliplexPlugin&gt; get dependencies =&gt; [];\n\n  void register(PluginContext context);\n\n  // Lifecycle hooks (all optional)\n  void onAppStart(AppLifecycleContext context) {}\n  void onAppStop() {}\n  void onServerConnect(ServerContext context) {}\n  void onServerDisconnect(ServerContext context) {}\n  void onRoomJoin(RoomContext context) {}\n  void onRoomLeave(RoomContext context) {}\n  void onError(Object error, StackTrace stack) {}\n\n  // Interceptors (optional)\n  MessageInterceptor? get messageInterceptor =&gt; null;\n  ToolCallInterceptor? get toolCallInterceptor =&gt; null;\n\n  // Provider overrides (optional)\n  List&lt;ProviderOverride&gt; get providerOverrides =&gt; [];\n}\n\n// lib/core/plugin/plugin_context.dart\nclass PluginContext {\n  final WidgetRegistry widgets;\n  final CommandRegistry commands;\n  final PanelRegistry panels;\n  final RouteRegistry routes;\n  final ShortcutRegistry shortcuts;\n  final LayoutRegistry layouts;\n  final ThemeExtensions themes;\n}\n</code></pre>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#package-structure-for-consumers","title":"Package Structure for Consumers","text":"<pre><code>my_app/\n\u251c\u2500\u2500 lib/\n\u2502   \u251c\u2500\u2500 main.dart              # App entry point\n\u2502   \u251c\u2500\u2500 config.dart            # SoliplexConfig\n\u2502   \u2514\u2500\u2500 plugins/\n\u2502       \u251c\u2500\u2500 branding/          # Theme, logos\n\u2502       \u251c\u2500\u2500 analytics/         # Event tracking\n\u2502       \u2514\u2500\u2500 domain/            # Business-specific features\n\u251c\u2500\u2500 pubspec.yaml\n\u2502   dependencies:\n\u2502     soliplex_core: ^1.0.0    # Core framework (this repo)\n\u2502     soliplex_widgets: ^1.0.0 # Optional widget pack\n</code></pre>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#comparison-summary","title":"Comparison Summary","text":"Capability Level 1 Level 2 Level 3 Custom branding/theme Yes Yes Yes Feature toggles Yes Yes Yes Custom widgets No Yes Yes Custom slash commands No Yes Yes Custom panels No Yes Yes Custom routes No Yes Yes Message interceptors No No Yes Lifecycle hooks No No Yes Provider overrides No No Yes Plugin dependencies No No Yes Custom layouts No Limited Yes Implementation effort Low Medium High"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#current-architecture-reference","title":"Current Architecture Reference","text":"<p>The following existing patterns inform this design:</p>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#panel-system","title":"Panel System","text":"<ul> <li>Location: <code>lib/core/providers/panel_providers.dart</code></li> <li>Pattern: Server-scoped notifiers with <code>.family</code> providers keyed by <code>ServerRoomKey</code></li> <li>Existing panels: Canvas, Context Pane, Activity Status, Tool Execution, Message Stream</li> </ul>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#widget-registry","title":"Widget Registry","text":"<ul> <li>Location: <code>lib/core/services/widget_registry.dart</code></li> <li>Pattern: Name-to-builder mapping, already extensible via <code>register()</code> method</li> <li>Existing widgets: InfoCard, MetricDisplay, DataList, SearchWidget, etc.</li> </ul>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#slash-commands","title":"Slash Commands","text":"<ul> <li>Location: <code>lib/features/chat/services/slash_command_service.dart</code></li> <li>Pattern: Currently hardcoded switch statement - needs refactoring for Level 2+</li> <li>Existing commands: /search, /list, /demo, /canvas, /help</li> </ul>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#routing","title":"Routing","text":"<ul> <li>Location: <code>lib/core/router/app_router.dart</code></li> <li>Pattern: GoRouter with shell route, auth guard redirect</li> <li>Existing routes: /setup, /auth/callback, /chat, /chat/:roomId, /settings, /inspector</li> </ul>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#configuration","title":"Configuration","text":"<ul> <li>Location: <code>lib/main.dart</code>, <code>lib/app_shell.dart</code></li> <li>Pattern: Runtime-driven via providers, no external config files currently</li> </ul>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#recommended-approach","title":"Recommended Approach","text":"<p>Start with Level 2 as the target architecture:</p> <ol> <li>It provides meaningful extensibility without over-engineering</li> <li>The registry pattern aligns with existing <code>WidgetRegistry</code> design</li> <li>Plugin lifecycle (Level 3) can be added later if demand exists</li> <li>Level 1 falls out naturally as a subset of Level 2</li> </ol>"},{"location":"flutter/planning/architecture/BRANDING-APPROACH/#implementation-order","title":"Implementation Order","text":"<ol> <li>Define <code>SoliplexConfig</code> and <code>SoliplexRegistry</code> interfaces</li> <li>Refactor <code>SlashCommandService</code> to use registered handlers</li> <li>Create <code>PanelRegistry</code> abstraction</li> <li>Extend <code>app_router.dart</code> to accept route definitions</li> <li>Update layouts to query registries dynamically</li> <li>Extract core into <code>soliplex_core</code> package</li> </ol>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/","title":"Soliplex Frontend Codebase Analysis","text":"<p>Generated: 2025-12-17 Branch: new_frontend Current Milestone: AM3 (Working Chat) \u2705</p>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#1-project-structure","title":"1. Project Structure","text":"<pre><code>frontend/\n\u251c\u2500\u2500 lib/                              # Main Flutter app (29 Dart files)\n\u2502   \u251c\u2500\u2500 main.dart                     # Entry point with ProviderScope\n\u2502   \u251c\u2500\u2500 app.dart                      # Root SoliplexApp widget\n\u2502   \u251c\u2500\u2500 core/                         # Infrastructure layer\n\u2502   \u2502   \u251c\u2500\u2500 models/                   # Core data models\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 active_run_state.dart # AG-UI streaming state\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 app_config.dart       # App configuration (baseUrl, version)\n\u2502   \u2502   \u251c\u2500\u2500 providers/                # Riverpod state management (7 providers)\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 api_provider.dart     # SoliplexApi singleton\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 active_run_provider.dart\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 active_run_notifier.dart\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 config_provider.dart\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 rooms_provider.dart\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 threads_provider.dart\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 backend_health_provider.dart\n\u2502   \u2502   \u2514\u2500\u2500 router/\n\u2502   \u2502       \u2514\u2500\u2500 app_router.dart       # GoRouter (5 routes)\n\u2502   \u251c\u2500\u2500 features/                     # Feature screens\n\u2502   \u2502   \u251c\u2500\u2500 home/                     # Welcome screen\n\u2502   \u2502   \u251c\u2500\u2500 rooms/                    # Room list\n\u2502   \u2502   \u251c\u2500\u2500 room/                     # Threads in room\n\u2502   \u2502   \u251c\u2500\u2500 thread/                   # Main chat (dual panel desktop)\n\u2502   \u2502   \u251c\u2500\u2500 chat/                     # Chat messaging\n\u2502   \u2502   \u251c\u2500\u2500 history/                  # Thread list sidebar\n\u2502   \u2502   \u251c\u2500\u2500 login/                    # Placeholder (AM7)\n\u2502   \u2502   \u2514\u2500\u2500 settings/                 # Settings screen\n\u2502   \u2514\u2500\u2500 shared/                       # Reusable components\n\u2502       \u251c\u2500\u2500 widgets/\n\u2502       \u2514\u2500\u2500 utils/\n\u2502\n\u251c\u2500\u2500 packages/soliplex_client/         # Pure Dart package (NO Flutter)\n\u2502   \u251c\u2500\u2500 lib/src/\n\u2502   \u2502   \u251c\u2500\u2500 models/                   # Data models\n\u2502   \u2502   \u251c\u2500\u2500 errors/                   # Exception hierarchy\n\u2502   \u2502   \u251c\u2500\u2500 api/                      # REST API client\n\u2502   \u2502   \u251c\u2500\u2500 http/                     # HTTP abstraction layer\n\u2502   \u2502   \u251c\u2500\u2500 agui/                     # AG-UI protocol\n\u2502   \u2502   \u2514\u2500\u2500 utils/                    # Utilities\n\u2502   \u2514\u2500\u2500 test/                         # 587 tests, 100% coverage\n\u2502\n\u251c\u2500\u2500 packages/soliplex_client_native/  # Flutter package - Native HTTP\n\u2502   \u2514\u2500\u2500 lib/src/adapters/\n\u2502       \u2514\u2500\u2500 cupertino_http_client.dart   # NSURLSession for iOS/macOS\n\u2502\n\u251c\u2500\u2500 test/                             # Integration and widget tests\n\u251c\u2500\u2500 android/, ios/, macos/, web/      # Platform-specific code\n\u2514\u2500\u2500 pubspec.yaml\n</code></pre>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#2-architecture","title":"2. Architecture","text":""},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#21-three-layer-design","title":"2.1 Three-Layer Design","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              UI Components                   \u2502\n\u2502  (Chat, History, Detail, Canvas)            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              Core Frontend                   \u2502\n\u2502  Providers \u2502 Navigation \u2502 AG-UI Processing  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                   \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502      soliplex_client (Pure Dart package)    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#22-state-management-riverpod","title":"2.2 State Management: Riverpod","text":"<p>Provider Hierarchy:</p> <pre><code>configProvider (StateProvider)\n    \u2502\n    \u251c\u2500\u2500 urlBuilderProvider\n    \u2514\u2500\u2500 httpTransportProvider\n            \u2502\n        apiProvider\n            \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502                \u2502\nroomsProvider  threadsProvider(roomId)\n    \u2502                \u2502\n    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\ncurrentRoomIdProvider / currentThreadIdProvider\n         \u2502\nactiveRunNotifierProvider \u2190 Main streaming orchestration\n         \u2502\nDerived: canSendMessageProvider, allMessagesProvider, isStreamingProvider\n</code></pre>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#23-http-layer-architecture","title":"2.3 HTTP Layer Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         SoliplexApi (REST client)              \u2502  Layer 3: Business Logic\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502      HttpTransport (JSON + Error Mapping)      \u2502  Layer 2: Transport\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   SoliplexHttpClient (Platform abstractions)   \u2502  Layer 1: Clients\n\u2502  - DartHttpClient (dart:http)                  \u2502\n\u2502  - CupertinoHttpClient (NSURLSession)          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#24-navigation-gorouter","title":"2.4 Navigation: GoRouter","text":"Route Screen Description <code>/</code> HomeScreen Welcome page <code>/rooms</code> RoomsScreen List all rooms <code>/rooms/:roomId</code> RoomScreen Threads in room <code>/rooms/:roomId/thread/:threadId</code> ThreadScreen Chat interface <code>/settings</code> SettingsScreen Backend config <p>Responsive Layout:</p> <ul> <li>Desktop (\u2265600px): Sidebar history panel + chat panel side-by-side</li> <li>Mobile (&lt;600px): Chat panel only</li> </ul>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#3-key-components","title":"3. Key Components","text":""},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#31-data-models","title":"3.1 Data Models","text":"<p>ChatMessage:</p> <pre><code>- id: String\n- user: ChatUser (user | assistant | system)\n- type: MessageType (text | error | toolCall | genUi | loading)\n- text: String?\n- isStreaming: bool\n- thinkingText: String?\n- toolCalls: List&lt;ToolCallInfo&gt;?\n- errorMessage: String?\n- createdAt: DateTime\n</code></pre> <p>ActiveRunState:</p> <pre><code>- status: ThreadRunStatus (idle | running | finished | error)\n- messages: List&lt;ChatMessage&gt;\n- threadId: String?\n- runId: String?\n- streamingText: String?\n- isTextStreaming: bool\n- activeToolCalls: List&lt;ToolCallInfo&gt;\n- state: Map&lt;String, dynamic&gt;\n- rawEvents: List&lt;AgUiEvent&gt;\n</code></pre>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#32-ag-ui-protocol","title":"3.2 AG-UI Protocol","text":"<p>Event Types (sealed class hierarchy):</p> <ul> <li>Run lifecycle: <code>RunStartedEvent</code>, <code>RunFinishedEvent</code>, <code>RunErrorEvent</code></li> <li>Message streaming: <code>TextMessageStartEvent</code>, <code>TextMessageContentEvent</code>, <code>TextMessageEndEvent</code></li> <li>Tool calls: <code>ToolCallStartEvent</code>, <code>ToolCallArgsEvent</code>, <code>ToolCallEndEvent</code>, <code>ToolCallResultEvent</code></li> <li>State: <code>StateSnapshotEvent</code>, <code>StateDeltaEvent</code></li> <li>Activity: <code>ActivitySnapshotEvent</code>, <code>ActivityDeltaEvent</code></li> <li>Messages: <code>MessagesSnapshotEvent</code></li> <li>Custom: <code>CustomEvent</code>, <code>UnknownEvent</code></li> </ul> <p>Streaming Pipeline:</p> <pre><code>SSE Stream \u2192 Thread.run() \u2192 Event parsing \u2192 Buffers \u2192 ActiveRunNotifier \u2192 UI\n</code></pre>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#33-chat-flow","title":"3.3 Chat Flow","text":"<pre><code>User types message\n    \u2193\nChatInput.onSend(text)\n    \u2193\nChatPanel._handleSend()\n    \u251c\u2500 Create thread if needed (api.createThread)\n    \u2514\u2500 activeRunNotifier.startRun(roomId, threadId, userMessage)\n         \u251c\u2500 Creates Thread\n         \u251c\u2500 Subscribes to eventStream\n         \u2514\u2500 Updates ActiveRunState\n    \u2193\nMessageList watches allMessagesProvider\n    \u251c\u2500 Merges history + run messages\n    \u2514\u2500 Auto-scrolls to bottom\n</code></pre>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#4-soliplex_client-package","title":"4. soliplex_client Package","text":"<p>Pure Dart - no Flutter dependency. Reusable on web, server, or desktop.</p> Milestone Description Status DM1 Models &amp; errors \u2705 DM2 HTTP adapter interface + DartHttpAdapter \u2705 DM3 HttpObserver + ObservableHttpAdapter \u2705 DM4 HttpTransport, UrlBuilder, CancelToken \u2705 DM5 API layer (SoliplexApi) \u2705 DM6 AG-UI protocol (Thread, buffers, tool registry) \u2705 DM7 Sessions (ConnectionManager, RoomSession) Not Started DM8 Facade (SoliplexClient) Not Started <p>Test Coverage: 587 tests, 100% coverage</p>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#5-ui-components","title":"5. UI Components","text":""},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#screens","title":"Screens","text":"Screen Purpose HomeScreen Welcome with navigation RoomsScreen List rooms from API RoomScreen List threads, create new ThreadScreen Main chat interface SettingsScreen Backend configuration"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#panels","title":"Panels","text":"Panel Purpose ChatPanel Message list + input, send/cancel/error handling HistoryPanel Thread list, new conversation, auto-selection"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#shared-widgets","title":"Shared Widgets","text":"<ul> <li><code>AsyncValueHandler</code>: Wraps AsyncValue with error handling</li> <li><code>ErrorDisplay</code>: Exception-aware error UI with retry</li> <li><code>LoadingIndicator</code>: Spinner with optional message</li> <li><code>EmptyState</code>: Icon + message for empty lists</li> </ul>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#6-testing","title":"6. Testing","text":"<p>Test Coverage:</p> <ul> <li>Frontend: 129 tests total</li> <li>soliplex_client: 587 tests, 100% coverage</li> <li>Zero analyzer issues</li> </ul> <p>Test Structure:</p> <pre><code>test/\n\u251c\u2500\u2500 core/providers/        # Provider tests\n\u251c\u2500\u2500 features/              # Screen and widget tests\n\u251c\u2500\u2500 shared/                # Shared widget tests\n\u2514\u2500\u2500 helpers/               # Mocks and utilities\n</code></pre> <p>Key Utilities:</p> <ul> <li><code>MockSoliplexApi</code>: Mock API for testing</li> <li><code>MockActiveRunNotifier</code>: Mock notifier with initial state</li> <li><code>createTestApp()</code>: Helper to create testable app</li> </ul>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#7-code-quality","title":"7. Code Quality","text":"<p>Analyzer: Zero tolerance - no errors, warnings, or hints</p> <p>Linting:</p> <ul> <li><code>very_good_analysis</code> (strict rules)</li> <li><code>dart format lib test</code> before commits</li> <li><code>markdownlint-cli</code> for markdown</li> </ul> <p>Conventions:</p> <ul> <li>PascalCase: Classes, enums, types</li> <li>camelCase: Variables, functions</li> <li><code>_privateMethod</code>: Private members prefixed</li> </ul>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#8-notable-patterns","title":"8. Notable Patterns","text":""},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#sealed-classes-for-events","title":"Sealed Classes for Events","text":"<pre><code>sealed class AgUiEvent { ... }\nfinal class RunStartedEvent extends AgUiEvent { ... }\n// Enables exhaustive pattern matching\n</code></pre>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#builder-pattern-for-models","title":"Builder Pattern for Models","text":"<pre><code>ChatMessage.text(...)\nChatMessage.error(...)\nChatMessage.toolCall(...)\n</code></pre>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#observer-pattern-for-http","title":"Observer Pattern for HTTP","text":"<p><code>ObservableHttpAdapter</code> wraps adapters for request inspection/logging.</p>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#cancel-token","title":"Cancel Token","text":"<p>Graceful SSE stream cancellation via <code>Completer</code> pattern.</p>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#responsive-breakpoint","title":"Responsive Breakpoint","text":"<p>600px mobile/desktop boundary in ThreadScreen.</p>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#9-dependencies","title":"9. Dependencies","text":"<p>Frontend App:</p> <pre><code>flutter_riverpod: ^2.6.1    # State management\ngo_router: ^14.7.1          # Navigation\nhttp: ^1.2.0                # Health checks\nintl: ^0.20.1               # Localization\nmeta: ^1.15.0               # Annotations\nsoliplex_client: path       # Pure Dart client\nsoliplex_client_native: path # Native adapters\n</code></pre> <p>soliplex_client:</p> <pre><code>http: ^1.2.0\nmeta: ^1.9.0\n</code></pre> <p>soliplex_client_native:</p> <pre><code>cupertino_http: ^2.0.0      # NSURLSession\nflutter: &gt;= 3.10.0\nhttp: ^1.2.0\n</code></pre>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#10-milestone-progress","title":"10. Milestone Progress","text":"Milestone Description Status AM1 App shell, navigation \u2705 AM2 Real API integration \u2705 AM3 Working chat with streaming \u2705 AM4 Message history and persistence Pending AM5 Detail panel (events, thinking, tools) Pending AM6 Canvas components Pending AM7 Authentication UI Pending AM8 Multi-room package extraction Pending"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#11-key-architectural-decisions","title":"11. Key Architectural Decisions","text":"<ol> <li>Pure Dart client package - Reusable across platforms without Flutter dependency</li> <li>Sealed classes for events - Type-safe exhaustive pattern matching</li> <li>3-layer HTTP abstraction - Testable adapters, transport, and API layers</li> <li>Platform-optimized adapters - NSURLSession on iOS/macOS for better performance</li> <li>Manual Riverpod providers - Explicit control over provider lifecycle</li> <li>Responsive dual-panel layout - Desktop sidebar with mobile fallback</li> </ol>"},{"location":"flutter/planning/architecture/CODEBASE_ANALYSIS/#12-summary","title":"12. Summary","text":"<p>This is a well-architected, production-quality Flutter frontend featuring:</p> <ul> <li>\u2705 Clean 3-layer HTTP abstraction with platform adapters</li> <li>\u2705 Pure Dart client package reusable across platforms</li> <li>\u2705 Sophisticated AG-UI event streaming protocol</li> <li>\u2705 Responsive dual-panel desktop + mobile chat</li> <li>\u2705 Comprehensive error handling with exception hierarchy</li> <li>\u2705 Strict code quality (zero analyzer issues, 100% test coverage on client)</li> <li>\u2705 Riverpod state management with clear provider hierarchy</li> <li>\u2705 Sealed classes for type-safe event handling</li> <li>\u2705 Platform-optimized native HTTP adapters</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/","title":"SOLIPLEX Flutter Application - Architecture Documentation","text":"<p>Version: 1.0.0 Last Updated: 2025-12-15 Audience: Internal developers maintaining and extending this codebase</p>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#table-of-contents","title":"Table of Contents","text":"<ol> <li>Overview</li> <li>System Architecture</li> <li>Network Infrastructure (Deep Dive)</li> <li>State Management</li> <li>AG-UI Protocol Integration</li> <li>Widget System</li> <li>Cross-Platform Considerations</li> <li>Security Architecture</li> <li>Key Files Reference</li> <li>Extension Guide</li> </ol>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#overview","title":"Overview","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#what-is-soliplex","title":"What is SOLIPLEX?","text":"<p>SOLIPLEX is a cross-platform Flutter application that provides an AI-powered chat interface with Agentic Generative UI capabilities. It connects to backend servers running the AFSOC-RAG system to enable RAG (Retrieval-Augmented Generation) conversations with native UI widget rendering.</p> <p>Platform Support: Web, iOS, macOS, Linux, Windows</p> <p>Key Capabilities:</p> <ul> <li>Multi-server connections with concurrent session management</li> <li>Real-time SSE (Server-Sent Events) streaming from AI agents</li> <li>Native widget rendering via GenUI protocol</li> <li>Canvas-based visual workspace for widget composition</li> <li>OIDC authentication with PKCE</li> <li>Offline session persistence and recovery</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#architecture-philosophy","title":"Architecture Philosophy","text":"<p>The application follows a clean layered architecture with emphasis on:</p> <ul> <li>Separation of concerns: Clear boundaries between UI, business logic, and infrastructure</li> <li>Testability: Pure functions for event processing, dependency injection via Riverpod</li> <li>Observability: Network inspector for traffic capture and debugging</li> <li>Resilience: Retry logic, cancellation tokens, graceful error handling</li> <li>Cross-platform: Conditional imports for platform-specific features</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#system-architecture","title":"System Architecture","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#high-level-architecture-diagram","title":"High-Level Architecture Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        PRESENTATION LAYER                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u2502\n\u2502  \u2502 Chat Screen  \u2502  \u2502 Canvas View  \u2502  \u2502 Context Pane \u2502          \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502                  \u2502                  \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         \u2502      STATE MANAGEMENT LAYER (Riverpod)                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u2502\n\u2502  \u2502  Panel Providers (Server-scoped, per-room families)  \u2502       \u2502\n\u2502  \u2502  - activeCanvasProvider                               \u2502       \u2502\n\u2502  \u2502  - activeContextPaneProvider                          \u2502       \u2502\n\u2502  \u2502  - roomMessageStreamProvider                          \u2502       \u2502\n\u2502  \u2502  - roomActivityStatusProvider                         \u2502       \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         \u2502              SERVICE LAYER                            \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u2502\n\u2502  \u2502 ConnectionReg \u2502  \u2502 EventProcessor \u2502  \u2502 WidgetReg    \u2502       \u2502\n\u2502  \u2502 (Multi-server)\u2502  \u2502 (Pure function)\u2502  \u2502 (17 widgets) \u2502       \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         \u2502            PROTOCOL LAYER                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                       \u2502\n\u2502  \u2502 RoomSession    \u2502  \u2502 HttpTransport   \u2502                       \u2502\n\u2502  \u2502 (Chat history, \u2502  \u2502 (HTTP POST/GET) \u2502                       \u2502\n\u2502  \u2502  event loop)   \u2502  \u2502                 \u2502                       \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502                     \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         \u2502       NETWORK INFRASTRUCTURE LAYER                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                       \u2502\n\u2502  \u2502   NetworkTransportLayer              \u2502                       \u2502\n\u2502  \u2502   - http.Client (HTTP)               \u2502                       \u2502\n\u2502  \u2502   - ag_ui.AgUiClient (SSE)           \u2502                       \u2502\n\u2502  \u2502   - 401 Retry + Token Refresh        \u2502                       \u2502\n\u2502  \u2502   - NetworkInspector (observability) \u2502                       \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#codebase-statistics","title":"Codebase Statistics","text":"<ul> <li>Total Dart Files: ~181 files</li> <li>Lines of Code: ~35,000 lines</li> <li>Core Network Layer:</li> <li><code>NetworkTransportLayer</code>: 518 lines</li> <li><code>ConnectionRegistry</code>: 514 lines</li> <li><code>RoomSession</code>: 1,345 lines</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#design-patterns","title":"Design Patterns","text":"Pattern Usage Location Repository Data access abstraction for rooms, servers <code>lib/core/services/rooms_service.dart</code> Facade Simplified API for AG-UI interaction <code>lib/core/protocol/chat_session.dart</code> Observer Reactive state updates via Riverpod providers <code>lib/core/providers/</code> Strategy Pluggable network transports (HTTP vs native) <code>lib/core/network/http_transport.dart</code> Registry Widget factory for GenUI rendering <code>lib/core/services/widget_registry.dart</code> Single-Flight Token refresh deduplication <code>NetworkTransportLayer._handle401()</code> Factory Tool registration and execution <code>lib/infrastructure/quick_agui/thread.dart</code>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#network-infrastructure-deep-dive","title":"Network Infrastructure (Deep Dive)","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#three-layer-transport-architecture","title":"Three-Layer Transport Architecture","text":"<p>SOLIPLEX uses a 3-layer network stack to separate concerns and enable observability:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Layer 3: HttpTransport (JSON serialization)    \u2502\n\u2502 - post() \u2192 NetworkTransportLayer.post()        \u2502\n\u2502 - get() \u2192 NetworkTransportLayer.get()          \u2502\n\u2502 - Handles JSON encoding/decoding                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Layer 2: NetworkTransportLayer (HTTP/SSE)      \u2502\n\u2502 - Owns http.Client and ag_ui.AgUiClient        \u2502\n\u2502 - 401 retry with single-flight token refresh   \u2502\n\u2502 - SSE streaming with retry logic               \u2502\n\u2502 - NetworkInspector hooks for observability     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Layer 1: http.Client (dart:io or dart:html)    \u2502\n\u2502 - Platform-specific HTTP implementation        \u2502\n\u2502 - Web: XMLHttpRequest                          \u2502\n\u2502 - Native: dart:io.HttpClient                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#networktransportlayer-libcorenetworknetwork_transport_layerdart","title":"NetworkTransportLayer (<code>lib/core/network/network_transport_layer.dart</code>)","text":"<p>Key Responsibilities:</p> <ul> <li>Single source of truth for all network I/O</li> <li>Owns both HTTP client and SSE client</li> <li>Provides observable hooks for traffic capture</li> <li>Handles 401 Unauthorized with token refresh</li> </ul> <p>Key Interfaces:</p> <pre><code>class NetworkTransportLayer {\n  /// HTTP POST with 401 retry\n  Future&lt;http.Response&gt; post(Uri uri, String body, {\n    Map&lt;String, String&gt;? additionalHeaders,\n  });\n\n  /// HTTP GET with 401 retry\n  Future&lt;http.Response&gt; get(Uri uri, {\n    Map&lt;String, String&gt;? additionalHeaders,\n  });\n\n  /// SSE streaming with retry and watchdog timeout\n  Stream&lt;ag_ui.BaseEvent&gt; runAgent(\n    String endpoint,\n    ag_ui.SimpleRunAgentInput input,\n  );\n\n  /// Update auth headers (recreates SSE client)\n  void updateHeaders(Map&lt;String, String&gt; headers);\n}\n</code></pre> <p>Token Refresh Flow:</p> <pre><code>1. Request fails with 401\n2. Check if refresh already in-flight (_refreshFuture)\n3. If yes \u2192 wait for existing refresh\n4. If no \u2192 acquire lock, call headerRefresher()\n5. Update headers, recreate SSE client\n6. Retry original request\n7. Release lock\n</code></pre> <p>Implementation Details:</p> <ul> <li>Single-flight lock: <code>Completer&lt;void&gt;</code> prevents concurrent refreshes</li> <li>Retry strategy: 3 retries with exponential backoff (500ms intervals)</li> <li>SSE watchdog: 2-minute timeout if no events received (configurable)</li> <li>Inspector hooks: Records request/response metadata for debugging</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#connectionregistry-libcorenetworkconnection_registrydart","title":"ConnectionRegistry (<code>lib/core/network/connection_registry.dart</code>)","text":"<p>Purpose: Top-level registry managing multiple server connections.</p> <p>Key Features:</p> <ul> <li>Multi-server support: Maintains separate <code>ServerConnectionState</code> per server</li> <li>Session pooling: Per-server room sessions with LRU eviction</li> <li>Automatic cleanup: Background timer for inactive session disposal</li> <li>Server focus: Suspends old sessions when switching servers</li> </ul> <p>Session Lifecycle States:</p> <pre><code>enum SessionState {\n  active,        // UI visible, ready for messages\n  streaming,     // Active SSE stream in progress\n  backgrounded,  // UI hidden, preserved for quick resume\n  suspended,     // Deep sleep, resources released\n  disposed       // Permanent cleanup\n}\n</code></pre> <p>State Transitions:</p> <pre><code>active \u2500\u252c\u2500&gt; streaming (startRun called)\n        \u2514\u2500&gt; backgrounded (UI switches room)\n\nstreaming \u2500\u252c\u2500&gt; active (run completed)\n           \u251c\u2500&gt; backgrounded (UI switches room, cancels run)\n           \u2514\u2500&gt; disposed (error or manual disposal)\n\nbackgrounded \u2500\u252c\u2500&gt; active (UI returns to room)\n              \u251c\u2500&gt; suspended (inactivity timeout ~24h)\n              \u2514\u2500&gt; disposed (explicit removal)\n\nsuspended \u2500\u2500&gt; disposed (cleanup timer or manual removal)\n</code></pre> <p>Configuration:</p> <pre><code>class ConnectionConfig {\n  Duration serverInactivityTimeout;  // Default: 1 hour\n  Duration roomInactivityTimeout;    // Default: 30 minutes\n  Duration cleanupInterval;          // Default: 5 minutes\n  int maxBackgroundedSessionsPerServer; // Default: 5 (LRU eviction)\n}\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#roomsession-libcorenetworkroom_sessiondart","title":"RoomSession (<code>lib/core/network/room_session.dart</code>)","text":"<p>Purpose: Per-room session managing thread lifecycle, chat history, and event processing.</p> <p>Key Responsibilities:</p> <ul> <li>Thread creation and run management</li> <li>Message state (THE source of truth for chat messages)</li> <li>Event processing (AG-UI events \u2192 ChatMessage updates)</li> <li>Tool registration and execution</li> <li>Cancellation support via CancelToken</li> </ul> <p>Message State Architecture:</p> <pre><code>class RoomSession {\n  // THE authoritative message list\n  final List&lt;ChatMessage&gt; _messages = [];\n\n  // Stream for UI updates\n  final StreamController&lt;List&lt;ChatMessage&gt;&gt; _messageController;\n\n  // Event processing state\n  final Map&lt;String, String&gt; _messageIdMap = {};  // AG-UI ID \u2192 Chat ID\n  final Map&lt;String, StringBuffer&gt; _textBuffers = {};\n  final Map&lt;String, String&gt; _toolCallMessageIds = {};\n\n  // Deduplication\n  final Set&lt;String&gt; _processedToolCalls = {};\n}\n</code></pre> <p>Event Processing Flow:</p> <pre><code>1. SSE event arrives \u2192 RoomSession.processEvent()\n2. Build EventProcessingState snapshot\n3. Call EventProcessor.process() (pure function)\n4. Apply EventProcessingResult mutations to mutable state\n5. Throttle updates (50ms) and emit to _messageController\n6. Dispatch side effects (canvas, context pane, activity)\n</code></pre> <p>Tool Execution:</p> <pre><code>// Internal tools (fire-and-forget)\nstatic const _genUiTool = ag_ui.Tool(\n  name: 'genui_render',\n  description: 'Render a UI widget',\n  // ...\n);\n\n// External tools (with result response)\nvoid _registerTools(LocalToolsService service) {\n  for (final toolDef in service.tools) {\n    addTool(agTool, (call) async {\n      handleLocalToolExecution(call.id, toolName, 'executing');\n      final result = await service.executeTool(...);\n      handleLocalToolExecution(call.id, toolName, 'completed');\n      return jsonEncode(result.result);\n    });\n  }\n}\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#sse-streaming-with-retry","title":"SSE Streaming with Retry","text":"<p>Watchdog Timeout: Prevents zombie streams if server stops responding.</p> <pre><code>// In Thread.startRun()\nfinal eventStream = _getRunAgentStream(endpoint, input);\nfinal watchdogStream = streamTimeout\n    ? eventStream.timeout(\n        Duration(minutes: 2),\n        onTimeout: (sink) =&gt; throw StreamTimeoutException(),\n      )\n    : eventStream;\n</code></pre> <p>Retry Logic (in <code>NetworkTransportLayer.runAgent()</code>):</p> <pre><code>var retryCount = 0;\nconst maxRetries = 3;\n\nwhile (true) {\n  try {\n    await for (final event in _agUiClient.runAgent(endpoint, input)) {\n      eventCount++;\n      yield event;\n    }\n    break; // Success\n  } catch (e) {\n    if (eventCount &gt; 0 || retryCount &gt;= maxRetries) {\n      rethrow; // Don't retry mid-stream\n    }\n    retryCount++;\n    await Future.delayed(Duration(milliseconds: 500 * retryCount));\n  }\n}\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#url-building","title":"URL Building","text":"<p>UrlBuilder (<code>lib/core/utils/url_builder.dart</code>) provides centralized URL construction:</p> <pre><code>final builder = UrlBuilder('https://server.com');\n\nbuilder.rooms();                              // /api/v1/rooms\nbuilder.room(roomId);                         // /api/v1/rooms/{roomId}\nbuilder.createThread(roomId);                 // /api/v1/rooms/{roomId}/agui (POST)\nbuilder.executeRun(roomId, threadId, runId);  // /api/v1/rooms/{roomId}/agui/{threadId}/{runId}\n</code></pre> <p>URL Normalization:</p> <ul> <li>Ensures trailing slash for base URL</li> <li>Auto-adds <code>/api/v1</code> prefix</li> <li>Handles both <code>/</code> and no-<code>/</code> prefixed paths consistently</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#networkinspector-libcorenetworknetwork_inspectordart","title":"NetworkInspector (<code>lib/core/network/network_inspector.dart</code>)","text":"<p>Purpose: Observability layer for debugging network traffic.</p> <p>Captured Metadata:</p> <ul> <li>Request: method, URI, headers, body</li> <li>Response: status code, headers, body (or SSE event count)</li> <li>Timing: duration, timestamp</li> <li>Errors: exception messages</li> </ul> <p>Usage Pattern:</p> <pre><code>final inspector = NetworkInspector();\n\n// Inspector is injected into NetworkTransportLayer\nfinal transport = NetworkTransportLayer(\n  baseUrl: serverUrl,\n  inspector: inspector,\n);\n\n// UI subscribes to inspector for debugging panel\nref.watch(networkInspectorProvider);\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#state-management","title":"State Management","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#riverpod-architecture-3-tier","title":"Riverpod Architecture (3-Tier)","text":"<p>SOLIPLEX uses Riverpod with a 3-tier provider hierarchy:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Tier 1: App-Level Providers                    \u2502\n\u2502 - authStateProvider (global auth state)        \u2502\n\u2502 - connectionRegistryProvider (singleton)       \u2502\n\u2502 - currentServerProvider (selected server)      \u2502\n\u2502 - selectedRoomProvider (selected room)         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                  \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Tier 2: Panel-Level Providers (per-room)       \u2502\n\u2502 - roomCanvasProvider(ServerRoomKey)            \u2502\n\u2502 - roomContextPaneProvider(ServerRoomKey)       \u2502\n\u2502 - roomActivityStatusProvider(ServerRoomKey)    \u2502\n\u2502 - roomMessageStreamProvider(ServerRoomKey)     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                  \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Tier 3: Feature-Level Providers                \u2502\n\u2502 - markdownHooksProvider (callbacks)            \u2502\n\u2502 - feedbackServiceProvider (per-room family)    \u2502\n\u2502 - notesServiceProvider (per-room family)       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#serverscopednotifier-pattern","title":"ServerScopedNotifier Pattern","text":"<p>Problem: Panel state (canvas, context pane) must reset when server changes.</p> <p>Solution: All panel providers watch <code>currentServerFromAppStateProvider</code>:</p> <pre><code>// lib/core/providers/panel_providers.dart\n\n/// Canvas state clears when server changes\nfinal canvasProvider = StateNotifierProvider&lt;CanvasNotifier, CanvasState&gt;((ref) {\n  final server = ref.watch(currentServerFromAppStateProvider);\n  return CanvasNotifier(serverId: server?.id);\n});\n</code></pre> <p>When to Use:</p> <ul> <li>Panel state tied to server connection (canvas, context pane, activity)</li> <li>State should NOT persist when switching servers</li> </ul> <p>When NOT to Use:</p> <ul> <li>App-level state (auth, settings)</li> <li>Per-room state that should persist across server switches</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#family-providers-with-serverroomkey","title":"Family Providers with ServerRoomKey","text":"<p>Composite Key Pattern:</p> <pre><code>@immutable\nclass ServerRoomKey {\n  const ServerRoomKey({\n    required this.serverId,\n    required this.roomId,\n  });\n\n  final String serverId;\n  final String roomId;\n\n  @override\n  bool operator ==(Object other) =&gt; /* equality check */;\n\n  @override\n  int get hashCode =&gt; Object.hash(serverId, roomId);\n}\n</code></pre> <p>Usage:</p> <pre><code>// Per-room canvas state\nfinal roomCanvasProvider = StateNotifierProvider.family&lt;\n  CanvasNotifier,\n  CanvasState,\n  ServerRoomKey\n&gt;((ref, key) =&gt; CanvasNotifier(\n  serverId: key.serverId,\n  roomId: key.roomId,\n));\n\n// Convenience provider for active room\nfinal activeCanvasProvider = Provider&lt;CanvasState&gt;((ref) {\n  final key = ref.watch(activeServerRoomKeyProvider);\n  if (key == null) return const CanvasState();\n  return ref.watch(roomCanvasProvider(key));\n});\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#message-stream-bridge","title":"Message Stream Bridge","text":"<p>Challenge: UI needs reactive updates from RoomSession message changes.</p> <p>Solution: <code>roomMessageStreamProvider</code> bridges session to UI:</p> <pre><code>final roomMessageStreamProvider = StreamProvider.family&lt;\n  List&lt;ChatMessage&gt;,\n  ServerRoomKey\n&gt;((ref, key) {\n  final registry = ref.watch(connectionRegistryProvider);\n  final session = registry.getSession(key);\n  return session.messageStream.startWith(session.messages);\n});\n</code></pre> <p>Key Pattern: <code>startWith()</code> ensures current state is immediately available (no initial loading spinner).</p>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#provider-declaration-rules","title":"Provider Declaration Rules","text":"<p>CRITICAL: All panel providers MUST be declared in <code>lib/core/providers/panel_providers.dart</code>.</p> <p>Why:</p> <ul> <li>Centralized visibility of server-scoped providers</li> <li>Ensures all panel state watches <code>currentServerFromAppStateProvider</code></li> <li>Prevents accidental imports from service files (breaks reset behavior)</li> </ul> <p>How to Add a New Panel:</p> <p>Step 1: Create notifier extending <code>ServerScopedNotifier</code>:</p> <pre><code>class MyPanelNotifier extends StateNotifier&lt;MyPanelState&gt; {\n  MyPanelNotifier({String? serverId, String? roomId})\n    : _serverId = serverId, super(const MyPanelState());\n\n  final String? _serverId;\n}\n</code></pre> <p>Step 2: Declare provider in <code>panel_providers.dart</code>:</p> <pre><code>final roomMyPanelProvider = StateNotifierProvider.family&lt;\n  MyPanelNotifier,\n  MyPanelState,\n  ServerRoomKey\n&gt;((ref, key) =&gt; MyPanelNotifier(\n  serverId: key.serverId,\n  roomId: key.roomId,\n));\n\nfinal activeMyPanelProvider = Provider&lt;MyPanelState&gt;((ref) {\n  final key = ref.watch(activeServerRoomKeyProvider);\n  if (key == null) return const MyPanelState();\n  return ref.watch(roomMyPanelProvider(key));\n});\n</code></pre> <p>Step 3: UI watches the active provider:</p> <pre><code>final panelState = ref.watch(activeMyPanelProvider);\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#ag-ui-protocol-integration","title":"AG-UI Protocol Integration","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#ag-ui-overview","title":"AG-UI Overview","text":"<p>AG-UI (Agentic Generative UI) is a protocol for real-time AI agent communication with UI rendering capabilities.</p> <p>Key Concepts:</p> <ul> <li>Thread: Conversation context (persistent)</li> <li>Run: Single agent execution within a thread</li> <li>Messages: User, Assistant, Tool messages</li> <li>Tools: Client-side functions the agent can invoke</li> <li>State: Arbitrary JSON passed to agent (e.g., canvas contents)</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#thread-lifecycle","title":"Thread Lifecycle","text":"<pre><code>1. Create Thread (POST /api/v1/rooms/{roomId}/agui)\n   \u2190 { thread_id, runs: { run_id: {...} } }\n\n2. Send User Message\n   a. Create Run (POST /api/v1/rooms/{roomId}/agui/{threadId})\n      \u2190 { run_id }\n   b. Execute Run (POST .../agui/{threadId}/{runId}) [SSE stream]\n      \u2192 { threadId, runId, messages, state, tools }\n      \u2190 SSE events: RUN_STARTED, TEXT_MESSAGE_*, TOOL_CALL_*, ...\n\n3. Tool Execution Loop\n   - Client executes tools locally\n   - Creates new run with ToolMessage results\n   - Repeats until no more tool calls\n\n4. Conversation continues...\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#event-types","title":"Event Types","text":"<p>Run Lifecycle:</p> <ul> <li><code>RUN_STARTED</code>, <code>RUN_FINISHED</code>, <code>RUN_ERROR</code></li> </ul> <p>Text Streaming:</p> <ul> <li><code>TEXT_MESSAGE_START</code> \u2192 create message</li> <li><code>TEXT_MESSAGE_CONTENT</code> \u2192 append delta</li> <li><code>TEXT_MESSAGE_END</code> \u2192 finalize</li> </ul> <p>Tool Calls:</p> <ul> <li><code>TOOL_CALL_START</code> \u2192 tool invoked</li> <li><code>TOOL_CALL_ARGS</code> \u2192 arguments streaming</li> <li><code>TOOL_CALL_END</code> \u2192 arguments complete</li> <li><code>TOOL_CALL_RESULT</code> \u2192 result returned</li> </ul> <p>State Updates:</p> <ul> <li><code>STATE_SNAPSHOT</code> \u2192 full state replacement</li> <li><code>STATE_DELTA</code> \u2192 incremental update</li> </ul> <p>Thinking (extended reasoning):</p> <ul> <li><code>THINKING_TEXT_MESSAGE_START</code></li> <li><code>THINKING_TEXT_MESSAGE_CONTENT</code></li> <li><code>THINKING_TEXT_MESSAGE_END</code></li> </ul> <p>Activity:</p> <ul> <li><code>ACTIVITY_SNAPSHOT</code> \u2192 agent activity status</li> </ul> <p>Custom (GenUI):</p> <ul> <li><code>CUSTOM</code> \u2192 custom events for UI tools</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#eventprocessor-libcorenetworkevent_processordart","title":"EventProcessor (<code>lib/core/network/event_processor.dart</code>)","text":"<p>Purpose: Pure function for testable event processing.</p> <p>Key Abstraction:</p> <pre><code>class EventProcessor {\n  const EventProcessor();\n\n  /// Process a single event and return mutations.\n  /// Pure function - no side effects, no mutable state.\n  EventProcessingResult process(\n    EventProcessingState state,\n    ag_ui.BaseEvent event,\n  );\n}\n</code></pre> <p>EventProcessingResult contains:</p> <ul> <li><code>messageMutations</code>: Add/update chat messages</li> <li><code>messageIdMapUpdate</code>: Update AG-UI ID mapping</li> <li><code>textBuffersUpdate</code>: Update streaming buffers</li> <li><code>thinkingBufferUpdate</code>: Update thinking state</li> <li><code>contextUpdate</code>: Side effect for context pane</li> <li><code>activityUpdate</code>: Side effect for activity status</li> <li><code>canvasUpdate</code>: Side effect for canvas operations</li> </ul> <p>Benefits:</p> <ul> <li>Testability: Easy to unit test with mock events</li> <li>Determinism: Same input \u2192 same output</li> <li>Debugging: No hidden state changes</li> <li>Concurrency: Thread-safe by design</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#tool-execution-system","title":"Tool Execution System","text":"<p>Fire-and-Forget vs Standard Tools:</p> <pre><code>// Fire-and-forget (UI tools, no result needed)\naddTool(_genUiTool, executeInternalTool, fireAndForget: true);\n\n// Standard (result sent back to agent)\naddTool(agTool, (call) async {\n  final result = await service.executeTool(call.id, call.function.name, args);\n  return jsonEncode(result);\n});\n</code></pre> <p>Internal Tools (registered by RoomSession):</p> <ul> <li><code>genui_render</code>: Render widget in chat</li> <li><code>canvas_render</code>: Render widget on canvas</li> </ul> <p>External Tools (registered by LocalToolsService):</p> <ul> <li><code>get_my_location</code>: GPS location</li> <li>Custom tools defined by backend</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#state-sync","title":"State Sync","text":"<p>Sending Canvas State to Agent:</p> <pre><code>// In chat_content.dart\nfinal canvasState = ref.read(activeCanvasProvider);\nawait session.sendMessage(\n  text,\n  state: canvasState.toJson(),  // {\"canvas\": [...]}\n);\n</code></pre> <p>Backend Requirement: Agent must implement <code>StateHandler</code> protocol (see <code>SOLIPLEX.md</code> for details).</p>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#widget-system","title":"Widget System","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#widget-registry","title":"Widget Registry","text":"<p>Purpose: Factory for rendering native Flutter widgets from JSON data.</p> <p>Registration:</p> <pre><code>class WidgetRegistry {\n  void register(String widgetName, WidgetBuilder builder) {\n    _builders[widgetName.toLowerCase()] = builder;\n  }\n\n  Widget? build(BuildContext context, String widgetName,\n                Map&lt;String, dynamic&gt; data, {\n    void Function(String eventName, Map&lt;String, dynamic&gt; args)? onEvent,\n  });\n}\n</code></pre> <p>Registered Widgets (17 total):</p> Widget Purpose Canvas Support Event Callback <code>InfoCard</code> Info display with icon Yes Yes <code>MetricDisplay</code> Metric with trend indicator No No <code>DataList</code> Key-value list No No <code>ErrorDisplay</code> Error message No No <code>LoadingIndicator</code> Spinner No No <code>ActionButton</code> Clickable button No Yes <code>ProgressCard</code> Progress bar No No <code>LocationCard</code> GPS coordinates No No <code>GISCard</code> OpenStreetMap view Yes Yes <code>SearchWidget</code> Search interface No Yes <code>SkillsCard</code> Skills display Yes Yes <code>ProjectCard</code> Project summary Yes Yes <code>NoteCard</code> Note display Yes No <code>CodeCard</code> Code snippet Yes No <code>MarkdownCard</code> Markdown content Yes No <p>Widget Builder Signature:</p> <pre><code>typedef WidgetBuilder = Widget Function(\n  BuildContext context,\n  Map&lt;String, dynamic&gt; data,\n  void Function(String eventName, Map&lt;String, dynamic&gt; args)? onEvent,\n);\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#semantic-ids-for-canvas-widgets","title":"Semantic IDs for Canvas Widgets","text":"<p>Purpose: Stable IDs for canvas operations (update, remove).</p> <p>Pattern:</p> <pre><code>// Generate semantic ID from data\nString getSemanticId(Map&lt;String, dynamic&gt; data) {\n  final type = data['type'] as String?;\n  final id = data['id'] as String?;\n  if (type != null &amp;&amp; id != null) {\n    return '$type-$id';  // e.g., \"staff-u1\", \"project-p1\"\n  }\n  return 'widget-${uuid.v4()}';  // Fallback to random ID\n}\n</code></pre> <p>Canvas Operations:</p> <pre><code>// Append (default)\ncanvas_render(widget_name=\"ProjectCard\", data={...}, position=\"append\")\n\n// Replace by semantic ID\ncanvas_render(widget_name=\"ProjectCard\", data={id: \"p1\", ...}, position=\"replace\")\n\n// Clear all\ncanvas_render(widget_name=\"ProjectCard\", position=\"clear\")\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#adding-a-new-widget","title":"Adding a New Widget","text":"<p>Step 1: Create widget file:</p> <pre><code>// lib/widgets/registry/my_widget.dart\nclass MyWidget extends StatelessWidget {\n  const MyWidget({required this.data, this.onEvent});\n\n  final Map&lt;String, dynamic&gt; data;\n  final void Function(String, Map&lt;String, dynamic&gt;)? onEvent;\n\n  factory MyWidget.fromData(\n    Map&lt;String, dynamic&gt; data,\n    void Function(String, Map&lt;String, dynamic&gt;)? onEvent,\n  ) {\n    return MyWidget(data: data, onEvent: onEvent);\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final title = data['title'] as String? ?? 'No Title';\n    return Card(\n      child: ListTile(\n        title: Text(title),\n        onTap: () =&gt; onEvent?.call('tap', {}),\n      ),\n    );\n  }\n}\n</code></pre> <p>Step 2: Register in WidgetRegistry:</p> <pre><code>// lib/core/services/widget_registry.dart\nvoid _registerDefaultWidgets() {\n  // ...\n  register('MyWidget', (context, data, onEvent) {\n    return MyWidget.fromData(data, onEvent);\n  });\n}\n</code></pre> <p>Step 3: Document in this file and <code>GENUI-WIDGETS.md</code>.</p>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#cross-platform-considerations","title":"Cross-Platform Considerations","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#platform-specific-code-pattern","title":"Platform-Specific Code Pattern","text":"<p>CRITICAL: SOLIPLEX must work on Web, Mobile, and Desktop. The <code>dart:io</code> package is NOT available on web.</p> <p>Conditional Imports:</p> <pre><code>// my_service.dart\nimport 'my_service_io.dart' if (dart.library.html) 'my_service_web.dart' as platform;\n\nFuture&lt;void&gt; saveData(String data) async {\n  await platform.saveDataImpl(data);\n}\n\n// my_service_io.dart (native)\nimport 'dart:io';\n\nFuture&lt;void&gt; saveDataImpl(String data) async {\n  final file = File('path/to/file');\n  await file.writeAsString(data);\n}\n\n// my_service_web.dart (web)\nimport 'dart:html';\n\nFuture&lt;void&gt; saveDataImpl(String data) async {\n  window.localStorage['key'] = data;\n}\n</code></pre> <p>Naming Convention:</p> <ul> <li><code>*_io.dart</code>: Native implementation using <code>dart:io</code></li> <li><code>*_web.dart</code>: Web implementation using <code>dart:html</code> or stubs</li> </ul> <p>Current Platform-Specific Features:</p> Feature Web Native Implementation Room Notes Hidden (<code>kIsWeb</code> check) File I/O <code>notes_service_io.dart</code> Feedback Storage localStorage File I/O <code>feedback_service_io.dart</code> / <code>_web.dart</code> Secure Storage localStorage flutter_secure_storage <code>secure_storage_service_io.dart</code> / <code>_web.dart</code> <p>When to Hide UI on Web:</p> <pre><code>// In build method\nif (!kIsWeb)\n  IconButton(\n    icon: Icon(Icons.notes),\n    onPressed: () =&gt; _showNotesDialog(),\n  )\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#http-client-differences","title":"HTTP Client Differences","text":"<p>Web: Uses <code>XMLHttpRequest</code> (browser-managed, no custom SSL) Native: Uses <code>dart:io.HttpClient</code> (can customize SSL, certificates)</p> <p>Implication: HTTPS enforcement and SSRF prevention differ by platform.</p>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#security-architecture","title":"Security Architecture","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#authentication-flow-oidc-pkce","title":"Authentication Flow (OIDC + PKCE)","text":"<p>1. Login Initiation:</p> <pre><code>User \u2192 LoginScreen \u2192 AuthManager.login(provider, server)\n  \u2193\nAuthManager \u2192 OidcAuthInteractor.authorizeAndExchangeCode()\n  \u2193\nOidcAuthInteractor \u2192 flutter_appauth (native OIDC flow)\n  \u2193\nBrowser/WebView \u2192 OIDC Provider (Keycloak)\n  \u2193\nAuthorization Code \u2192 flutter_appauth\n  \u2193\nToken Exchange (PKCE) \u2192 Access Token + Refresh Token\n  \u2193\nAuthManager \u2192 SecureTokenStorage.storeTokens()\n</code></pre> <p>2. Token Storage:</p> <p>Platform-Specific:</p> <ul> <li>iOS/macOS: Keychain via <code>flutter_secure_storage</code></li> <li>Android: KeyStore via <code>flutter_secure_storage</code></li> <li>Web: <code>localStorage</code> (fallback, less secure)</li> <li>Linux/Windows: Encrypted file via <code>flutter_secure_storage</code></li> </ul> <p>3. Token Refresh:</p> <pre><code>NetworkTransportLayer receives 401\n  \u2193\n_handle401() \u2192 headerRefresher()\n  \u2193\nAuthManager.refreshToken(serverId)\n  \u2193\nSecureTokenStorage.getRefreshToken()\n  \u2193\nHTTP POST to token endpoint with refresh_token\n  \u2193\nNew access_token + refresh_token\n  \u2193\nSecureTokenStorage.storeTokens()\n  \u2193\nNetworkTransportLayer.updateHeaders()\n  \u2193\nRetry original request\n</code></pre> <p>Single-Flight Lock: Prevents concurrent refreshes for same server.</p>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#https-enforcement","title":"HTTPS Enforcement","text":"<p>URL Normalization:</p> <pre><code>// In UrlBuilder\nString normalizeServerUrl(String url) {\n  // Upgrade http:// to https:// (except localhost)\n  if (url.startsWith('http://') &amp;&amp; !url.contains('localhost')) {\n    url = url.replaceFirst('http://', 'https://');\n  }\n  return url;\n}\n</code></pre> <p>SSRF Prevention:</p> <ul> <li>URL validation before network calls</li> <li>No arbitrary redirects</li> <li>Certificate pinning (native platforms only)</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#security-recommendations","title":"Security Recommendations","text":"<p>Completed:</p> <ul> <li>\u2705 OIDC with PKCE (no client secret exposure)</li> <li>\u2705 Platform-appropriate secure storage</li> <li>\u2705 HTTPS enforcement</li> <li>\u2705 Token refresh with single-flight lock</li> <li>\u2705 No sensitive data in logs (tokens redacted)</li> </ul> <p>Future Enhancements:</p> <ul> <li>\ud83d\udd04 Certificate pinning for production servers</li> <li>\ud83d\udd04 Biometric authentication for token access</li> <li>\ud83d\udd04 Token expiry warnings before expiration</li> <li>\ud83d\udd04 Audit logging for security events</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#key-files-reference","title":"Key Files Reference","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#network-layer","title":"Network Layer","text":"File Lines Purpose <code>lib/core/network/network_transport_layer.dart</code> 518 Low-level HTTP/SSE client with 401 retry <code>lib/core/network/connection_registry.dart</code> 514 Multi-server connection manager <code>lib/core/network/room_session.dart</code> 1,345 Per-room session with message state <code>lib/core/network/http_transport.dart</code> ~200 JSON-level HTTP transport facade <code>lib/core/network/network_inspector.dart</code> ~150 Traffic capture for debugging <code>lib/core/network/cancel_token.dart</code> ~50 Cancellation support <code>lib/core/network/connection_events.dart</code> ~200 Event types for session lifecycle"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#state-management-files","title":"State Management Files","text":"File Lines Purpose <code>lib/core/providers/panel_providers.dart</code> 307 All panel provider declarations <code>lib/core/providers/app_providers.dart</code> ~300 App-level providers <code>lib/core/services/canvas_service.dart</code> ~250 Canvas state management <code>lib/core/services/context_pane_service.dart</code> ~200 Context pane state <code>lib/core/services/activity_status_service.dart</code> ~300 Activity status with timers"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#protocol-layer","title":"Protocol Layer","text":"File Lines Purpose <code>lib/infrastructure/quick_agui/thread.dart</code> ~600 Thread management and tool execution <code>lib/core/network/event_processor.dart</code> ~500 Pure function event processing <code>lib/core/protocol/chat_session.dart</code> ~100 ChatSession interface <code>lib/infrastructure/quick_agui/tool_call_registry.dart</code> ~200 Tool state tracking"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#ui-layer","title":"UI Layer","text":"File Lines Purpose <code>lib/features/chat/chat_screen.dart</code> ~600 Main chat interface <code>lib/features/chat/chat_content.dart</code> ~800 Message rendering and input <code>lib/features/canvas/canvas_panel.dart</code> ~400 Canvas widget display <code>lib/features/context/context_pane.dart</code> ~300 Context pane UI"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#widget-system-files","title":"Widget System Files","text":"File Lines Purpose <code>lib/core/services/widget_registry.dart</code> 146 Widget factory registry <code>lib/widgets/registry/*.dart</code> ~150 each Individual widget implementations"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#authentication","title":"Authentication","text":"File Lines Purpose <code>lib/core/services/auth_manager.dart</code> ~400 OIDC auth operations <code>lib/core/auth/oidc_auth_interactor.dart</code> ~300 flutter_appauth wrapper <code>lib/core/auth/secure_token_storage.dart</code> ~150 Token persistence <code>lib/core/services/secure_storage_service.dart</code> ~200 Platform-specific storage"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#utilities","title":"Utilities","text":"File Lines Purpose <code>lib/core/utils/url_builder.dart</code> ~200 URL construction and normalization <code>lib/core/utils/debug_log.dart</code> ~100 Categorized logging <code>lib/core/utils/update_throttler.dart</code> ~80 UI update throttling"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#extension-guide","title":"Extension Guide","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#adding-a-new-panel","title":"Adding a New Panel","text":"<p>Scenario: Add a \"Notes Sidebar\" panel to the UI.</p> <p>Step 1: Create state model:</p> <pre><code>// lib/core/models/notes_sidebar_models.dart\n@immutable\nclass NotesSidebarState {\n  const NotesSidebarState({this.notes = const []});\n  final List&lt;Note&gt; notes;\n\n  NotesSidebarState copyWith({List&lt;Note&gt;? notes}) =&gt; /* ... */;\n}\n</code></pre> <p>Step 2: Create notifier:</p> <pre><code>// lib/core/services/notes_sidebar_service.dart\nclass NotesSidebarNotifier extends StateNotifier&lt;NotesSidebarState&gt; {\n  NotesSidebarNotifier({\n    String? serverId,\n    String? roomId,\n  }) : _serverId = serverId,\n       _roomId = roomId,\n       super(const NotesSidebarState());\n\n  final String? _serverId;\n  final String? _roomId;\n\n  void addNote(Note note) {\n    state = state.copyWith(notes: [...state.notes, note]);\n  }\n}\n</code></pre> <p>Step 3: Declare provider in panel_providers.dart:</p> <pre><code>// lib/core/providers/panel_providers.dart\nfinal roomNotesSidebarProvider = StateNotifierProvider.family&lt;\n  NotesSidebarNotifier,\n  NotesSidebarState,\n  ServerRoomKey\n&gt;((ref, key) =&gt; NotesSidebarNotifier(\n  serverId: key.serverId,\n  roomId: key.roomId,\n));\n\nfinal activeNotesSidebarProvider = Provider&lt;NotesSidebarState&gt;((ref) {\n  final key = ref.watch(activeServerRoomKeyProvider);\n  if (key == null) return const NotesSidebarState();\n  return ref.watch(roomNotesSidebarProvider(key));\n});\n</code></pre> <p>Step 4: Create UI:</p> <pre><code>// lib/features/notes_sidebar/notes_sidebar.dart\nclass NotesSidebar extends ConsumerWidget {\n  @override\n  Widget build(BuildContext context, WidgetRef ref) {\n    final state = ref.watch(activeNotesSidebarProvider);\n    final notifier = ref.read(activeNotesSidebarNotifierProvider);\n\n    return ListView.builder(\n      itemCount: state.notes.length,\n      itemBuilder: (context, index) =&gt; /* ... */,\n    );\n  }\n}\n</code></pre> <p>Step 5: Integrate into layout:</p> <pre><code>// lib/features/chat/chat_screen.dart\nRow(\n  children: [\n    Expanded(child: ChatContent()),\n    if (showNotesSidebar)\n      Container(width: 300, child: NotesSidebar()),\n  ],\n)\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#adding-a-new-widget-type","title":"Adding a New Widget Type","text":"<p>Scenario: Add a \"ChartWidget\" for data visualization.</p> <p>Steps:</p> <p>Step 1: Create widget file:</p> <pre><code>// lib/widgets/registry/chart_widget.dart\nimport 'package:fl_chart/fl_chart.dart';\n\nclass ChartWidget extends StatelessWidget {\n  const ChartWidget({required this.data, this.onEvent});\n\n  final Map&lt;String, dynamic&gt; data;\n  final void Function(String, Map&lt;String, dynamic&gt;)? onEvent;\n\n  factory ChartWidget.fromData(\n    Map&lt;String, dynamic&gt; data,\n    void Function(String, Map&lt;String, dynamic&gt;)? onEvent,\n  ) {\n    return ChartWidget(data: data, onEvent: onEvent);\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final chartType = data['chart_type'] as String? ?? 'line';\n    final dataPoints = (data['data'] as List?)?.cast&lt;Map&lt;String, dynamic&gt;&gt;() ?? [];\n\n    if (chartType == 'bar') {\n      return BarChart(/* ... */);\n    } else {\n      return LineChart(/* ... */);\n    }\n  }\n}\n</code></pre> <p>Step 2: Register widget:</p> <pre><code>// lib/core/services/widget_registry.dart\nvoid _registerDefaultWidgets() {\n  // ...\n  register('ChartWidget', (context, data, onEvent) {\n    return ChartWidget.fromData(data, onEvent);\n  });\n}\n</code></pre> <p>Step 3: Add semantic ID logic (if canvas-compatible):</p> <pre><code>String getSemanticId(Map&lt;String, dynamic&gt; data) {\n  final chartId = data['chart_id'] as String?;\n  if (chartId != null) {\n    return 'chart-$chartId';\n  }\n  return 'chart-${uuid.v4()}';\n}\n</code></pre> <p>Step 4: Document:</p> <ul> <li>Add to table in <code>GENUI-WIDGETS.md</code></li> <li>Update this file's widget table</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#adding-a-new-network-feature","title":"Adding a New Network Feature","text":"<p>Scenario: Add \"request queueing\" when offline.</p> <p>Steps:</p> <p>Step 1: Add state to RoomSession:</p> <pre><code>// In RoomSession\nfinal Queue&lt;PendingRequest&gt; _queuedRequests = Queue();\n\nclass PendingRequest {\n  final String text;\n  final Map&lt;String, dynamic&gt;? state;\n  final Completer&lt;void&gt; completer;\n}\n</code></pre> <p>Step 2: Modify sendMessage:</p> <pre><code>Future&lt;void&gt; sendMessage(String text, {Map&lt;String, dynamic&gt;? state}) async {\n  if (!_isOnline()) {\n    // Queue request\n    final request = PendingRequest(\n      text: text,\n      state: state,\n      completer: Completer&lt;void&gt;(),\n    );\n    _queuedRequests.add(request);\n    return request.completer.future;\n  }\n\n  // Normal flow\n  await _sendMessageImpl(text, state: state);\n}\n</code></pre> <p>Step 3: Add queue processor:</p> <pre><code>void _processQueue() async {\n  while (_queuedRequests.isNotEmpty &amp;&amp; _isOnline()) {\n    final request = _queuedRequests.removeFirst();\n    try {\n      await _sendMessageImpl(request.text, state: request.state);\n      request.completer.complete();\n    } catch (e) {\n      request.completer.completeError(e);\n    }\n  }\n}\n</code></pre> <p>Step 4: Add connectivity monitoring:</p> <pre><code>StreamSubscription&lt;ConnectivityResult&gt;? _connectivitySubscription;\n\nvoid _setupConnectivityMonitoring() {\n  _connectivitySubscription =\n    Connectivity().onConnectivityChanged.listen((result) {\n      if (result != ConnectivityResult.none) {\n        _processQueue();\n      }\n    });\n}\n</code></pre> <p>Step 5: Update dispose:</p> <pre><code>@override\nvoid dispose() {\n  _connectivitySubscription?.cancel();\n  // ... existing disposal\n}\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#testing-patterns","title":"Testing Patterns","text":"<p>Network Layer Testing:</p> <pre><code>// Use MockHttpTransport\nfinal mockTransport = MockHttpTransport();\nwhen(() =&gt; mockTransport.post(any(), any()))\n  .thenAnswer((_) async =&gt; {'thread_id': 'test-123'});\n\nfinal session = RoomSession(\n  roomId: 'test-room',\n  baseUrl: 'https://test.com',\n  transport: mockTransport,\n);\n</code></pre> <p>Event Processing Testing:</p> <pre><code>// EventProcessor is pure - easy to test\nfinal processor = EventProcessor();\nfinal state = EventProcessingState(/* ... */);\nfinal event = ag_ui.TextMessageStartEvent(/* ... */);\n\nfinal result = processor.process(state, event);\n\nexpect(result.messageMutations, hasLength(1));\nexpect(result.messageMutations.first, isA&lt;AddMessage&gt;());\n</code></pre> <p>Widget Testing:</p> <pre><code>testWidgets('ChartWidget renders bar chart', (tester) async {\n  final widget = ChartWidget.fromData({\n    'chart_type': 'bar',\n    'data': [{'x': 1, 'y': 10}],\n  }, null);\n\n  await tester.pumpWidget(MaterialApp(home: widget));\n\n  expect(find.byType(BarChart), findsOneWidget);\n});\n</code></pre>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#appendix-architecture-decisions","title":"Appendix: Architecture Decisions","text":""},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#why-3-layer-network-stack","title":"Why 3-Layer Network Stack?","text":"<p>Rationale:</p> <ul> <li>Separation: HTTP logic (Layer 2) separate from JSON serialization (Layer 3)</li> <li>Observability: NetworkInspector hooks in Layer 2 without coupling to business logic</li> <li>Testability: Can mock at any layer (HttpTransport for integration tests, NetworkTransportLayer for unit tests)</li> <li>Platform Independence: Layer 1 swaps based on platform without affecting Layers 2-3</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#why-riverpod-over-bloc-or-provider","title":"Why Riverpod Over BLoC or Provider?","text":"<p>Rationale:</p> <ul> <li>Compile-time safety: No runtime errors from typos</li> <li>Family providers: Natural multi-server, per-room state</li> <li>Auto-disposal: Providers dispose when no longer watched</li> <li>Testing: Easy to override providers in tests</li> <li>Composition: Providers can watch other providers</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#why-pure-eventprocessor-instead-of-statefulwidget","title":"Why Pure EventProcessor Instead of StatefulWidget?","text":"<p>Rationale:</p> <ul> <li>Testability: No async, no side effects, deterministic output</li> <li>Debugging: Easy to log input/output for troubleshooting</li> <li>Concurrency: Thread-safe by design (no shared mutable state)</li> <li>Reproducibility: Can replay events for bug reproduction</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#why-connectionregistry-instead-of-global-aguiservice","title":"Why ConnectionRegistry Instead of Global AgUiService?","text":"<p>Rationale:</p> <ul> <li>Multi-server: Users can connect to multiple backend servers simultaneously</li> <li>Session Isolation: Each server-room combo gets independent state</li> <li>Resource Management: LRU eviction and inactivity timeouts prevent memory leaks</li> <li>Scalability: Can handle dozens of backgrounded sessions without degradation</li> </ul>"},{"location":"flutter/planning/architecture/REVERSE_ENGINEERED/#glossary","title":"Glossary","text":"Term Definition AG-UI Agentic Generative UI protocol for AI agent communication SSE Server-Sent Events, HTTP streaming for real-time updates GenUI Generative UI, AI-generated native widget rendering OIDC OpenID Connect, authentication protocol PKCE Proof Key for Code Exchange, security extension for OAuth Riverpod Flutter state management library Family Provider Riverpod provider parameterized by a key (e.g., ServerRoomKey) ServerRoomKey Composite key (serverId + roomId) for multi-server state RoomSession Per-room session managing thread, messages, and event processing ConnectionRegistry Top-level manager for multi-server connections EventProcessor Pure function for processing AG-UI events Thread AG-UI conversation context (persistent across runs) Run Single agent execution within a thread Tool Client-side function the agent can invoke Fire-and-Forget Tool Tool executed without sending result back (e.g., UI tools) Watchdog Timeout Timer that kills stalled SSE streams Single-Flight Lock Concurrency pattern to deduplicate parallel operations <p>Document Maintenance: Update this file when adding major features, refactoring network layer, or changing state management patterns.</p> <p>Questions? See existing documentation:</p> <ul> <li><code>SOLIPLEX.md</code> - Backend API and AG-UI integration details</li> <li><code>APP_FEATURES.md</code> - Feature tracking and implementation notes</li> <li><code>PROJECT.md</code> - Project overview and status</li> </ul> <p>Last Reviewed: 2025-12-15 Reviewers: Documentation Engineer</p>"},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/","title":"Backend Bug: [Errno 2] No such file or directory","text":""},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#summary","title":"Summary","text":"<p>Backend returns Python <code>[Errno 2] No such file or directory</code> error when fetching thread messages after switching rooms.</p>"},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#reproduction-steps","title":"Reproduction Steps","text":"<ol> <li>Log into the app</li> <li>Navigate to room \"haiku\"</li> <li>Create or view a thread, send a message (works fine)</li> <li>Switch to room \"gitea\"</li> <li>The app auto-selects a thread (from last-viewed or first in list)</li> <li>Error appears: \"An unexpected error occurred. [Errno 2] No such file or directory\"</li> </ol>"},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#technical-details","title":"Technical Details","text":""},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#frontend-api-call","title":"Frontend API Call","text":"<pre><code>GET /api/v1/rooms/{roomId}/agui/{threadId}\n</code></pre> <p>The frontend calls <code>SoliplexApi.getThreadMessages(roomId, threadId)</code> which hits this endpoint to retrieve all runs and events for message reconstruction.</p>"},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#error-source","title":"Error Source","text":"<p>The error <code>[Errno 2]</code> is a Python POSIX error (<code>ENOENT</code>) indicating a file or directory doesn't exist. This suggests the backend is trying to read from the filesystem (likely the thread's event store or run data) and the path doesn't exist.</p>"},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#observed-behavior","title":"Observed Behavior","text":"<ul> <li>Thread ID: <code>82d06514-04d8-4131-bec6-f08012275ea6</code></li> <li>Room: <code>gitea</code></li> <li>The thread appears in the sidebar (meaning <code>GET /rooms/{roomId}/threads</code> succeeded)</li> <li>But loading messages fails</li> </ul>"},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#hypothesis","title":"Hypothesis","text":"<p>Possible causes:</p> <ol> <li>Thread exists in DB but run data missing: The thread was created but its    run/event files were never written or were deleted</li> <li>Cross-room thread reference: The thread ID might be from a different room    and the backend is looking in the wrong room's directory</li> <li>Race condition: Thread creation succeeded but async file write failed</li> <li>Storage path misconfiguration: Backend storage paths may be misconfigured    for this specific room</li> </ol>"},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#backend-investigation-needed","title":"Backend Investigation Needed","text":"<ol> <li>Check the backend logs for the full stack trace when this error occurs</li> <li>Verify the storage path structure for room \"gitea\"</li> <li>Confirm the thread <code>82d06514-04d8-4131-bec6-f08012275ea6</code> exists and has    associated run data</li> <li>Check if the error is reproducible with other threads in the gitea room</li> </ol>"},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#frontend-handling","title":"Frontend Handling","text":"<p>The frontend correctly displays the error via <code>ErrorDisplay</code> widget. The error flows through:</p> <pre><code>ThreadMessageCache.getMessages()\n  -&gt; SoliplexApi.getThreadMessages()\n  -&gt; HttpTransport.request()\n  -&gt; Backend returns 500 with error message\n  -&gt; ApiException thrown\n  -&gt; MessageFetchException wrapper\n  -&gt; allMessagesProvider error state\n  -&gt; MessageList shows ErrorDisplay with Retry button\n</code></pre>"},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#priority","title":"Priority","text":"<p>Medium - The app handles the error gracefully but users cannot view thread history in affected rooms.</p>"},{"location":"flutter/planning/bugs/backend-errno-2-thread-messages/#date-reported","title":"Date Reported","text":"<p>2025-01-07</p>"},{"location":"flutter/planning/refactoring/http-layer-naming/","title":"Refactor HTTP Layer Naming","text":""},{"location":"flutter/planning/refactoring/http-layer-naming/#summary","title":"Summary","text":"<p>Rename HTTP layer classes for clarity:</p> <ol> <li>Use <code>*Client</code> for the HTTP client hierarchy (interface + implementations)</li> <li>Reserve <code>*Adapter</code> only for true Adapter pattern usage (bridging interfaces)</li> </ol>"},{"location":"flutter/planning/refactoring/http-layer-naming/#naming-changes","title":"Naming Changes","text":"Old Name New Name File Rename <code>HttpClientAdapter</code> <code>SoliplexHttpClient</code> <code>http_client_adapter.dart</code> \u2192 <code>soliplex_http_client.dart</code> <code>AdapterResponse</code> <code>HttpResponse</code> <code>adapter_response.dart</code> \u2192 <code>http_response.dart</code> <code>DartHttpAdapter</code> <code>DartHttpClient</code> <code>dart_http_adapter.dart</code> \u2192 <code>dart_http_client.dart</code> <code>ObservableHttpAdapter</code> <code>ObservableHttpClient</code> <code>observable_http_adapter.dart</code> \u2192 <code>observable_http_client.dart</code> <code>AdapterHttpClient</code> <code>HttpClientAdapter</code> <code>adapter_http_client.dart</code> \u2192 <code>http_client_adapter.dart</code> <code>CupertinoHttpAdapter</code> <code>CupertinoHttpClient</code> <code>cupertino_http_adapter.dart</code> \u2192 <code>cupertino_http_client.dart</code> <code>createPlatformAdapter</code> <code>createPlatformClient</code> (same file) <p>Parameter/variable renames:</p> Context Old New <code>HttpTransport({required ... adapter})</code> <code>adapter</code> <code>client</code> <code>ObservableHttpClient({required ... adapter})</code> <code>adapter</code> <code>client</code> <code>HttpClientAdapter({required ... adapter})</code> <code>adapter</code> <code>client</code> <code>observableAdapterProvider</code> - <code>observableClientProvider</code> <code>httpAdapterProvider</code> - <code>soliplexHttpClientProvider</code>"},{"location":"flutter/planning/refactoring/http-layer-naming/#architecture","title":"Architecture","text":""},{"location":"flutter/planning/refactoring/http-layer-naming/#class-hierarchy","title":"Class Hierarchy","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     SoliplexHttpClient                              \u2502\n\u2502                        (interface)                                  \u2502\n\u2502  Methods: request(), requestStream(), close()                       \u2502\n\u2502  Returns: HttpResponse                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u25b2\n                              \u2502 implements\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502                   \u2502                   \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   DartHttpClient  \u2502 \u2502 Cupertino-    \u2502 \u2502 ObservableHttp-   \u2502\n\u2502                   \u2502 \u2502 HttpClient    \u2502 \u2502 Client            \u2502\n\u2502 Default impl      \u2502 \u2502 iOS/macOS     \u2502 \u2502 Decorator         \u2502\n\u2502 using package:http\u2502 \u2502 NSURLSession  \u2502 \u2502 wraps any client  \u2502\n\u2502                   \u2502 \u2502               \u2502 \u2502 + observers       \u2502\n\u2502 [soliplex_client] \u2502 \u2502 [soliplex_    \u2502 \u2502 [soliplex_client] \u2502\n\u2502                   \u2502 \u2502 client_native]\u2502 \u2502                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/refactoring/http-layer-naming/#provider-dependency-graph-flutter-app","title":"Provider Dependency Graph (Flutter App)","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         Flutter App                                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                     \u2502\n\u2502  configProvider \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                  \u2502\n\u2502       \u2502                          \u2502                                  \u2502\n\u2502       \u25bc                          \u25bc                                  \u2502\n\u2502  urlBuilderProvider         observableClientProvider                \u2502\n\u2502       \u2502                          \u2502                                  \u2502\n\u2502       \u2502                          \u2502 Creates: ObservableHttpClient    \u2502\n\u2502       \u2502                          \u2502   wrapping createPlatformClient()\u2502\n\u2502       \u2502                          \u2502   with HttpLogNotifier observer  \u2502\n\u2502       \u2502                          \u2502                                  \u2502\n\u2502       \u2502              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                      \u2502\n\u2502       \u2502              \u2502                       \u2502                      \u2502\n\u2502       \u2502              \u25bc                       \u25bc                      \u2502\n\u2502       \u2502    httpTransportProvider    soliplexHttpClientProvider      \u2502\n\u2502       \u2502              \u2502                       \u2502                      \u2502\n\u2502       \u2502              \u2502 Creates:              \u2502 Alias: exposes       \u2502\n\u2502       \u2502              \u2502 HttpTransport         \u2502 SoliplexHttpClient   \u2502\n\u2502       \u2502              \u2502                       \u2502 interface for SSE    \u2502\n\u2502       \u2502              \u2502                       \u2502                      \u2502\n\u2502       \u25bc              \u25bc                       \u25bc                      \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        httpClientProvider              \u2502\n\u2502  \u2502      apiProvider        \u2502                 \u2502                      \u2502\n\u2502  \u2502                         \u2502                 \u2502 Creates:             \u2502\n\u2502  \u2502  Creates: SoliplexApi   \u2502                 \u2502 HttpClientAdapter    \u2502\n\u2502  \u2502  (REST API client)      \u2502                 \u2502 (bridges to          \u2502\n\u2502  \u2502                         \u2502                 \u2502  http.Client)        \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                 \u2502                      \u2502\n\u2502                                              \u25bc                      \u2502\n\u2502                                     agUiClientProvider              \u2502\n\u2502                                              \u2502                      \u2502\n\u2502                                              \u2502 Creates: AgUiClient  \u2502\n\u2502                                              \u2502 (SSE streaming)      \u2502\n\u2502                                              \u25bc                      \u2502\n\u2502                                     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510             \u2502\n\u2502                                     \u2502 ActiveRun-      \u2502             \u2502\n\u2502                                     \u2502 Notifier        \u2502             \u2502\n\u2502                                     \u2502 (orchestrates   \u2502             \u2502\n\u2502                                     \u2502  AG-UI runs)    \u2502             \u2502\n\u2502                                     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Note: <code>soliplexHttpClientProvider</code> is an alias for <code>observableClientProvider</code>. Both return the same <code>ObservableHttpClient</code> instance. The alias exists to provide a semantically clear name when code needs the <code>SoliplexHttpClient</code> interface (e.g., for SSE streaming) rather than knowing about the observable wrapper.</p>"},{"location":"flutter/planning/refactoring/http-layer-naming/#request-flow-rest-api","title":"Request Flow: REST API","text":"<pre><code>Widget calls api.getRooms()\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   SoliplexApi   \u2502  Constructs URL, calls transport\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  HttpTransport  \u2502  JSON encode, exception mapping, CancelToken\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 ObservableHttpClient\u2502  Notifies HttpLogNotifier (onRequest/onResponse)\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  DartHttpClient or  \u2502  Platform-specific HTTP execution\n\u2502  CupertinoHttpClient\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n    HttpResponse\n    (statusCode, bodyBytes, headers)\n</code></pre>"},{"location":"flutter/planning/refactoring/http-layer-naming/#request-flow-ag-ui-streaming","title":"Request Flow: AG-UI Streaming","text":"<pre><code>ActiveRunNotifier starts run\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   AgUiClient    \u2502  External library, needs http.Client\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  HttpClientAdapter  \u2502  TRUE ADAPTER: bridges SoliplexHttpClient \u2192 http.Client\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 ObservableHttpClient\u2502  Notifies HttpLogNotifier (onStreamStart/onStreamEnd)\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  DartHttpClient or  \u2502  Platform-specific SSE stream\n\u2502  CupertinoHttpClient\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n    Stream&lt;List&lt;int&gt;&gt;\n    (byte chunks for SSE parsing)\n</code></pre>"},{"location":"flutter/planning/refactoring/http-layer-naming/#package-boundaries","title":"Package Boundaries","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    soliplex_frontend (Flutter)                      \u2502\n\u2502                                                                     \u2502\n\u2502  lib/core/providers/api_provider.dart                               \u2502\n\u2502    - observableClientProvider                                       \u2502\n\u2502    - httpTransportProvider                                          \u2502\n\u2502    - apiProvider                                                    \u2502\n\u2502    - soliplexHttpClientProvider                                     \u2502\n\u2502    - httpClientProvider                                             \u2502\n\u2502    - agUiClientProvider                                             \u2502\n\u2502                                                                     \u2502\n\u2502  Depends on: soliplex_client, soliplex_client_native                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u2502 imports both packages\n         \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502                                 \u2502\n    \u25bc                                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 soliplex_client           \u2502  \u2502 soliplex_client_native               \u2502\n\u2502 (Pure Dart)               \u2502  \u2502 (Platform-specific)                  \u2502\n\u2502                           \u2502  \u2502                                      \u2502\n\u2502 lib/src/http/             \u2502  \u2502 lib/src/clients/                     \u2502\n\u2502  - soliplex_http_client   \u2502\u25c0\u2500\u2524  - cupertino_http_client             \u2502\n\u2502    (interface)            \u2502  \u2502    (iOS/macOS NSURLSession)          \u2502\n\u2502  - http_response          \u2502  \u2502                                      \u2502\n\u2502  - dart_http_client       \u2502  \u2502 lib/src/platform/                    \u2502\n\u2502  - observable_http_client \u2502  \u2502  - create_platform_client            \u2502\n\u2502  - http_client_adapter    \u2502  \u2502    (factory function)                \u2502\n\u2502  - http_transport         \u2502  \u2502                                      \u2502\n\u2502  - http_observer          \u2502  \u2502 Depends on:                          \u2502\n\u2502                           \u2502  \u2502  - soliplex_client (for interface)   \u2502\n\u2502 lib/src/api/              \u2502  \u2502  - cupertino_http                    \u2502\n\u2502  - soliplex_api           \u2502  \u2502                                      \u2502\n\u2502                           \u2502  \u2502                                      \u2502\n\u2502 No Flutter dependency     \u2502  \u2502                                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/refactoring/http-layer-naming/#why-adapter-only-for-httpclientadapter","title":"Why \"Adapter\" Only for HttpClientAdapter","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Adapter Pattern (GoF)                          \u2502\n\u2502                                                                    \u2502\n\u2502  \"Convert the interface of a class into another interface         \u2502\n\u2502   clients expect.\"                                                 \u2502\n\u2502                                                                    \u2502\n\u2502  HttpClientAdapter is the ONLY true adapter:                       \u2502\n\u2502                                                                    \u2502\n\u2502    AgUiClient \u2500\u2500expects\u2500\u2500\u25b6 http.Client                             \u2502\n\u2502                               \u25b2                                    \u2502\n\u2502                               \u2502 extends                            \u2502\n\u2502                    HttpClientAdapter                               \u2502\n\u2502                               \u2502                                    \u2502\n\u2502                               \u2502 delegates to                       \u2502\n\u2502                               \u25bc                                    \u2502\n\u2502                    SoliplexHttpClient                              \u2502\n\u2502                                                                    \u2502\n\u2502  It bridges OUR interface (SoliplexHttpClient)                     \u2502\n\u2502  to THEIR interface (http.Client from package:http)                \u2502\n\u2502                                                                    \u2502\n\u2502  Other classes are NOT adapters:                                   \u2502\n\u2502    - DartHttpClient: implementation, not adapter                   \u2502\n\u2502    - CupertinoHttpClient: implementation, not adapter              \u2502\n\u2502    - ObservableHttpClient: decorator pattern, not adapter          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/refactoring/http-layer-naming/#unified-http-observability","title":"Unified HTTP Observability","text":"<p>All HTTP traffic flows through <code>ObservableHttpClient</code>, regardless of:</p> <ul> <li>Request type: REST API or AG-UI SSE streaming</li> <li>Platform: iOS, macOS, Android, Windows, Linux, or Web</li> <li>Native client: <code>CupertinoHttpClient</code> or <code>DartHttpClient</code></li> </ul> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  Single Point of Instantiation                     \u2502\n\u2502                                                                    \u2502\n\u2502  observableClientProvider (api_provider.dart:18)                   \u2502\n\u2502      \u2502                                                             \u2502\n\u2502      \u2502  final baseClient = createPlatformClient();                 \u2502\n\u2502      \u2502  final observable = ObservableHttpClient(                   \u2502\n\u2502      \u2502    client: baseClient,      // Dart or Cupertino            \u2502\n\u2502      \u2502    observers: [observer],   // HttpLogNotifier              \u2502\n\u2502      \u2502  );                                                         \u2502\n\u2502      \u2502                                                             \u2502\n\u2502      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502                         \u2502                              \u2502           \u2502\n\u2502                         \u25bc                              \u25bc           \u2502\n\u2502              httpTransportProvider          soliplexHttpClientProvider\n\u2502                         \u2502                              \u2502           \u2502\n\u2502                         \u25bc                              \u25bc           \u2502\n\u2502                   apiProvider                  httpClientProvider  \u2502\n\u2502                    (REST)                       (bridges to        \u2502\n\u2502                         \u2502                       http.Client)       \u2502\n\u2502                         \u2502                              \u2502           \u2502\n\u2502                         \u2502                              \u25bc           \u2502\n\u2502                         \u2502                      agUiClientProvider  \u2502\n\u2502                         \u2502                         (SSE)            \u2502\n\u2502                         \u2502                              \u2502           \u2502\n\u2502                         \u25bc                              \u25bc           \u2502\n\u2502                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u2502\n\u2502                    \u2502     HttpLogNotifier sees ALL traffic   \u2502      \u2502\n\u2502                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Why this matters:</p> <ul> <li>No bypass paths: <code>createPlatformClient()</code> is called only once, inside   <code>observableClientProvider</code>. No code directly instantiates <code>DartHttpClient</code>   or <code>CupertinoHttpClient</code>.</li> <li>Unified logging: <code>HttpLogNotifier</code> receives callbacks for every HTTP   request, response, error, and stream event across the entire application.</li> <li>Platform-agnostic monitoring: The same observer interface works whether   the app runs on iOS (Cupertino) or any other platform (Dart HTTP).</li> </ul>"},{"location":"flutter/planning/refactoring/navigation-refactoring/","title":"Navigation Refactoring Plan","text":""},{"location":"flutter/planning/refactoring/navigation-refactoring/#summary","title":"Summary","text":"<p>Consolidate RoomScreen and ThreadScreen into a single RoomScreen with:</p> <ul> <li>Room dropdown in app bar (switch rooms)</li> <li>Collapsible thread list sidebar (toggle button)</li> <li>Chat view as main content</li> <li>HTTP inspector accessible from all screens via ShellRoute</li> <li>Last viewed thread per room persisted to SharedPreferences</li> <li>Thread selection via optional query parameter (bookmarkable)</li> <li>No transition animations (instant navigation)</li> <li>Full accessibility (Semantics, tooltips, labels on all interactive elements)</li> </ul>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#ui-requirements","title":"UI Requirements","text":""},{"location":"flutter/planning/refactoring/navigation-refactoring/#no-transition-animations","title":"No Transition Animations","text":"<p>All navigation and UI state changes must be instant with no animations:</p> <ul> <li>Route transitions: Use <code>GoRouter</code> with <code>pageBuilder</code> returning <code>NoTransitionPage</code></li> <li>Drawer open/close: Disable animation or use instant transition</li> <li>Sidebar collapse: Instant width change, no animation</li> </ul> <pre><code>// In app_router.dart - disable all route transitions\nGoRoute(\n  path: '/rooms/:roomId',\n  pageBuilder: (context, state) =&gt; NoTransitionPage(\n    child: RoomScreen(...),\n  ),\n),\n</code></pre>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#accessibility-requirements","title":"Accessibility Requirements","text":"<p>Interactive elements (buttons, icons) must have:</p> <ol> <li>Semantics wrapper with descriptive label</li> <li>Tooltip explaining the action</li> <li>Sufficient contrast (follows Material guidelines)</li> </ol> <p>Interactive elements table:</p> Element Tooltip Semantics Label Sidebar toggle \"Show threads\" / \"Hide threads\" \"Toggle thread list sidebar\" Room dropdown \"Switch to another room\" \"Room selector, current: {roomName}\" HTTP inspector icon \"Open HTTP traffic inspector\" \u2014 Settings icon \"Open settings\" \"Settings\" New conversation button \"Start a new conversation\" \"Create new thread\" Thread list item \"{threadName}\" \"Select thread: {threadName}\" Send button \"Send message\" \"Send message\" <p>Container regions (drawers, panels) need only Semantics labels for screen reader context \u2014 Tooltips don't apply since they're not directly tapped.</p> Region Semantics Label Navigation drawer \"Navigation drawer\" HTTP inspector panel \"HTTP traffic inspector panel\""},{"location":"flutter/planning/refactoring/navigation-refactoring/#findings-resolved","title":"Findings (Resolved)","text":"<ul> <li> <p>[x] FINDING-01: Mobile drawer animation - Decision: Keep animation.   Flutter's drawer slide animation (~300ms) is acceptable. The \"no animations\"   rule applies to route transitions and sidebar collapse, not drawer interactions.</p> </li> <li> <p>[x] FINDING-02: Room dropdown accessibility - Decision: Use DropdownMenu   (Material 3) instead of DropdownButton. Better built-in accessibility, less   maintenance, modern Flutter direction.</p> </li> <li> <p>[x] FINDING-03: Chat message accessibility - Decision: Defer to   implementation. Streaming accessibility is complex; test with real screen   reader during ChatPanel work and fix issues found.</p> </li> <li> <p>[x] FINDING-04: Loading states - Decision: Add note. Implementers must   wrap all CircularProgressIndicator widgets in Semantics with appropriate labels   (e.g., \"Loading rooms\", \"Loading threads\").</p> </li> </ul>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#route-structure","title":"Route Structure","text":"<pre><code>/                              -&gt; HomeScreen\n/rooms                         -&gt; RoomsScreen\n/rooms/:roomId                 -&gt; RoomScreen (last viewed or first thread)\n/rooms/:roomId?thread=xyz      -&gt; RoomScreen (specific thread selected)\n/rooms/:roomId/thread/:tid     -&gt; REDIRECT to /rooms/:roomId?thread=:tid\n/settings                      -&gt; SettingsScreen\n</code></pre> <p>Key change: Thread selection uses query parameter instead of path segment. This keeps URLs bookmarkable while consolidating to a single screen.</p> <p>Migration: Old <code>/rooms/:roomId/thread/:threadId</code> URLs redirect to the new query param format to avoid breaking existing bookmarks.</p>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#design-decision-query-parameter-vs-path-segment","title":"Design Decision: Query Parameter vs Path Segment","text":"<p>We chose query parameters (<code>/rooms/:roomId?thread=xyz</code>) over path segments (<code>/rooms/:roomId/thread/:threadId</code>) for thread selection.</p>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#rationale","title":"Rationale","text":"<p>Semantic fit: The consolidation changes the conceptual model. Threads are now selected within a room view (like sidebar tabs), not navigated to as separate pages. Query parameters are semantically appropriate for \"which view of this resource am I looking at?\" \u2014 similar to <code>/products?category=electronics</code>.</p> <p>Browser back button: With path segments, back would cycle through thread history. With query params, back leaves the room entirely. The latter matches user expectations when thread selection feels like \"filtering\" rather than \"navigating.\"</p> <p>Route simplicity: One route definition instead of two. The handler reads an optional query param rather than managing two separate routes that both render RoomScreen.</p> <p>Trade-off acknowledged: Path segments feel more \"RESTful\" and would be better if threads were truly independent resources for external linking or SEO. But in this UI, threads are sidebar selections within a room \u2014 the URL should reflect that mental model.</p>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#comparison","title":"Comparison","text":"Aspect Path Segment Query Parameter Mental model Navigate TO thread Select WITHIN room Back button Cycles through threads Leaves the room Route complexity Two routes + redirect One route Semantic fit Thread as page Thread as filter"},{"location":"flutter/planning/refactoring/navigation-refactoring/#architecture","title":"Architecture","text":""},{"location":"flutter/planning/refactoring/navigation-refactoring/#single-scaffold-via-appshell","title":"Single Scaffold via AppShell","text":"<p>Each route wraps its content in AppShell, which owns the only Scaffold. Screens provide body content only, not their own Scaffold.</p> <pre><code>GoRoute\n\u2514\u2500\u2500 AppShell(config, body)\n    \u2514\u2500\u2500 Scaffold (single, owns AppBar + endDrawer)\n        \u251c\u2500\u2500 appBar: Built from ShellConfig\n        \u251c\u2500\u2500 endDrawer: HttpInspectorPanel\n        \u251c\u2500\u2500 drawer: (mobile only) from ShellConfig\n        \u2514\u2500\u2500 body: Screen content\n</code></pre> <p>Why single Scaffold? Nested Scaffolds don't share drawers. If each screen had its own Scaffold, <code>Scaffold.of(context).openEndDrawer()</code> would find the inner Scaffold (which has no drawer) instead of AppShell's.</p>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#screen-types","title":"Screen Types","text":"<p>Static screens (HomeScreen, RoomsScreen, SettingsScreen): Wrapped in AppShell at the router level with static ShellConfig.</p> <p>Dynamic screens (RoomScreen): Build their own AppShell internally to provide dynamic ShellConfig (e.g., room dropdown, sidebar toggle).</p>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#design-decision-dynamic-screen-wrapping","title":"Design Decision: Dynamic Screen Wrapping","text":"<p>Decision: RoomScreen returns AppShell directly (Option A).</p> <p>Rationale: RoomScreen's ShellConfig depends on:</p> <ol> <li>Provider state (room dropdown needs roomsProvider)</li> <li>Local widget state (sidebar toggle needs <code>_sidebarCollapsed</code>)</li> </ol> <p>If the router wrapped RoomScreen, it couldn't access the sidebar collapse state which lives inside RoomScreen's StatefulWidget. Lifting that state to a provider feels like overkill for UI-only state.</p> <p>Since RoomScreen is the only dynamic screen, the inconsistency with static screens (which are router-wrapped) is acceptable.</p> <p>Migration path if needed later:</p> <p>If a second dynamic screen emerges and the pattern feels wrong:</p> <ol> <li>Extract sidebar state to a provider:</li> </ol> <pre><code>final sidebarCollapsedProvider = StateProvider&lt;bool&gt;((ref) =&gt; false);\n</code></pre> <ol> <li>Change RoomScreen to return body content only (not AppShell)</li> <li>Move config building to router (reads from providers)</li> <li>Update router to wrap RoomScreen in AppShell</li> </ol> <p>This is a mechanical refactor. AppShell is already a separate widget and ShellConfig is pure data, so no structural changes needed.</p>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#roomscreen-layout","title":"RoomScreen Layout","text":"<p>Desktop (&gt;=600px):</p> <pre><code>+------------------------------------------+\n|  AppBar: [=] [Room v]         [bug] [gear]|\n+------------------------------------------+\n| Thread    |                              |\n| List      |      ChatPanel               |\n| (toggle)  |                              |\n+------------------------------------------+\n</code></pre> <p>Mobile (&lt;600px):</p> <pre><code>+------------------------------------------+\n|  AppBar: [=] [Room v]         [bug] [gear]|\n+------------------------------------------+\n|                                          |\n|           ChatPanel                      |\n|                                          |\n+------------------------------------------+\n+ Drawer (leading): HistoryPanel\n</code></pre> <ul> <li>Desktop: Sidebar toggle button collapses/expands thread list</li> <li>Mobile: Hamburger menu opens drawer with thread list</li> </ul>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#key-behaviors","title":"Key Behaviors","text":""},{"location":"flutter/planning/refactoring/navigation-refactoring/#thread-selection-on-room-entry","title":"Thread Selection on Room Entry","text":"<p>Async flow with validation:</p> <pre><code>Future&lt;void&gt; initializeThreadSelection(String roomId, String? queryThread) async {\n  final threads = await ref.read(threadsProvider(roomId).future);\n\n  if (threads.isEmpty) {\n    // Show welcome/empty state\n    ref.read(threadSelectionProvider.notifier).clear();\n    return;\n  }\n\n  // 1. Check query param first\n  if (queryThread != null &amp;&amp; threads.any((t) =&gt; t.id == queryThread)) {\n    ref.read(threadSelectionProvider.notifier).select(queryThread);\n    await _saveLastViewed(roomId, queryThread);\n    return;\n  }\n\n  // 2. Try last viewed from SharedPreferences\n  final lastViewed = await _getLastViewed(roomId);\n  if (lastViewed != null &amp;&amp; threads.any((t) =&gt; t.id == lastViewed)) {\n    ref.read(threadSelectionProvider.notifier).select(lastViewed);\n    return;\n  }\n\n  // 3. Fall back to first thread\n  final firstThread = threads.first.id;\n  ref.read(threadSelectionProvider.notifier).select(firstThread);\n  await _saveLastViewed(roomId, firstThread);\n}\n</code></pre> <p>Key points:</p> <ul> <li>Query param takes precedence (enables deep linking)</li> <li>Validates thread still exists before selecting</li> <li>Falls back gracefully through the chain</li> </ul>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#sidebar-toggle","title":"Sidebar Toggle","text":"<ul> <li>Toggle button in app bar (desktop only)</li> <li>Collapse state in local widget state (resets on navigation - intentional YAGNI)</li> <li>Accessibility: <code>Semantics(label: 'Toggle thread list sidebar')</code></li> </ul>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#last-viewed-thread","title":"Last Viewed Thread","text":"<ul> <li>Stored per room in SharedPreferences</li> <li>Key: <code>lastViewedThread_{roomId}</code> -&gt; <code>threadId</code></li> <li>Updated on thread selection and thread creation</li> </ul>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#work-in-progress","title":"Work In Progress","text":""},{"location":"flutter/planning/refactoring/navigation-refactoring/#completed","title":"Completed","text":"<ul> <li>[x] Phase 1: AppShell Foundation</li> <li>[x] Phase 2: Last Viewed Thread Provider</li> <li>[x] Phase 3: Update Panels (HistoryPanel + ChatPanel persist last viewed)</li> <li>[x] Phase 4: Consolidate RoomScreen</li> </ul>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#current-status","title":"Current Status","text":"<p>Phase 4 complete. RoomScreen now consolidates the thread list and chat view:</p> <ul> <li>Responsive layout: Desktop sidebar + mobile drawer</li> <li>Async thread selection: query param \u2192 last viewed \u2192 first thread</li> <li>Sidebar toggle with accessibility (desktop only)</li> <li>Room dropdown with loading/error states</li> <li>Comprehensive test coverage (383 tests passing)</li> </ul>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#null-elimination-post-phase-4","title":"Null Elimination (Post Phase 4)","text":"<p>Refactored to eliminate null returns/assignments where feasible:</p> <p>Fixed:</p> Issue Solution <code>_withErrorHandling</code> returned <code>null</code> on failure Use <code>Result&lt;T&gt;</code> sealed class (<code>Ok</code>/<code>Err</code>) <code>lastViewedThreadProvider</code> returned <code>String?</code> Use <code>LastViewed</code> sealed class (<code>HasLastViewed</code>/<code>NoLastViewed</code>) <code>thread!.id</code> force unwrap in ChatPanel Restructured with <code>final effectiveThread</code> <code>error: (_, __)</code> discarding error info Added <code>debugPrint</code> logging <p>Unfixable (framework constraints):</p> Issue Reason <code>initialThreadId: String?</code> GoRouter query params are inherently nullable <code>ShellConfig</code> nullable fields Flutter Scaffold API requires nullable drawer/FAB <code>currentRoom?.name ?? 'none'</code> Room can be null when no room selected <p>New types added:</p> <ul> <li><code>lib/core/models/result.dart</code> - <code>Result&lt;T&gt;</code> with <code>Ok</code>/<code>Err</code> variants</li> <li><code>LastViewed</code> sealed class in <code>threads_provider.dart</code> with <code>HasLastViewed</code>/<code>NoLastViewed</code></li> </ul>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#implementation-phases","title":"Implementation Phases","text":""},{"location":"flutter/planning/refactoring/navigation-refactoring/#phase-1-appshell-foundation","title":"Phase 1: AppShell Foundation","text":"<ol> <li>Create <code>lib/shared/widgets/app_shell.dart</code>:</li> <li>Scaffold with endDrawer (HttpInspectorPanel)</li> <li>Inspector icon button in actions</li> <li>Passes child through</li> <li>Update <code>app_router.dart</code>:</li> <li>Wrap all routes in ShellRoute using AppShell</li> <li>Add redirect for <code>/rooms/:roomId/thread/:threadId</code> -&gt; query param</li> <li>Remove inspector code from ThreadScreen (will be deleted anyway)</li> <li>Add tests for ShellRoute and redirect</li> </ol>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#phase-2-last-viewed-thread-provider","title":"Phase 2: Last Viewed Thread Provider","text":"<ol> <li>Add to <code>threads_provider.dart</code>:</li> </ol> <pre><code>// Read: FutureProvider for observable data\nfinal lastViewedThreadProvider = FutureProvider.family&lt;String?, String&gt;(...);\n\n// Write: Plain functions for imperative commands\nFuture&lt;void&gt; setLastViewedThread(Ref ref, {required String roomId, required String threadId});\nFuture&lt;void&gt; clearLastViewedThread(Ref ref, String roomId);\n</code></pre> <p>Design note: Write operations are functions (not providers) because    FutureProvider is for observable data, not imperative commands. Functions    that take <code>Ref</code> can still invalidate providers for cache coherence.</p> <ol> <li>Add tests for provider (including stale thread handling)</li> </ol> <p>Testing note: Functions that accept <code>Ref</code> require test helper providers    to obtain a Ref in tests. This is a known limitation\u2014the indirection is    acceptable when localized to test files.</p>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#phase-3-update-panels","title":"Phase 3: Update Panels","text":"<ol> <li><code>history_panel.dart</code>:</li> <li>Call <code>setLastViewed</code> on thread selection</li> <li>Update URL with query param on selection</li> <li><code>chat_panel.dart</code>:</li> <li>Call <code>setLastViewed</code> when thread is created</li> <li>Update URL with query param after creation</li> </ol>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#phase-4-consolidate-roomscreen","title":"Phase 4: Consolidate RoomScreen","text":"<ol> <li>Rewrite <code>room_screen.dart</code>:</li> <li>Read <code>?thread=</code> query param on mount</li> <li>Implement async thread selection flow (see above)</li> <li>Desktop: Row with togglable HistoryPanel + ChatPanel</li> <li>Mobile: ChatPanel + leading Drawer with HistoryPanel</li> <li>Room dropdown with loading/error states</li> <li>~~Delete <code>thread_screen.dart</code> and its test~~ \u2014 \u2705 Already deleted</li> <li>Update all related tests</li> </ol>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#phase-5-polish","title":"Phase 5: Polish","text":"<ol> <li>Run <code>mcp__dart__analyze_files</code> (0 issues)</li> <li>Run <code>mcp__dart__dart_format</code></li> <li>Run <code>mcp__dart__run_tests</code> (all pass)</li> </ol>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#files-summary","title":"Files Summary","text":""},{"location":"flutter/planning/refactoring/navigation-refactoring/#create","title":"Create","text":"File Purpose <code>lib/shared/widgets/app_shell.dart</code> Single Scaffold shell with inspector <code>lib/shared/widgets/shell_config.dart</code> Shell configuration for screens"},{"location":"flutter/planning/refactoring/navigation-refactoring/#modify","title":"Modify","text":"File Change <code>lib/core/router/app_router.dart</code> ShellRoute with AppShell, NoTransitionPage <code>lib/core/providers/threads_provider.dart</code> Add LastViewedThreadNotifier <code>lib/features/room/room_screen.dart</code> Complete rewrite, no Scaffold <code>lib/features/history/history_panel.dart</code> Track last viewed, update URL <code>lib/features/chat/chat_panel.dart</code> Track last viewed on create <code>lib/features/home/home_screen.dart</code> Remove Scaffold, return body + config <code>lib/features/rooms/rooms_screen.dart</code> Remove Scaffold, return body + config <code>lib/features/settings/settings_screen.dart</code> Remove Scaffold, return body + config"},{"location":"flutter/planning/refactoring/navigation-refactoring/#delete","title":"Delete","text":"File Status ~~<code>lib/features/thread/thread_screen.dart</code>~~ \u2705 Deleted ~~<code>test/features/thread/thread_screen_test.dart</code>~~ \u2705 Deleted"},{"location":"flutter/planning/refactoring/navigation-refactoring/#code-snippets","title":"Code Snippets","text":""},{"location":"flutter/planning/refactoring/navigation-refactoring/#shellconfig","title":"ShellConfig","text":"<pre><code>/// Configuration for AppShell's Scaffold (AppBar, drawer, FAB).\n@immutable\nclass ShellConfig {\n  const ShellConfig({\n    this.title,\n    this.leading,\n    this.actions = const [],\n    this.drawer,\n    this.floatingActionButton,\n  });\n\n  final Widget? title;\n  final Widget? leading;\n  final List&lt;Widget&gt; actions;\n  final Widget? drawer; // For mobile drawer (e.g., thread list)\n  final Widget? floatingActionButton;\n}\n</code></pre>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#appshell-single-scaffold-architecture","title":"AppShell (Single Scaffold Architecture)","text":"<pre><code>class AppShell extends StatelessWidget {\n  const AppShell({\n    required this.config,\n    required this.body,\n    super.key,\n  });\n\n  final ShellConfig config;\n  final Widget body;\n\n  @override\n  Widget build(BuildContext context) {\n    return Scaffold(\n      appBar: AppBar(\n        leading: config.leading,\n        title: config.title,\n        actions: [\n          ...config.actions,\n          const _InspectorButton(),\n        ],\n      ),\n      drawer: config.drawer != null\n          ? Semantics(\n              label: 'Navigation drawer',\n              child: config.drawer,\n            )\n          : null,\n      endDrawer: Semantics(\n        label: 'HTTP traffic inspector panel',\n        child: const SizedBox(\n          width: 400,\n          child: Drawer(child: HttpInspectorPanel()),\n        ),\n      ),\n      body: body,\n    );\n  }\n}\n\n/// Button that opens the HTTP inspector drawer.\n///\n/// Separate widget class ensures build() provides the correct context\n/// for Scaffold.of() to find the Scaffold we just built.\n@immutable\nclass _InspectorButton extends StatelessWidget {\n  const _InspectorButton();\n\n  @override\n  Widget build(BuildContext context) {\n    return Tooltip(\n      message: 'Open HTTP traffic inspector',\n      child: IconButton(\n        icon: const Icon(Icons.bug_report),\n        onPressed: () =&gt; Scaffold.of(context).openEndDrawer(),\n      ),\n    );\n  }\n}\n</code></pre>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#router-setup-no-transitions","title":"Router Setup (No Transitions)","text":"<p>Each route wraps its screen in AppShell with appropriate config:</p> <pre><code>GoRouter(\n  initialLocation: '/',\n  routes: [\n    GoRoute(\n      path: '/',\n      pageBuilder: (_, __) =&gt; NoTransitionPage(\n        child: AppShell(\n          config: const ShellConfig(title: Text('Home')),\n          body: const HomeScreen(),\n        ),\n      ),\n    ),\n    GoRoute(\n      path: '/rooms',\n      pageBuilder: (_, __) =&gt; NoTransitionPage(\n        child: AppShell(\n          config: const ShellConfig(title: Text('Rooms')),\n          body: const RoomsScreen(),\n        ),\n      ),\n    ),\n    GoRoute(\n      path: '/rooms/:roomId',\n      pageBuilder: (context, state) {\n        final roomId = state.pathParameters['roomId']!;\n        final threadId = state.uri.queryParameters['thread'];\n        return NoTransitionPage(\n          child: RoomScreen(roomId: roomId, initialThreadId: threadId),\n          // RoomScreen builds its own AppShell with dynamic config\n        );\n      },\n    ),\n    // Migration redirect\n    GoRoute(\n      path: '/rooms/:roomId/thread/:threadId',\n      redirect: (context, state) {\n        final roomId = state.pathParameters['roomId']!;\n        final threadId = state.pathParameters['threadId']!;\n        return '/rooms/$roomId?thread=$threadId';\n      },\n    ),\n    GoRoute(\n      path: '/settings',\n      pageBuilder: (_, __) =&gt; NoTransitionPage(\n        child: AppShell(\n          config: const ShellConfig(title: Text('Settings')),\n          body: const SettingsScreen(),\n        ),\n      ),\n    ),\n  ],\n  errorBuilder: (context, state) =&gt; AppShell(\n    config: const ShellConfig(title: Text('Error')),\n    body: // ... error content\n  ),\n)\n</code></pre>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#room-dropdown-with-async-handling-and-accessibility","title":"Room Dropdown with Async Handling and Accessibility","text":"<p>Uses Material 3 <code>DropdownMenu</code> for better built-in accessibility.</p> <pre><code>Consumer(\n  builder: (context, ref, _) {\n    final roomsAsync = ref.watch(roomsProvider);\n    final currentRoom = ref.watch(currentRoomProvider);\n    return roomsAsync.when(\n      data: (rooms) =&gt; Semantics(\n        label: 'Room selector, current: ${currentRoom?.name ?? 'none'}',\n        child: Tooltip(\n          message: 'Switch to another room',\n          child: DropdownMenu&lt;String&gt;(\n            initialSelection: currentRoom?.id,\n            dropdownMenuEntries: rooms\n                .map((r) =&gt; DropdownMenuEntry(value: r.id, label: r.name))\n                .toList(),\n            onSelected: (id) {\n              if (id != null) context.go('/rooms/$id');\n            },\n          ),\n        ),\n      ),\n      loading: () =&gt; Semantics(\n        label: 'Loading rooms',\n        child: const SizedBox(\n          width: 24,\n          height: 24,\n          child: CircularProgressIndicator(strokeWidth: 2),\n        ),\n      ),\n      error: (_, __) =&gt; Semantics(\n        label: 'Error loading rooms',\n        child: Tooltip(\n          message: 'Failed to load rooms',\n          child: const Icon(Icons.error_outline),\n        ),\n      ),\n    );\n  },\n),\n</code></pre>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#sidebar-toggle-with-accessibility","title":"Sidebar Toggle with Accessibility","text":"<pre><code>// Desktop only - check screen width first\nif (isDesktop)\n  Semantics(\n    label: _sidebarCollapsed\n        ? 'Show thread list sidebar'\n        : 'Hide thread list sidebar',\n    child: IconButton(\n      icon: Icon(_sidebarCollapsed ? Icons.menu : Icons.menu_open),\n      tooltip: _sidebarCollapsed ? 'Show threads' : 'Hide threads',\n      onPressed: () =&gt; setState(() =&gt; _sidebarCollapsed = !_sidebarCollapsed),\n    ),\n  ),\n</code></pre>"},{"location":"flutter/planning/refactoring/navigation-refactoring/#test-cases","title":"Test Cases","text":""},{"location":"flutter/planning/refactoring/navigation-refactoring/#thread-restoration-tests","title":"Thread Restoration Tests","text":"<pre><code>group('Thread selection on room entry', () {\n  test('selects thread from query param when valid', ...);\n  test('ignores query param when thread does not exist', ...);\n  test('falls back to last viewed when no query param', ...);\n  test('ignores last viewed when thread no longer exists', ...);\n  test('selects first thread when no query param and no last viewed', ...);\n  test('shows empty state when room has no threads', ...);\n});\n\ngroup('URL migration', () {\n  test('redirects /rooms/abc/thread/xyz to /rooms/abc?thread=xyz', ...);\n});\n\ngroup('ShellRoute inspector', () {\n  test('inspector drawer accessible from all screens', ...);\n  test('inspector icon visible in app bar', ...);\n});\n</code></pre>"},{"location":"flutter/planning/refactoring/null-removal/","title":"Null Removal Opportunities","text":"<p>Identified nullable types that could be replaced with non-nullable alternatives.</p>"},{"location":"flutter/planning/refactoring/null-removal/#review-status","title":"Review Status","text":"<p>Reviewed by blacksmith and sentinel agents. Most initially identified candidates should remain nullable - they represent semantically meaningful absence.</p>"},{"location":"flutter/planning/refactoring/null-removal/#actionable-items","title":"Actionable Items","text":""},{"location":"flutter/planning/refactoring/null-removal/#http_event_groupdart-force-unwraps-medium-priority","title":"<code>http_event_group.dart</code> - Force Unwraps (Medium Priority)","text":"<p>File: <code>lib/features/inspector/models/http_event_group.dart</code></p> <p>Current: 5 nullable event fields with force unwraps (<code>!</code>)</p> <pre><code>class HttpEventGroup {\n  final HttpRequestEvent? request;\n  final HttpResponseEvent? response;\n  final HttpErrorEvent? error;\n  final HttpStreamStartEvent? streamStart;\n  final HttpStreamEndEvent? streamEnd;\n\n  String get method {\n    if (request != null) return request!.method;  // force unwrap\n    // ...\n  }\n\n  String get statusDescription {\n    return switch (status) {\n      HttpEventStatus.success =&gt; 'status ${response!.statusCode}',  // unwrap\n      // ...\n    };\n  }\n}\n</code></pre> <p>Fix - Pattern Guards:</p> <pre><code>String get statusDescription {\n  return switch (status) {\n    HttpEventStatus.success when response case HttpResponseEvent(:final statusCode)\n      =&gt; 'success, status $statusCode',\n    HttpEventStatus.clientError when response case HttpResponseEvent(:final statusCode)\n      =&gt; 'client error, status $statusCode',\n    _ =&gt; '${status.name}',\n  };\n}\n</code></pre> <p>Pattern guards eliminate force unwraps while keeping the nullable fields (which are semantically correct - events arrive asynchronously and may not all be present).</p>"},{"location":"flutter/planning/refactoring/null-removal/#keep-as-is-semantically-correct","title":"Keep As-Is (Semantically Correct)","text":"File Field Reason <code>auth_flow.dart:10</code> <code>refreshToken</code> Optional per OAuth 2.0 spec (RFC 6749 Section 4.1.4). Null vs empty string distinction needed for debugging auth issues. <code>auth_state.dart:37</code> <code>idToken</code> Required for OIDC logout <code>loading_indicator.dart:7</code> <code>message</code> Null means \"show no message\" (spinner only). Default would change behavior - always showing text. <code>async_value_handler.dart:46-47</code> <code>onRetry</code>, <code>loading</code> Callbacks legitimately optional <code>shell_config.dart</code> <code>title</code>, <code>drawer</code>, <code>fab</code> UI configuration truly optional <code>error_display.dart</code> <code>onRetry</code> Not all errors support retry"},{"location":"flutter/planning/refactoring/null-removal/#review-notes","title":"Review Notes","text":""},{"location":"flutter/planning/refactoring/null-removal/#auth-tokens-rejected","title":"Auth Tokens (Rejected)","text":"<p>Original proposal: Default <code>refreshToken</code> and <code>idToken</code> to empty string.</p> <p>Why rejected (Sentinel - CAT II):</p> <ol> <li>Conflates \"IdP didn't provide token\" with \"token is empty string\"</li> <li>Masks errors instead of failing fast</li> <li>Empty string could reach security-sensitive code paths (e.g., <code>endSession()</code>)</li> <li>Loses debugging clarity - can't distinguish missing vs corrupted tokens</li> </ol> <p>The current nullable design provides better security properties. The localized fallback in <code>auth_notifier.dart:200</code> (<code>result.refreshToken ?? ''</code>) is appropriate for storage; making the model non-nullable propagates the lossy conversion everywhere.</p>"},{"location":"flutter/planning/refactoring/null-removal/#loadingindicator-rejected","title":"LoadingIndicator (Rejected)","text":"<p>Original proposal: Default <code>message</code> to <code>'Loading'</code>.</p> <p>Why rejected (Blacksmith):</p> <p>This changes behavior, not just null-safety:</p> <ul> <li>Current: <code>LoadingIndicator()</code> shows spinner only</li> <li>Proposed: <code>LoadingIndicator()</code> shows spinner + \"Loading\" text</li> </ul> <p>The null is semantically meaningful - it distinguishes \"show no message\" from \"show default message\". Callers who want \"Loading\" displayed would pass it explicitly.</p>"},{"location":"flutter/planning/refactoring/null-removal/#httpeventgroup-sealed-class-rejected","title":"HttpEventGroup Sealed Class (Rejected)","text":"<p>Original proposal: Option B with <code>EventSlot&lt;T&gt;</code> sealed class.</p> <p>Why rejected (Blacksmith):</p> <p>Over-engineering for a binary present/absent distinction. The sealed class is isomorphic to <code>T?</code> - same two cases, more boilerplate. Pattern guards (Option A) are the right fix: safe, expressive, no added abstraction.</p>"},{"location":"flutter/planning/refactoring/null-removal/#patterns-to-follow","title":"Patterns to Follow","text":"<p>Good examples already in codebase:</p> <ul> <li><code>room.dart:10</code> - <code>description = ''</code></li> <li><code>thread_info.dart:12-15</code> - <code>initialRunId = ''</code>, <code>name = ''</code></li> <li><code>run_info.dart:64-67</code> - <code>label = ''</code>, <code>metadata = const {}</code></li> <li><code>conversation.dart:134-136</code> - <code>messages = const []</code>, <code>status = const Idle()</code></li> </ul> <p>These work because empty string/collection is a valid domain value, not a sentinel for \"missing\". Apply this pattern only when the empty value is meaningful in the domain.</p>"},{"location":"flutter/planning/specs/client/","title":"Client","text":"<p>Pure Dart package (<code>soliplex_client</code>) for backend communication via HTTP and AG-UI protocols.</p>"},{"location":"flutter/planning/specs/client/#package-structure","title":"Package Structure","text":"Package Type Contents <code>soliplex_client</code> Pure Dart Core client, DartHttpClient, all business logic <code>soliplex_client_native</code> Flutter Native HTTP clients (v1.1) <pre><code>packages/\n\u251c\u2500\u2500 soliplex_client/           # Pure Dart - this spec\n\u2514\u2500\u2500 soliplex_client_native/    # Flutter - v1.1 scope\n</code></pre>"},{"location":"flutter/planning/specs/client/#architecture","title":"Architecture","text":""},{"location":"flutter/planning/specs/client/#network-stack","title":"Network Stack","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SoliplexApi                             \u2502  DM5 \u2713\n\u2502 - Room/Thread/Run CRUD operations       \u2502\n\u2502 - 8 methods: getRooms, getRoom,         \u2502\n\u2502   getThreads, getThread, createThread,  \u2502\n\u2502   deleteThread, createRun, getRun       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 HttpTransport                           \u2502  DM4 \u2713\n\u2502 - JSON serialization/deserialization    \u2502\n\u2502 - HTTP status \u2192 exception mapping       \u2502\n\u2502 - Request timeout handling              \u2502\n\u2502 - Streaming with cancellation           \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502   \u2502 Utils: UrlBuilder, CancelToken\u2502     \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502 uses SoliplexHttpClient\n                    \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 ObservableHttpClient (optional)         \u2502  DM3 \u2713\n\u2502 - Decorator implementing SoliplexHttpClient\n\u2502 - Notifies HttpObserver on all traffic  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502 wraps\n                    \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SoliplexHttpClient (interface)          \u2502  DM2 \u2713\n\u2502 - Abstract HTTP operations (DI)         \u2502\n\u2502 - Returns HttpResponse                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u25b2\n                    \u2502 implements\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                       \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502DartHttpClient \u2502  \u2502 soliplex_client_native:     \u2502\n\u2502 (default)     \u2502  \u2502 \u2713 CupertinoHttpClient       \u2502\n\u2502               \u2502  \u2502 - AndroidHttpClient planned \u2502\n\u2502 package:http  \u2502  \u2502 - WindowsHttpClient planned \u2502\n\u2502 All platforms \u2502  \u2502 - LinuxHttpClient planned   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502 - WebHttpClient planned     \u2502\n                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Usage patterns:</p> <pre><code>// Option 1: Direct client\nHttpTransport(client: DartHttpClient())\n\n// Option 2: With monitoring\nHttpTransport(\n  client: ObservableHttpClient(\n    client: DartHttpClient(),  // Wraps DartHttpClient\n    observers: [LoggingObserver()],\n  ),\n)\n</code></pre>"},{"location":"flutter/planning/specs/client/#session-management-planned","title":"Session Management (Planned)","text":"<pre><code>SoliplexClient (facade) \u2192 ConnectionManager \u2192 RoomSession \u2192 Thread (DM6 \u2713)\n     DM8 (planned)         DM7 (planned)      DM7 (planned)   (implemented)\n</code></pre> <p>Current: Apps use <code>Thread</code> directly with <code>HttpTransport</code> and <code>SoliplexApi</code>. Planned: Higher-level facade with automatic session management.</p>"},{"location":"flutter/planning/specs/client/#ag-ui-protocol-dm6","title":"AG-UI Protocol (DM6 \u2713)","text":"<p>Server-Sent Events (SSE) streaming with real-time event processing:</p> <ul> <li>19 Event Types: Run lifecycle, steps, text streaming, tool calls, state/activity updates</li> <li>Thread: Orchestrates SSE streams, manages buffers, executes tools</li> <li>TextMessageBuffer: Accumulates streaming text messages</li> <li>ToolCallBuffer: Tracks concurrent tool calls (start \u2192 args \u2192 end \u2192 result)</li> <li>ToolRegistry: Client-side tool registration and execution (supports fire-and-forget)</li> <li>JSON Patch: State delta operations (add, replace, remove)</li> <li>CancelToken Integration: Stream cancellation support</li> </ul>"},{"location":"flutter/planning/specs/client/#security","title":"Security","text":"<ul> <li>TLS 1.2+ required for all connections</li> <li>Tokens stored via platform secure storage (Keychain, Keystore, CredentialManager)</li> <li>No credentials in logs or error messages</li> <li>Input validation before network calls</li> <li>Certificate validation (native adapters can add pinning)</li> </ul>"},{"location":"flutter/planning/specs/client/#performance","title":"Performance","text":"<ul> <li>Connection keep-alive (HTTP/1.1 persistent, HTTP/2 multiplexing via native adapters)</li> <li>Request timeout: 30s default, configurable per-request</li> <li>SSE streaming with chunked transfer encoding</li> <li>Retry: 3x exponential backoff (500ms base) on 5xx/network errors</li> <li>Cancel in-flight requests via CancelToken</li> </ul>"},{"location":"flutter/planning/specs/client/#soliplexhttpclient-interface","title":"SoliplexHttpClient (Interface)","text":"<pre><code>abstract class SoliplexHttpClient {\n  Future&lt;HttpResponse&gt; request(String method, Uri uri, {Map&lt;String, String&gt;? headers, Object? body, Duration? timeout});\n  Stream&lt;List&lt;int&gt;&gt; requestStream(String method, Uri uri, {Map&lt;String, String&gt;? headers, Object? body});\n  void close();\n}\n</code></pre>"},{"location":"flutter/planning/specs/client/#platform-implementations","title":"Platform Implementations","text":"Client Package Platform Native Client Status <code>DartHttpClient</code> <code>soliplex_client</code> All package:http Done <code>CupertinoHttpClient</code> <code>soliplex_client_native</code> iOS/macOS NSURLSession Done <code>AndroidHttpClient</code> <code>soliplex_client_native</code> Android OkHttp Planned <code>WindowsHttpClient</code> <code>soliplex_client_native</code> Windows WinHTTP Planned <code>LinuxHttpClient</code> <code>soliplex_client_native</code> Linux libcurl Planned <code>WebHttpClient</code> <code>soliplex_client_native</code> Web fetch API Planned"},{"location":"flutter/planning/specs/client/#client-injection","title":"Client Injection","text":"<pre><code>// Default (pure Dart)\nfinal client = SoliplexClient(baseUrl: 'https://api.example.com');\n\n// With native client (v1.1)\nimport 'package:soliplex_client_native/soliplex_client_native.dart';\nfinal client = SoliplexClient(\n  baseUrl: 'https://api.example.com',\n  httpClient: createPlatformClient(),  // Auto-detects platform\n);\n</code></pre>"},{"location":"flutter/planning/specs/client/#error-handling","title":"Error Handling","text":"Exception Trigger Action <code>AuthException</code> 401, 403 Redirect to login <code>NetworkException</code> Timeout, unreachable Show retry <code>ApiException</code> 4xx, 5xx Show error <code>NotFoundException</code> 404 Go back <code>CancelledException</code> User cancelled Silent"},{"location":"flutter/planning/specs/client/#core-components","title":"Core Components","text":"Component Responsibility Status <code>HttpResponse</code> HTTP response model with status helpers Done <code>SoliplexHttpClient</code> Abstract HTTP operations interface (DI) Done <code>DartHttpClient</code> Default HTTP client using package:http Done <code>HttpObserver</code> Interface for observing HTTP activity Done <code>ObservableHttpClient</code> Decorator that notifies observers on all HTTP traffic Done <code>HttpTransport</code> JSON wrapper using SoliplexHttpClient Done <code>UrlBuilder</code> URL construction with normalization Done <code>CancelToken</code> Request cancellation Done <code>SoliplexApi</code> Room/Thread/Run CRUD operations Done <code>Thread</code> AG-UI SSE streaming, event processing Done <code>TextMessageBuffer</code> Text message streaming accumulation Done <code>ToolCallBuffer</code> Tool call buffering and tracking Done <code>ToolRegistry</code> Client-side tool registration and execution Done <code>ConnectionManager</code> Server switching, session pooling - <code>RoomSession</code> Per-room message state, event processing -"},{"location":"flutter/planning/specs/client/#data-models","title":"Data Models","text":"Model Fields <code>ChatMessage</code> id, user, type, text, thinkingText, isStreaming, toolCalls <code>ToolCallInfo</code> id, name, arguments, result, status <code>Room</code> id, name, config <code>ThreadInfo</code> id, createdAt, runs <code>RunInfo</code> id, threadId, status, createdAt, metadata"},{"location":"flutter/planning/specs/client/#api-methods-soliplexapi","title":"API Methods (SoliplexApi)","text":"Method Description <code>getRooms()</code> List rooms <code>getRoom(id)</code> Get room config <code>getThreads(roomId)</code> List threads <code>getThread(roomId, threadId)</code> Get thread + runs <code>createThread(roomId)</code> Create thread + initial run <code>deleteThread(roomId, threadId)</code> Delete thread <code>createRun(roomId, threadId)</code> Create run <code>getRun(roomId, threadId, runId)</code> Get run metadata"},{"location":"flutter/planning/specs/client/#implementation-phases","title":"Implementation Phases","text":"<p>Each phase maps to a Developer Milestone (DM). See <code>ROADMAP.md</code> for full milestone details.</p> Phase Goal Components Milestone Status 1 Models &amp; errors ChatMessage, Room, ThreadInfo, RunInfo, all exceptions DM1 Done 2a HTTP client SoliplexHttpClient (interface), DartHttpClient, HttpResponse DM2 Done 2b Network observer HttpObserver (interface), ObservableHttpClient (decorator) DM3 Done 2c HTTP transport HttpTransport, UrlBuilder, CancelToken DM4 Done 3 API layer SoliplexApi DM5 Done 4 AG-UI protocol Thread, TextMessageBuffer, ToolCallBuffer, ToolRegistry DM6 Done 5 Sessions ConnectionManager, RoomSession DM7 - 6 Facade SoliplexClient, chat() flow DM8 -"},{"location":"flutter/planning/specs/client/#file-structure","title":"File Structure","text":""},{"location":"flutter/planning/specs/client/#current-implementation-dm1-dm6-complete","title":"Current Implementation (DM1-DM6 Complete)","text":"<pre><code>packages/soliplex_client/\n\u251c\u2500\u2500 lib/\n\u2502   \u251c\u2500\u2500 soliplex_client.dart           # Public API exports\n\u2502   \u2514\u2500\u2500 src/\n\u2502       \u251c\u2500\u2500 api/                        # DM5 \u2713\n\u2502       \u2502   \u251c\u2500\u2500 api.dart                # Barrel export\n\u2502       \u2502   \u2514\u2500\u2500 soliplex_api.dart\n\u2502       \u251c\u2500\u2500 agui/                       # DM6 \u2713\n\u2502       \u2502   \u251c\u2500\u2500 agui.dart              # Barrel export\n\u2502       \u2502   \u251c\u2500\u2500 agui_event.dart\n\u2502       \u2502   \u251c\u2500\u2500 text_message_buffer.dart\n\u2502       \u2502   \u251c\u2500\u2500 thread.dart\n\u2502       \u2502   \u251c\u2500\u2500 tool_call_buffer.dart\n\u2502       \u2502   \u2514\u2500\u2500 tool_registry.dart\n\u2502       \u251c\u2500\u2500 errors/                     # DM1 \u2713\n\u2502       \u2502   \u251c\u2500\u2500 errors.dart             # Barrel export\n\u2502       \u2502   \u2514\u2500\u2500 exceptions.dart\n\u2502       \u251c\u2500\u2500 http/                       # DM2, DM3, DM4 \u2713\n\u2502       \u2502   \u251c\u2500\u2500 dart_http_client.dart\n\u2502       \u2502   \u251c\u2500\u2500 http.dart               # Barrel export\n\u2502       \u2502   \u251c\u2500\u2500 http_client_adapter.dart\n\u2502       \u2502   \u251c\u2500\u2500 http_observer.dart\n\u2502       \u2502   \u251c\u2500\u2500 http_response.dart\n\u2502       \u2502   \u251c\u2500\u2500 http_transport.dart\n\u2502       \u2502   \u251c\u2500\u2500 observable_http_client.dart\n\u2502       \u2502   \u2514\u2500\u2500 soliplex_http_client.dart\n\u2502       \u251c\u2500\u2500 models/                     # DM1 \u2713\n\u2502       \u2502   \u251c\u2500\u2500 chat_message.dart\n\u2502       \u2502   \u251c\u2500\u2500 models.dart             # Barrel export\n\u2502       \u2502   \u251c\u2500\u2500 room.dart\n\u2502       \u2502   \u251c\u2500\u2500 run_info.dart\n\u2502       \u2502   \u2514\u2500\u2500 thread_info.dart\n\u2502       \u2514\u2500\u2500 utils/                      # DM4 \u2713\n\u2502           \u251c\u2500\u2500 cancel_token.dart\n\u2502           \u251c\u2500\u2500 url_builder.dart\n\u2502           \u2514\u2500\u2500 utils.dart              # Barrel export\n\u251c\u2500\u2500 test/                               # Test coverage\n\u2502   \u251c\u2500\u2500 agui/\n\u2502   \u2502   \u251c\u2500\u2500 agui_event_test.dart\n\u2502   \u2502   \u251c\u2500\u2500 text_message_buffer_test.dart\n\u2502   \u2502   \u251c\u2500\u2500 thread_test.dart\n\u2502   \u2502   \u251c\u2500\u2500 tool_call_buffer_test.dart\n\u2502   \u2502   \u2514\u2500\u2500 tool_registry_test.dart\n\u2502   \u251c\u2500\u2500 api/\n\u2502   \u2502   \u2514\u2500\u2500 soliplex_api_test.dart\n\u2502   \u251c\u2500\u2500 errors/\n\u2502   \u2502   \u2514\u2500\u2500 exceptions_test.dart\n\u2502   \u251c\u2500\u2500 http/\n\u2502   \u2502   \u251c\u2500\u2500 dart_http_client_test.dart\n\u2502   \u2502   \u251c\u2500\u2500 http_client_adapter_test.dart\n\u2502   \u2502   \u251c\u2500\u2500 http_observer_test.dart\n\u2502   \u2502   \u251c\u2500\u2500 http_response_test.dart\n\u2502   \u2502   \u251c\u2500\u2500 http_transport_test.dart\n\u2502   \u2502   \u2514\u2500\u2500 observable_http_client_test.dart\n\u2502   \u251c\u2500\u2500 models/\n\u2502   \u2502   \u251c\u2500\u2500 chat_message_test.dart\n\u2502   \u2502   \u251c\u2500\u2500 room_test.dart\n\u2502   \u2502   \u251c\u2500\u2500 run_info_test.dart\n\u2502   \u2502   \u2514\u2500\u2500 thread_info_test.dart\n\u2502   \u2514\u2500\u2500 utils/\n\u2502       \u251c\u2500\u2500 cancel_token_test.dart\n\u2502       \u2514\u2500\u2500 url_builder_test.dart\n\u2514\u2500\u2500 pubspec.yaml\n</code></pre>"},{"location":"flutter/planning/specs/client/#planned-features-dm7-dm8","title":"Planned Features (DM7-DM8)","text":"<pre><code>packages/soliplex_client/lib/src/\n\u251c\u2500\u2500 session/                    # DM7 - NOT YET IMPLEMENTED\n\u2502   \u251c\u2500\u2500 connection_manager.dart # Server switching, session pooling\n\u2502   \u2514\u2500\u2500 room_session.dart       # Per-room message state\n\u2514\u2500\u2500 client/                     # DM8 - NOT YET IMPLEMENTED\n    \u2514\u2500\u2500 soliplex_client.dart    # High-level facade\n</code></pre>"},{"location":"flutter/planning/specs/client/#dependencies","title":"Dependencies","text":"<pre><code># soliplex_client/pubspec.yaml\nname: soliplex_client\ndescription: Pure Dart client for Soliplex backend\n\ndependencies:\n  http: ^1.2.0\n  meta: ^1.9.0\n\ndev_dependencies:\n  very_good_analysis: ^10.0.0\n  test: ^1.24.0\n  mocktail: ^1.0.0\n</code></pre> <p>Linting: Use <code>very_good_analysis</code>. Run <code>dart format .</code> and <code>dart analyze</code> before commits.</p> <p>Note: Native adapters are in separate <code>soliplex_client_native</code> package (v1.1 scope).</p>"},{"location":"flutter/planning/specs/core_frontend/","title":"Core Frontend","text":"<p>Flutter infrastructure using the <code>soliplex_client</code> package for backend interactions.</p>"},{"location":"flutter/planning/specs/core_frontend/#responsibilities","title":"Responsibilities","text":"<ul> <li>Authentication (login/logout via OIDC)</li> <li>Backend URL configuration</li> <li>Navigation (go_router)</li> <li>State management (Riverpod)</li> <li>AG-UI event processing</li> <li>Extensibility (config, registries)</li> </ul>"},{"location":"flutter/planning/specs/core_frontend/#platforms","title":"Platforms","text":"<p>Web (primary), iOS, Android, macOS, Windows, Linux</p>"},{"location":"flutter/planning/specs/core_frontend/#key-providers","title":"Key Providers","text":"Provider Type Purpose <code>configProvider</code> StateProvider App configuration <code>clientProvider</code> Provider SoliplexClient instance (AM7+) <code>authStateProvider</code> StateProvider Auth state (AM7+) <code>roomsProvider</code> FutureProvider Room list <code>currentRoomProvider</code> Provider Selected room (derived) <code>threadsProvider</code> FutureProvider.family Thread list for room <code>currentThreadProvider</code> Provider Selected thread (derived) <code>threadSelectionProvider</code> NotifierProvider Thread selection state <code>activeRunNotifierProvider</code> NotifierProvider AG-UI run state <code>threadMessageCacheProvider</code> NotifierProvider Message cache per thread <code>allMessagesProvider</code> FutureProvider Merged cached + streaming messages"},{"location":"flutter/planning/specs/core_frontend/#activerunstate","title":"ActiveRunState","text":"<pre><code>class ActiveRunState {\n  final String? threadId;\n  final RunStatus status;           // idle, running, finished, error\n  final List&lt;Message&gt; messages;\n  final String? error;\n  // Extensions for Detail/CurrentCanvas:\n  final List&lt;RawAgUiEvent&gt; rawEvents;\n  final List&lt;CanvasStateItem&gt; stateItems;\n  final CanvasActivity? currentActivity;\n}\n</code></pre>"},{"location":"flutter/planning/specs/core_frontend/#authentication-flow","title":"Authentication Flow","text":"<ol> <li>Open webview to <code>{baseUrl}/api/login/{provider}</code></li> <li>Server handles OIDC flow</li> <li>Callback returns token</li> <li>Store token securely</li> </ol>"},{"location":"flutter/planning/specs/core_frontend/#routes","title":"Routes","text":"Route Screen <code>/login</code> Login <code>/settings</code> Settings <code>/rooms</code> Room list <code>/rooms/:roomId</code> Room view <code>/rooms/:roomId/thread/:threadId</code> Thread view"},{"location":"flutter/planning/specs/core_frontend/#ag-ui-event-handling","title":"AG-UI Event Handling","text":"Event Action <code>RUN_STARTED</code> status = running <code>TEXT_MESSAGE_*</code> Update messages <code>TOOL_CALL_*</code> Update activity <code>STATE_SNAPSHOT/DELTA</code> Update stateItems <code>RUN_FINISHED/ERROR</code> status = finished/error"},{"location":"flutter/planning/specs/core_frontend/#error-handling","title":"Error Handling","text":"Exception Action <code>AuthException</code> Redirect to login <code>NetworkException</code> Show retry <code>NotFoundException</code> Go back <code>ApiException</code> Show error"},{"location":"flutter/planning/specs/core_frontend/#extensibility-level-2","title":"Extensibility (Level 2)","text":""},{"location":"flutter/planning/specs/core_frontend/#soliplexconfig","title":"SoliplexConfig","text":"<p>Configuration-driven customization at startup.</p> Field Purpose <code>appName</code> Display name <code>theme</code> ThemeData override <code>features</code> Enable/disable panels <code>routes</code> Initial route, hidden routes <code>defaultServers</code> Pre-configured backends"},{"location":"flutter/planning/specs/core_frontend/#soliplexregistry","title":"SoliplexRegistry","text":"<p>Runtime extension registration.</p> Registry Extensions <code>widgets</code> Custom GenUI widget builders <code>commands</code> Custom slash commands <code>panels</code> Custom panel definitions <code>routes</code> Custom route definitions"},{"location":"flutter/planning/specs/core_frontend/#key-abstractions","title":"Key Abstractions","text":"<pre><code>class SlashCommand {\n  final String name;\n  final String description;\n  final bool Function(List&lt;String&gt; args, RoomSession session) handler;\n}\n\nclass PanelDefinition {\n  final String id;\n  final String name;\n  final IconData icon;\n  final Widget Function(BuildContext, WidgetRef) builder;\n  final PanelPosition defaultPosition;\n}\n\nclass RouteDefinition {\n  final String path;\n  final Widget Function(BuildContext, GoRouterState) builder;\n}\n</code></pre>"},{"location":"flutter/planning/specs/core_frontend/#implementation-phases","title":"Implementation Phases","text":"Phase Goal Milestone Status 1 Project setup, navigation (NO AUTH) AM1 - 2 ActiveRunNotifier + extensions AM3 - 3 Authentication + Extensibility: SoliplexConfig, SoliplexRegistry AM7 - 4 Multi-room, extract to <code>soliplex_core</code> package AM8 -"},{"location":"flutter/planning/specs/core_frontend/#dependencies","title":"Dependencies","text":"<pre><code>dependencies:\n  soliplex_client:\n    path: packages/soliplex_client    # Or published version\n  flutter_riverpod: ^2.5.0\n  go_router: ^14.0.0\n  flutter_secure_storage: ^9.0.0\n  # Optional for native HTTP adapters (v1.1):\n  # soliplex_client_native: ^1.0.0\n\ndev_dependencies:\n  very_good_analysis: ^10.0.0\n  flutter_test:\n    sdk: flutter\n  mocktail: ^1.0.0\n</code></pre> <p>Linting: Use <code>very_good_analysis</code>. Run <code>flutter analyze</code> and <code>dart format .</code> before commits.</p>"},{"location":"flutter/planning/specs/external_backend_service/","title":"Backend API Reference","text":"<p>Base URL: <code>http://localhost:8000</code></p> <p>All authenticated endpoints use <code>Authorization: Bearer &lt;token&gt;</code>.</p>"},{"location":"flutter/planning/specs/external_backend_service/#authentication","title":"Authentication","text":"Method Path Description GET <code>/api/login</code> List OIDC providers GET <code>/api/login/{system}</code> Initiate OIDC flow GET <code>/api/auth/{system}</code> Complete OIDC flow (callback) GET <code>/api/user_info</code> Get user profile"},{"location":"flutter/planning/specs/external_backend_service/#rooms","title":"Rooms","text":"Method Path Description GET <code>/api/v1/rooms</code> List rooms GET <code>/api/v1/rooms/{room_id}</code> Get room config GET <code>/api/v1/rooms/{room_id}/bg_image</code> Get background image GET <code>/api/v1/rooms/{room_id}/mcp_token</code> Get MCP token GET <code>/api/v1/rooms/{room_id}/documents</code> List RAG documents"},{"location":"flutter/planning/specs/external_backend_service/#agui-threads","title":"AGUI Threads","text":"Method Path Description GET <code>/api/v1/rooms/{room_id}/agui</code> List threads POST <code>/api/v1/rooms/{room_id}/agui</code> Create thread \u2192 <code>{thread_id, runs: {run_id: ...}}</code> GET <code>/api/v1/rooms/{room_id}/agui/{thread_id}</code> Get thread + runs DELETE <code>/api/v1/rooms/{room_id}/agui/{thread_id}</code> Delete thread POST <code>/api/v1/rooms/{room_id}/agui/{thread_id}/meta</code> Update metadata"},{"location":"flutter/planning/specs/external_backend_service/#agui-runs","title":"AGUI Runs","text":"Method Path Description POST <code>/api/v1/rooms/{room_id}/agui/{thread_id}</code> Create run \u2192 <code>{run_id}</code> GET <code>/api/v1/rooms/{room_id}/agui/{thread_id}/{run_id}</code> Get run metadata POST <code>/api/v1/rooms/{room_id}/agui/{thread_id}/{run_id}</code> Execute run (SSE stream) POST <code>/api/v1/rooms/{room_id}/agui/{thread_id}/{run_id}/meta</code> Update metadata"},{"location":"flutter/planning/specs/external_backend_service/#run-execution-request-body-runagentinput","title":"Run Execution Request Body (RunAgentInput)","text":"<pre><code>{\n  \"threadId\": \"string\",\n  \"runId\": \"string\",\n  \"state\": {},\n  \"messages\": [{\"id\": \"...\", \"role\": \"user|assistant\", \"content\": \"...\"}],\n  \"tools\": [],\n  \"context\": []\n}\n</code></pre>"},{"location":"flutter/planning/specs/external_backend_service/#sse-event-types","title":"SSE Event Types","text":"<p><code>RUN_STARTED</code>, <code>RUN_FINISHED</code>, <code>RUN_ERROR</code>, <code>STEP_STARTED</code>, <code>STEP_FINISHED</code>, <code>TEXT_MESSAGE_START</code>, <code>TEXT_MESSAGE_CONTENT</code>, <code>TEXT_MESSAGE_END</code>, <code>TOOL_CALL_START</code>, <code>TOOL_CALL_ARGS</code>, <code>TOOL_CALL_END</code>, <code>TOOL_CALL_RESULT</code>, <code>STATE_SNAPSHOT</code>, <code>STATE_DELTA</code>, <code>MESSAGES_SNAPSHOT</code>, <code>ACTIVITY_SNAPSHOT</code>, <code>ACTIVITY_DELTA</code></p>"},{"location":"flutter/planning/specs/external_backend_service/#other-endpoints","title":"Other Endpoints","text":"Method Path Description GET <code>/api/v1/rooms/{room_id}/quiz/{quiz_id}</code> Get quiz config POST <code>/api/v1/rooms/{room_id}/quiz/{quiz_id}/{question_uuid}</code> Submit answer GET <code>/api/v1/installation</code> Get installation config GET <code>/api/ok</code> Health check"},{"location":"flutter/planning/specs/external_backend_service/#reference","title":"Reference","text":"<ul> <li>OpenAPI docs: http://localhost:8000/docs</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/","title":"OIDC Authentication (AM7)","text":"<p>Cross-platform OIDC authentication using direct OIDC flow via <code>flutter_appauth</code>.</p> <p>Implementation Note: Keep this document updated as implementation progresses. If context is lost and work needs to resume, this document serves as the source of truth for decisions made and current status. Update the \"Implementation Progress\" section below after completing each slice.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#overview","title":"Overview","text":"<p>The app authenticates directly with the IdP (Keycloak) using <code>flutter_appauth</code>. Backend provides IdP configuration but does not participate in the OAuth flow.</p> <p>Flow:</p> <ol> <li>Discover IdP configuration via <code>GET /api/login</code> \u2192 <code>{ server_url, client_id, scope }</code></li> <li><code>flutter_appauth</code> handles full OAuth flow:</li> <li>Opens system browser to IdP authorization endpoint</li> <li>User authenticates with IdP</li> <li>IdP redirects to app with authorization code</li> <li><code>flutter_appauth</code> exchanges code for tokens (PKCE handled automatically)</li> <li>Store tokens securely (Keychain on iOS/macOS)</li> <li>Add <code>Authorization: Bearer {token}</code> to API requests</li> <li>Refresh tokens before expiry (direct to IdP token endpoint)</li> </ol>"},{"location":"flutter/planning/specs/oidc_authentication/#mvp-scope","title":"MVP Scope","text":"<p>In scope (MVP):</p> <ul> <li>macOS (primary development/test platform)</li> <li>iOS</li> </ul> <p>Deferred (post-MVP):</p> <ul> <li>Windows/Linux (loopback server complexity)</li> <li>Web (different security model, CORS complexity)</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#architecture-core-vs-frontend-boundary","title":"Architecture: Core vs Frontend Boundary","text":"<p><code>soliplex_client</code> (future: <code>soliplex_core</code>) must remain frontend-agnostic to support swappable frontends (Flutter, CLI, potentially others). Both Flutter and CLI will use OIDC authentication.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#design-principle","title":"Design Principle","text":"<p>Core is a \"dumb pipe\" that:</p> <ul> <li>Fetches auth configuration from the backend (menu of options)</li> <li>Attaches tokens to HTTP requests</li> <li>Does NOT know how tokens are obtained or refreshed</li> </ul> <p>Frontend handles:</p> <ul> <li>Interpreting auth configuration (e.g., recognizing it as OIDC)</li> <li>Running platform-specific auth flows (flutter_appauth, device code, etc.)</li> <li>Token storage and refresh orchestration</li> <li>Providing tokens to core</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#what-belongs-in-soliplex_client","title":"What Belongs in <code>soliplex_client</code>","text":"Component Rationale <code>AuthProviderConfig</code> Pure data class describing backend's <code>/api/login</code> response. Agnostic to auth type. <code>AuthenticatedHttpClient</code> Decorator that injects <code>Authorization: Bearer</code> header. Pure Dart, no platform deps. <code>fetchAuthProviders()</code> API call to <code>/api/login</code>. Just fetches config, doesn't interpret it. <p>AuthProviderConfig (explicit OIDC fields for MVP):</p> <pre><code>/// Auth provider configuration from /api/login.\n@immutable\nclass AuthProviderConfig {\n  const AuthProviderConfig({\n    required this.id,\n    required this.name,\n    required this.serverUrl,\n    required this.clientId,\n    required this.scope,\n  });\n\n  final String id;\n  final String name;\n  final String serverUrl;\n  final String clientId;\n  final String scope;\n}\n</code></pre> <p>YAGNI Note: The original design proposed generic <code>type</code> + <code>metadata</code> fields for future extensibility (SAML, etc.). The implementation uses explicit OIDC fields since that's all we support. If non-OIDC providers are needed later, refactor to a sealed class hierarchy.</p> <p>AuthenticatedHttpClient (single responsibility: add tokens, no retry):</p> <pre><code>/// Decorates HTTP client with Bearer token injection.\n/// Does NOT handle 401 retry - that's the orchestration layer's job.\nclass AuthenticatedHttpClient implements SoliplexHttpClient {\n  AuthenticatedHttpClient(this._inner, this._getToken);\n\n  final SoliplexHttpClient _inner;\n  final String? Function() _getToken;\n\n  @override\n  Future&lt;HttpResponse&gt; request(...) {\n    final token = _getToken();\n    final headers = token != null\n        ? {...?existingHeaders, 'Authorization': 'Bearer $token'}\n        : existingHeaders;\n    return _inner.request(method, uri, headers: headers, ...);\n  }\n}\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#what-stays-in-flutter-frontend","title":"What Stays in Flutter Frontend","text":"Component Rationale <code>OidcIssuer</code> Frontend-specific interpretation of <code>AuthProviderConfig</code> for OIDC. <code>AuthState</code> sealed class State management is frontend-specific (Riverpod). CLI may use different patterns. <code>authenticate()</code> Uses <code>flutter_appauth</code>. CLI would use device code flow. <code>AuthNotifier</code> Riverpod-specific state management + 401 retry orchestration. Token storage <code>flutter_secure_storage</code> is platform-specific. Refresh orchestration When/how to refresh differs per frontend UX."},{"location":"flutter/planning/specs/oidc_authentication/#naming-convention","title":"Naming Convention","text":"<p>Avoid <code>*Provider</code> suffix in <code>soliplex_client</code> to prevent confusion with Riverpod's <code>Provider</code> terminology. Use inline function types:</p> <pre><code>// Preferred: inline type\nfinal String? Function() _getToken;\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#http-decorator-order-and-observability","title":"HTTP Decorator Order and Observability","text":"<p>Wrapping hierarchy: <code>Refreshing(Authenticated(Observable(Platform)))</code></p> <pre><code>// 1. Platform client (innermost)\nfinal platform = createPlatformClient();\n\n// 2. Observable wraps Platform\nfinal observable = ObservableHttpClient(client: platform, observers: [...]);\n\n// 3. Authenticated wraps Observable\nfinal authenticated = AuthenticatedHttpClient(client: observable, getToken: ...);\n\n// 4. Refreshing wraps Authenticated (outermost)\nfinal refreshing = RefreshingHttpClient(inner: authenticated, refresher: authNotifier);\n</code></pre> <p>Call order for requests:</p> <pre><code>Caller\n  \u2193 refreshing.request()\nRefreshing checks needsRefresh, proactively refreshes if needed\n  \u2193 authenticated.request()\nAuthenticated adds token to headers\n  \u2193 observable.request()\nObservable logs request (WITH auth headers)\n  \u2193 platform.request()\nPlatform sends over wire\n</code></pre> <p>Response order:</p> <pre><code>Platform receives response\n  \u2193\nObservable logs response (sees 401s, all errors)\n  \u2193\nAuthenticated returns response\n  \u2193\nRefreshing checks for 401, refreshes and retries ONCE if needed\n  \u2193\nCaller\n</code></pre> <p>Why this order:</p> <ul> <li>Observer sees requests WITH auth headers (accurate logging)</li> <li>Observer sees all responses including 401s</li> <li>RefreshingHttpClient handles retry at the outermost layer</li> <li>Single retry limit prevents infinite loops (CWE-834)</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#401-retry-architecture","title":"401 Retry Architecture","text":"<p>Key decision: <code>AuthenticatedHttpClient</code> does NOT retry. It only adds tokens. <code>RefreshingHttpClient</code> handles all refresh and retry logic as a separate decorator.</p> <pre><code>1. Original request \u2192 Refreshing \u2192 Authenticated \u2192 Observable \u2192 Platform\n2. 401 response     \u2190 (observer sees this)\n3. RefreshingHttpClient triggers refresh via TokenRefresher interface\n4. Refresh request  \u2192 Observable \u2192 Platform (uses base client, not authenticated)\n5. Refresh response \u2190 (observer sees this)\n6. RefreshingHttpClient retries original request (retried=true prevents loops)\n7. Retry request    \u2192 Refreshing \u2192 Authenticated \u2192 Observable \u2192 Platform\n8. Final response   \u2190 (observer sees this)\n</code></pre> <p>Observer sees all HTTP calls. No visibility is lost.</p> <pre><code>// RefreshingHttpClient - HTTP decorator layer\nclass RefreshingHttpClient implements SoliplexHttpClient {\n  final SoliplexHttpClient _inner;\n  final TokenRefresher _refresher;\n  Completer&lt;bool&gt;? _refreshInProgress;  // Dedupes concurrent refreshes\n\n  Future&lt;HttpResponse&gt; request(...) async {\n    await _refresher.refreshIfExpiringSoon();  // Proactive refresh\n    return _executeWithRetry(..., retried: false);\n  }\n\n  Future&lt;HttpResponse&gt; _executeWithRetry(..., {required bool retried}) async {\n    final response = await _inner.request(...);\n\n    // On 401, attempt refresh and retry ONCE (CWE-834 prevention)\n    if (response.statusCode == 401 &amp;&amp; !retried) {\n      if (await _tryRefreshOnce()) {\n        return _executeWithRetry(..., retried: true);\n      }\n    }\n    return response;\n  }\n}\n</code></pre> <p>Security controls:</p> <ul> <li>Single retry limit via <code>retried</code> flag prevents infinite 401\u2192refresh\u2192401 loops (CWE-834)</li> <li>Completer pattern deduplicates concurrent refresh attempts</li> <li>Refresh uses base HTTP client (not authenticated) to avoid refresh token loops</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#flow-diagram","title":"Flow Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                          soliplex_client (core)                          \u2502\n\u2502                                                                          \u2502\n\u2502  Defines abstractions:                                                   \u2502\n\u2502    \u2022 TokenRefresher (interface)                                          \u2502\n\u2502    \u2022 String? Function() (token getter signature)                         \u2502\n\u2502                                                                          \u2502\n\u2502  fetchAuthProviders() \u2500\u2500\u25ba List&lt;AuthProviderConfig&gt;                       \u2502\n\u2502                                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 RefreshingHttpClient                                               \u2502  \u2502\n\u2502  \u2502   - Wraps AuthenticatedHttpClient                                  \u2502  \u2502\n\u2502  \u2502   - Proactive refresh before requests when needsRefresh            \u2502  \u2502\n\u2502  \u2502   - On 401: refresh via TokenRefresher, retry ONCE                 \u2502  \u2502\n\u2502  \u2502   - Concurrent refresh deduplication via Completer                 \u2502  \u2502\n\u2502  \u2502   - CWE-834: Single retry limit prevents infinite loops            \u2502  \u2502\n\u2502  \u2502                                                                    \u2502  \u2502\n\u2502  \u2502   Dependencies:                                                    \u2502  \u2502\n\u2502  \u2502     inner: AuthenticatedHttpClient                                 \u2502  \u2502\n\u2502  \u2502     refresher: TokenRefresher \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                 \u2502        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 AuthenticatedHttpClient                                      \u2502     \u2502  \u2502\n\u2502  \u2502   - Wraps ObservableHttpClient                               \u2502     \u2502  \u2502\n\u2502  \u2502   - Calls _getToken() per request                            \u2502     \u2502  \u2502\n\u2502  \u2502   - Injects Authorization header if token present            \u2502     \u2502  \u2502\n\u2502  \u2502   - Does NOT retry on 401                                    \u2502     \u2502  \u2502\n\u2502  \u2502                                                              \u2502     \u2502  \u2502\n\u2502  \u2502   Dependencies:                                              \u2502     \u2502  \u2502\n\u2502  \u2502     inner: ObservableHttpClient                              \u2502     \u2502  \u2502\n\u2502  \u2502     _getToken: String? Function() \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2510   \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2502\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                 \u2502 \u2502      \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2502\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 TokenRefreshService (pure Dart)                              \u2502 \u2502   \u2502  \u2502\n\u2502  \u2502   - refresh() \u2192 TokenRefreshResult (sealed type)             \u2502 \u2502   \u2502  \u2502\n\u2502  \u2502   - Fetches OIDC discovery, POSTs to token endpoint          \u2502 \u2502   \u2502  \u2502\n\u2502  \u2502   - SSRF protection via origin validation                    \u2502 \u2502   \u2502  \u2502\n\u2502  \u2502                                                              \u2502 \u2502   \u2502  \u2502\n\u2502  \u2502   Dependencies:                                              \u2502 \u2502   \u2502  \u2502\n\u2502  \u2502     httpClient: baseHttpClient (no auth, internal to core)   \u2502 \u2502   \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2502\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                                                  \u2502 \u2502\n                                        implements &amp;              \u2502 \u2502\n                                        injects                   \u2502 \u2502\n                                                                  \u2502 \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                           Flutter Frontend                      \u2502 \u2502      \u2502\n\u2502                                                                 \u2502 \u2502      \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2502\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 AuthNotifier implements TokenRefresher \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502   \u2502  \u2502\n\u2502  \u2502   - Interprets AuthProviderConfig as OidcIssuer                \u2502   \u2502  \u2502\n\u2502  \u2502   - Runs flutter_appauth flow (sign in/out)                    \u2502   \u2502  \u2502\n\u2502  \u2502   - Stores tokens in flutter_secure_storage                    \u2502   \u2502  \u2502\n\u2502  \u2502   - Delegates refresh to TokenRefreshService                   \u2502   \u2502  \u2502\n\u2502  \u2502   - Implements needsRefresh, refreshIfExpiringSoon(), tryRefresh() \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                   \u2502      \u2502\n\u2502  api_provider.dart wiring:                                        \u2502      \u2502\n\u2502    _getToken: () =&gt; ref.read(accessTokenProvider) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2502\n\u2502                                                                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#migration-plan","title":"Migration Plan","text":"<ol> <li>Add to <code>soliplex_client</code>:</li> <li><code>AuthProviderConfig</code> model in <code>lib/src/auth/</code></li> <li><code>AuthenticatedHttpClient</code> decorator in <code>lib/src/http/</code></li> <li><code>TokenRefresher</code> interface in <code>lib/src/http/</code></li> <li><code>RefreshingHttpClient</code> decorator in <code>lib/src/http/</code></li> <li> <p><code>fetchAuthProviders()</code> in <code>SoliplexApi</code></p> </li> <li> <p>Keep in Flutter frontend:</p> </li> <li><code>OidcIssuer</code> (frontend interpretation of <code>AuthProviderConfig</code>)</li> <li>All Riverpod providers/notifiers</li> <li><code>auth_flow.dart</code> (flutter_appauth)</li> <li> <p>Token storage, <code>AuthNotifier</code> implementing <code>TokenRefresher</code></p> </li> <li> <p>Refactor Flutter wiring:</p> </li> <li>Use core's <code>AuthenticatedHttpClient</code> instead of <code>_AuthenticatedHttpClient</code></li> <li>Frontend provides token getter closure and <code>TokenRefresher</code> implementation</li> <li>Decorator order: <code>Refreshing(Authenticated(Observable(Platform)))</code></li> </ol>"},{"location":"flutter/planning/specs/oidc_authentication/#system-integration","title":"System Integration","text":""},{"location":"flutter/planning/specs/oidc_authentication/#full-architecture-diagram","title":"Full Architecture Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                              Flutter App                                    \u2502\n\u2502                                                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502                         UI Layer                                     \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502   \u2502\n\u2502  \u2502  \u2502 LoginScreen \u2502  \u2502 RoomsScreen \u2502  \u2502 ChatScreen  \u2502  \u2502 Settings   \u2502  \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502            \u2502                \u2502                \u2502               \u2502             \u2502\n\u2502            \u2502    ref.watch(authProvider)      \u2502               \u2502             \u2502\n\u2502            \u25bc                \u25bc                \u25bc               \u25bc             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502                      Providers (Riverpod)                           \u2502   \u2502\n\u2502  \u2502                                                                     \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                    \u2502   \u2502\n\u2502  \u2502  \u2502   authProvider   \u2502\u25c4\u2500\u2500\u2500\u2500\u25ba\u2502  configProvider  \u2502                    \u2502   \u2502\n\u2502  \u2502  \u2502  (AuthNotifier)  \u2502      \u2502 (ConfigNotifier) \u2502                    \u2502   \u2502\n\u2502  \u2502  \u2502 impl TokenRefresher     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                    \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                              \u2502   \u2502\n\u2502  \u2502           \u2502                                                         \u2502   \u2502\n\u2502  \u2502           \u2502 credentials + TokenRefresher interface                  \u2502   \u2502\n\u2502  \u2502           \u25bc                                                         \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                    \u2502   \u2502\n\u2502  \u2502  \u2502    apiProvider   \u2502\u2500\u2500\u2500\u2500\u2500\u25ba\u2502 agUiClientProvider\u2502                   \u2502   \u2502\n\u2502  \u2502  \u2502  (SoliplexApi)   \u2502      \u2502   (AG-UI Client) \u2502                    \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                    \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502              \u2502                         \u2502                                   \u2502\n\u2502              \u25bc                         \u25bc                                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502                         HTTP Decorator Stack                         \u2502   \u2502\n\u2502  \u2502                                                                     \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502   \u2502\n\u2502  \u2502  \u2502 RefreshingHttpClient (core - soliplex_client)                 \u2502   \u2502   \u2502\n\u2502  \u2502  \u2502   - Proactive refresh via TokenRefresher.refreshIfExpiringSoon\u2502  \u2502   \u2502\n\u2502  \u2502  \u2502   - 401 retry via TokenRefresher.tryRefresh (once only)      \u2502   \u2502   \u2502\n\u2502  \u2502  \u2502   - Uses baseHttpClient for refresh (bypasses auth layer)    \u2502   \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502   \u2502\n\u2502  \u2502                             \u2502                                       \u2502   \u2502\n\u2502  \u2502                             \u25bc                                       \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502   \u2502\n\u2502  \u2502  \u2502 AuthenticatedHttpClient (core - soliplex_client)             \u2502   \u2502   \u2502\n\u2502  \u2502  \u2502   - Injects Authorization: Bearer {token}                    \u2502   \u2502   \u2502\n\u2502  \u2502  \u2502   - Does NOT handle refresh or retry                         \u2502   \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502   \u2502\n\u2502  \u2502                             \u2502                                       \u2502   \u2502\n\u2502  \u2502                             \u25bc                                       \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502   \u2502\n\u2502  \u2502  \u2502 ObservableHttpClient (core - soliplex_client)                \u2502   \u2502   \u2502\n\u2502  \u2502  \u2502   - Notifies HttpObserver of all requests/responses          \u2502   \u2502   \u2502\n\u2502  \u2502  \u2502   - ALL traffic (backend + IdP refresh) goes through here    \u2502   \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502   \u2502\n\u2502  \u2502                             \u2502                                       \u2502   \u2502\n\u2502  \u2502                             \u25bc                                       \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502   \u2502\n\u2502  \u2502  \u2502 Platform HTTP Client (core - soliplex_client_native)         \u2502   \u2502   \u2502\n\u2502  \u2502  \u2502   - CupertinoHttpClient (iOS/macOS) / DartHttpClient         \u2502   \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                \u2502                                           \u2502\n\u2502  Token Refresh Path (bypasses AuthenticatedHttpClient):                    \u2502\n\u2502  AuthNotifier.tryRefresh() \u2192 auth_flow.refreshTokens() \u2192 baseHttpClient   \u2502\n\u2502                                \u2502                                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502 HTTPS\n                                 \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      Soliplex Backend Infrastructure                       \u2502\n\u2502                                                                            \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502                        Soliplex API Server                          \u2502  \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502  \u2502\n\u2502  \u2502  \u2502 GET /api/login    \u2502  \u2502 /api/v1/* (protected)                  \u2502  \u2502  \u2502\n\u2502  \u2502  \u2502 Returns IdP info: \u2502  \u2502 Validates Bearer token against IdP    \u2502  \u2502  \u2502\n\u2502  \u2502  \u2502 \u2022 server_url      \u2502  \u2502                                        \u2502  \u2502  \u2502\n\u2502  \u2502  \u2502 \u2022 client_id       \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502  \u2502\n\u2502  \u2502  \u2502 \u2022 scope           \u2502                                              \u2502  \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                              \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                            \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502                    OIDC Identity Provider (Keycloak)                \u2502  \u2502\n\u2502  \u2502  server_url: https://sso.domain.net/realms/soliplex                 \u2502  \u2502\n\u2502  \u2502                                                                     \u2502  \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502  \u2502\n\u2502  \u2502  \u2502 /.well-known/openid-configuration \u25c4\u2500\u2500 OIDC discovery        \u2502    \u2502  \u2502\n\u2502  \u2502  \u2502 /protocol/openid-connect/auth     \u25c4\u2500\u2500 flutter_appauth login \u2502    \u2502  \u2502\n\u2502  \u2502  \u2502 /protocol/openid-connect/token    \u25c4\u2500\u2500 code exchange &amp; refresh\u2502   \u2502  \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nAuth Flow (Direct OIDC via flutter_appauth):\n1. App calls GET /api/login \u2192 gets IdP config (server_url, client_id, scope)\n2. flutter_appauth opens system browser \u2192 IdP login page (server_url)\n3. User authenticates with IdP\n4. IdP redirects to app with auth code\n5. flutter_appauth exchanges code for tokens at IdP token endpoint (PKCE)\n6. App stores tokens, uses for API calls\n7. On refresh: auth_flow.refreshTokens() \u2192 baseHttpClient \u2192 IdP token endpoint\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#auth-components","title":"Auth Components","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         lib/core/auth/                                      \u2502\n\u2502                                                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502  AuthState (sealed class)                                             \u2502 \u2502\n\u2502  \u2502                                                                       \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502\n\u2502  \u2502  \u2502 Unauthenticated \u2502    \u2502 Authenticated                            \u2502 \u2502 \u2502\n\u2502  \u2502  \u2502                 \u2502    \u2502   accessToken, refreshToken, idToken     \u2502 \u2502 \u2502\n\u2502  \u2502  \u2502                 \u2502    \u2502   expiresAt, issuerId, clientId          \u2502 \u2502 \u2502\n\u2502  \u2502  \u2502                 \u2502    \u2502   issuerDiscoveryUrl                      \u2502 \u2502 \u2502\n\u2502  \u2502  \u2502                 \u2502    \u2502   isExpired, needsRefresh (computed)     \u2502 \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                  \u2502                                          \u2502\n\u2502                                  \u2502 persisted to                             \u2502\n\u2502                                  \u25bc                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502                 flutter_secure_storage (via AuthStorage)              \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  iOS/macOS: Keychain    Android: EncryptedSharedPreferences          \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  TokenRefresher (interface) \u2014 from soliplex_client                    \u2502  \u2502\n\u2502  \u2502    needsRefresh: bool                                                 \u2502  \u2502\n\u2502  \u2502    refreshIfExpiringSoon() \u2192 proactive refresh                        \u2502  \u2502\n\u2502  \u2502    tryRefresh() \u2192 attempt refresh, return success/failure             \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  Note: Implementers need access to baseHttpClient (not the            \u2502  \u2502\n\u2502  \u2502  RefreshingHttpClient being configured) for token refresh calls.      \u2502  \u2502\n\u2502  \u2502  This dependency is injected via constructor, not interface.          \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                  \u2502                                          \u2502\n\u2502                                  \u2502 implemented by                           \u2502\n\u2502                                  \u25bc                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  AuthNotifier implements TokenRefresher                               \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  Dependencies captured in build() via providers (enables testing):    \u2502  \u2502\n\u2502  \u2502    late final AuthStorage _storage                                    \u2502  \u2502\n\u2502  \u2502    late final TokenRefreshService _refreshService                     \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  signIn(issuer)      \u2192 flutter_appauth flow                           \u2502  \u2502\n\u2502  \u2502  signOut()           \u2192 endSession + clears tokens from storage        \u2502  \u2502\n\u2502  \u2502  tryRefresh()        \u2192 delegates to _refreshService.refresh()         \u2502  \u2502\n\u2502  \u2502  restoreSession()    \u2192 loads tokens from storage on app start         \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                  \u2502                                          \u2502\n\u2502                                  \u2502 delegates to                             \u2502\n\u2502                                  \u25bc                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  auth_flow.dart                                                       \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  authenticate(issuer) \u2192 AuthResult (flutter_appauth)                  \u2502  \u2502\n\u2502  \u2502  endSession(...)      \u2192 IdP logout (flutter_appauth)                  \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  TokenRefreshService (pure Dart - from soliplex_client)               \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  Constructor: TokenRefreshService(httpClient: SoliplexHttpClient)     \u2502  \u2502\n\u2502  \u2502    httpClient: base client (not authenticated) for refresh calls      \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  refresh(...) \u2192 TokenRefreshResult (sealed type)                      \u2502  \u2502\n\u2502  \u2502    - TokenRefreshSuccess: new tokens                                  \u2502  \u2502\n\u2502  \u2502    - TokenRefreshFailure: invalidGrant, networkError, unknownError    \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  Handles: OIDC discovery, token refresh POST, SSRF validation         \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  RefreshingHttpClient (decorator) \u2014 from soliplex_client              \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  Constructor: RefreshingHttpClient(inner, refresher)                  \u2502  \u2502\n\u2502  \u2502    inner: AuthenticatedHttpClient (for normal requests)               \u2502  \u2502\n\u2502  \u2502    refresher: TokenRefresher (for refresh operations)                 \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  Note: Does NOT receive baseHttpClient directly. The TokenRefresher   \u2502  \u2502\n\u2502  \u2502  implementation (AuthNotifier) handles the baseClient access.         \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  Behavior:                                                            \u2502  \u2502\n\u2502  \u2502    - Proactive refresh via refresher.refreshIfExpiringSoon()          \u2502  \u2502\n\u2502  \u2502    - 401 retry via refresher.tryRefresh() (once only, CWE-834)        \u2502  \u2502\n\u2502  \u2502    - Completer pattern for concurrent refresh deduplication           \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  OidcIssuer (slim model)                                              \u2502  \u2502\n\u2502  \u2502                                                                       \u2502  \u2502\n\u2502  \u2502  id, title, serverUrl, clientId, scope                                \u2502  \u2502\n\u2502  \u2502  discoveryUrl (computed from serverUrl)                               \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nHTTP Client Dependency Clarification:\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Why TokenRefresher needs baseHttpClient (not the decorated stack):         \u2502\n\u2502                                                                             \u2502\n\u2502  RefreshingHttpClient wraps AuthenticatedHttpClient. If refresh calls       \u2502\n\u2502  went through AuthenticatedHttpClient, the refresh_token would be sent      \u2502\n\u2502  with an Authorization header containing the (possibly expired) access      \u2502\n\u2502  token - this is incorrect OAuth behavior and could cause loops.            \u2502\n\u2502                                                                             \u2502\n\u2502  Solution: AuthNotifier receives baseHttpClient via Riverpod ref and        \u2502\n\u2502  passes it to auth_flow.refreshTokens(). The refresh request goes           \u2502\n\u2502  through Observable \u2192 Platform (visible in HTTP logs) but NOT through       \u2502\n\u2502  Authenticated (no auth header added).                                      \u2502\n\u2502                                                                             \u2502\n\u2502  Request paths:                                                             \u2502\n\u2502    Normal API call: Refreshing \u2192 Authenticated \u2192 Observable \u2192 Platform     \u2502\n\u2502    Token refresh:   auth_flow.refreshTokens() \u2192 Observable \u2192 Platform      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#http-observability","title":"HTTP Observability","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        HTTP Request Lifecycle                               \u2502\n\u2502                                                                             \u2502\n\u2502   API Call (e.g., fetchRooms())                                            \u2502\n\u2502        \u2502                                                                    \u2502\n\u2502        \u25bc                                                                    \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502   \u2502 RefreshingHttpClient                                                \u2502   \u2502\n\u2502   \u2502                                                                     \u2502   \u2502\n\u2502   \u2502  1. Check needsRefresh \u2192 proactive refresh if needed               \u2502   \u2502\n\u2502   \u2502  2. Forward request to inner client                                 \u2502   \u2502\n\u2502   \u2502  3. On 401 \u2192 tryRefresh() \u2192 retry ONCE (CWE-834)                   \u2502   \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                 \u2502                                           \u2502\n\u2502                                 \u25bc                                           \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502   \u2502 AuthenticatedHttpClient                                             \u2502   \u2502\n\u2502   \u2502                                                                     \u2502   \u2502\n\u2502   \u2502  Inject: Authorization: Bearer {token}                              \u2502   \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                 \u2502                                           \u2502\n\u2502                                 \u25bc                                           \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502   \u2502 ObservableHttpClient                                                \u2502   \u2502\n\u2502   \u2502                                                                     \u2502   \u2502\n\u2502   \u2502  Emits HttpRequestEvent \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502   \u2502\n\u2502   \u2502    \u2022 method, url                                              \u2502    \u2502   \u2502\n\u2502   \u2502    \u2022 headers (Authorization: Bearer [REDACTED])               \u2502    \u2502   \u2502\n\u2502   \u2502    \u2022 body (tokens [REDACTED])                                 \u2502    \u2502   \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                 \u2502                                 \u2502         \u2502\n\u2502                                 \u25bc                                 \u2502         \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502        \u2502\n\u2502   \u2502 Platform HTTP Client \u2192 Network                              \u2502  \u2502        \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502        \u2502\n\u2502                                 \u2502                                  \u2502         \u2502\n\u2502                                 \u25bc                                  \u2502         \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502        \u2502\n\u2502   \u2502 Response flows back up through the chain                    \u2502   \u2502        \u2502\n\u2502   \u2502                                                             \u2502   \u2502        \u2502\n\u2502   \u2502  ObservableHttpClient emits HttpResponseEvent \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502   \u2502        \u2502\n\u2502   \u2502    \u2022 status, headers                                    \u2502  \u2502   \u2502        \u2502\n\u2502   \u2502    \u2022 body (tokens [REDACTED])                           \u2502  \u2502   \u2502        \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2518   \u2502        \u2502\n\u2502                                                              \u2502     \u2502         \u2502\n\u2502                                                              \u25bc     \u25bc         \u2502\n\u2502   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502   \u2502                      HttpLogNotifier                                \u2502   \u2502\n\u2502   \u2502                  (implements HttpObserver)                          \u2502   \u2502\n\u2502   \u2502                                                                     \u2502   \u2502\n\u2502   \u2502  Sanitization rules applied before logging:                         \u2502   \u2502\n\u2502   \u2502    \u2022 Authorization header \u2192 \"Bearer [REDACTED]\"                     \u2502   \u2502\n\u2502   \u2502    \u2022 Cookie/Set-Cookie headers \u2192 \"[REDACTED]\"                       \u2502   \u2502\n\u2502   \u2502    \u2022 Query params: token, access_token, refresh_token, id_token,    \u2502   \u2502\n\u2502   \u2502      code, client_secret, state \u2192 \"[REDACTED]\"                      \u2502   \u2502\n\u2502   \u2502    \u2022 Response body tokens \u2192 \"[REDACTED]\"                            \u2502   \u2502\n\u2502   \u2502                                                                     \u2502   \u2502\n\u2502   \u2502  State: List&lt;HttpEvent&gt; \u2500\u2500\u25ba UI (HTTP Inspector / Debug Panel)      \u2502   \u2502\n\u2502   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        What IS Observable                                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  \u2713 GET /api/login (fetch IdP configuration)                                \u2502\n\u2502  \u2713 GET {idp}/.well-known/openid-configuration (OIDC discovery)             \u2502\n\u2502  \u2713 POST {idp}/token (refresh calls go through our HTTP stack)              \u2502\n\u2502  \u2713 All authenticated API calls (GET /api/v1/rooms, etc.)                   \u2502\n\u2502  \u2713 401 retry requests (after successful refresh)                           \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                        What is NOT Observable                               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  \u2717 Authorization request (ASWebAuthenticationSession sandbox)              \u2502\n\u2502  \u2717 IdP login page (user authentication)                                    \u2502\n\u2502  \u2717 Code exchange by flutter_appauth (happens inside the library)           \u2502\n\u2502                                                                             \u2502\n\u2502  Note: With direct OIDC, the initial code exchange is handled internally   \u2502\n\u2502  by flutter_appauth and isn't observable. Token refresh uses our HTTP      \u2502\n\u2502  stack via refreshTokens() in auth_flow.dart, so it IS observable.         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#login-flow-sequence","title":"Login Flow Sequence","text":"<pre><code>User taps \"Login with Keycloak\"\n        \u2502\n        \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 LoginScreen       \u2502\n\u2502 signIn(\"keycloak\")\u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 AuthNotifier      \u2502     \u2502 1. Fetch IdP config: GET /api/login              \u2502\n\u2502                   \u2502\u2500\u2500\u2500\u2500\u25ba\u2502    \u2192 { server_url, client_id, scope }            \u2502\n\u2502 signIn(issuerId)  \u2502     \u2502 2. Call flutter_appauth.authorizeAndExchangeCode \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                               \u2502\n                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502                    BROWSER SANDBOX                   \u2502\n                    \u2502              (not observable from app)               \u2502\n                    \u25bc                                                      \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                          \u2502\n         \u2502 ASWebAuthSession    \u2502                                          \u2502\n         \u2502 (iOS/macOS)         \u2502                                          \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                          \u2502\n                    \u2502                                                      \u2502\n                    \u25bc                                                      \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n         \u2502 IdP (Keycloak) - Direct OIDC                                \u2502  \u2502\n         \u2502 https://sso.domain.net/realms/soliplex                      \u2502  \u2502\n         \u2502                                                             \u2502  \u2502\n         \u2502  1. /protocol/openid-connect/auth                           \u2502  \u2502\n         \u2502     (authorization endpoint - shows login page)             \u2502  \u2502\n         \u2502                                                             \u2502  \u2502\n         \u2502  2. User authenticates                                      \u2502  \u2502\n         \u2502                                                             \u2502  \u2502\n         \u2502  3. Redirect to app with authorization code                 \u2502  \u2502\n         \u2502     app://callback?code=xxx&amp;state=yyy                       \u2502  \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n                                    \u2502                                      \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                    \u2502\n                                    \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502 flutter_appauth (automatic code exchange with PKCE)             \u2502\n         \u2502                                                                 \u2502\n         \u2502 POST /protocol/openid-connect/token                             \u2502\n         \u2502   grant_type=authorization_code                                 \u2502\n         \u2502   code=xxx                                                      \u2502\n         \u2502   code_verifier=&lt;PKCE verifier&gt;                                 \u2502\n         \u2502   redirect_uri=app://callback                                   \u2502\n         \u2502                                                                 \u2502\n         \u2502 Response: { access_token, refresh_token, expires_in, ... }     \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                    \u2502\n                                    \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502 AuthNotifier        \u2502\u2500\u2500\u2500\u2500\u25ba\u2502 flutter_secure_     \u2502\n         \u2502 state = Authenticated\u2502     \u2502 storage             \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n                    \u25bc\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502 GoRouter redirect   \u2502\n         \u2502 guard allows access \u2502\n         \u2502 \u2192 navigate to /     \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#logout-flow-sequence","title":"Logout Flow Sequence","text":"<pre><code>User taps \"Logout\"\n        \u2502\n        \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SettingsScreen    \u2502\n\u2502 signOut()         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 AuthNotifier      \u2502\n\u2502 signOut()         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Get idToken and issuerDiscoveryUrl from Authenticated state \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 idToken is null? \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502                                                    \u2502\n         \u25bc (idToken present)                                  \u25bc (no idToken)\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 auth_flow.endSession()                       \u2502    \u2502 Skip endSession      \u2502\n\u2502                                             \u2502    \u2502 (can't logout at IdP \u2502\n\u2502  appAuth.endSession(EndSessionRequest(      \u2502    \u2502  without idToken)    \u2502\n\u2502    idTokenHint: idToken,                    \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u2502    discoveryUrl: issuerDiscoveryUrl,        \u2502               \u2502\n\u2502    postLogoutRedirectUrl: redirectUri,      \u2502               \u2502\n\u2502  ))                                         \u2502               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518               \u2502\n         \u2502                                                    \u2502\n         \u2502 (Opens browser to IdP logout page)                 \u2502\n         \u2502 (IdP clears its session)                           \u2502\n         \u2502 (Redirects back to app)                            \u2502\n         \u2502                                                    \u2502\n         \u2502 (If endSession fails, continues anyway)            \u2502\n         \u25bc                                                    \u2502\n         \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 state = Unauthenticated()                   \u2502\n\u2502 (Local tokens cleared)                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u2502\n         \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 GoRouter redirect   \u2502\n\u2502 guard navigates     \u2502\n\u2502 \u2192 to /login         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Key behavior:</p> <ul> <li><code>endSession</code> requires <code>idToken</code> from the original login</li> <li>If <code>idToken</code> is unavailable, local logout still proceeds</li> <li>If <code>endSession</code> fails (network error, IdP error), local logout still proceeds</li> <li>User is always logged out locally regardless of IdP session state</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#backend-endpoints","title":"Backend Endpoints","text":"Endpoint Method Purpose <code>/api/login</code> GET IdP configuration (server_url, client_id, scope) <code>/api/v1/*</code> various Protected API endpoints (require Bearer token) <p><code>/api/login</code> Response Format:</p> <pre><code>{\n  \"keycloak\": {\n    \"id\": \"keycloak\",\n    \"title\": \"Authenticate with Keycloak\",\n    \"server_url\": \"https://sso.domain.net/realms/soliplex\",\n    \"client_id\": \"soliplex-service\",\n    \"scope\": \"openid email profile\"\n  }\n}\n</code></pre> <p>Note: BFF endpoints (<code>/api/login/{system}</code>, <code>/api/auth/{system}</code>) exist but are not used with direct OIDC approach. They're available for web platform (deferred).</p>"},{"location":"flutter/planning/specs/oidc_authentication/#models","title":"Models","text":""},{"location":"flutter/planning/specs/oidc_authentication/#authstate","title":"AuthState","text":"<pre><code>sealed class AuthState {\n  const AuthState();\n}\n\nclass Unauthenticated extends AuthState {\n  const Unauthenticated();\n}\n\nclass AuthLoading extends AuthState {\n  const AuthLoading();\n}\n\nclass Authenticated extends AuthState {\n  final String accessToken;\n  final String refreshToken;\n  final DateTime expiresAt;\n  final String issuerId;            // Which IdP issued tokens (for refresh)\n  final String issuerDiscoveryUrl;  // OIDC discovery URL (for endSession)\n  final String clientId;            // Required for token refresh\n  final String idToken;             // Required for OIDC endSession\n\n  const Authenticated({\n    required this.accessToken,\n    required this.refreshToken,\n    required this.expiresAt,\n    required this.issuerId,\n    required this.issuerDiscoveryUrl,\n    required this.clientId,\n    required this.idToken,\n  });\n\n  bool get isExpired =&gt; DateTime.now().isAfter(expiresAt);\n  bool get needsRefresh =&gt; DateTime.now().isAfter(\n    expiresAt.subtract(TokenRefreshService.refreshThreshold),\n  );\n}\n</code></pre> <p>Refresh Buffer Justification (1 minute):</p> <p>The 1-minute buffer before token expiry provides:</p> <ol> <li>Network latency margin: Ensures refresh completes before token expires, even with slow networks</li> <li>Clock drift tolerance: Small differences between client and server clocks won't cause premature 401s</li> <li>Reasonable for typical token lifetimes: Keycloak default access token lifetime is 5 minutes;    1 minute buffer means refresh at 80% of lifetime</li> </ol> <p>For shorter token lifetimes (&lt; 2 minutes), this buffer may be too aggressive. Consider making it configurable or percentage-based (e.g., 80% of lifetime) if supporting IdPs with very short tokens.</p> <p>Note: <code>refreshExpiresAt</code> intentionally omitted. Refresh token expiry is handled by <code>invalid_grant</code> error response from IdP, avoiding client-side clock drift issues.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#nullable-fields-and-boundaries","title":"Nullable Fields and Boundaries","text":"<p>The auth system has several nullable fields. Each null is handled at a single boundary to avoid spreading null checks throughout the codebase.</p> Field Type Why Nullable Boundary <code>AuthResult.refreshToken</code> <code>String?</code> Some IdPs don't issue refresh tokens <code>AuthNotifier.signIn()</code> - defaults to empty string <code>AuthResult.idToken</code> <code>String?</code> Some IdPs may not return id_token Stored as-is; checked in <code>endSession()</code> <code>AuthResult.expiresAt</code> <code>DateTime?</code> Some IdP responses omit <code>expires_in</code> <code>AuthNotifier.signIn()</code> - defaults to 1 hour from now <code>AuthenticatedHttpClient._getToken()</code> <code>String?</code> Returns null when unauthenticated <code>_injectAuth()</code> - skips header if null <code>TokenRefreshSuccess.idToken</code> <code>String?</code> OIDC spec: refresh may not return id_token <code>AuthNotifier</code> preserves existing idToken <p>TokenRefreshSuccess.idToken Nullability (OIDC Spec Reference):</p> <p>Per OIDC Core 1.0 Section 12.2:</p> <p>\"Upon successful validation of the Refresh Token, the response body is the Token Response of Section 3.1.3.3 except that it might not contain an id_token.\"</p> <p>Whether an IdP returns a new <code>id_token</code> on refresh depends on implementation, requested scopes, and provider-specific policies. The <code>TokenRefreshSuccess.idToken</code> field is intentionally nullable to accurately represent what the IdP returned. Callers must preserve the existing <code>id_token</code>:</p> <pre><code>// In AuthNotifier._handleRefreshSuccess()\nfinal idToken = result.idToken ?? current.idToken;\n</code></pre> <p>Design principle: Nulls represent legitimate states (e.g., no token yet, IdP didn't provide optional field). Each null is handled at one boundary, keeping the rest of the code simple.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#oidcissuer","title":"OidcIssuer","text":"<p>Exactly matches <code>/api/login</code> response shape:</p> <pre><code>class OidcIssuer {\n  final String id;\n  final String title;\n  final String serverUrl;\n  final String clientId;\n  final String scope;\n\n  const OidcIssuer({\n    required this.id,\n    required this.title,\n    required this.serverUrl,\n    required this.clientId,\n    required this.scope,\n  });\n}\n</code></pre> <p>Token endpoint for refresh is derived at runtime from OIDC discovery: <code>{serverUrl}/.well-known/openid-configuration</code></p>"},{"location":"flutter/planning/specs/oidc_authentication/#providers","title":"Providers","text":"Provider Type Purpose <code>authProvider</code> NotifierProvider Auth state + actions, implements TokenRefresher <code>baseHttpClientProvider</code> Provider Observable HTTP client for refresh (no auth header) <p>Derived providers (<code>accessTokenProvider</code>, <code>hasAppAccessProvider</code>) added when needed.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#authnotifier","title":"AuthNotifier","text":"<p>Implements <code>TokenRefresher</code> to provide refresh capabilities to RefreshingHttpClient.</p> <pre><code>class AuthNotifier extends Notifier&lt;AuthState&gt; implements TokenRefresher {\n  final AuthStorage _storage;\n\n  Future&lt;void&gt; signIn(OidcIssuer issuer);\n  Future&lt;void&gt; signOut();              // Calls endSession (flutter_appauth) + clears storage\n\n  // TokenRefresher implementation\n  bool get needsRefresh;               // True if token expires within 1 minute\n  Future&lt;void&gt; refreshIfExpiringSoon(); // Proactive refresh before API calls\n  Future&lt;bool&gt; tryRefresh();           // Uses auth_flow.refreshTokens() with baseHttpClient\n}\n</code></pre> <p>Token refresh uses <code>ref.read(baseHttpClientProvider)</code> to get an observable HTTP client that bypasses the auth layer (avoiding circular dependency).</p> <p>signOut behavior:</p> <ul> <li>On platforms with flutter_appauth (iOS/macOS): calls <code>appAuth.endSession()</code> to end   the IdP session, then clears local tokens</li> <li>On platforms without flutter_appauth (future): clears local tokens only; proper   endSession support deferred until platform-specific auth is implemented</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#platform-auth-flow","title":"Platform Auth Flow","text":"<p>Single file <code>auth_flow.dart</code> with platform-appropriate implementation:</p>"},{"location":"flutter/planning/specs/oidc_authentication/#mvp-iosmacos-direct-oidc-via-flutter_appauth","title":"MVP: iOS/macOS (Direct OIDC via flutter_appauth)","text":"<p>Uses <code>flutter_appauth</code> with ASWebAuthenticationSession. PKCE handled automatically.</p> <pre><code>const _redirectUri = 'ai.soliplex.client://callback';\n\nFuture&lt;AuthResult&gt; authenticate(OidcIssuer issuer) async {\n  // flutter_appauth handles:\n  // - PKCE code_verifier/code_challenge generation\n  // - State parameter generation and validation\n  // - Opening ASWebAuthenticationSession\n  // - Code exchange with IdP token endpoint\n\n  final result = await appAuth.authorizeAndExchangeCode(\n    AuthorizationTokenRequest(\n      issuer.clientId,\n      _redirectUri,\n      discoveryUrl: issuer.discoveryUrl,\n      scopes: issuer.scope.split(' '),\n      externalUserAgent: ExternalUserAgent.ephemeralAsWebAuthenticationSession,\n    ),\n  );\n\n  return AuthResult(\n    accessToken: result.accessToken!,\n    refreshToken: result.refreshToken,\n    idToken: result.idToken,\n    expiresAt: result.accessTokenExpirationDateTime,\n  );\n}\n</code></pre> <p>Platform configuration required:</p> <ul> <li>macOS: <code>Info.plist</code> with <code>CFBundleURLSchemes</code> for custom URL scheme</li> <li>iOS: Same <code>Info.plist</code> configuration</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#post-mvp-desktop-windows-linux","title":"Post-MVP: Desktop (Windows, Linux)","text":"<p>Loopback server with state validation (deferred).</p>"},{"location":"flutter/planning/specs/oidc_authentication/#post-mvp-web","title":"Post-MVP: Web","text":"<p>Redirect flow with memory-only storage (deferred).</p>"},{"location":"flutter/planning/specs/oidc_authentication/#http-integration","title":"HTTP Integration","text":""},{"location":"flutter/planning/specs/oidc_authentication/#token-injection","title":"Token Injection","text":"<pre><code>final authenticatedTransportProvider = Provider&lt;HttpTransport&gt;((ref) {\n  final transport = ref.watch(httpTransportProvider);\n  final authState = ref.watch(authProvider);\n  final token = authState is Authenticated ? authState.accessToken : null;\n\n  return AuthenticatedHttpTransport(\n    transport: transport,\n    getToken: () =&gt; token,\n  );\n});\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#401-handling","title":"401 Handling","text":"<p>On <code>AuthException</code> (401/403):</p> <ol> <li>If refresh token available and not expired: attempt refresh</li> <li>If refresh fails or no refresh token: transition to Unauthenticated</li> <li>Router redirect guard navigates to <code>/login</code></li> </ol>"},{"location":"flutter/planning/specs/oidc_authentication/#http-observer-filtering","title":"HTTP Observer Filtering","text":"<p>Filter sensitive data from logs:</p> <pre><code>const _sensitiveHeaders = {\n  'authorization',\n  'cookie',\n  'set-cookie',\n  'www-authenticate',\n};\n\nconst _sensitiveParams = {\n  'token',\n  'access_token',\n  'refresh_token',\n  'id_token',\n  'code',\n  'client_secret',\n  'state',\n  'code_verifier',   // PKCE verifier\n  'session_state',   // Keycloak session metadata\n};\n\nconst _sensitiveBodyFields = {\n  'access_token',\n  'refresh_token',\n  'id_token',\n  'code',\n  'session_state',\n};\n</code></pre> <p>Deferred (post-MVP):</p> <ul> <li>JWT pattern regex detection (<code>eyJ[A-Za-z0-9-_]+\\.eyJ...</code>) for catch-all redaction</li> <li>Response header <code>www-authenticate</code> parsing for token format leakage</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#router-integration","title":"Router Integration","text":""},{"location":"flutter/planning/specs/oidc_authentication/#routes","title":"Routes","text":"Route Screen Auth Required <code>/login</code> LoginScreen No <code>/</code> HomeScreen Yes <code>/rooms/*</code> Room screens Yes <code>/settings</code> SettingsScreen Yes"},{"location":"flutter/planning/specs/oidc_authentication/#redirect-guard","title":"Redirect Guard","text":"<p>The router uses <code>refreshListenable</code> to trigger redirect re-evaluation on auth status changes without recreating the router itself. This preserves navigation state during token refresh (which updates auth state but shouldn't cause navigation).</p> <pre><code>final routerProvider = Provider&lt;GoRouter&gt;((ref) {\n  // authStatusListenableProvider only fires on login/logout transitions,\n  // NOT on token refresh. This prevents navigation state loss.\n  final authStatusListenable = ref.watch(authStatusListenableProvider);\n\n  return GoRouter(\n    initialLocation: '/',\n    refreshListenable: authStatusListenable,\n    redirect: (context, state) {\n      // Use ref.read() for fresh auth state, not a captured variable\n      final authState = ref.read(authProvider);\n      final isAuthenticated = authState is Authenticated;\n      final isLoginRoute = state.matchedLocation == '/login';\n\n      if (!isAuthenticated &amp;&amp; !isLoginRoute) {\n        return '/login';\n      }\n      if (isAuthenticated &amp;&amp; isLoginRoute) {\n        return '/';\n      }\n      return null;\n    },\n    // ...routes\n  );\n});\n</code></pre> <p>Key implementation detail: <code>_AuthStatusListenable</code> tracks whether user is authenticated (boolean), not the full auth state. When tokens refresh, the boolean stays <code>true</code>, so no notification fires and the router doesn't rebuild. On logout, the boolean changes from <code>true</code> to <code>false</code>, triggering redirect evaluation.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#startup-ux","title":"Startup UX","text":"<p>On app launch, <code>restoreSession()</code> checks for stored tokens. During this async check:</p> <ol> <li>Show loading indicator (centered spinner or splash)</li> <li>Once auth state resolves:</li> <li>Authenticated \u2192 navigate to home</li> <li>Unauthenticated \u2192 navigate to login</li> </ol> <pre><code>// In app initialization\nawait ref.read(authProvider.notifier).restoreSession();\n// Auth state now resolved, router redirect guard takes over\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#secure-storage","title":"Secure Storage","text":"Platform Storage Mechanism iOS Keychain macOS Keychain Android EncryptedSharedPreferences (post-MVP) Windows DPAPI (post-MVP) Linux libsecret (post-MVP) Web Memory only (post-MVP) <p>Keychain Configuration (MVP):</p> <pre><code>const storage = FlutterSecureStorage(\n  iOptions: IOSOptions(\n    accessibility: KeychainAccessibility.first_unlock_this_device,\n  ),\n  mOptions: MacOsOptions(\n    accessibility: KeychainAccessibility.first_unlock_this_device,\n  ),\n);\n</code></pre> <p>Accessibility choice: <code>first_unlock_this_device</code> (not <code>whenUnlockedThisDeviceOnly</code>) because:</p> <ul> <li>Enables background token refresh without requiring device to be actively unlocked</li> <li>Still prevents backup/restore to different devices (<code>thisDeviceOnly</code> suffix)</li> <li>Still requires at least one unlock after boot before tokens are accessible</li> <li>Tradeoff: tokens accessible when device is locked (after first unlock)</li> </ul> <p>This prevents:</p> <ul> <li>Tokens being restored from backup to another device</li> <li>Access before first device unlock after boot</li> </ul> <p>Storage Keys:</p> <ul> <li><code>auth_access_token</code></li> <li><code>auth_refresh_token</code></li> <li><code>auth_id_token</code> (required for endSession)</li> <li><code>auth_expires_at</code></li> <li><code>auth_issuer_id</code> (to know which IdP config to use for refresh)</li> <li><code>auth_issuer_discovery_url</code> (required for endSession)</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#token-refresh-strategy","title":"Token Refresh Strategy","text":"<p>Backend does not provide a refresh endpoint. Client refreshes directly with IdP using the same HTTP stack (so refresh calls are observable).</p>"},{"location":"flutter/planning/specs/oidc_authentication/#flow","title":"Flow","text":"<pre><code>1. On app start, GET /api/login \u2192 OidcIssuer { server_url, client_id }\n2. GET {server_url}/.well-known/openid-configuration \u2192 { token_endpoint }\n3. Cache token_endpoint for refresh calls\n4. When access_token nearing expiry (1 min before):\n   POST {token_endpoint}  \u25c4\u2500\u2500 Goes through ObservableHttpClient\n   Content-Type: application/x-www-form-urlencoded\n\n   grant_type=refresh_token\n   refresh_token={stored_refresh_token}\n   client_id={client_id}\n\n5. IdP returns: { access_token, refresh_token, expires_in, refresh_expires_in }\n6. Store new tokens, update expiry times\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#error-handling","title":"Error Handling","text":"Error Action <code>invalid_grant</code> Refresh token expired/revoked \u2192 clear tokens, require re-login Network error Retry with exponential backoff, max 3 attempts Other OAuth error Log error, require re-login"},{"location":"flutter/planning/specs/oidc_authentication/#token-refresh-failure-handling-policy","title":"Token Refresh Failure Handling Policy","text":"<p>Token refresh failures are handled differently at startup vs runtime. This asymmetry is intentional.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#startup-session-restore","title":"Startup (Session Restore)","text":"<p>When the app launches with stored but expired tokens, <code>_tryRefreshStoredTokens</code> attempts refresh. All failures result in logout:</p> Failure Reason Action <code>invalidGrant</code> Clear tokens, logout <code>networkError</code> Clear tokens, logout <code>noRefreshToken</code> Clear tokens, logout Exception thrown Clear tokens, logout <p>Rationale: At startup, we're trying to establish trust from stored credentials. If we can't validate tokens (for any reason), we have nothing useful\u2014the tokens are stale and we can't verify them. Failing fast with \"please log in\" is clearer than pretending authentication succeeded when we can't verify it.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#runtime-active-session","title":"Runtime (Active Session)","text":"<p>When refresh is triggered during an active session (proactive refresh or 401 retry), <code>tryRefresh</code> distinguishes between failure types:</p> Failure Reason Action <code>invalidGrant</code> Clear tokens, logout (refresh token is dead) <code>networkError</code> Preserve session, return <code>false</code> (transient failure) <code>noRefreshToken</code> Preserve session, return <code>false</code> (can't recover) <code>unknownError</code> Preserve session, return <code>false</code> (optimistic) <p>Rationale: At runtime, we already established trust. A transient network error shouldn't destroy a valid session. The user stays \"authenticated\" in local state and can retry when network returns. Only a definitive rejection from the IdP (<code>invalidGrant</code>) triggers logout.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#why-not-align-both-to-the-same-policy","title":"Why Not Align Both to the Same Policy?","text":"<p>Option: Make startup lenient (like runtime)</p> <p>If the device is offline at launch with valid refresh tokens, the user would stay \"authenticated\" but unable to make API calls. This creates confusing UX: \"I'm logged in but nothing works.\" Every API call would fail, attempt refresh, fail again.</p> <p>Option: Make runtime strict (like startup)</p> <p>Network blips would log users out, destroying valid sessions unnecessarily. Users would need to re-authenticate after every transient network failure.</p> <p>Chosen: Asymmetric policy</p> <ul> <li>Startup: Strict (fail fast, clear \"please log in\" prompt)</li> <li>Runtime: Lenient (preserve session through transient failures)</li> </ul> <p>This matches user expectations: \"If I was logged in, a bad wifi moment shouldn't kick me out. But if I'm starting fresh, just show me the login screen.\"</p>"},{"location":"flutter/planning/specs/oidc_authentication/#deployment-requirements","title":"Deployment Requirements","text":"<p>These are backend/infrastructure requirements outside the app's control:</p> Requirement Owner Notes Keycloak redirect URI Backend Must configure <code>net.soliplex.app://callback</code> in Keycloak client Refresh token rotation Backend Keycloak should rotate refresh tokens on each use CORS (web only) Backend Not needed for MVP (native only) <p>Refresh Token Rotation:</p> <p>If Keycloak returns a new refresh token on refresh, the app stores the new token. If Keycloak is NOT configured for rotation, a leaked refresh token grants indefinite access until it expires.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#security-requirements","title":"Security Requirements","text":"Requirement Implementation PKCE flutter_appauth handles automatically No embedded WebView flutter_appauth uses ASWebAuthenticationSession Secure token storage flutter_secure_storage (Keychain) with <code>first_unlock_this_device</code> Token filtering in logs HttpObserver sanitization State parameter flutter_appauth handles automatically HTTPS only Enforced by config validation"},{"location":"flutter/planning/specs/oidc_authentication/#implementation-slices-vertical","title":"Implementation Slices (Vertical)","text":""},{"location":"flutter/planning/specs/oidc_authentication/#spike-validate-direct-oidc-on-macos-ios","title":"Spike: Validate Direct OIDC on macOS + iOS","text":"<p>Research findings:</p> <ul> <li>[x] <code>/api/login</code> returns IdP config: <code>{ server_url, client_id, scope }</code></li> <li>[x] Direct OIDC approach confirmed (per <code>clean_soliplex</code> implementation)</li> <li>[x] flutter_appauth supports macOS + iOS via ASWebAuthenticationSession</li> </ul> <p>Spike deliverable (before Slice 1):</p> <ul> <li>[ ] Minimal test app with flutter_appauth</li> <li>[ ] Confirm login flow works with Keycloak IdP on macOS</li> <li>[ ] Confirm login flow works on iOS</li> <li>[ ] Validate token returned and usable for API call</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#slice-1-walking-skeleton-http-filtering","title":"Slice 1: Walking Skeleton + HTTP Filtering","text":"<p>Delivers: Login on macOS, make authenticated API call, sensitive data redacted.</p> <p>Acceptance: User can login, see protected content. HTTP inspector shows <code>[REDACTED]</code> for tokens.</p> <p>Files:</p> <ul> <li><code>lib/core/auth/auth_state.dart</code></li> <li><code>lib/core/auth/oidc_issuer.dart</code></li> <li><code>lib/core/auth/auth_flow.dart</code></li> <li><code>lib/core/auth/auth_notifier.dart</code></li> <li><code>lib/core/auth/idp_client.dart</code></li> <li><code>lib/core/providers/auth_provider.dart</code></li> <li><code>lib/features/login/login_screen.dart</code></li> <li><code>lib/core/router/app_router.dart</code> (modify)</li> <li><code>packages/soliplex_client/lib/src/http/http_observer.dart</code> (modify - filtering)</li> <li><code>macos/Runner/Info.plist</code> (URL scheme)</li> <li><code>macos/Runner/DebugProfile.entitlements</code></li> <li><code>macos/Runner/Release.entitlements</code></li> <li><code>ios/Runner/Info.plist</code> (URL scheme)</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#slice-2-session-persistence","title":"Slice 2: Session Persistence","text":"<p>Delivers: Tokens survive app restart. Loading indicator during restore.</p> <p>Acceptance: Close app while authenticated, reopen, see loading indicator briefly, then authenticated content.</p> <p>Files:</p> <ul> <li>Modify <code>auth_notifier.dart</code> to use flutter_secure_storage with Keychain config</li> <li>Add loading state handling in router/UI</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#slice-3-token-refresh-401-recovery","title":"Slice 3: Token Refresh + 401 Recovery","text":"<p>Delivers: Access tokens refresh before expiry. Automatic retry on 401.</p> <p>Acceptance: App remains authenticated beyond initial token lifetime. Expired token triggers refresh and retry transparently.</p> <p>Files:</p> <ul> <li><code>lib/core/auth/authenticated_transport.dart</code></li> <li>Modify <code>lib/core/providers/api_provider.dart</code></li> <li>Modify <code>auth_notifier.dart</code> for refresh logic via IdpClient</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#dependencies","title":"Dependencies","text":"<pre><code>dependencies:\n  flutter_appauth: ^8.0.0        # Native OAuth (iOS/macOS)\n  flutter_secure_storage: ^9.2.0 # Secure token storage\n</code></pre> <p>Post-MVP:</p> <pre><code>  url_launcher: ^6.3.0           # System browser (desktop)\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#test-plan","title":"Test Plan","text":""},{"location":"flutter/planning/specs/oidc_authentication/#unit-tests","title":"Unit Tests","text":"<ul> <li>[x] AuthState.isExpired / needsRefresh</li> <li>[x] TokenRefreshService (13 tests: success, validation, errors, SSRF)</li> <li>[x] RefreshingHttpClient (19 tests: retry, deduplication, proactive refresh)</li> <li>[x] AuthNotifier (15 tests: restore, runtime refresh, failure policies)</li> <li>[ ] Token parsing from callback URI</li> <li>[ ] State parameter generation and validation</li> <li>[x] HTTP observer filtering rules</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#widget-tests","title":"Widget Tests","text":"<ul> <li>[ ] LoginScreen fetches and renders providers</li> <li>[ ] LoginScreen handles loading/error states</li> <li>[ ] Auth redirect guard behavior</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#integration-tests","title":"Integration Tests","text":"<ul> <li>[x] Full auth flow on macOS (spike validated)</li> <li>[x] Full auth flow on iOS (spike validated)</li> <li>[ ] Token refresh with artificially short expiry (manual test)</li> <li>[x] Session restore: write tokens, restart provider, verify state (unit tested)</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#file-structure","title":"File Structure","text":"<pre><code>lib/core/auth/\n\u251c\u2500\u2500 auth_state.dart              # Sealed class (AuthState, Authenticated, etc.)\n\u251c\u2500\u2500 auth_storage.dart            # Keychain storage wrapper\n\u251c\u2500\u2500 auth_notifier.dart           # State management + TokenRefresher impl\n\u251c\u2500\u2500 auth_provider.dart           # Riverpod providers\n\u251c\u2500\u2500 auth_flow.dart               # authenticate, endSession (flutter_appauth)\n\u2514\u2500\u2500 oidc_issuer.dart             # Model from /api/login\n\npackages/soliplex_client/lib/src/http/\n\u251c\u2500\u2500 token_refresher.dart         # Interface for refresh operations\n\u2514\u2500\u2500 refreshing_http_client.dart  # HTTP decorator for refresh + 401 retry\n\npackages/soliplex_client/lib/src/auth/\n\u2514\u2500\u2500 token_refresh_service.dart   # Pure Dart service for token refresh\n\npackages/soliplex_client/lib/src/api/\n\u2514\u2500\u2500 fetch_auth_providers.dart    # Backend API for /api/login\n\npackages/soliplex_client/lib/src/domain/\n\u2514\u2500\u2500 auth_provider_config.dart    # Domain model for auth providers\n\nlib/core/providers/\n\u2514\u2500\u2500 api_provider.dart            # HTTP client wiring with RefreshingHttpClient\n\nlib/features/login/\n\u2514\u2500\u2500 login_screen.dart            # Provider selection UI\n\nPlatform config:\n\u251c\u2500\u2500 macos/Runner/Info.plist      # URL scheme\n\u251c\u2500\u2500 macos/Runner/*.entitlements  # Network access\n\u2514\u2500\u2500 ios/Runner/Info.plist        # URL scheme\n</code></pre>"},{"location":"flutter/planning/specs/oidc_authentication/#component-summary","title":"Component Summary","text":"Component Purpose Lines (est) AuthState Sealed class with token fields ~60 AuthStorage Keychain storage wrapper ~80 AuthNotifier State management + TokenRefresher impl ~250 auth_flow.dart authenticate + endSession (flutter_appauth) ~80 OidcIssuer Model from /api/login ~50 TokenRefresher Interface for refresh operations ~20 TokenRefreshService Pure Dart refresh logic with result type ~230 RefreshingHttpClient HTTP decorator, 401 retry, CWE-834 ~120 Total ~890"},{"location":"flutter/planning/specs/oidc_authentication/#resolved-questions","title":"Resolved Questions","text":"<ol> <li>Auth approach: Direct OIDC via flutter_appauth (not BFF pattern)</li> <li>Token refresh: Via IdpClient using shared HTTP client (observable)</li> <li>HTTP client architecture: Single HTTP client, ObservableHttpClient wraps it, both SoliplexApi and IdpClient use it</li> <li>Logout: Full OIDC logout via <code>endSession</code> on platforms with flutter_appauth (iOS/macOS); local-only logout on other platforms until proper auth is implemented</li> <li>Multiple providers: Support one at a time (can switch by logging out first)</li> <li>Auth observability: Browser flow not observable; refresh calls are observable</li> <li>Platform scope: MVP = macOS + iOS; Desktop/Web deferred</li> <li>Keychain security: <code>first_unlock_this_device</code> to enable background refresh while preventing backup/restore attacks</li> <li>Startup UX: Loading indicator until auth state resolves</li> <li>refreshExpiresAt: Omitted - let <code>invalid_grant</code> signal refresh token expiry</li> </ol>"},{"location":"flutter/planning/specs/oidc_authentication/#web-platform-support-deferred","title":"Web Platform Support (Deferred)","text":"<p>Web requires a different authentication approach because:</p> <ol> <li><code>flutter_appauth</code> uses <code>dart:ffi</code> which is unavailable on web</li> <li><code>cupertino_http</code> (used by <code>soliplex_client_native</code>) also uses <code>dart:ffi</code></li> <li>CORS restrictions prevent direct OIDC token exchange from browser</li> </ol>"},{"location":"flutter/planning/specs/oidc_authentication/#backend-for-frontend-bff-pattern","title":"Backend-For-Frontend (BFF) Pattern","text":"<p>The backend already provides BFF endpoints for web authentication:</p> <ul> <li><code>GET /api/login/{provider_id}?return_to={callback_url}</code> - Initiates OAuth flow</li> <li>Backend handles PKCE, code exchange, and redirects back with tokens</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#implementation-requirements","title":"Implementation Requirements","text":"<p>HTTP Client for Web:</p> <p><code>soliplex_client_native</code> unconditionally exports <code>cupertino_http_client.dart</code>, which imports <code>cupertino_http</code> (dart:ffi). Fix with conditional export:</p> <pre><code>// clients.dart\nexport 'cupertino_http_client.dart'\n    if (dart.library.js_interop) 'cupertino_http_client_web.dart';\n</code></pre> <p>Create <code>cupertino_http_client_web.dart</code> that throws <code>UnsupportedError</code> if instantiated (web should use <code>DartHttpClient</code> via <code>createPlatformClient()</code> instead).</p> <p>Auth Flow for Web:</p> <p>New files needed (reference: <code>clean_soliplex/src/flutter/lib/core/auth/</code>):</p> File Purpose <code>callback_params.dart</code> Sealed class for URL callback params <code>web_auth_callback_handler.dart</code> Conditional import dispatcher <code>web_auth_callback_native.dart</code> No-op for native platforms <code>web_auth_callback_web.dart</code> Extracts tokens from URL using <code>web</code> package <code>web_auth_pending_storage.dart</code> Stores pending auth session for callback <code>features/auth/auth_callback_screen.dart</code> Route <code>/auth/callback</code> <p>Auth Flow Changes:</p> <p>Modify <code>auth_flow.dart</code> to detect web platform and redirect to backend BFF endpoint instead of using <code>flutter_appauth</code>. Web flow:</p> <ol> <li>User clicks login \u2192 redirect to <code>/api/login/{provider_id}?return_to=/auth/callback</code></li> <li>Backend handles OAuth, redirects back with <code>?token=xxx&amp;refresh_token=xxx&amp;expires_in=xxx</code></li> <li><code>AuthCallbackScreen</code> extracts tokens from URL, stores them, navigates to home</li> </ol> <p>Router Changes:</p> <p>Add <code>/auth/callback</code> route that renders <code>AuthCallbackScreen</code>.</p> <p>Dependencies:</p> <pre><code>dependencies:\n  url_launcher: ^6.3.0  # For web redirect\n  web: ^1.0.0           # For URL manipulation on web\n</code></pre> <p>Token Storage:</p> <p>Web should use memory-only storage (no <code>flutter_secure_storage</code> persistence) due to browser security model. Tokens cleared on page refresh.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#estimated-effort","title":"Estimated Effort","text":"<p>~6-8 new files, modifications to auth_flow.dart, router, and soliplex_client_native. Approximately 400-600 lines of new code.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#deferred-items","title":"Deferred Items","text":"<ul> <li>Windows/Linux loopback server implementation (includes endSession support)</li> <li>Web platform authentication (see \"Web Platform Support\" section above)</li> <li>Multiple simultaneous provider sessions</li> <li>Android support (flutter_appauth supported, endSession will work)</li> <li>JWT pattern regex for catch-all token redaction in logs</li> <li><code>www-authenticate</code> header parsing</li> <li>Auth-optional mode: skip login when backend returns empty providers list</li> <li>AuthNotifier testability: inject AuthFlow interface for unit testing</li> <li>OIDC nonce parameter: verify flutter_appauth handles internally or add explicit nonce</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#implementation-progress","title":"Implementation Progress","text":"<p>Track implementation status here. Update after each phase.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#spike-status-complete","title":"Spike Status: \u2705 Complete","text":"<ul> <li>[x] Add flutter_appauth dependency (v11.0.0)</li> <li>[x] Configure macOS URL scheme (<code>ai.soliplex.client://callback</code>)</li> <li>[x] Create spike test screen at <code>/auth-spike</code></li> <li>[x] macOS app builds and runs successfully</li> <li>[x] Configure iOS URL scheme (<code>ai.soliplex.client://callback</code>)</li> <li>[x] Test login flow on macOS</li> <li>[x] Test login flow on iOS (simulator)</li> <li>[x] Validate token usable for API call</li> </ul> <p>Spike Findings:</p> <ul> <li>flutter_appauth v11.0 API: use <code>externalUserAgent: ExternalUserAgent.ephemeralAsWebAuthenticationSession</code></li> <li>Redirect URI must match Keycloak client config: <code>ai.soliplex.client://callback</code></li> <li>OIDC discovery and token exchange work correctly with pydio Keycloak</li> <li>Access token successfully used for authenticated API calls</li> <li>Tested on both macOS and iOS (simulator) - both platforms work</li> </ul> <p>Files created:</p> <ul> <li><code>lib/core/auth/oidc_issuer.dart</code> - OidcIssuer model</li> <li><code>lib/core/auth/auth_flow.dart</code> - flutter_appauth wrapper</li> <li><code>lib/features/auth_spike/auth_spike_screen.dart</code> - test screen</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#slice-1-status-complete","title":"Slice 1 Status: \u2705 Complete","text":"<ul> <li>[x] <code>lib/core/auth/auth_state.dart</code> - Sealed AuthState classes</li> <li>[x] <code>lib/core/auth/oidc_issuer.dart</code> - OidcIssuer wrapper</li> <li>[x] <code>lib/core/auth/auth_flow.dart</code> - flutter_appauth wrapper with generic error messages</li> <li>[x] <code>lib/core/auth/auth_notifier.dart</code> - Riverpod state management</li> <li>[x] <code>lib/core/auth/auth_provider.dart</code> - Auth providers (authProvider, oidcIssuersProvider)</li> <li>[x] <code>lib/features/login/login_screen.dart</code> - Login UI with provider selection</li> <li>[x] <code>lib/core/router/app_router.dart</code> - Auth-aware routing with redirect</li> <li>[x] <code>lib/core/providers/http_log_provider.dart</code> - Sensitive query param redaction</li> <li>[x] <code>lib/core/providers/api_provider.dart</code> - Authenticated HTTP client wiring</li> <li>[x] <code>packages/soliplex_client/.../authenticated_http_client.dart</code> - Token injection</li> <li>[x] <code>packages/soliplex_client/.../fetch_auth_providers.dart</code> - Backend API</li> <li>[x] <code>packages/soliplex_client/.../auth_provider_config.dart</code> - Domain model</li> <li>[ ] <code>lib/core/auth/idp_client.dart</code> - Deferred (YAGNI for now)</li> </ul> <p>Notes:</p> <ul> <li><code>idp_client.dart</code> deferred - direct API calls sufficient for MVP</li> <li>HTTP filtering in <code>http_log_provider.dart</code> not <code>http_observer.dart</code></li> <li>Error messages sanitized per Sentinel review (generic to user, full in logs)</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#slice-2-status-complete","title":"Slice 2 Status: \u2705 Complete","text":"<ul> <li>[x] <code>lib/core/auth/auth_storage.dart</code> - Secure storage wrapper with Keychain config</li> <li>[x] <code>lib/core/auth/auth_notifier.dart</code> - Session restore and token persistence</li> <li>[x] <code>lib/core/auth/auth_state.dart</code> - Safe <code>toString()</code> on all states (no token exposure)</li> <li>[x] <code>lib/app.dart</code> - Loading screen during auth restore</li> <li>[x] <code>lib/main.dart</code> - <code>clearOnReinstall()</code> for iOS keychain persistence</li> <li>[x] <code>lib/features/settings/settings_screen.dart</code> - Sign out button (triggers endSession + clears storage)</li> <li>[x] <code>test/core/auth/auth_storage_test.dart</code> - Storage unit tests</li> </ul> <p>Notes:</p> <ul> <li>Keychain uses <code>first_unlock_this_device</code> (not spec's original <code>whenUnlockedThisDeviceOnly</code>)   to enable background token refresh. Spec updated to reflect this.</li> <li><code>clearOnReinstall()</code> handles iOS behavior where Keychain persists across app reinstalls</li> <li>Sign out uses <code>flutter_appauth.endSession()</code> to properly terminate IdP session</li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#slice-3-status-complete","title":"Slice 3 Status: \u2705 Complete","text":"<ul> <li>[x] <code>lib/core/auth/auth_storage.dart</code> - Add clientId to storage</li> <li>[x] <code>lib/core/auth/auth_state.dart</code> - Add clientId to Authenticated, require idToken</li> <li>[x] <code>lib/core/auth/auth_notifier.dart</code> - Store clientId, implement TokenRefresher</li> <li>[x] <code>lib/core/auth/auth_flow.dart</code> - Simplified to just authenticate/endSession</li> <li>[x] <code>packages/soliplex_client/.../token_refresher.dart</code> - Interface for refresh operations</li> <li>[x] <code>packages/soliplex_client/.../refreshing_http_client.dart</code> - HTTP decorator with 401 retry</li> <li>[x] <code>packages/soliplex_client/.../token_refresh_service.dart</code> - Pure Dart refresh logic</li> <li>[x] <code>lib/core/auth/auth_provider.dart</code> - Add tokenRefreshServiceProvider</li> <li>[x] <code>lib/core/providers/api_provider.dart</code> - Wire RefreshingHttpClient</li> <li>[x] Handle expired tokens on session restore (attempt refresh before clearing)</li> <li>[x] Unit tests for TokenRefreshService (13 tests)</li> <li>[x] Unit tests for RefreshingHttpClient (19 tests)</li> <li>[x] Unit tests for AuthNotifier (15 tests)</li> </ul> <p>Implementation Notes:</p> <ul> <li>Token refresh extracted to <code>TokenRefreshService</code> (pure Dart, in soliplex_client)</li> <li>Returns sealed <code>TokenRefreshResult</code> type (Success/Failure) instead of exceptions</li> <li>SSRF protection: validates token endpoint origin matches discovery URL</li> <li><code>RefreshingHttpClient</code> decorator pattern per blacksmith/sentinel review</li> <li>Single retry limit prevents infinite 401\u2192refresh\u2192401 loops (CWE-834)</li> <li>Completer pattern deduplicates concurrent refresh attempts with microtask cleanup</li> <li><code>TokenRefresher</code> interface decouples HTTP client from AuthNotifier</li> <li><code>idToken</code> now required (not nullable) - needed for proper OIDC logout</li> <li><code>clientId</code> stored in Keychain alongside other tokens for refresh</li> </ul> <p>Architectural Decision (2026-01-05):</p> <p>Per blacksmith consultation, AuthNotifier implementing TokenRefresher is valid DIP:</p> <ul> <li>RefreshingHttpClient depends only on TokenRefresher abstraction</li> <li>AuthNotifier provides implementation</li> <li>No actual inversion - the interface is in the right place (HTTP layer defines needs)</li> </ul> <p>Testability improved by:</p> <ul> <li>Extracting refresh HTTP logic to <code>TokenRefreshService</code> (pure Dart, constructor injection)</li> <li>AuthNotifier captures dependencies in <code>build()</code> via <code>late final</code> fields</li> <li>Test by overriding providers (<code>authStorageProvider</code>, <code>tokenRefreshServiceProvider</code>)</li> </ul> <p>Riverpod Notifier Dependency Injection Pattern:</p> <p>Riverpod's <code>Notifier</code> class doesn't support constructor injection because <code>NotifierProvider</code> uses <code>AuthNotifier.new</code> (the default constructor). The <code>ref</code> object is only available inside <code>build()</code> and instance methods, not in the constructor.</p> <p>The solution is <code>late final</code> fields initialized at the start of <code>build()</code>:</p> <pre><code>class AuthNotifier extends Notifier&lt;AuthState&gt; implements TokenRefresher {\n  late final AuthStorage _storage;\n  late final TokenRefreshService _refreshService;\n\n  @override\n  AuthState build() {\n    _storage = ref.read(authStorageProvider);\n    _refreshService = ref.read(tokenRefreshServiceProvider);\n    // ...\n  }\n}\n</code></pre> <p>Lifecycle guarantee: Riverpod calls <code>build()</code> before exposing the Notifier to callers. No instance method can be invoked until <code>build()</code> completes and returns the initial state. The <code>late final</code> fields are always initialized before any method accesses them.</p>"},{"location":"flutter/planning/specs/oidc_authentication/#router-navigation-preservation-fix-2026-01-06","title":"Router Navigation Preservation Fix (2026-01-06)","text":"<p>Fixed issue where token refresh caused navigation state loss. The router was using <code>ref.watch(authProvider)</code> which recreated the GoRouter on every auth state change (including token refresh), resetting navigation to <code>initialLocation: '/'</code>.</p> <p>Solution:</p> <ul> <li>Added <code>authStatusListenableProvider</code> that only fires on login/logout transitions</li> <li>Router uses <code>refreshListenable</code> pattern instead of <code>ref.watch(authProvider)</code></li> <li>Redirect callback uses <code>ref.read(authProvider)</code> for fresh state reads</li> </ul> <p>Files modified:</p> <ul> <li><code>lib/core/auth/auth_provider.dart</code> - Added <code>_AuthStatusListenable</code></li> <li><code>lib/core/router/app_router.dart</code> - Updated to use <code>refreshListenable</code></li> <li><code>test/core/router/app_router_test.dart</code> - Added tests for auth state changes</li> </ul> <p>Tests added:</p> <ul> <li><code>logout from deep navigation redirects to /login</code></li> <li><code>token refresh preserves navigation location</code></li> </ul>"},{"location":"flutter/planning/specs/oidc_authentication/#remaining-work","title":"Remaining Work","text":"<p>Tests (incremental coverage, not blocking):</p> Category Item Priority Unit Token parsing from callback URI Low Unit State parameter generation/validation Low Widget LoginScreen fetches/renders providers Medium Widget LoginScreen loading/error states Medium Widget Auth redirect guard behavior Medium Manual Token refresh with artificially short expiry Medium <p>Current test coverage: 47 unit tests across TokenRefreshService (13), RefreshingHttpClient (19), and AuthNotifier (15). Core token refresh functionality is well-tested.</p> <p>Not remaining (deferred to post-MVP): See \"Deferred Items\" section above for Windows/Linux, Web platform, Android, and other post-MVP work.</p>"},{"location":"flutter/planning/specs/web_platform_support/","title":"Plan: Enable Web Platform Support","text":""},{"location":"flutter/planning/specs/web_platform_support/#summary","title":"Summary","text":"<p>Enable the Soliplex Flutter frontend to run on web with all current features, including OIDC authentication.</p>"},{"location":"flutter/planning/specs/web_platform_support/#context","title":"Context","text":"<p>The current app supports iOS/macOS using <code>flutter_appauth</code> for direct OIDC flow. Web requires a different approach:</p> <ol> <li><code>flutter_appauth</code> uses <code>dart:ffi</code> - unavailable on web</li> <li><code>cupertino_http</code> uses <code>dart:ffi</code> - unavailable on web</li> <li>CORS restrictions prevent direct OIDC token exchange from browser</li> <li><code>dart:io</code> exceptions (SocketException, HttpException) don't exist on web</li> </ol> <p>Good news: The backend already provides BFF endpoints for web OAuth:</p> <ul> <li><code>GET /api/login/{provider}?return_to={url}</code> - Initiates OAuth (backend handles PKCE)</li> <li><code>GET /api/auth/{provider}</code> - Callback that redirects with tokens in URL</li> </ul> <p>Reference implementation: <code>/Users/jaeminjo/enfold/clean_soliplex/src/flutter/lib/core/auth/</code></p>"},{"location":"flutter/planning/specs/web_platform_support/#token-storage-decision","title":"Token Storage Decision","text":"<p>Per sentinel security review + clean_soliplex reference implementation:</p> <ul> <li>Use localStorage (matching clean_soliplex) - tokens persist across sessions</li> <li>Store refresh tokens - enables automatic token refresh on web</li> <li>Token refresh via direct HTTP POST to OIDC token endpoint (same as native)</li> </ul> <p>Security mitigations (already in place or backend responsibility):</p> <ul> <li>CSP headers to block XSS</li> <li>Server-side token validation</li> <li>Token refresh buffer (5 min before expiry)</li> <li>Logout clears all tokens</li> </ul> <p>Why localStorage over sessionStorage: XSS can access both equally. sessionStorage loses tokens on tab close, breaking legitimate workflows (accidental refresh, new tab). For an internal tool where we control the codebase, localStorage is pragmatic.</p>"},{"location":"flutter/planning/specs/web_platform_support/#implementation-slices","title":"Implementation Slices","text":""},{"location":"flutter/planning/specs/web_platform_support/#slice-1-web-platform-configuration","title":"Slice 1: Web Platform Configuration","text":"<p>Enable <code>flutter build web</code> so all subsequent work can be verified.</p> <p>Files to create/modify:</p> <ol> <li><code>web/index.html</code> - Flutter web entry point (if not exists, Flutter creates it)</li> <li><code>pubspec.yaml</code> - Add web dependency:</li> </ol> <pre><code>dependencies:\n  web: ^1.1.0\n</code></pre> <p>Verification: <code>flutter build web</code> compiles (will fail on dart:io - that's expected)</p>"},{"location":"flutter/planning/specs/web_platform_support/#slice-2-cors-verification","title":"Slice 2: CORS Verification","text":"<p>Before investing in auth work, verify backend CORS is configured.</p> <p>Manual test:</p> <ol> <li>Run <code>flutter run -d chrome</code></li> <li>Check browser console for CORS errors on API calls</li> <li>If CORS errors: backend needs <code>Access-Control-Allow-Origin</code> header for web origin</li> </ol> <p>If CORS fails: Stop and configure backend before proceeding.</p>"},{"location":"flutter/planning/specs/web_platform_support/#slice-3-http-layer-web-compatibility","title":"Slice 3: HTTP Layer Web Compatibility","text":"<p>Fix <code>dart:io</code> dependencies that break web compilation.</p>"},{"location":"flutter/planning/specs/web_platform_support/#why-web-compilation-fails","title":"Why web compilation fails","text":"<p>When <code>flutter build web</code> runs, Dart compiles all exported code - even code the app never calls. The export chain causes the problem:</p> <pre><code>soliplex_client_native.dart\n  \u2192 exports src/clients/clients.dart\n    \u2192 exports cupertino_http_client.dart\n      \u2192 imports package:cupertino_http\n        \u2192 uses dart:ffi\n          \u2192 FAILS on web (dart:ffi unavailable)\n</code></pre>"},{"location":"flutter/planning/specs/web_platform_support/#why-no-stub-file-is-needed","title":"Why no stub file is needed","text":"<p>We investigated whether app code directly references <code>CupertinoHttpClient</code>:</p> <pre><code>grep -r \"CupertinoHttpClient\" lib/\n# Result: No matches found\n</code></pre> <p>Findings:</p> <ul> <li>App code uses <code>createPlatformClient()</code> which returns <code>SoliplexHttpClient</code> interface</li> <li><code>createPlatformClient()</code> already handles web via <code>create_platform_client_stub.dart</code>   (returns <code>DartHttpClient</code> on web)</li> <li>Direct <code>CupertinoHttpClient</code> references exist only in:</li> <li>Package internals (<code>create_platform_client_io.dart</code> - already conditionally imported)</li> <li>Tests (run on native platforms, not web)</li> <li>Documentation</li> </ul> <p>Conclusion: We don't need a stub class. Simply don't export <code>CupertinoHttpClient</code> on web. Code that incorrectly tries to import it directly will get a compile error, which is the correct behavior - it guides developers to use <code>createPlatformClient()</code>.</p>"},{"location":"flutter/planning/specs/web_platform_support/#files-to-modify","title":"Files to modify","text":"<ol> <li><code>packages/soliplex_client_native/lib/src/clients/clients.dart</code></li> <li>Add conditional export so <code>CupertinoHttpClient</code> is only available on IO platforms:</li> </ol> <pre><code>// Before:\nexport 'cupertino_http_client.dart';\n\n// After - only export on platforms with dart:io\nexport 'cupertino_http_client.dart'\n    if (dart.library.io) 'cupertino_http_client.dart';\n</code></pre> <p>On web, this exports nothing. That's correct because:    - Web code should use <code>createPlatformClient()</code> \u2192 returns <code>DartHttpClient</code>    - Direct <code>CupertinoHttpClient</code> usage would fail anyway (no NSURLSession on web)</p> <ol> <li><code>packages/soliplex_client/lib/src/http/dart_http_client.dart</code></li> <li>Remove <code>import 'dart:io'</code></li> <li>Replace <code>SocketException</code>/<code>HttpException</code> catches with platform-agnostic pattern:</li> </ol> <pre><code>// Before: catches dart:io exceptions\n} on SocketException catch (e, stackTrace) { ... }\n} on HttpException catch (e, stackTrace) { ... }\n\n// After: generic fallback works on all platforms\n} on http.ClientException catch (e, stackTrace) {\n  throw NetworkException(\n    message: 'Client error: ${e.message}',\n    originalError: e,\n    stackTrace: stackTrace,\n  );\n} on Exception catch (e, stackTrace) {\n  // Generic fallback for platform-specific exceptions (SocketException on\n  // native, browser exceptions on web)\n  throw NetworkException(\n    message: 'Network error: $e',\n    originalError: e,\n    stackTrace: stackTrace,\n  );\n}\n</code></pre> <ol> <li>Audit <code>RefreshingHttpClient</code> for dart:io usage - apply same fix if needed</li> </ol> <p>Verification: <code>flutter build web</code> succeeds</p>"},{"location":"flutter/planning/specs/web_platform_support/#slice-4-platform-aware-auth-storage","title":"Slice 4: Platform-Aware Auth Storage","text":"<p>Make <code>AuthStorage</code> platform-aware instead of creating a separate <code>TokenStorage</code> layer. (Per blacksmith review: 3 files instead of 5, preserves existing high-level API)</p> <p>Files to create:</p> <ol> <li><code>lib/core/auth/auth_storage_native.dart</code> (NEW)</li> <li>Native implementation using <code>flutter_secure_storage</code></li> <li>Move existing <code>AuthStorage</code> logic here</li> <li> <p>Keychain config for iOS/macOS</p> </li> <li> <p><code>lib/core/auth/auth_storage_web.dart</code> (NEW)</p> </li> <li>Web implementation using localStorage</li> <li>Same API as native: <code>saveTokens()</code>, <code>loadTokens()</code>, <code>clearTokens()</code></li> <li>Add comment explaining why localStorage is acceptable (security decision)</li> </ol> <p>Files to modify:</p> <ol> <li><code>lib/core/auth/auth_storage.dart</code></li> <li>Convert to abstract interface + factory with conditional import:</li> </ol> <pre><code>import 'auth_storage_native.dart'\n    if (dart.library.js_interop) 'auth_storage_web.dart' as impl;\n\nabstract class AuthStorage {\n  factory AuthStorage() =&gt; impl.createAuthStorage();\n\n  Future&lt;void&gt; saveTokens(Authenticated state);\n  Future&lt;Authenticated?&gt; loadTokens();\n  Future&lt;void&gt; clearTokens();\n  Future&lt;void&gt; clearOnReinstall(); // no-op on web\n}\n</code></pre> <p>Verification:</p> <ul> <li>Existing auth tests still pass</li> <li>Manual test: login on native still works</li> </ul>"},{"location":"flutter/planning/specs/web_platform_support/#slice-5-web-authentication-flow","title":"Slice 5: Web Authentication Flow","text":"<p>Implement BFF-pattern authentication for web.</p> <p>Files to create:</p> <ol> <li><code>lib/core/auth/auth_flow_native.dart</code> (NEW)</li> <li>Move existing <code>flutter_appauth</code> code here</li> <li> <p>Contains <code>authenticate()</code> and <code>endSession()</code></p> </li> <li> <p><code>lib/core/auth/auth_flow_web.dart</code> (NEW)</p> </li> <li>Web implementation using BFF pattern</li> <li><code>authenticate()</code>: redirects to <code>/api/login/{provider}?return_to=/auth/callback</code></li> <li> <p><code>endSession()</code>: clears local tokens (no IdP logout on web)</p> </li> <li> <p><code>lib/core/auth/web_auth_callback_web.dart</code> (NEW)</p> </li> <li>Extracts tokens from URL using <code>web</code> package</li> <li> <p>Error handling (per blacksmith):</p> <pre><code>// Check for OAuth errors first\nfinal error = queryParams['error'];\nif (error != null) {\n  throw AuthException('OAuth error: $error - ${queryParams['error_description']}');\n}\n// Validate required tokens exist\nfinal token = queryParams['token'];\nif (token == null) {\n  throw AuthException('Missing token in callback');\n}\n</code></pre> </li> <li> <p>Clean URL after extraction (per pathfinder - security):</p> <pre><code>// Remove tokens from browser history\nhtml.window.history.replaceState(null, '', '/');\n</code></pre> </li> <li> <p><code>lib/core/auth/web_auth_callback_stub.dart</code> (NEW)</p> </li> <li> <p>No-op for native platforms</p> </li> <li> <p><code>lib/features/auth/auth_callback_screen.dart</code> (NEW)</p> </li> <li>Route handler for <code>/auth/callback</code></li> <li>Extracts tokens, stores them, navigates to home</li> </ol> <p>Files to modify:</p> <ol> <li><code>lib/core/auth/auth_flow.dart</code></li> <li>Convert to conditional import dispatcher:</li> </ol> <pre><code>import 'auth_flow_native.dart'\n    if (dart.library.js_interop) 'auth_flow_web.dart' as impl;\n\nFuture&lt;AuthResult&gt; authenticate(OidcIssuer issuer) =&gt; impl.authenticate(issuer);\nFuture&lt;void&gt; endSession(...) =&gt; impl.endSession(...);\n</code></pre> <ol> <li><code>lib/core/auth/auth_notifier.dart</code></li> <li> <p>Add <code>completeWebAuth(CallbackParams params)</code> method for callback handling</p> </li> <li> <p><code>lib/core/router/app_router.dart</code></p> </li> <li>Add <code>/auth/callback</code> route</li> <li>Important: This route must bypass auth guard (chicken-and-egg problem)</li> </ol> <p>Verification:</p> <ul> <li>Native auth still works</li> <li>Web auth flow completes (requires running backend)</li> </ul>"},{"location":"flutter/planning/specs/web_platform_support/#slice-6-testing-validation","title":"Slice 6: Testing &amp; Validation","text":"<p>Specific test matrix (per pathfinder):</p> <p>Compilation:</p> <ul> <li>[ ] <code>flutter build web</code> succeeds with no errors</li> <li>[ ] <code>flutter build macos</code> still succeeds</li> <li>[ ] <code>flutter build ios</code> still succeeds</li> </ul> <p>Unit tests:</p> <ul> <li>[ ] All existing auth tests pass</li> <li>[ ] <code>AuthStorage</code> factory returns correct implementation per platform</li> </ul> <p>Native regression (manual):</p> <ul> <li>[ ] Login works on macOS</li> <li>[ ] Token refresh works on macOS</li> <li>[ ] Logout works on macOS</li> </ul> <p>Web auth flow (manual):</p> <ul> <li>[ ] Login redirects to backend OAuth endpoint</li> <li>[ ] OAuth callback extracts tokens correctly</li> <li>[ ] Tokens stored in localStorage</li> <li>[ ] Token refresh works</li> <li>[ ] Logout clears localStorage</li> <li>[ ] OAuth error shows user-friendly message</li> <li>[ ] Direct navigation to <code>/auth/callback</code> shows error (not crash)</li> <li>[ ] Tokens removed from URL after extraction (check browser history)</li> </ul> <p>Web features (manual):</p> <ul> <li>[ ] Chat works (messages send/receive)</li> <li>[ ] SSE streaming works (AG-UI events)</li> <li>[ ] Thread switching works</li> <li>[ ] Room navigation works</li> </ul>"},{"location":"flutter/planning/specs/web_platform_support/#critical-files-summary","title":"Critical Files Summary","text":"File Action <code>packages/soliplex_client_native/.../clients.dart</code> Add conditional export (no stub needed) <code>packages/soliplex_client/lib/src/http/dart_http_client.dart</code> Remove dart:io <code>lib/core/auth/auth_storage.dart</code> Convert to interface + factory <code>lib/core/auth/auth_storage_native.dart</code> NEW - flutter_secure_storage impl <code>lib/core/auth/auth_storage_web.dart</code> NEW - localStorage impl <code>lib/core/auth/auth_flow.dart</code> Convert to conditional import dispatcher <code>lib/core/auth/auth_flow_native.dart</code> NEW - flutter_appauth impl <code>lib/core/auth/auth_flow_web.dart</code> NEW - BFF redirect impl <code>lib/core/auth/web_auth_callback_web.dart</code> NEW - URL token extraction <code>lib/features/auth/auth_callback_screen.dart</code> NEW - callback route <code>lib/core/router/app_router.dart</code> Add /auth/callback route"},{"location":"flutter/planning/specs/web_platform_support/#dependencies-to-add","title":"Dependencies to Add","text":"<pre><code>dependencies:\n  web: ^1.1.1  # For web platform APIs (localStorage, window.location)\n</code></pre>"},{"location":"flutter/planning/specs/web_platform_support/#estimated-loc","title":"Estimated LOC","text":"<ul> <li>~30 lines: Web config + dependencies</li> <li>~20 lines: HTTP conditional export + exception fix (no stub file needed)</li> <li>~80 lines: Auth storage (interface + 2 implementations)</li> <li>~120 lines: Web auth flow + callback handling</li> <li>~30 lines: Router changes</li> <li>Total: ~280 lines</li> </ul>"},{"location":"flutter/planning/specs/web_platform_support/#questions-resolved","title":"Questions Resolved","text":"<ol> <li>Token storage: localStorage with refresh tokens (per clean_soliplex + sentinel review)</li> <li>PKCE handling: Backend handles PKCE for web (BFF pattern)</li> <li>Token refresh: Direct HTTP POST to OIDC token endpoint (same mechanism as native)</li> <li>Security: Acceptable for internal tool with CSP, server-side validation, token rotation</li> <li>Conditional export direction: <code>if (dart.library.io)</code> for native (exports nothing on web)</li> <li>Storage abstraction: Platform-aware <code>AuthStorage</code> (not separate <code>TokenStorage</code>)</li> <li>CupertinoHttpClient on web: No stub file needed - app code never references it directly,    so conditional export that exports nothing on web is sufficient. Code that incorrectly    tries to import <code>CupertinoHttpClient</code> directly will get a compile error, guiding    developers to use <code>createPlatformClient()</code> instead.</li> </ol>"},{"location":"flutter/planning/specs/web_platform_support/#risk-factors","title":"Risk Factors","text":"<ol> <li>CORS: If backend isn't configured for CORS, API calls will fail on web</li> <li>Mitigation: Slice 2 verifies this early</li> <li>Cookies: Backend auth uses session cookies which may have SameSite issues</li> <li>SSE on web: EventSource should work but may have browser quirks</li> <li>Multi-tab state: Web browsers can have multiple tabs with different auth states</li> <li>Not addressed in this plan; accept as known limitation</li> </ol>"},{"location":"flutter/planning/specs/web_platform_support/#implementation-status","title":"Implementation Status","text":""},{"location":"flutter/planning/specs/web_platform_support/#slice-1-web-platform-configuration-pending","title":"Slice 1: Web Platform Configuration - \u23f3 Pending","text":"<p>Not yet started. Verify web/index.html and pubspec.yaml.</p>"},{"location":"flutter/planning/specs/web_platform_support/#slice-2-cors-verification-pending","title":"Slice 2: CORS Verification - \u23f3 Pending","text":"<p>Not yet tested. Requires running backend.</p>"},{"location":"flutter/planning/specs/web_platform_support/#slice-3-http-layer-web-compatibility-complete","title":"Slice 3: HTTP Layer Web Compatibility - \u2705 Complete","text":"<p>Commit: <code>2b50a57 feat(web): HTTP layer web compatibility (Slice 3)</code></p>"},{"location":"flutter/planning/specs/web_platform_support/#slice-4-platform-aware-auth-storage-complete","title":"Slice 4: Platform-Aware Auth Storage - \u2705 Complete","text":"<p>Commit: <code>43ee727 feat(web): platform-aware auth storage (Slice 4)</code></p> <p>Added PreAuthState support for web BFF flow:</p> <ul> <li><code>PreAuthState</code> class with 5-minute expiry for CSRF protection</li> <li>Storage handles expiry check internally (callers don't need to check)</li> </ul>"},{"location":"flutter/planning/specs/web_platform_support/#slice-5-web-authentication-flow-complete","title":"Slice 5: Web Authentication Flow - \u2705 Complete","text":"<p>Commits:</p> <ul> <li><code>9e6d64a feat(web): callback params capture abstraction</code></li> <li><code>ef190ee feat(web): pre-auth state storage for web BFF</code></li> <li><code>1e42deb feat(web): platform-aware auth flow with BFF pattern</code></li> <li><code>9adc28a feat(web): web auth completion flow (Slice 5)</code></li> <li><code>92082ca test(web): web auth flow tests</code></li> <li><code>bf21508 docs: backend-frontend integration notes</code></li> </ul>"},{"location":"flutter/planning/specs/web_platform_support/#slice-6-testing-validation-pending","title":"Slice 6: Testing &amp; Validation - \u23f3 Pending","text":"<p>Unit tests pass. Manual testing not yet done.</p>"},{"location":"flutter/planning/specs/web_platform_support/#implementation-notes","title":"Implementation Notes","text":""},{"location":"flutter/planning/specs/web_platform_support/#actual-files-created","title":"Actual Files Created","text":"Planned Actual Notes <code>web_auth_callback_stub.dart</code> <code>web_auth_callback_native.dart</code> Renamed for clarity (not planned) <code>callback_params.dart</code> Extracted sealed class (not planned) <code>web_auth_callback.dart</code> Dispatcher + interface"},{"location":"flutter/planning/specs/web_platform_support/#why-native-stub-files-are-required","title":"Why Native Stub Files Are Required","text":"<p>Question: Could we use <code>kIsWeb</code> in main.dart instead of conditional imports?</p> <p>Answer: No. Dart conditional imports are compile-time decisions, not runtime.</p> <pre><code>// This WON'T work:\nvoid main() async {\n  final params = kIsWeb\n      ? WebCapture.captureNow()  // FAILS: imports dart:js_interop\n      : const NoCallbackParams();\n}\n</code></pre> <p>The problem: <code>web_auth_callback_web.dart</code> imports <code>package:web</code> which uses <code>dart:js_interop</code>. That import fails at compile time on native platforms, even if the code path is never executed at runtime.</p> <p>Why we need the native file:</p> <ol> <li>Dart conditional imports require a real file on both branches</li> <li>We can't \"not import anything\" - must provide the functions/classes</li> <li>The native file provides no-op implementations (27 lines)</li> </ol> <p>Why not inline the conditional import per-callsite?</p> <p>Two call sites exist:</p> <ol> <li><code>main.dart</code> - captures params at startup</li> <li><code>AuthCallbackScreen</code> - clears URL params after processing</li> </ol> <p>Centralizing in <code>web_auth_callback.dart</code> avoids duplicating conditional imports.</p>"},{"location":"flutter/planning/specs/web_platform_support/#design-decision-authredirectinitiated-exception","title":"Design Decision: AuthRedirectInitiated Exception","text":"<p>Web auth flow fundamentally differs from native:</p> <ul> <li>Native: <code>authenticate()</code> completes with tokens after browser flow</li> <li>Web: <code>authenticate()</code> triggers redirect, never returns; tokens via callback</li> </ul> <p>Original implementation returned a never-completing <code>Future&lt;AuthResult&gt;</code> on web. This is a \"type system lie\" - the type promises completion that never happens.</p> <p>Fix: Throw <code>AuthRedirectInitiated</code> exception after triggering redirect.</p> <pre><code>// auth_flow_web.dart\nFuture&lt;AuthResult&gt; authenticate(OidcIssuer issuer) async {\n  _navigator.navigateTo(loginUrl);\n  throw const AuthRedirectInitiated();  // Type-honest\n}\n</code></pre> <p>Callers explicitly handle this case:</p> <pre><code>// login_screen.dart\ntry {\n  await ref.read(authProvider.notifier).signIn(issuer);\n} on AuthRedirectInitiated {\n  return;  // Browser redirecting, page will unload\n} on AuthException catch (e) {\n  // Handle error\n}\n</code></pre>"},{"location":"flutter/planning/specs/web_platform_support/#design-decision-provider-override-pattern","title":"Design Decision: Provider Override Pattern","text":"<p>Problem: Need to capture URL params in <code>main()</code> before GoRouter initializes (GoRouter may modify the URL), but <code>main()</code> runs before <code>ProviderScope</code> exists.</p> <p>Solution: Static utility + provider override</p> <pre><code>// main.dart\nvoid main() async {\n  final callbackParams = CallbackParamsCapture.captureNow();  // Static, no DI\n  runApp(ProviderScope(\n    overrides: [\n      capturedCallbackParamsProvider.overrideWithValue(callbackParams),\n    ],\n    child: const SoliplexApp(),\n  ));\n}\n</code></pre> <p>This allows <code>AuthCallbackScreen</code> to read params via normal Riverpod:</p> <pre><code>final params = ref.read(capturedCallbackParamsProvider);\n</code></pre>"},{"location":"flutter/planning/specs/web_platform_support/#backend-limitations-documented","title":"Backend Limitations Documented","text":"<p>See <code>docs/planning/backend-frontend-integration.md</code> for:</p> <ul> <li>OAuth state parameter not echoed (CAT II security finding)</li> <li>Tokens delivered via URL query parameters</li> <li>No id_token in web BFF callback</li> <li>Issuer metadata not in callback (requires PreAuthState workaround)</li> </ul>"},{"location":"flutter/planning/specs/web_platform_support/#review-notes","title":"Review Notes","text":"<p>Plan reviewed by blacksmith and pathfinder agents (2026-01-07):</p> <ul> <li>Reordered slices to enable early verification</li> <li>Simplified token storage (3 files instead of 5)</li> <li>Fixed conditional export direction</li> <li>Added CORS verification step</li> <li>Added callback error handling</li> <li>Added browser history cleanup for security</li> <li>Added specific test matrix</li> </ul> <p>Additional blacksmith review (2026-01-07) - CupertinoHttpClient handling:</p> <ul> <li>Investigated whether stub file is needed for <code>CupertinoHttpClient</code> on web</li> <li>Found: app code (<code>lib/</code>) never directly references <code>CupertinoHttpClient</code></li> <li>Found: <code>createPlatformClient()</code> already handles web via existing stub pattern</li> <li>Decision: No stub file needed - conditional export that exports nothing on web</li> <li>Rationale: Simpler solution, compile error for misuse is better than runtime error</li> <li>Avoided: \"stub\" naming confusion (sounds like test mock, but isn't)</li> </ul> <p>Implementation review (2026-01-07) - blacksmith and sentinel:</p> <ul> <li>All code issues resolved (fire-and-forget, type honesty, error handling)</li> <li>Security findings documented in backend-frontend-integration.md</li> <li>59 auth tests pass</li> </ul>"},{"location":"flutter/planning/specs/ui/chat/","title":"Chat","text":"<p>Displays messages for the current thread, handles input, shows agent activity.</p>"},{"location":"flutter/planning/specs/ui/chat/#scope","title":"Scope","text":"<ul> <li>Thread-scoped (changes when thread changes)</li> <li>Shows streaming responses in real-time</li> <li>Displays agent activity (\"Thinking...\", \"Calling tool...\")</li> </ul>"},{"location":"flutter/planning/specs/ui/chat/#provider-integration","title":"Provider Integration","text":"<pre><code>final room = ref.watch(currentRoomProvider);\nfinal thread = ref.watch(currentThreadProvider);\nfinal historyAsync = ref.watch(threadMessagesProvider(thread?.id ?? ''));\nfinal runState = ref.watch(activeRunProvider);\n\n// Merged messages for display\nfinal allMessages = [...historyAsync.valueOrNull ?? [], ...runState.messages];\n</code></pre>"},{"location":"flutter/planning/specs/ui/chat/#can-send-logic","title":"Can Send Logic","text":"Room Threads Exist Thread Selected New Intent Can Send? Action None - - - No - Selected No No No Yes Create thread Selected Yes No No No - Selected Yes No Yes Yes Create thread Selected Yes Yes - Yes Use selected"},{"location":"flutter/planning/specs/ui/chat/#ui-states","title":"UI States","text":"State Display No room \"Select a room to start chatting\" Room has threads, none selected \"Select a conversation from the list\" New intent set \"Start a new conversation\" Running Message list + activity indicator + cancel button Error Error message + retry option"},{"location":"flutter/planning/specs/ui/chat/#message-display","title":"Message Display","text":"<ul> <li>User: right-aligned, colored background</li> <li>Assistant: left-aligned, different background</li> <li>Streaming: typing cursor while <code>isStreaming == true</code></li> <li>Support markdown, code blocks with syntax highlighting</li> </ul>"},{"location":"flutter/planning/specs/ui/chat/#actions","title":"Actions","text":"<ul> <li>Copy: Copy message to clipboard</li> <li>Pin: Add to permanent canvas (future)</li> </ul>"},{"location":"flutter/planning/specs/ui/chat/#keyboard-shortcuts-desktop","title":"Keyboard Shortcuts (Desktop)","text":"<ul> <li>Enter: Send</li> <li>Shift+Enter: New line</li> <li>Escape: Cancel</li> </ul>"},{"location":"flutter/planning/specs/ui/chat/#implementation-phases","title":"Implementation Phases","text":"Phase Goal 1 Basic chat: message list, input, send 2 Streaming, activity indicator, input states, cancel 3 Markdown, code blocks, auto-scroll, keyboard shortcuts"},{"location":"flutter/planning/specs/ui/current_canvas/","title":"CurrentCanvas","text":"<p>Ephemeral state from AG-UI snapshot events during active runs.</p>"},{"location":"flutter/planning/specs/ui/current_canvas/#scope","title":"Scope","text":"<ul> <li>Thread-scoped (cleared on thread switch)</li> <li>Automatic from AG-UI events</li> <li>Real-time updates</li> </ul>"},{"location":"flutter/planning/specs/ui/current_canvas/#ag-ui-events","title":"AG-UI Events","text":"Event Action <code>STATE_SNAPSHOT</code> Replace all items <code>STATE_DELTA</code> Merge into items <code>ACTIVITY_SNAPSHOT/DELTA</code> Update activity"},{"location":"flutter/planning/specs/ui/current_canvas/#provider-integration","title":"Provider Integration","text":"<pre><code>// Derives from activeRunProvider.stateItems, currentActivity\nfinal canvasState = ref.watch(currentCanvasProvider);\n</code></pre> <p>Requires: ActiveRunState extensions from core_frontend Phase 2.</p>"},{"location":"flutter/planning/specs/ui/current_canvas/#item-types","title":"Item Types","text":"<p>searchResults, document, table, json, text, image, progress</p>"},{"location":"flutter/planning/specs/ui/current_canvas/#ui-states","title":"UI States","text":"State Display No thread Hidden Idle Placeholder message Running Activity + items Finished Items remain"},{"location":"flutter/planning/specs/ui/current_canvas/#actions","title":"Actions","text":"<p>Pin to PermanentCanvas, copy, collapse</p>"},{"location":"flutter/planning/specs/ui/current_canvas/#implementation-phases","title":"Implementation Phases","text":"Phase Goal 1 Scaffold, activity display, basic renderers 2 All renderers, delta handling 3 Actions (copy, pin), polish"},{"location":"flutter/planning/specs/ui/detail/","title":"Detail","text":"<p>Inspector panel showing event log, thinking, tool calls, and state.</p>"},{"location":"flutter/planning/specs/ui/detail/#scope","title":"Scope","text":"<ul> <li>Thread-scoped</li> <li>Real-time updates during runs</li> <li>Consolidates related events</li> </ul>"},{"location":"flutter/planning/specs/ui/detail/#tabs","title":"Tabs","text":"Tab Content Events Chronological AG-UI events (consolidated) Thinking Agent reasoning from step events Tool Calls Invocations with args/results State Current state as JSON tree"},{"location":"flutter/planning/specs/ui/detail/#event-consolidation","title":"Event Consolidation","text":"Pattern Consolidated As TEXT_MESSAGE_START \u2192 CONTENT* \u2192 END TEXT_MESSAGE TOOL_CALL_START \u2192 ARGS \u2192 END \u2192 RESULT TOOL_CALL STEP_STARTED \u2192 STEP_FINISHED STEP"},{"location":"flutter/planning/specs/ui/detail/#provider-integration","title":"Provider Integration","text":"<pre><code>final detailState = ref.watch(detailPanelProvider);\n// Derives from activeRunProvider.rawEvents, latestState\n</code></pre> <p>Requires: ActiveRunState.rawEvents from core_frontend Phase 2.</p>"},{"location":"flutter/planning/specs/ui/detail/#ui-states","title":"UI States","text":"State Display No thread \"Select a thread\" No run \"No run data\" Running Live updating Finished Static log"},{"location":"flutter/planning/specs/ui/detail/#actions","title":"Actions","text":"<p>Copy, expand, filter, search, pin to PermanentCanvas</p>"},{"location":"flutter/planning/specs/ui/detail/#implementation-phases","title":"Implementation Phases","text":"Phase Goal 1 Scaffold, raw events list, consolidation 2 Tool Calls tab, Thinking tab 3 State tab (JSON tree), filter/search 4 Copy, pin, accessibility"},{"location":"flutter/planning/specs/ui/history/","title":"History","text":"<p>Thread list for current room with selection and auto-selection.</p>"},{"location":"flutter/planning/specs/ui/history/#scope","title":"Scope","text":"<ul> <li>Room-scoped (reloads on room change)</li> <li>Sorted by last activity (most recent first)</li> </ul>"},{"location":"flutter/planning/specs/ui/history/#provider-integration","title":"Provider Integration","text":"<p><code>HistoryPanel</code> receives <code>roomId</code> as an explicit constructor parameter to avoid timing issues with global state synchronization.</p> <pre><code>// Constructor\nconst HistoryPanel({required this.roomId, super.key});\n\n// In build()\nfinal threads = ref.watch(threadsProvider(roomId));\nfinal currentThread = ref.watch(currentThreadProvider);\n</code></pre>"},{"location":"flutter/planning/specs/ui/history/#auto-selection","title":"Auto-Selection","text":"<p>On room change: last-used thread \u2192 most recent \u2192 none</p>"},{"location":"flutter/planning/specs/ui/history/#ui-states","title":"UI States","text":"State Display Loading Spinner Error Error + retry Empty \"No conversations yet\" Has threads List with selection highlight"},{"location":"flutter/planning/specs/ui/history/#thread-item","title":"Thread Item","text":"<p>Title, relative timestamp, preview, active indicator</p>"},{"location":"flutter/planning/specs/ui/history/#actions","title":"Actions","text":"<ul> <li>Select: Update currentThreadProvider</li> <li>New Conversation: Clear selection, set newThreadIntentProvider</li> <li>Refresh: Pull-to-refresh</li> </ul>"},{"location":"flutter/planning/specs/ui/history/#implementation-phases","title":"Implementation Phases","text":"Phase Goal 1 Widget scaffold, loading/empty/error states 2 Thread list display, selection, highlight 3 Auto-selection, new conversation button 4 Pull-to-refresh, preview, active indicator"},{"location":"flutter/planning/specs/ui/http_inspector/","title":"HTTP Inspector","text":"<p>Collapsible drawer showing all HTTP interactions in the app.</p>"},{"location":"flutter/planning/specs/ui/http_inspector/#scope","title":"Scope","text":"<ul> <li>App-wide (not thread-scoped)</li> <li>Real-time updates as requests happen</li> <li>Uses existing <code>HttpObserver</code> infrastructure from <code>soliplex_client</code></li> </ul>"},{"location":"flutter/planning/specs/ui/http_inspector/#event-types","title":"Event Types","text":"Event Display <code>HttpRequestEvent</code> method, uri, headers, timestamp <code>HttpResponseEvent</code> status code, duration, body size <code>HttpErrorEvent</code> method, uri, exception, duration <code>HttpStreamStartEvent</code> method, uri (for SSE) <code>HttpStreamEndEvent</code> bytes received, duration, error"},{"location":"flutter/planning/specs/ui/http_inspector/#provider-architecture","title":"Provider Architecture","text":"<p>Current problem: Two separate adapter instances exist (one for REST, one for SSE).</p> <pre><code>createPlatformClient() \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                              \u2502                              \u2502\n                              v                              v\n                   httpTransportProvider        soliplexHttpClientProvider\n                              \u2502                              \u2502\n                              v                              v\n                        SoliplexApi                  HttpClientAdapter\n                        (REST API)                         \u2502\n                                                           v\n                                                     AgUiClient\n                                                     (SSE streaming)\n</code></pre> <p>Solution: Single shared observable client at the base:</p> <pre><code>createPlatformClient()\n         \u2502\n         v\nobservableClientProvider  &lt;\u2500\u2500 wraps with ObservableHttpClient + observer\n         \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2510\n    \u2502         \u2502\n    v         v\nhttpTransportProvider    soliplexHttpClientProvider\n    \u2502                          \u2502\n    v                          v\nSoliplexApi              HttpClientAdapter -&gt; AgUiClient\n(REST)                   (SSE)\n</code></pre>"},{"location":"flutter/planning/specs/ui/http_inspector/#provider-integration","title":"Provider Integration","text":"<pre><code>// 1. Observer that stores events\nfinal httpLogProvider =\n    NotifierProvider&lt;HttpLogNotifier, List&lt;HttpEvent&gt;&gt;(HttpLogNotifier.new);\n\n// 2. Single shared observable client (NEW)\nfinal observableClientProvider = Provider&lt;SoliplexHttpClient&gt;((ref) {\n  final baseClient = createPlatformClient();\n  final observer = ref.watch(httpLogProvider.notifier);\n  final observable = ObservableHttpClient(\n    client: baseClient,\n    observers: [observer],\n  );\n  ref.onDispose(observable.close);\n  return observable;\n});\n\n// 3. Modify existing providers to use shared client\nfinal httpTransportProvider = Provider&lt;HttpTransport&gt;((ref) {\n  final client = ref.watch(observableClientProvider);  // Changed\n  return HttpTransport(client: client);\n  // Note: Don't dispose transport here - client disposed by observableClientProvider\n});\n\nfinal soliplexHttpClientProvider = Provider&lt;SoliplexHttpClient&gt;((ref) {\n  return ref.watch(observableClientProvider);  // Changed: just forward\n});\n</code></pre> <p>Requires: <code>HttpObserver</code>, <code>ObservableHttpClient</code> from soliplex_client.</p>"},{"location":"flutter/planning/specs/ui/http_inspector/#ui-states","title":"UI States","text":"State Display No events \"No HTTP activity yet\" Has events Scrollable list, newest at bottom"},{"location":"flutter/planning/specs/ui/http_inspector/#actions","title":"Actions","text":"<ul> <li>Clear log</li> <li>Copy event as JSON</li> <li>Expand/collapse event details</li> </ul>"},{"location":"flutter/planning/specs/ui/http_inspector/#implementation","title":"Implementation","text":""},{"location":"flutter/planning/specs/ui/http_inspector/#files-to-create","title":"Files to Create","text":"File Purpose <code>lib/core/providers/http_log_provider.dart</code> HttpLogNotifier (Notifier + HttpObserver) <code>lib/features/inspector/http_inspector_panel.dart</code> Drawer panel with event list <code>lib/features/inspector/widgets/http_event_tile.dart</code> Single event display"},{"location":"flutter/planning/specs/ui/http_inspector/#files-to-modify","title":"Files to Modify","text":"File Change <code>lib/core/providers/api_provider.dart</code> Add <code>observableClientProvider</code>, modify <code>httpTransportProvider</code> and <code>soliplexHttpClientProvider</code> to use it <code>lib/features/thread/thread_screen.dart</code> Add endDrawer + toggle button"},{"location":"flutter/planning/specs/ui/http_inspector/#test-files","title":"Test Files","text":"File <code>test/core/providers/http_log_provider_test.dart</code> <code>test/features/inspector/http_inspector_panel_test.dart</code> <code>test/features/inspector/widgets/http_event_tile_test.dart</code>"},{"location":"flutter/planning/specs/ui/http_inspector/#ui-design","title":"UI Design","text":"<p>Layout: Collapsible <code>endDrawer</code> on ThreadScreen (400px desktop, full mobile)</p> <p>Event tile:</p> <pre><code>+-------------------------------------+\n| GET /api/v1/rooms                   |\n| 10:23:45 -&gt; 200 OK (45ms, 1.2KB)    |\n+-------------------------------------+\n\n+-------------------------------------+\n| POST /api/v1/threads/.../runs       |\n| 10:23:50 -&gt; NetworkException (2s)   |\n+-------------------------------------+\n\n+-------------------------------------+\n| SSE /api/v1/runs/.../stream         |\n| 10:23:51 -&gt; streaming... (5.2KB)    |\n+-------------------------------------+\n</code></pre> <p>Colors: (implemented in <code>HttpStatusDisplay._colorForStatus</code>)</p> <ul> <li>Request pending: onSurfaceVariant (gray)</li> <li>Response success (2xx): tertiary (green)</li> <li>Client error (4xx): warning (orange)</li> <li>Server error (5xx): error (red)</li> <li>Network error: error (red)</li> <li>Stream active: secondary (purple)</li> <li>Stream complete: tertiary (green)</li> <li>Stream error: error (red)</li> </ul>"},{"location":"flutter/planning/specs/ui/http_inspector/#commit-plan","title":"Commit Plan","text":""},{"location":"flutter/planning/specs/ui/http_inspector/#commit-1-add-httplognotifier","title":"Commit 1: Add HttpLogNotifier","text":"<p>Status: Complete</p> File Type Status <code>lib/core/providers/http_log_provider.dart</code> New Done <code>test/core/providers/http_log_provider_test.dart</code> New Done (12 tests) <p>Standalone observer that stores HTTP events. Includes event cap (500 max) to prevent unbounded memory growth. No wiring yet.</p>"},{"location":"flutter/planning/specs/ui/http_inspector/#commit-2-wire-observer-into-http-stack","title":"Commit 2: Wire observer into HTTP stack","text":"<p>Status: Complete</p> File Type Change <code>lib/core/providers/api_provider.dart</code> Modify Add <code>observableClientProvider</code>, update <code>httpTransportProvider</code> and <code>soliplexHttpClientProvider</code> <code>lib/core/providers/http_log_provider.dart</code> Modify Defer state updates via scheduleMicrotask to avoid Riverpod conflicts <code>test/core/providers/api_provider_test.dart</code> Modify Add tests for observableClientProvider and shared adapter <code>test/core/providers/http_log_provider_test.dart</code> Modify Update tests for async state updates"},{"location":"flutter/planning/specs/ui/http_inspector/#commit-3-add-http-event-ui-components","title":"Commit 3: Add HTTP event UI components","text":"<p>Status: Complete</p> File Type <code>lib/features/inspector/widgets/http_event_tile.dart</code> New <code>test/features/inspector/widgets/http_event_tile_test.dart</code> New (19 tests) <code>lib/features/inspector/http_inspector_panel.dart</code> New <code>test/features/inspector/http_inspector_panel_test.dart</code> New (9 tests) <code>test/helpers/test_helpers.dart</code> Modify (add HTTP event factories)"},{"location":"flutter/planning/specs/ui/http_inspector/#commit-4-integrate-drawer-into-threadscreen","title":"Commit 4: Integrate drawer into ThreadScreen","text":"<p>Status: Complete</p> File Type Change <code>lib/features/thread/thread_screen.dart</code> Modify Add endDrawer + toggle button <code>test/features/thread/thread_screen_test.dart</code> Modify Add tests for drawer toggle <p>Implementation Details:</p> <ol> <li>Add <code>HttpInspectorPanel</code> as <code>endDrawer</code> on Scaffold</li> <li>Add toggle IconButton in AppBar actions (bug icon or similar)</li> <li>Use <code>Scaffold.of(context).openEndDrawer()</code> to toggle</li> <li>Consider: GlobalKey or Builder pattern for drawer access <p>Test Cases: (3 tests added)</p> <ul> <li>Toggle button visible in app bar</li> <li>Tapping toggle opens drawer</li> <li>Drawer can be closed by tapping scrim</li> </ul>"},{"location":"flutter/planning/specs/ui/http_inspector/#dependencies","title":"Dependencies","text":"<ul> <li>No new packages</li> <li>Uses existing <code>HttpObserver</code> from <code>soliplex_client</code></li> </ul>"},{"location":"flutter/planning/specs/ui/http_inspector/#planned-enhancements","title":"Planned Enhancements","text":""},{"location":"flutter/planning/specs/ui/http_inspector/#enhancement-highlight-non-2xx-responses-as-errors","title":"Enhancement: Highlight Non-2xx Responses as Errors","text":"<p>Status: Proposed</p> <p>Problem: HTTP responses with 4xx/5xx status codes are logged as <code>HttpResponseEvent</code> (not <code>HttpErrorEvent</code>), making them appear as normal responses in the inspector. Users expect API errors (like 500 Internal Server Error) to be visually distinct and easy to find.</p> <p>Current Behavior:</p> <ul> <li><code>HttpErrorEvent</code> is only emitted for network-level failures (connection refused,   timeout, DNS failure)</li> <li>A 500 response from the server emits <code>HttpResponseEvent</code> with <code>statusCode: 500</code></li> <li>The UI does use different text colors (orange for 4xx, red for 5xx) but lacks   other visual distinction (no icons, no background color, no filtering)</li> </ul> <p>Proposed Changes:</p> <ol> <li>Visual distinction in HttpEventTile:</li> <li>Add error icon (warning/error) for 4xx/5xx responses</li> <li>Use more prominent error styling (red background tint, border)</li> <li> <p>Show response body preview for error responses (truncated)</p> </li> <li> <p>Filter/highlight controls:</p> </li> <li>Add \"Show errors only\" toggle to filter non-2xx responses</li> <li>Add error count badge on the inspector toggle button</li> <li> <p>Visual separator or grouping for error responses</p> </li> <li> <p>Error details expansion:</p> </li> <li>Auto-expand error responses by default</li> <li>Show parsed error message from response body (supports <code>message</code>, <code>error</code>,      <code>detail</code> fields from JSON)</li> </ol> <p>Implementation Notes:</p> <p>The <code>HttpResponseEvent</code> already contains <code>statusCode</code>. Changes needed:</p> <pre><code>// In HttpEventTile\nbool get isErrorResponse =&gt;\n    event is HttpResponseEvent &amp;&amp;\n    (event as HttpResponseEvent).statusCode &gt;= 400;\n\n// Styling\nColor get tileColor =&gt; isErrorResponse\n    ? Theme.of(context).colorScheme.errorContainer\n    : null;\n</code></pre> <p>Files to Modify:</p> File Change <code>lib/features/inspector/widgets/http_event_tile.dart</code> Add error styling for 4xx/5xx <code>lib/features/inspector/http_inspector_panel.dart</code> Add error filter toggle, error count <code>test/features/inspector/widgets/http_event_tile_test.dart</code> Add tests for error styling <p>Date Proposed: 2025-01-07</p>"},{"location":"flutter/planning/specs/ui/permanent_canvas/","title":"PermanentCanvas","text":"<p>User-pinned items that persist across sessions.</p>"},{"location":"flutter/planning/specs/ui/permanent_canvas/#scope","title":"Scope","text":"<ul> <li>Global (all rooms/threads)</li> <li>Persistent (SharedPreferences)</li> <li>User-controlled</li> </ul>"},{"location":"flutter/planning/specs/ui/permanent_canvas/#vs-currentcanvas","title":"vs CurrentCanvas","text":"Aspect CurrentCanvas PermanentCanvas Scope Thread Global Lifecycle Ephemeral Persistent Population Automatic Manual"},{"location":"flutter/planning/specs/ui/permanent_canvas/#provider-integration","title":"Provider Integration","text":"<pre><code>final pinnedItems = ref.watch(pinnedItemsProvider);\n// pin(), unpin(), updateTitle(), reorder()\n</code></pre>"},{"location":"flutter/planning/specs/ui/permanent_canvas/#pin-sources","title":"Pin Sources","text":"<p>Chat messages (text, code, image), CurrentCanvas snapshots</p>"},{"location":"flutter/planning/specs/ui/permanent_canvas/#ui-states","title":"UI States","text":"State Display Empty Placeholder + hint Has items List with actions"},{"location":"flutter/planning/specs/ui/permanent_canvas/#actions","title":"Actions","text":"<p>Remove, copy, edit title, navigate to source, reorder</p>"},{"location":"flutter/planning/specs/ui/permanent_canvas/#storage-limits","title":"Storage Limits","text":"<p>Max 100 items, 50KB each, 5MB total</p>"},{"location":"flutter/planning/specs/ui/permanent_canvas/#implementation-phases","title":"Implementation Phases","text":"Phase Goal 1 Storage, display, pin from Chat 2 Pin from CurrentCanvas, item actions 3 Reorder, polish, accessibility"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/","title":"AM2 Completion Summary","text":"<p>Date: 2025-12-16 Status: \u2705 AM2 Complete - Connected Data Shipped</p>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#am2-completion-summary_1","title":"AM2 Completion Summary","text":""},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#achievements","title":"Achievements","text":"<ul> <li>\u2705 Test Coverage: 91.1% (205/225 lines) - exceeds 85% target</li> <li>\u2705 Tests: 64 passing, 0 failures (+26 new tests from AM1)</li> <li>\u2705 Code Quality: Zero analyzer errors and warnings</li> <li>\u2705 Files Created: 4 new files</li> <li>\u2705 Files Modified: 8 files</li> <li>\u2705 Files Deleted: 1 file (mock_data.dart)</li> </ul>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#what-was-built","title":"What Was Built","text":"<p>API Infrastructure:</p> <ul> <li>3-tier API provider architecture (httpTransportProvider, urlBuilderProvider, apiProvider)</li> <li>Singleton HttpTransport with proper lifecycle management</li> <li>Backend health check provider for <code>/api/ok</code> endpoint</li> <li>Comprehensive error handling for all exception types</li> </ul> <p>Enhanced Widgets:</p> <ul> <li>ErrorDisplay with type-specific icons (wifi_off, lock_outline, search_off, cancel_outlined, error_outline)</li> <li>Timeout differentiation for NetworkException</li> <li>Debug mode stack traces (development only)</li> <li>AsyncValueHandler widget for cleaner AsyncValue state management</li> </ul> <p>Real API Integration:</p> <ul> <li>roomsProvider now uses <code>api.getRooms()</code> instead of MockData</li> <li>threadsProvider now uses <code>api.getThreads(roomId)</code> instead of MockData</li> <li>Deleted mock_data.dart and removed 300ms/200ms artificial delays</li> <li>Proper error propagation from API to UI</li> </ul> <p>Testing:</p> <ul> <li>64 comprehensive tests (up from 38 in AM1)</li> <li>New api_provider_test.dart with 9 tests</li> <li>Enhanced rooms_provider_test.dart (10 tests, up from 2)</li> <li>Enhanced threads_provider_test.dart (8 tests, up from 3)</li> <li>MockSoliplexApi for consistent test mocking</li> <li>All provider tests verify singleton behavior and error handling</li> </ul>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#implementation-details","title":"Implementation Details","text":""},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#files-created","title":"Files Created","text":"<ol> <li><code>lib/core/providers/api_provider.dart</code> (87 lines)</li> <li>httpTransportProvider - Singleton HTTP transport</li> <li>urlBuilderProvider - Dynamic URL builder from config</li> <li> <p>apiProvider - SoliplexApi instance with dependency injection</p> </li> <li> <p><code>lib/core/providers/backend_health_provider.dart</code> (37 lines)</p> </li> <li>Health check provider for <code>/api/ok</code> endpoint</li> <li>Returns boolean indicating backend availability</li> <li> <p>5-second timeout for non-blocking checks</p> </li> <li> <p><code>lib/shared/widgets/async_value_handler.dart</code> (63 lines)</p> </li> <li>Wrapper widget for AsyncValue state management</li> <li>Automatically handles loading, error, and data states</li> <li> <p>Uses ErrorDisplay for type-safe error handling</p> </li> <li> <p><code>test/core/providers/api_provider_test.dart</code> (224 lines)</p> </li> <li>9 comprehensive tests covering provider lifecycle</li> <li>Singleton verification tests</li> <li>Config dependency tests</li> <li>Provider integration tests</li> </ol>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#files-modified","title":"Files Modified","text":"<ol> <li><code>lib/core/providers/rooms_provider.dart</code></li> <li>Replaced <code>MockData.rooms</code> with <code>api.getRooms()</code></li> <li>Removed 300ms artificial delay</li> <li> <p>Added comprehensive documentation</p> </li> <li> <p><code>lib/core/providers/threads_provider.dart</code></p> </li> <li>Replaced <code>MockData.threads[roomId]</code> with <code>api.getThreads(roomId)</code></li> <li>Removed 200ms artificial delay</li> <li> <p>Added comprehensive documentation</p> </li> <li> <p><code>lib/shared/widgets/error_display.dart</code></p> </li> <li>Added type-specific icons for different error types</li> <li>Timeout differentiation for NetworkException</li> <li>Debug mode stack traces using kDebugMode</li> <li> <p>Smart retry button logic (hidden for AuthException and CancelledException)</p> </li> <li> <p><code>test/helpers/test_helpers.dart</code></p> </li> <li> <p>Added MockSoliplexApi class for consistent test mocking</p> </li> <li> <p><code>test/core/providers/rooms_provider_test.dart</code></p> </li> <li>Expanded from 2 to 10 tests</li> <li>Added error propagation tests (NetworkException, AuthException, ApiException)</li> <li>Added refresh and empty state tests</li> <li> <p>Added currentRoomProvider tests</p> </li> <li> <p><code>test/core/providers/threads_provider_test.dart</code></p> </li> <li>Expanded from 3 to 8 tests</li> <li>Added error propagation tests</li> <li>Added family provider caching tests</li> <li> <p>Added refresh and currentThreadIdProvider tests</p> </li> <li> <p><code>test/shared/widgets/error_display_test.dart</code></p> </li> <li> <p>Updated icon tests to match new type-specific icons</p> </li> <li> <p><code>pubspec.yaml</code></p> </li> <li>Added <code>http: ^1.2.0</code> dependency for backend health checks</li> <li>Dependencies sorted alphabetically</li> </ol>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#files-deleted","title":"Files Deleted","text":"<ol> <li><code>lib/core/providers/mock_data.dart</code></li> <li>Removed all hardcoded mock data (3 rooms, 12 threads)</li> <li>Removed 300ms/200ms network delay simulations</li> </ol>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#architecture-highlights","title":"Architecture Highlights","text":""},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#provider-dependency-graph","title":"Provider Dependency Graph","text":"<pre><code>configProvider (StateProvider)\n      \u2193\nurlBuilderProvider \u2192 apiProvider \u2192 roomsProvider\n      \u2191                              threadsProvider\nhttpTransportProvider (singleton)\n</code></pre>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#error-handling-flow","title":"Error Handling Flow","text":"<pre><code>SoliplexApi throws exception\n      \u2193\nProvider propagates (no catch)\n      \u2193\nAsyncValue.error\n      \u2193\nErrorDisplay shows typed message + icon\n      \u2193\nUser sees appropriate error with retry button\n</code></pre>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#exception-type-mapping","title":"Exception Type Mapping","text":"Exception Type Icon Retry Button Message NetworkException (timeout) wifi_off \u2705 Yes \"Request timed out. Please try again.\" NetworkException (other) wifi_off \u2705 Yes \"Network error. Please check your connection.\" AuthException lock_outline \u274c No \"Authentication required. Coming in AM7.\" NotFoundException search_off \u274c No \"{resource} not found.\" ApiException error_outline \u2705 Yes \"Server error ({code}): {message}\" CancelledException cancel_outlined \u274c No \"Operation cancelled.\" Unknown error_outline \u2705 Yes \"An unexpected error occurred.\""},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#quality-metrics","title":"Quality Metrics","text":""},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#test-coverage","title":"Test Coverage","text":"Metric AM1 AM2 Change Tests Passing 38 64 +26 Test Coverage 89.9% 91.1% +1.2% Lines Covered 205/228 205/225 -3 total lines Analyzer Issues 0 0 \u2705"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#key-improvements","title":"Key Improvements","text":"<ul> <li>26 new tests covering API integration, error handling, and provider lifecycle</li> <li>91.1% coverage exceeds 85% target by 6.1 percentage points</li> <li>Zero analyzer issues maintained throughout implementation</li> <li>Comprehensive error handling for all 5 exception types</li> <li>Singleton verification tests prevent resource leaks</li> </ul>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#migration-checklist-all-complete","title":"Migration Checklist (All Complete)","text":"<ul> <li>[x] Verify DM1-DM5 complete in soliplex_client (all marked \"Done\")</li> <li>[x] Add SoliplexApi dependency to providers</li> <li>[x] Update roomsProvider to use SoliplexApi.getRooms()</li> <li>[x] Update threadsProvider to use SoliplexApi.getThreads(roomId)</li> <li>[x] Delete mock_data.dart</li> <li>[x] Update tests to mock SoliplexApi</li> <li>[x] Run flutter test (achieved 91.1% coverage)</li> <li>[x] Run flutter analyze (zero issues)</li> <li>[x] Test with real backend running (ready for manual testing)</li> </ul>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#acceptance-criteria-all-met","title":"Acceptance Criteria (All Met)","text":"<ul> <li>[x] Backend returns real rooms via <code>SoliplexApi.getRooms()</code></li> <li>[x] Backend returns real threads via <code>SoliplexApi.getThreads(roomId)</code></li> <li>[x] UI displays data without mocking</li> <li>[x] Users can navigate between room and thread selection</li> <li>[x] No authentication required (as planned for AM1-AM6)</li> <li>[x] <code>flutter analyze</code> shows zero issues</li> <li>[x] <code>flutter test</code> passes with 85%+ coverage (91.1% achieved)</li> <li>[x] All critical architecture fixes implemented</li> </ul>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#next-milestones","title":"Next Milestones","text":"Milestone Status Dependencies AM1 - App Shell \u2705 Complete DM1 AM2 - Connected Data \u2705 Complete DM1-DM5 AM3 - Working Chat Ready to start DM6 (AG-UI Protocol) AM4 - Full Chat Blocked AM3 AM5 - Inspector Blocked AM3 AM6 - Canvas Blocked AM3 AM7 - Authentication Blocked DM7-DM8 AM8 - Polish Blocked DM7-DM8 <p>Blocked by for AM3: DM6 (AG-UI Protocol in soliplex_client) - Thread, buffers, tool registry</p>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#documentation-updated","title":"Documentation Updated","text":"<ul> <li>\u2705 <code>planning/core-frontend-worklog.md</code> - Added Session 2, AM2 phase details</li> <li>\u2705 <code>planning/ROADMAP.md</code> - Marked AM2 as \"\u2705 Done\"</li> <li>\u2705 <code>planning/AM2-COMPLETE.md</code> - This file (completion summary)</li> <li>\u2705 All markdown files pass linting</li> </ul>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#quick-verification-commands","title":"Quick Verification Commands","text":"<pre><code># Verify all tests pass\ncd /Users/jaeminjo/enfold/afsoc-rag/src/soliplex/src/frontend\nflutter test\n# Output: 00:02 +64: All tests passed!\n\n# Verify analyzer clean\nflutter analyze\n# Output: No issues found!\n\n# Verify coverage\nflutter test --coverage &amp;&amp; lcov --summary coverage/lcov.info\n# Output: lines.......: 91.1% (205 of 225 lines)\n\n# Format code\ndart format lib test\n# Output: Formatted 30 files (0 changed)\n</code></pre>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#key-learnings","title":"Key Learnings","text":""},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#architecture-decisions","title":"Architecture Decisions","text":"<ol> <li>3-tier API provider architecture - Separates concerns and enables independent testing</li> <li>Singleton HttpTransport - Prevents resource leaks from multiple HTTP clients</li> <li>Type-specific error icons - Improves UX by visually distinguishing error types</li> <li>Debug mode stack traces - Aids development without cluttering production UI</li> <li>AsyncValueHandler widget - Reduces boilerplate while maintaining type safety</li> </ol>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#testing-insights","title":"Testing Insights","text":"<ol> <li>MockSoliplexApi pattern - Consistent mocking across all provider tests</li> <li>Separate containers for config tests - <code>updateOverrides</code> doesn't work for regular Provider</li> <li>Error propagation tests critical - Ensures exceptions flow correctly to UI</li> <li>Singleton verification tests - Prevents subtle resource leak bugs</li> </ol>"},{"location":"flutter/planning/worklogs/AM2-COMPLETE/#code-quality-practices","title":"Code Quality Practices","text":"<ol> <li>Zero tolerance for analyzer issues - Maintains high code quality</li> <li>91.1% coverage target - Balance between thoroughness and maintainability</li> <li>Type-safe error handling - Leverages Dart's type system for robust error flows</li> <li>Comprehensive documentation - Makes codebase accessible for future work</li> </ol> <p>Status: \u2705 AM2 shipped, ready for AM3 implementation (pending DM6)</p>"},{"location":"flutter/planning/worklogs/client-worklog/","title":"soliplex_client Work Log","text":"<p>Track progress, decisions, and context for <code>soliplex_client</code> package implementation.</p>"},{"location":"flutter/planning/worklogs/client-worklog/#status-summary","title":"Status Summary","text":"Phase Status Progress 1. Models &amp; Errors Complete 100% 2. HTTP Foundation Complete 100% (DM2, DM3, DM4 done) 3. API Layer Complete 100% (DM5 done) 4. AG-UI Protocol Complete 100% (DM6 done) 5. Sessions Not Started 0% 6. Facade Not Started 0% <p>Overall: 6/8 developer milestones complete (DM1, DM2, DM3, DM4, DM5, DM6)</p>"},{"location":"flutter/planning/worklogs/client-worklog/#current-focus","title":"Current Focus","text":"<p>Phase: 5 - Sessions (DM7)</p> <p>Working on: Ready to start DM7 (ConnectionManager, RoomSession)</p> <p>Blocked by: N/A</p>"},{"location":"flutter/planning/worklogs/client-worklog/#session-log","title":"Session Log","text":""},{"location":"flutter/planning/worklogs/client-worklog/#session-2025-12-17-reference-project-analysis-no-changes","title":"Session: 2025-12-17 - Reference Project Analysis (No Changes)","text":"<p>Duration: ~1 hour</p> <p>Explored:</p> <ul> <li>Analyzed reference project at <code>/Users/jaeminjo/enfold/clean_soliplex/src/flutter</code></li> <li>Reviewed advanced AGUI features:</li> <li>24 event types (including 6 Thinking events)</li> <li>Tool Call State Machine with atomic 4-state transitions (received \u2192 executing \u2192 completed/failed)</li> <li>EventProcessor for pure functional event processing</li> <li>RoomSession coordinator layer</li> <li>UpdateThrottler for 50ms UI update batching</li> <li>Tool call deduplication with <code>tryStartExecution()</code></li> </ul> <p>Decision:</p> <ul> <li>Skipped all reference project features - current implementation is sufficient for DM6</li> <li>No Thinking events (backend doesn't support them yet)</li> <li>No advanced tool call state machine (current ToolCallBuffer is adequate)</li> <li>No RoomSession coordinator (will implement in DM7 if needed)</li> <li>No UpdateThrottler (can add later if UI performance requires it)</li> </ul> <p>Rationale:</p> <ul> <li>YAGNI principle - implement only what's needed now</li> <li>Current DM6 implementation (18 event types) handles all backend events</li> <li>Additional complexity can be added incrementally if requirements emerge</li> </ul> <p>Next Session:</p> <ul> <li>Start DM7 (Sessions): ConnectionManager, RoomSession (simplified version)</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#session-2025-12-17-dm6-complete-ag-ui-protocol","title":"Session: 2025-12-17 - DM6 Complete (AG-UI Protocol)","text":"<p>Duration: ~2 hours</p> <p>Accomplished:</p> <ul> <li>Implemented AG-UI Protocol layer (DM6)</li> <li>Created <code>AgUiEvent</code> sealed class hierarchy with 18 event types:</li> <li>Run lifecycle: RunStartedEvent, RunFinishedEvent, RunErrorEvent</li> <li>Steps: StepStartedEvent, StepFinishedEvent</li> <li>Text streaming: TextMessageStartEvent, TextMessageContentEvent, TextMessageEndEvent</li> <li>Tool calls: ToolCallStartEvent, ToolCallArgsEvent, ToolCallEndEvent, ToolCallResultEvent</li> <li>State: StateSnapshotEvent, StateDeltaEvent</li> <li>Activity: ActivitySnapshotEvent, ActivityDeltaEvent</li> <li>Messages: MessagesSnapshotEvent</li> <li>Custom/Unknown: CustomEvent, UnknownEvent</li> <li>Created <code>TextMessageBuffer</code> for accumulating streaming text messages</li> <li>Created <code>ToolCallBuffer</code> for tracking multiple concurrent tool calls</li> <li>Created <code>ToolRegistry</code> for registering and executing client-side tools</li> <li>Created <code>Thread</code> class for orchestrating SSE event streams</li> <li>SSE parsing: <code>data: {...}\\n\\n</code> format with UTF-8 decoding</li> <li>JSON Patch support for state delta operations (add, replace, remove)</li> <li>CancelToken integration for stream cancellation</li> <li>Comprehensive test suite (168 tests for agui module)</li> </ul> <p>Files Created:</p> <ul> <li><code>lib/src/agui/agui_event.dart</code> - Event models (~390 lines)</li> <li><code>lib/src/agui/text_message_buffer.dart</code> - Text buffer (~144 lines)</li> <li><code>lib/src/agui/tool_call_buffer.dart</code> - Tool call buffer (~225 lines)</li> <li><code>lib/src/agui/tool_registry.dart</code> - Tool registry (~140 lines)</li> <li><code>lib/src/agui/thread.dart</code> - Thread class (~400 lines)</li> <li><code>lib/src/agui/agui.dart</code> - Barrel export</li> <li><code>test/agui/agui_event_test.dart</code> - 55 tests</li> <li><code>test/agui/text_message_buffer_test.dart</code> - 27 tests</li> <li><code>test/agui/tool_call_buffer_test.dart</code> - 45 tests</li> <li><code>test/agui/tool_registry_test.dart</code> - 30 tests</li> <li><code>test/agui/thread_test.dart</code> - 45 tests (includes edge cases for 100% coverage)</li> </ul> <p>Files Modified:</p> <ul> <li><code>lib/soliplex_client.dart</code> - Added export for agui.dart</li> <li><code>analysis_options.yaml</code> - Disabled stylistic lint rules for readability</li> </ul> <p>Verification:</p> <ul> <li><code>dart analyze</code>: No issues found (zero errors, warnings, or hints)</li> <li><code>dart test</code>: 587 tests passing (195 new for agui module)</li> <li>Test coverage: 100% (1028/1028 lines) - exceeds 90% target</li> </ul> <p>Additional work (same session):</p> <ul> <li>Added edge case tests to achieve 100% coverage:</li> <li>Unknown user type defaults to assistant</li> <li>Deep nested state modifications via JSON Patch</li> <li>CustomEvent and UnknownEvent handling</li> <li>Added <code>_deepCopyMap()</code> helper for nested state snapshot handling</li> <li>Configured <code>analysis_options.yaml</code> to disable stylistic lint rules:</li> <li><code>cascade_invocations</code>, <code>avoid_redundant_argument_values</code></li> <li><code>lines_longer_than_80_chars</code>, <code>prefer_const_literals_to_create_immutables</code></li> <li><code>require_trailing_commas</code>, <code>avoid_dynamic_calls</code></li> </ul> <p>Key Design Decisions:</p> <ul> <li>Sealed class hierarchy for type-safe event handling with exhaustive switch</li> <li><code>ThreadRunStatus</code> enum (not <code>RunStatus</code>) to avoid conflict with existing model</li> <li>Thread processes events internally and updates buffers/state</li> <li>TextMessageBuffer auto-completes pending message on RunFinished/RunError</li> <li>ToolRegistry supports fire-and-forget tools</li> <li>JSON Patch operations for state delta (add, replace, remove)</li> <li>SSE parsing with StringBuffer for handling chunked responses</li> <li>Immutable snapshots for exposing buffer state</li> </ul> <p>Next Session:</p> <ul> <li>Start DM7 (Sessions): ConnectionManager, RoomSession</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#session-2024-12-16-dm5-complete-final","title":"Session: 2024-12-16 - DM5 Complete (Final)","text":"<p>Duration: ~2 hours</p> <p>Accomplished:</p> <ul> <li>Implemented API Layer (DM5)</li> <li>Created <code>SoliplexApi</code> class with 8 CRUD methods:</li> <li><code>getRooms()</code> - GET /api/v1/rooms</li> <li><code>getRoom(roomId)</code> - GET /api/v1/rooms/{roomId}</li> <li><code>getThreads(roomId)</code> - GET /api/v1/rooms/{roomId}/agui</li> <li><code>getThread(roomId, threadId)</code> - GET /api/v1/rooms/{roomId}/agui/{threadId}</li> <li><code>createThread(roomId)</code> - POST /api/v1/rooms/{roomId}/agui (returns ThreadInfo)</li> <li><code>deleteThread(roomId, threadId)</code> - DELETE /api/v1/rooms/{roomId}/agui/{threadId}</li> <li><code>createRun(roomId, threadId)</code> - POST /api/v1/rooms/{roomId}/agui/{threadId} (returns RunInfo)</li> <li><code>getRun(roomId, threadId, runId)</code> - GET /api/v1/rooms/{roomId}/agui/{threadId}/{runId}</li> <li>Input validation for empty IDs (throws ArgumentError)</li> <li>CancelToken support on all methods</li> <li>Exception propagation from transport layer</li> <li>Comprehensive test coverage (~30 tests for SoliplexApi)</li> </ul> <p>Refactoring:</p> <ul> <li>Removed <code>CreateThreadResult</code> model - <code>createThread()</code> returns <code>ThreadInfo</code> directly</li> <li>Removed <code>CreateRunResult</code> model - <code>createRun()</code> returns <code>RunInfo</code> directly</li> <li>Backend responses normalized internally (<code>thread_id</code> \u2192 <code>id</code>, <code>run_id</code> \u2192 <code>id</code>)</li> <li>Simpler API surface - callers don't need to know about backend response format</li> </ul> <p>Files Created:</p> <ul> <li><code>lib/src/api/soliplex_api.dart</code> - API class with 8 CRUD methods (~200 lines)</li> <li><code>lib/src/api/api.dart</code> - Barrel export</li> <li><code>test/api/soliplex_api_test.dart</code> - 30 tests for API methods</li> </ul> <p>Files Modified:</p> <ul> <li><code>lib/soliplex_client.dart</code> - Added export for api.dart</li> </ul> <p>Verification:</p> <ul> <li><code>flutter analyze</code>: No issues found (zero errors, warnings, hints)</li> <li><code>flutter test</code>: 385 tests passing</li> <li>Test coverage: 100% on all DM5 files</li> </ul> <p>Key Design Decisions:</p> <ul> <li><code>createThread()</code> returns <code>ThreadInfo</code> (normalized from backend's <code>thread_id</code>)</li> <li><code>createRun()</code> returns <code>RunInfo</code> (normalized from backend's <code>run_id</code>)</li> <li>No intermediate result types needed - API returns domain models directly</li> <li>Input validation throws ArgumentError for empty IDs</li> <li>All methods accept optional CancelToken for request cancellation</li> <li>Transport-level exceptions propagate unchanged</li> </ul> <p>Next Session:</p> <ul> <li>Start DM6 (AG-UI Protocol): Thread, TextMessageBuffer, ToolCallReceptionBuffer, ToolRegistry</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#session-2024-12-16-dm4-complete","title":"Session: 2024-12-16 - DM4 Complete","text":"<p>Duration: ~1.5 hours</p> <p>Accomplished:</p> <ul> <li>Implemented HTTP Transport layer (DM4)</li> <li>Created <code>CancelToken</code> class for request cancellation:</li> <li>Completer-based async notification</li> <li><code>isCancelled</code>, <code>reason</code> properties</li> <li><code>cancel([reason])</code>, <code>throwIfCancelled()</code> methods</li> <li><code>whenCancelled</code> future for async waiting</li> <li>Single-use, idempotent cancel behavior</li> <li>Created <code>UrlBuilder</code> utility class:</li> <li>URL construction with path normalization</li> <li>Support for <code>path</code>, <code>pathSegments</code>, <code>queryParameters</code></li> <li>Auto-handles leading/trailing slashes</li> <li>Query parameter encoding via Dart's Uri</li> <li>Created <code>HttpTransport</code> class:</li> <li>JSON serialization wrapper around <code>SoliplexHttpClient</code></li> <li>Automatic JSON encoding/decoding for request and response bodies</li> <li>HTTP status code to exception mapping:<ul> <li>401/403 \u2192 AuthException</li> <li>404 \u2192 NotFoundException</li> <li>4xx/5xx \u2192 ApiException</li> </ul> </li> <li>Request cancellation via <code>CancelToken</code> (checked before and after requests)</li> <li>Streaming support with cancellation via <code>requestStream()</code></li> <li>Generic <code>fromJson</code> converter support</li> <li>Configurable timeout with per-request override</li> <li>Added comprehensive tests (51 new tests, 219 total)</li> <li>Achieved 100% test coverage on all DM4 files</li> </ul> <p>Files Created:</p> <ul> <li><code>lib/src/utils/cancel_token.dart</code> - Cancellation token (76 lines)</li> <li><code>lib/src/utils/url_builder.dart</code> - URL builder (107 lines)</li> <li><code>lib/src/utils/utils.dart</code> - Barrel export</li> <li><code>lib/src/http/http_transport.dart</code> - HTTP transport layer (304 lines)</li> <li><code>test/utils/cancel_token_test.dart</code> - 20 tests</li> <li><code>test/utils/url_builder_test.dart</code> - 25 tests</li> <li><code>test/http/http_transport_test.dart</code> - 51 tests (including pause/resume)</li> </ul> <p>Files Modified:</p> <ul> <li><code>lib/src/http/http.dart</code> - Added export for http_transport</li> <li><code>lib/soliplex_client.dart</code> - Added export for utils</li> </ul> <p>Verification:</p> <ul> <li><code>flutter analyze</code>: No issues found (zero errors, warnings, hints)</li> <li><code>flutter test</code>: 219 tests passing</li> <li>Test coverage: 100% on all DM4 files (cancel_token, url_builder, http_transport)</li> </ul> <p>Key Design Decisions:</p> <ul> <li>Completer-based CancelToken for async notification</li> <li>Path normalization in UrlBuilder (strip leading/trailing slashes)</li> <li>JSON encoding only for Map bodies <li>CancelToken checked both before and after adapter request</li> <li>Stream wrapping with pause/resume support for cancellation</li> <li>Error message extraction from JSON response bodies (message, error, detail fields)</li> <p>Next Session:</p> <ul> <li>Start DM5 (API Layer): SoliplexApi with CRUD operations</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#session-2024-12-16-dm3-complete","title":"Session: 2024-12-16 - DM3 Complete","text":"<p>Duration: ~1 hour</p> <p>Accomplished:</p> <ul> <li>Implemented Network Observer layer (DM3)</li> <li>Created <code>HttpObserver</code> interface with 5 lifecycle callbacks:</li> <li><code>onRequest()</code> - called when request is sent</li> <li><code>onResponse()</code> - called when response is received</li> <li><code>onError()</code> - called on network errors</li> <li><code>onStreamStart()</code> - called when streaming begins</li> <li><code>onStreamEnd()</code> - called when streaming ends</li> <li>Created 5 immutable event model classes:</li> <li><code>HttpEvent</code> - base class with requestId and timestamp</li> <li><code>HttpRequestEvent</code> - method, uri, headers</li> <li><code>HttpResponseEvent</code> - statusCode, duration, bodySize, isSuccess helper</li> <li><code>HttpErrorEvent</code> - method, uri, exception, duration</li> <li><code>HttpStreamStartEvent</code> - method, uri</li> <li><code>HttpStreamEndEvent</code> - bytesReceived, duration, error, isSuccess helper</li> <li>Created <code>ObservableHttpClient</code> decorator:</li> <li>Wraps any <code>SoliplexHttpClient</code> implementation</li> <li>Notifies registered observers on all HTTP activity</li> <li>Observer errors are caught and ignored (don't break requests)</li> <li>Supports custom request ID generator for correlation</li> <li>Tracks bytes received for streaming</li> <li>Added comprehensive tests (57 new tests, 168 total)</li> <li>Achieved 100% test coverage on all files</li> </ul> <p>Files Created:</p> <ul> <li><code>lib/src/http/http_observer.dart</code> - Observer interface + event models (41 lines)</li> <li><code>lib/src/http/observable_http_client.dart</code> - Decorator implementation (59 lines)</li> <li><code>test/http/http_observer_test.dart</code> - 30 tests for event models</li> <li><code>test/http/observable_http_client_test.dart</code> - 27 tests for decorator</li> </ul> <p>Files Modified:</p> <ul> <li><code>lib/src/http/http.dart</code> - Added exports for new classes</li> </ul> <p>Verification:</p> <ul> <li><code>flutter analyze</code>: No issues found (zero errors, warnings, hints)</li> <li><code>flutter test</code>: 168 tests passing</li> <li>Test coverage: 100% (380/380 lines across all files)</li> </ul> <p>Key Design Decisions:</p> <ul> <li>Event-based observer pattern (passive observers, no request modification)</li> <li>Decorator pattern for composition (works with any SoliplexHttpClient)</li> <li>Error isolation (observer failures don't break HTTP requests)</li> <li>Privacy-aware (no body logging by default, just body size)</li> <li>Request ID correlation across all events for same request</li> </ul> <p>Next Session:</p> <ul> <li>Start DM4 (HTTP Transport): HttpTransport, UrlBuilder, CancelToken</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#session-2024-12-16-dm2-complete","title":"Session: 2024-12-16 - DM2 Complete","text":"<p>Duration: ~1 hour</p> <p>Accomplished:</p> <ul> <li>Implemented HTTP adapter layer (DM2)</li> <li>Created <code>HttpResponse</code> model with status helpers and body decoding</li> <li>Created <code>SoliplexHttpClient</code> abstract interface</li> <li>Created <code>DartHttpClient</code> using <code>package:http</code> with:</li> <li>30s default timeout (configurable per-request)</li> <li>Body types: String, List, Map (JSON) <li>Exception conversion: TimeoutException, SocketException, HttpException \u2192 NetworkException</li> <li>Streaming support via <code>requestStream()</code> for SSE</li> <li>Header normalization (lowercase keys)</li> <li>Closed state tracking with StateError on use-after-close</li> <li>Added comprehensive tests (75 new tests, 186 total)</li> <p>Files Created:</p> <ul> <li><code>lib/src/http/http_response.dart</code> - Response model</li> <li><code>lib/src/http/soliplex_http_client.dart</code> - Abstract interface</li> <li><code>lib/src/http/dart_http_client.dart</code> - Default implementation</li> <li><code>lib/src/http/http.dart</code> - Barrel export</li> <li><code>test/http/http_response_test.dart</code> - 43 tests</li> <li><code>test/http/dart_http_client_test.dart</code> - 32 tests</li> </ul> <p>Files Modified:</p> <ul> <li><code>pubspec.yaml</code> - Added <code>http: ^1.2.0</code>, <code>mocktail: ^1.0.0</code></li> <li><code>lib/soliplex_client.dart</code> - Added <code>export 'src/http/http.dart';</code></li> </ul> <p>Verification:</p> <ul> <li><code>dart analyze</code>: No issues found</li> <li><code>dart test</code>: 186 tests passing</li> <li>Test coverage: 85%+ on HTTP adapter code</li> </ul> <p>Next Session:</p> <ul> <li>Start DM3 (Network Observer): HttpObserver interface + ObservableHttpClient decorator</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#session-2024-12-15-dm1-complete","title":"Session: 2024-12-15 - DM1 Complete","text":"<p>Duration: ~1 hour</p> <p>Accomplished:</p> <ul> <li>Created <code>packages/soliplex_client/</code> package structure</li> <li>Implemented all models: ChatMessage, ToolCallInfo, Room, ThreadInfo, RunInfo</li> <li>Implemented all exceptions: SoliplexException, AuthException, NetworkException, ApiException, NotFoundException, CancelledException</li> <li>Created comprehensive tests (102 tests passing)</li> <li>Set up <code>very_good_analysis</code> linting (upgraded to ^10.0.0)</li> <li>Added <code>.gitignore</code> file based on Flutter repo</li> </ul> <p>Files Created:</p> <ul> <li><code>lib/soliplex_client.dart</code> - Public exports</li> <li><code>lib/src/models/chat_message.dart</code> - ChatMessage, ChatUser, MessageType, ToolCallInfo, ToolCallStatus</li> <li><code>lib/src/models/room.dart</code> - Room with fromJson/toJson</li> <li><code>lib/src/models/thread_info.dart</code> - ThreadInfo with fromJson/toJson</li> <li><code>lib/src/models/run_info.dart</code> - RunInfo, RunStatus with fromJson/toJson</li> <li><code>lib/src/models/models.dart</code> - Barrel export</li> <li><code>lib/src/errors/exceptions.dart</code> - All exception classes</li> <li><code>lib/src/errors/errors.dart</code> - Barrel export</li> <li><code>test/models/*.dart</code> - Model tests</li> <li><code>test/errors/exceptions_test.dart</code> - Exception tests</li> </ul> <p>Verification:</p> <ul> <li><code>dart analyze</code>: Clean (info only, no errors/warnings)</li> <li><code>dart format</code>: Clean</li> <li><code>dart test</code>: 102 tests passing</li> </ul> <p>Next Session:</p> <ul> <li>Start Phase 2: DM2 (HTTP Adapter)</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#session-date-planning-complete","title":"Session: [DATE] - Planning Complete","text":"<p>Duration: N/A (planning only)</p> <p>Accomplished:</p> <ul> <li>Created package specification (<code>client.md</code>)</li> <li>Created this work log</li> <li>Defined all interfaces and data models</li> <li>Established testing strategy</li> <li>Set coverage targets (85% overall)</li> </ul> <p>Decisions Made:</p> <ol> <li>Package separation: <code>soliplex_client</code> (Pure Dart) + <code>soliplex_client_native</code> (Flutter, v1.1)</li> <li>Adapter injection: <code>HttpClientAdapter</code> interface allows plugging native HTTP clients</li> <li>Phase order: AG-UI protocol (Phase 4) before Sessions (Phase 5) due to dependency</li> <li>Immutable models: All data classes use <code>copyWith</code> pattern</li> <li>Stream-based AG-UI: Events exposed as Dart streams for reactive consumption</li> </ol> <p>Next Session:</p> <ul> <li>Start Phase 1: Create package structure and implement models</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#phase-details","title":"Phase Details","text":""},{"location":"flutter/planning/worklogs/client-worklog/#phase-1-models-errors","title":"Phase 1: Models &amp; Errors","text":"<p>Status: Complete</p> <p>Files Created:</p> <ul> <li>[x] <code>packages/soliplex_client/pubspec.yaml</code></li> <li>[x] <code>packages/soliplex_client/analysis_options.yaml</code></li> <li>[x] <code>packages/soliplex_client/lib/soliplex_client.dart</code></li> <li>[x] <code>packages/soliplex_client/lib/src/models/room.dart</code></li> <li>[x] <code>packages/soliplex_client/lib/src/models/thread_info.dart</code></li> <li>[x] <code>packages/soliplex_client/lib/src/models/run_info.dart</code></li> <li>[x] <code>packages/soliplex_client/lib/src/models/chat_message.dart</code> (includes ToolCallInfo)</li> <li>[x] <code>packages/soliplex_client/lib/src/models/models.dart</code> (barrel export)</li> <li>[x] <code>packages/soliplex_client/lib/src/errors/exceptions.dart</code></li> <li>[x] <code>packages/soliplex_client/lib/src/errors/errors.dart</code> (barrel export)</li> <li>[x] <code>packages/soliplex_client/.gitignore</code></li> </ul> <p>Tests Created:</p> <ul> <li>[x] <code>test/models/room_test.dart</code></li> <li>[x] <code>test/models/thread_info_test.dart</code></li> <li>[x] <code>test/models/run_info_test.dart</code></li> <li>[x] <code>test/models/chat_message_test.dart</code> (includes ToolCallInfo tests)</li> <li>[x] <code>test/errors/exceptions_test.dart</code></li> </ul> <p>Acceptance Criteria:</p> <ul> <li>[x] All models parse from JSON fixtures</li> <li>[x] All models serialize to JSON</li> <li>[x] <code>copyWith</code> works correctly</li> <li>[x] Exceptions have meaningful messages</li> <li>[x] <code>dart format .</code> produces no changes</li> <li>[x] <code>dart analyze</code> shows zero warnings/errors (info only)</li> <li>[x] <code>dart test</code> passes (102 tests)</li> <li>[x] 100% test coverage on models</li> </ul> <p>Notes:</p> <ul> <li>ToolCallInfo integrated into chat_message.dart rather than separate file</li> <li>Used <code>very_good_analysis</code> ^10.0.0 for strict linting</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#phase-2-http-foundation","title":"Phase 2: HTTP Foundation","text":"<p>Status: Complete (DM2, DM3, DM4 done)</p> <p>Files to Create:</p> <ul> <li>[x] <code>lib/src/http/http_response.dart</code> \u2713 DM2</li> <li>[x] <code>lib/src/http/soliplex_http_client.dart</code> \u2713 DM2</li> <li>[x] <code>lib/src/http/dart_http_client.dart</code> \u2713 DM2</li> <li>[x] <code>lib/src/http/http.dart</code> (barrel) \u2713 DM2</li> <li>[x] <code>lib/src/http/http_observer.dart</code> \u2713 DM3</li> <li>[x] <code>lib/src/http/observable_http_client.dart</code> \u2713 DM3</li> <li>[x] <code>lib/src/http/http_transport.dart</code> \u2713 DM4</li> <li>[x] <code>lib/src/utils/url_builder.dart</code> \u2713 DM4</li> <li>[x] <code>lib/src/utils/cancel_token.dart</code> \u2713 DM4</li> <li>[x] <code>lib/src/utils/utils.dart</code> (barrel) \u2713 DM4</li> </ul> <p>Tests to Create:</p> <ul> <li>[x] <code>test/http/http_response_test.dart</code> \u2713 DM2 (43 tests)</li> <li>[x] <code>test/http/dart_http_client_test.dart</code> \u2713 DM2 (32 tests)</li> <li>[x] <code>test/http/http_observer_test.dart</code> \u2713 DM3 (30 tests)</li> <li>[x] <code>test/http/observable_http_client_test.dart</code> \u2713 DM3 (27 tests)</li> <li>[x] <code>test/http/http_transport_test.dart</code> \u2713 DM4 (51 tests)</li> <li>[x] <code>test/utils/url_builder_test.dart</code> \u2713 DM4 (25 tests)</li> <li>[x] <code>test/utils/cancel_token_test.dart</code> \u2713 DM4 (20 tests)</li> </ul> <p>Acceptance Criteria:</p> <ul> <li>[x] DartHttpAdapter handles all HTTP methods (GET, POST, PUT, DELETE, PATCH, HEAD) \u2713 DM2</li> <li>[x] Request timeout behavior works correctly \u2713 DM2</li> <li>[x] Network exceptions converted properly \u2713 DM2</li> <li>[x] Streaming requests work for SSE support \u2713 DM2</li> <li>[x] HttpObserver interface defined with all callbacks \u2713 DM3</li> <li>[x] ObservableHttpAdapter notifies observers on all HTTP activity \u2713 DM3</li> <li>[x] Multiple observers can be registered \u2713 DM3</li> <li>[x] Observer error handling (observer throws doesn't break request) \u2713 DM3</li> <li>[x] UrlBuilder produces correct paths \u2713 DM4</li> <li>[x] CancelToken cancels requests \u2713 DM4</li> <li>[x] HttpTransport maps HTTP status codes to exceptions \u2713 DM4</li> <li>[x] 85%+ test coverage \u2713 (100% achieved on all files)</li> </ul> <p>Notes:</p> <ul> <li>DM2 complete: AdapterResponse, HttpClientAdapter interface, DartHttpAdapter implementation</li> <li>DM3 complete: HttpObserver interface, 5 event models, ObservableHttpAdapter decorator</li> <li>DM4 complete: CancelToken, UrlBuilder, HttpTransport with 100% test coverage</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#phase-3-api-layer","title":"Phase 3: API Layer","text":"<p>Status: Complete (DM5 done)</p> <p>Files Created:</p> <ul> <li>[x] <code>lib/src/api/soliplex_api.dart</code> \u2713 DM5</li> <li>[x] <code>lib/src/api/api.dart</code> (barrel) \u2713 DM5</li> </ul> <p>Tests Created:</p> <ul> <li>[x] <code>test/api/soliplex_api_test.dart</code> \u2713 DM5 (30 tests)</li> </ul> <p>Acceptance Criteria:</p> <ul> <li>[x] All 8 CRUD operations work (rooms, threads, runs)</li> <li>[x] Errors mapped to exceptions (propagated from transport)</li> <li>[x] Cancellation works via CancelToken</li> <li>[x] 100% test coverage on DM5 files</li> </ul> <p>Notes:</p> <ul> <li>MockHttpTransport using mocktail for unit tests</li> <li><code>createThread()</code> returns <code>ThreadInfo</code> (normalized from backend's <code>thread_id</code>)</li> <li><code>createRun()</code> returns <code>RunInfo</code> (normalized from backend's <code>run_id</code>)</li> <li>No intermediate result types - API returns domain models directly</li> <li>Input validation for empty IDs throws ArgumentError</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#phase-4-ag-ui-protocol","title":"Phase 4: AG-UI Protocol","text":"<p>Status: Complete (DM6 done)</p> <p>Files Created:</p> <ul> <li>[x] <code>lib/src/agui/agui_event.dart</code> \u2713</li> <li>[x] <code>lib/src/agui/text_message_buffer.dart</code> \u2713</li> <li>[x] <code>lib/src/agui/tool_call_buffer.dart</code> \u2713</li> <li>[x] <code>lib/src/agui/tool_registry.dart</code> \u2713</li> <li>[x] <code>lib/src/agui/thread.dart</code> \u2713</li> <li>[x] <code>lib/src/agui/agui.dart</code> (barrel) \u2713</li> </ul> <p>Tests Created:</p> <ul> <li>[x] <code>test/agui/agui_event_test.dart</code> \u2713 (55 tests)</li> <li>[x] <code>test/agui/text_message_buffer_test.dart</code> \u2713 (27 tests)</li> <li>[x] <code>test/agui/tool_call_buffer_test.dart</code> \u2713 (45 tests)</li> <li>[x] <code>test/agui/tool_registry_test.dart</code> \u2713 (30 tests)</li> <li>[x] <code>test/agui/thread_test.dart</code> \u2713 (45 tests, includes edge cases)</li> </ul> <p>Acceptance Criteria:</p> <ul> <li>[x] Event stream processing correct (18 event types parsed)</li> <li>[x] Message buffering works (TextMessageBuffer)</li> <li>[x] Tool calls buffered and executed (ToolCallBuffer + ToolRegistry)</li> <li>[x] Fire-and-forget tools handled</li> <li>[x] 100% test coverage (exceeds 90% target)</li> </ul> <p>Notes:</p> <ul> <li>Sealed class hierarchy for type-safe event handling</li> <li><code>ThreadRunStatus</code> enum to avoid conflict with existing <code>RunStatus</code> model</li> <li>JSON Patch support for state delta operations</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#phase-5-sessions","title":"Phase 5: Sessions","text":"<p>Status: Not Started</p> <p>Files to Create:</p> <ul> <li>[ ] <code>lib/src/session/room_session.dart</code></li> <li>[ ] <code>lib/src/session/connection_manager.dart</code></li> </ul> <p>Tests to Create:</p> <ul> <li>[ ] <code>test/session/room_session_test.dart</code></li> <li>[ ] <code>test/session/connection_manager_test.dart</code></li> </ul> <p>Acceptance Criteria:</p> <ul> <li>[ ] Session lifecycle correct</li> <li>[ ] Multi-room management works</li> <li>[ ] Server switching works</li> <li>[ ] Events emitted correctly</li> <li>[ ] 85% test coverage</li> </ul> <p>Notes:</p> <ul> <li>Test session disposal and cleanup</li> <li>Test concurrent sessions</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#phase-6-facade","title":"Phase 6: Facade","text":"<p>Status: Not Started</p> <p>Files to Create:</p> <ul> <li>[ ] <code>lib/src/soliplex_client.dart</code></li> <li>[ ] Update <code>lib/soliplex_client.dart</code> exports</li> </ul> <p>Tests to Create:</p> <ul> <li>[ ] <code>test/soliplex_client_test.dart</code></li> <li>[ ] <code>test/integration/</code> (optional)</li> </ul> <p>Acceptance Criteria:</p> <ul> <li>[ ] Public API clean and complete</li> <li>[ ] Full chat flow works</li> <li>[ ] Tool execution end-to-end</li> <li>[ ] Cancellation works</li> <li>[ ] 85% overall coverage</li> <li>[ ] README example works</li> </ul> <p>Notes:</p> <ul> <li>Write integration tests if time permits</li> <li>Update README with real examples</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#decisions-log","title":"Decisions Log","text":"Date Decision Rationale 2024-12-15 Pure Dart package Reusable in CLI/server, no Flutter dependency 2024-12-15 HttpClientAdapter interface Allows native adapters without modifying core 2024-12-15 AG-UI before Sessions Thread is used by RoomSession 2024-12-15 Immutable models Predictable state, better for testing 2024-12-15 Stream-based events Natural fit for Dart async, works with Riverpod 2024-12-15 ObservableHttpAdapter (Layer 0.5) Decorator pattern enables observing ALL HTTP traffic regardless of which platform adapter is used. Network inspector can see everything. 2024-12-16 Bytes-first AdapterResponse Store bodyBytes as Uint8List, provide body getter for UTF-8 decoding. Handles binary responses correctly. 2024-12-16 Content-type before body Set content-type header before setting body to prevent package:http from overriding user-specified values. 2024-12-16 Adapter-level exception conversion DartHttpAdapter converts platform exceptions (TimeoutException, SocketException) to NetworkException. HTTP status codes handled at transport layer. 2024-12-16 Event-based HttpObserver Observer pattern with immutable event objects. Observers are passive - cannot modify requests. Enables network inspector without coupling to adapter implementation. 2024-12-16 Observer error isolation ObservableHttpAdapter catches and ignores exceptions from observers. Observer failures never break HTTP requests. 2024-12-16 Completer-based CancelToken Uses Dart Completer for async notification. Single-use token (once cancelled, stays cancelled). <code>whenCancelled</code> future allows async waiting for cancellation. 2024-12-16 HttpTransport exception mapping Maps HTTP status codes to typed exceptions: 401/403 \u2192 AuthException, 404 \u2192 NotFoundException, 4xx/5xx \u2192 ApiException. NetworkException passed through from adapter. 2024-12-16 Stream cancellation with pause/resume Wrapped streams support pause/resume and cancellation. CancelToken emits CancelledException to stream on cancel. 2025-12-17 Sealed class for AG-UI events Type-safe event handling with exhaustive switch. 18 event types in sealed hierarchy. 2025-12-17 ThreadRunStatus enum Renamed from RunStatus to avoid conflict with existing model in run_info.dart. 2025-12-17 Deep copy for state snapshots <code>_deepCopyMap()</code> helper recursively copies nested maps to allow modification after StateSnapshotEvent. 2025-12-17 Stylistic lint rules disabled Disabled cascade_invocations, avoid_redundant_argument_values, etc. for better test readability."},{"location":"flutter/planning/worklogs/client-worklog/#issues-blockers","title":"Issues &amp; Blockers","text":"ID Issue Status Resolution - None yet - -"},{"location":"flutter/planning/worklogs/client-worklog/#resources","title":"Resources","text":"<ul> <li>Spec: <code>planning/client.md</code></li> <li>Backend API: <code>planning/external_backend_service.md</code></li> <li>AG-UI Docs: (link to ag_ui package docs)</li> </ul>"},{"location":"flutter/planning/worklogs/client-worklog/#quick-resume-guide","title":"Quick Resume Guide","text":"<p>To pick up where you left off:</p> <ol> <li>Check \"Current Focus\" section above</li> <li>Look at the current phase's checklist</li> <li>Run tests to verify current state: <code>cd packages/soliplex_client &amp;&amp; dart test</code></li> <li>Continue with unchecked items</li> </ol> <p>Last updated: 2025-12-17 (DM6 Complete, Reference Analysis)</p>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/","title":"Core Frontend Work Log","text":"<p>Track progress, decisions, and context for Core Frontend (Flutter app) implementation.</p>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#status-summary","title":"Status Summary","text":"Phase Status Progress 1. Project setup, navigation (NO AUTH) \u2705 Complete 100% 2. ActiveRunNotifier + extensions \u2705 Complete 100% 3. Authentication + Extensibility Not Started 0% 4. Polish, extract to <code>soliplex_core</code> Not Started 0% <p>Overall: 2/4 phases complete (AM1, AM2, AM3 shipped) - Code quality: \u2705 Clean</p>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#current-focus","title":"Current Focus","text":"<p>Phase: AM3 - COMPLETE (Working Chat shipped)</p> <p>Architectural Enhancement v3: \u2705 COMPLETE (Clean architecture layers)</p> <p>Next Phase: AM4 (Enhanced Chat) or AM5 (Inspector)</p> <p>Blocked by: None</p>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#session-log","title":"Session Log","text":""},{"location":"flutter/planning/worklogs/core-frontend-worklog/#session-1-2025-12-16-am1-implementation","title":"Session 1: 2025-12-16 - AM1 Implementation","text":"<p>Duration: Full implementation</p> <p>Completed:</p> <ul> <li>\u2705 Project structure and configuration</li> <li>\u2705 Core models, providers, and routing</li> <li>\u2705 All 5 screens (Home, Rooms, Room, Thread, Settings)</li> <li>\u2705 Shared widgets (LoadingIndicator, ErrorDisplay, EmptyState)</li> <li>\u2705 Comprehensive test suite (38 tests)</li> <li>\u2705 Router testing with full coverage</li> </ul> <p>Metrics:</p> <ul> <li>Test Coverage: 89.9% (205/228 lines) - exceeds 85% target</li> <li>Tests: 38 passing (0 failures)</li> <li>Analyzer: 0 errors, 0 warnings</li> <li>Files Created: 17 source files, 12 test files</li> </ul> <p>Key Decisions:</p> <ul> <li>Manual Riverpod providers (no code generation)</li> <li>go_router for declarative navigation</li> <li>Material 3 design system</li> <li>Hardcoded mock data (to be replaced in AM2)</li> <li>Initial route: <code>/</code> with button to navigate to <code>/rooms</code></li> </ul> <p>Issues Resolved:</p> <ul> <li>Fixed dependency ordering in pubspec.yaml</li> <li>Fixed constructor ordering (unnamed before factory)</li> <li>Corrected model fields (createdAt vs created)</li> <li>Fixed parameter ordering (required before optional)</li> <li>Added missing WidgetRef in ConsumerWidget</li> <li>Fixed pending timer in tests with pumpAndSettle()</li> <li>Fixed all analyzer issues (imports, const, line length)</li> </ul>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#session-2-2025-12-16-am2-implementation","title":"Session 2: 2025-12-16 - AM2 Implementation","text":"<p>Duration: Full implementation</p> <p>Completed:</p> <ul> <li>\u2705 API provider infrastructure (httpTransportProvider, urlBuilderProvider, apiProvider)</li> <li>\u2705 Backend health check provider</li> <li>\u2705 Enhanced ErrorDisplay with type-specific icons and debug mode</li> <li>\u2705 AsyncValueHandler widget for clean AsyncValue handling</li> <li>\u2705 Real API integration (replaced mock data in roomsProvider, threadsProvider)</li> <li>\u2705 Comprehensive test suite expansion (64 tests, up from 38)</li> <li>\u2705 All critical architecture fixes from architect-reviewer</li> <li>\u2705 Deleted mock_data.dart and removed artificial delays</li> </ul> <p>Metrics:</p> <ul> <li>Test Coverage: 91.1% (205/225 lines) - exceeds 85% target</li> <li>Tests: 64 passing (0 failures) - +26 new tests</li> <li>Analyzer: 0 errors, 0 warnings</li> <li>Files Created: 4 new files</li> <li>Files Modified: 8 files</li> <li>Files Deleted: 1 file (mock_data.dart)</li> </ul> <p>Key Decisions:</p> <ul> <li>3-tier API provider architecture (httpTransport \u2192 urlBuilder \u2192 api)</li> <li>Singleton HttpTransport to prevent resource leaks</li> <li>Type-specific error icons (wifi_off, lock_outline, search_off, etc.)</li> <li>Debug mode stack traces for development</li> <li>AsyncValueHandler for cleaner AsyncValue state management</li> <li>Added http package for backend health checks</li> </ul> <p>Architecture Highlights:</p> <ul> <li>Provider dependency graph ensures proper lifecycle management</li> <li>ErrorDisplay differentiates timeout vs connection errors</li> <li>All exception types (NetworkException, AuthException, NotFoundException, ApiException, CancelledException) properly handled</li> <li>Comprehensive API mocking strategy using MockSoliplexApi</li> </ul> <p>Issues Resolved:</p> <ul> <li>Fixed configProvider override pattern (StateProvider requires overrideWith, not overrideWithValue)</li> <li>Updated UrlBuilder.build() calls to use named parameter (path: '/rooms')</li> <li>Fixed ErrorDisplay icon tests to match new type-specific icons</li> <li>Sorted dependencies alphabetically in pubspec.yaml</li> <li>Fixed unnecessary lambdas and redundant default values</li> <li>Added missing code block language markers in documentation</li> </ul>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#session-3-2025-12-17-am3-implementation","title":"Session 3: 2025-12-17 - AM3 Implementation","text":"<p>Duration: Full implementation (~6 hours with parallel agents)</p> <p>Completed:</p> <ul> <li>\u2705 Core state management (ActiveRunState, ActiveRunNotifier)</li> <li>\u2705 Chat widgets (ChatPanel, MessageList, ChatInput, ChatMessageWidget)</li> <li>\u2705 History widgets (HistoryPanel, ThreadListItem, NewConversationButton)</li> <li>\u2705 ThreadScreen integration (responsive layout)</li> <li>\u2705 Provider architecture (7 new providers)</li> <li>\u2705 Utilities (date formatting, short ID display)</li> <li>\u2705 Comprehensive test suite (65 new tests, 129 total)</li> </ul> <p>Metrics:</p> <ul> <li>Test Coverage: TBD (awaiting genhtml report generation)</li> <li>Tests: 129 passing (0 failures) - +65 new tests for AM3</li> <li>Analyzer: 0 errors, 0 warnings (24 info-level linting suggestions)</li> <li>Files Created: 13 implementation files, 10 test files</li> <li>Lines Added: ~3,000 lines across implementation + tests</li> </ul> <p>Files Created:</p> <p>Core State:</p> <ul> <li><code>lib/core/models/active_run_state.dart</code> - Immutable state for AG-UI runs</li> <li><code>lib/core/providers/active_run_notifier.dart</code> - StateNotifier for SSE streaming</li> <li><code>lib/core/providers/active_run_provider.dart</code> - Provider definitions</li> </ul> <p>Chat Feature:</p> <ul> <li><code>lib/features/chat/chat_panel.dart</code> - Main chat UI</li> <li><code>lib/features/chat/widgets/message_list.dart</code> - Scrollable message list</li> <li><code>lib/features/chat/widgets/chat_input.dart</code> - Text input with send logic</li> <li><code>lib/features/chat/widgets/chat_message_widget.dart</code> - Single message display</li> </ul> <p>History Feature:</p> <ul> <li><code>lib/features/history/history_panel.dart</code> - Thread list panel</li> <li><code>lib/features/history/widgets/thread_list_item.dart</code> - Thread card</li> <li><code>lib/features/history/widgets/new_conversation_button.dart</code> - New thread button</li> </ul> <p>Utilities:</p> <ul> <li><code>lib/shared/utils/date_formatter.dart</code> - Relative time formatting</li> </ul> <p>Tests:</p> <ul> <li><code>test/core/models/active_run_state_test.dart</code></li> <li><code>test/core/providers/active_run_notifier_test.dart</code></li> <li><code>test/core/providers/active_run_provider_test.dart</code></li> <li><code>test/features/chat/chat_panel_test.dart</code></li> <li><code>test/features/chat/widgets/message_list_test.dart</code></li> <li><code>test/features/chat/widgets/chat_input_test.dart</code></li> <li><code>test/features/chat/widgets/chat_message_widget_test.dart</code></li> <li><code>test/features/history/history_panel_test.dart</code></li> <li><code>test/features/history/widgets/thread_list_item_test.dart</code></li> <li><code>test/shared/utils/date_formatter_test.dart</code></li> </ul> <p>Files Modified:</p> <ul> <li><code>lib/core/providers/threads_provider.dart</code> - Added currentThreadProvider</li> <li><code>lib/features/thread/thread_screen.dart</code> - Integrated Chat + History</li> <li><code>test/features/thread/thread_screen_test.dart</code> - Updated for new implementation</li> <li><code>test/helpers/test_helpers.dart</code> - Added createMessage factory, MockActiveRunNotifier</li> <li><code>pubspec.yaml</code> - Added intl package dependency</li> </ul> <p>Key Decisions:</p> <ul> <li>StateNotifier over StreamNotifier: Manual Riverpod without code generation</li> <li>allMessagesProvider pattern: Merges historical + active run messages declaratively</li> <li>Auto-scroll on new messages: ref.listen with post-frame callback</li> <li>Responsive layout: Desktop (&gt;=600px) shows History+Chat, Mobile shows Chat only</li> <li>Thread creation inline: Create thread on first message send (no separate action)</li> <li>No historical messages in AM3: threadMessagesProvider returns empty list (deferred to AM4)</li> <li>State machine in ActiveRunNotifier: idle \u2192 running \u2192 finished/error with proper cleanup</li> <li>rawEvents and state captured: Included for AM5 Detail panel (unused in AM3)</li> </ul> <p>Architecture Highlights:</p> <ul> <li>Clean separation: Core (state) \u2192 Features (UI) \u2192 soliplex_client (protocol)</li> <li>Provider dependency graph:</li> </ul> <pre><code>httpTransportProvider \u2192 activeRunNotifierProvider\nthreadsProvider \u2192 currentThreadProvider \u2192 allMessagesProvider\ncanSendMessageProvider watches: room, thread, runState, newIntent\n</code></pre> <ul> <li>Event processing: Thread class processes AG-UI events internally</li> <li>Lifecycle management: StateNotifier cleanup on dispose, CancelToken for streams</li> <li>Responsive widgets: LayoutBuilder pattern at 600px breakpoint</li> </ul> <p>Issues Resolved:</p> <ul> <li>Fixed StateNotifierProvider override pattern in tests (use MockActiveRunNotifier)</li> <li>Removed createdAt parameter from ChatMessage.text() factory</li> <li>Added currentThreadProvider to threads_provider.dart</li> <li>Fixed package imports (use soliplex_frontend/... not relative)</li> <li>Made ActiveRunState.cancelled constructor const</li> <li>Fixed ThreadScreen test expectations for new implementation</li> <li>Fixed NewConversationButton layout overflow (wrapped text in Expanded)</li> <li>Fixed message list scroll-to-bottom timing with WidgetsBinding.addPostFrameCallback</li> <li>Added intl package for date formatting utilities</li> </ul> <p>Testing Approach:</p> <ul> <li>Mock patterns: MockActiveRunNotifier for state overrides</li> <li>Widget tests: pump() for sync updates, pumpAndSettle() for async</li> <li>Provider tests: ProviderContainer with overrides</li> <li>Comprehensive scenarios: loading, error, empty, streaming, cancellation</li> <li>Edge cases: rapid sends, thread switching, error recovery</li> </ul> <p>Next Session:</p> <ul> <li>Start AM4 (Enhanced Chat) - Markdown rendering, syntax highlighting, message history</li> <li>Or AM5 (Inspector) - Detail panel with rawEvents, state inspection, tool call visualization</li> </ul> <p>Resume Context:</p> <ul> <li>Tests: 129 passing, 0 failing \u2713</li> <li>Coverage: 91.1% (TBD for new files after genhtml generation)</li> <li>Analyzer: 0 errors, 0 warnings \u2713 (24 info suggestions)</li> <li>Formatting: Clean \u2713</li> <li>Git Status: 23 files modified/created (shown in git diff --stat)</li> <li>Next Action: Test AM3 end-to-end with live backend, or proceed to AM4/AM5</li> </ul>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#session-4-2025-12-17-code-quality-maintenance","title":"Session 4: 2025-12-17 - Code Quality &amp; Maintenance","text":"<p>Duration: ~1 hour</p> <p>Completed:</p> <ul> <li>\u2705 Fixed all Flutter analyzer issues (46 total)</li> <li>\u2705 Updated test suite for new constructor signatures</li> <li>\u2705 Verified all tests pass after fixes</li> </ul> <p>Metrics:</p> <ul> <li>Analyzer: 0 errors, 0 warnings, 0 info (was 46 issues) \u2713</li> <li>Tests: 129 frontend tests passing, 587 client tests passing \u2713</li> <li>Files Modified: 9 files across frontend and client packages</li> </ul> <p>Issues Fixed:</p> <ol> <li>Errors (4):</li> <li>Added missing <code>urlBuilder</code> parameter to <code>Thread</code> constructor calls in tests</li> <li> <p>Added missing <code>urlBuilder</code> parameter to <code>MockActiveRunNotifier</code> constructor</p> </li> <li> <p>Warning (1):</p> </li> <li> <p>Removed dead null-aware expression in <code>thread_screen.dart:104</code> (<code>room.name</code> is non-nullable)</p> </li> <li> <p>Info/Hints (41):</p> </li> <li>Removed redundant <code>null</code> arguments from <code>copyWith()</code> calls</li> <li>Added ignore comments for semantically-required <code>isTextStreaming: false</code> arguments</li> <li>Removed redundant default arguments in test factories (<code>user: ChatUser.user</code>, <code>isStreaming: false</code>)</li> <li>Fixed nullable cast issues in tests (added null-assertion before casts)</li> <li>Fixed line length issues across multiple files</li> <li>Added <code>const</code> constructors where appropriate</li> <li>Removed unnecessary casts in test assertions</li> </ol> <p>Files Modified:</p> <ul> <li><code>packages/soliplex_client/test/agui/thread_test.dart</code> - Added urlBuilder parameter</li> <li><code>test/helpers/test_helpers.dart</code> - Added urlBuilder to MockActiveRunNotifier</li> <li><code>lib/features/thread/thread_screen.dart</code> - Removed dead null-aware operator</li> <li><code>lib/core/providers/active_run_notifier.dart</code> - Fixed redundant arguments, line length</li> <li><code>lib/core/providers/threads_provider.dart</code> - Fixed line length</li> <li><code>test/features/chat/chat_panel_test.dart</code> - Added const constructor</li> <li><code>test/features/chat/widgets/chat_input_test.dart</code> - Fixed nullable casts</li> <li><code>test/features/chat/widgets/chat_message_widget_test.dart</code> - Fixed redundant args &amp; casts</li> <li><code>test/features/chat/widgets/message_list_test.dart</code> - Removed redundant arguments</li> <li><code>test/features/thread/thread_screen_test.dart</code> - Fixed line length, casts, redundant args</li> </ul> <p>Key Insights:</p> <ul> <li>The <code>avoid_redundant_argument_values</code> lint detects when arguments match constructor defaults</li> <li>For <code>copyWith()</code> patterns, passing <code>null</code> to nullable parameters is redundant (preserves existing value via <code>??</code>)</li> <li>Test factory defaults should be leveraged to reduce boilerplate</li> <li>Null-assertion operator (<code>!</code>) needed before casting when value could be null</li> </ul> <p>Next Session:</p> <ul> <li>Ready for AM4 (Enhanced Chat) or AM5 (Inspector)</li> <li>All code quality gates passed \u2713</li> </ul>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#session-5-2025-12-17-native-http-adapter-integration","title":"Session 5: 2025-12-17 - Native HTTP Adapter Integration","text":"<p>Duration: ~45 minutes</p> <p>Completed:</p> <ul> <li>\u2705 Integrated soliplex_client_native package</li> <li>\u2705 Enabled platform-optimized HTTP adapters</li> <li>\u2705 Added fallback for test environment</li> <li>\u2705 Updated documentation</li> </ul> <p>Changes:</p> <ul> <li>Added <code>soliplex_client_native</code> dependency to pubspec.yaml</li> <li>Updated <code>api_provider.dart</code> to use <code>createPlatformClient()</code></li> <li>Added try-catch fallback in <code>create_platform_client_io.dart</code> for test environment</li> <li>Platform detection: CupertinoHttpClient on macOS/iOS, DartHttpClient elsewhere</li> </ul> <p>Benefits on macOS:</p> <ul> <li>Native NSURLSession integration</li> <li>HTTP/2 and HTTP/3 support</li> <li>System proxy and VPN support</li> <li>Better battery efficiency</li> <li>System certificate trust evaluation</li> </ul> <p>Metrics:</p> <ul> <li>Code Changed: 3 files, 5 lines (2 production + 3 native package)</li> <li>Tests: 129 passing (0 changes needed)</li> <li>Analyzer: 0 issues</li> <li>Risk: Very low (interface unchanged, automatic fallback)</li> </ul> <p>Key Decision:</p> <p>Used <code>createPlatformClient()</code> for automatic platform detection rather than explicit Platform.isMacOS checks. Added try-catch fallback for test environments where native bindings are unavailable, ensuring tests continue to pass with DartHttpClient.</p> <p>Technical Challenge Resolved:</p> <p>Initial implementation failed 16 tests because <code>CupertinoHttpClient</code> tried to load native bindings in the Flutter test environment (macOS VM without NSURLSession). Solution: Added try-catch in <code>createPlatformClientImpl()</code> to gracefully fall back to <code>DartHttpClient</code> when native bindings are unavailable.</p>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#phase-details","title":"Phase Details","text":""},{"location":"flutter/planning/worklogs/core-frontend-worklog/#phase-1-project-setup-navigation-no-auth","title":"Phase 1: Project Setup, Navigation (NO AUTH)","text":"<p>Status: \u2705 Complete</p> <p>Milestone: AM1</p> <p>Completed: 2025-12-16</p> <p>Key Points:</p> <ul> <li>NO authentication in AM1 - deferred to AM7</li> <li>Basic app shell with navigation</li> <li>Room and thread navigation only</li> <li>Placeholder screens for future features</li> </ul> <p>Files Created:</p> <ul> <li>[x] <code>pubspec.yaml</code> - Dependencies</li> <li>[x] <code>analysis_options.yaml</code> - Linting rules</li> <li>[x] <code>.gitignore</code> - Git ignore patterns</li> <li>[x] <code>lib/main.dart</code> - App entry point</li> <li>[x] <code>lib/app.dart</code> - MaterialApp configuration</li> <li>[x] <code>lib/core/router/app_router.dart</code> - go_router navigation</li> <li>[x] <code>lib/core/models/app_config.dart</code> - App configuration model</li> <li>[x] <code>lib/core/providers/</code> - Riverpod providers (config, rooms, threads)</li> <li>[x] <code>lib/features/home/home_screen.dart</code> - Welcome screen</li> <li>[x] <code>lib/features/rooms/rooms_screen.dart</code> - Rooms list</li> <li>[x] <code>lib/features/room/room_screen.dart</code> - Room detail with threads</li> <li>[x] <code>lib/features/thread/thread_screen.dart</code> - Thread placeholder</li> <li>[x] <code>lib/features/settings/settings_screen.dart</code> - Settings screen</li> <li>[x] <code>lib/shared/widgets/</code> - LoadingIndicator, ErrorDisplay, EmptyState</li> <li>[x] Complete test suite (38 tests, 12 test files)</li> </ul> <p>Acceptance Criteria:</p> <ul> <li>[x] App launches without errors</li> <li>[x] Navigation between routes works</li> <li>[x] <code>flutter analyze</code> shows zero issues</li> <li>[x] <code>flutter test</code> passes with 89.9% coverage (exceeds 85% target)</li> </ul>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#am2-connected-data","title":"AM2: Connected Data","text":"<p>Status: \u2705 Complete</p> <p>Milestone: AM2</p> <p>Completed: 2025-12-16</p> <p>Key Points:</p> <ul> <li>Real API integration replacing all mock data</li> <li>3-tier API provider architecture (httpTransport, urlBuilder, api)</li> <li>Enhanced error handling with type-specific icons</li> <li>Backend health check system</li> <li>AsyncValueHandler widget for cleaner state management</li> <li>Comprehensive test suite (64 tests, 91.1% coverage)</li> </ul> <p>Files Created:</p> <ul> <li>[x] <code>lib/core/providers/api_provider.dart</code> - API infrastructure</li> <li>[x] <code>lib/core/providers/backend_health_provider.dart</code> - Health checks</li> <li>[x] <code>lib/shared/widgets/async_value_handler.dart</code> - AsyncValue wrapper</li> <li>[x] <code>test/core/providers/api_provider_test.dart</code> - Provider tests</li> </ul> <p>Files Modified:</p> <ul> <li>[x] <code>lib/core/providers/rooms_provider.dart</code> - Real API integration</li> <li>[x] <code>lib/core/providers/threads_provider.dart</code> - Real API integration</li> <li>[x] <code>lib/shared/widgets/error_display.dart</code> - Enhanced error handling</li> <li>[x] <code>test/helpers/test_helpers.dart</code> - Added MockSoliplexApi</li> <li>[x] <code>test/core/providers/rooms_provider_test.dart</code> - API mocking</li> <li>[x] <code>test/core/providers/threads_provider_test.dart</code> - Family provider tests</li> <li>[x] <code>test/shared/widgets/error_display_test.dart</code> - Icon tests</li> <li>[x] <code>pubspec.yaml</code> - Added http dependency</li> </ul> <p>Files Deleted:</p> <ul> <li>[x] <code>lib/core/providers/mock_data.dart</code> - Removed all mock data</li> </ul> <p>Acceptance Criteria:</p> <ul> <li>[x] Backend returns real rooms via <code>SoliplexApi.getRooms()</code></li> <li>[x] Backend returns real threads via <code>SoliplexApi.getThreads(roomId)</code></li> <li>[x] UI displays data without mocking</li> <li>[x] Users can navigate between room and thread selection</li> <li>[x] <code>flutter analyze</code> shows zero issues</li> <li>[x] <code>flutter test</code> passes with 91.1% coverage (exceeds 85% target)</li> <li>[x] All 64 tests passing</li> </ul>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#phase-2-activerunnotifier-extensions","title":"Phase 2: ActiveRunNotifier + Extensions","text":"<p>Status: \u2705 Complete</p> <p>Milestone: AM3</p> <p>Completed: 2025-12-17</p> <p>Key Points:</p> <ul> <li>ActiveRunState and ActiveRunNotifier for AG-UI streaming</li> <li>Chat and History widgets for working chat interface</li> <li>Responsive layout (desktop/mobile)</li> <li>Comprehensive test suite (65 new tests)</li> <li>All code quality gates passed (0 analyzer issues)</li> </ul>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#phase-3-authentication-extensibility","title":"Phase 3: Authentication + Extensibility","text":"<p>Status: Not Started</p> <p>Milestone: AM7</p>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#phase-4-polish-extract","title":"Phase 4: Polish &amp; Extract","text":"<p>Status: Not Started</p> <p>Milestone: AM8</p>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#decisions-log","title":"Decisions Log","text":"Date Decision Rationale 2025-12-16 Use manual Riverpod providers (no code generation) User preference - simpler, more explicit, no build_runner 2025-12-16 Package name: <code>soliplex_frontend</code> Consistent with project naming 2025-12-16 Initial route: <code>/</code> with button to <code>/rooms</code> User requirement - explicit navigation flow 2025-12-16 Hardcoded mock data in providers AM1 scope - replaced with API in AM2 2025-12-16 go_router for navigation Declarative routing, URL support, type-safe 2025-12-16 Material 3 design system Modern Flutter UI patterns 2025-12-16 3-tier API provider architecture Separates transport, URL building, and API concerns; enables testability 2025-12-16 Singleton HttpTransport Prevents resource leaks from multiple HTTP clients 2025-12-16 Type-specific error icons Improves UX by visually distinguishing error types 2025-12-16 Debug mode stack traces in ErrorDisplay Aids development without cluttering production UI 2025-12-16 AsyncValueHandler widget DRY principle - reduces boilerplate in UI code 2025-12-16 Backend health check provider Enables proactive connection status monitoring 2025-12-17 Use native HTTP client via createPlatformClient() Automatic platform detection, better macOS performance (NSURLSession), zero config, fallback for test environment"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#issues-blockers","title":"Issues &amp; Blockers","text":"ID Issue Status Resolution I1 Dependency ordering lint errors \u2705 Resolved Alphabetically sorted dependencies in pubspec.yaml I2 Constructor ordering errors \u2705 Resolved Unnamed constructor before factory constructors I3 Wrong model fields in mock data \u2705 Resolved Used correct fields from soliplex_client models I4 Required parameter ordering \u2705 Resolved Required params before optional in constructors I5 Missing WidgetRef in ConsumerWidget \u2705 Resolved Added WidgetRef parameter to build methods I6 Pending timer in widget tests \u2705 Resolved Added pumpAndSettle() to wait for async operations I7 Missing Material imports \u2705 Resolved Added flutter/material.dart imports to test files I8 Analyzer warnings (22 issues) \u2705 Resolved Fixed imports, unawaited futures, const, line length"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#resources","title":"Resources","text":"<ul> <li>Spec: <code>planning/core_frontend.md</code></li> <li>Roadmap: <code>planning/ROADMAP.md</code></li> <li>Backend API: <code>planning/external_backend_service.md</code></li> <li>Client Worklog: <code>planning/client-worklog.md</code></li> </ul>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#quick-resume-guide","title":"Quick Resume Guide","text":"<p>To pick up where you left off:</p> <ol> <li>Check \"Current Focus\" section above</li> <li>Look at the current phase's checklist</li> <li>Run tests to verify current state: <code>flutter test</code></li> <li>Continue with unchecked items</li> </ol>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#session-6-2025-12-23-application-layer-export-import-cleanup","title":"Session 6: 2025-12-23 - Application Layer Export &amp; Import Cleanup","text":"<p>Duration: ~30 minutes</p> <p>Completed:</p> <ul> <li>\u2705 Fixed <code>implementation_imports</code> hints (importing from lib/src of another package)</li> <li>\u2705 Exported application layer from soliplex_client barrel</li> <li>\u2705 Renamed CompletionResult types to avoid domain conflicts</li> <li>\u2705 Updated all frontend imports to use barrel exports</li> </ul> <p>Changes:</p> <ol> <li>Domain barrel (<code>domain.dart</code>):</li> <li>Export status types explicitly (Cancelled, Completed, Failed, Idle, Running)</li> <li> <p>Hide streaming types (StreamingState, Streaming, NotStreaming) since they're in application layer</p> </li> <li> <p>Main barrel (<code>soliplex_client.dart</code>):</p> </li> <li> <p>Added <code>export 'src/application/application.dart'</code></p> </li> <li> <p>Frontend type renames:</p> </li> <li><code>Failed</code> \u2192 <code>FailedResult</code> (CompletionResult subtype)</li> <li><code>Cancelled</code> \u2192 <code>CancelledResult</code> (CompletionResult subtype)</li> <li> <p>This avoids conflicts with domain's <code>Failed</code>/<code>Cancelled</code> (ConversationStatus subtypes)</p> </li> <li> <p>Test file updates:</p> </li> <li><code>conversation_test.dart</code>: Uses <code>domain.</code> prefix for domain streaming types</li> <li>All frontend tests: Updated to use <code>FailedResult</code>/<code>CancelledResult</code></li> <li>Cleaned up unused shown names in imports</li> </ol> <p>Metrics:</p> <ul> <li>Analyzer: 0 errors, 0 warnings, 0 hints \u2713</li> <li>Tests: 187 passing (0 failures) \u2713</li> <li>Files Modified: 12 files</li> </ul> <p>Key Decision:</p> <p>Renamed frontend <code>Failed</code>/<code>Cancelled</code> to <code>FailedResult</code>/<code>CancelledResult</code> rather than using prefixes everywhere. This provides clearer semantics (domain status types vs completion results) and cleaner code at call sites.</p> <p>Files Modified:</p> <ul> <li><code>packages/soliplex_client/lib/src/domain/domain.dart</code></li> <li><code>packages/soliplex_client/lib/soliplex_client.dart</code></li> <li><code>packages/soliplex_client/test/domain/conversation_test.dart</code></li> <li><code>lib/core/models/active_run_state.dart</code></li> <li><code>lib/core/providers/active_run_notifier.dart</code></li> <li><code>lib/features/chat/widgets/message_list.dart</code></li> <li><code>lib/features/chat/chat_panel.dart</code></li> <li><code>test/core/models/active_run_state_test.dart</code></li> <li><code>test/core/providers/active_run_notifier_test.dart</code></li> <li><code>test/features/chat/chat_panel_test.dart</code></li> <li><code>test/features/chat/widgets/chat_input_test.dart</code></li> <li><code>test/features/chat/widgets/message_list_test.dart</code></li> </ul>"},{"location":"flutter/planning/worklogs/core-frontend-worklog/#session-7-2025-12-23-domain-layer-cleanup-arch-v3-complete","title":"Session 7: 2025-12-23 - Domain Layer Cleanup (Arch v3 Complete)","text":"<p>Duration: ~20 minutes</p> <p>Completed:</p> <ul> <li>\u2705 Removed streaming from domain layer (Step 1 of arch-v3)</li> <li>\u2705 Simplified domain barrel export</li> <li>\u2705 Cleaned up obsolete hide clauses in application layer</li> <li>\u2705 Removed streaming-related tests from conversation_test.dart</li> <li>\u2705 Blacksmith review: approved</li> </ul> <p>Changes:</p> <ol> <li>conversation.dart:</li> <li>Removed <code>StreamingState</code> sealed class and subtypes (<code>NotStreaming</code>, <code>Streaming</code>)</li> <li>Removed <code>streaming</code> field from <code>Conversation</code></li> <li>Removed <code>withStreaming()</code> method</li> <li>Removed <code>isStreaming</code> getter</li> <li> <p>Updated <code>copyWith()</code> and <code>toString()</code> to remove streaming references</p> </li> <li> <p>domain.dart:</p> </li> <li> <p>Simplified from explicit <code>show</code>/<code>hide</code> export to <code>export 'conversation.dart';</code></p> </li> <li> <p>agui_event_processor.dart:</p> </li> <li> <p>Removed obsolete <code>hide NotStreaming, Streaming, StreamingState</code> clause</p> </li> <li> <p>conversation_test.dart:</p> </li> <li>Removed <code>withStreaming</code> test group</li> <li>Removed <code>isStreaming</code> test group</li> <li>Removed <code>StreamingState</code> test group</li> <li>Updated <code>toString</code> test</li> </ol> <p>Metrics:</p> <ul> <li>Analyzer: 0 errors, 0 warnings, 0 hints \u2713</li> <li>Tests: 187 passing (0 failures) \u2713</li> <li>Files Modified: 4 files</li> <li>Lines Removed: ~150 (dead code + tests for removed behavior)</li> </ul> <p>Architectural Enhancement v3: COMPLETE</p> <p>All success criteria met: - Conversation aggregate is pure domain (no streaming state) \u2705 - StreamingState lives in application layer \u2705 - AG-UI event processing is pure function in application layer \u2705 - ActiveRunNotifier uses processor, no direct event switching \u2705 - All tests pass \u2705 - 0 analyzer issues \u2705</p> <p>Branch: <code>arch-v3/domain-cleanup</code></p> <p>Last updated: 2025-12-23 (Domain layer cleanup - Arch v3 complete)</p>"},{"location":"flutter/rules/flutter_rules/","title":"Flutter Development Rules","text":"<p>Expert Flutter/Dart development guide emphasizing performance, maintainability, and modern best practices.</p>"},{"location":"flutter/rules/flutter_rules/#core-principles","title":"Core Principles","text":"<ul> <li>SOLID - Apply throughout the codebase</li> <li>Composition over inheritance - Build complex widgets from smaller ones</li> <li>Immutability - Prefer immutable data structures; widgets should be immutable</li> <li>Separation of concerns - UI logic separate from business logic</li> </ul>"},{"location":"flutter/rules/flutter_rules/#code-style","title":"Code Style","text":"<pre><code>PascalCase  \u2192 classes\ncamelCase   \u2192 members, variables, functions, enums\nsnake_case  \u2192 file names\n</code></pre> <ul> <li>Line length: 80 characters max</li> <li>Functions: single purpose, &lt;20 lines</li> <li>Names: meaningful, descriptive, no abbreviations</li> <li>Comments: explain why, not what</li> <li>No trailing comments</li> </ul>"},{"location":"flutter/rules/flutter_rules/#dart-best-practices","title":"Dart Best Practices","text":"<p>Null Safety:</p> <ul> <li>Write soundly null-safe code</li> <li>Avoid <code>!</code> unless value is guaranteed non-null</li> <li>Use pattern matching to simplify null handling</li> </ul> <p>Async:</p> <ul> <li>Use <code>Future</code>/<code>async</code>/<code>await</code> for single async operations</li> <li>Use <code>Stream</code> for sequences of async events</li> <li>Always handle errors in async code</li> </ul> <p>Modern Features:</p> <ul> <li>Use pattern matching where it simplifies code</li> <li>Use records for returning multiple values</li> <li>Use exhaustive <code>switch</code> expressions (no <code>break</code> needed)</li> <li>Use arrow syntax for one-line functions</li> </ul> <p>Class Organization:</p> <ul> <li>Related classes in same library file</li> <li>Group related libraries in same folder</li> <li>Document all public APIs with <code>///</code> comments</li> </ul>"},{"location":"flutter/rules/flutter_rules/#flutter-best-practices","title":"Flutter Best Practices","text":"<p>Widgets:</p> <ul> <li><code>StatelessWidget</code> must be immutable</li> <li>Prefer small, private Widget classes over helper methods returning Widget</li> <li>Break large <code>build()</code> methods into smaller widget classes</li> <li>Use <code>const</code> constructors whenever possible</li> </ul> <p>Performance:</p> <ul> <li>Use <code>ListView.builder</code> / <code>SliverList</code> for long lists (lazy loading)</li> <li>Use <code>compute()</code> for expensive calculations (separate isolate)</li> <li>Never do network calls or heavy computation in <code>build()</code></li> </ul> <p>State Management (this project uses Riverpod):</p> <ul> <li>Separate ephemeral state from app state</li> <li>Use manual constructor dependency injection</li> <li>Abstract data sources with repositories for testability</li> </ul> <p>Navigation:</p> <ul> <li>Use <code>go_router</code> for declarative routing and deep linking</li> <li>Use <code>Navigator</code> only for dialogs/temporary views</li> </ul>"},{"location":"flutter/rules/flutter_rules/#architecture","title":"Architecture","text":"<p>Layers:</p> <pre><code>Presentation  \u2192 widgets, screens\nDomain        \u2192 business logic\nData          \u2192 models, API clients\nCore          \u2192 shared utilities, extensions\n</code></pre> <p>Feature-based Organization:</p> <p>Each feature has its own presentation, domain, and data subfolders.</p>"},{"location":"flutter/rules/flutter_rules/#testing","title":"Testing","text":"<p>Patterns:</p> <ul> <li>Arrange-Act-Assert (Given-When-Then)</li> <li>Prefer fakes/stubs over mocks</li> <li>Use <code>mockito</code> or <code>mocktail</code> only when necessary</li> </ul> <p>Types:</p> <ul> <li>Unit tests (<code>package:test</code>) \u2192 domain logic, data layer, state</li> <li>Widget tests (<code>package:flutter_test</code>) \u2192 UI components</li> <li>Integration tests (<code>package:integration_test</code>) \u2192 end-to-end flows</li> </ul> <p>Assertions:</p> <p>Prefer <code>package:checks</code> for expressive, readable assertions.</p>"},{"location":"flutter/rules/flutter_rules/#theming","title":"Theming","text":"<p>Material 3:</p> <ul> <li>Use <code>ColorScheme.fromSeed()</code> for harmonious palettes</li> <li>Provide both <code>theme</code> and <code>darkTheme</code> to MaterialApp</li> <li>Centralize component styles in <code>ThemeData</code></li> </ul> <p>Custom Tokens:</p> <p>Use <code>ThemeExtension&lt;T&gt;</code> for styles not in standard ThemeData.</p> <p>Accessibility:</p> <ul> <li>Text contrast ratio: 4.5:1 minimum (3:1 for large text)</li> <li>Test with increased system font size</li> <li>Use <code>Semantics</code> widget for screen reader labels</li> </ul>"},{"location":"flutter/rules/flutter_rules/#layout","title":"Layout","text":"<p>Overflow Prevention:</p> <ul> <li><code>Expanded</code> - fill remaining space</li> <li><code>Flexible</code> - shrink to fit (don't mix with Expanded)</li> <li><code>Wrap</code> - move to next line when overflowing</li> <li><code>SingleChildScrollView</code> - fixed content larger than viewport</li> <li><code>ListView.builder</code> - long lists</li> </ul> <p>Responsiveness:</p> <p>Use <code>LayoutBuilder</code> or <code>MediaQuery</code> for responsive layouts.</p>"},{"location":"flutter/rules/flutter_rules/#code-generation","title":"Code Generation","text":"<p>When using <code>json_serializable</code> or similar:</p> <pre><code>dart run build_runner build --delete-conflicting-outputs\n</code></pre>"},{"location":"flutter/rules/flutter_rules/#logging","title":"Logging","text":"<p>Use <code>dart:developer</code> log instead of <code>print</code>:</p> <pre><code>import 'dart:developer' as developer;\n\ndeveloper.log('Message', name: 'myapp.module', error: e, stackTrace: s);\n</code></pre>"},{"location":"flutter/rules/flutter_rules/#quick-reference","title":"Quick Reference","text":"Do Don't <code>const</code> constructors Mutable widgets Small, focused, reusable Widget classes Giant <code>build()</code> methods Pattern matching Excessive null checks with <code>!</code> <code>ListView.builder</code> <code>ListView</code> with large lists Fakes/stubs in tests Heavy mock usage <code>Theme.of(context)</code> Hardcoded colors/styles"},{"location":"flutter/summary/client/","title":"soliplex_client Package","text":"<p>Pure Dart client library for the Soliplex backend. No Flutter dependencies - can be used in any Dart environment (CLI, server, Flutter).</p>"},{"location":"flutter/summary/client/#package-structure","title":"Package Structure","text":"<pre><code>soliplex_client/lib/src/\n\u251c\u2500\u2500 agui/              # AG-UI streaming protocol\n\u2502   \u251c\u2500\u2500 agui_event.dart\n\u2502   \u251c\u2500\u2500 text_message_buffer.dart\n\u2502   \u251c\u2500\u2500 tool_call_buffer.dart\n\u2502   \u251c\u2500\u2500 tool_registry.dart\n\u2502   \u2514\u2500\u2500 thread.dart\n\u251c\u2500\u2500 api/               # REST API client\n\u2502   \u2514\u2500\u2500 soliplex_api.dart\n\u251c\u2500\u2500 errors/            # Exception hierarchy\n\u2502   \u2514\u2500\u2500 exceptions.dart\n\u251c\u2500\u2500 http/              # HTTP transport layer\n\u2502   \u251c\u2500\u2500 dart_http_client.dart\n\u2502   \u251c\u2500\u2500 http_client_adapter.dart\n\u2502   \u251c\u2500\u2500 http_observer.dart\n\u2502   \u251c\u2500\u2500 http_response.dart\n\u2502   \u251c\u2500\u2500 http_transport.dart\n\u2502   \u251c\u2500\u2500 observable_http_client.dart\n\u2502   \u2514\u2500\u2500 soliplex_http_client.dart\n\u251c\u2500\u2500 models/            # Data models\n\u2502   \u251c\u2500\u2500 chat_message.dart\n\u2502   \u251c\u2500\u2500 models.dart\n\u2502   \u251c\u2500\u2500 room.dart\n\u2502   \u251c\u2500\u2500 run_info.dart\n\u2502   \u2514\u2500\u2500 thread_info.dart\n\u2514\u2500\u2500 utils/             # Utilities\n    \u251c\u2500\u2500 cancel_token.dart\n    \u2514\u2500\u2500 url_builder.dart\n</code></pre>"},{"location":"flutter/summary/client/#architecture-overview","title":"Architecture Overview","text":""},{"location":"flutter/summary/client/#layered-design","title":"Layered Design","text":"<p>The package follows a layered architecture with clear separation of concerns:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   Application Layer                      \u2502\n\u2502  (Flutter app consumes SoliplexApi and Thread)          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                          \u2502\n                          \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Client Layer                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502  SoliplexApi    \u2502    \u2502      Thread               \u2502   \u2502\n\u2502  \u2502  (REST CRUD)    \u2502    \u2502  (AG-UI orchestration)    \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n            \u2502                           \u2502\n            \u25bc                           \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  Transport Layer                         \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502              HttpTransport                       \u2502    \u2502\n\u2502  \u2502  - JSON encode/decode                           \u2502    \u2502\n\u2502  \u2502  - Exception mapping                            \u2502    \u2502\n\u2502  \u2502  - CancelToken support                          \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502\n                           \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   Adapter Layer                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502  ObservableHttpClient (optional decorator)       \u2502    \u2502\n\u2502  \u2502         Wraps any client below \u2193                 \u2502    \u2502\n\u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524    \u2502\n\u2502  \u2502         SoliplexHttpClient (interface)           \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                       \u25b2                                  \u2502\n\u2502           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                      \u2502\n\u2502           \u2502                       \u2502                      \u2502\n\u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u2502\n\u2502    \u2502DartHttpClient\u2502     \u2502CupertinoHttpClient\u2502           \u2502\n\u2502    \u2502 (default)    \u2502     \u2502 (iOS/macOS)*     \u2502            \u2502\n\u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2502\n\u2502                                                          \u2502\n\u2502  * In soliplex_client_native package                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/summary/client/#key-design-decisions","title":"Key Design Decisions","text":"<p>1. Pluggable HTTP Clients</p> <p>The <code>SoliplexHttpClient</code> interface allows different HTTP implementations:</p> <ul> <li><code>DartHttpClient</code> - Default pure-Dart implementation using <code>package:http</code></li> <li>Platform clients (in <code>soliplex_client_native</code>) - CupertinoHttpClient for iOS/macOS</li> <li><code>ObservableHttpClient</code> - Wraps any client to add monitoring</li> </ul> <p>2. Sealed Class Hierarchies</p> <p>Used extensively for type safety and exhaustive pattern matching:</p> <ul> <li><code>ChatMessage</code> - Different message types (text, error, tool call, etc.)</li> <li><code>RunState</code> - Run lifecycle states (no active, active, completed, failed)</li> <li><code>TextMessageBuffer</code> - Buffer states (inactive vs active)</li> <li><code>AgUiEvent</code> - 19 event types from the backend</li> </ul> <p>3. Immutable Data Models</p> <p>All models are <code>@immutable</code> with <code>copyWith()</code> methods:</p> <ul> <li>Prevents accidental mutation</li> <li>Thread-safe by design</li> <li>Enables value equality</li> </ul> <p>4. Event-Driven Streaming</p> <p>AG-UI uses Server-Sent Events (SSE) for real-time updates:</p> <pre><code>Backend SSE Stream\n      \u2502\n      \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Byte Stream    \u2502\u2500\u2500\u2500\u2500\u25b6\u2502  SSE Parser     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n                                 \u25bc\n                        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                        \u2502  AgUiEvent      \u2502\n                        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u2502\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502                      \u2502                      \u2502\n          \u25bc                      \u25bc                      \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502TextMessageBuffer\u2502   \u2502 ToolCallBuffer  \u2502   \u2502  State Map      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502                      \u2502                      \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                 \u25bc\n                        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                        \u2502  UI Updates     \u2502\n                        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"flutter/summary/client/#core-components","title":"Core Components","text":""},{"location":"flutter/summary/client/#soliplexapi","title":"SoliplexApi","text":"<p>High-level REST client for CRUD operations. Wraps <code>HttpTransport</code> and normalizes backend responses.</p> <pre><code>final api = SoliplexApi(\n  transport: HttpTransport(client: DartHttpClient()),\n  urlBuilder: UrlBuilder('https://api.example.com/api/v1'),\n);\n\n// Room operations\nfinal rooms = await api.getRooms();\nfinal room = await api.getRoom('room-123');\n\n// Thread operations\nfinal threads = await api.getThreads('room-123');\nfinal thread = await api.createThread('room-123');\nawait api.deleteThread('room-123', 'thread-456');\n\n// Run operations\nfinal run = await api.createRun('room-123', 'thread-456');\n</code></pre>"},{"location":"flutter/summary/client/#thread","title":"Thread","text":"<p>Orchestrates AG-UI streaming. Manages buffers, state, and tool execution.</p> <pre><code>final thread = Thread(\n  transport: httpTransport,\n  urlBuilder: urlBuilder,\n  roomId: 'room-123',\n  threadId: 'thread-456',\n  toolRegistry: registry,  // Optional client-side tools\n);\n\n// Stream events from a run\nawait for (final event in thread.run(\n  runId: 'run-789',\n  userMessage: 'Hello!',\n  cancelToken: cancelToken,\n)) {\n  // Events are processed internally; yielded for observation\n}\n\n// Access accumulated state\nprint(thread.messages);  // List&lt;ChatMessage&gt;\nprint(thread.state);     // Map&lt;String, dynamic&gt;\nprint(thread.runState);  // RunState (sealed class)\n</code></pre> <p>RunState sealed class:</p> <pre><code>sealed class RunState {\n  NoActiveRun()                      // No run executing\n  ActiveRun(runId)                   // Run in progress\n  CompletedRun(runId)                // Run finished successfully\n  FailedRun(runId, errorMessage)     // Run encountered error\n}\n</code></pre>"},{"location":"flutter/summary/client/#httptransport","title":"HttpTransport","text":"<p>JSON serialization and exception mapping layer.</p> <pre><code>final transport = HttpTransport(\n  client: DartHttpClient(),\n  defaultTimeout: Duration(seconds: 30),\n);\n\n// Request with automatic JSON handling\nfinal data = await transport.request&lt;Map&lt;String, dynamic&gt;&gt;(\n  'POST',\n  uri,\n  body: {'message': 'Hello'},  // Auto-encoded to JSON\n  fromJson: Room.fromJson,     // Auto-decoded response\n  cancelToken: token,\n);\n\n// SSE streaming\nfinal stream = transport.requestStream('POST', uri, body: body);\n</code></pre> <p>Exception mapping:</p> Status Code Exception 401, 403 <code>AuthException</code> 404 <code>NotFoundException</code> Other 4xx/5xx <code>ApiException</code> Network errors <code>NetworkException</code> Cancelled <code>CancelledException</code>"},{"location":"flutter/summary/client/#buffers","title":"Buffers","text":"<p>Accumulate streaming content with immutable state transitions.</p> <p>TextMessageBuffer:</p> <pre><code>// Start inactive\nTextMessageBuffer buffer = TextMessageBuffer.empty;\n\n// TEXT_MESSAGE_START event\nbuffer = buffer.start(messageId: 'msg-123');\n\n// TEXT_MESSAGE_CONTENT events\nif (buffer case ActiveTextBuffer active) {\n  buffer = active.append('Hello, ');\n  buffer = (buffer as ActiveTextBuffer).append('world!');\n}\n\n// TEXT_MESSAGE_END event\nif (buffer case ActiveTextBuffer active) {\n  final (newBuffer, message) = active.complete();\n  buffer = newBuffer;  // Back to InactiveTextBuffer\n  // message.text == 'Hello, world!'\n}\n</code></pre> <p>ToolCallBuffer:</p> <pre><code>final buffer = ToolCallBuffer();\n\n// TOOL_CALL_START event\nbuffer.startToolCall(callId: 'call-1', name: 'calculator');\n\n// TOOL_CALL_ARGS events (streaming)\nbuffer.appendArgs(callId: 'call-1', delta: '{\"a\":');\nbuffer.appendArgs(callId: 'call-1', delta: '1,\"b\":2}');\n\n// TOOL_CALL_END event\nfinal toolCall = buffer.completeToolCall(callId: 'call-1');\n\n// TOOL_CALL_RESULT event\nbuffer.setResult(callId: 'call-1', result: '3');\n</code></pre>"},{"location":"flutter/summary/client/#toolregistry","title":"ToolRegistry","text":"<p>Client-side tool execution for AG-UI.</p> <pre><code>final registry = ToolRegistry();\n\n// Register a tool\nregistry.register(\n  name: 'calculator',\n  executor: (call) async {\n    final args = jsonDecode(call.arguments);\n    return ((args['a'] as num) + (args['b'] as num)).toString();\n  },\n);\n\n// Fire-and-forget tool (side effects, no result needed)\nregistry.register(\n  name: 'analytics',\n  executor: (call) async { /* log event */ return ''; },\n  fireAndForget: true,\n);\n\n// Execute\nfinal result = await registry.execute(toolCallInfo);\n</code></pre>"},{"location":"flutter/summary/client/#data-models","title":"Data Models","text":""},{"location":"flutter/summary/client/#chatmessage-sealed-hierarchy","title":"ChatMessage (Sealed Hierarchy)","text":"<pre><code>sealed class ChatMessage {\n  TextMessage       // Regular text, with streaming support\n  ErrorMessage      // System-generated errors\n  ToolCallMessage   // Contains List&lt;ToolCallInfo&gt;\n  GenUiMessage      // Widget render data\n  LoadingMessage    // Progress indicator\n}\n\n// TextMessage has streaming fields\nTextMessage(\n  text: 'Hello',\n  isStreaming: true,       // Currently streaming\n  thinkingText: '...',     // Reasoning content\n  isThinkingStreaming: false,\n);\n\n// ToolCallInfo tracks status\nToolCallInfo(\n  id: 'call-1',\n  name: 'search',\n  arguments: '{\"query\":\"...\"}',\n  status: ToolCallStatus.executing,  // pending/executing/completed/failed\n  result: '',\n);\n</code></pre>"},{"location":"flutter/summary/client/#room-threadinfo-runinfo","title":"Room, ThreadInfo, RunInfo","text":"<p>Simple immutable data classes with <code>fromJson()</code>, <code>toJson()</code>, <code>copyWith()</code>.</p> <pre><code>Room(id: 'room-1', name: 'General', description: '...', metadata: {});\n\nThreadInfo(\n  id: 'thread-1',\n  roomId: 'room-1',\n  name: 'Thread',\n  createdAt: DateTime.now(),\n);\n\nRunInfo(\n  id: 'run-1',\n  threadId: 'thread-1',\n  status: RunStatus.running,  // pending/running/completed/failed/cancelled\n);\n</code></pre>"},{"location":"flutter/summary/client/#ag-ui-events","title":"AG-UI Events","text":"<p>19 event types from the backend SSE stream:</p> <p>Run Lifecycle:</p> <ul> <li><code>RunStartedEvent</code> - Run began</li> <li><code>RunFinishedEvent</code> - Run completed successfully</li> <li><code>RunErrorEvent</code> - Run encountered error</li> </ul> <p>Steps:</p> <ul> <li><code>StepStartedEvent</code> - Step began</li> <li><code>StepFinishedEvent</code> - Step completed</li> </ul> <p>Text Messages (streaming):</p> <ul> <li><code>TextMessageStartEvent</code> - Begin streaming message</li> <li><code>TextMessageContentEvent</code> - Text chunk (delta)</li> <li><code>TextMessageEndEvent</code> - Message complete</li> </ul> <p>Tool Calls (streaming):</p> <ul> <li><code>ToolCallStartEvent</code> - Tool call began</li> <li><code>ToolCallArgsEvent</code> - Arguments chunk (delta)</li> <li><code>ToolCallEndEvent</code> - Arguments complete</li> <li><code>ToolCallResultEvent</code> - Result available</li> </ul> <p>State Management:</p> <ul> <li><code>StateSnapshotEvent</code> - Complete state replacement</li> <li><code>StateDeltaEvent</code> - JSON Patch operations</li> </ul> <p>Activity:</p> <ul> <li><code>ActivitySnapshotEvent</code> - Complete activity state</li> <li><code>ActivityDeltaEvent</code> - Activity JSON Patch</li> </ul> <p>Other:</p> <ul> <li><code>MessagesSnapshotEvent</code> - Replace all messages</li> <li><code>CustomEvent</code> - Application-specific events</li> <li><code>UnknownEvent</code> - Unrecognized event types</li> </ul>"},{"location":"flutter/summary/client/#http-observability","title":"HTTP Observability","text":""},{"location":"flutter/summary/client/#observablehttpclient","title":"ObservableHttpClient","text":"<p>The <code>ObservableHttpClient</code> is a decorator that wraps any <code>SoliplexHttpClient</code> to enable monitoring. It does not wrap clients automatically - you must explicitly compose it:</p> <pre><code>// Without observation (default)\nfinal transport = HttpTransport(client: DartHttpClient());\n\n// With observation (explicit wrapping required)\nfinal observable = ObservableHttpClient(\n  client: DartHttpClient(),\n  observers: [LoggingObserver(), MetricsObserver()],\n);\nfinal transport = HttpTransport(client: observable);\n</code></pre>"},{"location":"flutter/summary/client/#observer-interface","title":"Observer Interface","text":"<pre><code>abstract class HttpObserver {\n  void onRequest(HttpRequestEvent event);\n  void onResponse(HttpResponseEvent event);\n  void onError(HttpErrorEvent event);\n  void onStreamStart(HttpStreamStartEvent event);\n  void onStreamEnd(HttpStreamEndEvent event);\n}\n</code></pre>"},{"location":"flutter/summary/client/#what-gets-observed","title":"What Gets Observed","text":"<p>For regular requests (<code>request()</code>):</p> Event When <code>onRequest()</code> Before request starts <code>onResponse()</code> After successful response <code>onError()</code> When <code>SoliplexException</code> is thrown <p>For streaming (<code>requestStream()</code>):</p> Event When <code>onStreamStart()</code> When stream begins <code>onStreamEnd()</code> When stream completes or errors (includes byte count)"},{"location":"flutter/summary/client/#observability-with-darthttpclient","title":"Observability with DartHttpClient","text":"<p>When <code>ObservableHttpClient</code> wraps <code>DartHttpClient</code>, all real-world network transactions are visible because <code>DartHttpClient</code> converts network errors to <code>SoliplexException</code> subtypes:</p> Original Exception Converted To <code>TimeoutException</code> <code>NetworkException(isTimeout: true)</code> <code>SocketException</code> <code>NetworkException</code> <code>HttpException</code> <code>NetworkException</code> <code>http.ClientException</code> <code>NetworkException</code> <p>Since <code>ObservableHttpClient</code> catches <code>SoliplexException</code>, all these trigger <code>onError()</code>.</p> <p>Edge cases not observed:</p> <ol> <li><code>StateError</code> from using a closed client (programming error)</li> <li>Non-<code>SocketException</code> errors during streaming that aren't wrapped    (rare edge case in <code>DartHttpClient.requestStream()</code>)</li> </ol> <p>These are programming errors or rare edge cases, not normal network operations.</p>"},{"location":"flutter/summary/client/#request-correlation","title":"Request Correlation","text":"<p>Each request gets a unique ID for correlating request/response/error events:</p> <pre><code>class MyObserver extends HttpObserver {\n  @override\n  void onRequest(HttpRequestEvent event) {\n    print('[${event.requestId}] ${event.method} ${event.uri}');\n  }\n\n  @override\n  void onResponse(HttpResponseEvent event) {\n    print('[${event.requestId}] ${event.statusCode} '\n        'in ${event.duration.inMilliseconds}ms');\n  }\n}\n</code></pre>"},{"location":"flutter/summary/client/#exception-hierarchy","title":"Exception Hierarchy","text":"<pre><code>SoliplexException (abstract)\n\u251c\u2500\u2500 AuthException        - 401/403, redirect to login\n\u251c\u2500\u2500 NetworkException     - Connection failed, show retry\n\u251c\u2500\u2500 ApiException         - 4xx/5xx, show error message\n\u251c\u2500\u2500 NotFoundException    - 404, navigate away\n\u2514\u2500\u2500 CancelledException   - User cancelled, handle silently\n</code></pre> <p>All exceptions preserve <code>originalError</code> and <code>stackTrace</code> for debugging.</p>"},{"location":"flutter/summary/client/#data-flow-examples","title":"Data Flow Examples","text":""},{"location":"flutter/summary/client/#rest-api-call","title":"REST API Call","text":"<pre><code>api.getRoom('room-123')\n  \u2193\nHttpTransport.request&lt;Room&gt;()\n  \u2193\n[ObservableHttpClient.request() - if wrapped]\n  \u2193\nDartHttpClient.request()\n  \u2193\nNetwork request\n  \u2193\nHttpResponse\n  \u2193\nStatus code check \u2192 throw if error\n  \u2193\nJSON decode\n  \u2193\nRoom.fromJson()\n  \u2193\nRoom object\n</code></pre>"},{"location":"flutter/summary/client/#ag-ui-streaming","title":"AG-UI Streaming","text":"<pre><code>thread.run(runId, userMessage)\n  \u2193\nPOST /rooms/{roomId}/agui/{threadId}\n  \u2193\nSSE byte stream\n  \u2193\nUTF-8 decode \u2192 buffer until \\n\\n\n  \u2193\nParse \"data: {...}\" lines\n  \u2193\nAgUiEvent.fromJson() \u2192 typed event\n  \u2193\nthread.processEvent()\n  \u251c\u2500\u2500 TextMessage* \u2192 TextMessageBuffer \u2192 TextMessage\n  \u251c\u2500\u2500 ToolCall* \u2192 ToolCallBuffer \u2192 ToolCallInfo \u2192 execute\n  \u251c\u2500\u2500 State* \u2192 JSON Patch \u2192 _state map\n  \u2514\u2500\u2500 RunFinished/Error \u2192 RunState update\n  \u2193\nyield event to consumer\n</code></pre>"},{"location":"flutter/summary/client/#design-patterns-summary","title":"Design Patterns Summary","text":"Pattern Usage Adapter <code>SoliplexHttpClient</code> interface with <code>DartHttpClient</code> implementation Decorator <code>ObservableHttpClient</code> wraps clients with monitoring (manual) Factory <code>AgUiEvent.fromJson()</code> creates appropriate event subclass Repository <code>SoliplexApi</code> abstracts backend communication State Machine <code>RunState</code> sealed class for run lifecycle Buffer/Accumulator <code>TextMessageBuffer</code>, <code>ToolCallBuffer</code> for streaming Registry <code>ToolRegistry</code> for client-side tool registration Observer <code>HttpObserver</code> for HTTP monitoring"},{"location":"flutter/summary/client/#dependencies","title":"Dependencies","text":"<ul> <li>http (^1.2.0) - Pure Dart HTTP client</li> <li>meta (^1.9.0) - <code>@immutable</code> annotation</li> </ul>"},{"location":"ingester/API/","title":"Soliplex Ingester API Reference","text":""},{"location":"ingester/API/#base-url","title":"Base URL","text":"<p>All API endpoints are prefixed with <code>/api/v1/</code> unless otherwise noted.</p>"},{"location":"ingester/API/#authentication","title":"Authentication","text":"<p>Currently, the API does not implement authentication. This should be added for production deployments.</p>"},{"location":"ingester/API/#document-endpoints","title":"Document Endpoints","text":""},{"location":"ingester/API/#get-apiv1document","title":"GET /api/v1/document/","text":"<p>Get documents by source or batch ID.</p> <p>Query Parameters: - <code>source</code> (string, optional) - Source identifier to filter documents - <code>batch_id</code> (integer, optional) - Batch ID to filter documents</p> <p>Response: - <code>200 OK</code> - Array of DocumentURI objects - <code>400 Bad Request</code> - Neither source nor batch_id provided</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/document/?batch_id=1\"\n</code></pre></p>"},{"location":"ingester/API/#post-apiv1documentingest-document","title":"POST /api/v1/document/ingest-document","text":"<p>Ingest a new document into the system.</p> <p>Content-Type: <code>multipart/form-data</code></p> <p>Form Parameters: - <code>file</code> (file, optional) - Document file to upload - <code>input_uri</code> (string, optional) - URI to fetch document from - <code>mime_type</code> (string, optional) - MIME type of the document - <code>source_uri</code> (string, required) - Source URI/path identifier - <code>source</code> (string, required) - Source system identifier - <code>batch_id</code> (integer, required) - Batch ID to assign document - <code>doc_meta</code> (string, optional) - JSON string of metadata (default: <code>{}</code>) - <code>priority</code> (integer, optional) - Processing priority (default: 0)</p> <p>Response: - <code>201 Created</code> - Document ingested successfully (new document) - <code>203 Non-Authoritative Information</code> - Document already exists in a different batch - <code>400 Bad Request</code> - Invalid parameters or metadata - <code>500 Internal Server Error</code> - Processing error</p> <p>Success Response Body: <pre><code>{\n  \"batch_id\": 1,\n  \"document_uri\": \"/path/to/doc.pdf\",\n  \"document_hash\": \"sha256-abc123...\",\n  \"source\": \"filesystem\",\n  \"uri_id\": 42\n}\n</code></pre></p> <p>Notes: - The <code>batch_id</code> in the response reflects the batch where the document URI actually resides - If a document with the same hash already exists in a different batch, the response returns <code>203</code> with the original batch ID - This prevents duplicate processing while informing the caller that the document was previously ingested</p> <p>Example: <pre><code>curl -X POST \"http://localhost:8000/api/v1/document/ingest-document\" \\\n  -F \"file=@document.pdf\" \\\n  -F \"source_uri=/documents/report.pdf\" \\\n  -F \"source=filesystem\" \\\n  -F \"batch_id=1\" \\\n  -F \"doc_meta={\\\"author\\\":\\\"John Doe\\\"}\"\n</code></pre></p>"},{"location":"ingester/API/#batch-endpoints","title":"Batch Endpoints","text":""},{"location":"ingester/API/#get-apiv1batch","title":"GET /api/v1/batch/","text":"<p>List all document batches.</p> <p>Response: - <code>200 OK</code> - Array of DocumentBatch objects</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/batch/\"\n</code></pre></p>"},{"location":"ingester/API/#post-apiv1batch","title":"POST /api/v1/batch/","text":"<p>Create a new document batch.</p> <p>Content-Type: <code>application/x-www-form-urlencoded</code></p> <p>Form Parameters: - <code>source</code> (string, required) - Source system identifier - <code>name</code> (string, required) - Human-readable batch name</p> <p>Response: - <code>201 Created</code> - Batch created successfully</p> <p>Response Body: <pre><code>{\n  \"batch_id\": 1\n}\n</code></pre></p> <p>Example: <pre><code>curl -X POST \"http://localhost:8000/api/v1/batch/\" \\\n  -d \"source=filesystem\" \\\n  -d \"name=Q4 Reports\"\n</code></pre></p>"},{"location":"ingester/API/#post-apiv1batchstart-workflows","title":"POST /api/v1/batch/start-workflows","text":"<p>Start workflow processing for all documents in a batch.</p> <p>Content-Type: <code>application/x-www-form-urlencoded</code></p> <p>Form Parameters: - <code>batch_id</code> (integer, required) - Batch ID to process - <code>workflow_definition_id</code> (string, optional) - Workflow to use (default: from config) - <code>priority</code> (integer, optional) - Processing priority (default: 0) - <code>param_id</code> (string, optional) - Parameter set ID (default: \"default\")</p> <p>Response: - <code>201 Created</code> - Workflows started successfully - <code>404 Not Found</code> - Batch not found - <code>500 Internal Server Error</code> - Processing error</p> <p>Response Body: <pre><code>{\n  \"message\": \"Workflows started\",\n  \"workflows\": 10,\n  \"run_group\": 5\n}\n</code></pre></p> <p>Example: <pre><code>curl -X POST \"http://localhost:8000/api/v1/batch/start-workflows\" \\\n  -d \"batch_id=1\" \\\n  -d \"workflow_definition_id=batch\" \\\n  -d \"param_id=default\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1batchstatus","title":"GET /api/v1/batch/status","text":"<p>Get detailed status for a batch.</p> <p>Query Parameters: - <code>batch_id</code> (integer, required) - Batch ID</p> <p>Response: - <code>200 OK</code> - Batch status details - <code>404 Not Found</code> - Batch not found</p> <p>Response Body: <pre><code>{\n  \"batch\": {\n    \"id\": 1,\n    \"name\": \"Q4 Reports\",\n    \"source\": \"filesystem\",\n    \"start_date\": \"2025-01-15T10:00:00\",\n    \"completed_date\": null\n  },\n  \"document_count\": 10,\n  \"workflow_count\": {\n    \"COMPLETED\": 7,\n    \"RUNNING\": 2,\n    \"PENDING\": 1\n  },\n  \"workflows\": [...],\n  \"parsed\": 7,\n  \"remaining\": 3\n}\n</code></pre></p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/batch/status?batch_id=1\"\n</code></pre></p>"},{"location":"ingester/API/#workflow-endpoints","title":"Workflow Endpoints","text":""},{"location":"ingester/API/#get-apiv1workflow","title":"GET /api/v1/workflow/","text":"<p>Get workflow runs, optionally filtered by batch ID.</p> <p>Query Parameters: - <code>batch_id</code> (integer, optional) - Filter by batch ID</p> <p>Response: - <code>200 OK</code> - Array of WorkflowRun objects</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/?batch_id=1\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowby-status","title":"GET /api/v1/workflow/by-status","text":"<p>Get workflow runs filtered by status.</p> <p>Query Parameters: - <code>status</code> (enum, required) - One of: PENDING, RUNNING, COMPLETED, ERROR, FAILED - <code>batch_id</code> (integer, optional) - Filter by batch ID</p> <p>Response: - <code>200 OK</code> - Array of WorkflowRun objects</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/by-status?status=FAILED\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowdefinitions","title":"GET /api/v1/workflow/definitions","text":"<p>List all available workflow definitions.</p> <p>Response: - <code>200 OK</code> - Array of workflow definition summaries</p> <p>Response Body: <pre><code>[\n  {\n    \"id\": \"batch\",\n    \"name\": \"Batch Workflow\"\n  },\n  {\n    \"id\": \"interactive\",\n    \"name\": \"Interactive Workflow\"\n  }\n]\n</code></pre></p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/definitions\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowdefinitionsworkflow_id","title":"GET /api/v1/workflow/definitions/{workflow_id}","text":"<p>Get detailed workflow definition by ID.</p> <p>Path Parameters: - <code>workflow_id</code> (string, required) - Workflow definition ID</p> <p>Response: - <code>200 OK</code> - Complete WorkflowDefinition object - <code>404 Not Found</code> - Workflow definition not found</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/definitions/batch\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowparam-sets","title":"GET /api/v1/workflow/param-sets","text":"<p>List all available parameter sets.</p> <p>Response: - <code>200 OK</code> - Array of parameter set summaries</p> <p>Response Body: <pre><code>[\n  {\n    \"id\": \"default\",\n    \"name\": \"Default Parameters\"\n  },\n  {\n    \"id\": \"high_quality\",\n    \"name\": \"High Quality Processing\"\n  }\n]\n</code></pre></p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/param-sets\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowparam-setsset_id","title":"GET /api/v1/workflow/param-sets/{set_id}","text":"<p>Get parameter set by ID.</p> <p>Path Parameters: - <code>set_id</code> (string, required) - Parameter set ID</p> <p>Response: - <code>200 OK</code> - Complete WorkflowParams object - <code>404 Not Found</code> - Parameter set not found</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/param-sets/default\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowparam-setstargettarget","title":"GET /api/v1/workflow/param-sets/target/{target}","text":"<p>Get parameter sets that target a specific LanceDB directory.</p> <p>Path Parameters: - <code>target</code> (string, required) - LanceDB data directory path</p> <p>Response: - <code>200 OK</code> - Array of matching WorkflowParams objects</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/param-sets/target/lancedb\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowsteps","title":"GET /api/v1/workflow/steps","text":"<p>Get workflow steps filtered by status.</p> <p>Query Parameters: - <code>status</code> (enum, required) - One of: PENDING, RUNNING, COMPLETED, ERROR, FAILED</p> <p>Response: - <code>200 OK</code> - Array of RunStep objects</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/steps?status=RUNNING\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowrun-groups","title":"GET /api/v1/workflow/run-groups","text":"<p>Get workflow run groups, optionally filtered by batch ID.</p> <p>Query Parameters: - <code>batch_id</code> (integer, optional) - Filter by batch ID</p> <p>Response: - <code>200 OK</code> - Array of RunGroup objects - <code>500 Internal Server Error</code> - Processing error</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/run-groups?batch_id=1\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowrun-groupsrun_group_id","title":"GET /api/v1/workflow/run-groups/{run_group_id}","text":"<p>Get specific run group by ID.</p> <p>Path Parameters: - <code>run_group_id</code> (integer, required) - Run group ID</p> <p>Response: - <code>200 OK</code> - RunGroup object - <code>500 Internal Server Error</code> - Processing error</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/run-groups/5\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowrun-groupsrun_group_idstats","title":"GET /api/v1/workflow/run-groups/{run_group_id}/stats","text":"<p>Get statistics for a run group.</p> <p>Path Parameters: - <code>run_group_id</code> (integer, required) - Run group ID</p> <p>Response: - <code>200 OK</code> - Statistics object with status counts and durations - <code>500 Internal Server Error</code> - Processing error</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/run-groups/5/stats\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowruns","title":"GET /api/v1/workflow/runs","text":"<p>Get workflow runs for a batch.</p> <p>Query Parameters: - <code>batch_id</code> (integer, required) - Batch ID</p> <p>Response: - <code>200 OK</code> - Array of WorkflowRun objects</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/runs?batch_id=1\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowrunsworkflow_id","title":"GET /api/v1/workflow/runs/{workflow_id}","text":"<p>Get specific workflow run by ID, including steps.</p> <p>Path Parameters: - <code>workflow_id</code> (integer, required) - Workflow run ID</p> <p>Response: - <code>200 OK</code> - WorkflowRun object with steps array</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/runs/42\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1workflowrunsworkflow_idlifecycle","title":"GET /api/v1/workflow/runs/{workflow_id}/lifecycle","text":"<p>Get lifecycle history events for a specific workflow run.</p> <p>Path Parameters: - <code>workflow_id</code> (integer, required) - Workflow run ID</p> <p>Response: - <code>200 OK</code> - Array of LifecycleHistory objects ordered by start_date - <code>400 Bad Request</code> - Invalid workflow ID - <code>500 Internal Server Error</code> - Processing error</p> <p>Response Body: <pre><code>[\n  {\n    \"id\": 1,\n    \"event\": \"item_start\",\n    \"run_group_id\": 5,\n    \"workflow_run_id\": 42,\n    \"step_id\": null,\n    \"start_date\": \"2025-01-15T10:00:00\",\n    \"completed_date\": \"2025-01-15T10:01:30\",\n    \"status\": \"COMPLETED\",\n    \"status_date\": \"2025-01-15T10:01:30\",\n    \"status_message\": \"Item processing completed successfully\",\n    \"status_meta\": {}\n  }\n]\n</code></pre></p> <p>Event Types: - <code>group_start</code> / <code>group_end</code> - Run group lifecycle - <code>item_start</code> / <code>item_end</code> / <code>item_failed</code> - Item processing lifecycle - <code>step_start</code> / <code>step_end</code> / <code>step_failed</code> - Individual step lifecycle</p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/workflow/runs/42/lifecycle\"\n</code></pre></p>"},{"location":"ingester/API/#post-apiv1workflow","title":"POST /api/v1/workflow/","text":"<p>Start a new workflow run for a single document.</p> <p>Content-Type: <code>application/x-www-form-urlencoded</code></p> <p>Form Parameters: - <code>doc_id</code> (string, required) - Document hash to process - <code>workflow_definition_id</code> (string, optional) - Workflow to use - <code>param_id</code> (string, optional) - Parameter set ID - <code>priority</code> (integer, optional) - Processing priority (default: 0)</p> <p>Response: - <code>201 Created</code> - Workflow run created - <code>500 Internal Server Error</code> - Processing error</p> <p>Example: <pre><code>curl -X POST \"http://localhost:8000/api/v1/workflow/\" \\\n  -d \"doc_id=sha256-abc123...\" \\\n  -d \"workflow_definition_id=batch\" \\\n  -d \"priority=10\"\n</code></pre></p>"},{"location":"ingester/API/#post-apiv1workflowretry","title":"POST /api/v1/workflow/retry","text":"<p>Retry failed workflow steps for a run group.</p> <p>Content-Type: <code>application/x-www-form-urlencoded</code></p> <p>Form Parameters: - <code>run_group_id</code> (integer, required) - Run group ID to retry</p> <p>Response: - <code>201 Created</code> - Failed steps reset successfully - <code>500 Internal Server Error</code> - Processing error</p> <p>Example: <pre><code>curl -X POST \"http://localhost:8000/api/v1/workflow/retry\" \\\n  -d \"run_group_id=5\"\n</code></pre></p>"},{"location":"ingester/API/#source-status-endpoint","title":"Source Status Endpoint","text":""},{"location":"ingester/API/#post-apiv1source-status","title":"POST /api/v1/source-status","text":"<p>Check document status for a source system.</p> <p>Content-Type: <code>application/x-www-form-urlencoded</code></p> <p>Form Parameters: - <code>source</code> (string, required) - Source system identifier - <code>hashes</code> (string, required) - JSON object mapping URIs to hashes</p> <p>Response: - <code>200 OK</code> - Status object indicating new/changed/deleted documents</p> <p>Example: <pre><code>curl -X POST \"http://localhost:8000/api/v1/source-status\" \\\n  -d \"source=filesystem\" \\\n  -d 'hashes={\"file1.pdf\":\"sha256-abc\",\"file2.pdf\":\"sha256-def\"}'\n</code></pre></p>"},{"location":"ingester/API/#lancedb-endpoints","title":"LanceDB Endpoints","text":""},{"location":"ingester/API/#get-apiv1lancedblist","title":"GET /api/v1/lancedb/list","text":"<p>List all LanceDB vector databases in the configured directory.</p> <p>Response: - <code>200 OK</code> - List of databases with metadata</p> <p>Response Body: <pre><code>{\n  \"status\": \"ok\",\n  \"lancedb_dir\": \"/data/lancedb\",\n  \"database_count\": 2,\n  \"databases\": [\n    {\n      \"name\": \"default.lancedb\",\n      \"path\": \"default.lancedb\",\n      \"size_bytes\": 1048576,\n      \"size_human\": \"1.00 MB\"\n    }\n  ]\n}\n</code></pre></p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/lancedb/list\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1lancedbinfo","title":"GET /api/v1/lancedb/info","text":"<p>Get detailed information about a specific LanceDB database.</p> <p>Query Parameters: - <code>db</code> (string, required) - Database name relative to lancedb_dir</p> <p>Response: - <code>200 OK</code> - Database information - <code>404 Not Found</code> - Database does not exist - <code>500 Internal Server Error</code> - Failed to open database</p> <p>Response Body: <pre><code>{\n  \"status\": \"ok\",\n  \"path\": \"/data/lancedb/default.lancedb\",\n  \"versions\": {\n    \"lancedb\": \"0.25.3\",\n    \"haiku_rag\": \"0.5.0\",\n    \"stored_version\": \"0.5.0\"\n  },\n  \"embeddings\": {\n    \"provider\": \"openai\",\n    \"model\": \"text-embedding-3-small\",\n    \"vector_dim\": 1536\n  },\n  \"documents\": {\n    \"count\": 100,\n    \"size_bytes\": 512000,\n    \"size_human\": \"500.00 KB\",\n    \"versions\": 5\n  },\n  \"chunks\": {\n    \"count\": 1500,\n    \"size_bytes\": 2048000,\n    \"size_human\": \"2.00 MB\",\n    \"versions\": 5\n  },\n  \"vector_index\": {\n    \"exists\": true,\n    \"indexed_rows\": 1450,\n    \"unindexed_rows\": 50\n  },\n  \"tables\": [\"documents\", \"chunks\", \"settings\"]\n}\n</code></pre></p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/lancedb/info?db=default.lancedb\"\n</code></pre></p> <p>Note: The <code>db</code> parameter supports nested paths (e.g., <code>project/data.lancedb</code>).</p>"},{"location":"ingester/API/#get-apiv1lancedbdocuments","title":"GET /api/v1/lancedb/documents","text":"<p>List documents stored in a LanceDB database.</p> <p>Query Parameters: - <code>db</code> (string, required) - Database name relative to lancedb_dir - <code>limit</code> (integer, optional) - Maximum number of documents to return - <code>offset</code> (integer, optional) - Number of documents to skip - <code>filter</code> (string, optional) - SQL WHERE clause to filter documents</p> <p>Response: - <code>200 OK</code> - List of documents - <code>404 Not Found</code> - Database does not exist - <code>500 Internal Server Error</code> - Query error</p> <p>Response Body: <pre><code>{\n  \"status\": \"ok\",\n  \"path\": \"/data/lancedb/default.lancedb\",\n  \"document_count\": 10,\n  \"documents\": [\n    {\n      \"id\": \"doc-abc123\",\n      \"uri\": \"/documents/report.pdf\",\n      \"title\": \"Q4 Financial Report\",\n      \"created_at\": \"2025-01-15T10:00:00\",\n      \"updated_at\": \"2025-01-15T12:00:00\",\n      \"chunk_count\": 25,\n      \"metadata\": {\"author\": \"John Doe\"}\n    }\n  ]\n}\n</code></pre></p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/lancedb/documents?db=default.lancedb&amp;limit=10\"\n</code></pre></p> <p>Example with filter: <pre><code>curl \"http://localhost:8000/api/v1/lancedb/documents?db=default.lancedb&amp;filter=uri%20LIKE%20'%25report%25'\"\n</code></pre></p>"},{"location":"ingester/API/#get-apiv1lancedbvacuum","title":"GET /api/v1/lancedb/vacuum","text":"<p>Optimize and clean up database tables to reduce disk usage.</p> <p>Query Parameters: - <code>db</code> (string, required) - Database name relative to lancedb_dir</p> <p>Response: - <code>200 OK</code> - Vacuum completed successfully - <code>500 Internal Server Error</code> - Vacuum failed</p> <p>Response Body: <pre><code>{\n  \"status\": \"ok\"\n}\n</code></pre></p> <p>Example: <pre><code>curl \"http://localhost:8000/api/v1/lancedb/vacuum?db=default.lancedb\"\n</code></pre></p> <p>Note: Vacuum removes deleted rows and compacts table files. Run periodically after bulk deletions.</p>"},{"location":"ingester/API/#data-models","title":"Data Models","text":""},{"location":"ingester/API/#documentbatch","title":"DocumentBatch","text":"<pre><code>{\n  \"id\": 1,\n  \"name\": \"Q4 Reports\",\n  \"source\": \"filesystem\",\n  \"start_date\": \"2025-01-15T10:00:00\",\n  \"completed_date\": null,\n  \"batch_params\": {},\n  \"duration\": null\n}\n</code></pre>"},{"location":"ingester/API/#document","title":"Document","text":"<pre><code>{\n  \"hash\": \"sha256-abc123...\",\n  \"mime_type\": \"application/pdf\",\n  \"file_size\": 1024000,\n  \"doc_meta\": {\"author\": \"John Doe\"},\n\n}\n</code></pre>"},{"location":"ingester/API/#documenturi","title":"DocumentURI","text":"<pre><code>{\n  \"id\": 42,\n  \"doc_hash\": \"sha256-abc123...\",\n  \"uri\": \"/documents/report.pdf\",\n  \"source\": \"filesystem\",\n  \"version\": 1,\n  \"batch_id\": 1\n}\n</code></pre>"},{"location":"ingester/API/#workflowrun","title":"WorkflowRun","text":"<pre><code>{\n  \"id\": 100,\n  \"workflow_definition_id\": \"batch\",\n  \"run_group_id\": 5,\n  \"batch_id\": 1,\n  \"doc_id\": \"sha256-abc123...\",\n  \"priority\": 0,\n  \"created_date\": \"2025-01-15T10:00:00\",\n  \"start_date\": \"2025-01-15T10:01:00\",\n  \"completed_date\": null,\n  \"status\": \"RUNNING\",\n  \"status_date\": \"2025-01-15T10:05:00\",\n  \"status_message\": null,\n  \"status_meta\": {},\n  \"run_params\": {},\n  \"duration\": null\n}\n</code></pre>"},{"location":"ingester/API/#runstep","title":"RunStep","text":"<pre><code>{\n  \"id\": 500,\n  \"workflow_run_id\": 100,\n  \"workflow_step_number\": 2,\n  \"workflow_step_name\": \"parse\",\n  \"step_config_id\": 10,\n  \"step_type\": \"parse\",\n  \"is_last_step\": false,\n  \"created_date\": \"2025-01-15T10:01:00\",\n  \"priority\": 0,\n  \"start_date\": \"2025-01-15T10:02:00\",\n  \"status_date\": \"2025-01-15T10:05:00\",\n  \"completed_date\": null,\n  \"retry\": 0,\n  \"retries\": 3,\n  \"status\": \"RUNNING\",\n  \"status_message\": null,\n  \"status_meta\": {},\n  \"worker_id\": \"worker-abc-123\",\n  \"duration\": null\n}\n</code></pre>"},{"location":"ingester/API/#runstatus-enum","title":"RunStatus Enum","text":"<ul> <li><code>PENDING</code> - Not yet started</li> <li><code>RUNNING</code> - Currently executing</li> <li><code>COMPLETED</code> - Finished successfully</li> <li><code>ERROR</code> - Failed but will retry</li> <li><code>FAILED</code> - Permanently failed after all retries</li> </ul>"},{"location":"ingester/API/#workflowsteptype-enum","title":"WorkflowStepType Enum","text":"<ul> <li><code>ingest</code> - Load document</li> <li><code>validate</code> - Validate document</li> <li><code>parse</code> - Extract text/structure</li> <li><code>chunk</code> - Split into chunks</li> <li><code>embed</code> - Generate embeddings</li> <li><code>store</code> - Save to RAG system</li> <li><code>enrich</code> - Add metadata</li> <li><code>route</code> - Conditional routing</li> </ul>"},{"location":"ingester/API/#error-responses","title":"Error Responses","text":"<p>All error responses follow this format:</p> <pre><code>{\n  \"error\": \"Error message describing what went wrong\",\n  \"status_code\": 400\n}\n</code></pre> <p>Common HTTP status codes: - <code>400 Bad Request</code> - Invalid parameters - <code>404 Not Found</code> - Resource not found - <code>500 Internal Server Error</code> - Server-side error</p>"},{"location":"ingester/API/#rate-limiting","title":"Rate Limiting","text":"<p>Currently, no rate limiting is implemented. For production deployments, consider adding rate limiting middleware.</p>"},{"location":"ingester/API/#openapiswagger-documentation","title":"OpenAPI/Swagger Documentation","text":"<p>Interactive API documentation is available at: - Swagger UI: <code>http://localhost:8000/docs</code> - ReDoc: <code>http://localhost:8000/redoc</code></p>"},{"location":"ingester/ARCHITECTURE/","title":"Soliplex Ingester Architecture","text":""},{"location":"ingester/ARCHITECTURE/#overview","title":"Overview","text":"<p>Soliplex Ingester is a document processing and RAG (Retrieval-Augmented Generation) ingestion system designed to handle large-scale document workflows. It provides a FastAPI-based REST API, workflow orchestration, and integration with document parsing and embedding services.</p>"},{"location":"ingester/ARCHITECTURE/#system-components","title":"System Components","text":""},{"location":"ingester/ARCHITECTURE/#1-fastapi-server","title":"1. FastAPI Server","text":"<p>The server provides REST API endpoints for document and workflow management:</p> <ul> <li>Document Routes (<code>/api/v1/document/*</code>) - Document upload, retrieval, and management</li> <li>Batch Routes (<code>/api/v1/batch/*</code>) - Batch processing operations</li> <li>Workflow Routes (<code>/api/v1/workflow/*</code>) - Workflow execution and monitoring</li> <li>Stats Routes (<code>/api/v1/stats/*</code>) - System statistics and metrics</li> </ul> <p>Server entry point: <code>src/soliplex_ingester/server/__init__.py:30</code></p>"},{"location":"ingester/ARCHITECTURE/#2-workflow-system","title":"2. Workflow System","text":"<p>The workflow system orchestrates multi-step document processing pipelines:</p> <pre><code>Document \u2192 Validate \u2192 Parse \u2192 Chunk \u2192 Embed \u2192 Store\n</code></pre> <p>Workflow Components:</p> <ul> <li>WorkflowDefinition - Defines the steps and lifecycle events for a workflow</li> <li>WorkflowRun - Represents a single execution instance for one document</li> <li>RunGroup - Groups multiple workflow runs together</li> <li>RunStep - Individual step execution within a workflow run</li> </ul> <p>Step Types: - <code>INGEST</code> - Load document into system - <code>VALIDATE</code> - Validate document format and content - <code>PARSE</code> - Extract text and structure from document - <code>CHUNK</code> - Split document into semantic chunks - <code>EMBED</code> - Generate vector embeddings - <code>STORE</code> - Save to RAG system (LanceDB + HaikuRAG) - <code>ENRICH</code> - Add metadata or additional processing - <code>ROUTE</code> - Conditional routing logic</p> <p>Implementation: <code>src/soliplex_ingester/lib/wf/</code></p>"},{"location":"ingester/ARCHITECTURE/#3-worker-system","title":"3. Worker System","text":"<p>Async workers process workflow steps concurrently:</p> <ul> <li>Workers poll for pending workflow steps</li> <li>Configurable concurrency levels for different operations</li> <li>Automatic retry logic with configurable retry counts</li> <li>Health check/heartbeat system via <code>WorkerCheckin</code></li> </ul> <p>Worker implementation: <code>src/soliplex_ingester/lib/wf/runner.py</code></p>"},{"location":"ingester/ARCHITECTURE/#4-storage-layer","title":"4. Storage Layer","text":"<p>Database: - SQLModel + SQLAlchemy with async support - Supports SQLite (dev) and PostgreSQL (production) - Alembic for migrations</p> <p>File Storage: - Configurable backends (filesystem, S3-compatible via OpenDAL) - Separate storage locations for different artifact types:   - Raw documents   - Parsed markdown   - Parsed JSON   - Chunks   - Embeddings</p> <p>Vector Storage: - LanceDB for vector embeddings - HaikuRAG client for retrieval operations</p>"},{"location":"ingester/ARCHITECTURE/#5-document-processing-pipeline","title":"5. Document Processing Pipeline","text":"<pre><code>graph LR\n    A[Upload Document] --&gt; B[Create DocumentURI]\n    B --&gt; C[Hash &amp; Store as Document]\n    C --&gt; D[Queue Workflow Run]\n    D --&gt; E[Validate Step]\n    E --&gt; F[Parse with Docling]\n    F --&gt; G[Chunk Text]\n    G --&gt; H[Generate Embeddings]\n    H --&gt; I[Store in LanceDB]\n    I --&gt; J[Update RAG Index]\n</code></pre>"},{"location":"ingester/ARCHITECTURE/#6-external-services","title":"6. External Services","text":"<p>Docling Server: - Document parsing service - Extracts text, structure, and metadata - Configurable via <code>DOCLING_SERVER_URL</code></p> <p>HaikuRAG: - RAG backend for document retrieval - Vector search and document management - Optional (controlled by <code>DO_RAG</code> setting)</p>"},{"location":"ingester/ARCHITECTURE/#data-flow","title":"Data Flow","text":""},{"location":"ingester/ARCHITECTURE/#document-ingestion-flow","title":"Document Ingestion Flow","text":"<ol> <li>Upload - Client uploads document via <code>/api/v1/document/upload</code></li> <li>Hash &amp; Dedupe - System computes SHA256 hash, checks for duplicates</li> <li>Create URI - Maps source URI to document hash</li> <li>Batch Assignment - Associates document with processing batch</li> <li>Workflow Creation - Creates WorkflowRun and RunSteps</li> <li>Worker Processing - Workers pick up and execute steps</li> <li>Status Updates - Database tracks step and run status</li> <li>Completion - Document marked complete when all steps succeed</li> </ol>"},{"location":"ingester/ARCHITECTURE/#workflow-execution-flow","title":"Workflow Execution Flow","text":"<ol> <li>Worker Startup - Worker registers and starts polling</li> <li>Step Selection - Worker queries for PENDING steps with <code>FOR UPDATE</code> lock</li> <li>Status Transition - PENDING \u2192 RUNNING \u2192 COMPLETED/ERROR/FAILED</li> <li>Step Execution - Calls registered handler method</li> <li>Artifact Storage - Saves intermediate results</li> <li>Retry Logic - Automatic retry on ERROR status</li> <li>Run Completion - Aggregates step status to run status</li> <li>Group Completion - Aggregates run status to group status</li> </ol>"},{"location":"ingester/ARCHITECTURE/#configuration","title":"Configuration","text":"<p>Configuration via environment variables with <code>pydantic-settings</code>:</p> <ul> <li>Database connection</li> <li>File storage paths</li> <li>Worker concurrency settings</li> <li>External service URLs</li> <li>Workflow and parameter directories</li> </ul> <p>See <code>src/soliplex_ingester/lib/config.py:15</code> for full configuration schema.</p>"},{"location":"ingester/ARCHITECTURE/#scalability","title":"Scalability","text":"<p>Horizontal Scaling: - Multiple workers can run concurrently - Database row-level locking prevents duplicate processing - Stateless API servers can be load balanced</p> <p>Vertical Scaling: - Configurable concurrency per worker - Batch size controls for embedding operations - Connection pooling for database access</p> <p>Workflow Parallelism: - Multiple workflows can process simultaneously - Steps within a workflow run sequentially - Different documents process independently</p>"},{"location":"ingester/ARCHITECTURE/#technology-stack","title":"Technology Stack","text":"<ul> <li>Web Framework: FastAPI 0.120+</li> <li>Database ORM: SQLModel 0.0.27+</li> <li>Async Runtime: asyncio</li> <li>CLI: Typer</li> <li>Document Parsing: Docling</li> <li>Vector DB: LanceDB 0.25+</li> <li>RAG: HaikuRAG</li> <li>Storage: OpenDAL (multi-backend support)</li> </ul>"},{"location":"ingester/ARCHITECTURE/#extension-points","title":"Extension Points","text":"<p>Custom Workflow Steps: Define custom step handlers by: 1. Creating a new async function matching the EventHandler signature 2. Registering in workflow YAML configuration 3. Implementing retry logic and error handling</p> <p>Custom Storage Backends: Configure via <code>FILE_STORE_TARGET</code> environment variable and OpenDAL configuration.</p> <p>Custom Lifecycle Events: Add event handlers in workflow configuration to respond to: - <code>GROUP_START</code> / <code>GROUP_END</code> - <code>ITEM_START</code> / <code>ITEM_END</code> - <code>STEP_START</code> / <code>STEP_END</code> - <code>ITEM_FAILED</code> / <code>STEP_FAILED</code></p>"},{"location":"ingester/ARCHITECTURE/#monitoring","title":"Monitoring","text":"<p>Database Tables: - <code>workflowrun</code> - Track run status and duration - <code>runstep</code> - Monitor individual step execution - <code>workcheckin</code> - Worker health and activity - <code>lifecyclehistory</code> - Audit trail of events</p> <p>Metrics Available: - Document processing throughput - Step success/failure rates - Worker utilization - Processing durations - Batch completion times</p> <p>Access via <code>/api/v1/stats/*</code> endpoints.</p>"},{"location":"ingester/AUTHENTICATION/","title":"Authentication Guide","text":"<p>This guide covers setting up authentication for Soliplex Ingester using OAuth2 Proxy.</p>"},{"location":"ingester/AUTHENTICATION/#overview","title":"Overview","text":"<p>Soliplex Ingester uses OAuth2 Proxy as a reverse proxy to handle OIDC authentication. This approach:</p> <ul> <li>Requires zero code changes to the application</li> <li>Supports any OIDC-compliant identity provider</li> <li>Handles session management, token refresh, and logout automatically</li> <li>Forwards user identity to the backend via HTTP headers</li> </ul>"},{"location":"ingester/AUTHENTICATION/#architecture","title":"Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  User    \u2502\u2500\u2500\u2500\u2500\u25b6\u2502 OAuth2 Proxy  \u2502\u2500\u2500\u2500\u2500\u25b6\u2502 Soliplex Ingester   \u2502\n\u2502 Browser  \u2502     \u2502   (OIDC)      \u2502     \u2502   (API + UI)        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u2502\n                        \u25bc\n                 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                 \u2502 OIDC Provider \u2502\n                 \u2502 (Keycloak,   \u2502\n                 \u2502  Auth0, etc) \u2502\n                 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"ingester/AUTHENTICATION/#quick-start","title":"Quick Start","text":""},{"location":"ingester/AUTHENTICATION/#1-configure-your-oidc-provider","title":"1. Configure Your OIDC Provider","text":"<p>Create a new client/application in your OIDC provider with these settings:</p> Setting Value Client Type Confidential Protocol OpenID Connect Redirect URI <code>http://localhost:4180/oauth2/callback</code> Scopes <code>openid</code>, <code>email</code>, <code>profile</code> <p>Note the Client ID and Client Secret.</p>"},{"location":"ingester/AUTHENTICATION/#2-create-environment-file","title":"2. Create Environment File","text":"<pre><code>cd docker\ncp .env.auth.example .env.auth\n</code></pre> <p>Edit <code>.env.auth</code> with your OIDC settings:</p> <pre><code>OAUTH2_PROXY_OIDC_ISSUER_URL=https://your-idp.example.com/realms/your-realm\nOAUTH2_PROXY_CLIENT_ID=soliplex-ingester\nOAUTH2_PROXY_CLIENT_SECRET=your-secret\nOAUTH2_PROXY_COOKIE_SECRET=$(openssl rand -base64 32 | tr -- '+/' '-_')\nOAUTH2_PROXY_REDIRECT_URL=http://localhost:4180/oauth2/callback\n</code></pre>"},{"location":"ingester/AUTHENTICATION/#3-start-with-authentication","title":"3. Start with Authentication","text":"<pre><code>docker compose -f docker-compose.yml -f docker-compose.auth.yml --env-file .env.auth up\n</code></pre>"},{"location":"ingester/AUTHENTICATION/#4-access-the-application","title":"4. Access the Application","text":"<ul> <li>With auth: http://localhost:4180 (redirects to OIDC login)</li> <li>Direct API (no auth): http://localhost:8002 (if port still exposed)</li> </ul>"},{"location":"ingester/AUTHENTICATION/#provider-specific-configuration","title":"Provider-Specific Configuration","text":""},{"location":"ingester/AUTHENTICATION/#keycloak","title":"Keycloak","text":"<ol> <li>Create a new client in your realm:</li> <li>Client ID: <code>soliplex-ingester</code></li> <li>Client Protocol: <code>openid-connect</code></li> <li>Access Type: <code>confidential</code></li> <li> <p>Valid Redirect URIs: <code>http://localhost:4180/oauth2/callback</code></p> </li> <li> <p>Create an Audience mapper (required):</p> </li> <li>Go to Client \u2192 Mappers \u2192 Add Mapper</li> <li>Mapper Type: <code>Audience</code></li> <li> <p>Included Client Audience: <code>soliplex-ingester</code></p> </li> <li> <p>(Optional) Add Groups mapper for group-based access:</p> </li> <li>Go to Client Scopes \u2192 groups \u2192 Mappers</li> <li>Mapper Type: <code>Group Membership</code></li> <li> <p>Token Claim Name: <code>groups</code></p> </li> <li> <p>Environment settings:    <pre><code>OAUTH2_PROXY_OIDC_ISSUER_URL=https://keycloak.example.com/realms/your-realm\n# Or use keycloak-oidc provider for role support:\n# Add to oauth2-proxy.cfg: provider = \"keycloak-oidc\"\n</code></pre></p> </li> </ol>"},{"location":"ingester/AUTHENTICATION/#auth0","title":"Auth0","text":"<ol> <li>Create a new Regular Web Application</li> <li>Configure Allowed Callback URLs: <code>http://localhost:4180/oauth2/callback</code></li> <li> <p>Enable the following connections as needed</p> </li> <li> <p>Environment settings:    <pre><code>OAUTH2_PROXY_OIDC_ISSUER_URL=https://your-tenant.auth0.com/\n</code></pre></p> </li> </ol>"},{"location":"ingester/AUTHENTICATION/#azure-ad","title":"Azure AD","text":"<ol> <li>Register a new application in Azure Portal</li> <li>Add redirect URI: <code>http://localhost:4180/oauth2/callback</code></li> <li> <p>Create a client secret</p> </li> <li> <p>Environment settings:    <pre><code>OAUTH2_PROXY_OIDC_ISSUER_URL=https://login.microsoftonline.com/{tenant-id}/v2.0\n# Or use azure provider:\n# Add to oauth2-proxy.cfg: provider = \"azure\"\n</code></pre></p> </li> </ol>"},{"location":"ingester/AUTHENTICATION/#okta","title":"Okta","text":"<ol> <li>Create a new Web Application</li> <li> <p>Set Sign-in redirect URI: <code>http://localhost:4180/oauth2/callback</code></p> </li> <li> <p>Environment settings:    <pre><code>OAUTH2_PROXY_OIDC_ISSUER_URL=https://your-org.okta.com\n</code></pre></p> </li> </ol>"},{"location":"ingester/AUTHENTICATION/#access-control","title":"Access Control","text":""},{"location":"ingester/AUTHENTICATION/#email-domain-restriction","title":"Email Domain Restriction","text":"<p>Restrict access to specific email domains:</p> <pre><code># .env.auth\nOAUTH2_PROXY_EMAIL_DOMAINS=yourcompany.com,partner.com\n</code></pre>"},{"location":"ingester/AUTHENTICATION/#group-based-access","title":"Group-Based Access","text":"<p>Restrict access to users in specific groups:</p> <pre><code># oauth2-proxy.cfg\nallowed_groups = [\"soliplex-users\", \"soliplex-admins\"]\n</code></pre> <p>Requires your OIDC provider to include a <code>groups</code> claim in the token.</p>"},{"location":"ingester/AUTHENTICATION/#role-based-access-keycloak","title":"Role-Based Access (Keycloak)","text":"<pre><code># oauth2-proxy.cfg (with provider = \"keycloak-oidc\")\nallowed_roles = [\"soliplex-user\"]\n# Or client roles:\nallowed_roles = [\"soliplex-ingester:admin\"]\n</code></pre>"},{"location":"ingester/AUTHENTICATION/#backend-integration","title":"Backend Integration","text":"<p>OAuth2 Proxy forwards user identity via HTTP headers. The backend receives:</p> Header Description <code>X-Auth-Request-User</code> Username/subject <code>X-Auth-Request-Email</code> User's email <code>X-Auth-Request-Groups</code> User's groups (if available) <code>X-Auth-Request-Access-Token</code> OAuth access token <code>X-Forwarded-User</code> Alias for user <code>X-Forwarded-Email</code> Alias for email"},{"location":"ingester/AUTHENTICATION/#reading-headers-in-fastapi","title":"Reading Headers in FastAPI","text":"<pre><code>from fastapi import Request, HTTPException, Depends\n\ndef get_current_user(request: Request) -&gt; dict:\n    \"\"\"Extract user from OAuth2 Proxy headers.\"\"\"\n    user = request.headers.get(\"X-Auth-Request-User\")\n    email = request.headers.get(\"X-Auth-Request-Email\")\n\n    if not user:\n        raise HTTPException(status_code=401, detail=\"Not authenticated\")\n\n    return {\"user\": user, \"email\": email}\n\n@router.get(\"/protected\")\nasync def protected_endpoint(user: dict = Depends(get_current_user)):\n    return {\"message\": f\"Hello {user['email']}\"}\n</code></pre>"},{"location":"ingester/AUTHENTICATION/#api-key-fallback","title":"API Key Fallback","text":"<p>For programmatic access (scripts, CI/CD), you can enable API key authentication alongside OIDC:</p>"},{"location":"ingester/AUTHENTICATION/#enable-api-key-support","title":"Enable API Key Support","text":"<pre><code># .env.auth\nAPI_KEY_ENABLED=true\nAPI_KEY=$(openssl rand -hex 32)\n</code></pre>"},{"location":"ingester/AUTHENTICATION/#using-api-keys","title":"Using API Keys","text":"<p>Both methods work through the OAuth2 Proxy port (4180):</p> <pre><code># Through OAuth2 Proxy (recommended - single port for all clients)\ncurl -H \"Authorization: Bearer your-api-key\" http://localhost:4180/api/v1/batch/\n\n# Direct to API (if port 8002 is exposed)\ncurl -H \"Authorization: Bearer your-api-key\" http://localhost:8002/api/v1/batch/\n</code></pre> <p>How it works: OAuth2 Proxy is configured with <code>skip_jwt_bearer_tokens = true</code>, which allows requests with an <code>Authorization: Bearer</code> header to pass through without OIDC authentication. The backend then validates the token.</p>"},{"location":"ingester/AUTHENTICATION/#production-deployment","title":"Production Deployment","text":""},{"location":"ingester/AUTHENTICATION/#enable-https","title":"Enable HTTPS","text":"<ol> <li>Update redirect URL in OIDC provider</li> <li>Configure SSL certificates</li> <li>Update environment:    <pre><code>OAUTH2_PROXY_COOKIE_SECURE=true\nOAUTH2_PROXY_REDIRECT_URL=https://your-domain.com/oauth2/callback\n</code></pre></li> </ol>"},{"location":"ingester/AUTHENTICATION/#enable-redis-session-storage","title":"Enable Redis Session Storage","text":"<p>For high availability and session sharing:</p> <pre><code># .env.auth\nOAUTH2_PROXY_SESSION_STORE_TYPE=redis\nOAUTH2_PROXY_REDIS_CONNECTION_URL=redis://redis:6379\n</code></pre>"},{"location":"ingester/AUTHENTICATION/#restrict-cors-origins","title":"Restrict CORS Origins","text":"<p>Update the application's CORS settings to only allow your domain.</p>"},{"location":"ingester/AUTHENTICATION/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ingester/AUTHENTICATION/#invalid-redirect-error","title":"\"Invalid redirect\" Error","text":"<p>Ensure the redirect URL in <code>.env.auth</code> exactly matches what's configured in your OIDC provider.</p>"},{"location":"ingester/AUTHENTICATION/#token-audience-doesnt-match","title":"\"Token audience doesn't match\"","text":"<p>For Keycloak, add an Audience mapper to your client (see Keycloak section above).</p>"},{"location":"ingester/AUTHENTICATION/#headers-not-reaching-backend","title":"Headers Not Reaching Backend","text":"<p>Ensure <code>set_xauthrequest = true</code> is in <code>oauth2-proxy.cfg</code> and the backend trusts proxy headers.</p>"},{"location":"ingester/AUTHENTICATION/#session-expires-frequently","title":"Session Expires Frequently","text":"<p>Increase cookie lifetime: <pre><code># oauth2-proxy.cfg\ncookie_expire = \"168h\"\ncookie_refresh = \"1h\"\n</code></pre></p>"},{"location":"ingester/AUTHENTICATION/#debug-logging","title":"Debug Logging","text":"<p>Enable verbose logging: <pre><code># oauth2-proxy.cfg\nstandard_logging = true\nauth_logging = true\nrequest_logging = true\n</code></pre></p>"},{"location":"ingester/AUTHENTICATION/#files-reference","title":"Files Reference","text":"File Purpose <code>docker/docker-compose.auth.yml</code> Docker Compose overlay for auth <code>docker/oauth2-proxy/oauth2-proxy.cfg</code> OAuth2 Proxy configuration <code>docker/.env.auth.example</code> Environment variable template <code>docker/nginx/nginx-auth.conf</code> Nginx config (optional) <code>docker/nginx/locations.conf</code> Nginx location blocks"},{"location":"ingester/AUTHENTICATION/#see-also","title":"See Also","text":"<ul> <li>OAuth2 Proxy Documentation</li> <li>CONFIGURATION.md - Environment variables</li> <li>API.md - API reference</li> </ul>"},{"location":"ingester/CLI/","title":"CLI Reference","text":""},{"location":"ingester/CLI/#overview","title":"Overview","text":"<p>Soliplex Ingester provides a command-line interface (CLI) built with Typer. The CLI binary is named <code>si-cli</code>.</p> <p>Installation: After installing the package, the <code>si-cli</code> command is available: <pre><code>pip install -e .\nsi-cli --help\n</code></pre></p> <p>Entry Point: <code>src/soliplex_ingester/cli.py:35</code></p>"},{"location":"ingester/CLI/#global-options","title":"Global Options","text":"<p>All commands support these options:</p> <pre><code>si-cli --help           # Show help for all commands\nsi-cli COMMAND --help   # Show help for specific command\n</code></pre> <p>Initialization: Before running any command, the CLI automatically: 1. Validates settings 2. Sets up logging based on <code>LOG_LEVEL</code></p>"},{"location":"ingester/CLI/#commands","title":"Commands","text":""},{"location":"ingester/CLI/#validate-settings","title":"validate-settings","text":"<p>Validate and display application settings.</p> <p>Usage: <pre><code>si-cli validate-settings\n</code></pre></p> <p>Description: - Validates all environment variables - Displays current configuration - Exits with error code if validation fails</p> <p>Example Output: <pre><code>doc_db_url='sqlite+aiosqlite:///./db/documents.db'\ndocling_server_url='http://localhost:5001/v1'\ndocling_http_timeout=600\nlog_level='INFO'\nfile_store_target='fs'\nfile_store_dir='file_store'\n...\n</code></pre></p> <p>Error Output: <pre><code>invalid settings\n{'type': 'missing', 'loc': ('doc_db_url',), 'msg': 'Field required'}\n</code></pre></p> <p>Exit Codes: - <code>0</code> - Settings valid - <code>1</code> - Validation failed</p> <p>Implementation: <code>src/soliplex_ingester/cli.py:38</code></p>"},{"location":"ingester/CLI/#db-init","title":"db-init","text":"<p>Initialize database tables and run migrations.</p> <p>Usage: <pre><code>si-cli db-init\n</code></pre></p> <p>Description: - Creates all database tables using SQLModel metadata - Runs Alembic migrations to latest version - Idempotent (safe to run multiple times)</p> <p>Prerequisites: - <code>DOC_DB_URL</code> environment variable must be set - Database server must be accessible - User must have CREATE TABLE permissions</p> <p>Example: <pre><code>export DOC_DB_URL=\"sqlite+aiosqlite:///./db/documents.db\"\nsi-cli db-init\n</code></pre></p> <p>Notes: - For SQLite, creates database file if it doesn't exist - For PostgreSQL, database must already exist - Uses synchronous SQLAlchemy engine (not async)</p> <p>Implementation: <code>src/soliplex_ingester/cli.py:68</code></p>"},{"location":"ingester/CLI/#serve","title":"serve","text":"<p>Start the FastAPI web server.</p> <p>Usage: <pre><code>si-cli serve [OPTIONS]\n</code></pre></p> <p>Options:</p> Option Short Type Default Description <code>--host</code> <code>-h</code> str <code>127.0.0.1</code> Bind address <code>--port</code> <code>-p</code> int <code>8000</code> Port number <code>--uds</code> - str None Unix domain socket path <code>--fd</code> - int None File descriptor to bind <code>--reload</code> <code>-r</code> bool False Auto-reload on file changes <code>--workers</code> - int None Number of worker processes <code>--access-log</code> - bool None Enable/disable access log <code>--proxy-headers</code> - bool None Trust proxy headers <code>--forwarded-allow-ips</code> - str None IPs to trust for proxy headers <p>Examples:</p> <p>Basic server: <pre><code>si-cli serve\n</code></pre></p> <p>Custom host and port: <pre><code>si-cli serve --host 0.0.0.0 --port 9000\n</code></pre></p> <p>Development mode with auto-reload: <pre><code>si-cli serve --reload\n</code></pre></p> <p>Production with multiple workers: <pre><code>si-cli serve --workers 4 --host 0.0.0.0\n</code></pre></p> <p>Unix socket: <pre><code>si-cli serve --uds /tmp/soliplex.sock\n</code></pre></p> <p>Behind proxy: <pre><code>si-cli serve --proxy-headers --forwarded-allow-ips \"10.0.0.0/8\"\n</code></pre></p> <p>Reload Configuration: When <code>--reload</code> is enabled: - Watches Python files in <code>soliplex_ingester</code> package - Watches <code>*.yaml</code>, <code>*.yml</code>, <code>*.txt</code> files - Automatically restarts on changes</p> <p>Worker Note: The server automatically starts a background worker on startup. The worker processes workflow steps concurrently with serving API requests.</p> <p>Environment Variables: - <code>WEB_CONCURRENCY</code> - Default number of workers if not specified</p> <p>Implementation: <code>src/soliplex_ingester/cli.py:207</code></p>"},{"location":"ingester/CLI/#worker","title":"worker","text":"<p>Run a standalone workflow processing worker.</p> <p>Usage: <pre><code>si-cli worker\n</code></pre></p> <p>Description: - Starts a worker that polls for pending workflow steps - Executes steps according to workflow definitions - Runs indefinitely until interrupted (Ctrl+C)</p> <p>Behavior: - Registers worker with unique ID in database - Sends heartbeat every <code>WORKER_CHECKIN_INTERVAL</code> seconds - Processes steps based on priority and availability - Handles retries according to step configuration</p> <p>Example: <pre><code>si-cli worker\n</code></pre></p> <p>Multiple Workers: Run multiple instances for increased throughput: <pre><code># Terminal 1\nsi-cli worker\n\n# Terminal 2\nsi-cli worker\n\n# Terminal 3\nsi-cli worker\n</code></pre></p> <p>Graceful Shutdown: - Press <code>Ctrl+C</code> to stop worker - Worker will finish current step before exiting - Pending steps remain in database for other workers</p> <p>Monitoring: Check worker status via API: <pre><code>curl http://localhost:8000/api/v1/workflow/steps?status=RUNNING\n</code></pre></p> <p>Implementation: <code>src/soliplex_ingester/cli.py:148</code></p>"},{"location":"ingester/CLI/#validate-haiku","title":"validate-haiku","text":"<p>Validate HaikuRAG integration for a batch.</p> <p>Usage: <pre><code>si-cli validate-haiku BATCH_ID [OPTIONS]\n</code></pre></p> <p>Arguments: - <code>BATCH_ID</code> (int, required) - Batch ID to validate</p> <p>Options: - <code>--detail</code> (bool) - Show detailed output (not yet implemented)</p> <p>Description: - Checks all documents in batch - Verifies parsed markdown exists - Confirms documents are indexed in HaikuRAG - Reports any errors or missing documents</p> <p>Example: <pre><code>si-cli validate-haiku 1\n</code></pre></p> <p>Output: <pre><code>-----------results--------------\n found 10 results\n-----------fails--------------\n[\n  {\n    \"doc\": \"sha256-abc123...\",\n    \"haiku\": null,\n    \"message\": \"Document not found in HaikuRAG\",\n    \"status\": \"haiku error\"\n  }\n]\n</code></pre></p> <p>Status Values: - <code>success</code> - Document indexed correctly - <code>no_id</code> - Document has no <code>rag_id</code> (not yet stored) - <code>md error</code> - Parsed markdown not found - <code>haiku error</code> - Error fetching from HaikuRAG</p> <p>Implementation: <code>src/soliplex_ingester/cli.py:133</code></p>"},{"location":"ingester/CLI/#list-workflows","title":"list-workflows","text":"<p>List all available workflow definitions.</p> <p>Usage: <pre><code>si-cli list-workflows\n</code></pre></p> <p>Description: - Scans <code>WORKFLOW_DIR</code> for YAML files - Displays workflow IDs</p> <p>Example: <pre><code>si-cli list-workflows\n</code></pre></p> <p>Output: <pre><code>batch\nbatch_split\ninteractive\n</code></pre></p> <p>Implementation: <code>src/soliplex_ingester/cli.py:189</code></p>"},{"location":"ingester/CLI/#dump-workflow","title":"dump-workflow","text":"<p>Display complete workflow definition.</p> <p>Usage: <pre><code>si-cli dump-workflow WORKFLOW_ID\n</code></pre></p> <p>Arguments: - <code>WORKFLOW_ID</code> (str, required) - Workflow definition ID</p> <p>Description: - Loads workflow from YAML - Displays as formatted JSON</p> <p>Example: <pre><code>si-cli dump-workflow batch\n</code></pre></p> <p>Output: <pre><code>{\n  \"id\": \"batch\",\n  \"name\": \"Batch Workflow\",\n  \"meta\": {},\n  \"item_steps\": {\n    \"validate\": {\n      \"name\": \"docling validate\",\n      \"retries\": 3,\n      \"method\": \"soliplex_ingester.lib.workflow.validate_document\",\n      \"parameters\": {}\n    },\n    ...\n  },\n  \"lifecycle_events\": null\n}\n</code></pre></p> <p>Implementation: <code>src/soliplex_ingester/cli.py:162</code></p>"},{"location":"ingester/CLI/#list-param-sets","title":"list-param-sets","text":"<p>List all available parameter sets.</p> <p>Usage: <pre><code>si-cli list-param-sets\n</code></pre></p> <p>Description: - Scans <code>PARAM_DIR</code> for YAML files - Displays parameter set IDs</p> <p>Example: <pre><code>si-cli list-param-sets\n</code></pre></p> <p>Output: <pre><code>default\nhigh_quality\nfast_processing\n</code></pre></p> <p>Implementation: <code>src/soliplex_ingester/cli.py:201</code></p>"},{"location":"ingester/CLI/#dump-param-set","title":"dump-param-set","text":"<p>Display complete parameter set configuration.</p> <p>Usage: <pre><code>si-cli dump-param-set [PARAM_ID]\n</code></pre></p> <p>Arguments: - <code>PARAM_ID</code> (str, optional) - Parameter set ID (default: \"default\")</p> <p>Description: - Loads parameter set from YAML - Displays as formatted JSON</p> <p>Example: <pre><code>si-cli dump-param-set default\n</code></pre></p> <p>Output: <pre><code>{\n  \"id\": \"default\",\n  \"name\": \"Default Parameters\",\n  \"meta\": {},\n  \"config\": {\n    \"parse\": {\n      \"format\": \"markdown\",\n      \"ocr_enabled\": true\n    },\n    \"chunk\": {\n      \"chunk_size\": 512,\n      \"chunk_overlap\": 50\n    },\n    ...\n  }\n}\n</code></pre></p> <p>Implementation: <code>src/soliplex_ingester/cli.py:175</code></p>"},{"location":"ingester/CLI/#usage-patterns","title":"Usage Patterns","text":""},{"location":"ingester/CLI/#development-workflow","title":"Development Workflow","text":"<p>1. Validate configuration: <pre><code>si-cli validate-settings\n</code></pre></p> <p>2. Initialize database: <pre><code>si-cli db-init\n</code></pre></p> <p>3. Start server with reload: <pre><code>si-cli serve --reload\n</code></pre></p> <p>4. (Optional) Start additional workers: <pre><code>si-cli worker\n</code></pre></p>"},{"location":"ingester/CLI/#production-deployment","title":"Production Deployment","text":"<p>1. Validate configuration: <pre><code>si-cli validate-settings\n</code></pre></p> <p>2. Run migrations: <pre><code>si-cli db-init\n</code></pre></p> <p>3. Start server with multiple workers: <pre><code>si-cli serve --host 0.0.0.0 --port 8000 --workers 4\n</code></pre></p> <p>4. Start dedicated worker processes: <pre><code># In separate terminals/services\nsi-cli worker  # Process 1\nsi-cli worker  # Process 2\nsi-cli worker  # Process 3\n</code></pre></p>"},{"location":"ingester/CLI/#batch-processing","title":"Batch Processing","text":"<p>1. Create batch and ingest documents: <pre><code># Use API or client library\ncurl -X POST http://localhost:8000/api/v1/batch/ \\\n  -d \"source=filesystem\" \\\n  -d \"name=Test Batch\"\n</code></pre></p> <p>2. Start workflows: <pre><code>curl -X POST http://localhost:8000/api/v1/batch/start-workflows \\\n  -d \"batch_id=1\" \\\n  -d \"workflow_definition_id=batch\"\n</code></pre></p> <p>3. Start workers to process: <pre><code>si-cli worker\n</code></pre></p> <p>4. Monitor progress: <pre><code>curl http://localhost:8000/api/v1/batch/status?batch_id=1\n</code></pre></p> <p>5. Validate results: <pre><code>si-cli validate-haiku 1\n</code></pre></p>"},{"location":"ingester/CLI/#configuration-management","title":"Configuration Management","text":"<p>List available workflows: <pre><code>si-cli list-workflows\n</code></pre></p> <p>Inspect workflow: <pre><code>si-cli dump-workflow batch\n</code></pre></p> <p>List parameter sets: <pre><code>si-cli list-param-sets\n</code></pre></p> <p>Inspect parameters: <pre><code>si-cli dump-param-set default\n</code></pre></p>"},{"location":"ingester/CLI/#troubleshooting","title":"Troubleshooting","text":"<p>Check configuration: <pre><code>si-cli validate-settings\n</code></pre></p> <p>Verify database connection: <pre><code>si-cli db-init\n</code></pre></p> <p>Test server startup: <pre><code>si-cli serve --host localhost --port 8000\n# Press Ctrl+C to stop\n</code></pre></p> <p>Check worker connectivity: <pre><code>si-cli worker\n# Should start without errors\n# Press Ctrl+C to stop\n</code></pre></p> <p>Validate batch processing: <pre><code>si-cli validate-haiku BATCH_ID\n</code></pre></p>"},{"location":"ingester/CLI/#exit-codes","title":"Exit Codes","text":"Code Meaning <code>0</code> Success <code>1</code> Configuration error / validation failed <code>130</code> Interrupted by user (Ctrl+C)"},{"location":"ingester/CLI/#environment-variables","title":"Environment Variables","text":"<p>The CLI respects all configuration environment variables. Key ones for CLI usage:</p> <ul> <li><code>DOC_DB_URL</code> - Database connection (required)</li> <li><code>LOG_LEVEL</code> - Logging verbosity (DEBUG, INFO, WARNING, ERROR)</li> <li><code>WORKFLOW_DIR</code> - Workflow definitions directory</li> <li><code>PARAM_DIR</code> - Parameter sets directory</li> <li><code>DOCLING_SERVER_URL</code> - Docling service endpoint</li> </ul> <p>See CONFIGURATION.md for complete list.</p>"},{"location":"ingester/CLI/#logging","title":"Logging","text":""},{"location":"ingester/CLI/#log-levels","title":"Log Levels","text":"<p>Set via <code>LOG_LEVEL</code> environment variable:</p> <pre><code>LOG_LEVEL=DEBUG si-cli serve\n</code></pre> <p>Levels: - <code>DEBUG</code> - Detailed diagnostic information - <code>INFO</code> - General informational messages (default) - <code>WARNING</code> - Warning messages - <code>ERROR</code> - Error messages - <code>CRITICAL</code> - Critical error messages</p>"},{"location":"ingester/CLI/#log-output","title":"Log Output","text":"<p>Logs are written to stderr. Redirect as needed:</p> <pre><code>si-cli worker 2&gt;&amp;1 | tee worker.log\n</code></pre>"},{"location":"ingester/CLI/#log-format","title":"Log Format","text":"<p>Default format includes: - Timestamp - Log level - Logger name - Message</p> <p>Example: <pre><code>2025-01-15 10:00:00,123 INFO soliplex_ingester.cli Starting server\n2025-01-15 10:00:01,456 INFO soliplex_ingester.server Starting worker\n</code></pre></p>"},{"location":"ingester/CLI/#signal-handling","title":"Signal Handling","text":""},{"location":"ingester/CLI/#graceful-shutdown","title":"Graceful Shutdown","text":"<p>The CLI handles signals for graceful shutdown:</p> <p>Signals: - <code>SIGINT</code> (Ctrl+C) - Graceful shutdown - <code>SIGTERM</code> - Graceful shutdown</p> <p>Behavior: 1. Stop accepting new work 2. Complete current operations 3. Clean up resources 4. Exit with code 0</p> <p>Example: <pre><code>si-cli worker\n# Press Ctrl+C\n# Worker completes current step and exits\n</code></pre></p>"},{"location":"ingester/CLI/#platform-notes","title":"Platform Notes","text":""},{"location":"ingester/CLI/#windows","title":"Windows","text":"<p>On Windows, the CLI automatically sets the event loop policy for compatibility:</p> <pre><code>if platform.system() == \"Windows\":\n    asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())\n</code></pre> <p>This is handled automatically; no user action required.</p>"},{"location":"ingester/CLI/#unixlinux","title":"Unix/Linux","text":"<p>No special configuration needed.</p>"},{"location":"ingester/CLI/#running-with-python","title":"Running with Python","text":"<p>If <code>si-cli</code> is not in PATH, run directly:</p> <pre><code>python -m soliplex_ingester.cli --help\n</code></pre>"},{"location":"ingester/CLI/#docker-usage","title":"Docker Usage","text":"<p>Dockerfile CMD examples:</p> <p>Server: <pre><code>CMD [\"si-cli\", \"serve\", \"--host\", \"0.0.0.0\", \"--port\", \"8000\"]\n</code></pre></p> <p>Worker: <pre><code>CMD [\"si-cli\", \"worker\"]\n</code></pre></p> <p>Init container: <pre><code>CMD [\"si-cli\", \"db-init\"]\n</code></pre></p>"},{"location":"ingester/CLI/#systemd-service","title":"Systemd Service","text":"<p>Example service file:</p> <p>/etc/systemd/system/soliplex-ingester.service: <pre><code>[Unit]\nDescription=Soliplex Ingester API Server\nAfter=network.target postgresql.service\n\n[Service]\nType=simple\nUser=soliplex\nGroup=soliplex\nWorkingDirectory=/opt/soliplex-ingester\nEnvironmentFile=/etc/soliplex/config.env\nExecStart=/opt/soliplex-ingester/.venv/bin/si-cli serve --host 0.0.0.0 --port 8000\nRestart=on-failure\nRestartSec=5s\n\n[Install]\nWantedBy=multi-user.target\n</code></pre></p> <p>/etc/systemd/system/soliplex-worker@.service: <pre><code>[Unit]\nDescription=Soliplex Ingester Worker %i\nAfter=network.target postgresql.service\n\n[Service]\nType=simple\nUser=soliplex\nGroup=soliplex\nWorkingDirectory=/opt/soliplex-ingester\nEnvironmentFile=/etc/soliplex/config.env\nEnvironment=\"WORKER_ID=worker-%i\"\nExecStart=/opt/soliplex-ingester/.venv/bin/si-cli worker\nRestart=on-failure\nRestartSec=10s\n\n[Install]\nWantedBy=multi-user.target\n</code></pre></p> <p>Start services: <pre><code>sudo systemctl daemon-reload\nsudo systemctl enable soliplex-ingester\nsudo systemctl start soliplex-ingester\nsudo systemctl enable soliplex-worker@{1..3}\nsudo systemctl start soliplex-worker@{1..3}\n</code></pre></p>"},{"location":"ingester/CLI/#future-commands","title":"Future Commands","text":"<p>Commands planned for future releases:</p> <ul> <li><code>si-cli batch create</code> - Create batch via CLI</li> <li><code>si-cli batch ingest</code> - Ingest documents from directory</li> <li><code>si-cli batch status</code> - Check batch status</li> <li><code>si-cli workflow retry</code> - Retry failed workflows</li> <li><code>si-cli stats</code> - Display system statistics</li> <li><code>si-cli clean</code> - Clean up old data</li> </ul>"},{"location":"ingester/CLI/#getting-help","title":"Getting Help","text":"<p>Command help: <pre><code>si-cli --help\nsi-cli serve --help\nsi-cli worker --help\n</code></pre></p> <p>Report issues: - GitHub: https://github.com/your-repo/soliplex-ingester/issues - Include <code>si-cli validate-settings</code> output - Include relevant logs with <code>LOG_LEVEL=DEBUG</code></p>"},{"location":"ingester/CONFIGURATION/","title":"Configuration Guide","text":""},{"location":"ingester/CONFIGURATION/#overview","title":"Overview","text":"<p>Soliplex Ingester is configured via environment variables using Pydantic Settings. All configuration is defined in <code>src/soliplex/ingester/lib/config.py:15</code>.</p>"},{"location":"ingester/CONFIGURATION/#environment-variables","title":"Environment Variables","text":""},{"location":"ingester/CONFIGURATION/#database-configuration","title":"Database Configuration","text":""},{"location":"ingester/CONFIGURATION/#doc_db_url-required","title":"DOC_DB_URL (required)","text":"<p>Database connection URL.</p> <p>SQLite Example: <pre><code>DOC_DB_URL=\"sqlite+aiosqlite:///./db/documents.db\"\n</code></pre></p> <p>PostgreSQL Example: <pre><code>DOC_DB_URL=\"postgresql+psycopg://username:password@localhost:5432/soliplex\"\n</code></pre></p> <p>Notes: - Must use async drivers (<code>aiosqlite</code> for SQLite or <code>psycopg</code> for PostgreSQL) - SQLite uses relative or absolute file paths - PostgreSQL requires credentials and network access</p>"},{"location":"ingester/CONFIGURATION/#external-services","title":"External Services","text":""},{"location":"ingester/CONFIGURATION/#docling_server_url","title":"DOCLING_SERVER_URL","text":"<p>Docling document parsing service endpoint.</p> <p>Default: <code>http://localhost:5001/v1</code></p> <p>Example: <pre><code>DOCLING_SERVER_URL=\"http://docling.internal.company.com/v1\"\n</code></pre></p> <p>Notes: - Used for document parsing (PDF, DOCX, etc.) - Must be accessible from worker nodes - Health check: <code>GET {url}/health</code></p>"},{"location":"ingester/CONFIGURATION/#docling_chunk_server_url","title":"DOCLING_CHUNK_SERVER_URL","text":"<p>Docling service endpoint for chunking operations.</p> <p>Default: <code>http://localhost:5001/v1</code></p> <p>Example: <pre><code>DOCLING_CHUNK_SERVER_URL=\"http://docling-chunker.internal.company.com/v1\"\n</code></pre></p> <p>Notes: - Used by haiku.rag for document chunking via docling-serve - Can point to a different Docling instance than <code>DOCLING_SERVER_URL</code> for load distribution - If not set, defaults to the same endpoint as parsing - Useful when running separate Docling instances for parsing vs chunking</p>"},{"location":"ingester/CONFIGURATION/#docling_http_timeout","title":"DOCLING_HTTP_TIMEOUT","text":"<p>HTTP timeout for Docling requests in seconds.</p> <p>Default: <code>600</code> (10 minutes)</p> <p>Example: <pre><code>DOCLING_HTTP_TIMEOUT=300\n</code></pre></p> <p>Notes: - Large documents may require longer timeouts - Adjust based on document size and complexity</p>"},{"location":"ingester/CONFIGURATION/#logging","title":"Logging","text":""},{"location":"ingester/CONFIGURATION/#log_level","title":"LOG_LEVEL","text":"<p>Python logging level.</p> <p>Default: <code>INFO</code></p> <p>Options: <code>DEBUG</code>, <code>INFO</code>, <code>WARNING</code>, <code>ERROR</code>, <code>CRITICAL</code></p> <p>Example: <pre><code>LOG_LEVEL=DEBUG\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#file-storage","title":"File Storage","text":""},{"location":"ingester/CONFIGURATION/#file_store_target","title":"FILE_STORE_TARGET","text":"<p>Storage backend type.</p> <p>Default: <code>fs</code> (filesystem)</p> <p>Options: - <code>fs</code> - Local filesystem - <code>s3</code> - S3-compatible storage (requires OpenDAL config)</p> <p>Example: <pre><code>FILE_STORE_TARGET=s3\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#file_store_dir","title":"FILE_STORE_DIR","text":"<p>Base directory for file storage.</p> <p>Default: <code>file_store</code></p> <p>Example: <pre><code>FILE_STORE_DIR=/var/lib/soliplex/files\n</code></pre></p> <p>Notes: - Used when <code>FILE_STORE_TARGET=fs</code> - Must be writable by the application user - Consider disk space requirements</p>"},{"location":"ingester/CONFIGURATION/#document_store_dir","title":"DOCUMENT_STORE_DIR","text":"<p>Subdirectory for raw documents.</p> <p>Default: <code>raw</code></p> <p>Full Path: <code>{FILE_STORE_DIR}/{DOCUMENT_STORE_DIR}</code></p>"},{"location":"ingester/CONFIGURATION/#parsed_markdown_store_dir","title":"PARSED_MARKDOWN_STORE_DIR","text":"<p>Subdirectory for parsed markdown.</p> <p>Default: <code>markdown</code></p>"},{"location":"ingester/CONFIGURATION/#parsed_json_store_dir","title":"PARSED_JSON_STORE_DIR","text":"<p>Subdirectory for parsed JSON.</p> <p>Default: <code>json</code></p>"},{"location":"ingester/CONFIGURATION/#chunks_store_dir","title":"CHUNKS_STORE_DIR","text":"<p>Subdirectory for text chunks.</p> <p>Default: <code>chunks</code></p>"},{"location":"ingester/CONFIGURATION/#embeddings_store_dir","title":"EMBEDDINGS_STORE_DIR","text":"<p>Subdirectory for embedding vectors.</p> <p>Default: <code>embeddings</code></p>"},{"location":"ingester/CONFIGURATION/#vector-database","title":"Vector Database","text":""},{"location":"ingester/CONFIGURATION/#lancedb_dir","title":"LANCEDB_DIR","text":"<p>Directory for LanceDB vector storage.</p> <p>Default: <code>lancedb</code></p> <p>Filesystem Example: <pre><code>LANCEDB_DIR=/var/lib/soliplex/lancedb\n</code></pre></p> <p>S3 Example: <pre><code>LANCEDB_DIR=s3://my-bucket/lancedb\n</code></pre></p> <p>Notes: - Local filesystem paths or S3 URIs are supported - When using S3, LanceDB requires standard AWS environment variables (see below) - Stores vector embeddings for RAG retrieval - Requires sufficient disk space (filesystem) or S3 bucket access - Periodically compact for performance</p> <p>Required AWS Environment Variables for S3: <pre><code>AWS_ACCESS_KEY_ID=your_access_key_id\nAWS_SECRET_ACCESS_KEY=your_secret_key\nAWS_REGION=us-east-1\n</code></pre></p> <p>Optional AWS Environment Variables: <pre><code># For S3-compatible providers (MinIO, SeaweedFS, etc.)\nAWS_ENDPOINT=http://127.0.0.1:8333\n\n# Required when using HTTP to connect to endpoint\nAWS_ALLOW_HTTP=1\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#worker-configuration","title":"Worker Configuration","text":""},{"location":"ingester/CONFIGURATION/#ingest_queue_concurrency","title":"INGEST_QUEUE_CONCURRENCY","text":"<p>Maximum concurrent queue operations.</p> <p>Default: <code>20</code></p> <p>Example: <pre><code>INGEST_QUEUE_CONCURRENCY=50\n</code></pre></p> <p>Notes: - Controls internal queue processing - Higher values increase throughput but use more memory</p>"},{"location":"ingester/CONFIGURATION/#ingest_worker_concurrency","title":"INGEST_WORKER_CONCURRENCY","text":"<p>Maximum concurrent workflow steps per worker.</p> <p>Default: <code>10</code></p> <p>Example: <pre><code>INGEST_WORKER_CONCURRENCY=20\n</code></pre></p> <p>Notes: - Primary throughput control - Balance against CPU and external service limits - Monitor resource usage when tuning</p>"},{"location":"ingester/CONFIGURATION/#docling_concurrency","title":"DOCLING_CONCURRENCY","text":"<p>Maximum concurrent Docling requests.</p> <p>Default: <code>3</code></p> <p>Example: <pre><code>DOCLING_CONCURRENCY=5\n</code></pre></p> <p>Notes: - Prevents overwhelming Docling service - Coordinate with Docling server capacity - Increase if Docling can handle load</p>"},{"location":"ingester/CONFIGURATION/#worker_task_count","title":"WORKER_TASK_COUNT","text":"<p>Number of workflow steps to fetch per query.</p> <p>Default: <code>5</code></p> <p>Example: <pre><code>WORKER_TASK_COUNT=10\n</code></pre></p> <p>Notes: - Batch size for step queries - Higher values reduce database round-trips - Lower values improve fairness across workers</p>"},{"location":"ingester/CONFIGURATION/#worker_checkin_interval","title":"WORKER_CHECKIN_INTERVAL","text":"<p>Worker heartbeat interval in seconds.</p> <p>Default: <code>120</code> (2 minutes)</p> <p>Example: <pre><code>WORKER_CHECKIN_INTERVAL=60\n</code></pre></p> <p>Notes: - How often workers update health status - Lower values increase database load slightly - Used for monitoring worker liveness</p>"},{"location":"ingester/CONFIGURATION/#worker_checkin_timeout","title":"WORKER_CHECKIN_TIMEOUT","text":"<p>Worker timeout threshold in seconds.</p> <p>Default: <code>600</code> (10 minutes)</p> <p>Example: <pre><code>WORKER_CHECKIN_TIMEOUT=300\n</code></pre></p> <p>Notes: - When to consider a worker stale - Should be significantly larger than <code>WORKER_CHECKIN_INTERVAL</code> - Used for detecting crashed workers</p>"},{"location":"ingester/CONFIGURATION/#embed_batch_size","title":"EMBED_BATCH_SIZE","text":"<p>Batch size for embedding operations.</p> <p>Default: <code>1000</code></p> <p>Example: <pre><code>EMBED_BATCH_SIZE=500\n</code></pre></p> <p>Notes: - Number of chunks to embed at once - Higher values improve throughput - Limited by embedding service capacity and memory</p>"},{"location":"ingester/CONFIGURATION/#workflow-configuration","title":"Workflow Configuration","text":""},{"location":"ingester/CONFIGURATION/#workflow_dir","title":"WORKFLOW_DIR","text":"<p>Directory containing workflow YAML definitions.</p> <p>Default: <code>config/workflows</code></p> <p>Example: <pre><code>WORKFLOW_DIR=/etc/soliplex/workflows\n</code></pre></p> <p>Notes: - Scanned for <code>*.yaml</code> files at startup - Hot-reload if <code>--reload</code> flag is used</p>"},{"location":"ingester/CONFIGURATION/#default_workflow_id","title":"DEFAULT_WORKFLOW_ID","text":"<p>Default workflow to use when not specified.</p> <p>Default: <code>batch_split</code></p> <p>Example: <pre><code>DEFAULT_WORKFLOW_ID=batch\n</code></pre></p> <p>Notes: - Must match an <code>id</code> in workflow YAML files - Used when API requests omit <code>workflow_definition_id</code></p>"},{"location":"ingester/CONFIGURATION/#param_dir","title":"PARAM_DIR","text":"<p>Directory containing parameter set YAML files.</p> <p>Default: <code>config/params</code></p> <p>Example: <pre><code>PARAM_DIR=/etc/soliplex/params\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#default_param_id","title":"DEFAULT_PARAM_ID","text":"<p>Default parameter set to use when not specified.</p> <p>Default: <code>default</code></p> <p>Example: <pre><code>DEFAULT_PARAM_ID=high_quality\n</code></pre></p> <p>Notes: - Must match an <code>id</code> in parameter YAML files</p>"},{"location":"ingester/CONFIGURATION/#feature-flags","title":"Feature Flags","text":""},{"location":"ingester/CONFIGURATION/#do_rag","title":"DO_RAG","text":"<p>Enable/disable HaikuRAG integration.</p> <p>Default: <code>True</code></p> <p>Example: <pre><code>DO_RAG=false\n</code></pre></p> <p>Notes: - Set to <code>false</code> for testing without RAG backend - When disabled, <code>store</code> step becomes a no-op - Useful for CI/CD testing</p>"},{"location":"ingester/CONFIGURATION/#authentication","title":"Authentication","text":""},{"location":"ingester/CONFIGURATION/#api_key","title":"API_KEY","text":"<p>Static API key for programmatic access.</p> <p>Default: None (disabled)</p> <p>Example: <pre><code>API_KEY=your-secret-api-key-here\n</code></pre></p> <p>Notes: - Generate with: <code>openssl rand -hex 32</code> - Must also set <code>API_KEY_ENABLED=true</code> to enforce - Clients pass via <code>Authorization: Bearer &lt;token&gt;</code> header - Keep this value secure - do not commit to version control</p>"},{"location":"ingester/CONFIGURATION/#api_key_enabled","title":"API_KEY_ENABLED","text":"<p>Enable API key authentication.</p> <p>Default: <code>False</code></p> <p>Example: <pre><code>API_KEY_ENABLED=true\n</code></pre></p> <p>Notes: - When <code>true</code>, all API requests require valid <code>Authorization: Bearer</code> header - When <code>false</code>, API is open (or protected by OAuth2 Proxy) - Can be combined with <code>AUTH_TRUST_PROXY_HEADERS</code> for hybrid auth</p>"},{"location":"ingester/CONFIGURATION/#auth_trust_proxy_headers","title":"AUTH_TRUST_PROXY_HEADERS","text":"<p>Trust user identity headers from OAuth2 Proxy.</p> <p>Default: <code>False</code></p> <p>Example: <pre><code>AUTH_TRUST_PROXY_HEADERS=true\n</code></pre></p> <p>Notes: - Enable when running behind OAuth2 Proxy - Reads user identity from <code>X-Auth-Request-User</code>, <code>X-Auth-Request-Email</code> headers - Security: Only enable when behind a trusted reverse proxy - See AUTHENTICATION.md for OAuth2 Proxy setup</p>"},{"location":"ingester/CONFIGURATION/#configuration-file","title":"Configuration File","text":"<p>While the system uses environment variables, you can organize them in a <code>.env</code> file:</p> <p>.env Example: <pre><code># Database\nDOC_DB_URL=sqlite+aiosqlite:///./db/documents.db\n\n# External Services\nDOCLING_SERVER_URL=http://localhost:5001/v1\nDOCLING_HTTP_TIMEOUT=600\n\n# Logging\nLOG_LEVEL=INFO\n\n# Storage\nFILE_STORE_TARGET=fs\nFILE_STORE_DIR=file_store\nLANCEDB_DIR=lancedb\n\n# Worker Settings\nINGEST_WORKER_CONCURRENCY=10\nDOCLING_CONCURRENCY=3\nWORKER_TASK_COUNT=5\nWORKER_CHECKIN_INTERVAL=120\nWORKER_CHECKIN_TIMEOUT=600\nEMBED_BATCH_SIZE=1000\n\n# Workflow Configuration\nWORKFLOW_DIR=config/workflows\nDEFAULT_WORKFLOW_ID=batch\nPARAM_DIR=config/params\nDEFAULT_PARAM_ID=default\n\n# Features\nDO_RAG=true\n</code></pre></p> <p>Load with: <pre><code>export $(cat .env | xargs)\nsi-cli serve\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#s3-configuration-overview","title":"S3 Configuration Overview","text":"<p>This project supports S3 storage in two different contexts with different configuration methods:</p>"},{"location":"ingester/CONFIGURATION/#1-lancedb-vector-storage-lancedb_dir","title":"1. LanceDB Vector Storage (<code>LANCEDB_DIR</code>)","text":"<p>Purpose: Stores vector embeddings for RAG retrieval Configuration Method: Standard AWS environment variables Example: <pre><code>LANCEDB_DIR=s3://my-vector-bucket/lancedb\nAWS_ACCESS_KEY_ID=your_key_id\nAWS_SECRET_ACCESS_KEY=your_secret_key\nAWS_REGION=us-east-1\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#2-artifact-storage-file_store_targets3","title":"2. Artifact Storage (<code>FILE_STORE_TARGET=s3</code>)","text":"<p>Purpose: Stores intermediate processing artifacts (documents, markdown, chunks, embeddings) Configuration Method: Nested Pydantic settings with <code>__</code> delimiter Example: <pre><code>FILE_STORE_TARGET=s3\nARTIFACT_S3__BUCKET=my-artifact-bucket\nARTIFACT_S3__ACCESS_KEY_ID=your_key_id\nARTIFACT_S3__ACCESS_SECRET=your_secret_key\nARTIFACT_S3__REGION=us-east-1\nARTIFACT_S3__ENDPOINT_URL=http://127.0.0.1:8333\n</code></pre></p> <p>Important Notes: - These are independent systems and can use different S3 buckets or providers - LanceDB uses standard AWS SDK naming (<code>AWS_SECRET_ACCESS_KEY</code>) - Artifact/Input S3 uses Pydantic nested naming (<code>ARTIFACT_S3__ACCESS_SECRET</code>) - The field name difference is intentional to support Pydantic's nested configuration</p>"},{"location":"ingester/CONFIGURATION/#nested-configuration-advanced","title":"Nested Configuration (Advanced)","text":"<p>Pydantic Settings supports nested configuration using <code>__</code> delimiter for structured settings.</p> <p>Artifact S3 Configuration: <pre><code>ARTIFACT_S3__BUCKET=soliplex-artifacts\nARTIFACT_S3__ACCESS_KEY_ID=soliplex\nARTIFACT_S3__ACCESS_SECRET=soliplex\nARTIFACT_S3__REGION=xx\nARTIFACT_S3__ENDPOINT_URL=http://127.0.0.1:8333\n</code></pre></p> <p>Input S3 Configuration: <pre><code>INPUT_S3__BUCKET=soliplex-inputs\nINPUT_S3__ACCESS_KEY_ID=soliplex\nINPUT_S3__ACCESS_SECRET=soliplex\nINPUT_S3__REGION=xx\nINPUT_S3__ENDPOINT_URL=http://127.0.0.1:8333\n</code></pre></p> <p>Notes: - <code>ACCESS_SECRET</code> (not <code>SECRET_ACCESS_KEY</code>) is used for nested config fields - Nested delimiter is <code>__</code> (double underscore) - Both <code>INPUT_S3</code> and <code>ARTIFACT_S3</code> can point to different buckets/providers</p> <p>See <code>src/soliplex/ingester/lib/config.py:7-16</code> for nested model definitions.</p>"},{"location":"ingester/CONFIGURATION/#configuration-validation","title":"Configuration Validation","text":""},{"location":"ingester/CONFIGURATION/#validate-settings","title":"Validate Settings","text":"<p>Check configuration without starting services:</p> <pre><code>si-cli validate-settings\n</code></pre> <p>Output: <pre><code>doc_db_url='sqlite+aiosqlite:///./db/documents.db'\ndocling_server_url='http://localhost:5001/v1'\nlog_level='INFO'\n...\n</code></pre></p> <p>Validation Errors: <pre><code>invalid settings\n{'type': 'missing', 'loc': ('doc_db_url',), 'msg': 'Field required'}\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#environment-specific-configuration","title":"Environment-Specific Configuration","text":""},{"location":"ingester/CONFIGURATION/#development","title":"Development","text":"<p>dev.env: <pre><code>DOC_DB_URL=sqlite+aiosqlite:///./db/dev.db\nLOG_LEVEL=DEBUG\nINGEST_WORKER_CONCURRENCY=5\nDO_RAG=false\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#staging","title":"Staging","text":"<p>staging.env: <pre><code>DOC_DB_URL=postgresql+psycopg://user:pass@staging-db:5432/soliplex\nLOG_LEVEL=INFO\nINGEST_WORKER_CONCURRENCY=10\nDOCLING_SERVER_URL=http://docling-staging:5001/v1\nDO_RAG=true\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#production","title":"Production","text":"<p>production.env: <pre><code>DOC_DB_URL=postgresql+psycopg://user:pass@prod-db:5432/soliplex\nLOG_LEVEL=WARNING\nINGEST_WORKER_CONCURRENCY=20\nDOCLING_CONCURRENCY=5\nDOCLING_SERVER_URL=http://docling-prod:5001/v1\nFILE_STORE_TARGET=s3\nDO_RAG=true\nWORKER_CHECKIN_INTERVAL=60\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#docker-configuration","title":"Docker Configuration","text":""},{"location":"ingester/CONFIGURATION/#docker-compose-example","title":"Docker Compose Example","text":"<p>docker-compose.yml: <pre><code>version: '3.8'\n\nservices:\n  ingester:\n    image: soliplex-ingester:latest\n    environment:\n      DOC_DB_URL: postgresql+psycopg://postgres:password@db:5432/soliplex\n      DOCLING_SERVER_URL: http://docling:5001/v1\n      LOG_LEVEL: INFO\n      FILE_STORE_DIR: /data/files\n      LANCEDB_DIR: /data/lancedb\n      INGEST_WORKER_CONCURRENCY: 15\n    volumes:\n      - ./config/workflows:/app/config/workflows\n      - ./config/params:/app/config/params\n      - data-volume:/data\n    depends_on:\n      - db\n      - docling\n\n  db:\n    image: postgres:16\n    environment:\n      POSTGRES_DB: soliplex\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: password\n    volumes:\n      - db-volume:/var/lib/postgresql/data\n\n  docling:\n    image: docling-server:latest\n    ports:\n      - \"5001:5001\"\n\nvolumes:\n  db-volume:\n  data-volume:\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#kubernetes-configmap","title":"Kubernetes ConfigMap","text":"<p>configmap.yaml: <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: soliplex-config\ndata:\n  DOC_DB_URL: \"postgresql+psycopg://user:pass@postgres-service:5432/soliplex\"\n  DOCLING_SERVER_URL: \"http://docling-service:5001/v1\"\n  LOG_LEVEL: \"INFO\"\n  INGEST_WORKER_CONCURRENCY: \"20\"\n  WORKFLOW_DIR: \"/config/workflows\"\n  PARAM_DIR: \"/config/params\"\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#performance-tuning","title":"Performance Tuning","text":""},{"location":"ingester/CONFIGURATION/#high-throughput","title":"High Throughput","text":"<pre><code>INGEST_WORKER_CONCURRENCY=50\nDOCLING_CONCURRENCY=10\nWORKER_TASK_COUNT=20\nEMBED_BATCH_SIZE=2000\n</code></pre> <p>Notes: - Requires powerful hardware - Monitor CPU, memory, and I/O - Coordinate with external service capacity</p>"},{"location":"ingester/CONFIGURATION/#resource-constrained","title":"Resource Constrained","text":"<pre><code>INGEST_WORKER_CONCURRENCY=5\nDOCLING_CONCURRENCY=2\nWORKER_TASK_COUNT=3\nEMBED_BATCH_SIZE=500\n</code></pre> <p>Notes: - Reduces memory and CPU usage - Lower throughput but more stable - Good for shared environments</p>"},{"location":"ingester/CONFIGURATION/#batch-processing","title":"Batch Processing","text":"<pre><code>INGEST_WORKER_CONCURRENCY=30\nDOCLING_CONCURRENCY=8\nWORKER_TASK_COUNT=10\nWORKER_CHECKIN_INTERVAL=300\n</code></pre> <p>Notes: - Optimized for processing large batches - Reduces monitoring overhead - Assumes long-running workers</p>"},{"location":"ingester/CONFIGURATION/#secrets-management","title":"Secrets Management","text":""},{"location":"ingester/CONFIGURATION/#using-environment-files","title":"Using Environment Files","text":"<p>Keep secrets out of version control:</p> <pre><code># .env.secrets (add to .gitignore)\nDOC_DB_URL=postgresql+psycopg://user:$(cat /run/secrets/db_password)@db/soliplex\n</code></pre>"},{"location":"ingester/CONFIGURATION/#using-secret-management-tools","title":"Using Secret Management Tools","text":"<p>AWS Secrets Manager: <pre><code>export DOC_DB_URL=$(aws secretsmanager get-secret-value --secret-id db-url --query SecretString --output text)\n</code></pre></p> <p>HashiCorp Vault: <pre><code>export DOC_DB_URL=$(vault kv get -field=url secret/soliplex/db)\n</code></pre></p> <p>Kubernetes Secrets: <pre><code>env:\n  - name: DOC_DB_URL\n    valueFrom:\n      secretKeyRef:\n        name: db-credentials\n        key: url\n</code></pre></p>"},{"location":"ingester/CONFIGURATION/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ingester/CONFIGURATION/#configuration-not-loading","title":"Configuration Not Loading","text":"<p>Symptom: Application uses default values</p> <p>Solutions: 1. Verify environment variables are set: <code>env | grep DOC_</code> 2. Check for typos in variable names 3. Ensure <code>.env</code> file is in correct directory 4. Verify <code>.env</code> file is being loaded</p>"},{"location":"ingester/CONFIGURATION/#validation-errors","title":"Validation Errors","text":"<p>Symptom: Application fails to start with validation error</p> <p>Solutions: 1. Run <code>si-cli validate-settings</code> to see errors 2. Check required fields are set 3. Verify value types (e.g., integers for ports) 4. Check URL formats</p>"},{"location":"ingester/CONFIGURATION/#connection-errors","title":"Connection Errors","text":"<p>Symptom: Cannot connect to database or Docling</p> <p>Solutions: 1. Verify URLs are correct 2. Test connectivity: <code>curl http://docling-url/health</code> 3. Check network policies/firewall 4. Verify credentials</p>"},{"location":"ingester/CONFIGURATION/#file-permissions","title":"File Permissions","text":"<p>Symptom: Cannot write to storage directories</p> <p>Solutions: 1. Check directory exists and is writable 2. Verify application user permissions 3. Create directories if needed: <code>mkdir -p file_store lancedb</code> 4. Set ownership: <code>chown -R app-user file_store lancedb</code></p>"},{"location":"ingester/CONFIGURATION/#configuration-reference","title":"Configuration Reference","text":"Variable Type Required Default Description <code>DOC_DB_URL</code> str Yes - Database connection URL <code>DOCLING_SERVER_URL</code> str No <code>http://localhost:5001/v1</code> Docling parsing service URL <code>DOCLING_CHUNK_SERVER_URL</code> str No <code>http://localhost:5001/v1</code> Docling chunking service URL <code>DOCLING_HTTP_TIMEOUT</code> int No <code>600</code> Docling timeout (seconds) <code>LOG_LEVEL</code> str No <code>INFO</code> Logging level <code>FILE_STORE_TARGET</code> str No <code>fs</code> Storage backend type <code>FILE_STORE_DIR</code> str No <code>file_store</code> Base storage directory <code>LANCEDB_DIR</code> str No <code>lancedb</code> LanceDB directory (supports S3 URIs) <code>DOCUMENT_STORE_DIR</code> str No <code>raw</code> Raw documents subdir <code>PARSED_MARKDOWN_STORE_DIR</code> str No <code>markdown</code> Markdown subdir <code>PARSED_JSON_STORE_DIR</code> str No <code>json</code> JSON subdir <code>CHUNKS_STORE_DIR</code> str No <code>chunks</code> Chunks subdir <code>EMBEDDINGS_STORE_DIR</code> str No <code>embeddings</code> Embeddings subdir <code>INGEST_QUEUE_CONCURRENCY</code> int No <code>20</code> Queue concurrency <code>INGEST_WORKER_CONCURRENCY</code> int No <code>10</code> Worker concurrency <code>DOCLING_CONCURRENCY</code> int No <code>3</code> Docling concurrency <code>WORKER_TASK_COUNT</code> int No <code>5</code> Steps per query <code>WORKER_CHECKIN_INTERVAL</code> int No <code>120</code> Heartbeat interval (sec) <code>WORKER_CHECKIN_TIMEOUT</code> int No <code>600</code> Worker timeout (sec) <code>EMBED_BATCH_SIZE</code> int No <code>1000</code> Embedding batch size <code>WORKFLOW_DIR</code> str No <code>config/workflows</code> Workflow definitions dir <code>DEFAULT_WORKFLOW_ID</code> str No <code>batch_split</code> Default workflow <code>PARAM_DIR</code> str No <code>config/params</code> Parameter sets dir <code>DEFAULT_PARAM_ID</code> str No <code>default</code> Default parameter set <code>AWS_ACCESS_KEY_ID</code> str Conditional - AWS access key (required for S3 LanceDB) <code>AWS_SECRET_ACCESS_KEY</code> str Conditional - AWS secret key (required for S3 LanceDB) <code>AWS_REGION</code> str Conditional - AWS region (required for S3 LanceDB) <code>AWS_ENDPOINT</code> str No - S3 endpoint (for non-AWS providers) <code>AWS_ALLOW_HTTP</code> int No - Allow HTTP for S3 (set to 1 for HTTP) <code>ARTIFACT_S3__*</code> nested Conditional - Artifact S3 config (BUCKET, ACCESS_SECRET, etc.) <code>INPUT_S3__*</code> nested Conditional - Input S3 config (BUCKET, ACCESS_SECRET, etc.) <code>DO_RAG</code> bool No <code>True</code> Enable RAG integration <code>API_KEY</code> str Conditional - Static API key (required if API_KEY_ENABLED) <code>API_KEY_ENABLED</code> bool No <code>False</code> Enable API key authentication <code>AUTH_TRUST_PROXY_HEADERS</code> bool No <code>False</code> Trust OAuth2 Proxy headers"},{"location":"ingester/DATABASE/","title":"Database Models and Schema","text":""},{"location":"ingester/DATABASE/#overview","title":"Overview","text":"<p>Soliplex Ingester uses SQLModel (built on SQLAlchemy) for database modeling with async support. The system supports both SQLite (development) and PostgreSQL (production).</p> <p>Database models defined in: <code>src/soliplex_ingester/lib/models.py</code></p>"},{"location":"ingester/DATABASE/#database-connection","title":"Database Connection","text":""},{"location":"ingester/DATABASE/#configuration","title":"Configuration","text":"<p>Set via environment variable: <pre><code>DOC_DB_URL=\"sqlite+aiosqlite:///./db/documents.db\"\n# or\nDOC_DB_URL=\"postgresql+asyncpg://user:pass@localhost/soliplex\"\n</code></pre></p>"},{"location":"ingester/DATABASE/#async-engine","title":"Async Engine","text":"<p>The system uses async SQLAlchemy with connection pooling:</p> <pre><code>from soliplex_ingester.lib.models import get_session\n\nasync with get_session() as session:\n    # Your database operations\n    result = await session.exec(select(Document))\n</code></pre>"},{"location":"ingester/DATABASE/#core-models","title":"Core Models","text":""},{"location":"ingester/DATABASE/#documentbatch","title":"DocumentBatch","text":"<p>Represents a batch of documents ingested together.</p> <p>Table: <code>documentbatch</code></p> <p>Fields: - <code>id</code> (int, primary key) - Auto-increment batch ID - <code>name</code> (str) - Human-readable batch name - <code>source</code> (str) - Source system identifier - <code>start_date</code> (datetime) - When batch processing started - <code>completed_date</code> (datetime, nullable) - When batch completed - <code>batch_params</code> (dict[str, str]) - JSON metadata</p> <p>Computed Fields: - <code>duration</code> (float) - Processing time in seconds</p> <p>Example: <pre><code>{\n  \"id\": 1,\n  \"name\": \"Q4 Financial Reports\",\n  \"source\": \"sharepoint\",\n  \"start_date\": \"2025-01-15T10:00:00\",\n  \"completed_date\": \"2025-01-15T12:30:00\",\n  \"batch_params\": {\"department\": \"finance\"},\n  \"duration\": 9000.0\n}\n</code></pre></p>"},{"location":"ingester/DATABASE/#document","title":"Document","text":"<p>Represents a unique document identified by content hash.</p> <p>Table: <code>document</code></p> <p>Fields: - <code>hash</code> (str, primary key) - SHA256 content hash (format: \"sha256-...\") - <code>mime_type</code> (str) - Document MIME type - <code>file_size</code> (int, nullable) - Size in bytes - <code>doc_meta</code> (dict[str, str]) - JSON metadata</p> <p>Relationships: - Multiple <code>DocumentURI</code> records can reference the same document</p> <p>Deduplication: Documents are deduplicated by hash. If the same file is ingested multiple times, only one Document record exists.</p> <p>Example: <pre><code>{\n  \"hash\": \"sha256-a1b2c3d4e5f6...\",\n  \"mime_type\": \"application/pdf\",\n  \"file_size\": 1024000,\n  \"doc_meta\": {\n    \"author\": \"John Doe\",\n    \"title\": \"Q4 Report\"\n  },\n  \"rag_id\": \"doc_xyz123\",\n  \"batch_id\": 1\n}\n</code></pre></p>"},{"location":"ingester/DATABASE/#documenturi","title":"DocumentURI","text":"<p>Maps source URIs to document hashes, allowing multiple URIs to reference the same document.</p> <p>Table: <code>documenturi</code></p> <p>Fields: - <code>id</code> (int, primary key) - Auto-increment ID - <code>doc_hash</code> (str, foreign key) - References <code>document.hash</code> - <code>uri</code> (str) - Source system path/identifier - <code>source</code> (str) - Source system name - <code>version</code> (int) - Version number (increments on changes) - <code>batch_id</code> (int, foreign key, nullable) - Associated batch</p> <p>Constraints: - Unique constraint on <code>(uri, source)</code> - One active URI per source</p> <p>Use Cases: - Track document locations across source systems - Detect when a document at a URI has changed (hash mismatch) - Support document versioning</p> <p>Example: <pre><code>{\n  \"id\": 42,\n  \"doc_hash\": \"sha256-a1b2c3d4e5f6...\",\n  \"uri\": \"/sharepoint/finance/q4-report.pdf\",\n  \"source\": \"sharepoint\",\n  \"version\": 2,\n  \"batch_id\": 1\n}\n</code></pre></p>"},{"location":"ingester/DATABASE/#documenturihistory","title":"DocumentURIHistory","text":"<p>Tracks historical versions of documents at specific URIs.</p> <p>Table: <code>documenturihistory</code></p> <p>Fields: - <code>id</code> (int, primary key) - Auto-increment ID - <code>doc_uri_id</code> (int, foreign key) - References <code>documenturi.id</code> - <code>version</code> (int) - Version number - <code>hash</code> (str) - Document hash at this version - <code>process_date</code> (datetime) - When this version was processed - <code>action</code> (str) - Action taken (\"created\", \"updated\", \"deleted\") - <code>batch_id</code> (int, foreign key, nullable) - Associated batch - <code>histmeta</code> (dict[str, str]) - JSON metadata</p> <p>Use Cases: - Audit trail of document changes - Rollback to previous versions - Compliance and record-keeping</p> <p>Example: <pre><code>{\n  \"id\": 100,\n  \"doc_uri_id\": 42,\n  \"version\": 1,\n  \"hash\": \"sha256-old-hash...\",\n  \"process_date\": \"2025-01-10T10:00:00\",\n  \"action\": \"created\",\n  \"batch_id\": 1,\n  \"histmeta\": {\"user\": \"importer\"}\n}\n</code></pre></p>"},{"location":"ingester/DATABASE/#documentbytes","title":"DocumentBytes","text":"<p>Stores raw file bytes and artifacts in the database.</p> <p>Table: <code>documentbytes</code></p> <p>Fields: - <code>hash</code> (str, primary key) - Document hash - <code>artifact_type</code> (str, primary key) - Type of artifact - <code>storage_root</code> (str, primary key) - Storage location identifier - <code>file_size</code> (int, nullable) - Size in bytes (auto-computed) - <code>file_bytes</code> (bytes) - Raw binary data</p> <p>Artifact Types: - <code>document</code> - Raw document - <code>parsed_markdown</code> - Extracted markdown - <code>parsed_json</code> - Structured JSON - <code>chunks</code> - Text chunks - <code>embeddings</code> - Vector embeddings - <code>rag</code> - RAG metadata</p> <p>Note: For production, consider using file storage instead of database storage for large binaries.</p> <p>Example: <pre><code>{\n  \"hash\": \"sha256-a1b2c3d4e5f6...\",\n  \"artifact_type\": \"parsed_markdown\",\n  \"storage_root\": \"db\",\n  \"file_size\": 50000,\n  \"file_bytes\": b\"# Document Title\\n\\n...\"\n}\n</code></pre></p>"},{"location":"ingester/DATABASE/#workflow-models","title":"Workflow Models","text":""},{"location":"ingester/DATABASE/#rungroup","title":"RunGroup","text":"<p>Groups related workflow runs together.</p> <p>Table: <code>rungroup</code></p> <p>Fields: - <code>id</code> (int, primary key) - Auto-increment ID - <code>name</code> (str, nullable) - Optional group name - <code>workflow_definition_id</code> (str) - Workflow used - <code>param_definition_id</code> (str) - Parameter set used - <code>batch_id</code> (int, foreign key, nullable) - Associated batch - <code>created_date</code> (datetime) - When group was created - <code>start_date</code> (datetime) - When first run started - <code>completed_date</code> (datetime, nullable) - When all runs completed - <code>status</code> (RunStatus) - Overall group status - <code>status_date</code> (datetime, nullable) - When status last changed - <code>status_message</code> (str, nullable) - Status description - <code>status_meta</code> (dict[str, str]) - JSON metadata</p> <p>Relationships: - Has many <code>WorkflowRun</code> records - Has many <code>LifecycleHistory</code> records</p> <p>Example: <pre><code>{\n  \"id\": 5,\n  \"name\": \"Batch 1 Processing\",\n  \"workflow_definition_id\": \"batch\",\n  \"param_definition_id\": \"default\",\n  \"batch_id\": 1,\n  \"created_date\": \"2025-01-15T10:00:00\",\n  \"start_date\": \"2025-01-15T10:01:00\",\n  \"completed_date\": null,\n  \"status\": \"RUNNING\",\n  \"status_date\": \"2025-01-15T10:30:00\",\n  \"status_message\": \"Processing documents\",\n  \"status_meta\": {}\n}\n</code></pre></p>"},{"location":"ingester/DATABASE/#workflowrun","title":"WorkflowRun","text":"<p>Represents a single workflow execution for one document.</p> <p>Table: <code>workflowrun</code></p> <p>Fields: - <code>id</code> (int, primary key) - Auto-increment ID - <code>workflow_definition_id</code> (str) - Workflow definition ID - <code>run_group_id</code> (int, foreign key) - Parent group - <code>batch_id</code> (int, foreign key) - Associated batch - <code>doc_id</code> (str) - Document hash being processed - <code>priority</code> (int) - Processing priority (higher = more urgent) - <code>created_date</code> (datetime) - When run was created - <code>start_date</code> (datetime) - When first step started - <code>completed_date</code> (datetime, nullable) - When all steps completed - <code>status</code> (RunStatus) - Current status - <code>status_date</code> (datetime, nullable) - When status last changed - <code>status_message</code> (str, nullable) - Status description - <code>status_meta</code> (dict[str, str]) - JSON metadata - <code>run_params</code> (dict[str, str|int|bool]) - Runtime parameters</p> <p>Computed Fields: - <code>duration</code> (float) - Processing time in seconds</p> <p>Relationships: - Has many <code>RunStep</code> records - Belongs to <code>RunGroup</code> - References <code>Document</code> via <code>doc_id</code></p> <p>Example: <pre><code>{\n  \"id\": 100,\n  \"workflow_definition_id\": \"batch\",\n  \"run_group_id\": 5,\n  \"batch_id\": 1,\n  \"doc_id\": \"sha256-a1b2c3d4e5f6...\",\n  \"priority\": 0,\n  \"created_date\": \"2025-01-15T10:00:00\",\n  \"start_date\": \"2025-01-15T10:01:00\",\n  \"completed_date\": null,\n  \"status\": \"RUNNING\",\n  \"status_date\": \"2025-01-15T10:05:00\",\n  \"status_message\": \"Processing step 3 of 5\",\n  \"status_meta\": {},\n  \"run_params\": {},\n  \"duration\": null\n}\n</code></pre></p>"},{"location":"ingester/DATABASE/#runstep","title":"RunStep","text":"<p>Represents one step within a workflow run.</p> <p>Table: <code>runstep</code></p> <p>Fields: - <code>id</code> (int, primary key) - Auto-increment ID - <code>workflow_run_id</code> (int, foreign key) - Parent workflow run - <code>workflow_step_number</code> (int) - Step sequence number - <code>workflow_step_name</code> (str) - Step name/identifier - <code>step_config_id</code> (int, foreign key) - Configuration used - <code>step_type</code> (WorkflowStepType) - Type of step - <code>is_last_step</code> (bool) - Whether this is the final step - <code>created_date</code> (datetime) - When step was created - <code>priority</code> (int) - Processing priority - <code>start_date</code> (datetime, nullable) - When step started executing - <code>status_date</code> (datetime, nullable) - When status last changed - <code>completed_date</code> (datetime, nullable) - When step completed - <code>retry</code> (int) - Current retry attempt (0-indexed) - <code>retries</code> (int) - Maximum retry attempts - <code>status</code> (RunStatus) - Current status - <code>status_message</code> (str, nullable) - Status description - <code>status_meta</code> (dict[str, str]) - JSON metadata - <code>worker_id</code> (str, nullable) - Worker processing this step</p> <p>Computed Fields: - <code>duration</code> (float) - Execution time in seconds</p> <p>Relationships: - Belongs to <code>WorkflowRun</code> - References <code>StepConfig</code></p> <p>Example: <pre><code>{\n  \"id\": 500,\n  \"workflow_run_id\": 100,\n  \"workflow_step_number\": 2,\n  \"workflow_step_name\": \"parse\",\n  \"step_config_id\": 10,\n  \"step_type\": \"parse\",\n  \"is_last_step\": false,\n  \"created_date\": \"2025-01-15T10:01:00\",\n  \"priority\": 0,\n  \"start_date\": \"2025-01-15T10:02:00\",\n  \"status_date\": \"2025-01-15T10:05:00\",\n  \"completed_date\": null,\n  \"retry\": 0,\n  \"retries\": 3,\n  \"status\": \"RUNNING\",\n  \"status_message\": \"Parsing with Docling\",\n  \"status_meta\": {},\n  \"worker_id\": \"worker-abc-123\",\n  \"duration\": null\n}\n</code></pre></p>"},{"location":"ingester/DATABASE/#stepconfig","title":"StepConfig","text":"<p>Stores step configuration for reuse and tracking.</p> <p>Table: <code>stepconfig</code></p> <p>Fields: - <code>id</code> (int, primary key) - Auto-increment ID - <code>created_date</code> (datetime, nullable) - When config was created - <code>step_type</code> (WorkflowStepType) - Type of step - <code>config_json</code> (dict[str, str|int|bool], nullable) - Step parameters - <code>cuml_config_json</code> (str, nullable) - Cumulative config from previous steps</p> <p>Use Cases: - Deduplicate identical configurations - Track which configuration was used for each run - Audit changes to processing parameters</p> <p>Example: <pre><code>{\n  \"id\": 10,\n  \"created_date\": \"2025-01-15T09:00:00\",\n  \"step_type\": \"parse\",\n  \"config_json\": {\n    \"format\": \"markdown\",\n    \"ocr_enabled\": true\n  },\n  \"cuml_config_json\": \"{\\\"validate\\\":{...},\\\"parse\\\":{...}}\"\n}\n</code></pre></p>"},{"location":"ingester/DATABASE/#configset","title":"ConfigSet","text":"<p>Represents a complete parameter set configuration.</p> <p>Table: <code>configset</code></p> <p>Fields: - <code>id</code> (int, primary key) - Auto-increment ID - <code>yaml_id</code> (str) - Parameter set ID from YAML - <code>yaml_contents</code> (str) - Full YAML contents - <code>created_date</code> (datetime, nullable) - When loaded</p> <p>Relationships: - Has many <code>ConfigSetItem</code> records (junction table) - Links to multiple <code>StepConfig</code> records</p> <p>Use Cases: - Track which parameter sets were used - Reproduce exact configurations - Version control for processing parameters</p>"},{"location":"ingester/DATABASE/#configsetitem","title":"ConfigSetItem","text":"<p>Junction table linking config sets to step configs.</p> <p>Table: <code>configsetitem</code></p> <p>Fields: - <code>config_set_id</code> (int, primary key, foreign key) - References <code>configset.id</code> - <code>config_id</code> (int, primary key, foreign key) - References <code>stepconfig.id</code></p>"},{"location":"ingester/DATABASE/#lifecyclehistory","title":"LifecycleHistory","text":"<p>Tracks lifecycle events during workflow execution.</p> <p>Table: <code>lifecyclehistory</code></p> <p>Fields: - <code>id</code> (int, primary key) - Auto-increment ID - <code>event</code> (LifeCycleEvent) - Type of event - <code>run_group_id</code> (int, foreign key) - Associated run group - <code>workflow_run_id</code> (int, foreign key) - Associated workflow run - <code>step_id</code> (int, nullable) - Associated step (if applicable) - <code>start_date</code> (datetime) - When event started - <code>completed_date</code> (datetime, nullable) - When event completed - <code>status</code> (RunStatus) - Event status - <code>status_date</code> (datetime, nullable) - When status changed - <code>status_message</code> (str, nullable) - Status description - <code>status_meta</code> (dict[str, str]) - JSON metadata</p> <p>Event Types: - <code>GROUP_START</code> / <code>GROUP_END</code> - <code>ITEM_START</code> / <code>ITEM_END</code> / <code>ITEM_FAILED</code> - <code>STEP_START</code> / <code>STEP_END</code> / <code>STEP_FAILED</code></p> <p>Use Cases: - Audit trail of workflow execution - Performance monitoring - Debugging workflow issues</p>"},{"location":"ingester/DATABASE/#workercheckin","title":"WorkerCheckin","text":"<p>Tracks worker health and activity.</p> <p>Table: <code>workercheckin</code></p> <p>Fields: - <code>id</code> (str, primary key) - Worker identifier - <code>first_checkin</code> (datetime) - When worker first registered - <code>last_checkin</code> (datetime) - Most recent heartbeat</p> <p>Constraints: - Unique constraint on <code>id</code></p> <p>Use Cases: - Monitor active workers - Detect stale/crashed workers - Worker load balancing</p> <p>Example: <pre><code>{\n  \"id\": \"worker-abc-123\",\n  \"first_checkin\": \"2025-01-15T10:00:00\",\n  \"last_checkin\": \"2025-01-15T10:30:00\"\n}\n</code></pre></p>"},{"location":"ingester/DATABASE/#enums","title":"Enums","text":""},{"location":"ingester/DATABASE/#runstatus","title":"RunStatus","text":"<p>Workflow and step status values.</p> <pre><code>class RunStatus(str, Enum):\n    PENDING = \"PENDING\"      # Not yet started\n    RUNNING = \"RUNNING\"      # Currently executing\n    COMPLETED = \"COMPLETED\"  # Finished successfully\n    ERROR = \"ERROR\"          # Failed but will retry\n    FAILED = \"FAILED\"        # Permanently failed\n</code></pre>"},{"location":"ingester/DATABASE/#workflowsteptype","title":"WorkflowStepType","text":"<p>Types of workflow steps.</p> <pre><code>class WorkflowStepType(str, Enum):\n    INGEST = \"ingest\"\n    VALIDATE = \"validate\"\n    PARSE = \"parse\"\n    CHUNK = \"chunk\"\n    EMBED = \"embed\"\n    STORE = \"store\"\n    ENRICH = \"enrich\"\n    ROUTE = \"route\"\n</code></pre>"},{"location":"ingester/DATABASE/#artifacttype","title":"ArtifactType","text":"<p>Types of stored artifacts.</p> <pre><code>class ArtifactType(Enum):\n    DOC = \"document\"\n    PARSED_MD = \"parsed_markdown\"\n    PARSED_JSON = \"parsed_json\"\n    CHUNKS = \"chunks\"\n    EMBEDDINGS = \"embeddings\"\n    RAG = \"rag\"\n</code></pre>"},{"location":"ingester/DATABASE/#lifecycleevent","title":"LifeCycleEvent","text":"<p>Workflow lifecycle events.</p> <pre><code>class LifeCycleEvent(str, Enum):\n    GROUP_START = \"group_start\"\n    GROUP_END = \"group_end\"\n    ITEM_START = \"item_start\"\n    ITEM_END = \"item_end\"\n    ITEM_FAILED = \"item_failed\"\n    STEP_START = \"step_start\"\n    STEP_END = \"step_end\"\n    STEP_FAILED = \"step_failed\"\n</code></pre>"},{"location":"ingester/DATABASE/#relationships-diagram","title":"Relationships Diagram","text":"<pre><code>DocumentBatch\n    \u2193 (1:N)\nDocumentURI \u2500\u2500\u2192 Document (N:1)\n    \u2193\nDocumentURIHistory\n\nDocumentBatch\n    \u2193 (1:N)\nRunGroup\n    \u2193 (1:N)\nWorkflowRun \u2500\u2500\u2192 Document (N:1)\n    \u2193 (1:N)\nRunStep \u2500\u2500\u2192 StepConfig (N:1)\n\nConfigSet\n    \u2193 (N:M via ConfigSetItem)\nStepConfig\n\nRunGroup \u2500\u2500\u2192 LifecycleHistory (1:N)\nWorkflowRun \u2500\u2500\u2192 LifecycleHistory (1:N)\n</code></pre>"},{"location":"ingester/DATABASE/#database-initialization","title":"Database Initialization","text":""},{"location":"ingester/DATABASE/#using-cli","title":"Using CLI","text":"<pre><code>si-cli db-init\n</code></pre> <p>This creates tables and runs migrations.</p>"},{"location":"ingester/DATABASE/#using-alembic-directly","title":"Using Alembic Directly","text":"<pre><code>alembic upgrade head\n</code></pre>"},{"location":"ingester/DATABASE/#programmatic","title":"Programmatic","text":"<pre><code>from sqlalchemy import create_engine\nfrom sqlmodel import SQLModel\nfrom soliplex_ingester.lib.config import get_settings\n\nsettings = get_settings()\nengine = create_engine(settings.doc_db_url)\nSQLModel.metadata.create_all(engine)\n</code></pre>"},{"location":"ingester/DATABASE/#migrations","title":"Migrations","text":""},{"location":"ingester/DATABASE/#location","title":"Location","text":"<p><code>src/soliplex_ingester/migrations/</code></p>"},{"location":"ingester/DATABASE/#configuration_1","title":"Configuration","text":"<p><code>alembic.ini</code> (project root)</p>"},{"location":"ingester/DATABASE/#create-migration","title":"Create Migration","text":"<pre><code>alembic revision --autogenerate -m \"description\"\n</code></pre>"},{"location":"ingester/DATABASE/#apply-migration","title":"Apply Migration","text":"<pre><code>alembic upgrade head\n</code></pre>"},{"location":"ingester/DATABASE/#rollback","title":"Rollback","text":"<pre><code>alembic downgrade -1\n</code></pre>"},{"location":"ingester/DATABASE/#indexes","title":"Indexes","text":"<p>Consider adding these indexes for production:</p> <pre><code>-- Workflow processing queries\nCREATE INDEX idx_runstep_status ON runstep(status, priority DESC);\nCREATE INDEX idx_workflowrun_status ON workflowrun(status, batch_id);\nCREATE INDEX idx_rungroup_batch ON rungroup(batch_id);\n\n-- Document lookups\nCREATE INDEX idx_documenturi_source ON documenturi(source);\nCREATE INDEX idx_document_batch ON document(batch_id);\n\n-- Worker monitoring\nCREATE INDEX idx_runstep_worker ON runstep(worker_id);\nCREATE INDEX idx_workercheckin_last ON workercheckin(last_checkin);\n</code></pre>"},{"location":"ingester/DATABASE/#backup-and-maintenance","title":"Backup and Maintenance","text":""},{"location":"ingester/DATABASE/#sqlite-backup","title":"SQLite Backup","text":"<pre><code>sqlite3 db/documents.db \".backup backup.db\"\n</code></pre>"},{"location":"ingester/DATABASE/#postgresql-backup","title":"PostgreSQL Backup","text":"<pre><code>pg_dump -h localhost -U user soliplex &gt; backup.sql\n</code></pre>"},{"location":"ingester/DATABASE/#vacuum-sqlite","title":"Vacuum (SQLite)","text":"<pre><code>sqlite3 db/documents.db \"VACUUM;\"\n</code></pre>"},{"location":"ingester/DATABASE/#analyze-postgresql","title":"Analyze (PostgreSQL)","text":"<pre><code>psql -h localhost -U user -d soliplex -c \"ANALYZE;\"\n</code></pre>"},{"location":"ingester/DATABASE/#query-examples","title":"Query Examples","text":""},{"location":"ingester/DATABASE/#find-failed-workflows","title":"Find Failed Workflows","text":"<pre><code>from soliplex_ingester.lib.models import WorkflowRun, RunStatus, get_session\nfrom sqlmodel import select\n\nasync with get_session() as session:\n    query = select(WorkflowRun).where(WorkflowRun.status == RunStatus.FAILED)\n    results = await session.exec(query)\n    failed_runs = results.all()\n</code></pre>"},{"location":"ingester/DATABASE/#get-batch-statistics","title":"Get Batch Statistics","text":"<pre><code>from sqlmodel import func, select\n\nasync with get_session() as session:\n    query = select(\n        func.count(WorkflowRun.id).label(\"total\"),\n        WorkflowRun.status\n    ).where(\n        WorkflowRun.batch_id == batch_id\n    ).group_by(WorkflowRun.status)\n\n    results = await session.exec(query)\n    stats = {row.status: row.total for row in results}\n</code></pre>"},{"location":"ingester/DATABASE/#find-stale-workers","title":"Find Stale Workers","text":"<pre><code>from datetime import datetime, timedelta\n\ncutoff = datetime.now() - timedelta(seconds=600)\nquery = select(WorkerCheckin).where(WorkerCheckin.last_checkin &lt; cutoff)\nstale_workers = await session.exec(query)\n</code></pre>"},{"location":"ingester/GETTING_STARTED/","title":"Getting Started with Soliplex Ingester","text":""},{"location":"ingester/GETTING_STARTED/#quick-start","title":"Quick Start","text":"<p>This guide will help you get Soliplex Ingester up and running in minutes.</p>"},{"location":"ingester/GETTING_STARTED/#prerequisites","title":"Prerequisites","text":"<ul> <li>Python 3.12 or higher</li> <li>pip or uv package manager</li> <li>SQLite (included with Python) or PostgreSQL</li> <li>Docling server for document parsing (optional)</li> <li>S3 backend (optional)</li> </ul>"},{"location":"ingester/GETTING_STARTED/#docker-services","title":"Docker Services","text":"<p>A sample docker compose file is provided to show how to configure services used by the ingester.</p>"},{"location":"ingester/GETTING_STARTED/#postgres","title":"postgres","text":"<p>The postgres configuration includes references to startup scripts to create sample users and permissions, but for a production deployment, a more sophisticated secrets configuration should be used. Data is stored in a docker volume which may also need to be changed for a production setup.</p>"},{"location":"ingester/GETTING_STARTED/#docling-serve","title":"docling-serve","text":"<p>Docling-serve is used to convert pdf documents into markdown and docling JSON documents for use in the pipelline. In order to allow for higher concurrency, the example file shows how to use multiple instances of docling that are load balanced using cookies. The docling client in the ingester handles the cookies to ensure the full request cycle stays on the same server.</p> <p>The configuration also shows how to provision GPUs for use in parsing.  Depending on server hardware, the device ids may have to be changed. Multiple instances can share a single GPU but testing is required to determine the optimal configuration.</p> <p>Docling serve is prone to leak memory so constraining its memory allocation is necessary to prevent overloading server resources.  The restart settings along with load balancing and retry logic in the client will ensure that the ingester is able to continue uninterrupted.</p>"},{"location":"ingester/GETTING_STARTED/#seaweedfs","title":"seaweedfs","text":"<p>SeaweedFS is provided as a simple S3 compatible storage if desired for either the intermediate artifacts or the final LanceDB databases. An initialization script is provided to create the necessary bucket and authentication information. A production configuration should use a more robust secrets confugration.  Cloud providers can also be used for storage if desired.</p>"},{"location":"ingester/GETTING_STARTED/#_1","title":"Getting Started","text":""},{"location":"ingester/GETTING_STARTED/#1-install-package","title":"1. Install Package","text":""},{"location":"ingester/GETTING_STARTED/#installation-from-source","title":"Installation from source","text":"<p>Using pip: <pre><code>cd soliplex-ingester\npip install -e .\n</code></pre></p> <p>Using uv: <pre><code>cd soliplex-ingester\nuv pip install -e .\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#running-your-own-install","title":"Running your own Install","text":"<p>You can integrate soliplex ingester into another python project by installing it like any other package.  This will allow you to use custom methods for any part of the workflow if desired.</p> <pre><code>uv init --lib &lt;my project name&gt;\nuv add https://github.com/soliplex/ingester.git\nuv run si-cli bootstrap\n</code></pre> <p>This installs the package and makes the <code>si-cli</code> command available.</p>"},{"location":"ingester/GETTING_STARTED/#2-verify-installation","title":"2. Verify Installation","text":"<pre><code>si-cli --help\n</code></pre> <p>You should see the CLI help menu.</p>"},{"location":"ingester/GETTING_STARTED/#configuration","title":"Configuration","text":""},{"location":"ingester/GETTING_STARTED/#3-set-environment-variables","title":"3. Set Environment Variables","text":"<p>Automatically configure: <pre><code>uv run init-env\n</code></pre></p> <p>Manually create a <code>.env</code> file in the project root:</p> <pre><code># Minimum required configuration\nDOC_DB_URL=sqlite+aiosqlite:///./db/documents.db\n\n# Optional: Docling service (for document parsing)\nDOCLING_SERVER_URL=http://localhost:5001/v1\n\n# Optional: Adjust logging\nLOG_LEVEL=INFO\n</code></pre> <p>Load the environment: <pre><code>export $(cat .env | xargs)\n</code></pre></p> <p>Or on Windows: <pre><code>Get-Content .env | ForEach-Object { $var = $_.Split('='); [Environment]::SetEnvironmentVariable($var[0], $var[1]) }\n</code></pre> Alternatively, si-cli can be run via uv to initialize the environment file <pre><code>uv run --env-file=.env si-cli\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#4-validate-configuration","title":"4. Validate Configuration","text":"<pre><code>si-cli validate-settings\n</code></pre> <p>This should display your configuration without errors.</p>"},{"location":"ingester/GETTING_STARTED/#database-setup","title":"Database Setup","text":""},{"location":"ingester/GETTING_STARTED/#5-initialize-database","title":"5. Initialize Database","text":"<pre><code>si-cli db-init\n</code></pre> <p>This creates: - SQLite database file at <code>db/documents.db</code> - All necessary tables - Runs migrations</p>"},{"location":"ingester/GETTING_STARTED/#start-the-server","title":"Start the Server","text":""},{"location":"ingester/GETTING_STARTED/#6-run-the-development-server","title":"6. Run the Development Server","text":"<pre><code>si-cli serve --reload\n</code></pre> <p>The server starts on <code>http://127.0.0.1:8000</code> with: - Auto-reload on code changes - Integrated worker for processing - OpenAPI docs at <code>/docs</code></p> <p>Test the server: <pre><code>curl http://localhost:8000/docs\n</code></pre></p> <p>You should see the Swagger UI.</p>"},{"location":"ingester/GETTING_STARTED/#your-first-batch","title":"Your First Batch","text":""},{"location":"ingester/GETTING_STARTED/#7-create-a-batch","title":"7. Create a Batch","text":"<pre><code>curl -X POST \"http://localhost:8000/api/v1/batch/\" \\\n  -d \"source=test\" \\\n  -d \"name=My First Batch\"\n</code></pre> <p>Response: <pre><code>{\n  \"batch_id\": 1\n}\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#8-ingest-a-document","title":"8. Ingest a Document","text":"<p>Option A: Upload a file <pre><code>curl -X POST \"http://localhost:8000/api/v1/document/ingest-document\" \\\n  -F \"file=@sample.pdf\" \\\n  -F \"source_uri=/documents/sample.pdf\" \\\n  -F \"source=test\" \\\n  -F \"batch_id=1\"\n</code></pre></p> <p>Option B: Provide a URI (requires Docling server) <pre><code>curl -X POST \"http://localhost:8000/api/v1/document/ingest-document\" \\\n  -F \"input_uri=https://example.com/document.pdf\" \\\n  -F \"source_uri=/remote/document.pdf\" \\\n  -F \"source=test\" \\\n  -F \"batch_id=1\"\n</code></pre></p> <p>Response: <pre><code>{\n  \"batch_id\": 1,\n  \"document_uri\": \"/documents/sample.pdf\",\n  \"document_hash\": \"sha256-abc123...\",\n  \"source\": \"test\",\n  \"uri_id\": 1\n}\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#9-start-workflow-processing","title":"9. Start Workflow Processing","text":"<pre><code>curl -X POST \"http://localhost:8000/api/v1/batch/start-workflows\" \\\n  -d \"batch_id=1\" \\\n  -d \"workflow_definition_id=batch\"\n</code></pre> <p>Response: <pre><code>{\n  \"message\": \"Workflows started\",\n  \"workflows\": 1,\n  \"run_group\": 1\n}\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#10-monitor-progress","title":"10. Monitor Progress","text":"<p>Check batch status: <pre><code>curl \"http://localhost:8000/api/v1/batch/status?batch_id=1\"\n</code></pre></p> <p>Response: <pre><code>{\n  \"batch\": { ... },\n  \"document_count\": 1,\n  \"workflow_count\": {\n    \"COMPLETED\": 0,\n    \"RUNNING\": 1,\n    \"PENDING\": 0\n  },\n  \"workflows\": [ ... ],\n  \"parsed\": 0,\n  \"remaining\": 1\n}\n</code></pre></p> <p>Watch workflow runs: <pre><code>watch -n 5 'curl -s \"http://localhost:8000/api/v1/workflow/?batch_id=1\"'\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#11-view-results","title":"11. View Results","text":"<p>Once processing completes, check the document:</p> <pre><code>curl \"http://localhost:8000/api/v1/document/?batch_id=1\"\n</code></pre>"},{"location":"ingester/GETTING_STARTED/#next-steps","title":"Next Steps","text":""},{"location":"ingester/GETTING_STARTED/#explore-workflows","title":"Explore Workflows","text":"<p>List available workflows: <pre><code>si-cli list-workflows\n</code></pre></p> <p>Inspect a workflow: <pre><code>si-cli dump-workflow batch\n</code></pre></p> <p>View workflow runs: <pre><code>curl \"http://localhost:8000/api/v1/workflow/?batch_id=1\"\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#configure-parameters","title":"Configure Parameters","text":"<p>List parameter sets: <pre><code>si-cli list-param-sets\n</code></pre></p> <p>View parameters: <pre><code>si-cli dump-param-set default\n</code></pre></p> <p>Create custom parameters: 1. Copy <code>config/params/default.yaml</code> to <code>config/params/custom.yaml</code> 2. Modify settings as needed 3. Use in API: <code>-d \"param_id=custom\"</code></p>"},{"location":"ingester/GETTING_STARTED/#scale-workers","title":"Scale Workers","text":"<p>Run additional workers: <pre><code># Terminal 1\nsi-cli worker\n\n# Terminal 2\nsi-cli worker\n\n# Terminal 3\nsi-cli worker\n</code></pre></p> <p>Each worker processes steps independently, increasing throughput.</p>"},{"location":"ingester/GETTING_STARTED/#monitor-system","title":"Monitor System","text":"<p>API Documentation: Browse to <code>http://localhost:8000/docs</code> for interactive API docs.</p> <p>Database Inspection: <pre><code>sqlite3 db/documents.db\nsqlite&gt; .tables\nsqlite&gt; SELECT * FROM documentbatch;\nsqlite&gt; SELECT * FROM workflowrun WHERE batch_id = 1;\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ingester/GETTING_STARTED/#server-wont-start","title":"Server Won't Start","text":"<p>Problem: Configuration validation fails</p> <p>Solution: <pre><code>si-cli validate-settings\n</code></pre></p> <p>Fix any reported errors in your <code>.env</code> file.</p> <p>Problem: Port already in use</p> <p>Solution: <pre><code>si-cli serve --port 8001\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#workflows-stuck","title":"Workflows Stuck","text":"<p>Problem: Workflows remain in PENDING status</p> <p>Solution: Ensure a worker is running: <pre><code>si-cli worker\n</code></pre></p> <p>Check worker logs for errors.</p>"},{"location":"ingester/GETTING_STARTED/#document-parsing-fails","title":"Document Parsing Fails","text":"<p>Problem: Parse step fails with connection error</p> <p>Solution: 1. Verify Docling server is running 2. Check <code>DOCLING_SERVER_URL</code> is correct 3. Test connectivity:    <pre><code>curl http://localhost:5001/v1/health\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#database-errors","title":"Database Errors","text":"<p>Problem: Database connection fails</p> <p>Solution: 1. Check <code>DOC_DB_URL</code> format 2. Ensure directory exists: <code>mkdir -p db</code> 3. Check permissions: <code>chmod 755 db</code> 4. Reinitialize: <code>si-cli db-init</code></p>"},{"location":"ingester/GETTING_STARTED/#development-mode","title":"Development Mode","text":"<p>For active development:</p> <p>1. Enable auto-reload: <pre><code>si-cli serve --reload\n</code></pre></p> <p>2. Set debug logging: <pre><code>export LOG_LEVEL=DEBUG\nsi-cli serve --reload\n</code></pre></p> <p>3. Watch logs: <pre><code>si-cli serve --reload 2&gt;&amp;1 | tee server.log\n</code></pre></p> <p>4. Monitor database: <pre><code>watch -n 2 'sqlite3 db/documents.db \"SELECT status, COUNT(*) FROM workflowrun GROUP BY status\"'\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#production-deployment","title":"Production Deployment","text":""},{"location":"ingester/GETTING_STARTED/#configuration_1","title":"Configuration","text":"<p>Create production <code>.env</code>:</p> <pre><code># Database\nDOC_DB_URL=postgresql+asyncpg://user:password@db-host:5432/soliplex\n\n# Services\nDOCLING_SERVER_URL=http://docling-prod:5001/v1\n\n# Logging\nLOG_LEVEL=WARNING\n\n# Performance\nINGEST_WORKER_CONCURRENCY=20\nDOCLING_CONCURRENCY=5\nWORKER_TASK_COUNT=10\n\n# Storage\nFILE_STORE_DIR=/var/lib/soliplex/files\nLANCEDB_DIR=/var/lib/soliplex/lancedb\n</code></pre>"},{"location":"ingester/GETTING_STARTED/#run-services","title":"Run Services","text":"<p>Server: <pre><code>si-cli serve --host 0.0.0.0 --port 8000 --workers 4\n</code></pre></p> <p>Workers: (in separate processes) <pre><code>si-cli worker  # Worker 1\nsi-cli worker  # Worker 2\nsi-cli worker  # Worker 3\n</code></pre></p> <p>Behind Nginx: <pre><code>upstream soliplex {\n    server 127.0.0.1:8000;\n}\n\nserver {\n    listen 80;\n    server_name soliplex.example.com;\n\n    location / {\n        proxy_pass http://soliplex;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n    }\n}\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#docker-deployment","title":"Docker Deployment","text":"<p>Dockerfile: <pre><code>FROM python:3.12-slim\n\nWORKDIR /app\nCOPY . .\nRUN pip install -e .\n\nCMD [\"si-cli\", \"serve\", \"--host\", \"0.0.0.0\"]\n</code></pre></p> <p>docker-compose.yml: <pre><code>version: '3.8'\n\nservices:\n  server:\n    build: .\n    ports:\n      - \"8000:8000\"\n    environment:\n      DOC_DB_URL: postgresql+asyncpg://postgres:password@db/soliplex\n      DOCLING_SERVER_URL: http://docling:5001/v1\n    depends_on:\n      - db\n\n  worker:\n    build: .\n    command: si-cli worker\n    environment:\n      DOC_DB_URL: postgresql+asyncpg://postgres:password@db/soliplex\n      DOCLING_SERVER_URL: http://docling:5001/v1\n    depends_on:\n      - db\n    deploy:\n      replicas: 3\n\n  db:\n    image: postgres:16\n    environment:\n      POSTGRES_DB: soliplex\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: password\n    volumes:\n      - db-data:/var/lib/postgresql/data\n\nvolumes:\n  db-data:\n</code></pre></p> <p>Run: <pre><code>docker-compose up -d\n</code></pre></p>"},{"location":"ingester/GETTING_STARTED/#learning-more","title":"Learning More","text":""},{"location":"ingester/GETTING_STARTED/#documentation","title":"Documentation","text":"<ul> <li>Architecture Overview - System design and components</li> <li>API Reference - Complete REST API documentation</li> <li>Workflow System - Workflow concepts and configuration</li> <li>Database Schema - Data models and relationships</li> <li>Configuration - Environment variables and settings</li> <li>CLI Reference - Command-line interface guide</li> </ul>"},{"location":"ingester/GETTING_STARTED/#examples","title":"Examples","text":"<p>Check the <code>examples/</code> directory (if available) for: - Sample workflows - Integration scripts - Custom step handlers - Batch processing examples</p>"},{"location":"ingester/GETTING_STARTED/#community","title":"Community","text":"<ul> <li>Issues: Report bugs and request features</li> <li>Discussions: Ask questions and share ideas</li> <li>Contributing: See CONTRIBUTING.md (if available)</li> </ul>"},{"location":"ingester/GETTING_STARTED/#common-patterns","title":"Common Patterns","text":""},{"location":"ingester/GETTING_STARTED/#batch-document-ingestion","title":"Batch Document Ingestion","text":"<pre><code>import asyncio\nfrom pathlib import Path\nimport httpx\n\nasync def ingest_directory(directory: Path, batch_id: int, source: str):\n    \"\"\"Ingest all documents in a directory.\"\"\"\n    async with httpx.AsyncClient() as client:\n        for file_path in directory.glob(\"**/*.pdf\"):\n            with open(file_path, \"rb\") as f:\n                files = {\"file\": f}\n                data = {\n                    \"source_uri\": str(file_path),\n                    \"source\": source,\n                    \"batch_id\": batch_id,\n                }\n                response = await client.post(\n                    \"http://localhost:8000/api/v1/document/ingest-document\",\n                    files=files,\n                    data=data,\n                )\n                print(f\"Ingested {file_path}: {response.status_code}\")\n\n# Usage\nasyncio.run(ingest_directory(Path(\"/documents\"), batch_id=1, source=\"filesystem\"))\n</code></pre>"},{"location":"ingester/GETTING_STARTED/#monitor-batch-progress","title":"Monitor Batch Progress","text":"<pre><code>import asyncio\nimport httpx\n\nasync def wait_for_batch(batch_id: int, poll_interval: int = 5):\n    \"\"\"Wait for batch processing to complete.\"\"\"\n    async with httpx.AsyncClient() as client:\n        while True:\n            response = await client.get(\n                f\"http://localhost:8000/api/v1/batch/status\",\n                params={\"batch_id\": batch_id}\n            )\n            data = response.json()\n            counts = data[\"workflow_count\"]\n\n            print(f\"Completed: {counts.get('COMPLETED', 0)}, \"\n                  f\"Running: {counts.get('RUNNING', 0)}, \"\n                  f\"Failed: {counts.get('FAILED', 0)}\")\n\n            if counts.get(\"RUNNING\", 0) == 0 and counts.get(\"PENDING\", 0) == 0:\n                print(\"Batch complete!\")\n                break\n\n            await asyncio.sleep(poll_interval)\n\n# Usage\nasyncio.run(wait_for_batch(1))\n</code></pre>"},{"location":"ingester/GETTING_STARTED/#retry-failed-workflows","title":"Retry Failed Workflows","text":"<pre><code>#!/bin/bash\n# retry_failed.sh\n\nBATCH_ID=$1\nRUN_GROUP=$(curl -s \"http://localhost:8000/api/v1/workflow/run-groups?batch_id=${BATCH_ID}\" | jq -r '.[0].id')\n\nif [ -n \"$RUN_GROUP\" ]; then\n    curl -X POST \"http://localhost:8000/api/v1/workflow/retry\" \\\n        -d \"run_group_id=${RUN_GROUP}\"\n    echo \"Retried run group ${RUN_GROUP}\"\nelse\n    echo \"No run group found for batch ${BATCH_ID}\"\nfi\n</code></pre>"},{"location":"ingester/GETTING_STARTED/#whats-next","title":"What's Next?","text":"<p>Now that you have Soliplex Ingester running:</p> <ol> <li>Customize workflows - Create workflows for your specific needs</li> <li>Integrate services - Connect your data sources and RAG backends</li> <li>Scale processing - Add more workers and optimize configuration</li> <li>Monitor production - Set up logging, metrics, and alerting</li> <li>Build applications - Use the API to build document processing apps</li> </ol> <p>Welcome to Soliplex Ingester! \ud83d\ude80</p>"},{"location":"ingester/WORKFLOWS/","title":"Workflow System Documentation","text":""},{"location":"ingester/WORKFLOWS/#overview","title":"Overview","text":"<p>The Soliplex Ingester workflow system orchestrates multi-step document processing pipelines. Each document flows through a series of configurable steps, with automatic retry logic, status tracking, and parallel processing support.</p>"},{"location":"ingester/WORKFLOWS/#core-concepts","title":"Core Concepts","text":""},{"location":"ingester/WORKFLOWS/#workflow-definition","title":"Workflow Definition","text":"<p>A WorkflowDefinition specifies the processing pipeline for documents. It defines: - Unique ID and name - Item steps (processing stages) - Lifecycle event handlers - Retry policies</p> <p>Defined in YAML files at: <code>config/workflows/*.yaml</code></p>"},{"location":"ingester/WORKFLOWS/#workflow-run","title":"Workflow Run","text":"<p>A WorkflowRun represents a single execution of a workflow for one document. It tracks: - Status (PENDING \u2192 RUNNING \u2192 COMPLETED/FAILED) - Start and completion timestamps - Priority level - Associated document and batch</p>"},{"location":"ingester/WORKFLOWS/#run-group","title":"Run Group","text":"<p>A RunGroup aggregates multiple workflow runs that were started together (e.g., all documents in a batch). It provides: - Group-level status tracking - Aggregate statistics - Batch coordination</p>"},{"location":"ingester/WORKFLOWS/#run-step","title":"Run Step","text":"<p>A RunStep is one stage of execution within a workflow run. Each step: - Executes a specific handler method - Has its own status and retry counter - Produces artifacts stored in the file system - Updates database on completion/failure</p>"},{"location":"ingester/WORKFLOWS/#workflow-step-types","title":"Workflow Step Types","text":"<p>The system supports these predefined step types:</p>"},{"location":"ingester/WORKFLOWS/#ingest","title":"INGEST","text":"<ul> <li>Purpose: Load raw document into the system</li> <li>Input: File bytes or URI</li> <li>Output: Document stored in file system</li> <li>Artifact: <code>ArtifactType.DOC</code></li> </ul>"},{"location":"ingester/WORKFLOWS/#validate","title":"VALIDATE","text":"<ul> <li>Purpose: Check document format and readability</li> <li>Input: Raw document</li> <li>Output: Validation result</li> <li>Handler: <code>soliplex_ingester.lib.workflow.validate_document</code></li> </ul>"},{"location":"ingester/WORKFLOWS/#parse","title":"PARSE","text":"<ul> <li>Purpose: Extract text, structure, and metadata</li> <li>Input: Raw document</li> <li>Output: Markdown and JSON representations</li> <li>Artifacts: <code>ArtifactType.PARSED_MD</code>, <code>ArtifactType.PARSED_JSON</code></li> <li>Handler: <code>soliplex_ingester.lib.workflow.parse_document</code></li> <li>Service: Docling server</li> </ul>"},{"location":"ingester/WORKFLOWS/#chunk","title":"CHUNK","text":"<ul> <li>Purpose: Split document into semantic chunks</li> <li>Input: Parsed markdown</li> <li>Output: Array of text chunks</li> <li>Artifact: <code>ArtifactType.CHUNKS</code></li> <li>Handler: <code>soliplex_ingester.lib.workflow.chunk_document</code></li> </ul>"},{"location":"ingester/WORKFLOWS/#embed","title":"EMBED","text":"<ul> <li>Purpose: Generate vector embeddings for chunks</li> <li>Input: Text chunks</li> <li>Output: Embedding vectors</li> <li>Artifact: <code>ArtifactType.EMBEDDINGS</code></li> <li>Handler: <code>soliplex_ingester.lib.workflow.embed_document</code></li> </ul>"},{"location":"ingester/WORKFLOWS/#store","title":"STORE","text":"<ul> <li>Purpose: Save embeddings to RAG system</li> <li>Input: Embeddings</li> <li>Output: RAG document ID</li> <li>Artifact: <code>ArtifactType.RAG</code></li> <li>Handler: <code>soliplex_ingester.lib.workflow.save_to_rag</code></li> <li>Backend: LanceDB + HaikuRAG</li> </ul>"},{"location":"ingester/WORKFLOWS/#enrich","title":"ENRICH","text":"<ul> <li>Purpose: Add metadata or perform additional processing</li> <li>Input: Document and existing artifacts</li> <li>Output: Enhanced metadata</li> <li>Handler: Custom (user-defined)</li> </ul>"},{"location":"ingester/WORKFLOWS/#route","title":"ROUTE","text":"<ul> <li>Purpose: Conditional logic for workflow branching</li> <li>Input: Document state</li> <li>Output: Routing decision</li> <li>Handler: Custom (user-defined)</li> </ul>"},{"location":"ingester/WORKFLOWS/#workflow-configuration","title":"Workflow Configuration","text":""},{"location":"ingester/WORKFLOWS/#workflow-definition-yaml","title":"Workflow Definition YAML","text":"<p>Example: <code>config/workflows/batch.yaml</code></p> <pre><code>id: batch\nname: Batch Workflow\nmeta: {}\n\nitem_steps:\n  validate:\n    name: docling validate\n    retries: 3\n    method: soliplex_ingester.lib.workflow.validate_document\n    parameters: {}\n\n  parse:\n    name: docling parse\n    retries: 3\n    method: soliplex_ingester.lib.workflow.parse_document\n    parameters: {}\n\n  chunk:\n    name: docling chunk\n    retries: 3\n    method: soliplex_ingester.lib.workflow.chunk_document\n    parameters: {}\n\n  embed:\n    name: embeddings\n    retries: 3\n    method: soliplex_ingester.lib.workflow.embed_document\n    parameters: {}\n\n  store:\n    name: save to rag\n    retries: 3\n    method: soliplex_ingester.lib.workflow.save_to_rag\n    parameters: {}\n\nlifecycle_events:\n  group_start:\n    - name: log group start\n      method: soliplex_ingester.lib.workflow.log_event\n      retries: 1\n      parameters:\n        message: \"Starting workflow group\"\n</code></pre>"},{"location":"ingester/WORKFLOWS/#parameter-set-yaml","title":"Parameter Set YAML","text":"<p>Parameters control step behavior without changing the workflow definition.</p> <p>Example: <code>config/params/default.yaml</code></p> <pre><code>id: default\nname: Default Parameters\nmeta:\n  description: Standard processing parameters\n\nconfig:\n  parse:\n    format: markdown\n    ocr_enabled: true\n\n  chunk:\n    chunk_size: 512\n    chunk_overlap: 50\n    separator: \"\\n\\n\"\n\n  embed:\n    model: text-embedding-3-small\n    batch_size: 1000\n\n  store:\n    data_dir: lancedb\n    collection_name: documents\n</code></pre>"},{"location":"ingester/WORKFLOWS/#workflow-execution","title":"Workflow Execution","text":""},{"location":"ingester/WORKFLOWS/#creating-workflows","title":"Creating Workflows","text":"<p>For a Batch: <pre><code>curl -X POST \"http://localhost:8000/api/v1/batch/start-workflows\" \\\n  -d \"batch_id=1\" \\\n  -d \"workflow_definition_id=batch\" \\\n  -d \"param_id=default\"\n</code></pre></p> <p>For a Single Document: <pre><code>curl -X POST \"http://localhost:8000/api/v1/workflow/\" \\\n  -d \"doc_id=sha256-abc123...\" \\\n  -d \"workflow_definition_id=batch\"\n</code></pre></p>"},{"location":"ingester/WORKFLOWS/#worker-processing","title":"Worker Processing","text":"<p>Workers continuously poll for pending steps:</p> <ol> <li>Query database for PENDING steps with highest priority</li> <li>Lock step with <code>FOR UPDATE</code> to prevent duplicate processing</li> <li>Transition status: PENDING \u2192 RUNNING</li> <li>Execute handler method</li> <li>Store artifacts in file system</li> <li>Update step status: RUNNING \u2192 COMPLETED/ERROR</li> <li>Update parent run status based on step results</li> <li>Repeat</li> </ol> <p>Start a worker: <pre><code>si-cli worker\n</code></pre></p> <p>Or via server (starts worker automatically): <pre><code>si-cli serve\n</code></pre></p>"},{"location":"ingester/WORKFLOWS/#status-transitions","title":"Status Transitions","text":"<p>Valid Transitions: - PENDING \u2192 RUNNING - RUNNING \u2192 COMPLETED - RUNNING \u2192 ERROR - ERROR \u2192 RUNNING (retry) - ERROR \u2192 FAILED (after max retries)</p> <p>Invalid Transitions: - COMPLETED \u2192 RUNNING (no re-running completed steps) - FAILED \u2192 RUNNING (use retry endpoint instead)</p>"},{"location":"ingester/WORKFLOWS/#lifecycle-events","title":"Lifecycle Events","text":"<p>Lifecycle events allow custom logic at key points:</p>"},{"location":"ingester/WORKFLOWS/#event-types","title":"Event Types","text":"<ul> <li><code>GROUP_START</code> - Run group begins</li> <li><code>GROUP_END</code> - Run group completes</li> <li><code>ITEM_START</code> - Workflow run begins</li> <li><code>ITEM_END</code> - Workflow run completes</li> <li><code>ITEM_FAILED</code> - Workflow run fails</li> <li><code>STEP_START</code> - Step begins</li> <li><code>STEP_END</code> - Step completes</li> <li><code>STEP_FAILED</code> - Step fails</li> </ul>"},{"location":"ingester/WORKFLOWS/#event-handler-example","title":"Event Handler Example","text":"<pre><code>lifecycle_events:\n  item_failed:\n    - name: notify on failure\n      method: myapp.notifications.send_alert\n      retries: 3\n      parameters:\n        channel: \"#alerts\"\n        message: \"Document processing failed\"\n</code></pre>"},{"location":"ingester/WORKFLOWS/#retry-logic","title":"Retry Logic","text":""},{"location":"ingester/WORKFLOWS/#automatic-retries","title":"Automatic Retries","text":"<p>Steps automatically retry on error: - Configurable retry count per step - Exponential backoff (implementation dependent) - Status: ERROR during retries, FAILED when exhausted</p>"},{"location":"ingester/WORKFLOWS/#manual-retry","title":"Manual Retry","text":"<p>Reset failed steps for a run group: <pre><code>curl -X POST \"http://localhost:8000/api/v1/workflow/retry\" \\\n  -d \"run_group_id=5\"\n</code></pre></p> <p>This resets all FAILED steps to PENDING for re-processing.</p>"},{"location":"ingester/WORKFLOWS/#monitoring","title":"Monitoring","text":""},{"location":"ingester/WORKFLOWS/#check-run-group-status","title":"Check Run Group Status","text":"<pre><code>curl \"http://localhost:8000/api/v1/workflow/run-groups/5/stats\"\n</code></pre> <p>Returns: <pre><code>{\n  \"total_runs\": 100,\n  \"completed\": 95,\n  \"running\": 3,\n  \"pending\": 0,\n  \"failed\": 2,\n  \"average_duration\": 45.3,\n  \"group_status\": \"RUNNING\"\n}\n</code></pre></p>"},{"location":"ingester/WORKFLOWS/#check-specific-workflow-run","title":"Check Specific Workflow Run","text":"<pre><code>curl \"http://localhost:8000/api/v1/workflow/runs/42\"\n</code></pre> <p>Returns workflow run with all steps and their status.</p>"},{"location":"ingester/WORKFLOWS/#query-steps-by-status","title":"Query Steps by Status","text":"<pre><code>curl \"http://localhost:8000/api/v1/workflow/steps?status=FAILED\"\n</code></pre> <p>Lists all failed steps for investigation.</p>"},{"location":"ingester/WORKFLOWS/#custom-step-handlers","title":"Custom Step Handlers","text":""},{"location":"ingester/WORKFLOWS/#handler-signature","title":"Handler Signature","text":"<pre><code>async def custom_handler(\n    run_step: RunStep,\n    workflow_run: WorkflowRun,\n    doc: Document,\n    step_params: dict[str, Any]\n) -&gt; dict[str, Any]:\n    \"\"\"\n    Custom workflow step handler.\n\n    Args:\n        run_step: Current step being executed\n        workflow_run: Parent workflow run\n        doc: Document being processed\n        step_params: Parameters from config\n\n    Returns:\n        Dictionary with result metadata\n\n    Raises:\n        Exception: On failure (will trigger retry)\n    \"\"\"\n    # Your processing logic here\n    result_data = await process_document(doc)\n\n    # Store artifacts if needed\n    await store_artifact(\n        doc.hash,\n        ArtifactType.CUSTOM,\n        result_data\n    )\n\n    return {\"status\": \"success\", \"items_processed\": 42}\n</code></pre>"},{"location":"ingester/WORKFLOWS/#registering-custom-handler","title":"Registering Custom Handler","text":"<ol> <li>Define the handler in your Python module</li> <li>Add to workflow YAML: <pre><code>item_steps:\n  custom_step:\n    name: My Custom Step\n    retries: 2\n    method: myapp.handlers.custom_handler\n    parameters:\n      param1: value1\n</code></pre></li> <li>Ensure module is importable by the worker process</li> </ol>"},{"location":"ingester/WORKFLOWS/#worker-configuration","title":"Worker Configuration","text":""},{"location":"ingester/WORKFLOWS/#environment-variables","title":"Environment Variables","text":"<ul> <li><code>INGEST_WORKER_CONCURRENCY</code> - Max concurrent workflow steps (default: 10)</li> <li><code>INGEST_QUEUE_CONCURRENCY</code> - Max concurrent queue operations (default: 20)</li> <li><code>DOCLING_CONCURRENCY</code> - Max concurrent Docling requests (default: 3)</li> <li><code>WORKER_TASK_COUNT</code> - Steps to fetch per query (default: 5)</li> <li><code>WORKER_CHECKIN_INTERVAL</code> - Heartbeat interval in seconds (default: 120)</li> <li><code>WORKER_CHECKIN_TIMEOUT</code> - Worker timeout in seconds (default: 600)</li> </ul>"},{"location":"ingester/WORKFLOWS/#multiple-workers","title":"Multiple Workers","text":"<p>Run multiple workers for increased throughput:</p> <pre><code># Terminal 1\nsi-cli worker\n\n# Terminal 2\nsi-cli worker\n\n# Terminal 3\nsi-cli worker\n</code></pre> <p>Database locking ensures no duplicate processing.</p>"},{"location":"ingester/WORKFLOWS/#artifact-storage","title":"Artifact Storage","text":""},{"location":"ingester/WORKFLOWS/#storage-paths","title":"Storage Paths","text":"<p>Artifacts are stored under <code>FILE_STORE_DIR</code> with subdirectories:</p> <ul> <li><code>document_store_dir/</code> - Raw documents</li> <li><code>parsed_markdown_store_dir/</code> - Parsed markdown</li> <li><code>parsed_json_store_dir/</code> - Parsed JSON</li> <li><code>chunks_store_dir/</code> - Text chunks</li> <li><code>embeddings_store_dir/</code> - Embedding vectors</li> </ul>"},{"location":"ingester/WORKFLOWS/#file-naming","title":"File Naming","text":"<p>Files are named by document hash: <pre><code>{storage_dir}/{hash}\n</code></pre></p> <p>Example: <pre><code>file_store/markdown/sha256-abc123def456...\n</code></pre></p>"},{"location":"ingester/WORKFLOWS/#storage-backends","title":"Storage Backends","text":"<p>Configure via <code>FILE_STORE_TARGET</code>: - <code>fs</code> - Local filesystem (default) - <code>s3</code> - S3-compatible storage (via OpenDAL) - Other OpenDAL-supported backends</p>"},{"location":"ingester/WORKFLOWS/#best-practices","title":"Best Practices","text":""},{"location":"ingester/WORKFLOWS/#workflow-design","title":"Workflow Design","text":"<ol> <li>Keep steps atomic - Each step should do one thing well</li> <li>Make steps idempotent - Re-running a step should be safe</li> <li>Use appropriate retries - 3 retries for transient errors, 1 for validation</li> <li>Store intermediate results - Save artifacts for debugging and recovery</li> </ol>"},{"location":"ingester/WORKFLOWS/#error-handling","title":"Error Handling","text":"<ol> <li>Raise exceptions for retriable errors</li> <li>Log context before raising (worker ID, document hash, step)</li> <li>Use status_meta to store error details</li> <li>Monitor failed steps and investigate patterns</li> </ol>"},{"location":"ingester/WORKFLOWS/#performance","title":"Performance","text":"<ol> <li>Tune concurrency based on available resources</li> <li>Batch operations where possible (embeddings)</li> <li>Use priorities for urgent documents</li> <li>Monitor worker health via heartbeat table</li> </ol>"},{"location":"ingester/WORKFLOWS/#testing","title":"Testing","text":"<ol> <li>Test handlers independently with mock data</li> <li>Use small batches for integration testing</li> <li>Verify artifact storage after each step</li> <li>Test retry logic by simulating failures</li> </ol>"},{"location":"ingester/WORKFLOWS/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ingester/WORKFLOWS/#stuck-workflows","title":"Stuck Workflows","text":"<p>Symptom: Workflows remain in RUNNING status indefinitely</p> <p>Solution: 1. Check worker logs for exceptions 2. Query stuck steps: <code>SELECT * FROM runstep WHERE status='RUNNING' AND start_date &lt; NOW() - INTERVAL '1 hour'</code> 3. Check worker heartbeat: <code>SELECT * FROM workercheckin</code> 4. Restart workers if stale</p>"},{"location":"ingester/WORKFLOWS/#failed-steps","title":"Failed Steps","text":"<p>Symptom: Steps transition to FAILED status</p> <p>Solution: 1. Query step details: <code>GET /api/v1/workflow/steps?status=FAILED</code> 2. Check <code>status_message</code> and <code>status_meta</code> for error info 3. Fix underlying issue (service down, invalid config, etc.) 4. Retry: <code>POST /api/v1/workflow/retry</code></p>"},{"location":"ingester/WORKFLOWS/#slow-processing","title":"Slow Processing","text":"<p>Symptom: Low throughput, long durations</p> <p>Solution: 1. Check Docling server response time 2. Increase <code>INGEST_WORKER_CONCURRENCY</code> 3. Run multiple workers 4. Verify database performance (add indexes if needed) 5. Check network latency to external services</p>"},{"location":"ingester/WORKFLOWS/#duplicate-processing","title":"Duplicate Processing","text":"<p>Symptom: Same document processed multiple times</p> <p>Solution: 1. Verify database locking is working (<code>FOR UPDATE</code>) 2. Check for unique constraint violations in logs 3. Ensure workers use distinct worker IDs 4. Verify step status transitions are atomic</p>"},{"location":"ingester-agents/","title":"Soliplex Agents","text":"<p>Agents for ingesting documents into the Soliplex Ingester system. This package provides tools to collect, validate, and ingest documents from multiple sources including local filesystems, and source code management platforms (GitHub, Gitea).</p>"},{"location":"ingester-agents/#features","title":"Features","text":"<ul> <li>Filesystem Agent (<code>fs</code>): Ingest documents from local directories</li> <li>Recursive directory scanning</li> <li>Automatic SHA256 hash calculation</li> <li>MIME type detection</li> <li>Configuration validation</li> <li> <p>Status checking to avoid re-ingesting unchanged files</p> </li> <li> <p>SCM Agent (<code>scm</code>): Ingest files and issues from Git repositories</p> </li> <li>Support for GitHub and Gitea platforms</li> <li>Automatic file type filtering</li> <li>Issue ingestion with comments (rendered as Markdown)</li> <li>Batch processing with workflow support</li> <li> <p>Status checking to avoid re-ingesting unchanged files</p> </li> <li> <p>REST API Server: Run agents as a web service</p> </li> <li>FastAPI-based HTTP endpoints for all operations</li> <li>Multiple authentication methods (API key, OAuth2 proxy)</li> <li>Interactive API documentation with Swagger UI</li> <li>Health check endpoint for monitoring</li> <li>Container-ready with Docker support</li> </ul>"},{"location":"ingester-agents/#installation","title":"Installation","text":"<p>Requirements: - Python 3.13 or higher - Soliplex Ingester running and accessible</p> <p>Before using these tools, a working version of Soliplex Ingester must be available. The URL will need to be configured in the environment variables to function.</p>"},{"location":"ingester-agents/#using-uv-recommended","title":"Using uv (Recommended)","text":"<pre><code>uv add soliplex.agents\n</code></pre>"},{"location":"ingester-agents/#using-pip","title":"Using pip","text":"<pre><code>pip install soliplex.agents\n</code></pre>"},{"location":"ingester-agents/#from-source","title":"From Source","text":"<pre><code>git clone &lt;repository-url&gt;\ncd ingester-agents\nuv sync\n</code></pre>"},{"location":"ingester-agents/#configuration","title":"Configuration","text":"<p>The agents use environment variables for configuration. Create a <code>.env</code> file or export these variables:</p>"},{"location":"ingester-agents/#required-configuration","title":"Required Configuration","text":"<pre><code># Soliplex Ingester API endpoint\nENDPOINT_URL=http://localhost:8000/api/v1\n\n# Ingester API authentication (for connecting to protected Ingester instances)\nINGESTER_API_KEY=your-ingester-api-key\n\n# GitHub Configuration - if needed\nGH_TOKEN=your_github_token_here\nGH_OWNER=your_github_username_or_org\n\n# Gitea Configuration - if needed\nGITEA_URL=https://your-gitea-instance.com\nGITEA_TOKEN=your_gitea_token_here\nGITEA_OWNER=admin\n</code></pre>"},{"location":"ingester-agents/#optional-configuration","title":"Optional Configuration","text":"<pre><code># File extensions to include (default: md,pdf,doc,docx)\nEXTENSIONS=md,pdf,doc,docx\n\n# Logging level (default: INFO)\nLOG_LEVEL=INFO\n\n# API Server Configuration\nSERVER_HOST=127.0.0.1\nSERVER_PORT=8001\n\n# Authentication (for API server)\nAPI_KEY=your-secret-key-here\nAPI_KEY_ENABLED=false\nAUTH_TRUST_PROXY_HEADERS=false\n</code></pre>"},{"location":"ingester-agents/#usage","title":"Usage","text":"<p>The CLI tool <code>si-agent</code> provides three main modes of operation: - <code>fs</code>: Filesystem agent for ingesting local documents - <code>scm</code>: SCM agent for ingesting from Git repositories - <code>serve</code>: REST API server exposing agent functionality via HTTP</p>"},{"location":"ingester-agents/#filesystem-agent","title":"Filesystem Agent","text":""},{"location":"ingester-agents/#1-build-configuration","title":"1. Build Configuration","text":"<p>Scan a directory and create an inventory file:</p> <pre><code>si-agent fs build-config /path/to/documents\n</code></pre> <p>This creates an <code>inventory.json</code> file containing metadata for all discovered files. This file can be modified with additional metadata if desired.</p>"},{"location":"ingester-agents/#2-validate-configuration","title":"2. Validate Configuration","text":"<p>Check if files in the inventory are supported:</p> <pre><code>si-agent fs validate-config /path/to/inventory.json\n</code></pre>"},{"location":"ingester-agents/#3-check-status","title":"3. Check Status","text":"<p>See which files need to be ingested:</p> <pre><code>si-agent fs check-status /path/to/inventory.json my-source-name\n</code></pre> <p>Add <code>--detail</code> flag to see the full list of files:</p> <pre><code>si-agent fs check-status /path/to/inventory.json my-source-name --detail\n</code></pre> <p>The status check compares file hashes against the Ingester database: - new: File doesn't exist in the database - mismatch: File exists but content has changed - match: File is unchanged (will be skipped during ingestion)</p>"},{"location":"ingester-agents/#4-load-inventory","title":"4. Load Inventory","text":"<p>Ingest documents from an inventory:</p> <pre><code>si-agent fs run-inventory /path/to/inventory.json my-source-name\n</code></pre> <p>Advanced options:</p> <pre><code># Process a subset of files (e.g., files 10-50)\nsi-agent fs run-inventory inventory.json my-source --start 10 --end 50\n\n# Resume a previous batch\nsi-agent fs run-inventory inventory.json my-source --resume-batch 123\n\n# Start workflows after ingestion\nsi-agent fs run-inventory inventory.json my-source \\\n  --start-workflows \\\n  --workflow-definition-id my-workflow \\\n  --param-set-id my-params \\\n  --priority 10\n</code></pre> <p>You can also pass a directory path directly (it will build the config automatically):</p> <pre><code>si-agent fs run-inventory /path/to/documents my-source-name\n</code></pre>"},{"location":"ingester-agents/#scm-agent","title":"SCM Agent","text":""},{"location":"ingester-agents/#1-list-issues","title":"1. List Issues","text":"<p>List all issues from a repository:</p> <pre><code># GitHub\nsi-agent scm list-issues github my-repo my-github-user\n\n# Gitea\nsi-agent scm list-issues gitea my-repo --owner admin\n</code></pre>"},{"location":"ingester-agents/#2-get-repository-files","title":"2. Get Repository Files","text":"<p>List files in a repository:</p> <pre><code># GitHub\nsi-agent scm get-repo github my-repo my-github-user\n\n# Gitea\nsi-agent scm get-repo gitea my-repo\n</code></pre>"},{"location":"ingester-agents/#3-load-inventory","title":"3. Load Inventory","text":"<p>Ingest both files and issues from a repository. Issues are rendered as Markdown documents with their comments.</p> <pre><code># GitHub\nsi-agent scm run-inventory github my-repo my-github-user\n\n# Gitea\nsi-agent scm run-inventory gitea my-repo admin\n</code></pre> <p>Note on Workflows: By default, <code>start_workflows=True</code>. To skip workflow triggering, explicitly set <code>--no-start-workflows</code>.</p>"},{"location":"ingester-agents/#how-it-works","title":"How It Works","text":""},{"location":"ingester-agents/#document-ingestion-flow","title":"Document Ingestion Flow","text":"<ol> <li>Discovery: Files are discovered from the source (filesystem or SCM)</li> <li>Hashing: Each file's hash is calculated</li> <li>Filesystem sources: SHA256 hash</li> <li>SCM sources: SHA3-256 hash for files, SHA256 for issues</li> <li>Status Check: The system checks which files have changed or are new against the ingester database</li> <li>Batch Management:</li> <li>The system searches for an existing batch matching the source name</li> <li>If found, new documents are added to the existing batch (incremental ingestion)</li> <li>If not found, a new batch is created</li> <li>This enables efficient re-ingestion: only new or changed files are processed</li> <li>Ingestion: Files are uploaded to the Soliplex Ingester API</li> <li>Workflow Trigger (optional): Workflows can be started to process the ingested documents. See Ingester documentation for details.</li> </ol>"},{"location":"ingester-agents/#file-filtering","title":"File Filtering","text":"<p>Both agents filter files by the <code>EXTENSIONS</code> configuration. The default extensions are: <code>md</code>, <code>pdf</code>, <code>doc</code>, <code>docx</code>.</p> <p>To add more types: <pre><code>export EXTENSIONS=md,pdf,doc,docx,txt,rst\n</code></pre></p> <p>It also validates that files have supported content types and rejects: - ZIP archives - RAR archives - 7z archives - Generic binary files without proper MIME types</p>"},{"location":"ingester-agents/#scm-agent_1","title":"SCM Agent","text":"<p>The SCM agent only includes files with extensions specified in the <code>EXTENSIONS</code> configuration (default: <code>md</code>, <code>pdf</code>, <code>doc</code>, <code>docx</code>).</p>"},{"location":"ingester-agents/#issues-as-documents","title":"Issues as Documents","text":"<p>For SCM sources, issues (including their comments) are rendered as Markdown documents and ingested alongside repository files. This enables full-text search and analysis of issue discussions.</p>"},{"location":"ingester-agents/#examples","title":"Examples","text":"<p>As an example, the soliplex documentation) can be loaded using both the filesystem and via git.</p>"},{"location":"ingester-agents/#example-1-ingest-local-documents","title":"Example 1: Ingest Local Documents","text":"<pre><code>git clone https://github.com/soliplex/soliplex.git\n\n\n# Set up environment, check ingester configuration for details\nexport ENDPOINT_URL=http://localhost:8000/api/v1\n\n# Create inventory and ingest\nuv run  si-agent fs build-config &lt;path-to-checkout&gt;soliplex/docs\n#you may see messages about ignored files\n\n#if you want to update the inventory.json file, do it here\n\nuv run  si-agent fs validate-config &lt;path-to-checkout&gt;soliplex/docs/inventory.json\n#if there are errors, fix them now\n\nuv run  si-agent fs run-inventory &lt;path-to-checkout&gt;soliplex/docs soliplex-docs\n\n#check that documents are in the ingester: (your batch id may be different)\ncurl -X 'GET' \\\n  'http://127.0.0.1:8000/api/v1/document/?batch_id=1' \\\n  -H 'accept: application/json'\n</code></pre>"},{"location":"ingester-agents/#example-2-ingest-github-repository","title":"Example 2: Ingest GitHub Repository","text":"<pre><code># Set up environment\nexport ENDPOINT_URL=http://localhost:8000/api/v1\nexport GH_TOKEN=ghp_your_token_here\nexport GH_OWNER=mycompany\n\n# Ingest repository\nsi-agent scm run-inventory github soliplex soliplex\n\n#check that documents are in the ingester: (your batch id may be different)\ncurl -X 'GET' \\\n  'http://127.0.0.1:8000/api/v1/document/?batch_id=2' \\\n  -H 'accept: application/json'\n</code></pre>"},{"location":"ingester-agents/#example-3-batch-processing-with-workflows","title":"Example 3: Batch Processing with Workflows","text":"<pre><code># Ingest and trigger processing workflows\nsi-agent fs run-inventory ./documents my-docs \\\n  --start-workflows \\\n  --workflow-definition-id document-analysis \\\n  --priority 5\n</code></pre>"},{"location":"ingester-agents/#server-api","title":"Server API","text":"<p>The agents can be run as a REST API server using FastAPI. This exposes all agent operations as HTTP endpoints with support for authentication and interactive documentation.</p>"},{"location":"ingester-agents/#starting-the-server","title":"Starting the Server","text":"<pre><code># Basic\nsi-agent serve\n\n# Custom host and port\nsi-agent serve --host 0.0.0.0 --port 8080\n\n# Development mode with auto-reload\nsi-agent serve --reload\n\n# Production with multiple workers\nsi-agent serve --workers 4\n</code></pre>"},{"location":"ingester-agents/#authentication","title":"Authentication","text":"<p>The server supports multiple authentication methods:</p>"},{"location":"ingester-agents/#1-no-authentication-default","title":"1. No Authentication (Default)","text":"<pre><code>si-agent serve\n# All requests allowed\n</code></pre>"},{"location":"ingester-agents/#2-api-key-authentication","title":"2. API Key Authentication","text":"<pre><code>export API_KEY=your-secret-key\nexport API_KEY_ENABLED=true\nsi-agent serve\n</code></pre> <p>Clients must include the API key in the <code>Authorization</code> header: <pre><code>curl -H \"Authorization: Bearer your-secret-key\" http://localhost:8001/api/fs/status\n</code></pre></p>"},{"location":"ingester-agents/#3-oauth2-proxy-headers","title":"3. OAuth2 Proxy Headers","text":"<pre><code>export AUTH_TRUST_PROXY_HEADERS=true\nsi-agent serve\n</code></pre> <p>The server will trust authentication headers from a reverse proxy (e.g., OAuth2 Proxy): - <code>X-Auth-Request-User</code> - <code>X-Forwarded-User</code> - <code>X-Forwarded-Email</code></p>"},{"location":"ingester-agents/#api-endpoints","title":"API Endpoints","text":""},{"location":"ingester-agents/#filesystem-routes-apifs","title":"Filesystem Routes (<code>/api/fs/</code>)","text":"Method Endpoint Description <code>POST</code> <code>/api/fs/build-config</code> Build inventory from directory <code>POST</code> <code>/api/fs/validate-config</code> Validate inventory file <code>POST</code> <code>/api/fs/check-status</code> Check which files need ingestion <code>POST</code> <code>/api/fs/run-inventory</code> Ingest documents from inventory <p>Example: <pre><code>curl -X POST http://localhost:8001/api/fs/build-config \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"directory_path\": \"/path/to/docs\"}'\n</code></pre></p>"},{"location":"ingester-agents/#scm-routes-apiscm","title":"SCM Routes (<code>/api/scm/</code>)","text":"Method Endpoint Description <code>GET</code> <code>/api/scm/{platform}/{repo}/issues</code> List repository issues <code>GET</code> <code>/api/scm/{platform}/{repo}/files</code> List repository files <code>POST</code> <code>/api/scm/{platform}/{repo}/ingest</code> Ingest repo files and issues <p>Example: <pre><code># List GitHub issues\ncurl http://localhost:8001/api/scm/github/my-repo/issues?owner=myuser\n\n# Ingest repository\ncurl -X POST http://localhost:8001/api/scm/github/my-repo/ingest \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"owner\": \"myuser\", \"source\": \"my-source\"}'\n</code></pre></p>"},{"location":"ingester-agents/#health-check","title":"Health Check","text":"Method Endpoint Description <code>GET</code> <code>/health</code> Server health check <p>Example: <pre><code>curl http://localhost:8001/health\n# Returns: {\"status\": \"healthy\"}\n</code></pre></p>"},{"location":"ingester-agents/#api-documentation","title":"API Documentation","text":"<p>Interactive API documentation is available at: - Swagger UI: <code>http://localhost:8001/docs</code> - ReDoc: <code>http://localhost:8001/redoc</code> - OpenAPI JSON: <code>http://localhost:8001/openapi.json</code></p>"},{"location":"ingester-agents/#docker-deployment","title":"Docker Deployment","text":"<p>The server is designed to run in containers:</p> <pre><code># Build image\ndocker build -t ingester-agents:latest .\n\n# Run with environment variables\ndocker run -d \\\n  -p 8001:8000 \\\n  -e ENDPOINT_URL=http://ingester:8000/api/v1 \\\n  -e API_KEY_ENABLED=true \\\n  -e API_KEY=your-secret-key \\\n  ingester-agents:latest\n\n# Check health\ncurl http://localhost:8001/health\n</code></pre> <p>The Docker image includes: - Non-root user for security - Health checks for orchestration - Proper signal handling - Production-ready uvicorn configuration</p> <p>See DOCKERFILE_CHANGES.md for implementation details.</p>"},{"location":"ingester-agents/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ingester-agents/#authentication-errors","title":"Authentication Errors","text":"<p>Ensure your tokens have the required permissions: - GitHub: <code>repo</code> scope for private repositories, public access for public repos - Gitea: Access token with read permissions</p>"},{"location":"ingester-agents/#connection-errors","title":"Connection Errors","text":"<p>Verify the <code>ENDPOINT_URL</code> is correct and the Ingester API is running: <pre><code>curl http://localhost:8000/api/v1/batch/\n</code></pre></p>"},{"location":"ingester-agents/#file-not-found-errors","title":"File Not Found Errors","text":"<p>For SCM agents, ensure the repository name and owner are correct. Use the exact repository name, not the URL.</p>"},{"location":"ingester-agents/#development","title":"Development","text":""},{"location":"ingester-agents/#setup","title":"Setup","text":"<pre><code># Clone repository\ngit clone &lt;repository-url&gt;\ncd ingester-agents\n\n# Install dependencies with dev tools\nuv sync\n\n# Run tests\nuv run pytest\n\n# Run linter\nuv run ruff check\n</code></pre>"},{"location":"ingester-agents/#testing","title":"Testing","text":"<p>The project uses pytest with 100% code coverage requirements:</p> <pre><code># Run unit tests with coverage\nuv run pytest\n\n# Run specific tests\nuv run pytest tests/unit/test_client.py\n\n# Generate coverage report\nuv run pytest --cov-report=html\n</code></pre>"},{"location":"ingester-agents/#code-quality","title":"Code Quality","text":"<p>The project uses Ruff for linting and code formatting:</p> <pre><code># Check code\nuv run ruff check\n\n# Auto-fix issues\nuv run ruff check --fix\n\n# Format code\nuv run ruff format\n</code></pre>"},{"location":"ingester-agents/#architecture","title":"Architecture","text":"<pre><code>soliplex.agents/\n\u251c\u2500\u2500 src/soliplex/agents/\n\u2502   \u251c\u2500\u2500 cli.py              # Main CLI entry point (includes 'serve' command)\n\u2502   \u251c\u2500\u2500 client.py           # Soliplex Ingester API client\n\u2502   \u251c\u2500\u2500 config.py           # Configuration and settings\n\u2502   \u251c\u2500\u2500 server/             # FastAPI server\n\u2502   \u2502   \u251c\u2500\u2500 __init__.py     # FastAPI app initialization\n\u2502   \u2502   \u251c\u2500\u2500 auth.py         # Authentication (API key &amp; OAuth2 proxy)\n\u2502   \u2502   \u2514\u2500\u2500 routes/\n\u2502   \u2502       \u251c\u2500\u2500 __init__.py\n\u2502   \u2502       \u251c\u2500\u2500 fs.py       # Filesystem API endpoints\n\u2502   \u2502       \u2514\u2500\u2500 scm.py      # SCM API endpoints\n\u2502   \u251c\u2500\u2500 fs/                 # Filesystem agent\n\u2502   \u2502   \u251c\u2500\u2500 app.py          # Core filesystem logic\n\u2502   \u2502   \u2514\u2500\u2500 cli.py          # Filesystem CLI commands\n\u2502   \u2514\u2500\u2500 scm/                # SCM agent\n\u2502       \u251c\u2500\u2500 app.py          # Core SCM logic\n\u2502       \u251c\u2500\u2500 cli.py          # SCM CLI commands\n\u2502       \u251c\u2500\u2500 base.py         # Base SCM provider interface\n\u2502       \u251c\u2500\u2500 github/         # GitHub implementation\n\u2502       \u251c\u2500\u2500 gitea/          # Gitea implementation\n\u2502       \u2514\u2500\u2500 lib/\n\u2502           \u251c\u2500\u2500 templates/  # Issue rendering templates\n\u2502           \u2514\u2500\u2500 utils.py    # Utility functions\n\u251c\u2500\u2500 tests/                  # Test suite\n\u2502   \u2514\u2500\u2500 unit/\n\u2502       \u251c\u2500\u2500 test_server_*.py  # Server API tests\n\u2502       \u2514\u2500\u2500 ...\n\u251c\u2500\u2500 Dockerfile              # Production container\n\u251c\u2500\u2500 .dockerignore           # Build context exclusions\n\u2514\u2500\u2500 DOCKERFILE_CHANGES.md   # Docker implementation documentation\n</code></pre>"},{"location":"ingester-agents/#key-components","title":"Key Components","text":"<p>CLI Layer: - <code>cli.py</code> - Main entry point with <code>fs</code>, <code>scm</code>, and <code>serve</code> commands - Agent-specific CLI commands in <code>fs/cli.py</code> and <code>scm/cli.py</code></p> <p>Server Layer: - <code>server/</code> - FastAPI application - <code>server/auth.py</code> - Flexible authentication (none, API key, OAuth2 proxy) - <code>server/routes/</code> - REST API endpoints mirroring CLI functionality</p> <p>Agent Layer: - <code>fs/app.py</code> - Filesystem operations (shared by CLI and API) - <code>scm/app.py</code> - SCM operations (shared by CLI and API) - <code>client.py</code> - HTTP client for Soliplex Ingester API</p> <p>Configuration: - <code>config.py</code> - Pydantic settings for all components - Environment variables or <code>.env</code> file for configuration</p>"},{"location":"ingester-agents/#license","title":"License","text":"<p>See LICENSE file for details.</p>"},{"location":"ingester-agents/#support","title":"Support","text":"<p>For issues and questions, please open an issue on the repository.</p>"},{"location":"pdf-splitter/","title":"PDF Splitter","text":"<p>Split-Process-Merge pipeline for converting large PDFs to Docling documents. This pipeline is useful for projects like soliplex that might need to break large PDF files apart before processing.</p>"},{"location":"pdf-splitter/#installation","title":"Installation","text":"<p>With pip: <pre><code>pip install pdf-splitter            # core only\npip install pdf-splitter[dev]       # with test/lint tools\n</code></pre></p> <p>With uv: <pre><code>uv add pdf-splitter                 # core only\nuv add pdf-splitter --group dev     # with test/lint tools\n</code></pre></p> <p>From source: <pre><code>git clone https://github.com/soliplex/pdf-splitter.git\ncd pdf-splitter\n\n# pip\npip install -e .                    # core only\npip install -e \".[dev]\"             # with dev tools\n\n# uv\nuv sync                             # core only\nuv sync --group dev                 # with dev tools\n</code></pre></p> <p>Requires Python 3.12+.</p>"},{"location":"pdf-splitter/#usage","title":"Usage","text":"<pre><code>pdf-splitter analyze doc.pdf              # analyze structure\npdf-splitter chunk doc.pdf -o ./chunks    # split into chunks\npdf-splitter convert ./chunks -o out.json # process &amp; merge\npdf-splitter validate out.json ./chunks   # validate output\n</code></pre>"},{"location":"pdf-splitter/#options","title":"Options","text":"Option Description <code>-v</code> Verbose logging <code>-s &lt;strategy&gt;</code> Force: <code>fixed</code>, <code>hybrid</code>, <code>enhanced</code> <code>--max-pages N</code> Max pages per chunk (default: 100) <code>-w N</code> Worker processes <code>--keep-parts</code> Output individual chunks"},{"location":"pdf-splitter/#python-api","title":"Python API","text":"<pre><code>from pdf_splitter.segmentation_enhanced import smart_split_to_files\nfrom pdf_splitter.processor import BatchProcessor\nfrom pdf_splitter.reassembly import merge_from_results\n\nchunks, _ = smart_split_to_files(\"doc.pdf\", output_dir=\"./chunks\")\nresults = BatchProcessor(max_workers=4).execute_parallel(chunks)\nmerged = merge_from_results(results)\nmerged.export_to_json(\"output.json\")\n</code></pre>"},{"location":"pdf-splitter/#development","title":"Development","text":"<pre><code>uv run pytest       # run tests\nuv run ruff check   # run ruff\nuv run mypy src/    # run mypy\n</code></pre>"},{"location":"soliplex/","title":"Soliplex Documentation","text":"<p>Welcome to the Soliplex documentation. This system provides AI-powered retrieval-augmented generation capabilities for intelligent document search and question answering.</p>"},{"location":"soliplex/#quick-start","title":"Quick Start","text":"<ol> <li>Prerequisites - Complete installation checklist and setup guide</li> <li>Overview - Learn about the system architecture and features</li> <li>RAG Database Setup - Set up the RAG search database</li> <li>Server Setup - Set up the FastAPI backend server</li> <li>Client Setup - Configure the Flutter web client</li> <li>Docker Deployment - Run Soliplex with Docker and Docker Compose</li> <li>Usage Guide - Start using the system</li> </ol>"},{"location":"soliplex/#what-is-soliplex","title":"What is Soliplex?","text":"<p>Soliplex combines the power of retrieval systems with generative AI to provide accurate, contextual responses based on your document collections. The system indexes your documents and uses them to enhance AI responses with relevant, up-to-date information.</p>"},{"location":"soliplex/client/","title":"Client Setup","text":"<p>The Soliplex client is a Flutter web application that provides the user interface for interacting with the RAG system.</p>"},{"location":"soliplex/client/#prerequisites","title":"Prerequisites","text":"<ul> <li>Dart SDK</li> <li>Flutter SDK</li> <li>Google Chrome (for web development)</li> </ul>"},{"location":"soliplex/client/#installation","title":"Installation","text":"<ol> <li> <p>Clone the client repository:    <pre><code>git clone git@github.com:soliplex/soliplex.git\ncd soliplex/src/flutter\n</code></pre></p> </li> <li> <p>Install Flutter dependencies:    <pre><code>flutter pub get\n</code></pre></p> </li> </ol>"},{"location":"soliplex/client/#running-the-client","title":"Running the Client","text":"<p>Start the Flutter web application:</p> <pre><code>flutter run -d chrome\n</code></pre> <p>This will launch the application in Chrome and provide a development server with hot reload capabilities.</p>"},{"location":"soliplex/client/#development","title":"Development","text":"<p>The client uses: - Flutter 3.35+ with Material Design - Riverpod for state management - <code>go_router</code> for navigation - WebSocket connections for real-time chat</p>"},{"location":"soliplex/docker/","title":"Docker Deployment","text":"<p>This guide covers running Soliplex using Docker and Docker Compose.</p>"},{"location":"soliplex/docker/#prerequisites","title":"Prerequisites","text":"<ul> <li>Docker 20.10+</li> <li>Docker Compose 2.0+</li> <li>Access to an LLM provider (Ollama or OpenAI)</li> </ul>"},{"location":"soliplex/docker/#docker-compose-setup","title":"Docker Compose Setup","text":"<p>The project includes a <code>docker-compose.yaml</code> file that orchestrates both the backend server and frontend web client.</p>"},{"location":"soliplex/docker/#services","title":"Services","text":"<p>The compose configuration defines two services:</p>"},{"location":"soliplex/docker/#1-soliplex_backend-python-backend","title":"1. <code>soliplex_backend</code> (Python Backend)","text":"<ul> <li>Port: 8000</li> <li>Technology: Python 3.13 with FastAPI</li> <li>Purpose: API server, RAG processing, AI integration</li> <li>Volumes:</li> <li><code>./example:/app/installation</code> - Configuration files</li> <li><code>./db:/app/db</code> - Database storage (RAG, threads, etc.)</li> </ul>"},{"location":"soliplex/docker/#2-soliplex_web-flutter-frontend","title":"2. <code>soliplex_web</code> (Flutter Frontend)","text":"<ul> <li>Port: 9000</li> <li>Technology: Flutter web application</li> <li>Purpose: User interface for chat and document interaction</li> </ul>"},{"location":"soliplex/docker/#configuration","title":"Configuration","text":"<ol> <li>Create environment file</li> </ol> <p>Copy the example environment file and configure your secrets:    <pre><code>cp .env.example .env\n</code></pre></p> <p>Edit <code>.env</code> to set required variables (see Environment Variables section below).</p> <ol> <li>Configure installation path</li> </ol> <p>The backend expects configuration at <code>/app/installation</code> inside the container.    By default, the <code>./example</code> directory is mounted there.</p> <p>To use a custom configuration:    <pre><code>volumes:\n  - ./path/to/your/config:/app/installation\n  - ./db:/app/db\n</code></pre></p> <ol> <li>Database persistence</li> </ol> <p>The <code>./db</code> directory is mounted to persist:    - RAG vector database (<code>db/rag/</code>)    - Thread persistence database    - Room authorization database</p>"},{"location":"soliplex/docker/#running-with-docker-compose","title":"Running with Docker Compose","text":""},{"location":"soliplex/docker/#start-all-services","title":"Start all services","text":"<pre><code>docker-compose up\n</code></pre> <p>Add <code>-d</code> flag to run in detached mode: <pre><code>docker-compose up -d\n</code></pre></p>"},{"location":"soliplex/docker/#start-specific-service","title":"Start specific service","text":"<pre><code>docker-compose up soliplex_backend\n</code></pre>"},{"location":"soliplex/docker/#view-logs","title":"View logs","text":"<pre><code># All services\ndocker-compose logs -f\n\n# Specific service\ndocker-compose logs -f soliplex_backend\n</code></pre>"},{"location":"soliplex/docker/#stop-services","title":"Stop services","text":"<pre><code>docker-compose down\n</code></pre>"},{"location":"soliplex/docker/#rebuild-after-code-changes","title":"Rebuild after code changes","text":"<pre><code>docker-compose up --build\n</code></pre>"},{"location":"soliplex/docker/#accessing-the-application","title":"Accessing the Application","text":"<ul> <li>Backend API: http://localhost:8000</li> <li>API Documentation: http://localhost:8000/docs</li> <li>Frontend Web UI: http://localhost:9000</li> </ul>"},{"location":"soliplex/docker/#building-custom-docker-images","title":"Building Custom Docker Images","text":""},{"location":"soliplex/docker/#backend-dockerfile","title":"Backend Dockerfile","text":"<p>The backend Dockerfile uses Python 3.13 and installs Soliplex in editable mode.</p> <p>Build manually: <pre><code>docker build -t soliplex-backend .\n</code></pre></p> <p>Run manually: <pre><code>docker run -p 8000:8000 \\\n  --env-file .env \\\n  -v $(pwd)/example:/app/installation \\\n  -v $(pwd)/db:/app/db \\\n  soliplex-backend\n</code></pre></p>"},{"location":"soliplex/docker/#frontend-dockerfile","title":"Frontend Dockerfile","text":"<p>Build the Flutter web client: <pre><code>cd src/flutter\ndocker build -t soliplex-web .\n</code></pre></p> <p>Run manually: <pre><code>docker run -p 9000:9000 soliplex-web\n</code></pre></p>"},{"location":"soliplex/docker/#environment-variables","title":"Environment Variables","text":"<p>The backend container reads environment variables from: 1. <code>.env</code> file (specified with <code>env_file</code> in docker-compose.yaml) 2. Environment variables set in docker-compose.yaml 3. Shell environment (if using <code>docker run</code>)</p>"},{"location":"soliplex/docker/#required-variables","title":"Required Variables","text":"<p>See .env.example for a complete list.</p> <p>For Ollama: <pre><code>OLLAMA_BASE_URL=http://host.docker.internal:11434\n</code></pre></p> <p>For OpenAI: <pre><code>OPENAI_API_KEY=sk-...\n</code></pre></p>"},{"location":"soliplex/docker/#accessing-host-services","title":"Accessing Host Services","text":"<p>When running Ollama or other services on your host machine, use <code>host.docker.internal</code>:</p> <pre><code># In .env file\nOLLAMA_BASE_URL=http://host.docker.internal:11434\n</code></pre> <p>On Linux, you may need to add this to docker-compose.yaml (already included): <pre><code>extra_hosts:\n  - \"host.docker.internal:host-gateway\"\n</code></pre></p>"},{"location":"soliplex/docker/#volume-mounts","title":"Volume Mounts","text":""},{"location":"soliplex/docker/#configuration-files-exampleappinstallation","title":"Configuration Files (<code>./example:/app/installation</code>)","text":"<p>Mounts your configuration directory into the container. Contents: - <code>installation.yaml</code> or <code>minimal.yaml</code> - Main installation config - <code>haiku.rag.yaml</code> - RAG configuration - <code>rooms/</code> - Room configurations - <code>completions/</code> - Completion endpoint configurations - <code>oidc/</code> - OIDC provider configurations - <code>quizzes/</code> - Quiz question files</p>"},{"location":"soliplex/docker/#database-files-dbappdb","title":"Database Files (<code>./db:/app/db</code>)","text":"<p>Persists application data: - <code>db/rag/rag.lancedb/</code> - RAG vector database - SQLite databases for threads and authorization (if using defaults)</p> <p>Important: Initialize the RAG database before first run (see RAG Setup below).</p>"},{"location":"soliplex/docker/#rag-database-setup-in-docker","title":"RAG Database Setup in Docker","text":"<p>The RAG database must be initialized before starting the backend server.</p>"},{"location":"soliplex/docker/#option-1-initialize-on-host-recommended","title":"Option 1: Initialize on Host (Recommended)","text":"<p>Initialize the database on your host machine before running Docker:</p> <pre><code># Create Python virtual environment\npython3.13 -m venv venv\nsource venv/bin/activate  # On Windows: venv\\Scripts\\activate\n\n# Install haiku-rag (full version for ingestion)\npip install haiku-rag\n\n# Set Ollama URL\nexport OLLAMA_BASE_URL=http://localhost:11434\n\n# Initialize and populate RAG database\nhaiku-rag --config example/haiku.rag.yaml init --db db/rag/rag.lancedb\nhaiku-rag --config example/haiku.rag.yaml add-src --db db/rag/rag.lancedb docs/\n</code></pre> <p>The <code>./db</code> directory will be mounted into the container with the initialized database.</p>"},{"location":"soliplex/docker/#option-2-initialize-in-container","title":"Option 2: Initialize in Container","text":"<p>Run initialization inside the backend container:</p> <pre><code># Start container with shell\ndocker-compose run --rm soliplex_backend /bin/bash\n\n# Inside container\nexport OLLAMA_BASE_URL=http://host.docker.internal:11434\npip install haiku-rag  # Install full version\nhaiku-rag --config /app/installation/haiku.rag.yaml init --db /app/db/rag/rag.lancedb\nhaiku-rag --config /app/installation/haiku.rag.yaml add-src --db /app/db/rag/rag.lancedb /app/docs/\nexit\n</code></pre>"},{"location":"soliplex/docker/#common-issues","title":"Common Issues","text":""},{"location":"soliplex/docker/#port-already-in-use","title":"Port Already in Use","text":"<p>If ports 8000 or 9000 are already allocated:</p> <p>Edit <code>docker-compose.yaml</code>: <pre><code>ports:\n  - \"8001:8000\"  # Map host port 8001 to container port 8000\n</code></pre></p>"},{"location":"soliplex/docker/#cannot-connect-to-ollama","title":"Cannot Connect to Ollama","text":"<p>Ensure <code>OLLAMA_BASE_URL</code> uses <code>host.docker.internal</code>: <pre><code>OLLAMA_BASE_URL=http://host.docker.internal:11434\n</code></pre></p> <p>Verify Ollama is running on host: <pre><code>ollama list\n</code></pre></p>"},{"location":"soliplex/docker/#rag-database-not-found","title":"RAG Database Not Found","text":"<p>The backend will fail if the RAG database hasn't been initialized.</p> <p>Check for database files: <pre><code>ls -la db/rag/\n</code></pre></p> <p>If missing, initialize as described in RAG Database Setup section.</p>"},{"location":"soliplex/docker/#permission-issues","title":"Permission Issues","text":"<p>If you encounter permission errors with mounted volumes:</p> <pre><code># Ensure directories exist and are writable\nmkdir -p db/rag\nchmod -R 755 db/\n</code></pre>"},{"location":"soliplex/docker/#development-workflow","title":"Development Workflow","text":""},{"location":"soliplex/docker/#hot-reload","title":"Hot Reload","text":"<p>The backend supports hot reload for development:</p> <pre><code># In docker-compose.yaml, add to backend service\ncommand: [\n  \"soliplex-cli\", \"serve\",\n  \"--host=0.0.0.0\",\n  \"--reload\", \"both\",\n  \"/app/installation\"\n]\nvolumes:\n  - ./src/soliplex:/app/src/soliplex  # Mount source code\n  - ./example:/app/installation\n  - ./db:/app/db\n</code></pre> <p>Changes to Python code or YAML configs will automatically reload the server.</p>"},{"location":"soliplex/docker/#running-tests","title":"Running Tests","text":"<pre><code># Run tests in container\ndocker-compose run --rm soliplex_backend pytest\n\n# With coverage\ndocker-compose run --rm soliplex_backend pytest --cov=soliplex\n</code></pre>"},{"location":"soliplex/docker/#production-considerations","title":"Production Considerations","text":"<ol> <li>Authentication: Never use <code>--no-auth-mode</code> in production</li> <li>Secrets: Use Docker secrets or environment variable injection from secrets managers</li> <li>Database: Consider PostgreSQL instead of SQLite for production</li> <li>Reverse Proxy: Place behind nginx or traefik with HTTPS</li> <li>Health Checks: Add health check endpoints to docker-compose</li> <li>Resource Limits: Set memory and CPU limits</li> </ol> <p>Example production docker-compose additions: <pre><code>services:\n  soliplex_backend:\n    deploy:\n      resources:\n        limits:\n          memory: 4G\n          cpus: '2'\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8000/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n</code></pre></p>"},{"location":"soliplex/docker/#next-steps","title":"Next Steps","text":"<ul> <li>Configure OIDC authentication: OIDC Providers</li> <li>Set up rooms: Room Configuration</li> <li>Configure agents: Agent Configuration</li> <li>Review server documentation: Server Setup</li> </ul>"},{"location":"soliplex/overview/","title":"Soliplex Overview","text":"<p>Soliplex is an AI-powered Retrieval-Augmented Generation (RAG) system designed to provide intelligent document search and question-answering capabilities.</p>"},{"location":"soliplex/overview/#architecture","title":"Architecture","text":"<p>The system consists of three main components:</p>"},{"location":"soliplex/overview/#1-backend-server-soliplex","title":"1. Backend Server (<code>soliplex/</code>)","text":"<ul> <li>Technology: FastAPI with Python 3.13</li> <li>Purpose: Handles API requests, RAG processing, and AI model integration</li> <li>Features: </li> <li>OpenAI API integration</li> <li>Document indexing and retrieval</li> <li>Authentication and authorization</li> <li>Real-time WebSocket communication</li> </ul>"},{"location":"soliplex/overview/#2-frontend-client-gen_ai_client","title":"2. Frontend Client (<code>gen_ai_client/</code>)","text":"<ul> <li>Technology: Flutter web application</li> <li>Purpose: Provides user interface for chat and document interaction</li> <li>Features:</li> <li>Material Design UI</li> <li>Real-time chat interface</li> <li>State management with Riverpod</li> <li>Responsive web design</li> </ul>"},{"location":"soliplex/overview/#3-configuration-system","title":"3. Configuration System","text":"<ul> <li>OIDC Authentication: Keycloak integration for secure access</li> <li>Room Configuration: Chat environments and settings</li> <li>Model Configuration: LLM provider and model settings</li> </ul>"},{"location":"soliplex/overview/#key-features","title":"Key Features","text":"<ul> <li>RAG Capabilities: Combines document retrieval with AI generation</li> <li>Multiple AI Models: Support for OpenAI and local models</li> <li>Secure Authentication: OIDC-based user management  </li> <li>Real-time Chat: WebSocket-powered interactive communication</li> <li>Document Management: Upload, index, and search through documents</li> </ul>"},{"location":"soliplex/prerequisites/","title":"Prerequisites and Installation Checklist","text":"<p>This guide provides a complete checklist for setting up Soliplex from scratch.</p>"},{"location":"soliplex/prerequisites/#system-requirements","title":"System Requirements","text":""},{"location":"soliplex/prerequisites/#software-prerequisites","title":"Software Prerequisites","text":"<ul> <li>[ ] Python 3.13+ - Required for backend server</li> <li>[ ] pip - Python package installer (usually included with Python)</li> <li>[ ] Git - For cloning the repository</li> <li>[ ] Docker &amp; Docker Compose (Optional) - For containerized deployment</li> </ul>"},{"location":"soliplex/prerequisites/#llm-provider-choose-one","title":"LLM Provider (Choose One)","text":"<ul> <li>[ ] Ollama (Recommended for local development)</li> <li>Install from: https://ollama.com/</li> <li>Verify: <code>ollama --version</code></li> </ul> <p>OR</p> <ul> <li>[ ] OpenAI API Access</li> <li>Create account at: https://platform.openai.com/</li> <li>Generate API key at: https://platform.openai.com/api-keys</li> </ul>"},{"location":"soliplex/prerequisites/#optional-components","title":"Optional Components","text":"<ul> <li>[ ] Flutter SDK (For frontend development)</li> <li>Version: 3.35+</li> <li>Install from: https://flutter.dev/docs/get-started/install</li> <li> <p>Verify: <code>flutter --version</code></p> </li> <li> <p>[ ] Dart SDK (Usually included with Flutter)</p> </li> <li>Version: 3.10.0+</li> <li> <p>Verify: <code>dart --version</code></p> </li> <li> <p>[ ] PostgreSQL (Optional, for production databases)</p> </li> <li>For development, SQLite (included) is sufficient</li> </ul>"},{"location":"soliplex/prerequisites/#installation-steps","title":"Installation Steps","text":"<p>Follow these steps in order for a successful setup.</p>"},{"location":"soliplex/prerequisites/#step-1-install-python-313","title":"Step 1: Install Python 3.13","text":""},{"location":"soliplex/prerequisites/#windows","title":"Windows","text":"<pre><code># Download from python.org\n# Or use winget\nwinget install Python.Python.3.13\n</code></pre>"},{"location":"soliplex/prerequisites/#macos","title":"macOS","text":"<pre><code># Using Homebrew\nbrew install python@3.13\n</code></pre>"},{"location":"soliplex/prerequisites/#linux","title":"Linux","text":"<pre><code># Ubuntu/Debian\nsudo apt update\nsudo apt install python3.13 python3.13-venv python3.13-dev\n\n# Fedora\nsudo dnf install python3.13\n</code></pre> <p>Verify installation: <pre><code>python3.13 --version\n</code></pre></p>"},{"location":"soliplex/prerequisites/#step-2-install-and-configure-ollama-if-using-ollama","title":"Step 2: Install and Configure Ollama (if using Ollama)","text":"<ol> <li> <p>Install Ollama <pre><code># Linux\ncurl -fsSL https://ollama.com/install.sh | sh\n\n# macOS\nbrew install ollama\n\n# Windows: Download from https://ollama.com/download\n</code></pre></p> </li> <li> <p>Start Ollama service <pre><code># Linux/macOS\nollama serve\n\n# Windows: Ollama runs as a service automatically\n</code></pre></p> </li> <li> <p>Pull required models <pre><code># Chat model (choose one)\nollama pull qwen2.5:latest\n# OR\nollama pull llama3.2:latest\n# OR\nollama pull mistral:latest\n\n# Embedding model (required for RAG)\nollama pull qwen3-embedding:4b\n</code></pre></p> </li> <li> <p>Verify models <pre><code>ollama list\n</code></pre></p> </li> <li> <p>Note your Ollama URL</p> </li> <li>Local installation: <code>http://localhost:11434</code></li> <li>Remote installation: <code>http://your-server:11434</code></li> <li>Docker accessing host: <code>http://host.docker.internal:11434</code></li> </ol>"},{"location":"soliplex/prerequisites/#step-3-clone-soliplex-repository","title":"Step 3: Clone Soliplex Repository","text":"<pre><code>git clone https://github.com/soliplex/soliplex.git\ncd soliplex\n</code></pre>"},{"location":"soliplex/prerequisites/#step-4-set-up-python-virtual-environment","title":"Step 4: Set Up Python Virtual Environment","text":"<pre><code># Create virtual environment\npython3.13 -m venv venv\n\n# Activate virtual environment\n# Linux/macOS:\nsource venv/bin/activate\n\n# Windows:\nvenv\\Scripts\\activate\n</code></pre> <p>Your prompt should now show <code>(venv)</code> prefix.</p>"},{"location":"soliplex/prerequisites/#step-5-install-python-dependencies","title":"Step 5: Install Python Dependencies","text":"<pre><code># Upgrade pip\npip install --upgrade pip setuptools\n\n# Install Soliplex in editable mode\npip install -e .\n\n# Verify installation\nsoliplex-cli --help\n</code></pre>"},{"location":"soliplex/prerequisites/#step-6-install-rag-indexing-dependencies","title":"Step 6: Install RAG Indexing Dependencies","text":"<p>Soliplex requires <code>haiku.rag</code> (full version) for document ingestion:</p>"},{"location":"soliplex/prerequisites/#option-1-install-haiku-rag-locally","title":"Option 1: Install haiku-rag locally","text":"<pre><code>pip install haiku-rag\n</code></pre>"},{"location":"soliplex/prerequisites/#option-2-use-docling-serve-docker-container","title":"Option 2: Use docling-serve Docker container","text":"<pre><code>docker run -p 5001:5001 -d \\\n  -e DOCLING_SERVE_ENABLE_UI=1 \\\n  quay.io/docling-project/docling-serve\n</code></pre> <p>If using Option 2, configure <code>example/haiku.rag.yaml</code> to use remote processing.</p>"},{"location":"soliplex/prerequisites/#step-7-configure-environment-variables","title":"Step 7: Configure Environment Variables","text":"<ol> <li> <p>Copy example environment file <pre><code>cp .env.example .env\n</code></pre></p> </li> <li> <p>Edit .env file <pre><code># Linux/macOS\nnano .env\n\n# Windows\nnotepad .env\n</code></pre></p> </li> <li> <p>Set required variables</p> </li> </ol> <p>For Ollama: <pre><code>OLLAMA_BASE_URL=http://localhost:11434\nSOLIPLEX_URL_SAFE_TOKEN_SECRET=generate-a-random-secret-here\n</code></pre></p> <p>For OpenAI: <pre><code>OPENAI_API_KEY=sk-proj-your-key-here\nSOLIPLEX_URL_SAFE_TOKEN_SECRET=generate-a-random-secret-here\n</code></pre></p> <p>Generate a secure token secret:    <pre><code>python -c \"import secrets; print(secrets.token_urlsafe(32))\"\n</code></pre></p> <ol> <li>Load environment variables <pre><code># Linux/macOS\nsource .env\n\n# Windows (PowerShell)\nGet-Content .env | ForEach-Object {\n  if ($_ -match '^([^=]+)=(.*)$') {\n    [Environment]::SetEnvironmentVariable($matches[1], $matches[2])\n  }\n}\n</code></pre></li> </ol>"},{"location":"soliplex/prerequisites/#step-8-choose-configuration-profile","title":"Step 8: Choose Configuration Profile","text":"<p>Soliplex provides several example configurations:</p> Configuration LLM Provider Features Best For <code>example/minimal.yaml</code> Ollama Basic rooms, no external APIs Local development <code>example/minimal-openai.yaml</code> OpenAI Basic rooms, no external APIs OpenAI users <code>example/installation.yaml</code> Ollama Full features + MCP tools Advanced features <code>example/installation-openai.yaml</code> OpenAI Full features + MCP tools Production with OpenAI <p>Recommendation for first-time users: Start with <code>minimal.yaml</code> or <code>minimal-openai.yaml</code>.</p>"},{"location":"soliplex/prerequisites/#step-9-initialize-rag-database","title":"Step 9: Initialize RAG Database","text":"<p>The RAG database MUST be initialized before starting the server.</p> <ol> <li> <p>Create database directory <pre><code>mkdir -p db/rag\n</code></pre></p> </li> <li> <p>Initialize database <pre><code>haiku-rag --config example/haiku.rag.yaml init --db db/rag/rag.lancedb\n</code></pre></p> </li> <li> <p>Index documentation <pre><code># Index all documentation\nhaiku-rag --config example/haiku.rag.yaml \\\n  add-src --db db/rag/rag.lancedb docs/\n\n# You should see:\n# 17 documents added successfully.\n</code></pre></p> </li> <li> <p>Verify database <pre><code>ls -la db/rag/rag.lancedb/\n</code></pre></p> </li> </ol>"},{"location":"soliplex/prerequisites/#step-10-validate-configuration","title":"Step 10: Validate Configuration","text":"<p>Check for any missing requirements:</p> <pre><code>soliplex-cli check-config example/minimal.yaml\n</code></pre> <p>This command will report: - Missing secrets - Missing environment variables - Configuration errors</p> <p>Fix any reported issues before proceeding.</p>"},{"location":"soliplex/prerequisites/#step-11-list-available-rooms","title":"Step 11: List Available Rooms","text":"<p>Verify your room configuration:</p> <pre><code>soliplex-cli list-rooms example/minimal.yaml\n</code></pre> <p>You should see rooms like: - <code>ask_soliplex</code> - RAG-powered Soliplex documentation assistant - <code>haiku</code> - General purpose chat - <code>joker</code> - Entertainment/joke generation - <code>faux</code> - Test room</p>"},{"location":"soliplex/prerequisites/#step-12-start-backend-server","title":"Step 12: Start Backend Server","text":"<pre><code>soliplex-cli serve example/minimal.yaml --no-auth-mode\n</code></pre> <p>Expected output: <pre><code>INFO:     Started server process [xxxxx]\nINFO:     Waiting for application startup.\nINFO:     Application startup complete.\nINFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)\n</code></pre></p> <p>The <code>--no-auth-mode</code> flag disables authentication for development.</p>"},{"location":"soliplex/prerequisites/#step-13-verify-backend-api","title":"Step 13: Verify Backend API","text":"<p>In a new terminal, test the API:</p> <pre><code># Test health endpoint\ncurl http://localhost:8000/health\n\n# List rooms\ncurl http://localhost:8000/api/v1/rooms\n\n# View OpenAPI docs\n# Open browser: http://localhost:8000/docs\n</code></pre>"},{"location":"soliplex/prerequisites/#step-14-install-frontend-optional","title":"Step 14: Install Frontend (Optional)","text":"<p>If you want to use the web UI:</p> <ol> <li> <p>Install Flutter <pre><code># Follow instructions at https://flutter.dev/docs/get-started/install\n</code></pre></p> </li> <li> <p>Navigate to Flutter directory <pre><code>cd src/flutter\n</code></pre></p> </li> <li> <p>Install dependencies <pre><code>flutter pub get\n</code></pre></p> </li> <li> <p>Run web application <pre><code>flutter run -d chrome --web-port 59001\n</code></pre></p> </li> <li> <p>Access frontend</p> </li> <li>Open browser: http://localhost:59001</li> <li>Select \"localhost\" from dropdown</li> <li>Start chatting!</li> </ol>"},{"location":"soliplex/prerequisites/#step-15-try-tui-optional","title":"Step 15: Try TUI (Optional)","text":"<p>For a terminal-based interface:</p> <pre><code># Make sure backend is running with --no-auth-mode\nsoliplex-tui\n\n# Or specify custom URL\nsoliplex-tui --url http://localhost:8000\n</code></pre>"},{"location":"soliplex/prerequisites/#quick-start-commands-summary","title":"Quick Start Commands Summary","text":"<p>For reference, here's the complete command sequence:</p> <pre><code># Setup\ngit clone https://github.com/soliplex/soliplex.git\ncd soliplex\npython3.13 -m venv venv\nsource venv/bin/activate  # or venv\\Scripts\\activate on Windows\npip install --upgrade pip setuptools\npip install -e .\npip install haiku-rag\n\n# Configure\ncp .env.example .env\n# Edit .env with your settings\nsource .env\n\n# Initialize RAG\nmkdir -p db/rag\nhaiku-rag --config example/haiku.rag.yaml init --db db/rag/rag.lancedb\nhaiku-rag --config example/haiku.rag.yaml add-src --db db/rag/rag.lancedb docs/\n\n# Verify\nsoliplex-cli check-config example/minimal.yaml\nsoliplex-cli list-rooms example/minimal.yaml\n\n# Run\nsoliplex-cli serve example/minimal.yaml --no-auth-mode\n</code></pre>"},{"location":"soliplex/prerequisites/#docker-quick-start","title":"Docker Quick Start","text":"<p>If you prefer Docker:</p> <pre><code># Setup\ngit clone https://github.com/soliplex/soliplex.git\ncd soliplex\ncp .env.example .env\n# Edit .env with your settings\n\n# Initialize RAG database (on host)\npython3.13 -m venv venv\nsource venv/bin/activate\npip install haiku-rag\nexport OLLAMA_BASE_URL=http://localhost:11434\nmkdir -p db/rag\nhaiku-rag --config example/haiku.rag.yaml init --db db/rag/rag.lancedb\nhaiku-rag --config example/haiku.rag.yaml add-src --db db/rag/rag.lancedb docs/\ndeactivate\n\n# Run with Docker\ndocker-compose up\n</code></pre>"},{"location":"soliplex/prerequisites/#troubleshooting","title":"Troubleshooting","text":""},{"location":"soliplex/prerequisites/#python-313-not-found","title":"Python 3.13 not found","text":"<ul> <li>Ensure Python 3.13 is installed and in your PATH</li> <li>Try <code>python3.13 --version</code> to verify</li> </ul>"},{"location":"soliplex/prerequisites/#ollama-connection-refused","title":"Ollama connection refused","text":"<ul> <li>Ensure Ollama service is running: <code>ollama serve</code></li> <li>Verify URL is correct in .env file</li> <li>Check firewall settings</li> </ul>"},{"location":"soliplex/prerequisites/#rag-database-errors","title":"RAG database errors","text":"<ul> <li>Ensure database is initialized before starting server</li> <li>Check file permissions on db/ directory</li> <li>Verify OLLAMA_BASE_URL is accessible</li> </ul>"},{"location":"soliplex/prerequisites/#module-not-found-errors","title":"Module not found errors","text":"<ul> <li>Ensure virtual environment is activated</li> <li>Reinstall dependencies: <code>pip install -e .</code></li> <li>Check Python version: <code>python --version</code></li> </ul>"},{"location":"soliplex/prerequisites/#port-already-in-use","title":"Port already in use","text":"<ul> <li>Backend (8000): Change with <code>--port</code> flag</li> <li>Frontend (59001): Change with <code>--web-port</code> flag</li> <li>Check for other processes: <code>lsof -i :8000</code> (Linux/macOS)</li> </ul>"},{"location":"soliplex/prerequisites/#next-steps","title":"Next Steps","text":"<p>After successful installation:</p> <ol> <li>Explore Configuration: Review installation.md</li> <li>Set Up Rooms: Configure custom rooms in rooms.md</li> <li>Configure Agents: Set up AI agents in agents.md</li> <li>Enable Authentication: Configure OIDC in oidc_providers.md</li> <li>Deploy with Docker: Follow docker.md</li> </ol>"},{"location":"soliplex/prerequisites/#getting-help","title":"Getting Help","text":"<ul> <li>Documentation: https://soliplex.github.io/</li> <li>Issues: https://github.com/soliplex/soliplex/issues</li> <li>API Docs: http://localhost:8000/docs (when server is running)</li> </ul>"},{"location":"soliplex/rag/","title":"Retrieval-Augmented Generation (RAG) Database","text":"<p>Soliplex depends on the <code>haiku-rag</code> library to manage its retrieval-augmented generation (RAG) searches.  That library stores its extracted documents / chunks / embeddings in LanceDB databases.</p> <p>The example installation of Soliplex uses the Soliplex documentation as its RAG corpus, and expects that database to be created at <code>db/rag/rag.lancedb</code>.</p>"},{"location":"soliplex/rag/#note-on-haiku-rag-versions","title":"Note on <code>haiku-rag</code> Versions","text":"<p>The <code>soliplex</code> code itself requires only the <code>haiku-rag-slim</code> project (https://pypi.org/project/haiku.rag-slim/), which allows for queries aganst an existing LanceDB database.</p> <p>However, this dependency is not sufficient to perform the ingestion / indexing of documents.  For that purpose, either:</p> <ul> <li> <p>Install the main <code>haiku-rag</code> project   https://pypi.org/project/haiku.rag/   wihch will pull in all the dependencies required to ingest and index   documents.</p> </li> <li> <p>Pull the <code>docling-serve</code> Docker image, and run its server, with   your <code>haiku.rag.yaml</code> file configured to use it.</p> </li> </ul> <p>See the <code>haiku.rag</code> documentation to determine:</p> <ul> <li> <p>Which installation do you need?</p> </li> <li> <p>What are the tradeoffs of local vs. remote processing?</p> </li> <li> <p>How to configure <code>haiku-rag</code> to run in \"remote processing\" mode?</p> </li> </ul>"},{"location":"soliplex/rag/#adding-a-single-document","title":"Adding a single document","text":"<pre><code>export OLLAMA_BASE_URL=&lt;your Ollama server / port&gt;\nhaiku-rag --config example/haiku.rag.yaml \\\n  add-src --db db/rag/rag.lancedb docs/index.md\n...\nDocument &lt;UUID&gt; added successfully.\n</code></pre>"},{"location":"soliplex/rag/#adding-all-documents-in-a-directory","title":"Adding all documents in a directory","text":"<pre><code>export OLLAMA_BASE_URL=&lt;your Ollama server / port&gt;\nhaiku-rag --config example/haiku.rag.yaml \\\n  add-src --db db/rag/rag.lancedb docs/\n...\n17 documents added successfully.\n</code></pre>"},{"location":"soliplex/rag/#configuration-of-haiku-rag-clients-within-soliplex","title":"Configuration of <code>haiku-rag</code> clients within Soliplex","text":"<p>Please see this page for notes on configuring the various <code>haiku-rag</code> clients used in a Soliplex installation.</p>"},{"location":"soliplex/server/","title":"Server Setup","text":"<p>The Soliplex server is a FastAPI-based backend that forwards requests to OpenAI and provides RAG functionality.</p>"},{"location":"soliplex/server/#prerequisites","title":"Prerequisites","text":"<ul> <li> <p>Python 3.13+</p> </li> <li> <p>Access to LLM:</p> </li> <li> <p>OpenAI - an API key is required to use OpenAI</p> </li> <li> <p>Ollama  ([https://ollama.com/] https://ollama.com/)</p> </li> <li> <p>Logfire (optional):</p> </li> </ul> <p>A token from logfire (login here)   allows for visibility into the application. (see the   docs on FastAPI integration   for more information).</p>"},{"location":"soliplex/server/#installation","title":"Installation","text":"<ol> <li> <p>Clone the repository:    <pre><code>git clone git@github.com:soliplex/soliplex.git\ncd soliplex/\n</code></pre></p> </li> <li> <p>Set up a Python3 virtual environment:    <pre><code>python -m venv venv\nsource venv/bin/activate\npip install --upgrade setuptools pip\n</code></pre></p> </li> <li> <p>Install <code>soliplex</code> and its dependencies:    <pre><code>pip install -e .\n</code></pre></p> </li> <li> <p>Set up environment variables:</p> </li> </ol> <p>An environment file can be used to configure secrets.    For logfire, create a <code>.env</code> file with:    <pre><code>LOGFIRE_TOKEN=&lt;your_token_here&gt;\n</code></pre></p>"},{"location":"soliplex/server/#running-the-example","title":"Running the example","text":"<p>The example configuration provides an overview of how a soliplex application is assembled.  It contains four top-level installation configurations:</p> <ul> <li> <p><code>example/minimal.yaml</code> is a minimal example using Ollama:  it requires   no secrets.</p> </li> <li> <p><code>example/installation.yaml</code> is a more fleshed-out example using Ollama:   it requires secrets for the exernal Model-Control Protocol (MCP) client   toosets for the room <code>mcptest</code>.</p> </li> <li> <p><code>example/minimal-openai.yaml</code> is a minimal example using OpenAI:    it requires no secrets beyond the <code>OPENAI_API_KEY</code>.</p> </li> <li> <p><code>example/installation.yaml</code> is a more fleshed-out example using OpenAI:   in addition tothe <code>OPENAI_API_KEY</code> secret, it requires secrets for the   exernal Model-Control Protocol (MCP) client toosets for the room <code>mcptest</code>.</p> </li> </ul> <p>Each installation configuration includes a number of rooms that </p> <ol> <li>Configure resources:</li> </ol> <p>The example needs access to a model server using either openapi    or ollama as well as access to example MCP services.</p> <p>The example uses https://smithery.ai/ but others    can be configured.</p> <p>a. OIDC configuration:    TODO</p> <ol> <li> <p>Configure the LLM (Ollama / OpenAI):</p> </li> <li> <p>For the Ollama veriants, export the URL of your model server as      <code>OLLAMA_BASE_URL</code>.  This url should not contain the <code>/v1</code> suffix.      E.g. if you are running Ollama on your own machine:</p> <pre><code>export OLLAMA_BASE_URL=http://localhost:11434\n</code></pre> </li> <li> <p>The example configuration uses the <code>gpt-oss</code> model.  If using either      Ollama variant, install that model via:      <pre><code>ollama pull gpt-oss:latest\n</code></pre></p> </li> <li> <p>Check for missing secrets / environment variables:</p> </li> </ol> <p>This command will check the server for any missing variables or    invalid configuration files.    <pre><code>soliplex-cli check-config example/&lt;installation config&gt;.yaml\n</code></pre></p> <p>The secrets used in the your chosen configuration should be exported as    environment variables, e.g.:    <pre><code>SMITHERY_AI_API_KEY=&lt;your key&gt;\nSMITHERY_AI_PROFILE=&lt;your profile&gt;\n</code></pre></p> <p>Note that the alternate installation configurations, <code>example/minimal.yaml</code>    and <code>example/minimal-openai.yaml</code>, requires no additional secrets    The <code>example/minimal.yaml</code> configuration still expects    the <code>OLLAMA_BASE_URL</code> environment variable to be set (or present in    an <code>.env</code> file):    <pre><code>soliplex-cli check-config example/minimal.yaml\n</code></pre></p> <ol> <li> <p>Configure any missing secrets, e.g. by sourcing a <code>.env</code> file, or    by exporting them directly.</p> </li> <li> <p>Configure any missing environment variables, e.g. by editing    the installation YAML file, adding them to a <code>.env</code> file in the    installation path, or exporting them directly.    <pre><code>export OLLAMA_BASE_URL=http://&lt;your-ollama-host&gt;:11434\nsoliplex-cli check-config example/\n</code></pre></p> </li> </ol>"},{"location":"soliplex/server/#running-the-server","title":"Running the Server","text":"<p>Start the FastAPI server:</p> <pre><code>soliplex-cli serve example/installation.yaml\n</code></pre> <p>The server will be available at <code>http://localhost:8000</code> by default.</p>"},{"location":"soliplex/server/#server-command-options","title":"Server Command Options","text":"<pre><code>soliplex-cli serve [OPTIONS] INSTALLATION_CONFIG_PATH\n</code></pre> <p>Basic Options:</p> <ul> <li><code>INSTALLATION_CONFIG_PATH</code> - Path to installation YAML file (required)</li> <li><code>--help</code> - Show help message</li> </ul> <p>Network Options:</p> <ul> <li><code>--host HOST</code> - Bind to specific host (default: <code>127.0.0.1</code>)</li> <li>Use <code>0.0.0.0</code> to accept connections from any network interface</li> <li> <p>Example: <code>--host 0.0.0.0</code></p> </li> <li> <p><code>--port PORT</code> - Listen on specific port (default: <code>8000</code>)</p> </li> <li>Example: <code>--port 8080</code></li> </ul> <p>Authentication Options:</p> <ul> <li><code>--no-auth-mode</code> - Disable authentication (development/testing only)</li> <li>WARNING: Never use in production</li> <li>Example: <code>--no-auth-mode</code></li> </ul> <p>Hot Reload Options:</p> <ul> <li><code>--reload {code,config,both}</code> / <code>-r {code,config,both}</code> - Enable hot reload</li> <li><code>code</code> - Watch Python source files for changes</li> <li><code>config</code> - Watch YAML configuration files for changes</li> <li><code>both</code> - Watch both code and config files</li> <li> <p>Example: <code>--reload both</code> or <code>-r both</code></p> </li> <li> <p><code>--reload-dirs DIRS</code> - Additional directories to watch (repeatable)</p> </li> <li> <p>Example: <code>--reload-dirs ./custom_modules --reload-dirs ./plugins</code></p> </li> <li> <p><code>--reload-includes PATTERNS</code> - File patterns to include in watch (repeatable)</p> </li> <li>Example: <code>--reload-includes \"*.yaml\" --reload-includes \"*.json\"</code></li> </ul> <p>Proxy Options:</p> <ul> <li><code>--proxy-headers</code> - Enable parsing of X-Forwarded-* headers</li> <li>Use when running behind a reverse proxy (nginx, traefik, etc.)</li> <li> <p>Example: <code>--proxy-headers</code></p> </li> <li> <p><code>--forwarded-allow-ips IPS</code> - Trusted IP addresses for proxy headers (comma-separated)</p> </li> <li>Default: <code>127.0.0.1</code></li> <li>Example: <code>--forwarded-allow-ips \"127.0.0.1,10.0.0.0/8\"</code></li> </ul>"},{"location":"soliplex/server/#common-usage-examples","title":"Common Usage Examples","text":"<p>Development with hot reload: <pre><code>soliplex-cli serve example/installation.yaml \\\n  --reload both \\\n  --no-auth-mode\n</code></pre></p> <p>Production (behind nginx): <pre><code>soliplex-cli serve example/installation.yaml \\\n  --host 127.0.0.1 \\\n  --port 8000 \\\n  --proxy-headers \\\n  --forwarded-allow-ips \"127.0.0.1\"\n</code></pre></p> <p>Docker container (all network interfaces): <pre><code>soliplex-cli serve example/installation.yaml \\\n  --host 0.0.0.0 \\\n  --port 8000\n</code></pre></p> <p>Custom port for testing: <pre><code>soliplex-cli serve example/minimal.yaml \\\n  --port 8080 \\\n  --no-auth-mode\n</code></pre></p>"},{"location":"soliplex/server/#verifying-the-server","title":"Verifying the Server","text":"<p>To confirm your room configuration: <pre><code>curl -X 'GET' \\\n  'http://127.0.0.1:8000/api/v1/rooms' \\\n  -H 'accept: application/json'\n</code></pre></p> <p>To check server health: <pre><code>curl http://127.0.0.1:8000/health\n</code></pre></p>"},{"location":"soliplex/server/#api-endpoints","title":"API Endpoints","text":"<p>If the <code>soliplex-cli</code> server is running, you can browse the live OpenAPI documentation.</p>"},{"location":"soliplex/usage/","title":"Using Soliplex","text":"<p>Once both the server and client are running, you can start using the Soliplex system.</p>"},{"location":"soliplex/usage/#getting-started","title":"Getting Started","text":"<ol> <li>Open your web browser and navigate to the client application</li> <li>In the dropdown menu, select the localhost option</li> <li>Start typing your questions or prompts</li> </ol>"},{"location":"soliplex/usage/#features","title":"Features","text":"<p>The Soliplex system provides: - Chat Interface: Interactive chat with AI models - Document Retrieval: RAG-powered document search and question answering - Multiple Models: Support for various AI models through OpenAI API - Real-time Responses: WebSocket-based real-time communication</p>"},{"location":"soliplex/usage/#tips","title":"Tips","text":"<ul> <li>Use clear, specific questions for better RAG results</li> <li>The system can access and search through indexed documents</li> <li>Responses are generated using retrieval-augmented generation for   more accurate and contextual answers</li> </ul>"},{"location":"soliplex/config/agents/","title":"Agent Configurations","text":"<p>The agent configuration mapping is used to configure the Pydantic AI agent used to make the calls to the LLM.</p> <pre><code>agent:\n    model_name: \"gpt-oss:20b\"\n    system_prompt: |\n      You are an expert AI assistant specializing in information retrieval.\n\n      Your answers should be clear, concise, and ready for production use.\n\n      Always provide code or examples in Markdown blocks.\n</code></pre>"},{"location":"soliplex/config/agents/#required-agent-elements","title":"Required Agent Elements","text":"<ul> <li><code>model_name</code>: a string, should be the identifier of an LLM model for the   agent.</li> </ul> <p>NOTE: this value was previously optional, defaulting to the value             of the now-removed <code>DEFAULT_AGENT_MODEL</code> key in the             installation environment.</p> <ul> <li><code>system_prompt</code> is the \"instructions\" for the LLM serving the room.   If it starts with a <code>./</code>, it will be treated as a filename in the   same directory, whose contents will be read in its place.</li> </ul> <p>A minimal configuration, without an external prompt file:</p> <pre><code>agent:\n    model_name: \"gpt-oss:latest\"\n    system_prompt: |\n        You are a knowledgeable assistant that helps users find information from a document knowledge base.\n\n        Your process:\n        1. When a user asks a question, use the search_documents tool to find relevant information\n        ...\n</code></pre> <p>A minimal configuration, but with the prompt stored in external file:</p> <pre><code>agent:\n    model_name: \"gpt-oss:latest\"\n    system_prompt: \"./prompt.txt\"\n</code></pre>"},{"location":"soliplex/config/agents/#optional-agent-elements","title":"Optional Agent Elements","text":"<ul> <li> <p><code>provider_type</code>: a string, must be one of <code>\"ollama\"</code> (the default),   <code>\"openai\"</code>, or <code>\"google\"</code>.</p> </li> <li> <p><code>provider_base_url</code>: a string, is the base API URL for the agent's LLM   provider.</p> </li> </ul> <p>If not provided, and <code>provider_type</code> is set to <code>\"ollama\"</code>, defaults to   the value configured in the installation environment as <code>OLLAMA_BASE_URL</code></p> <p>If not provided, and <code>provider_type</code> is set to <code>\"openai\"</code>, defaults to   the default OpenAI service URL.</p> <p>Must not be set if <code>provider_type</code> is set to <code>\"google\"</code>.</p> <p>Must be specified without the <code>/v1</code> suffix. E.g.:</p> <pre><code>provider_base_url: \"https://provider.example.com/api\"\n</code></pre> <ul> <li><code>provider_key</code> (a string, default None) should be the name of the secret   holding the LLM provider's API key (not the value of the API key),   prefixed with <code>secret:</code></li> </ul> <pre><code>provider_key: \"secret:FOO_PROVIDER_API_KEY\"\n</code></pre> <p><code>provider_model_settings</code>: a mapping, whose keys are determined by   the <code>provider_type</code> above (see below).</p>"},{"location":"soliplex/config/agents/#example-ollama-configuration","title":"Example Ollama Configuration","text":"<p>NOTE: the values below show types, but should not be used without           testing.</p> <pre><code>model_name: \"gpt-oss:latest\"\nprovider_type: \"ollama\"\nprovider_model_settings:\n  temperature: 0.90\n  top_k: 100\n  top_p: 0.75\n  min_p: 0.25\n  stop: \"STOP\"\n  num_ctx: 2048\n  num_predict: 2000\n</code></pre>"},{"location":"soliplex/config/agents/#example-openai-configuration","title":"Example OpenAI Configuration","text":"<p>NOTE: the values below show types, but should not be used without           testing.</p> <pre><code>model_name: \"mistral:7b\"\nprovider_type: \"openai\"\nprovider_model_settings:\n  temperature: 0.90\n  top_p: 0.70\n  frequency_penalty: 0.25\n  presence_penalty: 0.50\n  parallel_tool_calls: false\n  truncation: \"disabled\"\n  max_tokens: 2048\n  verbosity: \"high\"\n</code></pre>"},{"location":"soliplex/config/agents/#example-google-configuration","title":"Example Google Configuration","text":"<p>NOTE: the values below show types, but should not be used without           testing.</p> <pre><code>model_name: \"gemini-2.5-flash\"\nprovider_type: \"google\"\nprovider_model_settings:\n  temperature: 0.90\n  top_p: 0.70\n  frequency_penalty: 0.25\n  presence_penalty: 0.50\n  parallel_tool_calls: false\n  truncation: \"disabled\"\n  max_tokens: 2048\n  verbosity: \"high\"\n</code></pre>"},{"location":"soliplex/config/completions/","title":"Completion Configuration Filesystem Layout","text":"<p>A completion is configured via a directory, whose name is the completion ID.</p> <p>NOTE: directories whose names start with '.' are ignored.</p> <p>Within that directory should be one or two files:</p> <ul> <li> <p><code>completion_config.yaml</code> holds metadata about the completion (see below)</p> </li> <li> <p><code>prompt.txt</code> (if present) holds the system prompt for conversations   which are initiated from the room.</p> </li> </ul> <p>Example layout without external prompt: <pre><code>simple/\n    room_config.yaml\n</code></pre></p> <p>Example layout with external prompt: <pre><code>chat/\n    prompt.txt\n    room_config.yaml\n</code></pre></p>"},{"location":"soliplex/config/completions/#completions-endpoint-configuration-file-schema","title":"Completions Endpoint Configuration File Schema","text":""},{"location":"soliplex/config/completions/#required-endpoint-elements","title":"Required endpoint elements","text":"<p>The <code>completion_config.yaml</code>  file should be a mapping, with at least the following required elements:</p> <ul> <li> <p><code>id</code> (a string) should match the name of the endpoint's directory.</p> </li> <li> <p><code>agent</code> (a mapping)</p> </li> </ul> <p>A minimal completion endpoint configuration must include the above elements, e.g.:</p> <pre><code>id: \"chat\"\nagent:\n  system_prompt: |\n      You are an..... #\n</code></pre> <p>Please see this page which documents the <code>agent</code> element schema.</p>"},{"location":"soliplex/config/environment/","title":"Installation Environment","text":"<p>The <code>environment</code> section configures non-secret values used by various portions of the Soliplex application.  Application code should use the <code>Installation.get_environment</code> API to fetch configured values, rather than using <code>os.environ</code>.</p>"},{"location":"soliplex/config/environment/#environment-entries","title":"Environment Entries","text":"<p>The section consists of a list of mappings, each with keys <code>name</code> and <code>value</code>.</p> <pre><code>environment:\n  - name: \"ENV_VAR_NAME\"\n    value: \"ENV_VAR_VALUE\"\n</code></pre>"},{"location":"soliplex/config/environment/#unconfigured-environment-entries","title":"Unconfigured Environment Entries","text":"<p>If the <code>value</code> key is missing, the Soliplex application will attempt to resolve it using <code>os.environ</code> during startup.</p>"},{"location":"soliplex/config/environment/#bare-string-environment-entries","title":"Bare-String Environment Entries","text":"<p>As an alternative, an item in the list can be a bare string:  such an entry corresponds exactly to a mapping with <code>name: \"&lt;bare string</code> and no <code>value</code>.</p> <p>This configuration: <pre><code>environment:\n  - \"ENV_VAR_NAME\"\n</code></pre> is exactly equivalent to this one: <pre><code>environment:\n  - name: \"ENV_VAR_NAME\"\n</code></pre></p>"},{"location":"soliplex/config/environment/#checking-configured-environment-values","title":"Checking Configured Environment Values","text":"<p>The <code>soliplex-cli</code> application has a sub-command, <code>list-environment</code>. It loads the configuration, attempts to resolve any values not found, and reports them:</p> <pre><code>$ soliplex-cli list-environment example/installation.yaml \n\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Configured environment variables \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n- OLLAMA_BASE_URL          : MISSING\n- INSTALLATION_PATH        : file:.\n- RAG_LANCE_DB_PATH        : file:../db/rag\n- LOGFIRE_ENVIRONMENT      : container\n- LOGFIRE_SERVICE_NAME     : soliplex\n</code></pre>"},{"location":"soliplex/config/filesystem_layout/","title":"Installation Filesystem Layout","text":"<p>An \"installation\" is a set of filesystem-based configuration files, organized as a directory tree.</p> <p>At the root of an installation directory is a file, <code>installation.yaml</code>, which is used to configure environment variables and secrets used by the installation.  There may be alternative configurations available, e.g. to configure how the installation runs inside a container.</p> <p>See this page for documentation on the schema of one of these configurations.</p> <p>An installation directory typically contains subdirectories, each holding configurations for a given type of entity.</p> <p>Example layout:</p> <pre><code>/\n  installation.yaml\n  completions/\n    chat-bot/\n      completion_config.yaml\n      prompt.txt\n    ...\n  oidc/\n    cacert.pem\n    config.yaml\n  quizzes/\n    quiz_name.json\n    ...\n  rooms/\n    quiztest/\n      prompt.txt\n      room_config.yaml\n    ...\n</code></pre>"},{"location":"soliplex/config/filesystem_layout/#room-configuration","title":"Room Configuration","text":"<p>Within a \"rooms\" directory, each room is represented by a subdirectory, whose name is the room ID.</p> <p>Within that subdirectory should be one or two files:</p> <ul> <li> <p><code>room_config.yaml</code> holds metadata about the room (see below)</p> </li> <li> <p><code>prompt.txt</code> (if present) holds the system prompt for conversations   which are initiated from the room.</p> </li> <li> <p>A logo image file (optional)</p> </li> </ul> <p>See this page for documentation on the contents and schema of these files.</p>"},{"location":"soliplex/config/filesystem_layout/#completions-endpoint-configuration","title":"Completions Endpoint Configuration","text":"<p>Within a \"completions\" directory, each endpoint is represented by a subdirectory, whose name is the endpoint ID.</p> <p>Within that subdirectory should be one or two files:</p> <ul> <li> <p><code>completion_config.yaml</code> holds metadata about the endpoint (see below)</p> </li> <li> <p><code>prompt.txt</code> (if present) holds the system prompt for conversations   which are initiated from the endpoint.</p> </li> </ul> <p>See this page for documentation on the contents and schema of these files.</p>"},{"location":"soliplex/config/filesystem_layout/#quiz-configuration","title":"Quiz Configuration","text":"<p>This directory contains question sets as individual JSON files, derived from the evaluation dataset entries.</p> <p>See this page for documentation on the contents and schema of these files.</p>"},{"location":"soliplex/config/filesystem_layout/#oidc-provider-configuration","title":"OIDC Provider Configuration","text":"<p>This directory contains configuration files defining the OIDC identity providers configured for use in this installation.</p> <p>See this page for documentation on the contents and schema of these files.</p>"},{"location":"soliplex/config/installation/","title":"Installation Configuration","text":""},{"location":"soliplex/config/installation/#installation-id","title":"Installation ID","text":"<p>A required field, to allow quick disambiguation between alternative configurations.</p> <pre><code>id: \"soliplex-example\"\n</code></pre>"},{"location":"soliplex/config/installation/#installation-metaconfiguration","title":"Installation Metaconfiguration","text":"<p>The <code>meta</code> section allows you to register custom \"kinds\" of entities (tool configurations, MCP client toolset configurations, etc.), such that you can use them within your own configurations (e.g., to register a configuration class for use with a custom tool in a given room).</p> <pre><code>meta:\n</code></pre> <p>See this page for documentation on the meta-configuration schema.</p>"},{"location":"soliplex/config/installation/#secrets","title":"Secrets","text":"<pre><code>secrets:\n</code></pre> <p>Secrets are values used to authenticate access to different resources or APIs.</p> <p>The may be kept in an external store, such as:</p> <ul> <li>ASW secret store</li> <li>GitHub secrets</li> <li>Docker Compose secrets files</li> <li>The user keyring</li> </ul> <p>See this page for documentation on configuring installation secrets.</p>"},{"location":"soliplex/config/installation/#environment","title":"Environment","text":"<p>The <code>environment</code> section configures non-secret values used by various portions of the Soliplex application.  Application code should use the <code>Installation.get_environment</code> API to fetch configured values, rather than using <code>os.environ</code>.</p> <pre><code>environment:\n</code></pre> <p>See this page for documentation on configuring the installation environment.</p>"},{"location":"soliplex/config/installation/#haikurag-configuration-file","title":"<code>haiku.rag</code> Configuration File","text":"<p>The <code>haiku_rag_config_file</code> entry points to a YAML file containing configuration values for the <code>haiku.rag</code> client</p> <p>If not configured explicitly, the installation configuration expects to find this file in the same directory, with the default name <code>haiku.rag.yaml</code>.</p> <p>Pleas see the <code>haiku.rag</code> configuration docs for details on how to configure the <code>haiku.rag</code> client used by Soliplex.</p>"},{"location":"soliplex/config/installation/#agent-configurations","title":"Agent Configurations","text":"<p>An installation can declare agent configurations (which are normally bound to rooms / completions) at the top-level, such that they can be looked up by ID from Python code using <code>the_installation.get_agent_by_id</code>.</p> <p><pre><code>agent_configs:\n\n  - id: \"ollama_gpt_oss\"\n    model_name: \"gpt-oss:20b\"\n    system_prompt: |\n      You are an expert AI assistant specializing in information retrieval.\n      ...\n</code></pre> Please see this page for details on configuring agents. In addition to the values described there, note that the <code>id</code> element is required here.</p>"},{"location":"soliplex/config/installation/#thread-persistence-dburi","title":"Thread Persistence DBURI","text":"<p>An installation can define two DBURIs for the database used to store AG-UI threads, runs, events, etc.</p>"},{"location":"soliplex/config/installation/#synchronous-dburi","title":"Synchronous DBURI","text":"<p>One DBURI is for sync usage, e.g.  within console scripts.  Examples:</p> <ul> <li><code>sqlite://</code></li> <li><code>postgresql+psycopg2://user:&lt;password&gt;@dbhost/dbname</code></li> </ul>"},{"location":"soliplex/config/installation/#asynchronous-dburi","title":"Asynchronous DBURI","text":"<p>The other DBURI is for async usage, e.g. within the Soliplex server process.  Examples:</p> <ul> <li><code>sqlite+aiosqlite://</code></li> <li><code>postgresql+asyncpg://user:&lt;password&gt;@dbhost/dbname</code></li> </ul> <p>This DBURI must be compatible with SQLAlchemy's asyncio extension. Dialects known to work include:</p> <ul> <li><code>aiosqlite</code></li> <li><code>asyncpg</code></li> </ul>"},{"location":"soliplex/config/installation/#default-configuration","title":"Default configuration","text":"<p>By default, Soliplex configures thread persistence using in-memory DBURIS:</p> <ul> <li>For sync use, <code>sqlite</code> (DBURI <code>sqlite://</code>)</li> <li>For async use, <code>aiosqlite</code> (DBURI <code>sqlite+aiosqlite://</code>)</li> </ul> <p>The default configuration is equivalent to this explicit YAML:</p> <pre><code>thread_persistence_dburi:\n  sync: \"sqlite://\"\n  async: \"sqlite+aiosqlite://\"\n</code></pre>"},{"location":"soliplex/config/installation/#database-passwords-as-secrets","title":"Database passwords as secrets","text":"<p>For DBURIs requiring authentication, we would rather not expose the password in plain-text configuration.  In this case, we can define a Soliplex secret (read here), and use that secret in the DBURI.</p> <pre><code>secrets:\n    - secret_name: MY_DBURI_SECRET\n      # Configure sources here\n...\n\nthread_persistence_dburi:\n  sync: \"postgresql+psycopg2://user:secret:MY_DBURI_SECRET@dbhost/dbname\"\n  async: \"postgresql+asyncpg://user:secret:MY_DBURI_SECRET@dbhost/dbname\"\n</code></pre>"},{"location":"soliplex/config/installation/#oidc-auth-provider-paths","title":"OIDC Auth Provider Paths","text":"<p>The <code>oidc_paths</code> element specifies one or more filesystem paths to be searched for OIDC provider configs.</p> <p>Please see this page for details on how to configure these providers.</p> <pre><code>oidc_paths:\n  - \"/path/to/oidc/config/dir\"\n</code></pre> <p>Non-absolute paths will be evaluated relative to the installation directory.</p> <p>By default, Soliplex loads provider configurations found under the path './oicd', just as though we had configured:</p> <pre><code>oidc_paths:\n  - \"./oidc\"\n</code></pre> <p>To disable authentication, list a single, \"null\" path, e.g.: <pre><code>oidc_paths:\n  -\n</code></pre> Or else run 'soliplex-cli serve --no-auth-mode'</p>"},{"location":"soliplex/config/installation/#room-configuration-paths","title":"Room Configuration Paths","text":"<p>The <code>room_paths</code> element specify one or more filesystem paths to search for room configs.</p> <p>Please see this page for details on how to configure these providers.</p> <p>Each path can be either:</p> <ul> <li> <p>a directory containing its own <code>room_config.yaml</code> file:  this directory   will be mapped as a single room.</p> </li> <li> <p>a directory whose immediate subdirectories will be treated as rooms   IFF they contain a <code>room_config.yaml</code> file.</p> </li> </ul> <p>Non-absolute paths are evaluated relative to the installation directory.</p> <p>The order of <code>room_paths</code> in this list controls which room configuration is used for any conflict on room ID:  rooms found earlier in the list \"win\" over later ones with the same ID.</p> <p>By default, Soliplex loads room configurations found under the path './rooms', just as though we had configured:</p> <p><pre><code>room_paths:\n  - \"./rooms\"\n</code></pre> To disable all rooms, list a single, \"null\" path, e.g.:</p> <pre><code>room_paths:\n   -\n</code></pre>"},{"location":"soliplex/config/installation/#completion-configuration-paths","title":"Completion Configuration Paths","text":"<p>The <code>completion_paths</code> entry specifies one or more filesystem paths to search for completion configs.</p> <p>Please see this page for details on how to configure these providers.</p> <p>Each path can be either:</p> <ul> <li> <p>a directory containing its own <code>completion_config.yaml</code> file:  this   directory will be mapped as a single completion.</p> </li> <li> <p>a directory whose immediate subdirectories will be treated as rooms   IFF they contain a <code>room_config.yaml</code> file.</p> </li> </ul> <p>Non-absolute paths will be evaluated relative to the installation directory.</p> <p>The order of entries in the <code>completion_paths</code> list controls which completion configuration is used for any conflict on completion ID:  completions found earlier in the list \"win\" over later ones with the same ID.</p> <p>By default, Soliplex loads completion configurations found under the path './completions', just as though we had configured:</p> <pre><code>completion_paths:\n  - \"./completions\"\n</code></pre> <p>To disable all completions, list a single, \"null\" path, e.g.: <pre><code>completion_paths:\n  -\n</code></pre></p>"},{"location":"soliplex/config/meta/","title":"Installation Metaconfiguration","text":"<p>The <code>meta</code> section of an installation configuration enables registration of custom \"kinds\" of entities (tool configurations, MCP client toolset configurations, etc.), so that they can be used within the rest of the installation.</p> <p>E.g., registering a new tool configuration class in the <code>meta.tool_configs</code> section allows use of that class when configuring a custom tool in a given room.</p>"},{"location":"soliplex/config/meta/#registering-ag-ui-feature-classes","title":"Registering AG-UI Feature Classes","text":"<p>The <code>meta.agui_features</code> section registers AG-UI feature types so that they can be referenced by their <code>name</code>.  Each feature is a contract between the client application and the server, defining the schema for a named field in the AG-UI state, and which parties are expected to write to that field.</p> <p>The section contains a list of mappings, each of which include:</p> <ul> <li> <p><code>name</code>, a string identifying the field in the AG-UI state.</p> </li> <li> <p><code>model_klass</code>, a Python \"dotted name\" which can be used to import the    model class which defines the field's schema.</p> </li> <li> <p><code>source</code> (optional), a  key indicating which party is allowed to set   the feature's field in the AG-UI state. Allowed values are \"client\",   \"server\", and \"either\";  the default is \"either\".</p> </li> </ul> <p>By default, Soliplex registers its own AG-UI feature classes, just as though we configured explicitly:</p> <pre><code>meta:\n  agui_features:\n\n  - name: \"filter_documents\"\n    model_klass: \"soliplex.agui.features.FilterDocuments\"\n    source: \"client\"\n\n  - name: \"ask_history\"\n    model_klass: \"soliplex.agui.features.AskedAndAnswered\"\n    source: \"server\"\n</code></pre>"},{"location":"soliplex/config/meta/#registering-tool-configuration-classes","title":"Registering Tool Configuration Classes","text":"<p>The <code>meta.tool_configs</code> section enumerates tool configuration types so that they can be referenced by their <code>tool_name</code>.</p> <p>The section contains a list of Python \"dotted names\", i.e. strings which can be used to import the configuration class.</p> <p>By default, Soliplex registers its own tool config classes, just as though we configured explicitly:</p> <pre><code>meta:\n  tool_configs:\n  - \"soliplex.config.SearchDocumentsToolConfig\"\n</code></pre>"},{"location":"soliplex/config/meta/#registering-mcp-client-toolset-configuration-classes","title":"Registering MCP Client Toolset Configuration Classes","text":"<p>The <code>meta.mcp_toolset_configs</code> section enumerates MCP client toolset configuration types so that they can be referenced by their 'kind'.</p> <p>The section contains a list of Python \"dotted names\", i.e. strings which can be used to import the configuration class.</p> <p>By default, Soliplex registers its own tool config classes, just as though we configured explicitly:</p> <pre><code>meta:\n  mcp_toolset_configs:\n  - \"soliplex.config.Stdio_MCP_ClientToolsetConfig\"\n  - \"soliplex.config.HTTP_MCP_ClientToolsetConfig\"\n</code></pre>"},{"location":"soliplex/config/meta/#registering-mcp-server-tool-wrapper-types","title":"Registering MCP Server Tool Wrapper Types","text":"<p>The <code>meta.mcp_server_tool_wrappers</code> section maps tool configuration classes to the equivalent wrapper class, used then offering the tool to external MCP clients.</p> <p>The section contains a list of mappings with keys <code>config_klass</code> and <code>wrapper_klass</code>.  Values for both keys Python \"dotted names\", i.e. strings which can be used to import the corresponding class.</p> <p>By default, Soliplex configures its 'soliplex.config.WithQueryMCPWrapper' as the wrapper for 'soliplex.config.SearchDocumentsToolConfig', just as if we configured here:</p> <pre><code>meta:\n  mcp_server_tool_wrappers:\n  - config_klass: \"soliplex.config.SearchDocumentsToolConfig\"\n    wrapper_klass: \"soliplex.config.WithQueryMCPWrapper\"\n</code></pre>"},{"location":"soliplex/config/meta/#registering-agent-configuration-classes","title":"Registering Agent Configuration Classes","text":"<p>The <code>meta.agent_configs</code> section enumerates agent configuration types so that they can be referenced by their <code>kind</code>.</p> <p>The section contains a list of Python \"dotted names\", i.e. strings which can be used to import the configuration class.</p> <p>By default, Soliplex registers its own agent config class, just as though we configured explicitly:</p> <pre><code>meta:\n  tool_configs:\n  - \"soliplex.config.AgentConfig\"\n</code></pre>"},{"location":"soliplex/config/meta/#registering-secret-source-configurations","title":"Registering Secret Source Configurations","text":"<p>Each installation secret can be configured with multiple \"sources\" of different kinds. Each source configuration kind corresponds to a Python function which is used to retrieve the secret value.</p> <p>The <code>meta.secret_sources</code> section allows configuring new secret source configurations and their corresponding functions.</p> <p>By default, these classes are configured to use the corresponding functions in 'soliplex.secrets', just as if we configured here:</p> <pre><code>meta:\n  secret_sources:\n  - config_klass: \"soliplex.config.EnvVarSecretSource\"\n    registered_func: \"soliplex.secrets.get_env_var_secret\"\n  - config_klass: \"soliplex.config.FilePathSecretSource\"\n    registered_func: \"soliplex.secrets.get_file_path_secret\"\n  - config_klass: \"soliplex.config.SubprocessSecretSource\"\n    registered_func: \"soliplex.secrets.get_subprocess_secret\"\n  - config_klass: \"soliplex.config.RandomCharsSecretSource\"\n    registered_func: \"soliplex.secrets.get_random_chars_secret\"\n</code></pre>"},{"location":"soliplex/config/oidc_providers/","title":"OIDC Provider Configuration","text":"<p>The <code>config.yaml</code> file in an OIDC provider configuration directory specifies one or more authentication systems, sharing a common CA certificate store:</p> <pre><code>oidc_client_pem_path: \"./cacert.pem\"\n\nauth_systems:\n\n  - id: \"myprovder\"\n    title: \"Authenticate with MyProovider\"\n    server_url: \"https://oidc.excample.com/\"\n    client_id: \"myprovider-token-service\"\n    client_secret: \"\"  # \"secret:{MYPROVIDER_CLIENT_SECRET}\"\n    scope: \"openid email profile\"\n    token_validation_pem: |\n        -----BEGIN PUBLIC KEY-----\n        MII..AQAB\n        -----END PUBLIC KEY-----\n</code></pre>"},{"location":"soliplex/config/oidc_providers/#required-configuration-elements","title":"Required Configuration Elements","text":"<ul> <li><code>authsystems</code> is a list of one or more OIDC provider configurations   (see below).</li> </ul>"},{"location":"soliplex/config/oidc_providers/#optional-configuration-elements","title":"Optional Configuration Elements","text":"<ul> <li><code>oidc_client_pem_path</code> points to a file on the filesystem containing   the shared CA certificate store.  If not configured, the Soliplex   application will use systemwide default CA certificates.</li> </ul>"},{"location":"soliplex/config/oidc_providers/#required-oidc-provider-elements","title":"Required OIDC Provider Elements","text":"<ul> <li> <p><code>id</code>: a string, should be unique across all configured providers</p> </li> <li> <p><code>title</code>: a string, might be displayed by a client</p> </li> <li> <p><code>server_url</code>: URL for initiating the token auth flow.</p> </li> <li> <p><code>token_validation_pem</code>: a string, the public key used to verify    the providers tokens.</p> </li> <li> <p><code>client_id</code>: a string identifying the client to the provider.</p> </li> </ul>"},{"location":"soliplex/config/oidc_providers/#optional-oidc-provider-elements","title":"Optional OIDC Provider Elements","text":"<ul> <li> <p><code>client_secret</code>: a string;  if not empty, should be in the form   <code>\"secret:MYPROVIDER_CLIENT_SECRET\"</code>, where the name following the   <code>secret:</code> prefix is the name of a configured installation secret   (see this page for details).</p> </li> <li> <p><code>scope</code>: string, an OAuth scope specifier.</p> </li> </ul>"},{"location":"soliplex/config/quizzes/","title":"Quiz Datasets","text":"<p>Quizzes use the evaluation dataset entries (see the schema).</p>"},{"location":"soliplex/config/quizzes/#room-configuration","title":"Room Configuration","text":"<ul> <li>Room configurations get a new key, <code>quizzes</code>, with a value which   is a mapping defining quizzes which can be run in the room   (see <code>rooms/README.md</code>).</li> </ul>"},{"location":"soliplex/config/quizzes/#api","title":"API","text":""},{"location":"soliplex/config/quizzes/#get-apiv1rooms","title":"<code>GET /api/v1/rooms</code>","text":"<p>Room config entries in the response include the value of <code>quizzes</code> (a list of mappings).</p>"},{"location":"soliplex/config/quizzes/#get-apiv1roomsroom_id","title":"<code>GET /api/v1/rooms/{room_id}</code>","text":"<p>Response includes  the value of <code>quizzes</code> (a list of mappings).</p>"},{"location":"soliplex/config/quizzes/#get-apiv1roomsroom_idquizquiz_id","title":"<code>GET /api/v1/rooms/{room_id}/quiz/{quiz_id}</code>","text":"<p>Fetch the quiz.  Returns a mapping for the quiz with a list of questions:</p> <pre><code>{\n    \"id\": \"&lt;quiz_id&gt;\",\n    \"questions\": [\n        {\n            \"uuid\": \"&lt;question_uuid&gt;\",\n            \"inputs\": \"What color is the sky? (QA)\",\n            \"metadata\": {\n                \"type\": \"qa\"\n            }\n        },\n        {\n            \"uuid\": \"&lt;question_uuid&gt;\",\n            \"inputs\": \"The color of the sky is _____\",\n            \"metadata\": {\n                \"type\": \"fill-blank\"\n            }\n        },\n        {\n            \"uuid\": \"&lt;question_uuid&gt;\",\n            \"inputs\": \"Is the sky blue?\",\n            \"metadata\": {\n                \"type\": \"multiple-choice\",\n                \"options\": {\n                    \"true\",\n                    \"false\"\n                }\n            }\n        },\n        {\n            \"uuid\": \"&lt;question_uuid&gt;\",\n            \"inputs\": \"What color is the sky? (MC)\",\n            \"metadata\": {\n                \"type\": \"multiple-choice\",\n                \"options\": {\n                    \"red\",\n                    \"green\",\n                    \"blue\"\n                }\n            }\n        },\n    ...\n    ]\n}\n</code></pre> <ul> <li> <p><code>question-type</code> is one of <code>\"qa\"</code>, <code>\"fill-blank\"</code>, or <code>\"multiple-choice\"</code></p> </li> <li> <p>Questions of type <code>\"multiple-choice\"</code> contain an additional entry,   <code>\"options\"</code> in their metadata, whose value is a list of strings.</p> </li> </ul>"},{"location":"soliplex/config/quizzes/#post-apiv1roomsroom_idquizquiz_idquestion_uuid","title":"<code>POST /api/v1/rooms/{room_id}/quiz/{quiz_id}/{question_uuid}</code>","text":"<p>Check an answer.  Client should send the answer entered / selected by the user as a <code>text/plain</code> body.  For a correct answer, returns:</p> <pre><code>{\n    \"correct\": \"true\"\n}\n</code></pre> <p>For an incorrect answer, returns: <pre><code>{\n    \"correct\": \"false\"\n    \"expected_output\": \"&lt;expected_output&gt;\"\n}\n</code></pre></p> <p>(Later, this response might include more information, such as a citation).</p>"},{"location":"soliplex/config/rag/","title":"<code>haiku-rag</code> Client Configuration","text":"<p>In order to use its RAG database(s) (see this page for how to create them), Soliplex installation uses <code>haiku.rag</code> as a library, creating instances of <code>haiku.rag.client.HaikuRag</code> client class as needed.</p> <p>NOTE:  the <code>embeddings</code> configuration used to create the RAG database            must match the client configuration used to read the database.</p> <p>The configuration used to create these client instances can be defined in two places:</p>"},{"location":"soliplex/config/rag/#global-configuration","title":"Global Configuration","text":"<p>The default <code>haiku-rag</code> configuration for an installation lives in a seprate file, <code>haiku.rag.yaml</code>, which is located by default in the installation directory (next to the main installation config file).</p> <p>See the <code>haiku-rag</code> docs for the format and semantics of this file.</p>"},{"location":"soliplex/config/rag/#room-level-and-completion-level-configuration","title":"Room-level and Completion-level Configuration","text":"<p>Rooms and completions which use the <code>soliplex.tools.search_documents</code> tool can also define a <code>haiku.rag.yaml</code> file, next to their own config files.  Soliplex overlays any configuration defined in such files on top of the global configuration when using the tool.</p> <p>E.g., to override only the reranking used by <code>haiku-rag</code> in a given room:</p> <pre><code>reranking:\n  model:\n    name: \"gpt-oss:20b\"\n    provider: \"ollama\"\n</code></pre>"},{"location":"soliplex/config/rooms/","title":"Room Configuration Filesystem Layout","text":"<p>A room is configured via a directory, whose name is the room ID.</p> <p>NOTE: directories whose names start with '.' are ignored.</p> <p>Within that directory should be one or two files:</p> <ul> <li> <p><code>room_config.yaml</code> holds metadata about the room (see below)</p> </li> <li> <p><code>prompt.txt</code> (if present) holds the system prompt for conversations   which are initiated from the room.</p> </li> </ul> <p>Example layout without external prompt file: <pre><code>simple/\n    room_config.yaml\n</code></pre></p> <pre><code>chat/\n    prompt.txt\n    room_config.yaml\n</code></pre>"},{"location":"soliplex/config/rooms/#room-configuration-file-schema","title":"Room Configuration File Schema","text":""},{"location":"soliplex/config/rooms/#required-room-elements","title":"Required room elements","text":"<p>The <code>room_config.yaml</code>  file should be a mapping, with at least the following required elements:</p> <ul> <li> <p><code>id</code> (a string) should match the name of the room's directory.</p> </li> <li> <p><code>name</code> (a string) is the \"title\" of the room, as would be shown in a list.</p> </li> <li> <p><code>description</code> (a string) tells the purpose of the room:  it might show up   as the \"lede\" graph (below the <code>name</code>) in a list of rooms.</p> </li> <li> <p><code>agent</code> (a mapping, see next section)</p> </li> </ul> <p>A minimal room configuration must include the above elements, e.g.:</p> <pre><code>id: \"chat\"\nname: \"Chatting Darkly\"\ndescription: \"Scanning for conversations\"\nagent:\n  system_prompt: |\n      You are an..... #\n</code></pre>"},{"location":"soliplex/config/rooms/#optional-room-elements-ui-related","title":"Optional room elements (UI-related):","text":"<ul> <li><code>welcome_message</code> (a string), for the UI to display when the user   enters a room.  E.g.:</li> </ul> <pre><code>welcome_message: &gt;\n    Welcome to the room.  We hope you find it useful\n\n    Please review the suggestions below for ideas on the kinds\n    of questions for which this room is intended.\n</code></pre> <ul> <li><code>suggestions</code> (a list of strings) contains possible \"starter questions\"   for the room, which the UI might display as shortcuts when the user   enters the room.  E.g.:</li> </ul> <pre><code>suggestions:\n  - \"How high is up?\"\n  - \"Why is the sky blue?\"\n</code></pre> <ul> <li><code>enable_attachments</code> (a boolean, default <code>False</code>), which, if true,    tells the UI to allow the user to attach files to a prompt. E.g.:</li> </ul> <pre><code>enable_attachments: true\n</code></pre>"},{"location":"soliplex/config/rooms/#agent-configuration","title":"Agent configuration","text":"<p>The <code>agent</code> mapping is used to configure the Pydantic AI agent used to make the room's calls to the LLM.</p> <pre><code>agent:\n    model_name: \"gpt-oss:latest\"\n    system_prompt: \"./prompt.txt\"\n</code></pre> <p>Please see this page for a full description of the options for configuring an agent.</p>"},{"location":"soliplex/config/rooms/#tool-configurations","title":"Tool Configurations","text":"<ul> <li><code>tools</code> should be a list of mappings, with at least the key   <code>tool_name</code>, whose value is a dotted name identifying a Python function    (or callable) which can serve as a \"tool\" for the LLM.  E.g.:</li> </ul> <p><pre><code>tools:\n    - tool_name: \"soliplex.tools.get_current_datetime\"\n    - tool_name: \"soliplex.tools.get_current_user\"\n</code></pre>   Each tool mapping can contain additional elements, which are used to    configure the tool's behavior.</p>"},{"location":"soliplex/config/rooms/#rag-search-related","title":"RAG / search-related","text":"<p>The <code>soliplex.tools.search_documents</code> tool takes a number of configuration values.  Exactly one of the following two elements is required:</p> <ul> <li><code>rag_lancedb_stem</code> is a string:  it should be the \"base name\" (without   path or <code>.lancedb</code> suffix) of the LanceDB file containing the RAG document   data for the tool. This file must exist in the \"standard\" location   (typically under the <code>db/rag/</code> directory;  see below).</li> </ul> <pre><code>rag_lancedb_stem: \"&lt;room_id&gt;\"\n</code></pre> <ul> <li><code>rag_lancedb_override_path</code> is a string:  it should be a fully-qualified   pathname, including the suffix, of the LanceDB directory containing the RAG   document data for the tool. </li> </ul> <pre><code>rag_lancedb_override_path: \"/&lt;path-to-rag-databases&gt;/&lt;room_id&gt;.&lt;extension&gt;\"\n</code></pre> <p>Other, optional elements for the <code>search_documents</code> tool:</p> <ul> <li><code>search_documents_limit</code> is a positive integer (default <code>5</code>), used to   control the number of results returned by the <code>search_documents</code> tool. E.g.:</li> </ul> <pre><code>search_documents_limit: 8\n</code></pre> <p>Minimal <code>search_documents</code> configuration, with RAG database file found in the standard location:</p> <pre><code>agent:\n  tools:\n    - tool_name: \"soliplex.tools.search_documents\"\n      rag_lancedb_stem: \"chat\"\n</code></pre> <p>Minimal <code>search_documents</code> configuration, with RAG database file found in an overridden location:</p> <pre><code>agent:\n  tools:\n    - tool_name: \"soliplex.tools.search_documents\"\n      rag_lancedb_override_path: \"/path/to/rag/db/filename.lancedb\"\n</code></pre> <p>Maximal <code>search_documents</code> configuration</p> <pre><code>agent:\n  tools:\n    - tool_name: \"soliplex.tools.search_documents\"\n      rag_lancedb_stem: \"chat\"\n      search_documents_limit: 8\n</code></pre>"},{"location":"soliplex/config/rooms/#quiz-related-elements","title":"Quiz-related elements","text":"<ul> <li><code>quizzes</code> is a list of mappings (default <code>()</code>):  each mapping defines a   quiz which can be run in the room (see this page for   details of the quiz dataset).</li> </ul> <pre><code>quizzes:\n  - id: \"test_quiz\"\n    title: \"Test Quiz\"\n    question_file: \"/path/to/questions.json\"\n    randomize: false\n    max_questions: 100\n</code></pre>"},{"location":"soliplex/config/rooms/#location-of-rag-database-files","title":"Location of RAG database files","text":"<p>Rooms using the <code>search_documents</code> tool need to be able to find the LanceDB database containing the chunks and embeddings extracted by Haiku-RAG.  At present, there should be a single database per room, named by convention <code>&lt;stem&gt;.lancedb</code>, and stored in the <code>db/rag/</code> subdirectory of the project root.</p>"},{"location":"soliplex/config/secrets/","title":"Configuring Installation Secrets","text":"<p>The <code>secrets</code> section of an installation configuration contains a list of secret names, and optionally their configured sources.</p> <p>The default configuration knows of four types of sources:</p> <ul> <li>Environment variables</li> <li>File paths</li> <li>Subprocess commands</li> <li>Randomly-generated strings</li> </ul>"},{"location":"soliplex/config/secrets/#secret-source-environment-variable","title":"Secret Source: Environment Variable","text":"<p>A secret source which uses an environment variable can be configured so:</p> <pre><code>secrets:\n   - secret_name: MY_SECRET\n     sources:\n     - kind: \"env_var\"\n       env_var_name: \"MY_SECRET_ENV_VAR_NAME\"\n</code></pre>"},{"location":"soliplex/config/secrets/#secret-source-filesystem-path","title":"Secret Source: Filesystem Path","text":"<p>A secret source which uses a file system path can be configured so:</p> <pre><code>secrets:\n   - secret_name: MY_SECRET\n     sources:\n     - kind: \"file_path\"\n       file_path: \"/run/secret/my_secret\"\n</code></pre>"},{"location":"soliplex/config/secrets/#secret-source-subprocess-command","title":"Secret Source: Subprocess Command","text":"<p>A secret source which uses a subprocess command can be configured so:</p> <pre><code>secrets:\n   - secret_name: MY_SECRET\n     sources:\n     - kind: \"subprocess\"\n       command: \"/usr/bin/fetch_secret\"\n       args:\n       - \"--secret-name=MY_SECRET\"\n</code></pre>"},{"location":"soliplex/config/secrets/#secret-source-randomly-generated-string","title":"Secret Source: Randomly-Generated String","text":"<p>A secret source which uses generates a random string at process startup can be configured so:</p> <pre><code>secrets:\n   - secret_name: MY_SECRET\n     sources:\n     - kind: \"random_chars\"\n       n_chars: 32\n</code></pre>"},{"location":"soliplex/config/secrets/#layering-secret-sources","title":"Layering Secret Sources","text":"<p>Sources are resolved in the order they are listed, with the first one returning a value winning.  This example layers an environment variable source with a random string source:</p> <pre><code>secrets:\n   - secret_name: MY_SECRET\n     sources:\n     - kind: \"env_var\"\n       env_var_name: \"MY_SECRET_ENV_VAR_NAME\"\n     - kind: \"random_chars\"\n       n_chars: 32\n</code></pre>"},{"location":"soliplex/config/secrets/#secrets-without-sources","title":"Secrets without Sources","text":"<p>Secrets which list no sources are treated as though they were configured using an environment variable source with the same name.</p> <p>This configuration:</p> <pre><code>secrets:\n    - secret_name: MY_SECRET\n</code></pre> <p>is equivalent to:</p> <pre><code>secrets:\n   - secret_name: MY_SECRET\n     sources:\n     - kind: \"env_var\"\n       env_var_name: \"MY_SECRET\"\n</code></pre>"},{"location":"soliplex/config/secrets/#secrets-as-bare-strings","title":"Secrets as Bare Strings","text":"<p>An even shorter way to spell the previous configuration:</p> <pre><code>secrets:\n   - \"MY_SECRET\"\n</code></pre>"},{"location":"soliplex/config/secrets/#checking-configured-secrets","title":"Checking Configured Secrets","text":"<p>The <code>soliplex-cli</code> application has a sub-command, <code>list-secrets</code>. It loads the configuration, attempts to resolve all the secrets, and reports those not found.  E.g.:</p> <pre><code>$ soliplex-cli list-secrets example/installation.yaml \n\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Configured secrets \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n- LOGFIRE_TOKEN             MISSING\n- SMITHERY_AI_API_KEY       MISSING\n- SMITHERY_AI_PROFILE       MISSING\n- URL_SAFE_TOKEN_SECRET     OK\n</code></pre>"}]}