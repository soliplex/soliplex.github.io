
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://soliplex.github.io/flutter/planning/specs/oidc_authentication/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>OIDC Authentication (AM7) - Soliplex</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#oidc-authentication-am7" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Soliplex" class="md-header__button md-logo" aria-label="Soliplex" data-md-component="logo">
      
  <img src="../../../../img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Soliplex
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OIDC Authentication (AM7)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 2C5.13 2 2 5.13 2 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7M6 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H6zm13-8h-2l-3.2 9h1.9l.7-2h3.2l.7 2h1.9zm-2.15 5.65L18 15l1.15 3.65z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="amber"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/soliplex/soliplex.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    soliplex/soliplex.github.io
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../soliplex/overview/" class="md-tabs__link">
          
  
  
    
  
  Core Platform

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../ingester/GETTING_STARTED/" class="md-tabs__link">
          
  
  
    
  
  Ingester

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../chatbot/readme/" class="md-tabs__link">
          
  
  
    
  
  User Interfaces

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../ingester-agents/" class="md-tabs__link">
          
  
  
    
  
  Supporting Tools

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Soliplex" class="md-nav__button md-logo" aria-label="Soliplex" data-md-component="logo">
      
  <img src="../../../../img/logo.png" alt="logo">

    </a>
    Soliplex
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/soliplex/soliplex.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    soliplex/soliplex.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Core Platform
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core Platform
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Setup
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Setup
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Client
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAG Database
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Configuration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/filesystem_layout/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Filesystem Layout
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/meta/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Meta
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Environment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/secrets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Secrets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/rooms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rooms
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/completions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Completions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/quizzes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quizzes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/config/oidc_providers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OIDC Authentication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../soliplex/usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Ingester
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ingester
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ingester/GETTING_STARTED/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ingester/ARCHITECTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ingester/API/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ingester/WORKFLOWS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Workflows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ingester/DATABASE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Database Schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ingester/CONFIGURATION/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../ingester/CLI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    User Interfaces
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Interfaces
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../chatbot/readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chatbot Widget
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/developer-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flutter UI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../ingester-agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Supporting Tools
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Supporting Tools
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../pdf-splitter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PDF Splitter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mvp-scope" class="md-nav__link">
    <span class="md-ellipsis">
      
        MVP Scope
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-core-vs-frontend-boundary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture: Core vs Frontend Boundary
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture: Core vs Frontend Boundary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#design-principle" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design Principle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-belongs-in-soliplex_client" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Belongs in soliplex_client
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-stays-in-flutter-frontend" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Stays in Flutter Frontend
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#naming-convention" class="md-nav__link">
    <span class="md-ellipsis">
      
        Naming Convention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-decorator-order-and-observability" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTP Decorator Order and Observability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#401-retry-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        401 Retry Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flow-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow Diagram
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migration-plan" class="md-nav__link">
    <span class="md-ellipsis">
      
        Migration Plan
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#system-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        System Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="System Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#full-architecture-diagram" class="md-nav__link">
    <span class="md-ellipsis">
      
        Full Architecture Diagram
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auth-components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Auth Components
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-observability" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTP Observability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#login-flow-sequence" class="md-nav__link">
    <span class="md-ellipsis">
      
        Login Flow Sequence
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logout-flow-sequence" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logout Flow Sequence
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backend Endpoints
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    <span class="md-ellipsis">
      
        Models
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authstate" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuthState
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nullable-fields-and-boundaries" class="md-nav__link">
    <span class="md-ellipsis">
      
        Nullable Fields and Boundaries
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oidcissuer" class="md-nav__link">
    <span class="md-ellipsis">
      
        OidcIssuer
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#providers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Providers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Providers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authnotifier" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuthNotifier
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#platform-auth-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Platform Auth Flow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Platform Auth Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mvp-iosmacos-direct-oidc-via-flutter_appauth" class="md-nav__link">
    <span class="md-ellipsis">
      
        MVP: iOS/macOS (Direct OIDC via flutter_appauth)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-mvp-desktop-windows-linux" class="md-nav__link">
    <span class="md-ellipsis">
      
        Post-MVP: Desktop (Windows, Linux)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#post-mvp-web" class="md-nav__link">
    <span class="md-ellipsis">
      
        Post-MVP: Web
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTP Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HTTP Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#token-injection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Token Injection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#401-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        401 Handling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-observer-filtering" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTP Observer Filtering
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#router-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Router Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Router Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#routes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Routes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redirect-guard" class="md-nav__link">
    <span class="md-ellipsis">
      
        Redirect Guard
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#startup-ux" class="md-nav__link">
    <span class="md-ellipsis">
      
        Startup UX
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#secure-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Secure Storage
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token-refresh-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Token Refresh Strategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Token Refresh Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-refresh-failure-handling-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Token Refresh Failure Handling Policy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Token Refresh Failure Handling Policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#startup-session-restore" class="md-nav__link">
    <span class="md-ellipsis">
      
        Startup (Session Restore)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#runtime-active-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        Runtime (Active Session)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-not-align-both-to-the-same-policy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why Not Align Both to the Same Policy?
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deployment Requirements
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Requirements
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-slices-vertical" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Slices (Vertical)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Slices (Vertical)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spike-validate-direct-oidc-on-macos-ios" class="md-nav__link">
    <span class="md-ellipsis">
      
        Spike: Validate Direct OIDC on macOS + iOS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slice-1-walking-skeleton-http-filtering" class="md-nav__link">
    <span class="md-ellipsis">
      
        Slice 1: Walking Skeleton + HTTP Filtering
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slice-2-session-persistence" class="md-nav__link">
    <span class="md-ellipsis">
      
        Slice 2: Session Persistence
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slice-3-token-refresh-401-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      
        Slice 3: Token Refresh + 401 Recovery
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dependencies
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-plan" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test Plan
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unit Tests
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#widget-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Widget Tests
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-tests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration Tests
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#file-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        File Structure
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#component-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Component Summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resolved-questions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Resolved Questions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web-platform-support-deferred" class="md-nav__link">
    <span class="md-ellipsis">
      
        Web Platform Support (Deferred)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Web Platform Support (Deferred)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backend-for-frontend-bff-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backend-For-Frontend (BFF) Pattern
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Requirements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estimated-effort" class="md-nav__link">
    <span class="md-ellipsis">
      
        Estimated Effort
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deferred-items" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deferred Items
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-progress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Progress
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Progress">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spike-status-complete" class="md-nav__link">
    <span class="md-ellipsis">
      
        Spike Status: ✅ Complete
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slice-1-status-complete" class="md-nav__link">
    <span class="md-ellipsis">
      
        Slice 1 Status: ✅ Complete
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slice-2-status-complete" class="md-nav__link">
    <span class="md-ellipsis">
      
        Slice 2 Status: ✅ Complete
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slice-3-status-complete" class="md-nav__link">
    <span class="md-ellipsis">
      
        Slice 3 Status: ✅ Complete
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#router-navigation-preservation-fix-2026-01-06" class="md-nav__link">
    <span class="md-ellipsis">
      
        Router Navigation Preservation Fix (2026-01-06)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remaining-work" class="md-nav__link">
    <span class="md-ellipsis">
      
        Remaining Work
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="oidc-authentication-am7">OIDC Authentication (AM7)</h1>
<p>Cross-platform OIDC authentication using direct OIDC flow via <code>flutter_appauth</code>.</p>
<blockquote>
<p><strong>Implementation Note</strong>: Keep this document updated as implementation progresses.
If context is lost and work needs to resume, this document serves as the source of
truth for decisions made and current status. Update the "Implementation Progress"
section below after completing each slice.</p>
</blockquote>
<h2 id="overview">Overview</h2>
<p>The app authenticates directly with the IdP (Keycloak) using <code>flutter_appauth</code>.
Backend provides IdP configuration but does not participate in the OAuth flow.</p>
<p><strong>Flow:</strong></p>
<ol>
<li>Discover IdP configuration via <code>GET /api/login</code> → <code>{ server_url, client_id, scope }</code></li>
<li><code>flutter_appauth</code> handles full OAuth flow:</li>
<li>Opens system browser to IdP authorization endpoint</li>
<li>User authenticates with IdP</li>
<li>IdP redirects to app with authorization code</li>
<li><code>flutter_appauth</code> exchanges code for tokens (PKCE handled automatically)</li>
<li>Store tokens securely (Keychain on iOS/macOS)</li>
<li>Add <code>Authorization: Bearer {token}</code> to API requests</li>
<li>Refresh tokens before expiry (direct to IdP token endpoint)</li>
</ol>
<h2 id="mvp-scope">MVP Scope</h2>
<p><strong>In scope (MVP):</strong></p>
<ul>
<li>macOS (primary development/test platform)</li>
<li>iOS</li>
</ul>
<p><strong>Deferred (post-MVP):</strong></p>
<ul>
<li>Windows/Linux (loopback server complexity)</li>
<li>Web (different security model, CORS complexity)</li>
</ul>
<h2 id="architecture-core-vs-frontend-boundary">Architecture: Core vs Frontend Boundary</h2>
<p><code>soliplex_client</code> (future: <code>soliplex_core</code>) must remain frontend-agnostic to support
swappable frontends (Flutter, CLI, potentially others). Both Flutter and CLI will use
OIDC authentication.</p>
<h3 id="design-principle">Design Principle</h3>
<p><strong>Core is a "dumb pipe"</strong> that:</p>
<ul>
<li>Fetches auth configuration from the backend (menu of options)</li>
<li>Attaches tokens to HTTP requests</li>
<li>Does NOT know how tokens are obtained or refreshed</li>
</ul>
<p><strong>Frontend handles:</strong></p>
<ul>
<li>Interpreting auth configuration (e.g., recognizing it as OIDC)</li>
<li>Running platform-specific auth flows (flutter_appauth, device code, etc.)</li>
<li>Token storage and refresh orchestration</li>
<li>Providing tokens to core</li>
</ul>
<h3 id="what-belongs-in-soliplex_client">What Belongs in <code>soliplex_client</code></h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuthProviderConfig</code></td>
<td>Pure data class describing backend's <code>/api/login</code> response. Agnostic to auth type.</td>
</tr>
<tr>
<td><code>AuthenticatedHttpClient</code></td>
<td>Decorator that injects <code>Authorization: Bearer</code> header. Pure Dart, no platform deps.</td>
</tr>
<tr>
<td><code>fetchAuthProviders()</code></td>
<td>API call to <code>/api/login</code>. Just fetches config, doesn't interpret it.</td>
</tr>
</tbody>
</table>
<p><strong>AuthProviderConfig</strong> (explicit OIDC fields for MVP):</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">/// Auth provider configuration from /api/login.</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nd">@immutable</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kd">class</span><span class="w"> </span><span class="nc">AuthProviderConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">AuthProviderConfig</span><span class="p">({</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">serverUrl</span><span class="p">,</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">clientId</span><span class="p">,</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">scope</span><span class="p">,</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">  </span><span class="p">});</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">serverUrl</span><span class="p">;</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">clientId</span><span class="p">;</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">scope</span><span class="p">;</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="p">}</span>
</span></code></pre></div>
<blockquote>
<p><strong>YAGNI Note</strong>: The original design proposed generic <code>type</code> + <code>metadata</code> fields
for future extensibility (SAML, etc.). The implementation uses explicit OIDC
fields since that's all we support. If non-OIDC providers are needed later,
refactor to a sealed class hierarchy.</p>
</blockquote>
<p><strong>AuthenticatedHttpClient</strong> (single responsibility: add tokens, no retry):</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">/// Decorates HTTP client with Bearer token injection.</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="c1">/// Does NOT handle 401 retry - that&#39;s the orchestration layer&#39;s job.</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kd">class</span><span class="w"> </span><span class="nc">AuthenticatedHttpClient</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">SoliplexHttpClient</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">  </span><span class="n">AuthenticatedHttpClient</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">_inner</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">_getToken</span><span class="p">);</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">SoliplexHttpClient</span><span class="w"> </span><span class="n">_inner</span><span class="p">;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="o">?</span><span class="w"> </span><span class="kt">Function</span><span class="p">()</span><span class="w"> </span><span class="n">_getToken</span><span class="p">;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">  </span><span class="nd">@override</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">  </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_getToken</span><span class="p">();</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="p">{...</span><span class="o">?</span><span class="n">existingHeaders</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Authorization&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Bearer </span><span class="si">$</span><span class="n">token</span><span class="s1">&#39;</span><span class="p">}</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">existingHeaders</span><span class="p">;</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_inner</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">uri</span><span class="p">,</span><span class="w"> </span><span class="nl">headers:</span><span class="w"> </span><span class="n">headers</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="what-stays-in-flutter-frontend">What Stays in Flutter Frontend</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OidcIssuer</code></td>
<td>Frontend-specific interpretation of <code>AuthProviderConfig</code> for OIDC.</td>
</tr>
<tr>
<td><code>AuthState</code> sealed class</td>
<td>State management is frontend-specific (Riverpod). CLI may use different patterns.</td>
</tr>
<tr>
<td><code>authenticate()</code></td>
<td>Uses <code>flutter_appauth</code>. CLI would use device code flow.</td>
</tr>
<tr>
<td><code>AuthNotifier</code></td>
<td>Riverpod-specific state management + 401 retry orchestration.</td>
</tr>
<tr>
<td>Token storage</td>
<td><code>flutter_secure_storage</code> is platform-specific.</td>
</tr>
<tr>
<td>Refresh orchestration</td>
<td>When/how to refresh differs per frontend UX.</td>
</tr>
</tbody>
</table>
<h3 id="naming-convention">Naming Convention</h3>
<p>Avoid <code>*Provider</code> suffix in <code>soliplex_client</code> to prevent confusion with Riverpod's
<code>Provider</code> terminology. Use inline function types:</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// Preferred: inline type</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="o">?</span><span class="w"> </span><span class="kt">Function</span><span class="p">()</span><span class="w"> </span><span class="n">_getToken</span><span class="p">;</span>
</span></code></pre></div>
<h3 id="http-decorator-order-and-observability">HTTP Decorator Order and Observability</h3>
<p><strong>Wrapping hierarchy:</strong> <code>Refreshing(Authenticated(Observable(Platform)))</code></p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1">// 1. Platform client (innermost)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kd">final</span><span class="w"> </span><span class="n">platform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createPlatformClient</span><span class="p">();</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1">// 2. Observable wraps Platform</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="kd">final</span><span class="w"> </span><span class="n">observable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObservableHttpClient</span><span class="p">(</span><span class="nl">client:</span><span class="w"> </span><span class="n">platform</span><span class="p">,</span><span class="w"> </span><span class="nl">observers:</span><span class="w"> </span><span class="p">[...]);</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="c1">// 3. Authenticated wraps Observable</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="kd">final</span><span class="w"> </span><span class="n">authenticated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AuthenticatedHttpClient</span><span class="p">(</span><span class="nl">client:</span><span class="w"> </span><span class="n">observable</span><span class="p">,</span><span class="w"> </span><span class="nl">getToken:</span><span class="w"> </span><span class="p">...);</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="c1">// 4. Refreshing wraps Authenticated (outermost)</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="kd">final</span><span class="w"> </span><span class="n">refreshing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RefreshingHttpClient</span><span class="p">(</span><span class="nl">inner:</span><span class="w"> </span><span class="n">authenticated</span><span class="p">,</span><span class="w"> </span><span class="nl">refresher:</span><span class="w"> </span><span class="n">authNotifier</span><span class="p">);</span>
</span></code></pre></div>
<p><strong>Call order for requests:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Caller
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>  ↓ refreshing.request()
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>Refreshing checks needsRefresh, proactively refreshes if needed
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>  ↓ authenticated.request()
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>Authenticated adds token to headers
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>  ↓ observable.request()
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>Observable logs request (WITH auth headers)
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>  ↓ platform.request()
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>Platform sends over wire
</span></code></pre></div>
<p><strong>Response order:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>Platform receives response
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>  ↓
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>Observable logs response (sees 401s, all errors)
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>  ↓
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>Authenticated returns response
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>  ↓
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>Refreshing checks for 401, refreshes and retries ONCE if needed
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>  ↓
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>Caller
</span></code></pre></div>
<p><strong>Why this order:</strong></p>
<ul>
<li>Observer sees requests WITH auth headers (accurate logging)</li>
<li>Observer sees all responses including 401s</li>
<li>RefreshingHttpClient handles retry at the outermost layer</li>
<li>Single retry limit prevents infinite loops (CWE-834)</li>
</ul>
<h3 id="401-retry-architecture">401 Retry Architecture</h3>
<p><strong>Key decision:</strong> <code>AuthenticatedHttpClient</code> does NOT retry. It only adds tokens.
<code>RefreshingHttpClient</code> handles all refresh and retry logic as a separate decorator.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>1. Original request → Refreshing → Authenticated → Observable → Platform
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>2. 401 response     ← (observer sees this)
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>3. RefreshingHttpClient triggers refresh via TokenRefresher interface
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>4. Refresh request  → Observable → Platform (uses base client, not authenticated)
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>5. Refresh response ← (observer sees this)
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>6. RefreshingHttpClient retries original request (retried=true prevents loops)
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>7. Retry request    → Refreshing → Authenticated → Observable → Platform
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>8. Final response   ← (observer sees this)
</span></code></pre></div>
<p><strong>Observer sees all HTTP calls.</strong> No visibility is lost.</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">// RefreshingHttpClient - HTTP decorator layer</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kd">class</span><span class="w"> </span><span class="nc">RefreshingHttpClient</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">SoliplexHttpClient</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">SoliplexHttpClient</span><span class="w"> </span><span class="n">_inner</span><span class="p">;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">TokenRefresher</span><span class="w"> </span><span class="n">_refresher</span><span class="p">;</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">  </span><span class="n">Completer</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;?</span><span class="w"> </span><span class="n">_refreshInProgress</span><span class="p">;</span><span class="w">  </span><span class="c1">// Dedupes concurrent refreshes</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">  </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">(...)</span><span class="w"> </span><span class="kd">async</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="kd">await</span><span class="w"> </span><span class="n">_refresher</span><span class="p">.</span><span class="n">refreshIfExpiringSoon</span><span class="p">();</span><span class="w">  </span><span class="c1">// Proactive refresh</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_executeWithRetry</span><span class="p">(...,</span><span class="w"> </span><span class="nl">retried:</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">  </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="n">_executeWithRetry</span><span class="p">(...,</span><span class="w"> </span><span class="p">{</span><span class="kd">required</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">retried</span><span class="p">})</span><span class="w"> </span><span class="kd">async</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">await</span><span class="w"> </span><span class="n">_inner</span><span class="p">.</span><span class="n">request</span><span class="p">(...);</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="c1">// On 401, attempt refresh and retry ONCE (CWE-834 prevention)</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">statusCode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">401</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">retried</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kd">await</span><span class="w"> </span><span class="n">_tryRefreshOnce</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_executeWithRetry</span><span class="p">(...,</span><span class="w"> </span><span class="nl">retried:</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">;</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Security controls:</strong></p>
<ul>
<li>Single retry limit via <code>retried</code> flag prevents infinite 401→refresh→401 loops (CWE-834)</li>
<li>Completer pattern deduplicates concurrent refresh attempts</li>
<li>Refresh uses base HTTP client (not authenticated) to avoid refresh token loops</li>
</ul>
<h3 id="flow-diagram">Flow Diagram</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>┌──────────────────────────────────────────────────────────────────────────┐
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>│                          soliplex_client (core)                          │
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>│                                                                          │
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>│  Defines abstractions:                                                   │
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>│    • TokenRefresher (interface)                                          │
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>│    • String? Function() (token getter signature)                         │
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>│                                                                          │
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>│  fetchAuthProviders() ──► List&lt;AuthProviderConfig&gt;                       │
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>│                                                                          │
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>│  ┌────────────────────────────────────────────────────────────────────┐  │
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>│  │ RefreshingHttpClient                                               │  │
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>│  │   - Wraps AuthenticatedHttpClient                                  │  │
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>│  │   - Proactive refresh before requests when needsRefresh            │  │
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>│  │   - On 401: refresh via TokenRefresher, retry ONCE                 │  │
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>│  │   - Concurrent refresh deduplication via Completer                 │  │
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>│  │   - CWE-834: Single retry limit prevents infinite loops            │  │
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>│  │                                                                    │  │
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>│  │   Dependencies:                                                    │  │
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>│  │     inner: AuthenticatedHttpClient                                 │  │
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>│  │     refresher: TokenRefresher ◄──────────────────────────────┐     │  │
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>│  └──────────────────────────────────────────────────────────────│─────┘  │
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>│                                                                 │        │
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>│  ┌──────────────────────────────────────────────────────────────│─────┐  │
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>│  │ AuthenticatedHttpClient                                      │     │  │
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>│  │   - Wraps ObservableHttpClient                               │     │  │
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>│  │   - Calls _getToken() per request                            │     │  │
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>│  │   - Injects Authorization header if token present            │     │  │
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>│  │   - Does NOT retry on 401                                    │     │  │
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>│  │                                                              │     │  │
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>│  │   Dependencies:                                              │     │  │
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>│  │     inner: ObservableHttpClient                              │     │  │
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>│  │     _getToken: String? Function() ◄──────────────────────────│─┐   │  │
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>│  └──────────────────────────────────────────────────────────────│─│───┘  │
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>│                                                                 │ │      │
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>│  ┌──────────────────────────────────────────────────────────────│─│───┐  │
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>│  │ TokenRefreshService (pure Dart)                              │ │   │  │
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>│  │   - refresh() → TokenRefreshResult (sealed type)             │ │   │  │
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>│  │   - Fetches OIDC discovery, POSTs to token endpoint          │ │   │  │
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>│  │   - SSRF protection via origin validation                    │ │   │  │
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>│  │                                                              │ │   │  │
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>│  │   Dependencies:                                              │ │   │  │
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>│  │     httpClient: baseHttpClient (no auth, internal to core)   │ │   │  │
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>│  └──────────────────────────────────────────────────────────────│─│───┘  │
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>└─────────────────────────────────────────────────────────────────│─│──────┘
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>                                                                  │ │
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>                                        implements &amp;              │ │
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>                                        injects                   │ │
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>                                                                  │ │
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>┌─────────────────────────────────────────────────────────────────│─│──────┐
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>│                           Flutter Frontend                      │ │      │
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a>│                                                                 │ │      │
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a>│  ┌──────────────────────────────────────────────────────────────│─│───┐  │
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a>│  │ AuthNotifier implements TokenRefresher ──────────────────────┘ │   │  │
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>│  │   - Interprets AuthProviderConfig as OidcIssuer                │   │  │
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>│  │   - Runs flutter_appauth flow (sign in/out)                    │   │  │
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>│  │   - Stores tokens in flutter_secure_storage                    │   │  │
</span><span id="__span-8-57"><a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>│  │   - Delegates refresh to TokenRefreshService                   │   │  │
</span><span id="__span-8-58"><a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>│  │   - Implements needsRefresh, refreshIfExpiringSoon(), tryRefresh() │  │
</span><span id="__span-8-59"><a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a>│  └────────────────────────────────────────────────────────────────│───┘  │
</span><span id="__span-8-60"><a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a>│                                                                   │      │
</span><span id="__span-8-61"><a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a>│  api_provider.dart wiring:                                        │      │
</span><span id="__span-8-62"><a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a>│    _getToken: () =&gt; ref.read(accessTokenProvider) ────────────────┘      │
</span><span id="__span-8-63"><a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a>│                                                                          │
</span><span id="__span-8-64"><a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a>└──────────────────────────────────────────────────────────────────────────┘
</span></code></pre></div>
<h3 id="migration-plan">Migration Plan</h3>
<ol>
<li><strong>Add to <code>soliplex_client</code>:</strong></li>
<li><code>AuthProviderConfig</code> model in <code>lib/src/auth/</code></li>
<li><code>AuthenticatedHttpClient</code> decorator in <code>lib/src/http/</code></li>
<li><code>TokenRefresher</code> interface in <code>lib/src/http/</code></li>
<li><code>RefreshingHttpClient</code> decorator in <code>lib/src/http/</code></li>
<li>
<p><code>fetchAuthProviders()</code> in <code>SoliplexApi</code></p>
</li>
<li>
<p><strong>Keep in Flutter frontend:</strong></p>
</li>
<li><code>OidcIssuer</code> (frontend interpretation of <code>AuthProviderConfig</code>)</li>
<li>All Riverpod providers/notifiers</li>
<li><code>auth_flow.dart</code> (flutter_appauth)</li>
<li>
<p>Token storage, <code>AuthNotifier</code> implementing <code>TokenRefresher</code></p>
</li>
<li>
<p><strong>Refactor Flutter wiring:</strong></p>
</li>
<li>Use core's <code>AuthenticatedHttpClient</code> instead of <code>_AuthenticatedHttpClient</code></li>
<li>Frontend provides token getter closure and <code>TokenRefresher</code> implementation</li>
<li>Decorator order: <code>Refreshing(Authenticated(Observable(Platform)))</code></li>
</ol>
<h2 id="system-integration">System Integration</h2>
<h3 id="full-architecture-diagram">Full Architecture Diagram</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>┌─────────────────────────────────────────────────────────────────────────────┐
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>│                              Flutter App                                    │
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>│                                                                             │
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>│  ┌─────────────────────────────────────────────────────────────────────┐   │
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>│  │                         UI Layer                                     │   │
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>│  │  │ LoginScreen │  │ RoomsScreen │  │ ChatScreen  │  │ Settings   │  │   │
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └─────┬──────┘  │   │
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>│  └─────────┼────────────────┼────────────────┼───────────────┼─────────┘   │
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>│            │                │                │               │             │
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>│            │    ref.watch(authProvider)      │               │             │
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>│            ▼                ▼                ▼               ▼             │
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>│  ┌─────────────────────────────────────────────────────────────────────┐   │
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>│  │                      Providers (Riverpod)                           │   │
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>│  │                                                                     │   │
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>│  │  ┌──────────────────┐      ┌──────────────────┐                    │   │
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>│  │  │   authProvider   │◄────►│  configProvider  │                    │   │
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>│  │  │  (AuthNotifier)  │      │ (ConfigNotifier) │                    │   │
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>│  │  │ impl TokenRefresher     └──────────────────┘                    │   │
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>│  │  └────────┬─────────┘                                              │   │
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>│  │           │                                                         │   │
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>│  │           │ credentials + TokenRefresher interface                  │   │
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>│  │           ▼                                                         │   │
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>│  │  ┌──────────────────┐      ┌──────────────────┐                    │   │
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>│  │  │    apiProvider   │─────►│ agUiClientProvider│                   │   │
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>│  │  │  (SoliplexApi)   │      │   (AG-UI Client) │                    │   │
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>│  │  └────────┬─────────┘      └────────┬─────────┘                    │   │
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>│  └───────────┼─────────────────────────┼──────────────────────────────┘   │
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>│              │                         │                                   │
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>│              ▼                         ▼                                   │
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>│  ┌─────────────────────────────────────────────────────────────────────┐   │
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>│  │                         HTTP Decorator Stack                         │   │
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>│  │                                                                     │   │
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>│  │  │ RefreshingHttpClient (core - soliplex_client)                 │   │   │
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>│  │  │   - Proactive refresh via TokenRefresher.refreshIfExpiringSoon│  │   │
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>│  │  │   - 401 retry via TokenRefresher.tryRefresh (once only)      │   │   │
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>│  │  │   - Uses baseHttpClient for refresh (bypasses auth layer)    │   │   │
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>│  │  └──────────────────────────┬──────────────────────────────────┘   │   │
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>│  │                             │                                       │   │
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>│  │                             ▼                                       │   │
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>│  │  │ AuthenticatedHttpClient (core - soliplex_client)             │   │   │
</span><span id="__span-9-44"><a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>│  │  │   - Injects Authorization: Bearer {token}                    │   │   │
</span><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>│  │  │   - Does NOT handle refresh or retry                         │   │   │
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a>│  │  └──────────────────────────┬──────────────────────────────────┘   │   │
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>│  │                             │                                       │   │
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>│  │                             ▼                                       │   │
</span><span id="__span-9-49"><a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a>│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
</span><span id="__span-9-50"><a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>│  │  │ ObservableHttpClient (core - soliplex_client)                │   │   │
</span><span id="__span-9-51"><a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>│  │  │   - Notifies HttpObserver of all requests/responses          │   │   │
</span><span id="__span-9-52"><a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>│  │  │   - ALL traffic (backend + IdP refresh) goes through here    │   │   │
</span><span id="__span-9-53"><a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>│  │  └──────────────────────────┬──────────────────────────────────┘   │   │
</span><span id="__span-9-54"><a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>│  │                             │                                       │   │
</span><span id="__span-9-55"><a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>│  │                             ▼                                       │   │
</span><span id="__span-9-56"><a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
</span><span id="__span-9-57"><a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>│  │  │ Platform HTTP Client (core - soliplex_client_native)         │   │   │
</span><span id="__span-9-58"><a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>│  │  │   - CupertinoHttpClient (iOS/macOS) / DartHttpClient         │   │   │
</span><span id="__span-9-59"><a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>│  │  └──────────────────────────┬──────────────────────────────────┘   │   │
</span><span id="__span-9-60"><a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a>│  └─────────────────────────────┼──────────────────────────────────────┘   │
</span><span id="__span-9-61"><a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>│                                │                                           │
</span><span id="__span-9-62"><a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a>│  Token Refresh Path (bypasses AuthenticatedHttpClient):                    │
</span><span id="__span-9-63"><a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a>│  AuthNotifier.tryRefresh() → auth_flow.refreshTokens() → baseHttpClient   │
</span><span id="__span-9-64"><a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a>│                                │                                           │
</span><span id="__span-9-65"><a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a>└────────────────────────────────┼───────────────────────────────────────────┘
</span><span id="__span-9-66"><a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a>                                 │ HTTPS
</span><span id="__span-9-67"><a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a>                                 ▼
</span><span id="__span-9-68"><a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a>┌────────────────────────────────────────────────────────────────────────────┐
</span><span id="__span-9-69"><a id="__codelineno-9-69" name="__codelineno-9-69" href="#__codelineno-9-69"></a>│                      Soliplex Backend Infrastructure                       │
</span><span id="__span-9-70"><a id="__codelineno-9-70" name="__codelineno-9-70" href="#__codelineno-9-70"></a>│                                                                            │
</span><span id="__span-9-71"><a id="__codelineno-9-71" name="__codelineno-9-71" href="#__codelineno-9-71"></a>│  ┌─────────────────────────────────────────────────────────────────────┐  │
</span><span id="__span-9-72"><a id="__codelineno-9-72" name="__codelineno-9-72" href="#__codelineno-9-72"></a>│  │                        Soliplex API Server                          │  │
</span><span id="__span-9-73"><a id="__codelineno-9-73" name="__codelineno-9-73" href="#__codelineno-9-73"></a>│  │  ┌───────────────────┐  ┌────────────────────────────────────────┐  │  │
</span><span id="__span-9-74"><a id="__codelineno-9-74" name="__codelineno-9-74" href="#__codelineno-9-74"></a>│  │  │ GET /api/login    │  │ /api/v1/* (protected)                  │  │  │
</span><span id="__span-9-75"><a id="__codelineno-9-75" name="__codelineno-9-75" href="#__codelineno-9-75"></a>│  │  │ Returns IdP info: │  │ Validates Bearer token against IdP    │  │  │
</span><span id="__span-9-76"><a id="__codelineno-9-76" name="__codelineno-9-76" href="#__codelineno-9-76"></a>│  │  │ • server_url      │  │                                        │  │  │
</span><span id="__span-9-77"><a id="__codelineno-9-77" name="__codelineno-9-77" href="#__codelineno-9-77"></a>│  │  │ • client_id       │  └────────────────────────────────────────┘  │  │
</span><span id="__span-9-78"><a id="__codelineno-9-78" name="__codelineno-9-78" href="#__codelineno-9-78"></a>│  │  │ • scope           │                                              │  │
</span><span id="__span-9-79"><a id="__codelineno-9-79" name="__codelineno-9-79" href="#__codelineno-9-79"></a>│  │  └───────────────────┘                                              │  │
</span><span id="__span-9-80"><a id="__codelineno-9-80" name="__codelineno-9-80" href="#__codelineno-9-80"></a>│  └─────────────────────────────────────────────────────────────────────┘  │
</span><span id="__span-9-81"><a id="__codelineno-9-81" name="__codelineno-9-81" href="#__codelineno-9-81"></a>│                                                                            │
</span><span id="__span-9-82"><a id="__codelineno-9-82" name="__codelineno-9-82" href="#__codelineno-9-82"></a>│  ┌─────────────────────────────────────────────────────────────────────┐  │
</span><span id="__span-9-83"><a id="__codelineno-9-83" name="__codelineno-9-83" href="#__codelineno-9-83"></a>│  │                    OIDC Identity Provider (Keycloak)                │  │
</span><span id="__span-9-84"><a id="__codelineno-9-84" name="__codelineno-9-84" href="#__codelineno-9-84"></a>│  │  server_url: https://sso.domain.net/realms/soliplex                 │  │
</span><span id="__span-9-85"><a id="__codelineno-9-85" name="__codelineno-9-85" href="#__codelineno-9-85"></a>│  │                                                                     │  │
</span><span id="__span-9-86"><a id="__codelineno-9-86" name="__codelineno-9-86" href="#__codelineno-9-86"></a>│  │  ┌────────────────────────────────────────────────────────────┐    │  │
</span><span id="__span-9-87"><a id="__codelineno-9-87" name="__codelineno-9-87" href="#__codelineno-9-87"></a>│  │  │ /.well-known/openid-configuration ◄── OIDC discovery        │    │  │
</span><span id="__span-9-88"><a id="__codelineno-9-88" name="__codelineno-9-88" href="#__codelineno-9-88"></a>│  │  │ /protocol/openid-connect/auth     ◄── flutter_appauth login │    │  │
</span><span id="__span-9-89"><a id="__codelineno-9-89" name="__codelineno-9-89" href="#__codelineno-9-89"></a>│  │  │ /protocol/openid-connect/token    ◄── code exchange &amp; refresh│   │  │
</span><span id="__span-9-90"><a id="__codelineno-9-90" name="__codelineno-9-90" href="#__codelineno-9-90"></a>│  │  └────────────────────────────────────────────────────────────┘    │  │
</span><span id="__span-9-91"><a id="__codelineno-9-91" name="__codelineno-9-91" href="#__codelineno-9-91"></a>│  └─────────────────────────────────────────────────────────────────────┘  │
</span><span id="__span-9-92"><a id="__codelineno-9-92" name="__codelineno-9-92" href="#__codelineno-9-92"></a>└────────────────────────────────────────────────────────────────────────────┘
</span><span id="__span-9-93"><a id="__codelineno-9-93" name="__codelineno-9-93" href="#__codelineno-9-93"></a>
</span><span id="__span-9-94"><a id="__codelineno-9-94" name="__codelineno-9-94" href="#__codelineno-9-94"></a>Auth Flow (Direct OIDC via flutter_appauth):
</span><span id="__span-9-95"><a id="__codelineno-9-95" name="__codelineno-9-95" href="#__codelineno-9-95"></a>1. App calls GET /api/login → gets IdP config (server_url, client_id, scope)
</span><span id="__span-9-96"><a id="__codelineno-9-96" name="__codelineno-9-96" href="#__codelineno-9-96"></a>2. flutter_appauth opens system browser → IdP login page (server_url)
</span><span id="__span-9-97"><a id="__codelineno-9-97" name="__codelineno-9-97" href="#__codelineno-9-97"></a>3. User authenticates with IdP
</span><span id="__span-9-98"><a id="__codelineno-9-98" name="__codelineno-9-98" href="#__codelineno-9-98"></a>4. IdP redirects to app with auth code
</span><span id="__span-9-99"><a id="__codelineno-9-99" name="__codelineno-9-99" href="#__codelineno-9-99"></a>5. flutter_appauth exchanges code for tokens at IdP token endpoint (PKCE)
</span><span id="__span-9-100"><a id="__codelineno-9-100" name="__codelineno-9-100" href="#__codelineno-9-100"></a>6. App stores tokens, uses for API calls
</span><span id="__span-9-101"><a id="__codelineno-9-101" name="__codelineno-9-101" href="#__codelineno-9-101"></a>7. On refresh: auth_flow.refreshTokens() → baseHttpClient → IdP token endpoint
</span></code></pre></div>
<h3 id="auth-components">Auth Components</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>┌─────────────────────────────────────────────────────────────────────────────┐
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>│                         lib/core/auth/                                      │
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>│                                                                             │
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>│  ┌───────────────────────────────────────────────────────────────────────┐ │
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>│  │  AuthState (sealed class)                                             │ │
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>│  │                                                                       │ │
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>│  │  ┌─────────────────┐    ┌──────────────────────────────────────────┐ │ │
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>│  │  │ Unauthenticated │    │ Authenticated                            │ │ │
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>│  │  │                 │    │   accessToken, refreshToken, idToken     │ │ │
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>│  │  │                 │    │   expiresAt, issuerId, clientId          │ │ │
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>│  │  │                 │    │   issuerDiscoveryUrl                      │ │ │
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>│  │  │                 │    │   isExpired, needsRefresh (computed)     │ │ │
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>│  │  └─────────────────┘    └──────────────────────────────────────────┘ │ │
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>│  └───────────────────────────────────────────────────────────────────────┘ │
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>│                                  │                                          │
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>│                                  │ persisted to                             │
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>│                                  ▼                                          │
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>│  ┌──────────────────────────────────────────────────────────────────────┐  │
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>│  │                 flutter_secure_storage (via AuthStorage)              │  │
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>│  │                                                                       │  │
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>│  │  iOS/macOS: Keychain    Android: EncryptedSharedPreferences          │  │
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>│  └──────────────────────────────────────────────────────────────────────┘  │
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>│                                                                             │
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>│  ┌──────────────────────────────────────────────────────────────────────┐  │
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>│  │  TokenRefresher (interface) — from soliplex_client                    │  │
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>│  │    needsRefresh: bool                                                 │  │
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>│  │    refreshIfExpiringSoon() → proactive refresh                        │  │
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>│  │    tryRefresh() → attempt refresh, return success/failure             │  │
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>│  │                                                                       │  │
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>│  │  Note: Implementers need access to baseHttpClient (not the            │  │
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>│  │  RefreshingHttpClient being configured) for token refresh calls.      │  │
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>│  │  This dependency is injected via constructor, not interface.          │  │
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>│  └───────────────────────────────┬──────────────────────────────────────┘  │
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>│                                  │                                          │
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>│                                  │ implemented by                           │
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>│                                  ▼                                          │
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>│  ┌──────────────────────────────────────────────────────────────────────┐  │
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>│  │  AuthNotifier implements TokenRefresher                               │  │
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>│  │                                                                       │  │
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>│  │  Dependencies captured in build() via providers (enables testing):    │  │
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>│  │    late final AuthStorage _storage                                    │  │
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>│  │    late final TokenRefreshService _refreshService                     │  │
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>│  │                                                                       │  │
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>│  │  signIn(issuer)      → flutter_appauth flow                           │  │
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>│  │  signOut()           → endSession + clears tokens from storage        │  │
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>│  │  tryRefresh()        → delegates to _refreshService.refresh()         │  │
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>│  │  restoreSession()    → loads tokens from storage on app start         │  │
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>│  └───────────────────────────────┬──────────────────────────────────────┘  │
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>│                                  │                                          │
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>│                                  │ delegates to                             │
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a>│                                  ▼                                          │
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a>│  ┌──────────────────────────────────────────────────────────────────────┐  │
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a>│  │  auth_flow.dart                                                       │  │
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a>│  │                                                                       │  │
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a>│  │  authenticate(issuer) → AuthResult (flutter_appauth)                  │  │
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a>│  │  endSession(...)      → IdP logout (flutter_appauth)                  │  │
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a>│  └──────────────────────────────────────────────────────────────────────┘  │
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a>│                                                                             │
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a>│  ┌──────────────────────────────────────────────────────────────────────┐  │
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a>│  │  TokenRefreshService (pure Dart - from soliplex_client)               │  │
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a>│  │                                                                       │  │
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a>│  │  Constructor: TokenRefreshService(httpClient: SoliplexHttpClient)     │  │
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a>│  │    httpClient: base client (not authenticated) for refresh calls      │  │
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a>│  │                                                                       │  │
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a>│  │  refresh(...) → TokenRefreshResult (sealed type)                      │  │
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a>│  │    - TokenRefreshSuccess: new tokens                                  │  │
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a>│  │    - TokenRefreshFailure: invalidGrant, networkError, unknownError    │  │
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a>│  │                                                                       │  │
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69" href="#__codelineno-10-69"></a>│  │  Handles: OIDC discovery, token refresh POST, SSRF validation         │  │
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70" href="#__codelineno-10-70"></a>│  └──────────────────────────────────────────────────────────────────────┘  │
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71" href="#__codelineno-10-71"></a>│                                                                             │
</span><span id="__span-10-72"><a id="__codelineno-10-72" name="__codelineno-10-72" href="#__codelineno-10-72"></a>│  ┌──────────────────────────────────────────────────────────────────────┐  │
</span><span id="__span-10-73"><a id="__codelineno-10-73" name="__codelineno-10-73" href="#__codelineno-10-73"></a>│  │  RefreshingHttpClient (decorator) — from soliplex_client              │  │
</span><span id="__span-10-74"><a id="__codelineno-10-74" name="__codelineno-10-74" href="#__codelineno-10-74"></a>│  │                                                                       │  │
</span><span id="__span-10-75"><a id="__codelineno-10-75" name="__codelineno-10-75" href="#__codelineno-10-75"></a>│  │  Constructor: RefreshingHttpClient(inner, refresher)                  │  │
</span><span id="__span-10-76"><a id="__codelineno-10-76" name="__codelineno-10-76" href="#__codelineno-10-76"></a>│  │    inner: AuthenticatedHttpClient (for normal requests)               │  │
</span><span id="__span-10-77"><a id="__codelineno-10-77" name="__codelineno-10-77" href="#__codelineno-10-77"></a>│  │    refresher: TokenRefresher (for refresh operations)                 │  │
</span><span id="__span-10-78"><a id="__codelineno-10-78" name="__codelineno-10-78" href="#__codelineno-10-78"></a>│  │                                                                       │  │
</span><span id="__span-10-79"><a id="__codelineno-10-79" name="__codelineno-10-79" href="#__codelineno-10-79"></a>│  │  Note: Does NOT receive baseHttpClient directly. The TokenRefresher   │  │
</span><span id="__span-10-80"><a id="__codelineno-10-80" name="__codelineno-10-80" href="#__codelineno-10-80"></a>│  │  implementation (AuthNotifier) handles the baseClient access.         │  │
</span><span id="__span-10-81"><a id="__codelineno-10-81" name="__codelineno-10-81" href="#__codelineno-10-81"></a>│  │                                                                       │  │
</span><span id="__span-10-82"><a id="__codelineno-10-82" name="__codelineno-10-82" href="#__codelineno-10-82"></a>│  │  Behavior:                                                            │  │
</span><span id="__span-10-83"><a id="__codelineno-10-83" name="__codelineno-10-83" href="#__codelineno-10-83"></a>│  │    - Proactive refresh via refresher.refreshIfExpiringSoon()          │  │
</span><span id="__span-10-84"><a id="__codelineno-10-84" name="__codelineno-10-84" href="#__codelineno-10-84"></a>│  │    - 401 retry via refresher.tryRefresh() (once only, CWE-834)        │  │
</span><span id="__span-10-85"><a id="__codelineno-10-85" name="__codelineno-10-85" href="#__codelineno-10-85"></a>│  │    - Completer pattern for concurrent refresh deduplication           │  │
</span><span id="__span-10-86"><a id="__codelineno-10-86" name="__codelineno-10-86" href="#__codelineno-10-86"></a>│  └──────────────────────────────────────────────────────────────────────┘  │
</span><span id="__span-10-87"><a id="__codelineno-10-87" name="__codelineno-10-87" href="#__codelineno-10-87"></a>│                                                                             │
</span><span id="__span-10-88"><a id="__codelineno-10-88" name="__codelineno-10-88" href="#__codelineno-10-88"></a>│  ┌──────────────────────────────────────────────────────────────────────┐  │
</span><span id="__span-10-89"><a id="__codelineno-10-89" name="__codelineno-10-89" href="#__codelineno-10-89"></a>│  │  OidcIssuer (slim model)                                              │  │
</span><span id="__span-10-90"><a id="__codelineno-10-90" name="__codelineno-10-90" href="#__codelineno-10-90"></a>│  │                                                                       │  │
</span><span id="__span-10-91"><a id="__codelineno-10-91" name="__codelineno-10-91" href="#__codelineno-10-91"></a>│  │  id, title, serverUrl, clientId, scope                                │  │
</span><span id="__span-10-92"><a id="__codelineno-10-92" name="__codelineno-10-92" href="#__codelineno-10-92"></a>│  │  discoveryUrl (computed from serverUrl)                               │  │
</span><span id="__span-10-93"><a id="__codelineno-10-93" name="__codelineno-10-93" href="#__codelineno-10-93"></a>│  └──────────────────────────────────────────────────────────────────────┘  │
</span><span id="__span-10-94"><a id="__codelineno-10-94" name="__codelineno-10-94" href="#__codelineno-10-94"></a>└─────────────────────────────────────────────────────────────────────────────┘
</span><span id="__span-10-95"><a id="__codelineno-10-95" name="__codelineno-10-95" href="#__codelineno-10-95"></a>
</span><span id="__span-10-96"><a id="__codelineno-10-96" name="__codelineno-10-96" href="#__codelineno-10-96"></a>HTTP Client Dependency Clarification:
</span><span id="__span-10-97"><a id="__codelineno-10-97" name="__codelineno-10-97" href="#__codelineno-10-97"></a>
</span><span id="__span-10-98"><a id="__codelineno-10-98" name="__codelineno-10-98" href="#__codelineno-10-98"></a>┌─────────────────────────────────────────────────────────────────────────────┐
</span><span id="__span-10-99"><a id="__codelineno-10-99" name="__codelineno-10-99" href="#__codelineno-10-99"></a>│  Why TokenRefresher needs baseHttpClient (not the decorated stack):         │
</span><span id="__span-10-100"><a id="__codelineno-10-100" name="__codelineno-10-100" href="#__codelineno-10-100"></a>│                                                                             │
</span><span id="__span-10-101"><a id="__codelineno-10-101" name="__codelineno-10-101" href="#__codelineno-10-101"></a>│  RefreshingHttpClient wraps AuthenticatedHttpClient. If refresh calls       │
</span><span id="__span-10-102"><a id="__codelineno-10-102" name="__codelineno-10-102" href="#__codelineno-10-102"></a>│  went through AuthenticatedHttpClient, the refresh_token would be sent      │
</span><span id="__span-10-103"><a id="__codelineno-10-103" name="__codelineno-10-103" href="#__codelineno-10-103"></a>│  with an Authorization header containing the (possibly expired) access      │
</span><span id="__span-10-104"><a id="__codelineno-10-104" name="__codelineno-10-104" href="#__codelineno-10-104"></a>│  token - this is incorrect OAuth behavior and could cause loops.            │
</span><span id="__span-10-105"><a id="__codelineno-10-105" name="__codelineno-10-105" href="#__codelineno-10-105"></a>│                                                                             │
</span><span id="__span-10-106"><a id="__codelineno-10-106" name="__codelineno-10-106" href="#__codelineno-10-106"></a>│  Solution: AuthNotifier receives baseHttpClient via Riverpod ref and        │
</span><span id="__span-10-107"><a id="__codelineno-10-107" name="__codelineno-10-107" href="#__codelineno-10-107"></a>│  passes it to auth_flow.refreshTokens(). The refresh request goes           │
</span><span id="__span-10-108"><a id="__codelineno-10-108" name="__codelineno-10-108" href="#__codelineno-10-108"></a>│  through Observable → Platform (visible in HTTP logs) but NOT through       │
</span><span id="__span-10-109"><a id="__codelineno-10-109" name="__codelineno-10-109" href="#__codelineno-10-109"></a>│  Authenticated (no auth header added).                                      │
</span><span id="__span-10-110"><a id="__codelineno-10-110" name="__codelineno-10-110" href="#__codelineno-10-110"></a>│                                                                             │
</span><span id="__span-10-111"><a id="__codelineno-10-111" name="__codelineno-10-111" href="#__codelineno-10-111"></a>│  Request paths:                                                             │
</span><span id="__span-10-112"><a id="__codelineno-10-112" name="__codelineno-10-112" href="#__codelineno-10-112"></a>│    Normal API call: Refreshing → Authenticated → Observable → Platform     │
</span><span id="__span-10-113"><a id="__codelineno-10-113" name="__codelineno-10-113" href="#__codelineno-10-113"></a>│    Token refresh:   auth_flow.refreshTokens() → Observable → Platform      │
</span><span id="__span-10-114"><a id="__codelineno-10-114" name="__codelineno-10-114" href="#__codelineno-10-114"></a>└─────────────────────────────────────────────────────────────────────────────┘
</span></code></pre></div>
<h3 id="http-observability">HTTP Observability</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>┌─────────────────────────────────────────────────────────────────────────────┐
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>│                        HTTP Request Lifecycle                               │
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>│                                                                             │
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>│   API Call (e.g., fetchRooms())                                            │
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>│        │                                                                    │
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>│        ▼                                                                    │
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>│   ┌────────────────────────────────────────────────────────────────────┐   │
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>│   │ RefreshingHttpClient                                                │   │
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>│   │                                                                     │   │
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>│   │  1. Check needsRefresh → proactive refresh if needed               │   │
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>│   │  2. Forward request to inner client                                 │   │
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>│   │  3. On 401 → tryRefresh() → retry ONCE (CWE-834)                   │   │
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>│   └─────────────────────────────┬──────────────────────────────────────┘   │
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>│                                 │                                           │
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>│                                 ▼                                           │
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>│   ┌────────────────────────────────────────────────────────────────────┐   │
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>│   │ AuthenticatedHttpClient                                             │   │
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>│   │                                                                     │   │
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>│   │  Inject: Authorization: Bearer {token}                              │   │
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>│   └─────────────────────────────┬──────────────────────────────────────┘   │
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>│                                 │                                           │
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>│                                 ▼                                           │
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>│   ┌────────────────────────────────────────────────────────────────────┐   │
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>│   │ ObservableHttpClient                                                │   │
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>│   │                                                                     │   │
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>│   │  Emits HttpRequestEvent ──────────────────────────────────────┐    │   │
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>│   │    • method, url                                              │    │   │
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>│   │    • headers (Authorization: Bearer [REDACTED])               │    │   │
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>│   │    • body (tokens [REDACTED])                                 │    │   │
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>│   └─────────────────────────────┬─────────────────────────────────┼────┘   │
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>│                                 │                                 │         │
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>│                                 ▼                                 │         │
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>│   ┌────────────────────────────────────────────────────────────┐  │        │
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>│   │ Platform HTTP Client → Network                              │  │        │
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>│   └─────────────────────────────┬──────────────────────────────┘  │        │
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>│                                 │                                  │         │
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>│                                 ▼                                  │         │
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>│   ┌────────────────────────────────────────────────────────────┐   │        │
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>│   │ Response flows back up through the chain                    │   │        │
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>│   │                                                             │   │        │
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>│   │  ObservableHttpClient emits HttpResponseEvent ──────────┐  │   │        │
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>│   │    • status, headers                                    │  │   │        │
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>│   │    • body (tokens [REDACTED])                           │  │   │        │
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>│   └─────────────────────────────────────────────────────────┼──┘   │        │
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>│                                                              │     │         │
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>│                                                              ▼     ▼         │
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>│   ┌────────────────────────────────────────────────────────────────────┐   │
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>│   │                      HttpLogNotifier                                │   │
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>│   │                  (implements HttpObserver)                          │   │
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>│   │                                                                     │   │
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>│   │  Sanitization rules applied before logging:                         │   │
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>│   │    • Authorization header → &quot;Bearer [REDACTED]&quot;                     │   │
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>│   │    • Cookie/Set-Cookie headers → &quot;[REDACTED]&quot;                       │   │
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>│   │    • Query params: token, access_token, refresh_token, id_token,    │   │
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a>│   │      code, client_secret, state → &quot;[REDACTED]&quot;                      │   │
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>│   │    • Response body tokens → &quot;[REDACTED]&quot;                            │   │
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a>│   │                                                                     │   │
</span><span id="__span-11-58"><a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>│   │  State: List&lt;HttpEvent&gt; ──► UI (HTTP Inspector / Debug Panel)      │   │
</span><span id="__span-11-59"><a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a>│   └────────────────────────────────────────────────────────────────────┘   │
</span><span id="__span-11-60"><a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>└─────────────────────────────────────────────────────────────────────────────┘
</span><span id="__span-11-61"><a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>
</span><span id="__span-11-62"><a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a>┌─────────────────────────────────────────────────────────────────────────────┐
</span><span id="__span-11-63"><a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a>│                        What IS Observable                                   │
</span><span id="__span-11-64"><a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a>├─────────────────────────────────────────────────────────────────────────────┤
</span><span id="__span-11-65"><a id="__codelineno-11-65" name="__codelineno-11-65" href="#__codelineno-11-65"></a>│  ✓ GET /api/login (fetch IdP configuration)                                │
</span><span id="__span-11-66"><a id="__codelineno-11-66" name="__codelineno-11-66" href="#__codelineno-11-66"></a>│  ✓ GET {idp}/.well-known/openid-configuration (OIDC discovery)             │
</span><span id="__span-11-67"><a id="__codelineno-11-67" name="__codelineno-11-67" href="#__codelineno-11-67"></a>│  ✓ POST {idp}/token (refresh calls go through our HTTP stack)              │
</span><span id="__span-11-68"><a id="__codelineno-11-68" name="__codelineno-11-68" href="#__codelineno-11-68"></a>│  ✓ All authenticated API calls (GET /api/v1/rooms, etc.)                   │
</span><span id="__span-11-69"><a id="__codelineno-11-69" name="__codelineno-11-69" href="#__codelineno-11-69"></a>│  ✓ 401 retry requests (after successful refresh)                           │
</span><span id="__span-11-70"><a id="__codelineno-11-70" name="__codelineno-11-70" href="#__codelineno-11-70"></a>├─────────────────────────────────────────────────────────────────────────────┤
</span><span id="__span-11-71"><a id="__codelineno-11-71" name="__codelineno-11-71" href="#__codelineno-11-71"></a>│                        What is NOT Observable                               │
</span><span id="__span-11-72"><a id="__codelineno-11-72" name="__codelineno-11-72" href="#__codelineno-11-72"></a>├─────────────────────────────────────────────────────────────────────────────┤
</span><span id="__span-11-73"><a id="__codelineno-11-73" name="__codelineno-11-73" href="#__codelineno-11-73"></a>│  ✗ Authorization request (ASWebAuthenticationSession sandbox)              │
</span><span id="__span-11-74"><a id="__codelineno-11-74" name="__codelineno-11-74" href="#__codelineno-11-74"></a>│  ✗ IdP login page (user authentication)                                    │
</span><span id="__span-11-75"><a id="__codelineno-11-75" name="__codelineno-11-75" href="#__codelineno-11-75"></a>│  ✗ Code exchange by flutter_appauth (happens inside the library)           │
</span><span id="__span-11-76"><a id="__codelineno-11-76" name="__codelineno-11-76" href="#__codelineno-11-76"></a>│                                                                             │
</span><span id="__span-11-77"><a id="__codelineno-11-77" name="__codelineno-11-77" href="#__codelineno-11-77"></a>│  Note: With direct OIDC, the initial code exchange is handled internally   │
</span><span id="__span-11-78"><a id="__codelineno-11-78" name="__codelineno-11-78" href="#__codelineno-11-78"></a>│  by flutter_appauth and isn&#39;t observable. Token refresh uses our HTTP      │
</span><span id="__span-11-79"><a id="__codelineno-11-79" name="__codelineno-11-79" href="#__codelineno-11-79"></a>│  stack via refreshTokens() in auth_flow.dart, so it IS observable.         │
</span><span id="__span-11-80"><a id="__codelineno-11-80" name="__codelineno-11-80" href="#__codelineno-11-80"></a>└─────────────────────────────────────────────────────────────────────────────┘
</span></code></pre></div>
<h3 id="login-flow-sequence">Login Flow Sequence</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>User taps &quot;Login with Keycloak&quot;
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>        │
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>        ▼
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>┌───────────────────┐
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>│ LoginScreen       │
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>│ signIn(&quot;keycloak&quot;)│
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>└────────┬──────────┘
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>         │
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>         ▼
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>┌───────────────────┐     ┌─────────────────────────────────────────────────┐
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>│ AuthNotifier      │     │ 1. Fetch IdP config: GET /api/login              │
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>│                   │────►│    → { server_url, client_id, scope }            │
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>│ signIn(issuerId)  │     │ 2. Call flutter_appauth.authorizeAndExchangeCode │
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>└───────────────────┘     └────────────────────┬────────────────────────────┘
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>                                               │
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>                    ┌──────────────────────────┴───────────────────────────┐
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>                    │                    BROWSER SANDBOX                   │
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>                    │              (not observable from app)               │
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>                    ▼                                                      │
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>         ┌─────────────────────┐                                          │
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>         │ ASWebAuthSession    │                                          │
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>         │ (iOS/macOS)         │                                          │
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>         └──────────┬──────────┘                                          │
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>                    │                                                      │
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>                    ▼                                                      │
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>         ┌─────────────────────────────────────────────────────────────┐  │
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>         │ IdP (Keycloak) - Direct OIDC                                │  │
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>         │ https://sso.domain.net/realms/soliplex                      │  │
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>         │                                                             │  │
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>         │  1. /protocol/openid-connect/auth                           │  │
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>         │     (authorization endpoint - shows login page)             │  │
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>         │                                                             │  │
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>         │  2. User authenticates                                      │  │
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>         │                                                             │  │
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>         │  3. Redirect to app with authorization code                 │  │
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>         │     app://callback?code=xxx&amp;state=yyy                       │  │
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>         └──────────────────────────┬──────────────────────────────────┘  │
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>                                    │                                      │
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>                    └───────────────┴──────────────────────────────────────┘
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>                                    │
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>                                    ▼
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>         ┌─────────────────────────────────────────────────────────────────┐
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>         │ flutter_appauth (automatic code exchange with PKCE)             │
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>         │                                                                 │
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>         │ POST /protocol/openid-connect/token                             │
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>         │   grant_type=authorization_code                                 │
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>         │   code=xxx                                                      │
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>         │   code_verifier=&lt;PKCE verifier&gt;                                 │
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>         │   redirect_uri=app://callback                                   │
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>         │                                                                 │
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>         │ Response: { access_token, refresh_token, expires_in, ... }     │
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>         └──────────────────────────┬──────────────────────────────────────┘
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>                                    │
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>                                    ▼
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>         ┌─────────────────────┐     ┌─────────────────────┐
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>         │ AuthNotifier        │────►│ flutter_secure_     │
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>         │ state = Authenticated│     │ storage             │
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>         └──────────┬──────────┘     └─────────────────────┘
</span><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>                    │
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>                    ▼
</span><span id="__span-12-61"><a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>         ┌─────────────────────┐
</span><span id="__span-12-62"><a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a>         │ GoRouter redirect   │
</span><span id="__span-12-63"><a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a>         │ guard allows access │
</span><span id="__span-12-64"><a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a>         │ → navigate to /     │
</span><span id="__span-12-65"><a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>         └─────────────────────┘
</span></code></pre></div>
<h3 id="logout-flow-sequence">Logout Flow Sequence</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>User taps &quot;Logout&quot;
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>        │
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>        ▼
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>┌───────────────────┐
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>│ SettingsScreen    │
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>│ signOut()         │
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>└────────┬──────────┘
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>         │
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>         ▼
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>┌───────────────────┐
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>│ AuthNotifier      │
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>│ signOut()         │
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>└────────┬──────────┘
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>         │
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>         ▼
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>┌────────────────────────────────────────────────────────────┐
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>│ Get idToken and issuerDiscoveryUrl from Authenticated state │
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>└────────┬───────────────────────────────────────────────────┘
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>         │
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>         ├──────────────── idToken is null? ─────────────────┐
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>         │                                                    │
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>         ▼ (idToken present)                                  ▼ (no idToken)
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>┌─────────────────────────────────────────────┐    ┌──────────────────────┐
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>│ auth_flow.endSession()                       │    │ Skip endSession      │
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>│                                             │    │ (can&#39;t logout at IdP │
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>│  appAuth.endSession(EndSessionRequest(      │    │  without idToken)    │
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>│    idTokenHint: idToken,                    │    └──────────┬───────────┘
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>│    discoveryUrl: issuerDiscoveryUrl,        │               │
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>│    postLogoutRedirectUrl: redirectUri,      │               │
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>│  ))                                         │               │
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>└────────┬────────────────────────────────────┘               │
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>         │                                                    │
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>         │ (Opens browser to IdP logout page)                 │
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>         │ (IdP clears its session)                           │
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>         │ (Redirects back to app)                            │
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>         │                                                    │
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>         │ (If endSession fails, continues anyway)            │
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>         ▼                                                    │
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>         ├────────────────────────────────────────────────────┘
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>         │
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>         ▼
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>┌─────────────────────────────────────────────┐
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>│ state = Unauthenticated()                   │
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>│ (Local tokens cleared)                      │
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>└────────┬────────────────────────────────────┘
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a>         │
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>         ▼
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>┌─────────────────────┐
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a>│ GoRouter redirect   │
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a>│ guard navigates     │
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>│ → to /login         │
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a>└─────────────────────┘
</span></code></pre></div>
<p><strong>Key behavior:</strong></p>
<ul>
<li><code>endSession</code> requires <code>idToken</code> from the original login</li>
<li>If <code>idToken</code> is unavailable, local logout still proceeds</li>
<li>If <code>endSession</code> fails (network error, IdP error), local logout still proceeds</li>
<li>User is always logged out locally regardless of IdP session state</li>
</ul>
<h2 id="backend-endpoints">Backend Endpoints</h2>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/api/login</code></td>
<td>GET</td>
<td>IdP configuration (server_url, client_id, scope)</td>
</tr>
<tr>
<td><code>/api/v1/*</code></td>
<td>various</td>
<td>Protected API endpoints (require Bearer token)</td>
</tr>
</tbody>
</table>
<p><strong><code>/api/login</code> Response Format:</strong></p>
<div class="language-json highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="p">{</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span><span class="nt">&quot;keycloak&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;keycloak&quot;</span><span class="p">,</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Authenticate with Keycloak&quot;</span><span class="p">,</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="nt">&quot;server_url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://sso.domain.net/realms/soliplex&quot;</span><span class="p">,</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;soliplex-service&quot;</span><span class="p">,</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="nt">&quot;scope&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;openid email profile&quot;</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="p">}</span>
</span></code></pre></div>
<p>Note: BFF endpoints (<code>/api/login/{system}</code>, <code>/api/auth/{system}</code>) exist but are not used
with direct OIDC approach. They're available for web platform (deferred).</p>
<h2 id="models">Models</h2>
<h3 id="authstate">AuthState</h3>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">sealed</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">AuthState</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">AuthState</span><span class="p">();</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="p">}</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="kd">class</span><span class="w"> </span><span class="nc">Unauthenticated</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AuthState</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">Unauthenticated</span><span class="p">();</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="p">}</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="kd">class</span><span class="w"> </span><span class="nc">AuthLoading</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AuthState</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">AuthLoading</span><span class="p">();</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="p">}</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="kd">class</span><span class="w"> </span><span class="nc">Authenticated</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AuthState</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">accessToken</span><span class="p">;</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">refreshToken</span><span class="p">;</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">DateTime</span><span class="w"> </span><span class="n">expiresAt</span><span class="p">;</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">issuerId</span><span class="p">;</span><span class="w">            </span><span class="c1">// Which IdP issued tokens (for refresh)</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">issuerDiscoveryUrl</span><span class="p">;</span><span class="w">  </span><span class="c1">// OIDC discovery URL (for endSession)</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">clientId</span><span class="p">;</span><span class="w">            </span><span class="c1">// Required for token refresh</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">idToken</span><span class="p">;</span><span class="w">             </span><span class="c1">// Required for OIDC endSession</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">Authenticated</span><span class="p">({</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">accessToken</span><span class="p">,</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">refreshToken</span><span class="p">,</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">expiresAt</span><span class="p">,</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">issuerId</span><span class="p">,</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">issuerDiscoveryUrl</span><span class="p">,</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">clientId</span><span class="p">,</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">idToken</span><span class="p">,</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="w">  </span><span class="p">});</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="kd">get</span><span class="w"> </span><span class="n">isExpired</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">DateTime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">isAfter</span><span class="p">(</span><span class="n">expiresAt</span><span class="p">);</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="kd">get</span><span class="w"> </span><span class="n">needsRefresh</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">DateTime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">isAfter</span><span class="p">(</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="w">    </span><span class="n">expiresAt</span><span class="p">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">TokenRefreshService</span><span class="p">.</span><span class="n">refreshThreshold</span><span class="p">),</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a><span class="w">  </span><span class="p">);</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Refresh Buffer Justification (1 minute):</strong></p>
<p>The 1-minute buffer before token expiry provides:</p>
<ol>
<li><strong>Network latency margin</strong>: Ensures refresh completes before token expires, even with slow networks</li>
<li><strong>Clock drift tolerance</strong>: Small differences between client and server clocks won't cause premature 401s</li>
<li><strong>Reasonable for typical token lifetimes</strong>: Keycloak default access token lifetime is 5 minutes;
   1 minute buffer means refresh at 80% of lifetime</li>
</ol>
<p>For shorter token lifetimes (&lt; 2 minutes), this buffer may be too aggressive. Consider making it
configurable or percentage-based (e.g., 80% of lifetime) if supporting IdPs with very short tokens.</p>
<p>Note: <code>refreshExpiresAt</code> intentionally omitted. Refresh token expiry is handled by
<code>invalid_grant</code> error response from IdP, avoiding client-side clock drift issues.</p>
<h3 id="nullable-fields-and-boundaries">Nullable Fields and Boundaries</h3>
<p>The auth system has several nullable fields. Each null is handled at a single boundary
to avoid spreading null checks throughout the codebase.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Why Nullable</th>
<th>Boundary</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuthResult.refreshToken</code></td>
<td><code>String?</code></td>
<td>Some IdPs don't issue refresh tokens</td>
<td><code>AuthNotifier.signIn()</code> - defaults to empty string</td>
</tr>
<tr>
<td><code>AuthResult.idToken</code></td>
<td><code>String?</code></td>
<td>Some IdPs may not return id_token</td>
<td>Stored as-is; checked in <code>endSession()</code></td>
</tr>
<tr>
<td><code>AuthResult.expiresAt</code></td>
<td><code>DateTime?</code></td>
<td>Some IdP responses omit <code>expires_in</code></td>
<td><code>AuthNotifier.signIn()</code> - defaults to 1 hour from now</td>
</tr>
<tr>
<td><code>AuthenticatedHttpClient._getToken()</code></td>
<td><code>String?</code></td>
<td>Returns null when unauthenticated</td>
<td><code>_injectAuth()</code> - skips header if null</td>
</tr>
<tr>
<td><code>TokenRefreshSuccess.idToken</code></td>
<td><code>String?</code></td>
<td>OIDC spec: refresh may not return id_token</td>
<td><code>AuthNotifier</code> preserves existing idToken</td>
</tr>
</tbody>
</table>
<p><strong>TokenRefreshSuccess.idToken Nullability (OIDC Spec Reference):</strong></p>
<p>Per <a href="https://openid.net/specs/openid-connect-core-1_0.html#RefreshTokenResponse">OIDC Core 1.0 Section 12.2</a>:</p>
<blockquote>
<p>"Upon successful validation of the Refresh Token, the response body is the Token Response
of Section 3.1.3.3 except that <strong>it might not contain an id_token</strong>."</p>
</blockquote>
<p>Whether an IdP returns a new <code>id_token</code> on refresh depends on implementation, requested scopes,
and provider-specific policies. The <code>TokenRefreshSuccess.idToken</code> field is intentionally nullable
to accurately represent what the IdP returned. Callers must preserve the existing <code>id_token</code>:</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">// In AuthNotifier._handleRefreshSuccess()</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kd">final</span><span class="w"> </span><span class="n">idToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">idToken</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="n">idToken</span><span class="p">;</span>
</span></code></pre></div>
<p><strong>Design principle</strong>: Nulls represent legitimate states (e.g., no token yet, IdP didn't
provide optional field). Each null is handled at one boundary, keeping the rest of the
code simple.</p>
<h3 id="oidcissuer">OidcIssuer</h3>
<p>Exactly matches <code>/api/login</code> response shape:</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kd">class</span><span class="w"> </span><span class="nc">OidcIssuer</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">title</span><span class="p">;</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">serverUrl</span><span class="p">;</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">clientId</span><span class="p">;</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="n">scope</span><span class="p">;</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">OidcIssuer</span><span class="p">({</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">serverUrl</span><span class="p">,</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">clientId</span><span class="p">,</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="kd">required</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">scope</span><span class="p">,</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">  </span><span class="p">});</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="p">}</span>
</span></code></pre></div>
<p>Token endpoint for refresh is derived at runtime from OIDC discovery:
<code>{serverUrl}/.well-known/openid-configuration</code></p>
<h2 id="providers">Providers</h2>
<table>
<thead>
<tr>
<th>Provider</th>
<th>Type</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>authProvider</code></td>
<td>NotifierProvider</td>
<td>Auth state + actions, implements TokenRefresher</td>
</tr>
<tr>
<td><code>baseHttpClientProvider</code></td>
<td>Provider</td>
<td>Observable HTTP client for refresh (no auth header)</td>
</tr>
</tbody>
</table>
<p>Derived providers (<code>accessTokenProvider</code>, <code>hasAppAccessProvider</code>) added when needed.</p>
<h3 id="authnotifier">AuthNotifier</h3>
<p>Implements <code>TokenRefresher</code> to provide refresh capabilities to RefreshingHttpClient.</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kd">class</span><span class="w"> </span><span class="nc">AuthNotifier</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Notifier</span><span class="o">&lt;</span><span class="n">AuthState</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">TokenRefresher</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">AuthStorage</span><span class="w"> </span><span class="n">_storage</span><span class="p">;</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">  </span><span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">signIn</span><span class="p">(</span><span class="n">OidcIssuer</span><span class="w"> </span><span class="n">issuer</span><span class="p">);</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">  </span><span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">signOut</span><span class="p">();</span><span class="w">              </span><span class="c1">// Calls endSession (flutter_appauth) + clears storage</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">  </span><span class="c1">// TokenRefresher implementation</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="kd">get</span><span class="w"> </span><span class="n">needsRefresh</span><span class="p">;</span><span class="w">               </span><span class="c1">// True if token expires within 1 minute</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">  </span><span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">refreshIfExpiringSoon</span><span class="p">();</span><span class="w"> </span><span class="c1">// Proactive refresh before API calls</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">  </span><span class="n">Future</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tryRefresh</span><span class="p">();</span><span class="w">           </span><span class="c1">// Uses auth_flow.refreshTokens() with baseHttpClient</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="p">}</span>
</span></code></pre></div>
<p>Token refresh uses <code>ref.read(baseHttpClientProvider)</code> to get an observable HTTP client
that bypasses the auth layer (avoiding circular dependency).</p>
<p><strong>signOut behavior:</strong></p>
<ul>
<li>On platforms with flutter_appauth (iOS/macOS): calls <code>appAuth.endSession()</code> to end
  the IdP session, then clears local tokens</li>
<li>On platforms without flutter_appauth (future): clears local tokens only; proper
  endSession support deferred until platform-specific auth is implemented</li>
</ul>
<h2 id="platform-auth-flow">Platform Auth Flow</h2>
<p>Single file <code>auth_flow.dart</code> with platform-appropriate implementation:</p>
<h3 id="mvp-iosmacos-direct-oidc-via-flutter_appauth">MVP: iOS/macOS (Direct OIDC via flutter_appauth)</h3>
<p>Uses <code>flutter_appauth</code> with ASWebAuthenticationSession. PKCE handled automatically.</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">const</span><span class="w"> </span><span class="n">_redirectUri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ai.soliplex.client://callback&#39;</span><span class="p">;</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="n">Future</span><span class="o">&lt;</span><span class="n">AuthResult</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authenticate</span><span class="p">(</span><span class="n">OidcIssuer</span><span class="w"> </span><span class="n">issuer</span><span class="p">)</span><span class="w"> </span><span class="kd">async</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">  </span><span class="c1">// flutter_appauth handles:</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">  </span><span class="c1">// - PKCE code_verifier/code_challenge generation</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">  </span><span class="c1">// - State parameter generation and validation</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">  </span><span class="c1">// - Opening ASWebAuthenticationSession</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">  </span><span class="c1">// - Code exchange with IdP token endpoint</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">await</span><span class="w"> </span><span class="n">appAuth</span><span class="p">.</span><span class="n">authorizeAndExchangeCode</span><span class="p">(</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">    </span><span class="n">AuthorizationTokenRequest</span><span class="p">(</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">      </span><span class="n">issuer</span><span class="p">.</span><span class="n">clientId</span><span class="p">,</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">      </span><span class="n">_redirectUri</span><span class="p">,</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">      </span><span class="nl">discoveryUrl:</span><span class="w"> </span><span class="n">issuer</span><span class="p">.</span><span class="n">discoveryUrl</span><span class="p">,</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">      </span><span class="nl">scopes:</span><span class="w"> </span><span class="n">issuer</span><span class="p">.</span><span class="n">scope</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">      </span><span class="nl">externalUserAgent:</span><span class="w"> </span><span class="n">ExternalUserAgent</span><span class="p">.</span><span class="n">ephemeralAsWebAuthenticationSession</span><span class="p">,</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">  </span><span class="p">);</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">AuthResult</span><span class="p">(</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">    </span><span class="nl">accessToken:</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">accessToken</span><span class="o">!</span><span class="p">,</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">    </span><span class="nl">refreshToken:</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">refreshToken</span><span class="p">,</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">    </span><span class="nl">idToken:</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">idToken</span><span class="p">,</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">    </span><span class="nl">expiresAt:</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">accessTokenExpirationDateTime</span><span class="p">,</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="w">  </span><span class="p">);</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Platform configuration required:</strong></p>
<ul>
<li>macOS: <code>Info.plist</code> with <code>CFBundleURLSchemes</code> for custom URL scheme</li>
<li>iOS: Same <code>Info.plist</code> configuration</li>
</ul>
<h3 id="post-mvp-desktop-windows-linux">Post-MVP: Desktop (Windows, Linux)</h3>
<p>Loopback server with state validation (deferred).</p>
<h3 id="post-mvp-web">Post-MVP: Web</h3>
<p>Redirect flow with memory-only storage (deferred).</p>
<h2 id="http-integration">HTTP Integration</h2>
<h3 id="token-injection">Token Injection</h3>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kd">final</span><span class="w"> </span><span class="n">authenticatedTransportProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Provider</span><span class="o">&lt;</span><span class="n">HttpTransport</span><span class="o">&gt;</span><span class="p">((</span><span class="n">ref</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">transport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ref</span><span class="p">.</span><span class="n">watch</span><span class="p">(</span><span class="n">httpTransportProvider</span><span class="p">);</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">authState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ref</span><span class="p">.</span><span class="n">watch</span><span class="p">(</span><span class="n">authProvider</span><span class="p">);</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authState</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">Authenticated</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">authState</span><span class="p">.</span><span class="n">accessToken</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">AuthenticatedHttpTransport</span><span class="p">(</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span><span class="nl">transport:</span><span class="w"> </span><span class="n">transport</span><span class="p">,</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">    </span><span class="nl">getToken:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">token</span><span class="p">,</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">  </span><span class="p">);</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="p">});</span>
</span></code></pre></div>
<h3 id="401-handling">401 Handling</h3>
<p>On <code>AuthException</code> (401/403):</p>
<ol>
<li>If refresh token available and not expired: attempt refresh</li>
<li>If refresh fails or no refresh token: transition to Unauthenticated</li>
<li>Router redirect guard navigates to <code>/login</code></li>
</ol>
<h3 id="http-observer-filtering">HTTP Observer Filtering</h3>
<p>Filter sensitive data from logs:</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">const</span><span class="w"> </span><span class="n">_sensitiveHeaders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">  </span><span class="s1">&#39;authorization&#39;</span><span class="p">,</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">  </span><span class="s1">&#39;cookie&#39;</span><span class="p">,</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">  </span><span class="s1">&#39;set-cookie&#39;</span><span class="p">,</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">  </span><span class="s1">&#39;www-authenticate&#39;</span><span class="p">,</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="p">};</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="k">const</span><span class="w"> </span><span class="n">_sensitiveParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">  </span><span class="s1">&#39;token&#39;</span><span class="p">,</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">  </span><span class="s1">&#39;access_token&#39;</span><span class="p">,</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">  </span><span class="s1">&#39;refresh_token&#39;</span><span class="p">,</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">  </span><span class="s1">&#39;id_token&#39;</span><span class="p">,</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">  </span><span class="s1">&#39;code&#39;</span><span class="p">,</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">  </span><span class="s1">&#39;client_secret&#39;</span><span class="p">,</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">  </span><span class="s1">&#39;state&#39;</span><span class="p">,</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">  </span><span class="s1">&#39;code_verifier&#39;</span><span class="p">,</span><span class="w">   </span><span class="c1">// PKCE verifier</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="w">  </span><span class="s1">&#39;session_state&#39;</span><span class="p">,</span><span class="w">   </span><span class="c1">// Keycloak session metadata</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="p">};</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="k">const</span><span class="w"> </span><span class="n">_sensitiveBodyFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="w">  </span><span class="s1">&#39;access_token&#39;</span><span class="p">,</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="w">  </span><span class="s1">&#39;refresh_token&#39;</span><span class="p">,</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="w">  </span><span class="s1">&#39;id_token&#39;</span><span class="p">,</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="w">  </span><span class="s1">&#39;code&#39;</span><span class="p">,</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="w">  </span><span class="s1">&#39;session_state&#39;</span><span class="p">,</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="p">};</span>
</span></code></pre></div>
<p><strong>Deferred (post-MVP):</strong></p>
<ul>
<li>JWT pattern regex detection (<code>eyJ[A-Za-z0-9-_]+\.eyJ...</code>) for catch-all redaction</li>
<li>Response header <code>www-authenticate</code> parsing for token format leakage</li>
</ul>
<h2 id="router-integration">Router Integration</h2>
<h3 id="routes">Routes</h3>
<table>
<thead>
<tr>
<th>Route</th>
<th>Screen</th>
<th>Auth Required</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/login</code></td>
<td>LoginScreen</td>
<td>No</td>
</tr>
<tr>
<td><code>/</code></td>
<td>HomeScreen</td>
<td>Yes</td>
</tr>
<tr>
<td><code>/rooms/*</code></td>
<td>Room screens</td>
<td>Yes</td>
</tr>
<tr>
<td><code>/settings</code></td>
<td>SettingsScreen</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<h3 id="redirect-guard">Redirect Guard</h3>
<p>The router uses <code>refreshListenable</code> to trigger redirect re-evaluation on auth status
changes without recreating the router itself. This preserves navigation state during
token refresh (which updates auth state but shouldn't cause navigation).</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kd">final</span><span class="w"> </span><span class="n">routerProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Provider</span><span class="o">&lt;</span><span class="n">GoRouter</span><span class="o">&gt;</span><span class="p">((</span><span class="n">ref</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">  </span><span class="c1">// authStatusListenableProvider only fires on login/logout transitions,</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">  </span><span class="c1">// NOT on token refresh. This prevents navigation state loss.</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="w">  </span><span class="kd">final</span><span class="w"> </span><span class="n">authStatusListenable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ref</span><span class="p">.</span><span class="n">watch</span><span class="p">(</span><span class="n">authStatusListenableProvider</span><span class="p">);</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">GoRouter</span><span class="p">(</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">    </span><span class="nl">initialLocation:</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">    </span><span class="nl">refreshListenable:</span><span class="w"> </span><span class="n">authStatusListenable</span><span class="p">,</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">    </span><span class="nl">redirect:</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">      </span><span class="c1">// Use ref.read() for fresh auth state, not a captured variable</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">authState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ref</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">authProvider</span><span class="p">);</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">isAuthenticated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authState</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">Authenticated</span><span class="p">;</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">      </span><span class="kd">final</span><span class="w"> </span><span class="n">isLoginRoute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">matchedLocation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;/login&#39;</span><span class="p">;</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isAuthenticated</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">isLoginRoute</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;/login&#39;</span><span class="p">;</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isAuthenticated</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">isLoginRoute</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">;</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">    </span><span class="c1">// ...routes</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">  </span><span class="p">);</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="p">});</span>
</span></code></pre></div>
<p><strong>Key implementation detail:</strong> <code>_AuthStatusListenable</code> tracks whether user is
authenticated (boolean), not the full auth state. When tokens refresh, the boolean
stays <code>true</code>, so no notification fires and the router doesn't rebuild. On logout,
the boolean changes from <code>true</code> to <code>false</code>, triggering redirect evaluation.</p>
<h3 id="startup-ux">Startup UX</h3>
<p>On app launch, <code>restoreSession()</code> checks for stored tokens. During this async check:</p>
<ol>
<li>Show loading indicator (centered spinner or splash)</li>
<li>Once auth state resolves:</li>
<li>Authenticated → navigate to home</li>
<li>Unauthenticated → navigate to login</li>
</ol>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1">// In app initialization</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="kd">await</span><span class="w"> </span><span class="n">ref</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">authProvider</span><span class="p">.</span><span class="n">notifier</span><span class="p">).</span><span class="n">restoreSession</span><span class="p">();</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="c1">// Auth state now resolved, router redirect guard takes over</span>
</span></code></pre></div>
<h2 id="secure-storage">Secure Storage</h2>
<table>
<thead>
<tr>
<th>Platform</th>
<th>Storage Mechanism</th>
</tr>
</thead>
<tbody>
<tr>
<td>iOS</td>
<td>Keychain</td>
</tr>
<tr>
<td>macOS</td>
<td>Keychain</td>
</tr>
<tr>
<td>Android</td>
<td>EncryptedSharedPreferences (post-MVP)</td>
</tr>
<tr>
<td>Windows</td>
<td>DPAPI (post-MVP)</td>
</tr>
<tr>
<td>Linux</td>
<td>libsecret (post-MVP)</td>
</tr>
<tr>
<td>Web</td>
<td>Memory only (post-MVP)</td>
</tr>
</tbody>
</table>
<p><strong>Keychain Configuration</strong> (MVP):</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">const</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FlutterSecureStorage</span><span class="p">(</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">  </span><span class="nl">iOptions:</span><span class="w"> </span><span class="n">IOSOptions</span><span class="p">(</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">    </span><span class="nl">accessibility:</span><span class="w"> </span><span class="n">KeychainAccessibility</span><span class="p">.</span><span class="n">first_unlock_this_device</span><span class="p">,</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">  </span><span class="p">),</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">  </span><span class="nl">mOptions:</span><span class="w"> </span><span class="n">MacOsOptions</span><span class="p">(</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">    </span><span class="nl">accessibility:</span><span class="w"> </span><span class="n">KeychainAccessibility</span><span class="p">.</span><span class="n">first_unlock_this_device</span><span class="p">,</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">  </span><span class="p">),</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="p">);</span>
</span></code></pre></div>
<p><strong>Accessibility choice</strong>: <code>first_unlock_this_device</code> (not <code>whenUnlockedThisDeviceOnly</code>) because:</p>
<ul>
<li>Enables background token refresh without requiring device to be actively unlocked</li>
<li>Still prevents backup/restore to different devices (<code>thisDeviceOnly</code> suffix)</li>
<li>Still requires at least one unlock after boot before tokens are accessible</li>
<li>Tradeoff: tokens accessible when device is locked (after first unlock)</li>
</ul>
<p>This prevents:</p>
<ul>
<li>Tokens being restored from backup to another device</li>
<li>Access before first device unlock after boot</li>
</ul>
<p><strong>Storage Keys</strong>:</p>
<ul>
<li><code>auth_access_token</code></li>
<li><code>auth_refresh_token</code></li>
<li><code>auth_id_token</code> (required for endSession)</li>
<li><code>auth_expires_at</code></li>
<li><code>auth_issuer_id</code> (to know which IdP config to use for refresh)</li>
<li><code>auth_issuer_discovery_url</code> (required for endSession)</li>
</ul>
<h2 id="token-refresh-strategy">Token Refresh Strategy</h2>
<p>Backend does not provide a refresh endpoint. Client refreshes directly with IdP
using the same HTTP stack (so refresh calls are observable).</p>
<h3 id="flow">Flow</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>1. On app start, GET /api/login → OidcIssuer { server_url, client_id }
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>2. GET {server_url}/.well-known/openid-configuration → { token_endpoint }
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>3. Cache token_endpoint for refresh calls
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>4. When access_token nearing expiry (1 min before):
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>   POST {token_endpoint}  ◄── Goes through ObservableHttpClient
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>   Content-Type: application/x-www-form-urlencoded
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>   grant_type=refresh_token
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>   refresh_token={stored_refresh_token}
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>   client_id={client_id}
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>5. IdP returns: { access_token, refresh_token, expires_in, refresh_expires_in }
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>6. Store new tokens, update expiry times
</span></code></pre></div>
<h3 id="error-handling">Error Handling</h3>
<table>
<thead>
<tr>
<th>Error</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>invalid_grant</code></td>
<td>Refresh token expired/revoked → clear tokens, require re-login</td>
</tr>
<tr>
<td>Network error</td>
<td>Retry with exponential backoff, max 3 attempts</td>
</tr>
<tr>
<td>Other OAuth error</td>
<td>Log error, require re-login</td>
</tr>
</tbody>
</table>
<h3 id="token-refresh-failure-handling-policy">Token Refresh Failure Handling Policy</h3>
<p>Token refresh failures are handled differently at <strong>startup</strong> vs <strong>runtime</strong>. This
asymmetry is intentional.</p>
<h4 id="startup-session-restore">Startup (Session Restore)</h4>
<p>When the app launches with stored but expired tokens, <code>_tryRefreshStoredTokens</code> attempts
refresh. <strong>All failures result in logout:</strong></p>
<table>
<thead>
<tr>
<th>Failure Reason</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>invalidGrant</code></td>
<td>Clear tokens, logout</td>
</tr>
<tr>
<td><code>networkError</code></td>
<td>Clear tokens, logout</td>
</tr>
<tr>
<td><code>noRefreshToken</code></td>
<td>Clear tokens, logout</td>
</tr>
<tr>
<td>Exception thrown</td>
<td>Clear tokens, logout</td>
</tr>
</tbody>
</table>
<p><strong>Rationale:</strong> At startup, we're trying to <em>establish</em> trust from stored credentials.
If we can't validate tokens (for any reason), we have nothing useful—the tokens are
stale and we can't verify them. Failing fast with "please log in" is clearer than
pretending authentication succeeded when we can't verify it.</p>
<h4 id="runtime-active-session">Runtime (Active Session)</h4>
<p>When refresh is triggered during an active session (proactive refresh or 401 retry),
<code>tryRefresh</code> distinguishes between failure types:</p>
<table>
<thead>
<tr>
<th>Failure Reason</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>invalidGrant</code></td>
<td>Clear tokens, logout (refresh token is dead)</td>
</tr>
<tr>
<td><code>networkError</code></td>
<td>Preserve session, return <code>false</code> (transient failure)</td>
</tr>
<tr>
<td><code>noRefreshToken</code></td>
<td>Preserve session, return <code>false</code> (can't recover)</td>
</tr>
<tr>
<td><code>unknownError</code></td>
<td>Preserve session, return <code>false</code> (optimistic)</td>
</tr>
</tbody>
</table>
<p><strong>Rationale:</strong> At runtime, we already established trust. A transient network error
shouldn't destroy a valid session. The user stays "authenticated" in local state and
can retry when network returns. Only a definitive rejection from the IdP (<code>invalidGrant</code>)
triggers logout.</p>
<h4 id="why-not-align-both-to-the-same-policy">Why Not Align Both to the Same Policy?</h4>
<p><strong>Option: Make startup lenient (like runtime)</strong></p>
<p>If the device is offline at launch with valid refresh tokens, the user would stay
"authenticated" but unable to make API calls. This creates confusing UX: "I'm logged
in but nothing works." Every API call would fail, attempt refresh, fail again.</p>
<p><strong>Option: Make runtime strict (like startup)</strong></p>
<p>Network blips would log users out, destroying valid sessions unnecessarily. Users
would need to re-authenticate after every transient network failure.</p>
<p><strong>Chosen: Asymmetric policy</strong></p>
<ul>
<li>Startup: Strict (fail fast, clear "please log in" prompt)</li>
<li>Runtime: Lenient (preserve session through transient failures)</li>
</ul>
<p>This matches user expectations: "If I was logged in, a bad wifi moment shouldn't
kick me out. But if I'm starting fresh, just show me the login screen."</p>
<h2 id="deployment-requirements">Deployment Requirements</h2>
<p>These are backend/infrastructure requirements outside the app's control:</p>
<table>
<thead>
<tr>
<th>Requirement</th>
<th>Owner</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Keycloak redirect URI</td>
<td>Backend</td>
<td>Must configure <code>net.soliplex.app://callback</code> in Keycloak client</td>
</tr>
<tr>
<td>Refresh token rotation</td>
<td>Backend</td>
<td>Keycloak should rotate refresh tokens on each use</td>
</tr>
<tr>
<td>CORS (web only)</td>
<td>Backend</td>
<td>Not needed for MVP (native only)</td>
</tr>
</tbody>
</table>
<p><strong>Refresh Token Rotation:</strong></p>
<p>If Keycloak returns a new refresh token on refresh, the app stores the new token.
If Keycloak is NOT configured for rotation, a leaked refresh token grants indefinite
access until it expires.</p>
<h2 id="security-requirements">Security Requirements</h2>
<table>
<thead>
<tr>
<th>Requirement</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td>PKCE</td>
<td>flutter_appauth handles automatically</td>
</tr>
<tr>
<td>No embedded WebView</td>
<td>flutter_appauth uses ASWebAuthenticationSession</td>
</tr>
<tr>
<td>Secure token storage</td>
<td>flutter_secure_storage (Keychain) with <code>first_unlock_this_device</code></td>
</tr>
<tr>
<td>Token filtering in logs</td>
<td>HttpObserver sanitization</td>
</tr>
<tr>
<td>State parameter</td>
<td>flutter_appauth handles automatically</td>
</tr>
<tr>
<td>HTTPS only</td>
<td>Enforced by config validation</td>
</tr>
</tbody>
</table>
<h2 id="implementation-slices-vertical">Implementation Slices (Vertical)</h2>
<h3 id="spike-validate-direct-oidc-on-macos-ios">Spike: Validate Direct OIDC on macOS + iOS</h3>
<p>Research findings:</p>
<ul>
<li>[x] <code>/api/login</code> returns IdP config: <code>{ server_url, client_id, scope }</code></li>
<li>[x] Direct OIDC approach confirmed (per <code>clean_soliplex</code> implementation)</li>
<li>[x] flutter_appauth supports macOS + iOS via ASWebAuthenticationSession</li>
</ul>
<p>Spike deliverable (before Slice 1):</p>
<ul>
<li>[ ] Minimal test app with flutter_appauth</li>
<li>[ ] Confirm login flow works with Keycloak IdP on macOS</li>
<li>[ ] Confirm login flow works on iOS</li>
<li>[ ] Validate token returned and usable for API call</li>
</ul>
<h3 id="slice-1-walking-skeleton-http-filtering">Slice 1: Walking Skeleton + HTTP Filtering</h3>
<p><strong>Delivers</strong>: Login on macOS, make authenticated API call, sensitive data redacted.</p>
<p><strong>Acceptance</strong>: User can login, see protected content. HTTP inspector shows <code>[REDACTED]</code>
for tokens.</p>
<p>Files:</p>
<ul>
<li><code>lib/core/auth/auth_state.dart</code></li>
<li><code>lib/core/auth/oidc_issuer.dart</code></li>
<li><code>lib/core/auth/auth_flow.dart</code></li>
<li><code>lib/core/auth/auth_notifier.dart</code></li>
<li><code>lib/core/auth/idp_client.dart</code></li>
<li><code>lib/core/providers/auth_provider.dart</code></li>
<li><code>lib/features/login/login_screen.dart</code></li>
<li><code>lib/core/router/app_router.dart</code> (modify)</li>
<li><code>packages/soliplex_client/lib/src/http/http_observer.dart</code> (modify - filtering)</li>
<li><code>macos/Runner/Info.plist</code> (URL scheme)</li>
<li><code>macos/Runner/DebugProfile.entitlements</code></li>
<li><code>macos/Runner/Release.entitlements</code></li>
<li><code>ios/Runner/Info.plist</code> (URL scheme)</li>
</ul>
<h3 id="slice-2-session-persistence">Slice 2: Session Persistence</h3>
<p><strong>Delivers</strong>: Tokens survive app restart. Loading indicator during restore.</p>
<p><strong>Acceptance</strong>: Close app while authenticated, reopen, see loading indicator briefly,
then authenticated content.</p>
<p>Files:</p>
<ul>
<li>Modify <code>auth_notifier.dart</code> to use flutter_secure_storage with Keychain config</li>
<li>Add loading state handling in router/UI</li>
</ul>
<h3 id="slice-3-token-refresh-401-recovery">Slice 3: Token Refresh + 401 Recovery</h3>
<p><strong>Delivers</strong>: Access tokens refresh before expiry. Automatic retry on 401.</p>
<p><strong>Acceptance</strong>: App remains authenticated beyond initial token lifetime. Expired token
triggers refresh and retry transparently.</p>
<p>Files:</p>
<ul>
<li><code>lib/core/auth/authenticated_transport.dart</code></li>
<li>Modify <code>lib/core/providers/api_provider.dart</code></li>
<li>Modify <code>auth_notifier.dart</code> for refresh logic via IdpClient</li>
</ul>
<h2 id="dependencies">Dependencies</h2>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nt">dependencies</span><span class="p">:</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">  </span><span class="nt">flutter_appauth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^8.0.0</span><span class="w">        </span><span class="c1"># Native OAuth (iOS/macOS)</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">  </span><span class="nt">flutter_secure_storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^9.2.0</span><span class="w"> </span><span class="c1"># Secure token storage</span>
</span></code></pre></div>
<p>Post-MVP:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="w">  </span><span class="nt">url_launcher</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^6.3.0</span><span class="w">           </span><span class="c1"># System browser (desktop)</span>
</span></code></pre></div>
<h2 id="test-plan">Test Plan</h2>
<h3 id="unit-tests">Unit Tests</h3>
<ul>
<li>[x] AuthState.isExpired / needsRefresh</li>
<li>[x] TokenRefreshService (13 tests: success, validation, errors, SSRF)</li>
<li>[x] RefreshingHttpClient (19 tests: retry, deduplication, proactive refresh)</li>
<li>[x] AuthNotifier (15 tests: restore, runtime refresh, failure policies)</li>
<li>[ ] Token parsing from callback URI</li>
<li>[ ] State parameter generation and validation</li>
<li>[x] HTTP observer filtering rules</li>
</ul>
<h3 id="widget-tests">Widget Tests</h3>
<ul>
<li>[ ] LoginScreen fetches and renders providers</li>
<li>[ ] LoginScreen handles loading/error states</li>
<li>[ ] Auth redirect guard behavior</li>
</ul>
<h3 id="integration-tests">Integration Tests</h3>
<ul>
<li>[x] Full auth flow on macOS (spike validated)</li>
<li>[x] Full auth flow on iOS (spike validated)</li>
<li>[ ] Token refresh with artificially short expiry (manual test)</li>
<li>[x] Session restore: write tokens, restart provider, verify state (unit tested)</li>
</ul>
<h2 id="file-structure">File Structure</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>lib/core/auth/
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>├── auth_state.dart              # Sealed class (AuthState, Authenticated, etc.)
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>├── auth_storage.dart            # Keychain storage wrapper
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>├── auth_notifier.dart           # State management + TokenRefresher impl
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>├── auth_provider.dart           # Riverpod providers
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>├── auth_flow.dart               # authenticate, endSession (flutter_appauth)
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>└── oidc_issuer.dart             # Model from /api/login
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>packages/soliplex_client/lib/src/http/
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>├── token_refresher.dart         # Interface for refresh operations
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>└── refreshing_http_client.dart  # HTTP decorator for refresh + 401 retry
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>packages/soliplex_client/lib/src/auth/
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>└── token_refresh_service.dart   # Pure Dart service for token refresh
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>packages/soliplex_client/lib/src/api/
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>└── fetch_auth_providers.dart    # Backend API for /api/login
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>packages/soliplex_client/lib/src/domain/
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>└── auth_provider_config.dart    # Domain model for auth providers
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>lib/core/providers/
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>└── api_provider.dart            # HTTP client wiring with RefreshingHttpClient
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a>lib/features/login/
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a>└── login_screen.dart            # Provider selection UI
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a>Platform config:
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a>├── macos/Runner/Info.plist      # URL scheme
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a>├── macos/Runner/*.entitlements  # Network access
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a>└── ios/Runner/Info.plist        # URL scheme
</span></code></pre></div>
<h2 id="component-summary">Component Summary</h2>
<table>
<thead>
<tr>
<th>Component</th>
<th>Purpose</th>
<th>Lines (est)</th>
</tr>
</thead>
<tbody>
<tr>
<td>AuthState</td>
<td>Sealed class with token fields</td>
<td>~60</td>
</tr>
<tr>
<td>AuthStorage</td>
<td>Keychain storage wrapper</td>
<td>~80</td>
</tr>
<tr>
<td>AuthNotifier</td>
<td>State management + TokenRefresher impl</td>
<td>~250</td>
</tr>
<tr>
<td>auth_flow.dart</td>
<td>authenticate + endSession (flutter_appauth)</td>
<td>~80</td>
</tr>
<tr>
<td>OidcIssuer</td>
<td>Model from /api/login</td>
<td>~50</td>
</tr>
<tr>
<td>TokenRefresher</td>
<td>Interface for refresh operations</td>
<td>~20</td>
</tr>
<tr>
<td>TokenRefreshService</td>
<td>Pure Dart refresh logic with result type</td>
<td>~230</td>
</tr>
<tr>
<td>RefreshingHttpClient</td>
<td>HTTP decorator, 401 retry, CWE-834</td>
<td>~120</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td></td>
<td><strong>~890</strong></td>
</tr>
</tbody>
</table>
<h2 id="resolved-questions">Resolved Questions</h2>
<ol>
<li><strong>Auth approach</strong>: Direct OIDC via flutter_appauth (not BFF pattern)</li>
<li><strong>Token refresh</strong>: Via IdpClient using shared HTTP client (observable)</li>
<li><strong>HTTP client architecture</strong>: Single HTTP client, ObservableHttpClient wraps it, both SoliplexApi and IdpClient use it</li>
<li><strong>Logout</strong>: Full OIDC logout via <code>endSession</code> on platforms with flutter_appauth (iOS/macOS); local-only logout on other platforms until proper auth is implemented</li>
<li><strong>Multiple providers</strong>: Support one at a time (can switch by logging out first)</li>
<li><strong>Auth observability</strong>: Browser flow not observable; refresh calls are observable</li>
<li><strong>Platform scope</strong>: MVP = macOS + iOS; Desktop/Web deferred</li>
<li><strong>Keychain security</strong>: <code>first_unlock_this_device</code> to enable background refresh while preventing backup/restore attacks</li>
<li><strong>Startup UX</strong>: Loading indicator until auth state resolves</li>
<li><strong>refreshExpiresAt</strong>: Omitted - let <code>invalid_grant</code> signal refresh token expiry</li>
</ol>
<h2 id="web-platform-support-deferred">Web Platform Support (Deferred)</h2>
<p>Web requires a different authentication approach because:</p>
<ol>
<li><code>flutter_appauth</code> uses <code>dart:ffi</code> which is unavailable on web</li>
<li><code>cupertino_http</code> (used by <code>soliplex_client_native</code>) also uses <code>dart:ffi</code></li>
<li>CORS restrictions prevent direct OIDC token exchange from browser</li>
</ol>
<h3 id="backend-for-frontend-bff-pattern">Backend-For-Frontend (BFF) Pattern</h3>
<p>The backend already provides BFF endpoints for web authentication:</p>
<ul>
<li><code>GET /api/login/{provider_id}?return_to={callback_url}</code> - Initiates OAuth flow</li>
<li>Backend handles PKCE, code exchange, and redirects back with tokens</li>
</ul>
<h3 id="implementation-requirements">Implementation Requirements</h3>
<p><strong>HTTP Client for Web:</strong></p>
<p><code>soliplex_client_native</code> unconditionally exports <code>cupertino_http_client.dart</code>, which imports
<code>cupertino_http</code> (dart:ffi). Fix with conditional export:</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1">// clients.dart</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="k">export</span><span class="w"> </span><span class="s1">&#39;cupertino_http_client.dart&#39;</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">    </span><span class="n">if</span><span class="w"> </span><span class="err">(</span><span class="n">dart</span><span class="err">.</span><span class="n">library</span><span class="err">.</span><span class="n">js_interop</span><span class="err">)</span><span class="w"> </span><span class="s1">&#39;cupertino_http_client_web.dart&#39;</span><span class="p">;</span>
</span></code></pre></div>
<p>Create <code>cupertino_http_client_web.dart</code> that throws <code>UnsupportedError</code> if instantiated
(web should use <code>DartHttpClient</code> via <code>createPlatformClient()</code> instead).</p>
<p><strong>Auth Flow for Web:</strong></p>
<p>New files needed (reference: <code>clean_soliplex/src/flutter/lib/core/auth/</code>):</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>callback_params.dart</code></td>
<td>Sealed class for URL callback params</td>
</tr>
<tr>
<td><code>web_auth_callback_handler.dart</code></td>
<td>Conditional import dispatcher</td>
</tr>
<tr>
<td><code>web_auth_callback_native.dart</code></td>
<td>No-op for native platforms</td>
</tr>
<tr>
<td><code>web_auth_callback_web.dart</code></td>
<td>Extracts tokens from URL using <code>web</code> package</td>
</tr>
<tr>
<td><code>web_auth_pending_storage.dart</code></td>
<td>Stores pending auth session for callback</td>
</tr>
<tr>
<td><code>features/auth/auth_callback_screen.dart</code></td>
<td>Route <code>/auth/callback</code></td>
</tr>
</tbody>
</table>
<p><strong>Auth Flow Changes:</strong></p>
<p>Modify <code>auth_flow.dart</code> to detect web platform and redirect to backend BFF endpoint
instead of using <code>flutter_appauth</code>. Web flow:</p>
<ol>
<li>User clicks login → redirect to <code>/api/login/{provider_id}?return_to=/auth/callback</code></li>
<li>Backend handles OAuth, redirects back with <code>?token=xxx&amp;refresh_token=xxx&amp;expires_in=xxx</code></li>
<li><code>AuthCallbackScreen</code> extracts tokens from URL, stores them, navigates to home</li>
</ol>
<p><strong>Router Changes:</strong></p>
<p>Add <code>/auth/callback</code> route that renders <code>AuthCallbackScreen</code>.</p>
<p><strong>Dependencies:</strong></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nt">dependencies</span><span class="p">:</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">  </span><span class="nt">url_launcher</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^6.3.0</span><span class="w">  </span><span class="c1"># For web redirect</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">  </span><span class="nt">web</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^1.0.0</span><span class="w">           </span><span class="c1"># For URL manipulation on web</span>
</span></code></pre></div>
<p><strong>Token Storage:</strong></p>
<p>Web should use memory-only storage (no <code>flutter_secure_storage</code> persistence) due to
browser security model. Tokens cleared on page refresh.</p>
<h3 id="estimated-effort">Estimated Effort</h3>
<p>~6-8 new files, modifications to auth_flow.dart, router, and soliplex_client_native.
Approximately 400-600 lines of new code.</p>
<h2 id="deferred-items">Deferred Items</h2>
<ul>
<li>Windows/Linux loopback server implementation (includes endSession support)</li>
<li>Web platform authentication (see "Web Platform Support" section above)</li>
<li>Multiple simultaneous provider sessions</li>
<li>Android support (flutter_appauth supported, endSession will work)</li>
<li>JWT pattern regex for catch-all token redaction in logs</li>
<li><code>www-authenticate</code> header parsing</li>
<li>Auth-optional mode: skip login when backend returns empty providers list</li>
<li>AuthNotifier testability: inject AuthFlow interface for unit testing</li>
<li>OIDC nonce parameter: verify flutter_appauth handles internally or add explicit nonce</li>
</ul>
<hr />
<h2 id="implementation-progress">Implementation Progress</h2>
<p>Track implementation status here. Update after each phase.</p>
<h3 id="spike-status-complete">Spike Status: ✅ Complete</h3>
<ul>
<li>[x] Add flutter_appauth dependency (v11.0.0)</li>
<li>[x] Configure macOS URL scheme (<code>ai.soliplex.client://callback</code>)</li>
<li>[x] Create spike test screen at <code>/auth-spike</code></li>
<li>[x] macOS app builds and runs successfully</li>
<li>[x] Configure iOS URL scheme (<code>ai.soliplex.client://callback</code>)</li>
<li>[x] Test login flow on macOS</li>
<li>[x] Test login flow on iOS (simulator)</li>
<li>[x] Validate token usable for API call</li>
</ul>
<p><strong>Spike Findings:</strong></p>
<ul>
<li>flutter_appauth v11.0 API: use <code>externalUserAgent: ExternalUserAgent.ephemeralAsWebAuthenticationSession</code></li>
<li>Redirect URI must match Keycloak client config: <code>ai.soliplex.client://callback</code></li>
<li>OIDC discovery and token exchange work correctly with pydio Keycloak</li>
<li>Access token successfully used for authenticated API calls</li>
<li>Tested on both macOS and iOS (simulator) - both platforms work</li>
</ul>
<p><strong>Files created:</strong></p>
<ul>
<li><code>lib/core/auth/oidc_issuer.dart</code> - OidcIssuer model</li>
<li><code>lib/core/auth/auth_flow.dart</code> - flutter_appauth wrapper</li>
<li><code>lib/features/auth_spike/auth_spike_screen.dart</code> - test screen</li>
</ul>
<h3 id="slice-1-status-complete">Slice 1 Status: ✅ Complete</h3>
<ul>
<li>[x] <code>lib/core/auth/auth_state.dart</code> - Sealed AuthState classes</li>
<li>[x] <code>lib/core/auth/oidc_issuer.dart</code> - OidcIssuer wrapper</li>
<li>[x] <code>lib/core/auth/auth_flow.dart</code> - flutter_appauth wrapper with generic error messages</li>
<li>[x] <code>lib/core/auth/auth_notifier.dart</code> - Riverpod state management</li>
<li>[x] <code>lib/core/auth/auth_provider.dart</code> - Auth providers (authProvider, oidcIssuersProvider)</li>
<li>[x] <code>lib/features/login/login_screen.dart</code> - Login UI with provider selection</li>
<li>[x] <code>lib/core/router/app_router.dart</code> - Auth-aware routing with redirect</li>
<li>[x] <code>lib/core/providers/http_log_provider.dart</code> - Sensitive query param redaction</li>
<li>[x] <code>lib/core/providers/api_provider.dart</code> - Authenticated HTTP client wiring</li>
<li>[x] <code>packages/soliplex_client/.../authenticated_http_client.dart</code> - Token injection</li>
<li>[x] <code>packages/soliplex_client/.../fetch_auth_providers.dart</code> - Backend API</li>
<li>[x] <code>packages/soliplex_client/.../auth_provider_config.dart</code> - Domain model</li>
<li>[ ] <code>lib/core/auth/idp_client.dart</code> - Deferred (YAGNI for now)</li>
</ul>
<p><strong>Notes:</strong></p>
<ul>
<li><code>idp_client.dart</code> deferred - direct API calls sufficient for MVP</li>
<li>HTTP filtering in <code>http_log_provider.dart</code> not <code>http_observer.dart</code></li>
<li>Error messages sanitized per Sentinel review (generic to user, full in logs)</li>
</ul>
<h3 id="slice-2-status-complete">Slice 2 Status: ✅ Complete</h3>
<ul>
<li>[x] <code>lib/core/auth/auth_storage.dart</code> - Secure storage wrapper with Keychain config</li>
<li>[x] <code>lib/core/auth/auth_notifier.dart</code> - Session restore and token persistence</li>
<li>[x] <code>lib/core/auth/auth_state.dart</code> - Safe <code>toString()</code> on all states (no token exposure)</li>
<li>[x] <code>lib/app.dart</code> - Loading screen during auth restore</li>
<li>[x] <code>lib/main.dart</code> - <code>clearOnReinstall()</code> for iOS keychain persistence</li>
<li>[x] <code>lib/features/settings/settings_screen.dart</code> - Sign out button (triggers endSession + clears storage)</li>
<li>[x] <code>test/core/auth/auth_storage_test.dart</code> - Storage unit tests</li>
</ul>
<p><strong>Notes:</strong></p>
<ul>
<li>Keychain uses <code>first_unlock_this_device</code> (not spec's original <code>whenUnlockedThisDeviceOnly</code>)
  to enable background token refresh. Spec updated to reflect this.</li>
<li><code>clearOnReinstall()</code> handles iOS behavior where Keychain persists across app reinstalls</li>
<li>Sign out uses <code>flutter_appauth.endSession()</code> to properly terminate IdP session</li>
</ul>
<h3 id="slice-3-status-complete">Slice 3 Status: ✅ Complete</h3>
<ul>
<li>[x] <code>lib/core/auth/auth_storage.dart</code> - Add clientId to storage</li>
<li>[x] <code>lib/core/auth/auth_state.dart</code> - Add clientId to Authenticated, require idToken</li>
<li>[x] <code>lib/core/auth/auth_notifier.dart</code> - Store clientId, implement TokenRefresher</li>
<li>[x] <code>lib/core/auth/auth_flow.dart</code> - Simplified to just authenticate/endSession</li>
<li>[x] <code>packages/soliplex_client/.../token_refresher.dart</code> - Interface for refresh operations</li>
<li>[x] <code>packages/soliplex_client/.../refreshing_http_client.dart</code> - HTTP decorator with 401 retry</li>
<li>[x] <code>packages/soliplex_client/.../token_refresh_service.dart</code> - Pure Dart refresh logic</li>
<li>[x] <code>lib/core/auth/auth_provider.dart</code> - Add tokenRefreshServiceProvider</li>
<li>[x] <code>lib/core/providers/api_provider.dart</code> - Wire RefreshingHttpClient</li>
<li>[x] Handle expired tokens on session restore (attempt refresh before clearing)</li>
<li>[x] Unit tests for TokenRefreshService (13 tests)</li>
<li>[x] Unit tests for RefreshingHttpClient (19 tests)</li>
<li>[x] Unit tests for AuthNotifier (15 tests)</li>
</ul>
<p><strong>Implementation Notes:</strong></p>
<ul>
<li>Token refresh extracted to <code>TokenRefreshService</code> (pure Dart, in soliplex_client)</li>
<li>Returns sealed <code>TokenRefreshResult</code> type (Success/Failure) instead of exceptions</li>
<li>SSRF protection: validates token endpoint origin matches discovery URL</li>
<li><code>RefreshingHttpClient</code> decorator pattern per blacksmith/sentinel review</li>
<li>Single retry limit prevents infinite 401→refresh→401 loops (CWE-834)</li>
<li>Completer pattern deduplicates concurrent refresh attempts with microtask cleanup</li>
<li><code>TokenRefresher</code> interface decouples HTTP client from AuthNotifier</li>
<li><code>idToken</code> now required (not nullable) - needed for proper OIDC logout</li>
<li><code>clientId</code> stored in Keychain alongside other tokens for refresh</li>
</ul>
<p><strong>Architectural Decision (2026-01-05):</strong></p>
<p>Per blacksmith consultation, AuthNotifier implementing TokenRefresher is valid DIP:</p>
<ul>
<li>RefreshingHttpClient depends only on TokenRefresher abstraction</li>
<li>AuthNotifier provides implementation</li>
<li>No actual inversion - the interface is in the right place (HTTP layer defines needs)</li>
</ul>
<p>Testability improved by:</p>
<ul>
<li>Extracting refresh HTTP logic to <code>TokenRefreshService</code> (pure Dart, constructor injection)</li>
<li>AuthNotifier captures dependencies in <code>build()</code> via <code>late final</code> fields</li>
<li>Test by overriding providers (<code>authStorageProvider</code>, <code>tokenRefreshServiceProvider</code>)</li>
</ul>
<p><strong>Riverpod Notifier Dependency Injection Pattern:</strong></p>
<p>Riverpod's <code>Notifier</code> class doesn't support constructor injection because <code>NotifierProvider</code>
uses <code>AuthNotifier.new</code> (the default constructor). The <code>ref</code> object is only available
inside <code>build()</code> and instance methods, not in the constructor.</p>
<p>The solution is <code>late final</code> fields initialized at the start of <code>build()</code>:</p>
<div class="language-dart highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="kd">class</span><span class="w"> </span><span class="nc">AuthNotifier</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Notifier</span><span class="o">&lt;</span><span class="n">AuthState</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">TokenRefresher</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">  </span><span class="kd">late</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AuthStorage</span><span class="w"> </span><span class="n">_storage</span><span class="p">;</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="w">  </span><span class="kd">late</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">TokenRefreshService</span><span class="w"> </span><span class="n">_refreshService</span><span class="p">;</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">  </span><span class="nd">@override</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">  </span><span class="n">AuthState</span><span class="w"> </span><span class="n">build</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">    </span><span class="n">_storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ref</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">authStorageProvider</span><span class="p">);</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">    </span><span class="n">_refreshService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ref</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">tokenRefreshServiceProvider</span><span class="p">);</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">    </span><span class="c1">// ...</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="p">}</span>
</span></code></pre></div>
<p><strong>Lifecycle guarantee:</strong> Riverpod calls <code>build()</code> before exposing the Notifier to callers.
No instance method can be invoked until <code>build()</code> completes and returns the initial state.
The <code>late final</code> fields are always initialized before any method accesses them.</p>
<h3 id="router-navigation-preservation-fix-2026-01-06">Router Navigation Preservation Fix (2026-01-06)</h3>
<p>Fixed issue where token refresh caused navigation state loss. The router was using
<code>ref.watch(authProvider)</code> which recreated the GoRouter on every auth state change
(including token refresh), resetting navigation to <code>initialLocation: '/'</code>.</p>
<p><strong>Solution:</strong></p>
<ul>
<li>Added <code>authStatusListenableProvider</code> that only fires on login/logout transitions</li>
<li>Router uses <code>refreshListenable</code> pattern instead of <code>ref.watch(authProvider)</code></li>
<li>Redirect callback uses <code>ref.read(authProvider)</code> for fresh state reads</li>
</ul>
<p><strong>Files modified:</strong></p>
<ul>
<li><code>lib/core/auth/auth_provider.dart</code> - Added <code>_AuthStatusListenable</code></li>
<li><code>lib/core/router/app_router.dart</code> - Updated to use <code>refreshListenable</code></li>
<li><code>test/core/router/app_router_test.dart</code> - Added tests for auth state changes</li>
</ul>
<p><strong>Tests added:</strong></p>
<ul>
<li><code>logout from deep navigation redirects to /login</code></li>
<li><code>token refresh preserves navigation location</code></li>
</ul>
<h3 id="remaining-work">Remaining Work</h3>
<p><strong>Tests (incremental coverage, not blocking):</strong></p>
<table>
<thead>
<tr>
<th>Category</th>
<th>Item</th>
<th>Priority</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unit</td>
<td>Token parsing from callback URI</td>
<td>Low</td>
</tr>
<tr>
<td>Unit</td>
<td>State parameter generation/validation</td>
<td>Low</td>
</tr>
<tr>
<td>Widget</td>
<td>LoginScreen fetches/renders providers</td>
<td>Medium</td>
</tr>
<tr>
<td>Widget</td>
<td>LoginScreen loading/error states</td>
<td>Medium</td>
</tr>
<tr>
<td>Widget</td>
<td>Auth redirect guard behavior</td>
<td>Medium</td>
</tr>
<tr>
<td>Manual</td>
<td>Token refresh with artificially short expiry</td>
<td>Medium</td>
</tr>
</tbody>
</table>
<p><strong>Current test coverage:</strong> 47 unit tests across TokenRefreshService (13), RefreshingHttpClient (19),
and AuthNotifier (15). Core token refresh functionality is well-tested.</p>
<p><strong>Not remaining (deferred to post-MVP):</strong> See "Deferred Items" section above for Windows/Linux,
Web platform, Android, and other post-MVP work.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "content.footnote.tooltips", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>