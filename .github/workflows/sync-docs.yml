name: Sync Documentation from Repos

on:
  # Trigger from other repos via repository_dispatch
  repository_dispatch:
    types: [docs_updated]

  # Manual trigger
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repository to sync (or "all")'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - soliplex
          - ingester
          - ingester-agents
          - chatbot
          - flutter
          - ag-ui

  # Scheduled sync (daily at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout soliplex.github.io
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Determine which repos to sync
        id: repos
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REPO_INPUT="${{ github.event.inputs.repo }}"
          else
            REPO_INPUT="all"
          fi

          echo "sync_input=$REPO_INPUT" >> $GITHUB_OUTPUT

          # Set flags for which repos to sync
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "soliplex" ]; then
            echo "sync_soliplex=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "ingester" ]; then
            echo "sync_ingester=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "ingester-agents" ]; then
            echo "sync_agents=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "chatbot" ]; then
            echo "sync_chatbot=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "flutter" ]; then
            echo "sync_flutter=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "ag-ui" ]; then
            echo "sync_agui=true" >> $GITHUB_OUTPUT
          fi

      - name: Sync soliplex/soliplex docs
        if: steps.repos.outputs.sync_soliplex == 'true'
        run: |
          chmod +x scripts/sync-repo-docs.sh
          ./scripts/sync-repo-docs.sh \
            soliplex/soliplex \
            docs/soliplex \
            docs

      - name: Sync soliplex/ingester docs
        if: steps.repos.outputs.sync_ingester == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/ingester \
            docs/ingester \
            docs

      # Note: ingester-agents doesn't have a docs/ directory, only README.md
      # Skipping sync for now - can be added later if docs are created

      - name: Sync soliplex/chatbot docs
        if: steps.repos.outputs.sync_chatbot == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/chatbot \
            docs/chatbot \
            docs || echo "⚠️  Failed to sync chatbot (may not exist)"

      - name: Sync soliplex/flutter docs
        if: steps.repos.outputs.sync_flutter == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/flutter \
            docs/flutter \
            docs || echo "⚠️  Failed to sync flutter (may not exist)"

      - name: Sync soliplex/ag-ui docs
        if: steps.repos.outputs.sync_agui == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/ag-ui \
            docs/ag-ui \
            docs || echo "⚠️  Failed to sync ag-ui (may not exist)"

      - name: Generate sync summary
        id: summary
        run: |
          echo "## Documentation Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Synced Repositories:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "docs/soliplex" ]; then
            SOLIPLEX_COUNT=$(find docs/soliplex -type f | wc -l)
            echo "- ✅ **soliplex/soliplex**: $SOLIPLEX_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/ingester" ]; then
            INGESTER_COUNT=$(find docs/ingester -type f | wc -l)
            echo "- ✅ **soliplex/ingester**: $INGESTER_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/agents" ]; then
            AGENTS_COUNT=$(find docs/agents -type f | wc -l)
            echo "- ✅ **soliplex/ingester-agents**: $AGENTS_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/chatbot" ]; then
            CHATBOT_COUNT=$(find docs/chatbot -type f | wc -l)
            echo "- ✅ **soliplex/chatbot**: $CHATBOT_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/flutter" ]; then
            FLUTTER_COUNT=$(find docs/flutter -type f | wc -l)
            echo "- ✅ **soliplex/flutter**: $FLUTTER_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/ag-ui" ]; then
            AGUI_COUNT=$(find docs/ag-ui -type f | wc -l)
            echo "- ✅ **soliplex/ag-ui**: $AGUI_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit and push synced docs directly to main
        continue-on-error: true
        id: push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Force add synced docs (override .gitignore)
          git add --force docs/soliplex/ docs/ingester/ docs/chatbot/ docs/flutter/ docs/ag-ui/ 2>/dev/null || true

          # Check if there are changes
          if git diff --cached --quiet; then
            echo "No documentation changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Committing synced documentation..."
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Create commit
            git commit -m "docs: sync from upstream repositories

Synced repositories:
- soliplex/soliplex
- soliplex/ingester

Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
Triggered by: ${{ github.event_name }}

Co-Authored-By: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

            # Try to push (will fail due to branch protection, but that's OK)
            git push || echo "⚠️  Push failed due to branch protection - this is expected"
          fi

      - name: Create patch file for manual application
        if: steps.push.outputs.has_changes == 'true'
        run: |
          git format-patch -1 HEAD --stdout > sync-docs.patch
          echo "Patch file created: sync-docs.patch"
          echo "To apply manually, run: git am sync-docs.patch"

      - name: Upload synced docs as artifact
        if: steps.push.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: synced-docs-${{ github.run_id }}
          path: |
            docs/soliplex/
            docs/ingester/
            docs/chatbot/
            docs/flutter/
            docs/ag-ui/
            sync-docs.patch
          retention-days: 7

      - name: Summary
        if: steps.push.outputs.has_changes == 'true'
        run: |
          echo "## ⚠️  Manual Action Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Documentation has been synced but could not be pushed due to branch protection." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### To complete the sync:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact 'synced-docs-${{ github.run_id }}' from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract it to your local repository" >> $GITHUB_STEP_SUMMARY
          echo "3. Run: \`git add --force docs/\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Run: \`git commit -m 'docs: sync from upstream repositories'\`" >> $GITHUB_STEP_SUMMARY
          echo "5. Run: \`git push\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Or apply the patch: \`git am sync-docs.patch\`" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        env:
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "❌ Documentation sync failed"
          echo "Run URL: $RUN_URL"
          # Add Slack/Discord notification here if configured
