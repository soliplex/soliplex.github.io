name: Sync Documentation from Repos

on:
  # Trigger from other repos via repository_dispatch
  repository_dispatch:
    types: [docs_updated]

  # Manual trigger
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repository to sync (or "all")'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - soliplex
          - ingester
          - ingester-agents
          - chatbot
          - flutter
          - ag-ui

  # Scheduled sync (daily at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout soliplex.github.io
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Determine which repos to sync
        id: repos
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REPO_INPUT="${{ github.event.inputs.repo }}"
          else
            REPO_INPUT="all"
          fi

          echo "sync_input=$REPO_INPUT" >> $GITHUB_OUTPUT

          # Set flags for which repos to sync
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "soliplex" ]; then
            echo "sync_soliplex=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "ingester" ]; then
            echo "sync_ingester=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "ingester-agents" ]; then
            echo "sync_agents=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "chatbot" ]; then
            echo "sync_chatbot=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "flutter" ]; then
            echo "sync_flutter=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "ag-ui" ]; then
            echo "sync_agui=true" >> $GITHUB_OUTPUT
          fi

      - name: Sync soliplex/soliplex docs
        if: steps.repos.outputs.sync_soliplex == 'true'
        run: |
          chmod +x scripts/sync-repo-docs.sh
          ./scripts/sync-repo-docs.sh \
            soliplex/soliplex \
            docs/soliplex \
            docs

      - name: Sync soliplex/ingester docs
        if: steps.repos.outputs.sync_ingester == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/ingester \
            docs/ingester \
            docs

      - name: Sync soliplex/ingester-agents docs
        if: steps.repos.outputs.sync_agents == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/ingester-agents \
            docs/agents \
            README.md || echo "⚠️  Failed to sync ingester-agents (may not exist)"

      - name: Sync soliplex/chatbot docs
        if: steps.repos.outputs.sync_chatbot == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/chatbot \
            docs/chatbot \
            docs || echo "⚠️  Failed to sync chatbot (may not exist)"

      - name: Sync soliplex/flutter docs
        if: steps.repos.outputs.sync_flutter == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/flutter \
            docs/flutter \
            docs || echo "⚠️  Failed to sync flutter (may not exist)"

      - name: Sync soliplex/ag-ui docs
        if: steps.repos.outputs.sync_agui == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/ag-ui \
            docs/ag-ui \
            docs || echo "⚠️  Failed to sync ag-ui (may not exist)"

      - name: Generate sync summary
        id: summary
        run: |
          echo "## Documentation Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Synced Repositories:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "docs/soliplex" ]; then
            SOLIPLEX_COUNT=$(find docs/soliplex -type f | wc -l)
            echo "- ✅ **soliplex/soliplex**: $SOLIPLEX_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/ingester" ]; then
            INGESTER_COUNT=$(find docs/ingester -type f | wc -l)
            echo "- ✅ **soliplex/ingester**: $INGESTER_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/agents" ]; then
            AGENTS_COUNT=$(find docs/agents -type f | wc -l)
            echo "- ✅ **soliplex/ingester-agents**: $AGENTS_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/chatbot" ]; then
            CHATBOT_COUNT=$(find docs/chatbot -type f | wc -l)
            echo "- ✅ **soliplex/chatbot**: $CHATBOT_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/flutter" ]; then
            FLUTTER_COUNT=$(find docs/flutter -type f | wc -l)
            echo "- ✅ **soliplex/flutter**: $FLUTTER_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/ag-ui" ]; then
            AGUI_COUNT=$(find docs/ag-ui -type f | wc -l)
            echo "- ✅ **soliplex/ag-ui**: $AGUI_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit synced docs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Add all docs changes (force to override .gitignore)
          git add --force docs/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No documentation changes detected"
            echo "CHANGES=false" >> $GITHUB_ENV
          else
            # Create detailed commit message
            echo "Creating commit with synced documentation..."

            # Build commit message
            cat > /tmp/commit_msg.txt << 'COMMIT_EOF'
          docs: sync from upstream repositories

          Synced repositories:
          COMMIT_EOF

            if [ -d "docs/soliplex" ]; then
              echo "- soliplex/soliplex" >> /tmp/commit_msg.txt
            fi

            if [ -d "docs/ingester" ]; then
              echo "- soliplex/ingester" >> /tmp/commit_msg.txt
            fi

            if [ -d "docs/agents" ]; then
              echo "- soliplex/ingester-agents" >> /tmp/commit_msg.txt
            fi

            if [ -d "docs/chatbot" ]; then
              echo "- soliplex/chatbot" >> /tmp/commit_msg.txt
            fi

            if [ -d "docs/flutter" ]; then
              echo "- soliplex/flutter" >> /tmp/commit_msg.txt
            fi

            if [ -d "docs/ag-ui" ]; then
              echo "- soliplex/ag-ui" >> /tmp/commit_msg.txt
            fi

            echo "" >> /tmp/commit_msg.txt
            echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> /tmp/commit_msg.txt
            echo "Triggered by: ${{ github.event_name }}" >> /tmp/commit_msg.txt

            git commit -F /tmp/commit_msg.txt
            git push

            echo "CHANGES=true" >> $GITHUB_ENV
            echo "✅ Changes committed and pushed"
          fi

      - name: Trigger docs build
        if: env.CHANGES == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: docs_synced

      - name: Notify on failure
        if: failure()
        env:
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "❌ Documentation sync failed"
          echo "Run URL: $RUN_URL"
          # Add Slack/Discord notification here if configured
