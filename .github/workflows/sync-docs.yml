name: Sync Documentation from Repos

on:
  # Trigger from other repos via repository_dispatch
  repository_dispatch:
    types: [docs_updated]

  # Manual trigger
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repository to sync (or "all")'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - soliplex
          - ingester
          - ingester-agents
          - chatbot
          - flutter
          - ag-ui

  # Scheduled sync (daily at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout soliplex.github.io
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Determine which repos to sync
        id: repos
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REPO_INPUT="${{ github.event.inputs.repo }}"
          else
            REPO_INPUT="all"
          fi

          echo "sync_input=$REPO_INPUT" >> $GITHUB_OUTPUT

          # Set flags for which repos to sync
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "soliplex" ]; then
            echo "sync_soliplex=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "ingester" ]; then
            echo "sync_ingester=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "ingester-agents" ]; then
            echo "sync_agents=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "chatbot" ]; then
            echo "sync_chatbot=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "flutter" ]; then
            echo "sync_flutter=true" >> $GITHUB_OUTPUT
          fi
          if [ "$REPO_INPUT" = "all" ] || [ "$REPO_INPUT" = "ag-ui" ]; then
            echo "sync_agui=true" >> $GITHUB_OUTPUT
          fi

      - name: Sync soliplex/soliplex docs
        if: steps.repos.outputs.sync_soliplex == 'true'
        run: |
          chmod +x scripts/sync-repo-docs.sh
          ./scripts/sync-repo-docs.sh \
            soliplex/soliplex \
            docs/soliplex \
            docs

      - name: Sync soliplex/ingester docs
        if: steps.repos.outputs.sync_ingester == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/ingester \
            docs/ingester \
            docs

      # Note: ingester-agents doesn't have a docs/ directory, only README.md
      # Skipping sync for now - can be added later if docs are created

      - name: Sync soliplex/chatbot docs
        if: steps.repos.outputs.sync_chatbot == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/chatbot \
            docs/chatbot \
            docs || echo "⚠️  Failed to sync chatbot (may not exist)"

      - name: Sync soliplex/flutter docs
        if: steps.repos.outputs.sync_flutter == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/flutter \
            docs/flutter \
            docs || echo "⚠️  Failed to sync flutter (may not exist)"

      - name: Sync soliplex/ag-ui docs
        if: steps.repos.outputs.sync_agui == 'true'
        run: |
          ./scripts/sync-repo-docs.sh \
            soliplex/ag-ui \
            docs/ag-ui \
            docs || echo "⚠️  Failed to sync ag-ui (may not exist)"

      - name: Generate sync summary
        id: summary
        run: |
          echo "## Documentation Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Synced Repositories:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "docs/soliplex" ]; then
            SOLIPLEX_COUNT=$(find docs/soliplex -type f | wc -l)
            echo "- ✅ **soliplex/soliplex**: $SOLIPLEX_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/ingester" ]; then
            INGESTER_COUNT=$(find docs/ingester -type f | wc -l)
            echo "- ✅ **soliplex/ingester**: $INGESTER_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/agents" ]; then
            AGENTS_COUNT=$(find docs/agents -type f | wc -l)
            echo "- ✅ **soliplex/ingester-agents**: $AGENTS_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/chatbot" ]; then
            CHATBOT_COUNT=$(find docs/chatbot -type f | wc -l)
            echo "- ✅ **soliplex/chatbot**: $CHATBOT_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/flutter" ]; then
            FLUTTER_COUNT=$(find docs/flutter -type f | wc -l)
            echo "- ✅ **soliplex/flutter**: $FLUTTER_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "docs/ag-ui" ]; then
            AGUI_COUNT=$(find docs/ag-ui -type f | wc -l)
            echo "- ✅ **soliplex/ag-ui**: $AGUI_COUNT files" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Force add synced docs (override .gitignore)
        run: |
          git add --force docs/soliplex/ docs/ingester/ docs/agents/ docs/chatbot/ docs/flutter/ docs/ag-ui/ 2>/dev/null || true
          git status

      - name: Create Pull Request with synced docs
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: sync from upstream repositories

            Synced repositories:
            - soliplex/soliplex
            - soliplex/ingester

            Timestamp: ${{ github.run_id }}
            Triggered by: ${{ github.event_name }}
          branch: docs-sync-${{ github.run_id }}
          delete-branch: true
          title: 'docs: sync from upstream repositories'
          body: |
            ## Documentation Sync

            Automated sync of documentation from upstream repositories.

            **Synced repositories:**
            - soliplex/soliplex
            - soliplex/ingester
            - soliplex/ingester-agents (if available)
            - soliplex/chatbot (if available)
            - soliplex/flutter (if available)
            - soliplex/ag-ui (if available)

            **Triggered by:** ${{ github.event_name }}
            **Workflow run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          labels: documentation,automated

      - name: Enable Pull Request Auto-merge
        if: steps.cpr.outputs.pull-request-number != ''
        run: gh pr merge --auto --squash "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set changes flag
        if: steps.cpr.outputs.pull-request-number != ''
        run: echo "CHANGES=true" >> $GITHUB_ENV

      - name: Notify on failure
        if: failure()
        env:
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "❌ Documentation sync failed"
          echo "Run URL: $RUN_URL"
          # Add Slack/Discord notification here if configured
